# pair_analyzer — 페어 트레이딩 분석 도구 가이드

## 이 도구는 뭔가요?
"삼성전자-SK하이닉스처럼 같이 움직이는 종목 두 개를 찾아서, **가격 차이가 벌어지면 매매 기회를 포착**"하는 도구입니다.
통계적 차익거래(Statistical Arbitrage)의 핵심 기법인 **페어 트레이딩**을 자동으로 분석합니다.
두 종목의 상관관계, Z-score 스프레드, 평균 회귀 반감기를 계산하고, KOSPI 시총 상위 20종목에서 페어 후보를 자동 스캐닝합니다.

## 페어 트레이딩이 뭔가요? (쉽게)
> 두 종목이 평소에 같이 움직이다가, 갑자기 한쪽만 벌어지면?
> → "비싸진 쪽을 팔고, 싸진 쪽을 산다" → 다시 붙으면 양쪽 다 수익!
>
> 예: 삼성전자와 SK하이닉스가 보통 같이 움직이는데, 갑자기 삼성전자만 올랐다면?
> → 삼성전자 매도 + SK하이닉스 매수 → 둘 다 원래 관계로 돌아오면 수익

## 어떤 기술을 쓰나요?
| 기술 | 역할 |
|------|------|
| **pykrx** | 한국거래소 OHLCV 데이터 (시가/고가/저가/종가/거래량) |
| **numpy** | 상관관계, Z-score, OLS 회귀 계산 |
| **pandas** | 시계열 정렬, 롤링 상관관계, 가격 비율 계산 |
| **Ornstein-Uhlenbeck 모델** | 평균 회귀 반감기 계산 (가격 차이가 원래로 돌아오는 속도) |
| **LLM 분석** | 통계 결과를 교수급 전략으로 해석 (Gatev et al. 2006 이론) |

- 비용: **주식 데이터 무료** + LLM 호출 비용 (GPT-5.2 기준 약 $0.01/분석)
- 환경변수: **없음** (pykrx는 API 키 불필요)
- 필요 라이브러리: pykrx, pandas, numpy

## 핵심 개념 정리

| 개념 | 쉬운 설명 | 수치 기준 |
|------|---------|----------|
| **상관관계** | 두 종목이 얼마나 같이 움직이나 (0~1) | 0.8 이상 = 페어 적합, 0.5 미만 = 부적합 |
| **스프레드** | 두 종목 가격 비율의 정규화 (Z-score) | 평균=0, 표준편차=1 기준으로 편차 측정 |
| **Z-score** | 스프레드가 평균에서 몇 표준편차 떨어졌나 | ±2 이상 = 매매 신호, ±3 이상 = 손절 |
| **반감기** | 벌어진 스프레드가 절반으로 줄어드는 기간 | 짧을수록 좋음 (5~30일이 이상적) |
| **롤링 상관관계** | 최근 60일 기준 움직이는 상관관계 | 안정적이면 페어 관계가 견고 |

## 사용법

### action=full (종합 페어 분석) — 가장 많이 쓰게 될 액션
```
action=full, names="삼성전자,SK하이닉스"
action=full, name_a="삼성전자", name_b="SK하이닉스"
```
- 가격 상관관계 + 수익률 상관관계 + Z-score 스프레드 + 반감기 + 매매 신호를 **한 번에** 분석
- 현재가와 가격 비율(A/B) 표시
- 마지막에 LLM이 **Gatev et al.(2006)** 이론 기반 교수급 전략 제안

**출력 예시:**
```
=======================================================
 페어 분석: 삼성전자 ↔ SK하이닉스
=======================================================

▸ 가격 상관관계: 0.872 (강한 양의 상관)
▸ 수익률 상관관계: 0.714
▸ 평균 회귀 반감기: 18일

▸ 스프레드 (Z-score):
  현재: +1.45
  평균: 0.00 / 표준편차 ±1.00
  최대: +2.31 / 최소: -1.87

▸ 페어 트레이딩 신호: 🟡 매도 A / 매수 B (스프레드 확대)

▸ 현재가:
  삼성전자: 71,500원
  SK하이닉스: 198,000원
  비율 (A/B): 0.3611

=======================================================
🎓 교수급 페어 분석
=======================================================
(LLM 분석 결과)
```

### action=correlation (상관관계 분석)
```
action=correlation, names="현대차,기아"
```
분석 항목:
| 항목 | 뭔가요? | 활용법 |
|------|--------|--------|
| 가격 상관관계 | 두 종목 종가가 얼마나 같은 방향으로 움직이나 | 0.8+ = 강한 페어 |
| 수익률 상관관계 | 일일 수익률이 얼마나 비슷한가 | 가격보다 더 정확한 관계 측정 |
| 60일 롤링 상관 (현재) | 최근 60일의 상관관계 | 최근 관계 강도 확인 |
| 60일 롤링 상관 (평균) | 전체 기간 평균 | 장기 관계 안정성 확인 |
| 60일 롤링 상관 (최저) | 가장 관계가 약했던 시기 | 최악의 경우 리스크 판단 |

**상관관계 판단 기준:**
- 0.8 이상 → "매우 높은 상관관계 — 페어 트레이딩에 적합"
- 0.5~0.8 → "중간 상관관계 — 조건부 페어 가능"
- 0.5 미만 → "낮은 상관관계 — 페어 트레이딩 부적합"

### action=spread (스프레드 분석)
```
action=spread, names="삼성전자,SK하이닉스", days=365
```
분석 항목:
| 항목 | 뭔가요? | 활용법 |
|------|--------|--------|
| 비율 (A/B) 현재/평균 | 두 종목 가격 비율과 평균 | 현재가 평균 대비 어디인지 |
| ±1σ 범위 | 정상 변동 범위 | 이 범위 밖이면 비정상적 괴리 |
| Z-score | 현재 스프레드가 평균에서 몇 표준편차 | ±2 이상이면 매매 기회 |
| 반감기 | 스프레드가 절반으로 줄어드는 일수 | 짧을수록 빨리 수익 실현 가능 |
| ±2σ 이탈 횟수 | 극단적 괴리가 몇 번 발생했나 | 많을수록 매매 기회 빈번 |

### action=signal (매매 신호) — CIO가 가장 자주 쓸 액션
```
action=signal, names="삼성전자,SK하이닉스"
```
- Z-score 기반으로 **지금 당장 매매할지 판단**

**Z-score별 매매 신호:**
| Z-score | 신호 | 행동 |
|---------|------|------|
| +2.0 초과 | 강한 신호 | A 매도 + B 매수 (스프레드가 +2σ 초과, 평균 회귀 가능성 높음) |
| +1.0~+2.0 | 약한 신호 | A 매도 + B 매수 고려 |
| -1.0~+1.0 | 중립 | 포지션 없음 (스프레드 정상 범위) |
| -2.0~-1.0 | 약한 신호 | A 매수 + B 매도 고려 |
| -2.0 미만 | 강한 신호 | A 매수 + B 매도 (스프레드가 -2σ 미만, 평균 회귀 가능성 높음) |

**기본 매매 규칙:**
- 진입 기준: Z > +2.0 또는 Z < -2.0
- 청산 기준: Z가 0으로 복귀
- 손절 기준: Z > +3.0 또는 Z < -3.0

### action=scan (페어 후보 자동 탐색) — 어떤 페어를 트레이딩할지 찾을 때
```
action=scan
```
- KOSPI **시가총액 상위 20종목**을 가져와서 모든 조합의 상관관계 계산
- 상관관계 **0.7 이상**인 페어를 자동으로 찾아서 상관계수 순으로 정렬
- 최대 15쌍까지 표시
- 파라미터 불필요 (자동으로 180일 데이터 사용)

**출력 예시:**
```
 페어 트레이딩 후보 탐색 (KOSPI 대형주)

상관관계 0.7 이상 페어 (8쌍 발견):

    종목 A ↔     종목 B | 상관계수
----------------------------------------
  삼성전자 ↔ SK하이닉스 | 0.872
    현대차 ↔       기아 | 0.851
  KB금융 ↔   신한지주 | 0.834
  ...
```

---

## 이 도구를 쓰는 에이전트들

### 1. CIO (투자분석처장)
**언제 쓰나?** 시장 중립 전략이 필요할 때, 차익거래 기회를 찾을 때
**어떻게 쓰나?**
- `action=scan`으로 현재 페어 후보 목록 확인
- `action=signal`로 이미 추적 중인 페어의 진입 타이밍 판단
- `action=full`로 신규 페어 발굴 시 종합 분석

**실전 시나리오:**
> CEO가 "시장이 불안한데 안전한 전략 없어?" 라고 물으면:
> 1. `pair_analyzer action=scan` → 상관관계 높은 페어 8쌍 발견
> 2. `pair_analyzer action=signal, names="삼성전자,SK하이닉스"` → Z-score +1.8 (약한 매도A/매수B 신호)
> 3. `pair_analyzer action=full, names="현대차,기아"` → Z-score +2.3 (강한 신호), 반감기 12일
> 4. 매매 시그널 발행: "현대차 매도 + 기아 매수 페어 진입 추천. Z-score +2.3으로 강한 괴리, 반감기 12일로 약 2주 내 수렴 기대. 손절 Z +3.0"

### 2. 기술적분석 Specialist
**언제 쓰나?** CIO가 지정한 페어의 상세 통계를 분석할 때
**어떻게 쓰나?**
- `action=correlation`으로 상관관계 안정성 검증 (롤링 상관 확인)
- `action=spread`로 스프레드 이력 + 반감기 + 이탈 횟수 분석
- technical_analyzer와 병행해서 개별 종목의 기술적 상태도 확인

**실전 시나리오:**
> CIO가 "삼성전자-SK하이닉스 페어, 지금 들어가도 되나 검증해줘" 라고 지시하면:
> 1. `action=correlation, names="삼성전자,SK하이닉스"` → 가격 상관 0.87, 롤링 최저 0.61 (한때 약화 이력)
> 2. `action=spread, names="삼성전자,SK하이닉스", days=365` → 반감기 18일, ±2σ 이탈 7회
> 3. `technical_analyzer action=signal, name="삼성전자"` → 매수 60점 (관망~매수)
> 4. `technical_analyzer action=signal, name="SK하이닉스"` → 매수 55점 (관망)
> 5. 보고: "상관관계 0.87로 강한 페어. 단, 롤링 최저 0.61로 관계 약화 시기 있었음(리스크). 반감기 18일, 연간 이탈 7회로 매매 기회 충분. 진입 가능하나 손절선 Z ±3.0 엄수 권장"

### 3. 리스크관리 Specialist
**언제 쓰나?** 포트폴리오의 페어 포지션 리스크를 모니터링할 때
**어떻게 쓰나?**
- `action=signal`로 기존 페어 포지션의 Z-score 변화 추적
- `action=spread`로 스프레드 확대 추세 감지 → 손절 필요 여부 판단
- `action=correlation`으로 상관관계 붕괴 여부 모니터링

**실전 시나리오:**
> CIO가 보유 중인 "현대차 매도 + 기아 매수" 페어 포지션에 대해:
> 1. `action=signal, names="현대차,기아"` → Z-score +2.8 (손절 기준 ±3.0 근접!)
> 2. `action=correlation, names="현대차,기아"` → 롤링 상관 0.65 (평소 0.85에서 급락)
> 3. 경고 보고: "Z-score +2.8로 손절선(±3.0) 임박. 롤링 상관관계도 0.65로 하락 — 페어 관계 약화 가능성. 포지션 축소 또는 즉시 청산 권장"

---

## 파라미터 정리

| 파라미터 | 필수 | 타입 | 설명 |
|---------|------|------|------|
| action | O | string | full / correlation / spread / signal / scan |
| names | X | string | 두 종목 쉼표 구분 (예: "삼성전자,SK하이닉스"). name_a/name_b 대신 사용 가능 |
| name_a | X | string | 종목 A 이름 (예: "삼성전자") |
| name_b | X | string | 종목 B 이름 (예: "SK하이닉스") |
| stock_a | X | string | name_a와 동일 (별칭) |
| stock_b | X | string | name_b와 동일 (별칭) |
| query | X | string | names와 동일 (별칭). "삼성전자,SK하이닉스" 형태 |
| days | X | integer | 분석 기간 (기본값: 365일). scan에서는 180일 고정 |

- `action=scan`은 파라미터 없이 호출합니다. 자동으로 KOSPI 시총 상위 20종목을 스캐닝합니다.
- 그 외 액션은 **두 종목이 필수**입니다. `names="A,B"` 또는 `name_a="A", name_b="B"` 형태로 입력합니다.

## 주의사항
- **장 마감 후 데이터 기준**입니다. 실시간 스프레드가 아닙니다.
- **최소 30일 이상** 데이터가 있어야 분석 가능합니다. 신규 상장 종목은 부적합합니다.
- `days` 값이 너무 작으면 (60일 미만) 상관관계와 반감기의 통계적 신뢰도가 떨어집니다.
- **상관관계는 변합니다** — 과거에 상관관계가 높았어도 미래에 깨질 수 있습니다. 롤링 상관관계를 반드시 확인하세요.
- 반감기가 **음수(N/A)**이면 평균 회귀가 아니라 **발산(계속 벌어짐)**을 의미합니다. 이런 페어는 트레이딩 대상이 아닙니다.
- `scan`은 20종목 x 190쌍을 계산하므로, 응답 시간이 30초~1분 소요될 수 있습니다.
- 페어 트레이딩은 **확률 전략**입니다. 항상 손절선(Z ±3.0)을 설정하세요.
- 종목명이 정확해야 합니다. "삼성" 대신 "삼성전자"로 정확히 입력하세요.
