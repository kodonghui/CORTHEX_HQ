# backtest_engine — 포트폴리오 백테스터 도구 가이드

## 이 도구는 뭔가요?
투자 전략을 과거 주가 데이터로 시뮬레이션(가상 매매)하여 "이 전략을 과거에 실행했다면 얼마를 벌었을까?"를 테스트하는 도구입니다. 골든크로스, RSI, MACD 같은 기술적 분석 전략을 검증하고, 수익률/최대 낙폭/승률 등 성과 지표를 제공합니다.

## 어떤 API를 쓰나요?
- **pykrx** (한국거래소 과거 주가 데이터)
- **pandas-ta** (기술적 지표 계산 라이브러리)
- 비용: **무료** (API 키 불필요)
- 필요한 키: 없음

## 사용법

### action=backtest (단일 전략 백테스트)
```
action=backtest, ticker="005930", strategy="golden_cross", start_date="20250101", end_date="20260101", initial_capital=10000000
```
- 특정 종목에 대해 하나의 전략을 시뮬레이션합니다.
- 종목코드(ticker) 또는 종목명(name) 중 하나를 입력합니다.
- AI가 백테스트 결과를 분석하여 전략의 강점/약점/개선안을 제시합니다.

**파라미터:**
| 파라미터 | 설명 | 기본값 |
|---------|------|--------|
| ticker | 종목코드 (예: "005930") | - |
| name | 종목명 (예: "삼성전자") | - |
| strategy | 전략명 (아래 표 참조) | "golden_cross" |
| start_date | 시작일 (YYYYMMDD) | 1년 전 |
| end_date | 종료일 (YYYYMMDD) | 오늘 |
| initial_capital | 초기 자금 (원) | 10,000,000 |

**사용 가능한 전략:**
| 전략명 | 설명 | 매수 조건 | 매도 조건 |
|--------|------|----------|----------|
| golden_cross | 골든크로스 | 5일 이동평균이 20일 이동평균을 상향 돌파 | 5일 이동평균이 20일 이동평균을 하향 돌파 |
| rsi | RSI 과매도/과매수 | RSI가 30 아래로 내려갈 때 (과매도) | RSI가 70 위로 올라갈 때 (과매수) |
| macd | MACD 시그널 돌파 | MACD 선이 시그널선을 상향 돌파 | MACD 선이 시그널선을 하향 돌파 |
| buy_and_hold | 바이앤홀드 | 첫날 매수 후 보유 | 매도 없음 (비교 기준용) |

**반환 지표:**
- 최종 자산 / 총 수익률 / 연환산 수익률(CAGR) / 최대 낙폭(MDD) / 승률 / 샤프 비율 / 총 거래 횟수 / 최근 거래 내역

**예시:**
- `action=backtest, name="삼성전자", strategy="golden_cross"` → 삼성전자 골든크로스 전략 1년 백테스트
- `action=backtest, ticker="035720", strategy="rsi", initial_capital=50000000` → 카카오 RSI 전략, 5천만원 초기자금

### action=compare (전략 비교)
```
action=compare, name="삼성전자", strategies="golden_cross,rsi,macd,buy_and_hold"
```
- 여러 전략의 결과를 한꺼번에 비교합니다.
- 같은 종목, 같은 기간에 대해 어떤 전략이 가장 좋았는지 확인할 수 있습니다.

**예시:**
- `action=compare, name="삼성전자", strategies="golden_cross,rsi,buy_and_hold"` → 3가지 전략 성과 비교

## 이 도구를 쓰는 에이전트들

### 1. 투자분석처장 (CIO)
**언제 쓰나?** 투자 전략의 유효성을 검증하거나, 팀원들의 분석 결과를 크로스체크(교차 검증)할 때
**어떻게 쓰나?**
- compare로 여러 전략을 비교하여 최적 전략 선택
- 팀원이 제안한 전략의 과거 성과를 백테스트로 검증

**실전 시나리오:**
> CEO가 "골든크로스 전략이 진짜 돈 되나?" 라고 하면:
> 1. `action=compare, name="삼성전자", strategies="golden_cross,buy_and_hold"` 로 비교
> 2. 골든크로스 vs 단순 보유의 수익률/MDD 차이를 수치로 보고
> 3. "골든크로스 전략의 수익률은 +15%인데, 단순 보유는 +20%입니다. MDD(최대 낙폭)는 골든크로스가 -8%로 더 안정적입니다."

### 2. 기술적분석 Specialist
**언제 쓰나?** 차트 분석에서 발견한 시그널의 과거 적중률을 확인할 때
**어떻게 쓰나?**
- 특정 종목에서 발견한 기술적 시그널(예: RSI 과매도)이 과거에 얼마나 수익을 냈는지 백테스트
- 다양한 전략의 샤프 비율(위험 대비 수익)을 비교하여 최적 전략 추천

**실전 시나리오:**
> CEO가 "카카오 차트 봤을 때 RSI 전략이 맞을 것 같은데?" 라고 하면:
> 1. `action=backtest, name="카카오", strategy="rsi"` 로 RSI 전략 백테스트
> 2. 승률, 수익률, MDD를 확인하고 "RSI 전략 승률 60%, 연 수익률 +12%, MDD -15%"로 보고
> 3. kr_stock의 실시간 지표와 함께 현재 진입 타이밍 판단

## 주의사항
- 백테스트는 **과거 성과**이며, 미래 수익을 보장하지 않습니다. 참고 지표로만 사용하세요.
- 시뮬레이션에서는 **슬리피지(체결가 차이)와 수수료가 반영되지 않습니다**. 실제 수익률은 더 낮을 수 있습니다.
- 데이터가 최소 30거래일 이상 필요합니다. 너무 짧은 기간은 분석이 불가합니다.
- pykrx와 pandas-ta 라이브러리가 서버에 설치되어 있어야 합니다.
- 매수 시 **전액 투자**, 매도 시 **전량 매도** 방식으로 시뮬레이션합니다.
