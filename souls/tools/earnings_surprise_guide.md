# earnings_surprise — 실적 서프라이즈 분석 도구 가이드

## 이 도구는 뭔가요?
대학교 금융학 교수가 실적 발표 시즌마다 해주는 분석처럼, **과거 EPS(주당순이익) 추이와 실적 발표 전후 주가 패턴**을 종합 분석해주는 도구입니다.
"이번 분기 실적이 좋을까? 나쁠까?", "실적 발표 전에 사야 해? 후에 사야 해?" 같은 질문에 데이터 기반으로 답합니다.

## kr_stock의 fundamentals와 뭐가 다른가요?
| 항목 | kr_stock (fundamentals) | earnings_surprise |
|------|------------------------|-------------------|
| EPS 데이터 | 현재 시점 EPS/PER/PBR 단순 조회 | **분기별 EPS 추이 + YoY 성장률 트렌드** |
| 실적 시즌 분석 | 없음 | 1월/4월/7월/10월 실적 시즌별 평균 수익률 |
| 주가 반응 이력 | 없음 | 과거 실적 발표 전후 ±5일 수익률 기록 |
| 서프라이즈 예측 | 없음 | EPS 성장률 기반 서프라이즈 가능성 확률 추정 |
| PER 밴드 | 없음 | 2년간 PER 범위 (최저/평균/최고) 분석 |
| AI 종합 판단 | 없음 | LLM이 PEAD 이론 기반 매수/매도 판단 |

## 어떤 기술을 쓰나요?
- **pykrx** — 한국거래소 OHLCV(시가/고가/저가/종가/거래량) + 펀더멘털(EPS/PER/PBR) 데이터 (2년치)
- **pandas** — 분기별 리샘플링, 월별 수익률 그룹핑
- **numpy** — 수치 계산 (NaN 처리, 성장률 계산)
- **LLM 분석** — Ball & Brown(1968) PEAD 이론 기반 교수급 해설 생성
- **학술 근거**: Ball & Brown(1968) PEAD, Bernard & Thomas(1989) 어닝 모멘텀, SUE(표준화 비기대이익)
- 비용: **주식 데이터 무료** + LLM 호출 비용 (action=full, estimate에서만 LLM 사용)

## 사용법

### action=full (종합 실적 분석) — 가장 많이 쓰게 될 액션
```
action=full, name="삼성전자"
```
- 분기별 EPS 추이 + YoY 성장률
- 연간 EPS 성장률 (TTM 기준, 최근 4분기 합 vs 전년 4분기 합)
- 실적 시즌(1월/4월/7월/10월) 평균 일간 수익률
- PER 밴드 (현재/평균/최저/최고)
- LLM이 PEAD 이론 기반 **교수급 종합 분석** 덧붙임

### action=history (과거 실적 후 주가 반응 이력)
```
action=history, name="카카오"
```
분석 내용:
| 항목 | 설명 | 활용법 |
|------|------|--------|
| 실적 시즌별 ±5일 수익률 | 1월(4Q)/4월(1Q)/7월(2Q)/10월(3Q) 발표 전후 5영업일 수익률 | 양의 반응 비율이 높으면 → 실적 시즌에 주가가 잘 오르는 종목 |
| 평균 수익률 | 모든 실적 시즌의 평균 주가 변동 | 양수면 실적 발표가 호재로 작용하는 경향 |
| 양의 반응 비율 | 실적 발표 후 주가가 오른 횟수 / 전체 | 70% 이상이면 실적 시즌 매수 전략 유효 |

### action=pattern (실적 시즌 주가 패턴)
```
action=pattern, name="NAVER"
```
분석 내용:
| 항목 | 설명 | 활용법 |
|------|------|--------|
| 월별 평균 일간 수익률 | 1~12월 각각의 평균 일간 수익률 | 특정 월에 강한/약한 종목 파악 |
| 막대 그래프 | 수익률 크기를 시각적으로 표시 | 한눈에 강한 달/약한 달 구분 |
| 실적 시즌 강조 | 1월(4Q)/4월(1Q)/7월(2Q)/10월(3Q) 표시 | 실적 발표 월과 수익률 관계 파악 |

### action=estimate (서프라이즈 가능성 추정)
```
action=estimate, name="현대차"
```
분석 내용:
| 항목 | 설명 | 활용법 |
|------|------|--------|
| 최근 4분기 EPS | 분기별 실제 EPS 값 | EPS 추세 방향 확인 (증가/감소/횡보) |
| 분기별 평균 성장률 | 최근 4분기간 EPS 변화율 평균 | 성장률이 양수면 실적 개선 추세 |
| 다음 분기 예상 EPS | 마지막 EPS x (1 + 평균 성장률) | 단순 추정이므로 참고용 |
| 서프라이즈 가능성 (%) | 10%~90% 범위 확률 | 60% 초과 → PEAD 매수 전략 고려 / 40% 미만 → 리스크 관리 |

---

## 이 도구를 쓰는 에이전트들

### 1. CIO (투자분석처장)
**언제 쓰나?** 실적 시즌 전에 포트폴리오 종목의 실적 전망을 판단할 때
**어떻게 쓰나?**
- `action=full`로 종합 실적 분석 → 어닝 서프라이즈 가능성 판단
- `action=estimate`로 서프라이즈 확률 확인 → 매수/매도 결정 근거

**실전 시나리오:**
> CEO가 "삼성전자 이번 실적 어떨 것 같아?" 라고 물으면:
> 1. `earnings_surprise action=full, name="삼성전자"` → EPS 성장률 + 시즌 패턴 + PER 밴드 + LLM 분석
> 2. `earnings_surprise action=estimate, name="삼성전자"` → 서프라이즈 가능성 72% (PEAD 매수 고려)
> 3. `technical_analyzer action=signal, name="삼성전자"` → 매매 점수 병행 확인
> 4. 보고: "EPS가 3분기 연속 성장 중이고, 서프라이즈 가능성 72%입니다. 과거 실적 시즌 양의 반응 비율이 80%라 발표 전 분할 매수를 추천합니다."

### 2. 종목분석 Specialist
**언제 쓰나?** CIO가 지시한 종목의 실적 패턴을 심층 조사할 때
**어떻게 쓰나?**
- `action=history`로 과거 실적 시즌 반응 패턴 확인
- `action=pattern`으로 월별 수익률 계절성 파악
- `action=estimate`로 다음 분기 EPS 추정 + 서프라이즈 확률 산출

**실전 시나리오:**
> CIO가 "카카오 실적 시즌 매수 전략 세워줘" 라고 지시하면:
> 1. `action=history, name="카카오"` → 과거 8분기 실적 시즌 수익률: 평균 +1.2%, 양의 반응 75%
> 2. `action=pattern, name="카카오"` → 4월이 가장 강한 달 (+0.15%/일), 10월이 가장 약한 달 (-0.08%/일)
> 3. `action=estimate, name="카카오"` → EPS 성장률 +12%, 서프라이즈 가능성 74%
> 4. 보고: "카카오는 4월(1Q) 실적 시즌에 가장 강한 패턴을 보입니다. 양의 반응 비율 75%, 서프라이즈 가능성 74%로 3월 중순 분할매수 → 4월 중순 실적 발표 후 매도 전략을 추천합니다."

---

## 파라미터 정리

| 파라미터 | 필수 | 타입 | 설명 |
|---------|------|------|------|
| action | X | string | full / history / pattern / estimate (기본값: full) |
| name | X | string | 종목명 (예: "삼성전자"). name 또는 ticker 중 하나 필요 |
| ticker | X | string | 종목코드 (예: "005930"). name 또는 ticker 중 하나 필요 |
| query | X | string | name이 없을 때 종목명 대용으로 사용됨 |

## 핵심 개념 — PEAD 이론이란?

**PEAD (Post-Earnings Announcement Drift)** — 실적 발표 후 주가 밀림 현상
- Ball & Brown(1968)이 발견: **실적이 좋으면 발표 후에도 주가가 계속 오르고, 나쁘면 계속 떨어진다**
- 시장이 실적 정보를 한 번에 반영하지 못하고, 서서히(수주~수개월) 반영하기 때문
- 투자 전략: 어닝 서프라이즈(예상보다 좋은 실적) 발생 시 → 발표 직후 매수해도 추가 수익 가능

## 주의사항
- **데이터 범위**: 2년치(730일) OHLCV + 펀더멘털 데이터를 사용합니다. 상장한 지 2년 미만인 종목은 분석이 제한됩니다.
- **EPS 데이터 한계**: pykrx의 EPS는 장 마감 기준 데이터입니다. 실시간 컨센서스(증권사 추정치)가 아닙니다.
- **실적 시즌 기준**: 1월(4Q 발표), 4월(1Q 발표), 7월(2Q 발표), 10월(3Q 발표)을 기준으로 분석합니다. 종목마다 실제 발표일은 다를 수 있습니다.
- **서프라이즈 확률**: 과거 EPS 성장률 기반 단순 추정입니다. 실제 서프라이즈는 증권사 컨센서스 대비 결과이므로 참고용으로 사용하세요.
- **LLM 호출**: action=full에서만 LLM을 호출합니다 (교수급 분석). history/pattern/estimate는 순수 데이터 계산만 하므로 비용이 들지 않습니다.
- **최소 데이터**: action=estimate는 최소 4분기 EPS가 있어야 작동합니다. 데이터 부족 시 안내 메시지가 나옵니다.
