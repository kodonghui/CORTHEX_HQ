# portfolio_optimizer — 교수급 포트폴리오 최적화 도구 가이드

## 이 도구는 뭔가요?
Harry Markowitz 교수(노벨경제학상 수상)의 현대포트폴리오이론(MPT)을 그대로 구현한 도구입니다. **"어떤 종목에 얼마씩 넣어야 위험 대비 수익이 최대인가?"**를 수학적으로 계산해줍니다.
종목 2~20개를 입력하면, 10,000번의 몬테카를로 시뮬레이션을 돌려서 최적 비중, 최소 위험 비중, 효율적 프론티어까지 한 번에 산출합니다.

## kr_stock이나 dcf_valuator와 뭐가 다른가요?
| 항목 | kr_stock | dcf_valuator | portfolio_optimizer |
|------|---------|-------------|-------------------|
| 분석 대상 | 개별 종목 1개 | 개별 종목 1개 | **여러 종목 조합** (2~20개) |
| 핵심 질문 | "이 종목 지금 얼마야?" | "이 종목 비싼가 싼가?" | **"이 종목들을 몇 대 몇으로 섞어야 해?"** |
| 출력물 | 가격/재무/차트 | 적정가/괴리율 | **최적 비중(%), 샤프 비율, 효율적 프론티어** |
| 상관관계 | 없음 | 없음 | **종목 간 상관계수 매트릭스** |
| 분산효과 | 없음 | 없음 | **포트폴리오 변동성 < 개별 변동성 합** |

**한 줄 요약**: kr_stock은 "개별 종목 정보", dcf_valuator는 "개별 종목 가치", portfolio_optimizer는 **"종목들을 어떻게 섞을지"**

## 어떤 기술을 쓰나요?
- **pykrx** — 한국거래소 일간 종가 데이터 (최대 5년)
- **numpy** — 수익률/변동성/공분산/샤프비율 계산, 몬테카를로 난수 생성
- **pandas** — 다종목 수익률 DataFrame, 상관관계 매트릭스
- **LLM 분석** — Markowitz 교수 수준의 포트폴리오 배분 전략 해설
- **핵심 알고리즘**: 몬테카를로 시뮬레이션 10,000회 (무작위 비중 조합 → 최적 탐색)
- **학술 근거**: Markowitz "Portfolio Selection" (1952), Sharpe Ratio (1966)
- 비용: **주식 데이터 무료** + LLM 호출 비용 (full 액션만)

## 사용법

### action=full (종합 분석) — 가장 많이 쓰게 될 액션
```
action=full, names="삼성전자,카카오,현대차,NAVER"
```
- 개별 종목 연간 수익률/변동성 + 상관관계 매트릭스 + 최적 비중 + 최소 위험 비중 + 동일 비중 비교를 **한 번에** 분석
- 마지막에 LLM이 Markowitz 교수 수준의 배분 전략 + 분산 효과 해설
- 출력 예시:
  - 개별: 삼성전자 +12.3%, 카카오 -5.2%, 현대차 +18.7%, NAVER +8.1%
  - 최적: 삼성전자 35.2%, 카카오 5.1%, 현대차 42.8%, NAVER 16.9% → 샤프 1.45
  - 최소위험: 삼성전자 28.1%, 카카오 15.3%, 현대차 22.0%, NAVER 34.6% → 변동성 14.2%
  - 동일비중: 25%씩 → 샤프 1.12

### action=optimize (최적 비중 계산) — 핵심 액션
```
action=optimize, names="삼성전자,SK하이닉스,LG에너지솔루션"
```
계산 과정:
| 단계 | 설명 | 상세 |
|------|------|------|
| 1. 수익률 계산 | 일간 수익률(종가 변화율) | pykrx 종가 데이터 기반 |
| 2. 평균/공분산 | 평균 수익률 + 공분산 행렬 | pandas 통계 함수 |
| 3. 시뮬레이션 | 10,000개 무작위 비중 조합 | numpy 랜덤 (seed=42 고정) |
| 4. 샤프 계산 | 각 조합의 (수익률/변동성) | 연율화 (x252일) |
| 5. 최적 선택 | 샤프 비율이 가장 높은 조합 | 위험 대비 수익 최대 |
- **샤프 비율이란?** 위험 1단위당 얻는 초과 수익. 높을수록 효율적인 포트폴리오
- 출력: 종목별 비중(%) + 예상 연간 수익률 + 예상 연간 변동성 + 샤프 비율

### action=min_risk (최소 위험 포트폴리오) — 보수적 투자자용
```
action=min_risk, names="삼성전자,카카오,현대차"
```
- 10,000번 시뮬레이션에서 **변동성이 가장 낮은** 비중 조합을 선택
- "수익은 좀 덜 나도 좋으니 밤에 편히 자고 싶다"는 투자자에게 적합
- 상관관계가 낮은 종목끼리 섞으면 분산 효과로 개별 종목보다 변동성이 더 낮아짐

### action=equal_weight (동일 비중 비교) — 벤치마크용
```
action=equal_weight, names="삼성전자,SK하이닉스,LG에너지솔루션"
```
- "그냥 N분의 1로 나눠 담기" vs "최적화 비중"을 나란히 비교
- 최적화가 동일 비중 대비 **샤프 비율을 몇 % 개선**했는지 수치로 표시
- 의외로 동일 비중이 잘 먹힐 때도 있음 → 최적화의 실효성을 검증하는 액션

### action=efficient_frontier (효율적 프론티어) — 학술적 분석용
```
action=efficient_frontier, names="삼성전자,카카오,현대차,NAVER,LG에너지솔루션"
```
- 최소 수익률 ~ 최대 수익률 구간을 5등분하여, 각 목표 수익률에서 **변동성이 가장 낮은** 비중 조합을 탐색
- 수익률 | 변동성 | 샤프 | 비중 배분 형태의 테이블 출력
- "수익률을 올리면 변동성도 올라간다"는 트레이드오프를 한눈에 파악
- 5개 포인트 각각 5,000번 시뮬레이션 (총 25,000회)

---

## 이 도구를 쓰는 에이전트들

### 1. CIO (투자분석처장)
**언제 쓰나?** CEO 자금의 포트폴리오 배분 전략을 수립할 때
**어떻게 쓰나?**
- `action=full`로 후보 종목들의 최적 조합 확인
- `action=efficient_frontier`로 위험-수익 트레이드오프 시각화

**실전 시나리오:**
> CEO가 "1억으로 국내 주식 포트폴리오 만들어줘" 라고 하면:
> 1. `stock_screener`로 후보 종목 10개 선별
> 2. `dcf_valuator action=full`로 각 종목 가치평가 → 저평가 5개 선정
> 3. `portfolio_optimizer action=full, names="삼성전자,현대차,KT&G,POSCO홀딩스,NAVER"`
> 4. 최적 비중: 삼성전자 32%, 현대차 28%, KT&G 15%, POSCO홀딩스 18%, NAVER 7%
> 5. 보고: "예상 연간 수익률 +14.2%, 변동성 18.5%, 샤프 0.77. KT&G와 POSCO가 다른 종목과 상관관계가 낮아 분산 효과가 큽니다"

### 2. 리스크관리 Specialist
**언제 쓰나?** 기존 포트폴리오의 위험을 줄이거나, 리밸런싱할 때
**어떻게 쓰나?**
- `action=min_risk` → 현재 보유 종목으로 최소 위험 비중 확인
- `action=equal_weight` → 최적화 효과가 실제로 있는지 검증
- `action=efficient_frontier` → 목표 수익률별 최소 위험 확인

**실전 시나리오:**
> CIO가 "현재 포트폴리오 변동성이 너무 크다, 줄여줘" 라고 지시하면:
> 1. `action=min_risk, names="삼성전자,SK하이닉스,카카오,셀트리온"` → 최소 변동성 비중 산출
> 2. `action=full` → 현재 비중 vs 최소위험 비중 vs 최적 비중 3가지 비교
> 3. 상관관계 매트릭스에서 삼성전자-SK하이닉스 상관계수 0.78 (너무 높음) 발견
> 4. 보고: "삼성전자와 SK하이닉스가 같이 움직여서 분산 효과가 약합니다. 삼성전자 비중을 줄이고 KT&G나 한국전력 같은 내수주를 추가하면 변동성을 22%→16%로 낮출 수 있습니다"

---

## 파라미터 정리

| 파라미터 | 필수 | 타입 | 설명 |
|---------|------|------|------|
| action | O | string | full/optimize/min_risk/equal_weight/efficient_frontier |
| names | O | string | 종목명 쉼표 구분 (예: "삼성전자,카카오,현대차"). 최소 2개, 최대 20개 |
| tickers | X | string | 종목코드 쉼표 구분 (예: "005930,035720,005380"). names 대신 사용 가능 |
| days | X | integer | 분석 기간 (기본값: 365일 = 1년) |

## 주의사항
- **장 마감 후 데이터 기준**입니다. 실시간 호가가 아닙니다.
- **최소 2개, 최대 20개 종목**이 필요합니다. 1개면 포트폴리오가 아닙니다.
- 종목당 **최소 20거래일** 데이터가 필요합니다. 신규 상장 직후 종목은 분석이 제한됩니다.
- 몬테카를로 시뮬레이션은 **seed=42 고정**이므로 같은 입력이면 같은 결과가 나옵니다. (재현 가능성 보장)
- **과거 데이터 기반**입니다. "과거에 이 조합이 좋았다"는 뜻이지, 미래를 보장하지 않습니다.
- `days` 값이 작으면 (90일 미만) 통계적 신뢰도가 떨어집니다. 최소 180일 이상 권장합니다.
- 상관관계는 시간에 따라 변합니다. 위기 시 상관관계가 1에 수렴하는 현상이 있으므로, 분산 효과를 과신하지 마세요.
- 종목명으로 검색 시 pykrx의 ticker 변환을 사용합니다. 정확한 종목명을 입력하세요.
- full 액션만 LLM 분석을 포함합니다. 나머지는 수치 결과만 반환합니다.
- 종목 수가 많을수록 데이터 로딩 시간이 길어집니다 (종목당 약 1~2초).
