# risk_calculator — JP Morgan급 리스크 측정 도구 가이드

## 이 도구는 뭔가요?
JP Morgan RiskMetrics 수준으로 **"최악의 경우 얼마까지 잃을 수 있나?"**를 정량적으로 계산해주는 도구입니다.
VaR(최대예상손실), MDD(최대낙폭), 변동성, 샤프/소르티노/칼마 비율, 스트레스 테스트까지 **6가지 위험 분석**을 한 번에 제공합니다.

## kr_stock이나 technical_analyzer와 뭐가 다른가요?
| 항목 | kr_stock (price) | technical_analyzer | risk_calculator |
|------|-----------------|-------------------|----------------|
| 목적 | 현재가/차트 조회 | 매매 신호 분석 | **위험 측정** |
| VaR (95%/99%) | 없음 | 없음 | **일일/월간 VaR + CVaR** |
| MDD (최대낙폭) | 없음 | 없음 | **MDD + 낙폭 이력 + 회복 시간** |
| 샤프/소르티노/칼마 비율 | 없음 | 없음 | **3종 위험조정수익률** |
| 스트레스 테스트 | 없음 | 없음 | **코로나/리먼급 5개 시나리오** |
| 위험 등급 | 없음 | 없음 | **녹/황/적 3단계 등급** |
| 투자금 기준 손실액 | 없음 | 없음 | **원화 금액으로 환산** |

## 어떤 기술을 쓰나요?
- **pykrx** — 한국거래소 OHLCV(시가/고가/저가/종가/거래량) 데이터
- **numpy** — 통계 계산 (퍼센타일, 표준편차, 첨도/왜도)
- **Historical VaR** — 과거 수익률 분포에서 직접 퍼센타일 추출 (파라메트릭이 아닌 역사적 시뮬레이션 방식)
- **LLM 분석** — full과 stress 액션에서 교수급 해설 생성
- 비용: **주식 데이터 무료** + LLM 호출 비용 (full/stress만, 약 $0.01/분석)

---

## 사용법

### action=full (전체 리스크 종합) — 가장 많이 쓰게 될 액션
```
action=full, name="삼성전자"
action=full, name="삼성전자", investment=50000000
```
- VaR + MDD + 변동성 + 위험조정수익률 + 위험 등급을 **한 번에** 분석
- 마지막에 LLM이 JP Morgan급 리스크 종합 의견을 덧붙임
- `investment` 파라미터로 투자금을 지정하면 원화 손실액으로 환산 (기본 1,000만원)

**위험 등급 기준:**
| 연간 변동성 | 등급 | 의미 |
|-----------|------|------|
| 20% 미만 | 녹색 (낮음) | 보수적 투자 적합 |
| 20~35% | 황색 (중간) | 일반 투자자 |
| 35% 이상 | 적색 (높음) | 고위험 감수 가능자만 |

### action=var (VaR 분석) — "하루에 최대 얼마 잃을 수 있나?"
```
action=var, name="카카오"
action=var, name="카카오", investment=20000000
```
분석 항목:
| 지표 | 뭔가요? | 활용법 |
|------|--------|--------|
| VaR 90% | 100일 중 10일은 이 이상 손실 | 보수적 기준 |
| VaR 95% | 100일 중 5일은 이 이상 손실 | **가장 많이 쓰는 기준** |
| VaR 99% | 100일 중 1일은 이 이상 손실 | 극단적 상황 대비 |
| CVaR 95% (Expected Shortfall) | VaR 95%를 넘은 날의 **평균** 손실 | VaR보다 보수적 — 꼬리 위험 측정 |
| 월간 VaR 95% | 일일 VaR를 루트(21)로 스케일링 | 한 달 기준 최대 손실 |

**해석 예시:** "VaR 95% = -2.3%이고 투자금 1,000만원이면 → 100거래일 중 5일은 23만원 이상 손실 가능"

### action=drawdown (최대낙폭 분석) — "고점에서 얼마나 떨어졌나?"
```
action=drawdown, name="NAVER"
```
분석 항목:
| 지표 | 뭔가요? | 활용법 |
|------|--------|--------|
| MDD (Maximum Drawdown) | 역사상 고점 대비 최대 하락률 | 최악의 경우 시뮬레이션 |
| MDD 발생일 | 최대 낙폭이 발생한 날짜 | 어떤 이벤트 때 가장 많이 빠졌는지 확인 |
| 현재 낙폭 | 지금 현재 고점 대비 얼마나 빠져 있는지 | 현재 위험 수준 파악 |
| 10% 이상 낙폭 이력 | 과거 10% 이상 하락한 구간들 (최근 5건) | 하락 패턴/빈도 분석 |
| MDD 회복 소요 | 최대 낙폭에서 고점까지 회복하는 데 걸린 일수 | 장기 투자 시 인내 기간 추정 |

### action=volatility (변동성 분석) — "이 종목이 얼마나 출렁이는가?"
```
action=volatility, name="현대차"
```
분석 항목:
| 지표 | 뭔가요? | 활용법 |
|------|--------|--------|
| 일간 변동성 | 하루 수익률의 표준편차 | 기본 변동 크기 |
| 연간 변동성 | 일간 x 루트(252)로 연율화 | 종목 간 비교 기준 (252 = 연간 거래일) |
| 20일 롤링 변동성 | 최근 20거래일의 변동성 | **단기 변동성 추이** |
| 60일 롤링 변동성 | 최근 60거래일의 변동성 | **중기 변동성 추이** |
| 왜도 (Skewness) | 수익률 분포가 어느 쪽으로 치우쳤나 | 음수 = 하락 위험 크다, 양수 = 상승 유리 |
| 첨도 (Kurtosis) | 극단적 변동이 얼마나 자주 나오나 | 3 초과 = 꼬리 위험 높음 (갑작스런 급등락 가능) |

**경고 신호:**
- 20일 변동성 > 60일 변동성 x 1.3 → "단기 변동성 급등, 주의 필요"
- 20일 변동성 < 60일 변동성 x 0.7 → "단기 변동성 축소, 큰 움직임 대비"

### action=ratios (위험조정수익률) — "위험 대비 수익이 괜찮은가?"
```
action=ratios, name="삼성SDI"
action=ratios, name="삼성SDI", rf=0.04
```
분석 지표:
| 지표 | 뭔가요? | 판단 기준 |
|------|--------|----------|
| 샤프 비율 (Sharpe Ratio) | (수익률 - 무위험수익률) / 변동성 | 1.0 이상 = 우수, 0.5 이상 = 양호, 0.5 미만 = 부진 |
| 소르티노 비율 (Sortino Ratio) | (수익률 - 무위험수익률) / 하방변동성 | 2.0 이상 = 우수, 1.0 이상 = 양호, 1.0 미만 = 부진 |
| 칼마 비율 (Calmar Ratio) | 연간수익률 / MDD | 1.0 이상 = 우수, 0.5 이상 = 양호, 0.5 미만 = 부진 |
| 승률 | 양수 수익률 거래일 비율 | 50% 이상이 일반적 |
| 평균 이익 / 평균 손실 | 수익 날과 손실 날의 평균 크기 | 평균이익 > 평균손실이면 유리 |
| 손익비 (Profit Factor) | 평균이익 / 평균손실 (절대값) | 1.5 이상이 양호 |

**샤프 vs 소르티노 차이:** 샤프는 상승도 "위험"으로 보지만, 소르티노는 **하락만** 위험으로 봅니다. 상승 변동이 큰 종목은 소르티노가 더 높게 나옵니다.

### action=stress (스트레스 테스트) — "위기가 오면 얼마나 잃나?"
```
action=stress, name="삼성전자"
action=stress, name="삼성전자", investment=100000000
```
시뮬레이션 시나리오:
| 시나리오 | 하락률 | 의미 |
|---------|--------|------|
| 코로나 쇼크 | -30% | 2020년 3월 수준의 팬데믹 공포 |
| 금리 급등 시나리오 | -20% | 중앙은행 급격한 긴축 |
| 리먼 브라더스급 | -50% | 2008년 글로벌 금융위기 수준 |
| 일반 조정 | -10% | 정상적인 시장 조정 |
| 블랙 먼데이급 (일일) | -20% | 하루 만에 20% 폭락 |

추가 분석:
- **역사적 최악의 하루**: 이 종목의 실제 최악의 1일 수익률
- **역사적 최악의 주간**: 1주간 가장 큰 하락
- **역사적 최악의 월간**: 1개월간 가장 큰 하락
- LLM이 스트레스 테스트 결과를 해석하고 **대비 전략**을 제안

---

## 이 도구를 쓰는 에이전트들

### 1. CIO (투자분석처장)
**언제 쓰나?** 포트폴리오 위험 관리 전략을 세울 때, 매매 전 리스크 확인할 때
**어떻게 쓰나?**
- `action=full`로 종합 리스크를 빠르게 파악
- `action=stress`로 최악의 시나리오 대비
- `action=ratios`로 위험 대비 수익이 괜찮은지 판단

**실전 시나리오:**
> CEO가 "삼성전자에 5,000만원 넣으려는데 괜찮아?" 라고 물으면:
> 1. `risk_calculator action=full, name="삼성전자", investment=50000000` → 종합 리스크 확인
> 2. VaR 95%: -2.1% → "100일 중 5일은 105만원 이상 손실 가능"
> 3. MDD: -35% → "최악의 경우 1,750만원까지 손실 가능"
> 4. 위험 등급: 황색(중간) → "일반 투자자에게 적합"
> 5. `action=stress, name="삼성전자", investment=50000000` → "코로나급 쇼크 시 1,500만원 손실"
> 6. 보고: "연간 변동성 28%로 중간 위험. 최악의 경우 1,750만원(35%) 손실 가능하지만, 샤프 비율 0.7로 양호. 리먼급 위기에도 2,500만원(50%) 이상은 유지. 5,000만원 중 3,000만원만 투자하고 나머지는 현금 비중으로 위험 관리 권장"

### 2. 리스크관리 Specialist
**언제 쓰나?** CIO가 지시한 종목/포트폴리오의 위험을 심층 분석할 때
**어떻게 쓰나?**
- `action=var`로 일일/월간 최대손실 산출
- `action=drawdown`로 과거 낙폭 패턴 분석
- `action=volatility`로 변동성 추이 확인 (단기 변동성 급등 여부)

**실전 시나리오:**
> CIO가 "NAVER 포지션 유지할지 정리할지 판단해줘" 라고 지시하면:
> 1. `action=drawdown, name="NAVER"` → MDD -45%, 아직 미회복
> 2. `action=volatility, name="NAVER"` → 20일 변동성이 60일 대비 1.5배 → 단기 변동성 급등 경고
> 3. `action=ratios, name="NAVER"` → 샤프 0.3(부진), 소르티노 0.5(부진)
> 4. 보고: "현재 낙폭 -32%에서 미회복 상태, 단기 변동성 급등 중. 위험조정수익률 모두 부진. 포지션 축소 또는 손절 가격 설정 권장. 피보나치 61.8% 지지선을 손절 기준으로 제안"

---

## 파라미터 정리

| 파라미터 | 필수 | 타입 | 설명 |
|---------|------|------|------|
| action | O | string | full / var / drawdown / volatility / ratios / stress |
| name | X | string | 종목명 (예: "삼성전자"). name 또는 ticker 중 하나 필요 |
| ticker | X | string | 종목코드 (예: "005930"). name 또는 ticker 중 하나 필요 |
| days | X | integer | 분석 기간 (기본값: **500일** — 약 2년) |
| investment | X | integer | 투자금액 (기본값: **10,000,000원** = 1,000만원). full/var/stress에서 사용 |
| rf | X | float | 무위험 수익률 (기본값: **0.035** = 3.5%). ratios에서 사용 |

## 주의사항
- **장 마감 후 데이터 기준**입니다. 실시간 호가가 아닙니다.
- 최소 **30일** 이상의 데이터가 필요합니다. 신규 상장 종목은 분석이 안 될 수 있습니다.
- **investment 파라미터가 핵심**입니다. CEO에게 보고할 때 "VaR -2.1%"보다 **"105만원 손실 가능"**이 훨씬 이해하기 쉽습니다. 투자금을 꼭 넣으세요.
- VaR는 **과거 데이터 기반** 역사적 시뮬레이션입니다. 과거에 없던 새로운 위기(블랙 스완)는 예측하지 못합니다. 그래서 stress 액션도 함께 확인하세요.
- `days` 기본값이 500일(약 2년)로 technical_analyzer(200일)보다 깁니다. 리스크 측정은 더 긴 기간이 정확합니다.
- full과 stress 액션만 LLM 호출이 포함됩니다. var/drawdown/volatility/ratios는 순수 계산만 합니다.
