# CORTHEX HQ ëŒ€ê°œí¸ ë¦¬íŒ©í† ë§ ê³„íšì„œ

> **ì‘ì„±ì¼**: 2026-02-23
> **ëª©ì **: ì „ìˆ˜ê²€ì‚¬ ê²°ê³¼ ê¸°ë°˜ ì„œë²„ êµ¬ì¡° ëŒ€ê°œí¸
> **ì›ì¹™**: ë™ì‘í•˜ëŠ” ìƒíƒœë¥¼ ìœ ì§€í•˜ë©´ì„œ í•˜ë‚˜ì”© êµì²´ (ì§‘ ì‚´ë©´ì„œ ë°°ê´€ êµì²´)

---

## í˜„ì¬ ìƒíƒœ ìš”ì•½ (ì „ìˆ˜ê²€ì‚¬ ê²°ê³¼)

### í•µì‹¬ ìˆ˜ì¹˜

| í•­ëª© | í˜„ì¬ | ì •ìƒ ê¸°ì¤€ |
|------|------|----------|
| `mini_server.py` | **11,906ì¤„** | 500ì¤„ ì´í•˜/ëª¨ë“ˆ |
| `index.html` | **10,666ì¤„** | ì»´í¬ë„ŒíŠ¸ë³„ ë¶„ë¦¬ |
| ì „ì—­ ë³€ìˆ˜ | **44ê°œ** | ìµœì†Œí•œ + Lock |
| API ì—”ë“œí¬ì¸íŠ¸ | **55ê°œ** (ì¸ì¦ 1ê°œë§Œ) | ì „ì²´ ì¸ì¦ |
| ì¤‘ë³µ ë¸Œë¡œë“œìºìŠ¤íŠ¸ íŒ¨í„´ | **24ê³³** | í—¬í¼ í•¨ìˆ˜ 1ê°œ |
| `except Exception: pass` | **40ê³³ ì´ìƒ** | êµ¬ì²´ì  ì—ëŸ¬ + ë¡œê¹… |
| ëª¨ë¸ëª… í•˜ë“œì½”ë”© ìœ„ì¹˜ | **5ê³³ ì´ìƒ** | config 2ê³³ë§Œ |
| Config YAML/JSON ì´ì¤‘í™” | **3ìŒ** (ë™ê¸°í™” ì•ˆ ë¨) | YAML ë‹¨ì¼ |
| AI í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ | **ì—†ìŒ** | 60ì´ˆ ì œí•œ |
| ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë”•ì…”ë„ˆë¦¬ | **4ê°œ** (ì •ë¦¬ ì—†ìŒ) | TTL + ì •ë¦¬ |

### í˜„ì¬ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    mini_server.py (11,906ì¤„)                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚WebSocketâ”‚ â”‚ 55ê°œ API â”‚ â”‚í…”ë ˆê·¸ë¨  â”‚ â”‚ ì—ì´ì „íŠ¸ ë¼ìš°íŒ…/ â”‚ â”‚
â”‚  â”‚ í•¸ë“¤ëŸ¬  â”‚ â”‚ì—”ë“œí¬ì¸íŠ¸â”‚ â”‚   ë´‡    â”‚ â”‚ ìœ„ì„/í•©ì„± ë¡œì§  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚           â”‚            â”‚                â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                         â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ì „ì—­ ë³€ìˆ˜ 44ê°œ (Lock ì—†ìŒ)               â”‚  â”‚
â”‚  â”‚  connected_clients, _bg_tasks, _batch_queue,          â”‚  â”‚
â”‚  â”‚  _sse_clients, _notion_log, _price_cache ...          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ai_handler.py       â”‚
              â”‚   (1,651ì¤„)           â”‚
              â”‚   3ê°œ í”„ë¡œë°”ì´ë”      â”‚
              â”‚   ë„êµ¬ í˜¸ì¶œ ë£¨í”„      â”‚
              â”‚   ëª¨ë¸ëª… í•˜ë“œì½”ë”© 10+ â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     db.py (1,426ì¤„)   â”‚
              â”‚     SQLite 17ê°œ í…Œì´ë¸”â”‚
              â”‚     (ì–‘í˜¸)            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œ**: ëª¨ë“  ê²ƒì´ `mini_server.py` í•œ íŒŒì¼ì— ë“¤ì–´ìˆìŒ. ê¸°ëŠ¥ ì¶”ê°€í•  ë•Œë§ˆë‹¤ ì´ íŒŒì¼ì´ ì»¤ì§.

---

## ëª©í‘œ ì•„í‚¤í…ì²˜

```
web/
â”œâ”€â”€ app.py                    â† FastAPI ì•± ìƒì„± + ë¯¸ë“¤ì›¨ì–´ (100ì¤„)
â”œâ”€â”€ main.py                   â† ì„œë²„ ì‹œì‘ ì§„ì…ì  (50ì¤„)
â”œâ”€â”€ auth.py                   â† ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ (100ì¤„)
â”œâ”€â”€ db.py                     â† DB (í˜„ì¬ ìœ ì§€, ì–‘í˜¸)
â”œâ”€â”€ ai_handler.py             â† AI í˜¸ì¶œ (ë¦¬íŒ©í† ë§ í›„ 800ì¤„)
â”œâ”€â”€ state.py                  â† ì „ì—­ ìƒíƒœ ê´€ë¦¬ + Lock (200ì¤„)
â”œâ”€â”€ broadcast.py              â† WebSocket/SSE ë¸Œë¡œë“œìºìŠ¤íŠ¸ í—¬í¼ (100ì¤„)
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ websocket_handler.py  â† WebSocket ì—°ê²° + ë©”ì‹œì§€ ì²˜ë¦¬ (300ì¤„)
â”‚   â”œâ”€â”€ agent_handler.py      â† ì—ì´ì „íŠ¸ ë¼ìš°íŒ…/ìœ„ì„/í•©ì„± (800ì¤„)
â”‚   â”œâ”€â”€ task_handler.py       â† ì‘ì—… ê´€ë¦¬ API (200ì¤„)
â”‚   â”œâ”€â”€ batch_handler.py      â† ë°°ì¹˜ ì²˜ë¦¬ ì²´ì¸ (500ì¤„)
â”‚   â”œâ”€â”€ media_handler.py      â† ë¯¸ë””ì–´ ì„œë¹™/ì‚­ì œ (100ì¤„)
â”‚   â”œâ”€â”€ sns_handler.py        â† SNS í/ìŠ¹ì¸/ë°œí–‰ (300ì¤„)
â”‚   â”œâ”€â”€ trading_handler.py    â† ì£¼ì‹ íˆ¬ì API (400ì¤„)
â”‚   â”œâ”€â”€ telegram_handler.py   â† í…”ë ˆê·¸ë¨ ë´‡ (300ì¤„)
â”‚   â”œâ”€â”€ quality_handler.py    â† í’ˆì§ˆê²€ìˆ˜ API (200ì¤„)
â”‚   â””â”€â”€ debug_handler.py      â† ë””ë²„ê·¸/ë¡œê·¸ ì—”ë“œí¬ì¸íŠ¸ (100ì¤„)
â””â”€â”€ templates/
    â””â”€â”€ index.html            â† (ì¥ê¸°: ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬)
```

---

## ì‹¤í–‰ ê³„íš (12 Step)

> ë§¤ Step ì™„ë£Œ í›„ ë°°í¬ + ì„œë²„ ì •ìƒ í™•ì¸ + ì»¤ë°‹
> í•˜ë‚˜ë¼ë„ ê¹¨ì§€ë©´ ë¡¤ë°± í›„ ì›ì¸ ë¶„ì„

---

### Step 1: ë¸Œë¡œë“œìºìŠ¤íŠ¸ í—¬í¼ ì¶”ì¶œ âœ… (2026-02-23)

**ë¬¸ì œ**: WebSocket ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì½”ë“œê°€ 24ê³³ì— ë³µë¶™ë˜ì–´ ìˆìŒ
```python
# ì´ íŒ¨í„´ì´ 24ë²ˆ ë°˜ë³µë¨
for c in connected_clients[:]:
    try:
        await c.send_json({"event": "...", "data": {...}})
    except Exception:
        pass
```

**ì‘ì—… ë‚´ìš©**:
1. `web/broadcast.py` ìƒì„±
2. `broadcast_ws(event, data)` í•¨ìˆ˜ ì‘ì„± (íƒ€ì„ì•„ì›ƒ 2ì´ˆ, ì‹¤íŒ¨ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì œê±°)
3. `broadcast_sse(msg_data)` í•¨ìˆ˜ ì‘ì„±
4. `mini_server.py`ì˜ 24ê³³ì„ `broadcast_ws()` í˜¸ì¶œë¡œ êµì²´
5. `connected_clients` ë¦¬ìŠ¤íŠ¸ì— `asyncio.Lock` ì¶”ê°€

**ê²€ì¦**: ì›¹ì—ì„œ í”„ë¡¬í”„íŠ¸ ë³´ë‚´ê¸° â†’ ì‘ë‹µ ì •ìƒ ìˆ˜ì‹  í™•ì¸

**ì˜ˆìƒ íš¨ê³¼**: mini_server.py **-200ì¤„**, ë ˆì´ìŠ¤ì»¨ë””ì…˜ í•´ê²°

---

### Step 2: ì „ì—­ ìƒíƒœ ê´€ë¦¬ ëª¨ë“ˆ

**ë¬¸ì œ**: 44ê°œ ì „ì—­ ë³€ìˆ˜ê°€ mini_server.pyì— í©ì–´ì ¸ ìˆê³ , Lock ì—†ì´ ì—¬ëŸ¬ async íƒœìŠ¤í¬ì—ì„œ ë™ì‹œ ì ‘ê·¼

**ì‘ì—… ë‚´ìš©**:
1. `web/state.py` ìƒì„±
2. ëª¨ë“  ì „ì—­ ë³€ìˆ˜ë¥¼ `AppState` í´ë˜ìŠ¤ë¡œ ì´ë™:
   ```python
   class AppState:
       def __init__(self):
           self.connected_clients: list[WebSocket] = []
           self.clients_lock = asyncio.Lock()
           self.bg_tasks: dict[str, asyncio.Task] = {}
           self.bg_results: dict[str, dict] = {}
           self.bg_current_task_id: str | None = None
           self.batch_queue: list[dict] = []
           self.batch_lock = asyncio.Lock()
           self.sse_clients: list[asyncio.Queue] = []
           self.notion_log: list[dict] = []
           # ... ë‚˜ë¨¸ì§€ 44ê°œ ë³€ìˆ˜

   app_state = AppState()
   ```
3. `mini_server.py`ì—ì„œ `global` í‚¤ì›Œë“œ ì „ë¶€ ì œê±°, `app_state.xxx`ë¡œ êµì²´
4. `_bg_current_task_id` ë ˆì´ìŠ¤ì»¨ë””ì…˜: Lockìœ¼ë¡œ ë³´í˜¸

**ê²€ì¦**: ì„œë²„ ì‹œì‘ â†’ ë™ì‹œ 2ê°œ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ í”„ë¡¬í”„íŠ¸ ì „ì†¡ â†’ ì¶©ëŒ ì—†ìŒ

**ì˜ˆìƒ íš¨ê³¼**: ë ˆì´ìŠ¤ì»¨ë””ì…˜ 5ê°œ í•´ê²°, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì¶”ì  ê°€ëŠ¥

---

### Step 3: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìˆ˜ì • + AI í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ

**ë¬¸ì œ**:
- `_bg_tasks`, `_bg_results` ë”•ì…”ë„ˆë¦¬ê°€ ë¬´í•œíˆ ì»¤ì§
- `_notion_log` ë¦¬ìŠ¤íŠ¸ê°€ ë¬´í•œíˆ ì»¤ì§
- AI í˜¸ì¶œ(`ask_ai()`)ì— íƒ€ì„ì•„ì›ƒ ì—†ì–´ì„œ í–‰(hang) ê°€ëŠ¥

**ì‘ì—… ë‚´ìš©**:
1. `AppState`ì— TTL ê¸°ë°˜ ì •ë¦¬ ë©”ì„œë“œ ì¶”ê°€:
   ```python
   async def cleanup_old_tasks(self, max_age_seconds=3600):
       """1ì‹œê°„ ì´ìƒ ëœ ì™„ë£Œ íƒœìŠ¤í¬ ì •ë¦¬"""
       cutoff = time.time() - max_age_seconds
       old_keys = [k for k, v in self.bg_results.items()
                   if v.get("_completed_at", 0) < cutoff]
       for k in old_keys:
           self.bg_results.pop(k, None)
           self.bg_tasks.pop(k, None)
   ```
2. ì„œë²„ ì‹œì‘ ì‹œ ì£¼ê¸°ì  ì •ë¦¬ íƒœìŠ¤í¬ ë“±ë¡ (10ë¶„ë§ˆë‹¤)
3. `_notion_log` ìµœëŒ€ 500ê°œë¡œ ì œí•œ (FIFO)
4. `ask_ai()` í˜¸ì¶œ ì „ë¶€ì— `asyncio.wait_for(timeout=120)` ë˜í•‘
5. íƒ€ì„ì•„ì›ƒ ì‹œ ì‚¬ìš©ìì—ê²Œ "AI ì‘ë‹µ ì‹œê°„ ì´ˆê³¼" ë©”ì‹œì§€ ì „ì†¡

**ê²€ì¦**: ì„œë²„ 1ì‹œê°„ ìš´ì˜ í›„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (ì¦ê°€ ì•ˆ í•´ì•¼ í•¨)

**ì˜ˆìƒ íš¨ê³¼**: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í•´ê²°, ë¬´í•œ ëŒ€ê¸° í•´ê²°

---

### Step 4: ì—ëŸ¬ í•¸ë“¤ë§ ì •ë¦¬

**ë¬¸ì œ**: `except Exception: pass`ê°€ 40ê³³ ì´ìƒ. ì—ëŸ¬ê°€ ì‚¼ì¼œì ¸ì„œ ë””ë²„ê¹… ë¶ˆê°€ëŠ¥

**ì‘ì—… ë‚´ìš©**:
1. ëª¨ë“  `except Exception: pass` ê²€ìƒ‰ (40ê³³+)
2. ê°ê° ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ êµì²´:
   - **ë¬´ì‹œí•´ë„ ë˜ëŠ” ê²ƒ**: `except Exception: pass` â†’ ì£¼ì„ìœ¼ë¡œ ì´ìœ  ëª…ì‹œ
   - **ë¡œê¹… í•„ìš”**: `except Exception as e: logger.warning("...: %s", e)`
   - **ì „íŒŒ í•„ìš”**: `except SpecificError` ë˜ëŠ” `raise`
3. ì—ëŸ¬ ë°˜í™˜ í˜•ì‹ í†µì¼: ëª¨ë“  í•¨ìˆ˜ê°€ `{"error": "ë©”ì‹œì§€"}` ë˜ëŠ” ì˜ˆì™¸ ë°œìƒ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©

**ê²€ì¦**: ì˜ë„ì ìœ¼ë¡œ ì˜ëª»ëœ API í‚¤ë¡œ í˜¸ì¶œ â†’ ì—ëŸ¬ ë¡œê·¸ í™•ì¸

**ì˜ˆìƒ íš¨ê³¼**: ë””ë²„ê¹… ì‹œê°„ 50% ë‹¨ì¶•

---

### Step 5: í•¸ë“¤ëŸ¬ ëª¨ë“ˆ ë¶„ë¦¬ â€” ë¯¸ë””ì–´ + SNS + ë””ë²„ê·¸

**ë¬¸ì œ**: ë¯¸ë””ì–´, SNS, ë””ë²„ê·¸ ì—”ë“œí¬ì¸íŠ¸ê°€ mini_server.pyì— ì„ì—¬ ìˆìŒ

**ì‘ì—… ë‚´ìš©**:
1. `web/handlers/` ë””ë ‰í† ë¦¬ ìƒì„±
2. `media_handler.py` ì¶”ì¶œ:
   - `/api/media/images/{filename}`, `/api/media/videos/{filename}`
   - `/api/media/list`, `/api/media/{type}/{filename}` DELETE
   - `/api/media/delete-batch`
3. `sns_handler.py` ì¶”ì¶œ:
   - `/api/sns/status`, `/api/sns/queue`, `/api/sns/approve/{id}`
   - `/api/sns/reject/{id}`, `/api/sns/publish/{id}`
   - `/api/sns/queue` DELETE, `/api/sns/events`
   - OAuth ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ ì „ë¶€
4. `debug_handler.py` ì¶”ì¶œ:
   - `/api/debug/server-logs`, ê¸°íƒ€ ë””ë²„ê·¸ ì—”ë“œí¬ì¸íŠ¸
5. FastAPI Router ì‚¬ìš©:
   ```python
   # web/handlers/media_handler.py
   from fastapi import APIRouter
   router = APIRouter(prefix="/api/media", tags=["media"])

   @router.get("/list")
   async def list_media(): ...
   ```
6. `mini_server.py`ì—ì„œ `app.include_router(media_router)` ë“±ë¡

**ê²€ì¦**: ë¯¸ë””ì–´ íƒ­ ì—´ê¸°, SNS ìŠ¹ì¸í ì—´ê¸°, ì„œë²„ ë¡œê·¸ í™•ì¸ â€” ì „ë¶€ ì •ìƒ

**ì˜ˆìƒ íš¨ê³¼**: mini_server.py **-800ì¤„**

---

### Step 6: í•¸ë“¤ëŸ¬ ëª¨ë“ˆ ë¶„ë¦¬ â€” ì‘ì—… + ë°°ì¹˜ + í’ˆì§ˆ

**ì‘ì—… ë‚´ìš©**:
1. `task_handler.py` ì¶”ì¶œ:
   - `/api/tasks` GET/POST/DELETE/PUT ì „ë¶€
   - `/api/tasks/{id}/bookmark`, `/api/tasks/{id}/cancel` ë“±
2. `batch_handler.py` ì¶”ì¶œ:
   - `/api/batch/*` ì „ë¶€ (í, ì²´ì¸, API ë°°ì¹˜, íˆìŠ¤í† ë¦¬)
   - `_run_batch_chain()`, `_start_batch_chain()` í•¨ìˆ˜
3. `quality_handler.py` ì¶”ì¶œ:
   - `/api/quality`, `/api/quality-rules/*`
   - í’ˆì§ˆê²€ìˆ˜ ê´€ë ¨ ë¡œì§

**ê²€ì¦**: ë°°ì¹˜ ì²´ì¸ ì‹¤í–‰, í’ˆì§ˆê²€ìˆ˜ íƒ­, ì‘ì—… ëª©ë¡ â€” ì „ë¶€ ì •ìƒ

**ì˜ˆìƒ íš¨ê³¼**: mini_server.py **-2,000ì¤„**

---

### Step 7: í•¸ë“¤ëŸ¬ ëª¨ë“ˆ ë¶„ë¦¬ â€” ì—ì´ì „íŠ¸ + í…”ë ˆê·¸ë¨

**ì‘ì—… ë‚´ìš©**:
1. `agent_handler.py` ì¶”ì¶œ:
   - `_process_ai_command()`, `_route_task()`, `_call_agent()`
   - `_manager_with_delegation()`, `_broadcast_to_managers_all()`
   - ì—ì´ì „íŠ¸ ë¼ìš°íŒ…, ë¶„ë¥˜, ìœ„ì„ ì²´ì¸ ì „ì²´
2. `telegram_handler.py` ì¶”ì¶œ:
   - í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™”, í•¸ë“¤ëŸ¬, CEO ì•Œë¦¼
3. `websocket_handler.py` ì¶”ì¶œ:
   - WebSocket ì—°ê²° ê´€ë¦¬, ë©”ì‹œì§€ ë¼ìš°íŒ…
   - `_run_agent_bg()` ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬

**ê²€ì¦**: ì›¹ ì±„íŒ…, í…”ë ˆê·¸ë¨ ë©”ì‹œì§€, ì—ì´ì „íŠ¸ ì‘ë‹µ â€” ì „ë¶€ ì •ìƒ

**ì˜ˆìƒ íš¨ê³¼**: mini_server.py â†’ **app.py (500ì¤„)** ìœ¼ë¡œ ì¶•ì†Œ. 11,906ì¤„ â†’ 500ì¤„ ë‹¬ì„±

---

### Step 8: ai_handler.py ë¦¬íŒ©í† ë§

**ë¬¸ì œ**:
- ëª¨ë¸ëª… 10ê³³ ì´ìƒ í•˜ë“œì½”ë”©
- 3ê°œ í”„ë¡œë°”ì´ë” ë„êµ¬ í˜¸ì¶œ ì½”ë“œ 3ë²Œ ë³µë¶™
- ë„êµ¬ ê²°ê³¼ truncation `[:4000]` 3ê³³ í•˜ë“œì½”ë”©
- Extended thinking ë©”ëª¨ë¦¬ ëˆ„ì 

**ì‘ì—… ë‚´ìš©**:
1. ëª¨ë¸ëª… â†’ `config/models.yaml`ì—ì„œ ì½ë„ë¡ ë³€ê²½
   ```python
   # ë³€ê²½ ì „: í•˜ë“œì½”ë”©
   default_model = "claude-sonnet-4-6"

   # ë³€ê²½ í›„: configì—ì„œ ë¡œë“œ
   default_model = MODELS_CONFIG["defaults"]["anthropic"]
   ```
2. í”„ë¡œë°”ì´ë”ë³„ ë„êµ¬ í˜¸ì¶œ ê³µí†µ íŒ¨í„´ ì¶”ì¶œ:
   ```python
   async def _execute_tool_loop(provider, messages, tools, executor, max_iter=10):
       """3ê°œ í”„ë¡œë°”ì´ë” ê³µí†µ ë„êµ¬ í˜¸ì¶œ ë£¨í”„"""
   ```
3. `TOOL_RESULT_MAX_CHARS = 4000` ìƒìˆ˜í™”
4. Extended thinking ë¸”ë¡ â†’ ë£¨í”„ ë°˜ë³µ ì‹œ ì œê±° (ë©”ëª¨ë¦¬ ì ˆì•½)
5. `_PRICING` ë”•ì…”ë„ˆë¦¬ â†’ `models.yaml`ì—ì„œ ë¡œë“œ

**ê²€ì¦**: 3ê°œ í”„ë¡œë°”ì´ë”(Claude, GPT, Gemini) ê°ê° ë„êµ¬ í˜¸ì¶œ í…ŒìŠ¤íŠ¸

**ì˜ˆìƒ íš¨ê³¼**: ai_handler.py 1,651ì¤„ â†’ 800ì¤„, ëª¨ë¸ ë³€ê²½ ì‹œ configë§Œ ìˆ˜ì •

---

### Step 9: Config ì´ì¤‘í™” í•´ê²°

**ë¬¸ì œ**: YAMLê³¼ JSONì´ ë™ê¸°í™” ì•ˆ ë¨. ì„œë²„ê°€ êµ¬ë²„ì „ JSON ë¡œë“œ ìœ„í—˜

**ì‘ì—… ë‚´ìš©**:
1. `deploy.yml`ì— yaml2json ìë™ ì‹¤í–‰ ë‹¨ê³„ ì¶”ê°€:
   ```yaml
   - name: YAML â†’ JSON ë™ê¸°í™”
     run: cd config && python yaml2json.py
   ```
2. `yaml2json.py` ì˜¤ë¥˜ ì‹œ ë°°í¬ ì¤‘ë‹¨ (exit 1)
3. ì„œë²„ ì½”ë“œ: YAML ì§ì ‘ ë¡œë“œë¡œ í†µì¼ (JSON í´ë°± ì œê±°)
4. `config/*.json` íŒŒì¼ â†’ `.gitignore`ì— ì¶”ê°€ (ì„œë²„ì—ì„œë§Œ ìƒì„±)

**ê²€ì¦**: ë°°í¬ í›„ `agents.yaml` ìˆ˜ì • â†’ ì„œë²„ ë°˜ì˜ í™•ì¸

**ì˜ˆìƒ íš¨ê³¼**: Config ë™ê¸°í™” ë¬¸ì œ ì˜êµ¬ í•´ê²°

---

### Step 10: ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€

**ë¬¸ì œ**: 55ê°œ ì—”ë“œí¬ì¸íŠ¸ ì¤‘ 1ê°œë§Œ ì¸ì¦. ëˆ„êµ¬ë‚˜ API í˜¸ì¶œ ê°€ëŠ¥

**ì‘ì—… ë‚´ìš©**:
1. `web/auth.py` ìƒì„±
2. FastAPI ë¯¸ë“¤ì›¨ì–´ë¡œ ì „ì²´ `/api/*` ê²½ë¡œì— í† í° ê²€ì¦:
   ```python
   @app.middleware("http")
   async def auth_middleware(request: Request, call_next):
       # /api/auth/login, /api/debug/server-logs ë“± í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì œì™¸
       if request.url.path.startswith("/api/") and not is_whitelisted(path):
           token = request.headers.get("x-auth-token")
           if not verify_token(token):
               return JSONResponse({"error": "ì¸ì¦ í•„ìš”"}, 401)
       return await call_next(request)
   ```
3. í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸: `/api/auth/*`, `/api/debug/server-logs` (Cloudflare WAF Skip)
4. `hmac.compare_digest()` ì‚¬ìš© (íƒ€ì´ë° ê³µê²© ë°©ì§€)

**ê²€ì¦**: í† í° ì—†ì´ API í˜¸ì¶œ â†’ 401, í† í° ìˆìœ¼ë©´ ì •ìƒ

**ì˜ˆìƒ íš¨ê³¼**: ë³´ì•ˆ ì·¨ì•½ì  í•´ê²°

---

### Step 11: ì…ë ¥ ê²€ì¦ + ì„œë²„ ì…§ë‹¤ìš´ ì •ë¦¬

**ë¬¸ì œ**:
- WebSocket ë©”ì‹œì§€ í¬ê¸° ì œí•œ ì—†ìŒ (1MB JSON ê°€ëŠ¥)
- ì„œë²„ ì¢…ë£Œ ì‹œ ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ ì •ë¦¬ ì•ˆ ë¨

**ì‘ì—… ë‚´ìš©**:
1. WebSocket ë©”ì‹œì§€ ìµœëŒ€ í¬ê¸° ì œí•œ (64KB)
2. API POST body ìµœëŒ€ í¬ê¸° ì œí•œ (1MB)
3. ì„œë²„ ì…§ë‹¤ìš´ í•¸ë“¤ëŸ¬ì— íƒœìŠ¤í¬ ì •ë¦¬ ì¶”ê°€:
   ```python
   @app.on_event("shutdown")
   async def on_shutdown():
       # ëª¨ë“  ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ ì·¨ì†Œ
       for task_id, task in app_state.bg_tasks.items():
           task.cancel()
       # í…”ë ˆê·¸ë¨ ë´‡ ì¢…ë£Œ
       await stop_telegram_bot()
       # DB ì—°ê²° ì •ë¦¬
       close_db()
   ```
4. `asyncio.create_task()` í˜¸ì¶œ ì‹œ ëª¨ë‘ `app_state.bg_tasks`ì— ë“±ë¡

**ê²€ì¦**: ì„œë²„ ì¬ì‹œì‘ ì‹œ "graceful shutdown" ë¡œê·¸ í™•ì¸

---

### Step 12: index.html êµ¬ì¡° ì •ë¦¬ (ì¥ê¸°)

**ë¬¸ì œ**: 10,666ì¤„ ë‹¨ì¼ HTML. Alpine.js ë°ì´í„°/ë©”ì„œë“œê°€ 3,000ì¤„ ì´ìƒ

**ì‘ì—… ë‚´ìš©** (ì ì§„ì ):
1. Alpine.js ë©”ì„œë“œë¥¼ ì™¸ë¶€ JS íŒŒì¼ë¡œ ë¶„ë¦¬:
   ```
   web/static/js/
   â”œâ”€â”€ app.js          â† Alpine.js ë©”ì¸ ë°ì´í„°
   â”œâ”€â”€ chat.js         â† ì±„íŒ… ê´€ë ¨ ë©”ì„œë“œ
   â”œâ”€â”€ sns.js          â† SNS/ë¯¸ë””ì–´ ê´€ë ¨ ë©”ì„œë“œ
   â”œâ”€â”€ trading.js      â† ì£¼ì‹ ê´€ë ¨ ë©”ì„œë“œ
   â””â”€â”€ utils.js        â† ê³µí†µ ìœ í‹¸ (showToast ë“±)
   ```
2. HTML í…œí”Œë¦¿ì„ Jinja2 includeë¡œ ë¶„ë¦¬:
   ```
   web/templates/
   â”œâ”€â”€ index.html          â† ë©”ì¸ ë ˆì´ì•„ì›ƒë§Œ
   â”œâ”€â”€ partials/
   â”‚   â”œâ”€â”€ chat_panel.html
   â”‚   â”œâ”€â”€ sns_panel.html
   â”‚   â”œâ”€â”€ trading_panel.html
   â”‚   â””â”€â”€ sidebar.html
   ```

**ê²€ì¦**: ëª¨ë“  íƒ­ ì •ìƒ ë™ì‘ + ëª¨ë°”ì¼ UI í™•ì¸

**ì˜ˆìƒ íš¨ê³¼**: HTML ìœ ì§€ë³´ìˆ˜ì„± ëŒ€í­ í–¥ìƒ

---

## ì‹¤í–‰ ìˆœì„œ & ì˜ì¡´ì„±

```
Step 1 (ë¸Œë¡œë“œìºìŠ¤íŠ¸ í—¬í¼) â”€â”€â”
Step 2 (ì „ì—­ ìƒíƒœ ê´€ë¦¬)     â”€â”€â”¼â”€â”€ Step 5~7 (í•¸ë“¤ëŸ¬ ë¶„ë¦¬)
Step 3 (ë©”ëª¨ë¦¬+íƒ€ì„ì•„ì›ƒ)    â”€â”€â”˜        â”‚
Step 4 (ì—ëŸ¬ í•¸ë“¤ë§)        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
Step 8 (ai_handler ë¦¬íŒ©í† ë§) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Step 9 (Config ì´ì¤‘í™”)       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Step 10 (ì¸ì¦ ë¯¸ë“¤ì›¨ì–´)      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Step 11 (ì…ë ¥ê²€ì¦+ì…§ë‹¤ìš´)    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Step 12 (index.html ë¶„ë¦¬)    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 1~4ëŠ” ê¸°ë°˜ ì‘ì—…** â†’ ì´ê²Œ ëë‚˜ì•¼ 5~7 ë¶„ë¦¬ ê°€ëŠ¥
**Step 5~7ì€ í•µì‹¬** â†’ mini_server.pyë¥¼ 11,906ì¤„ â†’ 500ì¤„ë¡œ ì¤„ì„
**Step 8~12ëŠ” ë§ˆë¬´ë¦¬** â†’ í’ˆì§ˆ í–¥ìƒ

---

## ì˜ˆìƒ ê²°ê³¼

| í•­ëª© | í˜„ì¬ | ì™„ë£Œ í›„ |
|------|------|---------|
| `mini_server.py` | 11,906ì¤„ | **~500ì¤„** (ë¼ìš°í„° ë“±ë¡ë§Œ) |
| ì „ì—­ ë³€ìˆ˜ | 44ê°œ (Lock ì—†ìŒ) | **AppState 1ê°œ** (Lock ìˆìŒ) |
| ì¤‘ë³µ ì½”ë“œ | 24ê³³ ë¸Œë¡œë“œìºìŠ¤íŠ¸ | **í—¬í¼ 1ê°œ** |
| ì—ëŸ¬ í•¸ë“¤ë§ | `pass` 40ê³³ | **êµ¬ì²´ì  ë¡œê¹…** |
| ì¸ì¦ | 1/55 ì—”ë“œí¬ì¸íŠ¸ | **ì „ì²´ ë¯¸ë“¤ì›¨ì–´** |
| ëª¨ë¸ëª… ê´€ë¦¬ | 5ê³³ ë¶„ì‚° | **config 2ê³³** |
| AI í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ | ì—†ìŒ | **120ì´ˆ ì œí•œ** |
| ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ | ë¬´í•œ ì¦ê°€ | **TTL ìë™ ì •ë¦¬** |

---

## ì£¼ì˜ì‚¬í•­

1. **ë§¤ Step ì™„ë£Œ = ì»¤ë°‹ + ë°°í¬ + ì„œë²„ ì •ìƒ í™•ì¸** (ê¹¨ì§„ ìƒíƒœë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ)
2. **Step ì‹¤íŒ¨ ì‹œ**: í•´ë‹¹ Stepë§Œ ë¡¤ë°±, ì›ì¸ ë¶„ì„ í›„ ì¬ì‹œë„
3. **ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ê¸ˆì§€**: ë¦¬íŒ©í† ë§ ì¤‘ì—ëŠ” ê¸°ëŠ¥ ì¶”ê°€ ì•ˆ í•¨ (ì½”ë“œ ì¶©ëŒ ë°©ì§€)
4. **ëŒ€í‘œë‹˜ í™•ì¸ í•„ìš”í•œ ì‹œì **: Step 5~7 ì™„ë£Œ í›„ (ì„œë²„ êµ¬ì¡° ëŒ€ë³€ê²½)
5. **ì»´íŒ©(context compaction) ëŒ€ë¹„**: ì´ ë¬¸ì„œê°€ GitHubì— ìˆìœ¼ë¯€ë¡œ ìƒˆ ì„¸ì…˜ì—ì„œë„ ì½ì„ ìˆ˜ ìˆìŒ

---

## ì´ ë¬¸ì„œ ì‚¬ìš©ë²• (Claude ì„¸ì…˜ìš©)

1. ìƒˆ ì„¸ì…˜ ì‹œì‘ ì‹œ ì´ íŒŒì¼ ì½ê¸°: `docs/REFACTORING_PLAN.md`
2. í˜„ì¬ ì–´ë””ê¹Œì§€ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸ (Step N ì»¤ë°‹ ë©”ì‹œì§€)
3. ë‹¤ìŒ Step ì‹¤í–‰
4. ì™„ë£Œ ì‹œ ì´ ë¬¸ì„œì˜ í•´ë‹¹ Stepì— âœ… í‘œì‹œ + ë‚ ì§œ ê¸°ë¡

---

## ì¶”ê°€ ê¸°ëŠ¥ ê³„íš (ë¦¬íŒ©í† ë§ ì™„ë£Œ í›„)

### Step 13: ë©€í‹°í„´ ëŒ€í™” ê¸°ëŠ¥

**í˜„ì¬**: ì—ì´ì „íŠ¸ì—ê²Œ ëª…ë ¹ 1ê°œ â†’ ì‘ë‹µ 1ê°œ (1í„´). ì´ì „ ëŒ€í™”ë¥¼ ê¸°ì–µ ëª»í•¨.

**ëª©í‘œ**: ì—ì´ì „íŠ¸ê°€ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ê¸°ì–µí•˜ê³ , ì´ì–´ì„œ ëŒ€í™”í•  ìˆ˜ ìˆìŒ.

**ë¹„ìœ **: í˜„ì¬ëŠ” ë§¤ë²ˆ ìƒˆ ìƒë‹´ì›ê³¼ í†µí™” â†’ ì´í›„ì—” ê°™ì€ ìƒë‹´ì›ì´ ì´ì „ ìƒë‹´ ë‚´ì—­ì„ ë³´ë©´ì„œ ì‘ë‹µ

**êµ¬í˜„ ë°©ë²•**:
1. **ëŒ€í™” ì„¸ì…˜ ID** ìƒì„±: ì›¹ ì±„íŒ…ì—ì„œ í•œ ë²ˆì˜ ëŒ€í™” íë¦„ì— ê³ ìœ  ID ë¶€ì—¬
2. **ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ê´€ë¦¬**: ê°™ì€ ì„¸ì…˜ì˜ ë©”ì‹œì§€ë¥¼ DBì— ìˆœì„œëŒ€ë¡œ ì €ì¥
   ```
   ì„¸ì…˜ A: ì‚¬ìš©ì "ì‚¼ì„±ì „ì ë¶„ì„í•´ì¤˜" â†’ AI "ì‚¼ì„±ì „ìëŠ”..."
   ì„¸ì…˜ A: ì‚¬ìš©ì "ê²½ìŸì‚¬ë„ ë¹„êµí•´ì¤˜" â†’ AI "(ì´ì „ ëŒ€í™”ë¥¼ ê¸°ì–µí•˜ê³ ) SKí•˜ì´ë‹‰ìŠ¤ì™€ ë¹„êµí•˜ë©´..."
   ```
3. **AI í˜¸ì¶œ ì‹œ íˆìŠ¤í† ë¦¬ ì£¼ì…**: `ask_ai()`ì— ì´ì „ ë©”ì‹œì§€ë“¤ì„ `messages` ë°°ì—´ë¡œ ì „ë‹¬
   ```python
   messages = [
       {"role": "system", "content": "ë‹¹ì‹ ì€ CTO ì²˜ì¥ì…ë‹ˆë‹¤..."},
       {"role": "user", "content": "ì‚¼ì„±ì „ì ë¶„ì„í•´ì¤˜"},         # ì´ì „ ëŒ€í™”
       {"role": "assistant", "content": "ì‚¼ì„±ì „ìëŠ”..."},        # ì´ì „ ì‘ë‹µ
       {"role": "user", "content": "ê²½ìŸì‚¬ë„ ë¹„êµí•´ì¤˜"},         # í˜„ì¬ ì§ˆë¬¸
   ]
   ```
4. **í† í° ë¹„ìš© ê´€ë¦¬**: íˆìŠ¤í† ë¦¬ê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ìš”ì•½ â†’ ë¹„ìš© í­ì¦ ë°©ì§€
5. **ìƒˆ ëŒ€í™” ì‹œì‘**: "ìƒˆ ëŒ€í™”" ë²„íŠ¼ â†’ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
6. **ì—ì´ì „íŠ¸ ì „í™˜ ì‹œ**: ë‹¤ë¥¸ ì—ì´ì „íŠ¸ì—ê²Œ ë„˜ì–´ê°€ë©´ íˆìŠ¤í† ë¦¬ ë¶„ë¦¬ ë˜ëŠ” ìš”ì•½ ì „ë‹¬

**UI ë³€ê²½**:
- ì±„íŒ…ì°½ ìƒë‹¨ì— "ìƒˆ ëŒ€í™” ì‹œì‘" ë²„íŠ¼
- ëŒ€í™” ì„¸ì…˜ ëª©ë¡ (ì´ì „ ëŒ€í™” ë‹¤ì‹œ ë³´ê¸°)
- í˜„ì¬ ëŒ€í™”ì˜ í„´ ìˆ˜ í‘œì‹œ (ì˜ˆ: "3í„´ì§¸")

**ì£¼ì˜ì‚¬í•­**:
- ë©€í‹°í„´ì€ ë¹„ìš©ì´ ëŠ˜ì–´ë‚¨ (ì´ì „ ëŒ€í™”ë¥¼ ë§¤ë²ˆ ë³´ë‚´ì•¼ í•˜ë¯€ë¡œ)
- í† í° ìƒí•œì„  ì„¤ì • í•„ìˆ˜ (ì˜ˆ: ìµœëŒ€ 10í„´, ì´í›„ ìë™ ìš”ì•½)
- ë°°ì¹˜ ëª¨ë“œì™€ í˜¸í™˜ í•„ìš”

**ì˜ˆìƒ íš¨ê³¼**: ëŒ€í™”ì˜ ë§¥ë½ì„ ìœ ì§€í•´ì„œ ë” ì •í™•í•œ ë‹µë³€ + CEO ì§€ì‹œ ì—°ì†ì„± í™•ë³´

---

### Step 14: ì•„í‚¤í…ì²˜ ë§µ ëŒ€ì‹œë³´ë“œ

**í˜„ì¬**: ì‹œìŠ¤í…œ êµ¬ì¡°ë¥¼ ë³¼ ë°©ë²• ì—†ìŒ. ì½”ë“œë¥¼ ì§ì ‘ ì—´ì–´ë´ì•¼ í•¨.

**ëª©í‘œ**: ì›¹ ëŒ€ì‹œë³´ë“œì—ì„œ CORTHEX ì‹œìŠ¤í…œ êµ¬ì¡°ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥.

**ë¹„ìœ **: íšŒì‚¬ ì¡°ì§ë„ + ì—…ë¬´ íë¦„ë„ë¥¼ ì›¹ì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ê²ƒ

**êµ¬í˜„ ë‚´ìš©**:
1. **ì¡°ì§ë„ íƒ­**: ì—ì´ì „íŠ¸ ê´€ê³„ ì‹œê°í™” (ë¹„ì„œì‹¤ì¥ â†’ 6ê°œ ì²˜ì¥ â†’ ì „ë¬¸ê°€ë“¤)
2. **ë°ì´í„° íë¦„ë„**: ëª…ë ¹ì´ ì–´ë–¤ ê²½ë¡œë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™”ì‚´í‘œë¡œ í‘œì‹œ
3. **ì‹¤ì‹œê°„ ìƒíƒœ**: í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì—ì´ì „íŠ¸ í•˜ì´ë¼ì´íŠ¸
4. **API ë§µ**: 55ê°œ ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ + ê°ê°ì˜ ê¸°ëŠ¥ ì„¤ëª…
5. **ëª¨ë“ˆ êµ¬ì¡°**: ë¦¬íŒ©í† ë§ í›„ íŒŒì¼ êµ¬ì¡° (handlers, state, broadcast ë“±)
6. **ë¹„ìš© íë¦„**: ì–´ë–¤ ì—ì´ì „íŠ¸ê°€ ì–¼ë§ˆë‚˜ ì“°ëŠ”ì§€ ì‹œê°í™”

**ê¸°ìˆ  ì„ íƒ**: Mermaid.js (CDN, ì„¤ì¹˜ ë¶ˆí•„ìš”) ë˜ëŠ” D3.js

---

## ì•ìœ¼ë¡œ ì›¹í˜ì´ì§€ë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ë§Œë“œëŠ” ë°©ë²•

### ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì–´ë–¤ ê¸°ëŠ¥ì´ë“  ì¶”ê°€í•  ë•Œ ì•„ë˜ ìˆœì„œë¥¼ ë”°ë¦…ë‹ˆë‹¤:

| ìˆœì„œ | í•  ì¼ | ì„¤ëª… |
|------|-------|------|
| 1 | **ì–´ë””ì— ë„£ì„ì§€ ê²°ì •** | í•´ë‹¹í•˜ëŠ” handler íŒŒì¼ì„ ì°¾ê±°ë‚˜, ì—†ìœ¼ë©´ ìƒˆ handler ìƒì„± |
| 2 | **API ì—”ë“œí¬ì¸íŠ¸ ì‘ì„±** | `handlers/xxx_handler.py`ì— FastAPI Routerë¡œ ì¶”ê°€ |
| 3 | **ìƒíƒœ ê´€ë¦¬** | í•„ìš”í•œ ì „ì—­ ë³€ìˆ˜ëŠ” `state.py`ì˜ AppStateì— ì¶”ê°€ |
| 4 | **WebSocket ì•Œë¦¼** | ì‹¤ì‹œê°„ ì•Œë¦¼ì´ í•„ìš”í•˜ë©´ `wm.broadcast()` ì‚¬ìš© |
| 5 | **í”„ë¡ íŠ¸ì—”ë“œ** | `index.html`(ë‚˜ì¤‘ì— ì»´í¬ë„ŒíŠ¸)ì— UI ì¶”ê°€ |
| 6 | **í…ŒìŠ¤íŠ¸** | ì„œë²„ ë¡œê·¸ í™•ì¸ + ì›¹ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸ |
| 7 | **ê¸°ë¡** | ì—…ë°ì´íŠ¸ ê¸°ë¡ + ì´ ê³„íšì„œì— ë³€ê²½ì‚¬í•­ ë°˜ì˜ |

### íŒŒì¼ êµ¬ì¡° ê·œì¹™ (ë¦¬íŒ©í† ë§ í›„)

```
ìƒˆ ê¸°ëŠ¥ "ì£¼ì‹ ì•Œë¦¼" ì¶”ê°€ ì˜ˆì‹œ:

1. web/handlers/trading_handler.py  â†’ API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
2. web/state.py                     â†’ AppStateì— alert_settings ì¶”ê°€
3. web/ws_manager.py               â†’ wm.broadcast("stock_alert", ...) ì‚¬ìš©
4. web/templates/index.html        â†’ ì£¼ì‹ íƒ­ì— ì•Œë¦¼ UI ì¶”ê°€
5. config/agents.yaml              â†’ ê´€ë ¨ ì—ì´ì „íŠ¸ ì„¤ì • (í•„ìš” ì‹œ)
```

### í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ

| ê¸ˆì§€ ì‚¬í•­ | ì´ìœ  |
|-----------|------|
| mini_server.pyì— ì§ì ‘ ì½”ë“œ ì¶”ê°€ | ë¦¬íŒ©í† ë§ ì™„ë£Œ í›„ mini_server.pyëŠ” ì§„ì…ì ë§Œ. handlerì— ì¶”ê°€í•  ê²ƒ |
| ì „ì—­ ë³€ìˆ˜ ì§ì ‘ ì„ ì–¸ | `state.py`ì˜ AppStateì— ì¶”ê°€í•  ê²ƒ |
| `for c in connected_clients` ë£¨í”„ | `wm.broadcast()` ì‚¬ìš©í•  ê²ƒ |
| JSON íŒŒì¼ì— ë°ì´í„° ì €ì¥ | SQLite DB (`save_setting`/`load_setting`) ì‚¬ìš©í•  ê²ƒ |
| ëª¨ë¸ëª… í•˜ë“œì½”ë”© | `config/models.yaml`ì—ë§Œ ì •ì˜í•  ê²ƒ |

---

## ë¹„ê°œë°œìë¥¼ ìœ„í•œ ìš©ì–´ ì„¤ëª…

| ìš©ì–´ | ì‰¬ìš´ ì„¤ëª… |
|------|----------|
| **ë¦¬íŒ©í† ë§** | ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ, ë‚´ë¶€ ì½”ë“œ ì •ë¦¬. ì§‘ êµ¬ì¡° ë¦¬ëª¨ë¸ë§ê³¼ ê°™ìŒ |
| **ë¸Œë¡œë“œìºìŠ¤íŠ¸** | ëª¨ë“  ì ‘ì†ìì—ê²Œ ë™ì‹œì— ë©”ì‹œì§€ ë³´ë‚´ê¸° (ë°©ì†¡ì²˜ëŸ¼) |
| **WebSocket** | ë¸Œë¼ìš°ì €ì™€ ì„œë²„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ëŒ€í™”í•˜ëŠ” ì „í™”ì„  |
| **SSE** | ì„œë²„â†’ë¸Œë¼ìš°ì € í•œ ë°©í–¥ ì‹¤ì‹œê°„ ì•Œë¦¼ (ë°©ì†¡ ì „íŒŒ ê°™ì€ ê²ƒ) |
| **API ì—”ë“œí¬ì¸íŠ¸** | ì„œë²„ê°€ ë°›ëŠ” "ì£¼ì†Œ+ëª…ë ¹". ì˜ˆ: `/api/tasks` = "ì‘ì—… ëª©ë¡ ì¤˜" |
| **ì „ì—­ ë³€ìˆ˜** | ì„œë²„ ì „ì²´ê°€ ê³µìœ í•˜ëŠ” ë©”ëª¨ (ì—¬ëŸ¬ ëª…ì´ ë™ì‹œì— ì“°ë©´ ìœ„í—˜) |
| **Lock** | ë©”ëª¨ì— "ì‚¬ìš©ì¤‘" í‘œì‹œ â†’ í•œ ëª…ì”©ë§Œ ì“°ê²Œ í•˜ëŠ” ì¥ì¹˜ |
| **ë¯¸ë“¤ì›¨ì–´** | ëª¨ë“  ìš”ì²­ì´ í†µê³¼í•˜ëŠ” ê²€ë¬¸ì†Œ (ì¸ì¦ ì²´í¬ ë“±) |
| **í•¸ë“¤ëŸ¬** | íŠ¹ì • ì¢…ë¥˜ì˜ ìš”ì²­ì„ ì „ë‹´í•˜ëŠ” ë‹´ë‹¹ì (ë¯¸ë””ì–´ í•¸ë“¤ëŸ¬, SNS í•¸ë“¤ëŸ¬ ë“±) |
| **ì‹±ê¸€í„´** | í”„ë¡œê·¸ë¨ ì „ì²´ì—ì„œ ë”± 1ê°œë§Œ ì¡´ì¬í•˜ëŠ” ê´€ë¦¬ì (ì˜ˆ: wm) |
| **íƒ€ì„ì•„ì›ƒ** | "Nì´ˆ ì•ˆì— ì‘ë‹µ ì—†ìœ¼ë©´ í¬ê¸°" ê·œì¹™ |
| **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜** | ì“°ê³  ë²„ë¦° ë°ì´í„°ê°€ ê³„ì† ìŒ“ì—¬ì„œ ì„œë²„ê°€ ëŠë ¤ì§€ëŠ” í˜„ìƒ |
| **TTL (Time To Live)** | ë°ì´í„° ìœ íš¨ê¸°ê°„. ì‹œê°„ ì§€ë‚˜ë©´ ìë™ ì‚­ì œ |
| **ë©€í‹°í„´** | ëŒ€í™”ë¥¼ ì´ì–´ê°€ëŠ” ê²ƒ. "ì´ì „ì— ë§í•œ ê±° ê¸°ì–µí•˜ë‹ˆ?" ê°€ëŠ¥ |
| **Router** | FastAPIì—ì„œ API ì£¼ì†Œë¥¼ ê·¸ë£¹ë³„ë¡œ ê´€ë¦¬í•˜ëŠ” ë„êµ¬ |

---

## ì§„í–‰ ìƒí™© ì¶”ì 

| Step | ìƒíƒœ | ë‚ ì§œ | ë¹Œë“œ# | ë‚´ìš© |
|------|------|------|-------|------|
| 1 | âœ… ì™„ë£Œ | 2026-02-23 | PR#493 | ë¸Œë¡œë“œìºìŠ¤íŠ¸ í—¬í¼ ì¶”ì¶œ (30ê³³ â†’ wm 1ê³³) |
| 2 | ğŸ”„ ì§„í–‰ì¤‘ | 2026-02-23 | - | ì „ì—­ ìƒíƒœ ê´€ë¦¬ ëª¨ë“ˆ |
| 3 | â¬œ ëŒ€ê¸° | - | - | ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìˆ˜ì • + AI íƒ€ì„ì•„ì›ƒ |
| 4 | â¬œ ëŒ€ê¸° | - | - | ì—ëŸ¬ í•¸ë“¤ë§ ì •ë¦¬ |
| 5 | â¬œ ëŒ€ê¸° | - | - | í•¸ë“¤ëŸ¬ ë¶„ë¦¬ (ë¯¸ë””ì–´+SNS+ë””ë²„ê·¸) |
| 6 | â¬œ ëŒ€ê¸° | - | - | í•¸ë“¤ëŸ¬ ë¶„ë¦¬ (ì‘ì—…+ë°°ì¹˜+í’ˆì§ˆ) |
| 7 | â¬œ ëŒ€ê¸° | - | - | í•¸ë“¤ëŸ¬ ë¶„ë¦¬ (ì—ì´ì „íŠ¸+í…”ë ˆê·¸ë¨) |
| 8 | â¬œ ëŒ€ê¸° | - | - | ai_handler.py ë¦¬íŒ©í† ë§ |
| 9 | â¬œ ëŒ€ê¸° | - | - | Config ì´ì¤‘í™” í•´ê²° |
| 10 | â¬œ ëŒ€ê¸° | - | - | ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€ |
| 11 | â¬œ ëŒ€ê¸° | - | - | ì…ë ¥ ê²€ì¦ + ì„œë²„ ì…§ë‹¤ìš´ ì •ë¦¬ |
| 12 | â¬œ ëŒ€ê¸° | - | - | index.html êµ¬ì¡° ì •ë¦¬ |
| 13 | â¬œ ëŒ€ê¸° | - | - | ë©€í‹°í„´ ëŒ€í™” ê¸°ëŠ¥ |
| 14 | â¬œ ëŒ€ê¸° | - | - | ì•„í‚¤í…ì²˜ ë§µ ëŒ€ì‹œë³´ë“œ |

---

## ì§„í–‰ ì¼ì§€

> ë¦¬íŒ©í† ë§ ê° ë‹¨ê³„ê°€ ëë‚  ë•Œë§ˆë‹¤ ì—¬ê¸°ì— ê¸°ë¡. ì»´íŒ©(ëŒ€í™” ì••ì¶•) ë˜ì–´ë„ ì´ íŒŒì¼ ì½ìœ¼ë©´ ì–´ë””ê¹Œì§€ í–ˆëŠ”ì§€ ë°”ë¡œ ì•Œ ìˆ˜ ìˆìŒ.

### 2026-02-23

**Step 1 ì™„ë£Œ (PR#493, ìë™ ë¨¸ì§€ ì™„ë£Œ)**
- `web/ws_manager.py` ìƒì„± â€” ConnectionManager í´ë˜ìŠ¤ + ì‹±ê¸€í„´ `wm`
  - `wm.broadcast(event, data)`: WebSocket ì „ì²´ ë°©ì†¡
  - `wm.broadcast_multi([(event, data), ...])`: ì—¬ëŸ¬ ì´ë²¤íŠ¸ í•œ ë²ˆì—
  - `wm.broadcast_sse(msg_data)`: SSE í´ë¼ì´ì–¸íŠ¸ì—ê²Œ
  - `wm.send_agent_status(...)`: ì—ì´ì „íŠ¸ ìƒíƒœë“± ì œì–´
  - `wm.send_cost_update(...)`: ë¹„ìš© ì—…ë°ì´íŠ¸
  - `wm.send_delegation_log(...)`: ìœ„ì„ ë¡œê·¸ (WS + SSE ë™ì‹œ)
- `mini_server.py` 30ê³³ `for c in connected_clients[:]:` ë£¨í”„ â†’ `await wm.broadcast(...)` 1ì¤„ë¡œ êµì²´
- ì£½ì€ WebSocket ì—°ê²° ìë™ ì œê±° ë¡œì§ í¬í•¨

**ê°™ì´ ì§„í–‰í•œ ì‘ì—…:**
- ë…¸ì…˜ API í‚¤ë¥¼ elddlwkd(ê°œì¸) â†’ corthex.hq(íšŒì‚¬)ë¡œ ì „ë©´ êµì²´
- CLAUDE.mdì— "ë©”ëª¨ë¦¬ íŒŒì¼ ì‚¬ìš© ê¸ˆì§€" ê·œì¹™ ìµœìƒë‹¨ ì¶”ê°€
- ë¹„ê°œë°œììš© ë¦¬íŒ©í† ë§ ê°€ì´ë“œ `docs/refactoring-guide.md` ì‘ì„±
- CEO ì•„ì´ë””ì–´ #005(ë©”ëª¨ë¦¬ ê¸ˆì§€), #006(ë¦¬íŒ©í† ë§ ì„¤ëª… ì›ì¹™) ê¸°ë¡

**Step 2 ì‹œì‘ (AppState ì „ì—­ ìƒíƒœ ê´€ë¦¬)**
- ë¸Œëœì¹˜: `claude/refactor-step2-appstate`
- ëª©í‘œ: 44ê°œ ì „ì—­ë³€ìˆ˜ â†’ AppState í´ë˜ìŠ¤ 1ê°œë¡œ í†µí•© + Lock ì¶”ê°€
