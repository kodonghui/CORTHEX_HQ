# 2026-02-28 완료 항목

## 빌드 #660 — arm_server.py 리팩토링 P4
- ✅ `web/argos_collector.py` 신규 생성 (1,026줄) — ARGOS 수집 16함수 + 컨텍스트 빌더
  - 수집: prices/news/dart/macro/financial/sector (6종 수집기 + 안전 래퍼 6개)
  - 오케스트레이터: `_argos_sequential_collect` (순차 DB lock 방지)
  - 월간 RL: `_argos_monthly_rl_analysis` (AI 오답 패턴 분석)
  - 컨텍스트 빌더: `_build_argos_context_section` (팀장 프롬프트 주입)
- ✅ arm_server.py 10,399→9,436줄 (963줄 감소)
- ✅ argos_handler.py 스텁 7개 삭제 → argos_collector 직접 import로 교체 (505→472줄)
- ✅ 서버 배포 + ARGOS 수집 동작 검증 (price/news/dart 전부 정상)

## 빌드 #661 — arm_server.py 리팩토링 P5
- ✅ `web/batch_system.py` 신규 생성 (1,808줄) — 배치 큐 + AI Batch API + 배치 체인 오케스트레이터
  - 10개 API 엔드포인트 batch_router로 이관
  - 4단계 배치 체인: 분류 → 팀장 지시서 → 전문가 배치 → 종합 보고서
  - 배치 폴러 (60초 간격), 브로드캐스트 모드, 실시간 폴백
  - _BATCH_MODE_SUFFIX 상수도 함께 이동
- ✅ arm_server.py 9,436→7,676줄 (1,760줄 감소)
- ✅ 서버 배포 + 배치 API 검증 (queue/chains/pending 전부 정상)

## 빌드 #662 — arm_server.py 리팩토링 P6
- ✅ `web/trading_engine.py` 신규 생성 (2,830줄) — CIO 신뢰도 학습 + 자동매매 + 정량분석
  - CIO 학습: ELO + Bayesian 보정 + 도구 효과 + 오답 패턴 (5함수)
  - 정량분석: RSI/MACD/볼린저/거래량/이평선 합의투표 시스템
  - 자동매매: 가격 트리거 + 손절/익절 + 봇 루프 + DST 감지
  - 6개 API 엔드포인트 → trading_router
  - FX 환율 + 시세 캐시 + Shadow Trading 알림
- ✅ arm_server.py 7,676→4,948줄 (2,728줄 감소)
- ✅ 서버 배포 + 헬스체크 + 트레이딩 API 검증 정상

## 빌드 #667 — arm_server.py 리팩토링 P7
- ✅ `web/scheduler.py` 신규 생성 (508줄) — 크론 엔진 + 워크플로우 실행 + Soul Gym 루프
  - 크론 표현식 파서/매처 (5필드 리눅스 표준)
  - 1분 주기 크론 루프 (ARGOS 수집, 환율 갱신, 가격 트리거)
  - 기본 스케줄 자동 등록 + 워크플로우 순차 실행 API
  - Soul Gym 24/7 루프 + start_background_tasks() 통합 함수
- ✅ arm_server.py 4,948→4,509줄 (439줄 감소)
- ✅ on_startup 스케줄링 부분 → start_background_tasks()로 통합 (11개 태스크)
- ✅ 서버 배포 + 11개 백그라운드 태스크 전부 정상 시작 확인

## arm_server.py 리팩토링 P8 — 에이전트 라우팅 분리
- ✅ `web/agent_router.py` 신규 생성 (2,500줄) — CEO 명령 라우팅 + 에이전트 호출 + QA + 노션 + 도구풀
  - 상수: _ROUTING_KEYWORDS, _AGENT_NAMES, _BROADCAST_KEYWORDS, _MANAGER_SPECIALISTS 등 12개
  - 노션 API: _extract_notion_title, _save_to_notion, _add_notion_log
  - QA 시스템: _QAModelRouter, _quality_review_specialists, _handle_specialist_rework (비활성 보존)
  - 에이전트 코어: _call_agent, _manager_with_delegation (팀장=5번째 분석가 구조)
  - 라우팅: _determine_routing_level (Level 1~4), _process_ai_command (최상위 라우터)
  - 브로드캐스트: _broadcast_to_managers_all, _broadcast_with_debate, _sequential_collaboration
  - 도구풀: _init_tool_pool + _MiniModelRouter 어댑터
- ✅ arm_server.py 4,509→1,843줄 (2,666줄 감소, 59%)
- ✅ 기존 버그 수정: _flush_batch_api_queue 미임포트 → batch_system에서 정상 import
- ✅ _ms() 패턴 호환 확인 (batch_system/scheduler/trading_engine 모두 정상 참조)
- ✅ CLAUDE.md에 1M 컨텍스트 추천 규칙 추가

## arm_server.py 리팩토링 P9 — 텔레그램 봇 분리
- ✅ `web/telegram_bot.py` 신규 생성 (797줄) — CEO 텔레그램 인터페이스 전체
  - 텔레그램 라이브러리 선택적 로드 (_telegram_available)
  - 봇 시작/종료: _start_telegram_bot, _stop_telegram_bot
  - 명령 핸들러 12개: start/help/agents/health/rt/batch/status/budget/pause/resume/models + 콜백
  - 한국어 명령: /토론, /심층토론, /전체, /순차
  - 일반 메시지 핸들러: @에이전트 직접 지시, 실시간/배치 모드, AI 라우팅
  - 웹 응답 전달: _forward_web_response_to_telegram
  - 모델 선택 3단계 인라인 버튼 (_TG_MODELS)
- ✅ arm_server.py 1,843→1,075줄 (768줄 감소, 42%)
- ✅ P8 버그 수정: _NOTION_API_KEY 미임포트 → os.getenv 직접 호출로 수정
- ✅ 리팩토링 최종 누적: 11,637→1,075줄 (10,562줄 분리, 91%)

## 나노바나나 v2 교체 (3/9 데드라인 대응)
- ✅ `src/tools/gemini_image_generator.py` — `_IMAGE_MODEL` 교체: `gemini-3-pro-image-preview` → `gemini-3.1-flash-image-preview`
- ✅ `config/tools.yaml` — 이름/설명 업데이트 (나노바나나 Pro → v2)
- ✅ `config/tools.json` — 이름/설명 업데이트 (나노바나나 Pro → v2)
- ✅ Flash 티어 전환 → Pro 대비 ~50% 비용 절감

## SketchVibe Phase 2 — 정확도 + MCP + 구현 브리지
- ✅ `_parse_drawflow()` 강화: 노드타입→Mermaid 형태, 레이아웃 자동판단, 공간 그룹, 분기 포트
- ✅ Claude 프롬프트 확장: 4개 다이어그램 타입, 매핑표, 예시 2개
- ✅ `web/mcp_sketchvibe.py` 신규: FastMCP 서버 (read_canvas, list/get_confirmed)
- ✅ `.mcp.json` sketchvibe 등록
- ✅ confirmed API: `GET /confirmed`, `GET /confirmed/{name}` (SQLite)
- ✅ "맞아" 후 구현 안내 패널 (MCP URI + HTML 뷰어)
- ✅ 모델 하드코딩 수정: `load_setting("sketchvibe_model")`

## SketchVibe Phase 3 — 아키텍처 재설계 (서버변환 제거 + MCP 양방향)
- ✅ 서버 변환 제거: `/convert` 엔드포인트 삭제, `_SYSTEM_PROMPT`/`_extract_json()`/`_get_sketchvibe_model()` 제거
- ✅ SSE 엔드포인트 5개: save-canvas, push-event, request-approval, approve, stream
- ✅ MCP 도구 2개 추가: `update_canvas(mermaid_code)`, `request_approval(message)` (기존 3도구 보존)
- ✅ 프론트엔드: "변환하기" → "저장하기", SSE 구독(`_connectSketchVibeSSE`), 실시간 Mermaid 렌더링
- ✅ 팔레트 버그 수정: `querySelectorAll` + 보이는 요소 선택 (동일 ID 대응) + 노드 랜덤 위치
- ✅ API 비용 표시 제거 ($0.0079 등)
- ✅ NEXUS 분할뷰 + 시스템플로우 삭제: HTML 151줄 제거, 모드버튼 삭제, 캔버스 모드만 유지
- ✅ `nexus-canvas` ID 유일화 → 팔레트 버그 완전 해결
- ✅ HTML 뷰어 404 수정: `/api/sketchvibe/viewer/{name}` 엔드포인트 추가 (nginx 우회)
- ✅ 크롬 빈 캔버스 수정: SSE 연결 시 최근 Mermaid 즉시 전송 (새 브라우저 복원)
- ✅ 새 창 열기 제거: Mermaid 결과를 같은 화면 패널에서 렌더링 (대표님 피드백)
- ✅ 저장된 캔버스 목록 연동: confirmed 다이어그램이 사이드바에 표시 + 클릭 시 인라인 렌더링

## SketchVibe — 캔버스 직접 렌더링 (빌드 #692)
- ✅ Mermaid 결과를 사이드 패널 → 캔버스 영역에 직접 렌더링 (스케치 교체 UX)
- ✅ 캔버스 오버레이: 상단 바(맞아/초기화 버튼 + 설명 + 확인 상태) + Mermaid 풀스크린 렌더링
- ✅ 사이드 패널: Mermaid 렌더링 제거, 상태 메시지만 유지 ("캔버스에 표시됨")
- ✅ SSE 자동 연결: NEXUS 탭 열 때 자동 연결, 닫을 때 해제 (사이드 패널 토글 불필요)
- ✅ 저장된 다이어그램 클릭 시에도 캔버스에 직접 렌더링

## SketchVibe — 새 캔버스 + 삭제 (빌드 #694)
- ✅ 초기화 시 Mermaid 결과 + Drawflow 캔버스 동시 클리어 (새로 그리기)
- ✅ `DELETE /api/sketchvibe/confirmed/{name}` — DB + 파일(.md/.html) 동시 삭제
- ✅ 사이드바 호버 시 × 삭제 버튼 표시 (confirm 확인 후 삭제 + 목록 갱신)

## Instagram 자동 발행 기능 추가
- ✅ `src/tools/sns/instagram_publisher.py` — OAuth 의존 제거, 환경변수 토큰(`INSTAGRAM_ACCESS_TOKEN`) 직접 사용으로 전환
  - User ID 자동 조회: `GET /me?fields=id,username` (INSTAGRAM_USER_ID 미설정 시 자동)
  - httpx 타임아웃 추가 (10s/30s)
- ✅ `src/tools/sns/sns_manager.py` — Instagram 잠금 해제
  - `ALLOWED_PLATFORMS`에 "instagram" 추가
  - `BLOCKED_PLATFORM_MSG`에서 "instagram" 제거
  - Instagram import 활성화 (주석 해제)
  - status에 Instagram 환경변수 토큰 상태 표시 추가
- ✅ `config/agents.yaml` — CMO system_prompt: 지원 플랫폼 4개→5개, Instagram 활성화
- ✅ `config/tools.yaml` — sns_manager 설명: 4개→5개 플랫폼, Instagram 추가
- ✅ `config/tools.json` — sns_manager 설명: 동일 업데이트
