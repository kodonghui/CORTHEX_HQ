# 2026-03-02 완료 기록

## ✅ Mermaid→Drawflow 파서 수정 (PR #751, 빌드 #814)

인라인 노드 정의(`A([시작])-->B{결정분기}`) 파싱 실패 → B,C,D,E가 Mermaid ID를 레이블로, 전부 system 타입으로 폴백
- `parseNodeToken` 헬퍼 도입 → 엣지 라인에서 src/tgt 모양+레이블 동시 추출
- `[[label]]` 이중 대괄호 → system 타입 추가

## ✅ SSH 빠른 배포 스크립트 (PR #752, 빌드 #815)

`deploy-fast.sh`: GitHub Actions(3분) → SSH 직배포(30초) 대체
- push → Actions 자동 취소 → SSH git reset + systemctl restart → 헬스체크
- CLAUDE.md STEP5 업데이트
- 신규 API 키 추가 시엔 기존 Actions 사용

## ✅ sister(누나) 계정 4가지 버그 수정 (PR #728, 빌드 #759)

근본 원인: 로그인 토큰에 org 정보 없음 → 백엔드가 누나/CEO 구분 불가

1. **saju 에이전트 안 보임** → index.html "준비중" 하드코딩 → 4명(executive/eden/zoe/sage) 실제 렌더링
2. **대화 세션 CEO와 공유** → conversation_handler.py에 `get_auth_org()` 인증 필터 추가
3. **작전일지 공유** → activity_handler.py에 `get_auth_org()` 인증 필터 추가
4. **비서실장 누나 화면 표시** → index.html `x-show="auth.role !== 'sister'"` 추가

인프라: auth_handler.py `_extract_token()` 통합(header→query→쿠키) + `get_auth_org()` API 신설 + corthex-app.js 쿠키 토큰 저장

## ✅ 로그아웃 버튼 표시 수정 (PR #729, 빌드 #760)

원인: 배포→서버 재시작→세션 소멸→bootstrapMode=true→로그인 성공해도 안 바뀜
수정: corthex-app.js 로그인 성공 시 `this.auth.bootstrapMode = false` 추가

## ✅ v5.1 Config-driven Workspace Architecture (PR #730, 빌드 #762)

**핵심**: role if/else 하드코딩 전면 폐기 → config/workspaces.yaml 설정 기반 동적 렌더링

1. **workspaces.yaml 신규** — CEO(4섹션: 비서실장+리트마스터+사주+금융) / sister(1섹션: 사주냥팀 Eden/Zoe/Sage) 프로파일
2. **GET /api/workspace-profile** — 로그인 시 role → 프로파일 매핑 반환. config_loader.py에 load_workspace_profiles() 추가
3. **JS role if/else 17곳 제거** — `auth.role === 'sister'` → `workspace.orgScope`, `workspace.sidebarFilter`, `workspace.mentionFilter` 사용
4. **HTML x-show role 제거** — `x-show="auth.role !== 'sister'"` → `x-show="workspace.sidebarFilter === 'ceo'"` + cli_owner 기반 필터
5. **yaml2json.py** — workspaces 변환 추가 (배포 시 JSON 자동 생성)
6. **CLAUDE.md 정리** — v3 잔재(처장=5번째분석가) 제거, v5.1 워크스페이스 규칙 반영
7. **architecture.md 동기화** — sidebarFilter/mentionFilter org→cli_owner 기반 코드 예시 수정

아키텍처 원칙: 네이버 모델(같은 기능, 다른 데이터) + 슬랙 모델(cli_owner 기반 내 CLI 직원만)
새 사람 추가 = workspaces.yaml 프로파일 1개 + 인증 추가. 코드 수정 0줄.

## ✅ v5.1 프론트엔드 버그 4건 수정 (빌드 #765)

1. **사이드바 에이전트 안 보임** → AgentConfig에 cli_owner 추가 + /api/agents에 cli_owner 포함 + x-show → agentCliOwner[id] 기반 동적 필터
2. **사무실 뷰 하드코딩** → "CORTHEX STAFF 팀장 6명" 삭제 → workspace.officeLayout x-for 동적 렌더링
3. **로그아웃 버튼 안 보임** → bootstrapMode 조건 제거 → auth.token만 확인
4. **전력분석 시체 에이전트** → loadPerformance/loadGymHistory에서 agentNames에 없는 구 ID 필터 아웃

## ✅ v5.2 워크스페이스 격리 + CLAUDE.md 재구축 (PR #732~#734, 빌드 #773~#776)

### 버그 수정 3건 (빌드 #773)
1. **workspace-profile 404 근본 수정** — 토큰 없으면 initWorkspace 스킵 + viewer 폴백 프로파일 반환
2. **사이드바 에이전트 안 보임** — sidebarFilter 기본값 문제 → viewer 프로파일(빈 sidebarFilter)로 해결
3. **$204.86 누나 대시보드 노출** — /api/dashboard에 orgScope 필터 추가 → sister는 자신의 에이전트 비용만

### showSections 탭 격리 (빌드 #775)
- workspaces.yaml: ceo=[] (전체 탭), sister=[home, command, performance] (3개만)
- corthex-app.js: getPrimaryTabs/getSecondaryTabs에 _tabAllowed() 필터 추가

### CLAUDE.md 모범사례 재구축 (빌드 #775, 공식 Claude Code best practices 기반)
- CLAUDE.md: @import 문법 추가 (claude-rules 3개 자동 로드), 자율 실행 모드 섹션
- .claude/agents/log-analyzer.md: 로그 분석 전문 에이전트 (Haiku)
- .claude/agents/security-reviewer.md: 보안 규칙 위반 감지 에이전트 (Sonnet)
- .claude/rules/frontend.md: 프론트엔드 경로별 자동 적용 규칙
- .claude/rules/backend.md: 백엔드 경로별 자동 적용 규칙

### get_auth_org 핫픽스 (빌드 #776)
- arm_server.py: get_auth_org import 추가
- config/workspaces.yaml: viewer showSections: [] 추가

## ✅ v5.3 탭 숨기기 전면 폐기 — 네이버 모델 완전 구현 (PR #737, 빌드 #779)

showSections/allowedDivisions가 탭 숨기기이므로 네이버 모델 위반 → 전면 제거

1. **workspaces.yaml**: showSections, allowedDivisions 모든 워크스페이스에서 제거
2. **corthex-app.js**: _tabAllowed() 함수 제거, getPrimaryTabs/getSecondaryTabs 전체 탭 반환
3. **index.html**: 기밀문서 division 버튼 x-show 조건 모두 제거 → 전부 표시
4. **loadArchive()**: orgScope + filterDivision 함께 API 전달 (이전엔 filterDivision 누락)
5. **arm_server.py**: viewer 폴백에서 allowedDivisions 제거
6. **CLAUDE.md**: 탭 숨기기 금지(v5.3) 절대 규칙 추가
7. **architecture.md**: ADR-7 + Frontend 표 업데이트 — 탭숨김→빈상태표시
