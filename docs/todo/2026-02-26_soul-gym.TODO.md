# 🧬 Soul Gym 구현 TODO — 2026-02-26

> **목표**: CORTHEX 에이전트가 스스로 진화하는 시스템 (DGM + EvoPrompt + OPRO 논문 기반)
> **참조 알고리즘**: `docs/architecture/soul-gym-algorithm.md`
> **예상 소요**: 1일 (오전 백엔드 + 오후 프론트 + 저녁 테스트)
> **예상 비용**: 테스트 $3~5 / 운영 주당 $10

---

## 🔴 전제 이해 (시작 전 반드시 읽기)

### 왜 만드나?
현재 CORTHEX는 에이전트가 실수하면 → warnings에 기록 → 주 1회 제안 → 대표님 승인 → 수정
이 방식은 **반응적(reactive)**: 실수가 쌓여야만 개선됨

Soul Gym은 **능동적(proactive)**: 매주 에이전트를 "경기"시켜서 성적 최고인 버전으로 자동 교체

### 이미 있는 것 (건드리지 마!)
- `soul_evolution_handler.py`: warnings 기반 반응적 진화 → **그대로 유지**
- `quality_handler.py`: QA 점수 저장 → **그대로 사용**
- `db.py` `save_quality_review()`: QA 점수 저장 함수 → **그대로 사용**

### 새로 만드는 것
- `web/soul_gym_engine.py`: 진화 엔진 (핵심 로직)
- `config/soul_gym_benchmarks.yaml`: 부서별 벤치마크 문항
- `web/handlers/soul_gym_handler.py`: **기존 파일 있음 → 완전 재작성** (현재 파일은 soul_evolution과 같이 묶여있었음)
- DB 테이블: `soul_gym_rounds` (신규, `db.py`에 추가)

---

## ⬜ Step 1: DB 스키마 추가 (`web/db.py`)

**왜**: 진화 기록(어떤 변이가 어떤 점수를 받았는지)을 SQLite에 저장

**어떤 함수 어디에 추가할지**:
- `db.py` 내 `CREATE TABLE` 블록 끝에 추가 (기존 테이블 건드리지 말고 IF NOT EXISTS로 신규 추가)

```sql
CREATE TABLE IF NOT EXISTS soul_gym_rounds (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id      TEXT NOT NULL,
    agent_name    TEXT,
    round_num     INTEGER DEFAULT 1,
    soul_before   TEXT,          -- 진화 전 soul 앞 200자 (스냅샷)
    soul_after    TEXT,          -- 진화 후 soul 앞 200자 (없으면 NULL)
    winner        TEXT,          -- 'original' | 'variant_A' | 'variant_B' | 'variant_C'
    score_before  REAL,          -- 기존 soul 점수
    score_after   REAL,          -- 최고 변이 점수 (개선 없으면 score_before와 동일)
    improvement   REAL,          -- score_after - score_before
    cost_usd      REAL DEFAULT 0,
    variants_json TEXT,          -- JSON: 변이 내용 + 각 점수
    created_at    TEXT
);
```

**추가할 Python 함수 2개** (db.py 하단):
```python
def save_soul_gym_round(data: dict) -> None:
    """진화 라운드 결과 저장."""
    # INSERT INTO soul_gym_rounds VALUES (...)

def get_soul_gym_history(agent_id: str = "", limit: int = 50) -> list[dict]:
    """진화 히스토리 조회. agent_id 없으면 전체."""
    # SELECT * FROM soul_gym_rounds ORDER BY id DESC LIMIT limit
```

---

## ⬜ Step 2: 벤치마크 문항 파일 (`config/soul_gym_benchmarks.yaml`)

**왜**: 에이전트를 테스트할 "시험지". 매번 같은 문제로 공정 비교

**채점 기준 핵심**:
- 모든 문항은 **Sonnet QA 판정**으로 0~100 점수 산출
- 판정 기준: BLUF 준수(20점) + 전문성(30점) + 구체성(30점) + 구조(20점)

```yaml
# config/soul_gym_benchmarks.yaml

finance.investment:
  - id: cio_bench_1
    title: "PER 비교분석 + 투자의견"
    question: |
      삼성전자(005930) 현재 PER 13배, 반도체 업종 평균 PER 15배.
      최근 3개월 주가 -12%, 영업이익 전년 대비 +40%.
      BLUF 형식으로 단기(1달)/중기(3달)/장기(1년) 투자의견과 목표가를 제시하시오.
    scoring_focus: "BLUF 형식, PER 비교, 구체적 목표가, 근거 인용"

  - id: cio_bench_2
    title: "금리 상승 시나리오 분석"
    question: |
      미국 연준이 다음 FOMC에서 기준금리를 0.25%p 추가 인상한다고 가정할 때,
      한국 성장주 포트폴리오에 미치는 영향을 3가지 메커니즘으로 분석하시오.
    scoring_focus: "할인율 효과, 환율 연동, 구체적 수치 예시"

  - id: cio_bench_3
    title: "리스크 헤지 전략"
    question: |
      포트폴리오: 반도체 30%, IT 20%, 방어주 50%.
      시장 급락(-15%) 시나리오에서 손실을 최소화하는 헤지 전략 2가지와
      예상 비용/효과를 제시하시오.
    scoring_focus: "섹터별 영향 분석, 구체적 헤지 방법, 비용-효과 평가"

leet_master.strategy:
  - id: cso_bench_1
    title: "경쟁 전략 분석"
    question: |
      2026년 AI 에이전트 SaaS 시장에서 신규 진입자가
      OpenAI, Anthropic 대비 차별화할 수 있는 3가지 전략을 제시하시오.
      각 전략의 실행 가능성을 6개월/1년 기준으로 평가할 것.
    scoring_focus: "전략 구체성, 실행 가능성, 경쟁사 분석"

  - id: cso_bench_2
    title: "리스크 분석"
    question: |
      B2B SaaS 제품의 첫 번째 엔터프라이즈 고객 계약 시
      법적/재무적/운영적 리스크 각 1가지씩과 대응 방안을 제시하시오.

  - id: cso_bench_3
    title: "시장 규모 추정"
    question: |
      국내 중소기업(50인 이하) 대상 AI 에이전트 도구 시장 규모를
      TAM/SAM/SOM 프레임워크로 추정하시오. 가정을 명시할 것.

leet_master.legal:
  - id: clo_bench_1
    title: "AI 저작권 리스크"
    question: |
      AI가 생성한 콘텐츠(블로그 글, 이미지)를 상업적으로 사용할 때
      한국 저작권법 하에서 발생할 수 있는 3가지 법적 리스크와 대응 방안을 제시하시오.

  - id: clo_bench_2
    title: "계약서 리스크 분석"
    question: |
      SaaS 서비스 이용약관에 포함되어야 할 핵심 조항 5가지와,
      각 조항이 없을 때 발생할 수 있는 법적 분쟁 시나리오를 설명하시오.

  - id: clo_bench_3
    title: "개인정보 보호"
    question: |
      사용자 행동 데이터(클릭, 체류시간, 검색어)를 수집하는 서비스에서
      개인정보 보호법 준수를 위해 반드시 이행해야 할 3가지 조치를 설명하시오.

leet_master.marketing:
  - id: cmo_bench_1
    title: "콘텐츠 전략"
    question: |
      B2B SaaS 제품의 LinkedIn 마케팅 전략을 수립하시오.
      월 예산 100만원, 목표: 6개월 내 리드 50건 확보.
      구체적 콘텐츠 유형, 게시 빈도, KPI를 포함할 것.

  - id: cmo_bench_2
    title: "고객 리텐션"
    question: |
      SaaS 제품의 월 이탈률이 8%일 때, 이를 3% 이하로 낮추기 위한
      온보딩 개선 방안 3가지를 제시하시오. 각 방안의 예상 효과를 수치로 표현할 것.

  - id: cmo_bench_3
    title: "경쟁사 분석"
    question: |
      경쟁사 제품 대비 우리 제품의 포지셔닝을 위한
      "전쟁 카드(Battle Card)" 1장 분량을 작성하시오.
      강점/약점/주요 차별점/반박 스크립트 포함.

leet_master.tech:
  - id: cto_bench_1
    title: "아키텍처 설계"
    question: |
      10만 명이 동시 접속하는 실시간 주식 분석 서비스를
      AWS/GCP 없이 Oracle Cloud Free Tier(ARM 4코어, 24GB)에서
      운영할 수 있는 아키텍처를 설계하시오.
      병목 지점 3가지와 해결 방법을 포함할 것.

  - id: cto_bench_2
    title: "보안 리뷰"
    question: |
      FastAPI + SQLite 기반 서비스의 주요 보안 취약점 5가지와
      각각의 구체적 방어 코드(Python/SQL)를 제시하시오.

  - id: cto_bench_3
    title: "성능 최적화"
    question: |
      Python async 기반 서버에서 다수의 LLM API 동시 호출(30개)을
      비용과 레이턴시를 모두 최소화하며 처리하는 방법을 설명하시오.
      구체적 코드 패턴 포함.

secretary:
  - id: sec_bench_1
    title: "업무 우선순위 판단"
    question: |
      CEO로부터 동시에 3가지 요청이 들어왔다:
      1) 긴급 투자자 미팅 자료 준비 (오늘 오후)
      2) 팀 성과 리뷰 문서 작성 (이번 주)
      3) 신규 채용 공고 검토 (이번 달)
      Eisenhower Matrix를 사용하여 우선순위를 정하고 처리 계획을 제시하시오.

  - id: sec_bench_2
    title: "멀티에이전트 조율"
    question: |
      CEO가 "NVDA 투자 검토 + 관련 특허 리스크 분석 + SNS 발표문 초안 작성"을 동시에 요청했다.
      어떤 부서에 어떤 순서로 배분하고, 결과를 어떻게 종합할지 RACI 매트릭스로 정리하시오.

  - id: sec_bench_3
    title: "CEO 보고 번역"
    question: |
      다음 기술 보고서를 비개발자 CEO가 이해할 수 있는 형식으로 변환하시오:
      "P95 레이턴시가 2300ms에서 340ms로 감소하였으며, TTFB가 개선되어
      LCP Core Web Vitals 점수가 43에서 87로 향상되었습니다."
```

---

## ⬜ Step 3: Soul Gym 엔진 (`web/soul_gym_engine.py`)

**새 파일 생성. 약 300줄 예상.**

### 주요 함수 목록

```python
# 1. 변이 생성 (Haiku)
async def generate_variants(agent_id, soul_current, warnings, history) -> dict:
    """
    OPRO 방식: meta_prompt에 히스토리 포함
    EvoPrompt 방식: mutation(A, B) + crossover(C)
    반환: {'variant_A': str, 'variant_B': str, 'variant_C': str}
    """

# 2. 벤치마크 실행 (원본 모델)
async def run_benchmark(agent_id, soul, model_name) -> float:
    """
    config/soul_gym_benchmarks.yaml에서 해당 부서 문항 로드
    각 문항에 대해 agent 실행 → QA 판정 → 평균 점수 반환
    반환: float (0~100)
    """

# 3. QA 판정 (Sonnet)
async def judge_response(question, response, scoring_focus) -> float:
    """
    LLM-as-a-Judge 패턴
    채점 기준: BLUF(20) + 전문성(30) + 구체성(30) + 구조(20)
    반환: float (0~100)
    """

# 4. 메인 진화 함수
async def evolve_agent(agent_id: str, dry_run: bool = False) -> dict:
    """
    전체 파이프라인 실행
    dry_run=True면 저장 안 하고 결과만 반환
    """

# 5. 전체 에이전트 진화 (하위 N명)
async def evolve_all(top_n_worst: int = 5) -> list[dict]:
    """
    QA 점수 하위 N명 선별 → 순차 진화
    비용 캡: 1회 $5 초과 시 중단
    """
```

### 변이 생성 프롬프트 구조 (OPRO + EvoPrompt 혼합)

```
[MUTATION META-PROMPT]

당신은 AI 에이전트 소울(시스템 프롬프트) 진화 전문가입니다.

## 과거 진화 기록 (OPRO 방식)
| 라운드 | 변경 내용 요약 | 점수 |
|--------|---------------|------|
| Round 1 | 숫자 검증 규칙 추가 | 62 → 71 |
| Round 2 | BLUF 강화 | 71 → 68 (퇴보, 채택 안 됨) |

## 현재 반복 실수 (warnings)
{warnings}

## 현재 소울 (앞 1500자)
{soul_current}

## 지시
위 정보를 바탕으로 소울 Variant A (규칙 추가형)를 생성하세요.
- 기존 내용을 삭제하지 말 것
- 구체적이고 행동 가능한 규칙 1~2개 추가
- 100자 이내로 추가
반드시 변경된 소울 전체를 출력하세요.
```

---

## ⬜ Step 4: API 핸들러 업데이트 (`web/handlers/soul_gym_handler.py`)

**기존 파일 있음 — 기존 내용 확인 후 엔드포인트 추가**

추가할 엔드포인트:

```python
@router.post("/api/soul-gym/evolve/{agent_id}")
# 파라미터: dry_run=false (bool)
# 반환: {winner, score_before, score_after, improvement, cost_usd, variants}

@router.post("/api/soul-gym/evolve-all")
# 파라미터: top_n=5 (int)
# 반환: [{agent_id, winner, improvement}, ...]

@router.get("/api/soul-gym/history")
# 파라미터: agent_id (optional), limit=50
# 반환: soul_gym_rounds 테이블

@router.get("/api/soul-gym/status")
# 현재 진화 중인 에이전트 목록 (in-memory 상태)

@router.get("/api/soul-gym/benchmarks")
# 전체 벤치마크 문항 목록 반환 (확인용)
```

---

## ⬜ Step 5: 크론 등록 (`web/mini_server.py`)

**기존 `_cron_loop()` 함수 내에 추가**

```python
# 매주 월요일 03:00 KST — Soul Gym 자동 진화
if now.weekday() == 0 and now.hour == 3 and now.minute == 0:
    logger.info("🧬 Soul Gym 주간 진화 시작")
    asyncio.create_task(evolve_all(top_n_worst=5))
```

---

## ⬜ Step 6: 웹 UI (전력분석 탭)

**기존 `soul_evolution_handler.py` UI 옆에 새 섹션 추가**

UI 구성 (Alpine.js + Tailwind):
```
┌─────────────────────────────────────────────────────┐
│ 🧬 SOUL GYM — 에이전트 경쟁 진화                      │
│                                                     │
│ [에이전트 선택 드롭다운]  [Dry Run 체크박스]           │
│ [▶ 지금 진화시키기]  [⚡ 하위 5명 자동 진화]           │
│                                                     │
│ ── 최근 진화 기록 ──────────────────────────────── │
│ 에이전트      라운드  결과       점수 변화   날짜     │
│ CIO 전문가A    R3    C 채택     62→78 +16  02-26   │
│ CLO 분석가1    R1    원본 유지  71→69 -2   02-26   │
│ ...                                                 │
└─────────────────────────────────────────────────────┘
```

구현 포인트:
- `x-if` 필수 (성능 규칙 준수)
- 진화 중일 때 로딩 스피너 + "경기 중..." 텍스트
- 채택 시 녹색 배지, 미채택 시 회색 배지
- "변경 내용 보기" 클릭 시 soul diff 슬라이드 패널

---

## ⬜ Step 7: Dry Run 테스트

**배포 전 반드시 실행**

```bash
# 1. CIO 분석가 1명 Dry Run (실제 저장 안 함)
curl -X POST "https://corthex-hq.com/api/soul-gym/evolve/cio_analyst_1?dry_run=true"

# 2. 결과 확인: winner, score_before, score_after, variants 내용
# 3. 점수 로직이 합리적인지 확인 (랜덤하게 움직이지 않는지)
# 4. 비용 확인: cost_usd가 $2 이하인지
```

---

## ⬜ Step 8: 실제 진화 실행 + 결과 보고

**대표님 보고 형식:**
```
🧬 Soul Gym 첫 진화 결과

에이전트: CIO 전문가A
라운드: 1
채택 변이: Variant C (교차형)
점수 변화: 62 → 78 (+16점)
변경 내용: "모든 수치 제시 시 출처 명시 + BLUF 결론에 목표가 반드시 포함"
비용: $1.93
```

---

## ✅ 완료 기준

- [ ] `/api/soul-gym/evolve/{agent_id}?dry_run=true` 호출 시 오류 없이 결과 반환
- [ ] 벤치마크 3문항이 CIO 에이전트로 실제 실행됨
- [ ] 점수가 0~100 범위 내에서 변이마다 다르게 나옴 (다양성 확인)
- [ ] soul_gym_rounds 테이블에 결과 저장됨
- [ ] 웹 UI에서 기록 확인 가능
- [ ] 텔레그램 알림 수신 (채택 시)
- [ ] 비용 $5 이하 (Dry Run 제외)

---

## 🚨 주의사항

1. **`agents.yaml`의 system_prompt를 직접 수정하지 말 것** → DB의 `soul_{agent_id}` 키에만 저장
2. **기존 `soul_evolution_handler.py` 건드리지 말 것** → 별도 시스템으로 공존
3. **벤치마크 문항은 절대 변경하지 말 것** (기준 변경 시 점수 비교 불가)
4. **Dry Run 먼저, 실제 실행은 대표님 확인 후**
5. **비용 캡**: `evolve_all()` 총 비용 $10 초과 시 자동 중단

---

## 📚 참조

- 알고리즘 상세: `docs/architecture/soul-gym-algorithm.md`
- DGM 논문: https://arxiv.org/abs/2505.22954
- EvoPrompt 논문: https://arxiv.org/abs/2309.08532 (ICLR 2024)
- OPRO 논문: https://arxiv.org/abs/2309.03409 (Google DeepMind)
- 기존 진화 핸들러: `web/handlers/soul_evolution_handler.py`
