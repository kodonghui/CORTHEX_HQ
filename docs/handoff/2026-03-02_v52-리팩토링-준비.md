# 핸드오프 — v5.2 다계정 전면 리팩토링 준비

**날짜**: 2026-03-02 (KST) | **최신 빌드**: #771

---

## 다음 세션 할 일 (순서 그대로)

1. **Claude Code 워크플로우 + CLAUDE.md 모범 사례 수집**
   - anthropic.com/engineering/claude-code-best-practices
   - GitHub anthropics/claude-code-action 예제
   - 가쟈누님 스타일 자율 작업 워크플로우 (PM 위임 + 잠자기 전 실행 방식)
   - 현재 CLAUDE.md에 없는 것 전부 추가

2. **다계정 전면 리팩토링 구상 (v5.2)**
   - 현재 문제: workspace.sidebarFilter='all' 기본값 → 격리 전부 무효
   - 목표: 새 계정 추가 = workspaces.yaml 1줄. HTML/JS 수정 0줄.
   - 근본 원인 → 아래 "미해결 버그" 참조

---

## 현재 미해결 버그 (오늘 못 다 잡음)

### 🔴 핵심: workspace 격리가 아직 불완전함
- `/api/workspace-profile` 404 → workspace 기본값(sidebarFilter='all') 유지 → 격리 전부 무효
- 원인: initWorkspace()가 로그인 이전에도 한 번 실행됨 → 토큰 없음 → 404
- 증상 1: 누나 사이드바에 Eden/Zoe/Sage 안 보임 (sidebarFilter='all'이라 agentCliOwner 조건 불일치)
- 증상 2: 전력분석에 모든 에이전트 보임 (sidebarFilter='all' → 필터 없이 전체 표시)
- 증상 3: SNS에 6개 CEO 플랫폼 다 보임
- 증상 4: 누나 화면에 $204.86 총 비용 노출 (대시보드 격리 안 됨)

### 수정 방향 (다음 세션)
```
옵션 A: initWorkspace를 checkAuth 완료 후에만 실행 (타이밍 수정)
옵션 B: workspace-profile이 404면 role 기반 폴백 적용 (viewer → 최소 권한 프로파일)
옵션 C: workspaces.yaml에 'viewer' 프로파일 추가
→ 권장: B+C 조합
```

### 🟡 $204.86 누나 화면 노출
- `/api/performance` 또는 `/api/dashboard`가 orgScope 없이 전체 데이터 반환
- 누나는 사주 에이전트 호출 기록만 봐야 함
- 수정: 대시보드 API에 orgScope 필터 추가

### 🟡 GitHub Actions Quality Gate API 비용
- `.github/workflows/pr-quality-gate.yml` 추가됨
- PR마다 ANTHROPIC_API_KEY 소비 (PR당 ~$0.01~0.03)
- 대표님 우려 있음 → 비용 상한 설정 또는 claude/ 브랜치 PR만 트리거로 제한

---

## 오늘 완료된 것 (빌드 #765~#771)

| 빌드 | 내용 |
|------|------|
| #765 | AgentConfig cli_owner 추가 + 사이드바 x-show + 로그아웃 버튼 + 전력분석 필터 |
| #766 | 로그아웃 버튼 위치 수정 (오른쪽 그룹 안으로) |
| #767~768 | 전력분석 cli_owner 기반 필터 + 스케치바이브 사이드바 제거 |
| #769~770 | 누나 격리 (showSatisfaction/showBulkModel/allowedDivisions/SNS orgScope) + 사이드바 색상 |
| #771 | PR Quality Gate (anthropics/claude-code-action) 추가 |

---

## v5.2 리팩토링 구상 방향 (대표님 지시)

### 핵심 원칙
- **하드코딩 0줄**: 새 계정 추가 = workspaces.yaml 1개만
- **완전 격리**: CEO 데이터가 누나에게 보이는 것 = 사형
- **자율 QA**: PR 올라오면 Claude가 자동으로 규칙 위반 감지

### 구조 개편 후보
```
workspaces.yaml 확장:
  showSections: [dashboard, performance, sns, archive, ...]  # 탭/섹션 visible 목록
  dataScope: { org: saju, agents: cli_owner }                # API 필터 통합
  uiTheme: { color: hq-green, label: 사주냥 관제 }           # 브랜딩
```

→ HTML은 `workspace.showSections.includes('performance')` 같은 조건만
→ API는 `workspace.dataScope.org`로 자동 필터
→ 새 계정 추가 시 코드 수정 완전 0줄

### 참고할 것들 (다음 세션 수집)
- [Anthropic Claude Code Best Practices](https://www.anthropic.com/engineering/claude-code-best-practices)
- [GitHub claude-code-action 예제](https://github.com/anthropics/claude-code-action/tree/main/examples)
- [Writing a good CLAUDE.md](https://www.humanlayer.dev/blog/writing-a-good-claude-md)
- 가쟈누님 방식: PM 에이전트에게 위임 → 자율 실행 7시간

---

## 다음 세션 시작 프롬프트

```
안녕. 오늘 할 일:

1. 먼저 docs/handoff/2026-03-02_v52-리팩토링-준비.md 읽어.

2. Claude Code 모범 사례 수집:
   - anthropics/claude-code-action GitHub 예제 전부
   - Writing a good CLAUDE.md (humanlayer 블로그)
   - 가쟈누님 스타일 자율 PM 워크플로우
   현재 CLAUDE.md에 없는 것 전부 추가 제안

3. v5.2 다계정 리팩토링 구상:
   - 미해결 버그: workspace-profile 404 → 격리 무효 근본 수정
   - workspaces.yaml에 showSections/dataScope 추가
   - 새 계정 = yaml 1줄. 코드 수정 0줄 목표
   - 구상 완성되면 플랜모드로 대표님 승인 받기
```
