# 전수검사 프로토콜

> CLAUDE.md에서 분리된 상세 문서. 전수검사 시 이 파일을 Read로 읽고 따를 것.

## 전수검사란?
- **전수검사 ≠ grep 키워드 검색** — 키워드 검색만 하고 "이상 없음" 선언하면 안 됨
- **전수검사 = 파일을 Read 도구로 처음부터 끝까지 청크로 나눠서 전부 읽고, 각 함수/로직을 직접 이해하며 검토**
- grep은 "어디 있는지 찾기"용. 실제 검사는 반드시 Read로 읽어야 함

## 단계별 프로토콜

**1단계: 파일 전체 읽기 (건너뛰기 금지)**
- Read 도구로 처음부터 끝까지 여러 번 나눠서 전부 읽을 것
- 마지막 줄까지 다 읽었는지 확인. 중간에 멈추면 안 됨

**2단계: 함수별 입출력 검증**
- 각 API 함수의 입력 형식이 실제 SDK 규격과 맞는지 확인
  - OpenAI 파일 업로드: `("파일명.jsonl", bytes)` 튜플 형식
  - Anthropic 배치 결과: `async for result in client.messages.batches.results(...)` — `await` 두 번 금지
- 함수 호출 결과를 사용하는 곳까지 추적

**3단계: 모델명 검증**
- CLAUDE.md의 "실제 존재하는 모델명" 목록과 하나씩 대조
- 목록에 없는 모델명 → **절대 임의로 "최신버전"으로 업그레이드 금지**

**4단계: 중복/누락 확인**
- 같은 API 엔드포인트 두 번 정의 여부 (FastAPI는 두 번째 무시)
- 함수가 return 없이 끝나는 곳
- async 함수에서 await 빠진 곳, await 두 번 쓴 곳

**5단계: 수정 전 반드시 확인**
- 해당 코드가 다른 곳에서 어떻게 호출되는지 추적
- 수정 후 grep으로 구버전 문자열 0건 검증

## 팀 에이전트 전수검사 규칙
- **파일 담당 분리**: 같은 파일을 두 에이전트가 동시에 수정하면 충돌 — 파일마다 담당자 1명만
- **모델명 정보 소스**: CLAUDE.md의 "실제 존재하는 모델명" 표가 절대 기준
- **추측 금지**: 모르면 CLAUDE.md를 먼저 읽거나 팀장에게 물어볼 것
- **수정 완료 선언 조건**: grep으로 구버전/잘못된 값 0건 확인 후에만 "완료" 보고

## 팀 편성 기준

### 작업 범위 파악 (팀 편성 전 필수)
```
1. 수정 대상 파일 목록 → Glob + Grep으로 빠르게 확인
2. 각 파일 줄 수 → 줄 수에 따라 서브에이전트 수 결정
3. 도메인(기능 영역) 수 → 영역마다 전담 배정
```

### 팀 규모 가이드

| 파일 크기 / 작업 규모 | 서브에이전트 | 팀원 상한 |
|-------------------|------------|---------|
| ~500줄 / 단일 버그 | 2명 | 2명 + QA |
| ~3000줄 / 기능 점검 | 3명 | 3~5명 + QA |
| ~5000줄 / 전체 검사 | 4명 | 최대 9명 + QA |
| 5000줄+ | 4명 고정 | 9명 초과 금지 |

### CORTHEX HQ 전체 전수검사 팀 편성표

파일별 담당 1명 고정 (같은 파일 두 명 → 충돌).

| 팀원 | 담당 파일 | 서브에이전트 | 핵심 검사 항목 |
|------|----------|------------|--------------|
| **FE** | `web/templates/index.html` | 5명 | 하드코딩 배열, SNS, 배치 탭, 사령관실, 다크모드 |
| **BE** | `web/mini_server.py` | 5명 | API 중복, 에이전트 목록, async/await |
| **AI** | `web/ai_handler.py` + `src/llm/` | 4명 | 배치 SDK 형식, 모델명, _PRICING |
| **TG** | `src/telegram/` | 3명 | 명령어, 배치 연동 |
| **AGENT** | `src/core/` | 3명 | soul DB, quality_gate, 도구 루프 5회 |
| **TOOL** | `src/tools/` | 4명 | 도구 스키마, Instagram API, Selenium |
| **SNS** | `src/integrations/` | 3명 | SNS 발행, 환경변수, Tistory |
| **CONFIG** | `config/` | 2명 | 모델명, yaml2json 변환 목록 |
| **DEVOPS** | `.github/workflows/` | 2명 | git fetch+reset, 환경변수 전달 |
| **QA** | 전체 (읽기만) | 3명 | 금지 모델명 0건, 하드코딩 잔재 |

→ 총: 팀장 1 + 팀원 10 + 서브에이전트 34 = **45개 에이전트**

### 팀장 vs 팀원 역할

**팀장**: 팀 편성 + spawn, CLAUDE.md 업데이트, 보고 수신 + 충돌 조정, 최종 커밋/푸시/배포
**팀원**: 서브에이전트 spawn → 결과 받고 수정 → grep 검증 → SendMessage 보고

### 팀원 spawn 프롬프트 필수 포함 항목
- [ ] 절대경로 + "이 파일만 수정" 강조
- [ ] 수정 위치 (함수명/줄번호) + 건드리면 안 되는 것
- [ ] 수정 이유 + 완료 확인 방법 (grep 0건 또는 yaml2json 실행)
- [ ] 서브에이전트 구간 분담 (예: 1~2000줄 / 2001~4000줄 / 4001~끝)
- [ ] 허용/금지 모델명 목록 (CLAUDE.md 표 복사)

## 전수검사에서 쌓인 교훈

| 카테고리 | 교훈 |
|---------|------|
| 배포/서버 | `git pull` 금지 → `git fetch + git reset --hard` 사용 |
| 배포/서버 | Actions 로그 전체 확인 (중간 에러 있어도 최종 "success" 가능) |
| 배포/서버 | 새 .yaml 추가 시 yaml2json.py 변환 목록에도 반드시 추가 |
| FastAPI | 엔드포인트 중복 정의 → 두 번째 무시. 추가 전 grep 확인 |
| FastAPI | 서버 응답 구조와 프론트엔드 접근 코드 반드시 동시에 확인 |
| 배치 | OpenAI 파일 업로드: `file=("batch.jsonl", bytes)` 튜플 형식 |
| 배치 | Anthropic batch results: `async for`로만 순회 |
| 하드코딩 | yaml 단일 소스에서 동적으로 읽을 것 |
| 모델명 | "있을 것 같은" 모델명 지어내기 금지 |
| 팀 작업 | 같은 파일 두 팀원 수정 금지 |
| 팀 작업 | 컴팩트 시 팀원 전원 사라짐 → 컴팩트 전 미커밋 파일 커밋 |
| 팀 작업 | 3~5줄 수정에 팀 투입 금지 |
| 팀 작업 | auto-merge 후 deploy.yml 트리거 확인 필수 |
| 데이터 | `data/*.json` 저장 금지 → `save_setting(key, value)` 사용 |
| CSS | `opacity` 애니메이션 → `::before` 가상 요소로 분리 |

## 시작 전 체크리스트 (팀장)
1. `docs/project-status.md` 읽기
2. `docs/updates/` 최근 2~3개 읽기
3. 파일 담당 명확히 배정 (중복 금지)
4. 팀원 spawn 프롬프트에 담당 파일, 서브에이전트 활용법, 모델명 목록, SendMessage 보고 지시 포함

## 완료 후 체크리스트 (팀장)
1. QA 금지 모델명 0건 확인
2. 수정 내용 취합
3. CLAUDE.md 교훈 추가
4. `config/yaml2json.py` 실행
5. 커밋 + 푸시 + 배포 ([완료] 태그)
6. `docs/updates/` 작성 + `docs/project-status.md` 갱신
7. CEO에게 빌드 번호 체크리스트 보고
