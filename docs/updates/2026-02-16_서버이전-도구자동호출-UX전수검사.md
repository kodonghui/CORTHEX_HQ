# 서버 이전 + AI 도구 자동호출 + UX 전수검사

## 버전
0.13.000

## 작업 날짜
2026-02-16

## 작업 브랜치
claude/fix-multi-provider-ai-chat

---

## 변경 사항 요약

### 1. 서버 이전 준비 (deploy.yml 수정)

기존 소형 서버(1GB RAM)에서 ARM 4코어 24GB 서버로 이전하기 위해 배포 스크립트를 수정했습니다.

| 항목 | 이전 | 이후 |
|------|------|------|
| 서버 IP | 하드코딩 (`168.107.28.100`) | GitHub Secrets (`SERVER_IP`)에서 자동으로 읽어옴 |
| 새 서버 초기 설정 | 수동 | deploy.yml이 자동으로 설정 (nginx, Python 가상환경, 서비스 등록) |
| 서버 스펙 | 1GB RAM, 1코어 | 24GB RAM, ARM 4코어 |

**구체적으로 뭘 바꿨나**:
- deploy.yml 줄 179의 `http://168.107.28.100` → `http://${SERVER_IP}` 변경
- 배포 스크립트에 "0단계: 새 서버 초기 설정" 추가 (처음 한 번만 실행):
  - nginx 웹서버 설치 + API 프록시 설정
  - Python 가상환경(venv) 생성
  - corthex 서비스 등록 (자동 시작)
  - 환경변수 파일 생성

---

### 2. AI 도구 자동호출 (Function Calling)

AI가 111개 도구를 스스로 호출할 수 있게 만들었습니다.

**이전**: AI가 "삼성전자 주가를 조회해보겠습니다"라고 **말만** 하고, 실제로 도구를 실행하지 않음
**이후**: AI가 자동으로 kr_stock 도구를 호출하여 **실제 데이터**로 답변

| 프로바이더 | 도구 호출 방식 | 상태 |
|-----------|-------------|------|
| Claude (Anthropic) | `tools` 파라미터 → `tool_use` 블록 처리 | ✅ 구현 완료 |
| GPT (OpenAI) | `tools` 파라미터 → `tool_calls` 응답 처리 | ✅ 구현 완료 |
| Gemini (Google) | `FunctionDeclaration` → `function_call` 파트 처리 | ✅ 구현 완료 |

**핵심 구현 내용**:
- `ai_handler.py`에 `_load_tool_schemas()` — config/tools.yaml에서 도구 정의를 읽어서 프로바이더별 포맷으로 변환
- `ai_handler.py`에 `_build_tool_schemas()` — Anthropic 포맷으로 도구 스키마 생성
- `ask_ai()`에 `tools`, `tool_executor` 파라미터 추가 — 도구 호출 루프 (최대 5회)
- `arm_server.py`의 `_call_agent()`에서 에이전트별 허용 도구로 스키마를 로드하고 ToolPool을 통해 도구 실행
- 에이전트별 도구 제한: CIO는 투자 도구만, CTO는 기술 도구만 사용

---

### 3. UX 전수검사 (8개 수정)

#### [버그] 부서 필터 초기화
- **문제**: 기밀문서 탭에서 부서 필터를 바꿔도 이전 보고서가 계속 표시됨
- **해결**: `loadArchive()` 함수에서 `archive.content`와 `archive.selectedReport`를 초기화

#### [버그] 사령실 채팅 스크롤
- **문제**: 다른 탭 갔다가 사령실로 돌아오면 채팅이 맨 아래로 안 감
- **해결**: `switchTab()`에서 command 탭 전환 시 `scrollToBottom()` 호출 추가

#### [버그] 피드백(따봉) 토글
- **문제**: 한번 피드백을 보내면 수정/취소 불가
- **해결**: 프론트엔드 — 토글 로직 (같은 버튼=취소, 다른 버튼=변경), 백엔드 — action 파라미터 (send/cancel/change)

#### [UX] 기밀문서 2단 레이아웃
- **문제**: 보고서 보려면 스크롤을 많이 내려야 함
- **해결**: 이메일 앱처럼 왼쪽 1/3 카드 목록 + 오른쪽 2/3 보고서 내용

#### [디자인] 글씨체 변경
- **이전**: Noto Serif KR (명조체, 딱딱함)
- **이후**: Pretendard Variable (깔끔한 고딕체)

#### [디자인] 보고서 이미지 CSS
- 이미지에 `max-width: 100%`, 둥근 모서리, 테두리 추가

#### [디자인] ■ 네모 배지 + 층위 구분
- **이전**: 모든 ■ 문자가 동일한 흰색 네모
- **이후**: 상위항목 = 보라색 배지, 하위항목 = 시안색 배지, 3단계 = 초록색 배지

#### [버그] 피드백 API 토글 지원
- 백엔드 POST `/api/feedback`에 `action` 파라미터 추가 (send/cancel/change)
- 같은 버튼 재클릭 → 취소, 다른 버튼 클릭 → 변경

---

### 4. 문서 업데이트

- `CLAUDE.md`: 서버 IP 하드코딩 제거 → Secrets 참조, AI 도구 자동호출 규칙 추가, 버전 업데이트
- `docs/project-status.md`: 최신 상태 반영

---

## 수정한 파일 목록

| 파일 | 설명 |
|------|------|
| `.github/workflows/deploy.yml` | 서버 이전 (하드코딩 IP 제거 + 새 서버 초기 설정 추가) |
| `web/ai_handler.py` | AI 도구 자동호출 (3개 프로바이더 function calling) |
| `web/arm_server.py` | 피드백 토글 API + 도구 호출 연동 |
| `web/templates/index.html` | UX 전수검사 8개 수정 |
| `CLAUDE.md` | 서버 정보, 도구 자동호출 규칙, 버전 업데이트 |
| `docs/project-status.md` | 프로젝트 현재 상태 업데이트 |

---

### 5. AI Batch API 시스템

여러 AI 요청을 한꺼번에 보내서 비용을 절감하는 시스템을 구현했습니다.

| 항목 | 설명 |
|------|------|
| Anthropic 배치 | `client.beta.messages.batches.create()` → 결과 자동 수집 |
| OpenAI 배치 | JSONL 파일 업로드 → `client.batches.create()` → 결과 다운로드 |
| Gemini 배치 | API 키 방식에서는 병렬 실시간 호출로 대체 (Vertex AI 미사용) |

**핵심 기능**:
- 사령실에서 📦 Batch 토글 → 요청이 대기열에 쌓임
- 5건 이상 쌓이면 자동 제출, 또는 `/배치실행` 명령으로 즉시 제출
- 60초 간격 백그라운드 폴러가 결과를 자동 수집
- 완료 시 에이전트에게 자동 위임 + 아카이브 저장 + WebSocket 알림
- `/배치상태` 명령으로 현재 진행 상황 확인 가능

---

## 수정한 파일 목록 (추가분)

| 파일 | 설명 |
|------|------|
| `web/ai_handler.py` | Batch API 함수 추가 (batch_submit/check/retrieve, 3개 프로바이더) |
| `web/arm_server.py` | PENDING 추적 + 자동 결과 수집 폴러 + /배치실행/배치상태 명령 |
| `docs/project-status.md` | 버전 0.13.000 + 배치 시스템 + 서버 정보 업데이트 |

---

## 현재 상태
- 코드 변경: **완료**
- 배포: **대기 중** ([완료] 커밋 후 자동 배포)

## 다음에 할 일
1. 새 서버(158.179.165.97)에서 배포 확인
2. 사령실에서 "삼성전자 주가 분석해줘" → AI가 도구 자동 호출하는지 확인
3. 사령실에서 📦 배치 모드로 여러 요청 → Batch API 결과 자동 수집 확인
4. 기밀문서 2단 레이아웃, 피드백 토글 등 UX 확인
5. 키움증권 Open API+ 연동
6. 소울 추가 보강
