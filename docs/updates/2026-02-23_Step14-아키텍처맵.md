# Step 14: 아키텍처 맵 대시보드

- **날짜**: 2026-02-23
- **버전**: 3.02.023
- **브랜치**: claude/step14-architecture-map

---

## 변경 요약

"우리 회사가 지금 어떻게 돌아가고 있는지"를 한눈에 볼 수 있는 대시보드. 리팩토링 14단계 중 마지막.

| 구분 | 이전 | 이후 |
|------|------|------|
| 조직도 | 사이드바 텍스트 목록만 | Mermaid.js 시각화 트리 (29노드 + 부서별 색상) |
| 에이전트 상태 | 사이드바 점(dot)만 | 부서별 카드 그리드 + 작업중/대기 표시 |
| 비용 분석 | 헤더 총액만 | 부서별 도넛 + 에이전트 TOP10 바 차트 + 상세 테이블 |
| 에이전트 접근 | 사이드바 클릭 → 설정 | 조직도/현황 클릭 → **사령관실에서 대화** |
| 비용 확인 | 없음 | 이번 달 총액 히어로 카드 + 오늘 + 일평균 |

---

## 수정 파일 (5개)

### 1. `web/db.py` — 비용 집계 함수 2개
- `get_cost_by_agent(period)`: 에이전트별 cost_usd, call_count, tokens 집계
- `get_cost_by_agent_raw(period)`: division 매핑용 raw 데이터

### 2. `web/handlers/architecture_handler.py` — 새 파일, 4개 API
- GET `/api/architecture/hierarchy` — 조직도 트리 (nodes/edges)
- GET `/api/architecture/cost-summary` — 이번달/오늘/일평균
- GET `/api/architecture/cost-by-agent?period=month` — 에이전트별 비용
- GET `/api/architecture/cost-by-division?period=month` — 부서별 비용

### 3. `web/arm_server.py` — 라우터 등록 1줄

### 4. `web/static/js/corthex-app.js` — 상태 + 탭 + 메서드 9개
- archMap 상태 변수, archmap 탭 정의, getSecondaryTabs에 추가
- loadArchMap, loadArchMapCosts, changeCostPeriod
- renderMermaidOrgChart, bindOrgChartClicks
- renderCostCharts, _renderDivisionDonut, _renderAgentBarChart
- getDeptAgents, getDeptWorkingCount 헬퍼

### 5. `web/templates/index.html` — CDN + 탭 패널 + 모바일
- Chart.js 4.4.7 + Mermaid 11 CDN 추가
- 3개 서브탭: 조직도/실시간 현황/비용 분석
- 모바일 더보기 바텀시트에 조직도 항목 추가

---

## 검증 포인트

1. 더보기 → "조직도" → 탭 전환
2. Mermaid 트리 렌더링 (29개 노드 + 부서별 색상)
3. 에이전트 클릭 → 사령관실 이동 + 해당 에이전트 대화
4. 실시간 현황: 부서별 카드, 에이전트 상태 점
5. 비용 분석: 도넛/바 차트 + 기간 필터
6. 히어로 카드: 이번 달/오늘/일평균
7. 모바일 접근성
