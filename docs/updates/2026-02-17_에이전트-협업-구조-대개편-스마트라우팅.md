# 에이전트 협업 구조 대 개편 — 스마트 라우팅 + 처장 자율 선택 + CEO 직접 개입

## 버전
2.00.000

## 작업 날짜
2026-02-17

## 작업 브랜치
claude/agent-collab-overhaul

## 변경 사항 요약

### 배경: 왜 이걸 바꿨나?

기존 CORTHEX는 "안녕하세요" 같은 간단한 인사말에도 처장 6명 + 보좌관 3명 + 전문가 전원을 전부 동시에 호출했습니다. 코드(arm_server.py)가 모든 결정권을 갖고 있었고, AI 에이전트들은 시킨 일만 했습니다. CEO가 특정 에이전트에게 직접 말을 걸 수도 없었습니다.

이번 작업으로 세 가지를 구현했습니다.

---

### 1. 스마트 라우팅 — 4단계 복잡도 자동 판단

질문의 성격에 따라 자동으로 규모를 조정합니다.

| 레벨 | 어떤 질문? | 누가 처리? | 비용 |
|------|-----------|-----------|------|
| Level 1 | "안녕", "일정 알려줘" 등 간단한 요청 | 비서실장만 (1명) | 극소 |
| Level 2 | "투자 현황 알려줘" 등 단일 부서 질문 | 해당 처장 1명만 | 낮음 |
| Level 3 | "투자 전략 분석 보고서" 등 깊은 분석 | 처장 1명 + 필요한 전문가만 선택 | 중간 |
| Level 4 | 여러 부서 관련 또는 복합 전략 | 기존 방식 (전원 협력) | 높음 |

**기대 효과**: AI 호출 비용 평균 60~70% 절감

비서실장이 항상 최종 보고서 1개를 CEO에게 전달하는 원칙은 유지됩니다.

---

### 2. 처장의 자율 전문가 선택 (C+ 아이디어)

기존에는 코드가 "CIO처장이면 시황·종목·기술·리스크 4명 전원 호출"을 강제했습니다.

이제 처장 AI가 `spawn_agent(전문가ID, 작업내용)` 도구를 통해 스스로 판단합니다:
- "이건 시황분석만 필요해" → 시황분석 전문가 1명만 호출
- "종합 투자 전략이네" → 필요한 전문가 전원 호출
- "내가 직접 처리할 수 있어" → 전문가 0명, 처장 혼자 답변

---

### 3. CEO 직접 개입 UI (A 아이디어)

사령실 채팅창에 수신자 선택 드롭다운이 추가됩니다.

- **기본값**: 🤖 전체 자동 라우팅 (기존과 동일)
- **선택 가능**: 비서실장, 처장 6명, 전문가 22명 (총 29명 전원)
- 특정 에이전트를 선택하면 비서실장을 거치지 않고 바로 전달

---

### 4. 에이전트 간 실시간 소통 (A 아이디어)

기존 `cross_agent_protocol` 도구는 메시지를 파일에 저장만 하고 아무것도 안 했습니다.

이제 `request` 액션을 사용하면 실제로 대상 에이전트 AI를 실시간 호출하고 결과를 바로 반환합니다. 처장끼리, 전문가끼리 직접 정보를 주고받을 수 있게 됩니다.

---

## 수정한 파일

| 파일 | 역할 | 변경 내용 |
|------|------|----------|
| `web/arm_server.py` | 핵심 서버 로직 | 스마트 라우팅 함수 5개 추가 + `_broadcast_to_managers()` 라우팅 허브로 교체 + WebSocket에서 `target_agent_id` 수신 |
| `web/ai_handler.py` | AI 호출 모듈 | `SPAWN_AGENT_TOOL_SCHEMA` 상수 추가 (처장이 전문가 호출용 도구 스키마) |
| `src/tools/cross_agent_protocol.py` | 에이전트 간 소통 도구 | `register_call_agent()` 추가 + `_request()` 실시간 AI 호출로 업그레이드 |
| `config/agents.yaml` | 에이전트 설정 파일 | 비서실장 + 처장 7명의 Soul(성격 지시문)에 라우팅/자율선택 안내 추가 |
| `web/templates/index.html` | 웹 화면 | 사령실 채팅창에 수신자 선택 드롭다운 추가 |

---

## 현재 상태
- 코딩 완료, 커밋 + 푸시 + 자동 머지 + 배포 대기

## 다음에 확인할 것
- 사령실에서 "안녕하세요" 입력 → 비서실장만 답변하는지 확인
- 수신자 드롭다운에서 "CIO처장 직접" 선택 후 메시지 전송 → 바로 CIO처장이 답변하는지
- "투자 전략 분석 보고서 만들어줘" 입력 → CIO처장 + 일부 전문가만 호출되는지
- 기존 "전사 질문"은 여전히 전원이 협력하는지

## 다음에 할 일
- 키움증권 Open API+ 연동 (모의투자 → 실거래 전환)
- SNS API 키 등록 (인스타그램, 유튜브 등)
- 도메인 연결 + HTTPS 설정
