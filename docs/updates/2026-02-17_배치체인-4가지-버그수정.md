# 배치 체인 4가지 핵심 버그 수정

## 버전
1.04.006

## 작업 날짜
2026-02-17

## 작업 브랜치
claude/fix-multi-provider-ai-chat

---

## 문제 상황

텔레그램에서 `/batch` 후 "전원 출석체크" 명령 시 **모든 부서가 "응답 없음 (배치 처리 중 오류 발생)"** 으로 표시됨.

```
처장 지시서 0/6 완료
전문가 0명 완료 → 종합보고서 작성 시작
배치 체인 완료 → 6개 부서 모두 응답 없음
```

비용도 $0.0000으로 API 호출이 전혀 되지 않은 것으로 확인됨.

---

## 전수조사 결과 — 발견된 버그 4가지

### 버그 1: Anthropic 배치 API 경로 오류 (ai_handler.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/ai_handler.py` — `_batch_submit_anthropic`, `_batch_check_anthropic`, `_batch_retrieve_anthropic` |
| **문제** | `_anthropic_client.beta.messages.batches` (구버전 경로) 사용 |
| **원인** | Anthropic SDK 최신 버전에서 정식 경로는 `messages.batches` |
| **수정** | `beta.messages.batches` → `messages.batches` (3곳 모두 변경) |

이게 배치가 전부 실패하는 **핵심 원인**으로 추정됩니다.

### 버그 2: specialists 배치 실패 시 오류 원인 불명 (mini_server.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/mini_server.py` — `_advance_batch_chain` specialists 단계 |
| **문제** | 배치가 실패해도 텔레그램에 "전문가 0명 완료"만 표시, 실제 오류 원인 전달 안 됨 |
| **수정** | 배치 확인/수집 오류를 `batch_errors`/`retrieve_errors` 리스트에 추적, 결과 0명 시 구체적 오류 메시지 텔레그램 전달 |

### 버그 3: synthesis 배치 실패 시 폴백 없음 (mini_server.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/mini_server.py` — `_advance_batch_chain` synthesis 단계 |
| **문제** | 종합보고서 배치가 실패하면 "응답 없음"으로 끝나버림 |
| **수정** | 배치 실패 시 `_synthesis_realtime_fallback()` 함수로 실시간 `ask_ai()` 호출 |

### 버그 4: 오류 추적 로직 부재 (mini_server.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/mini_server.py` — synthesis 단계 |
| **문제** | 종합 배치 확인 오류가 로그(`_log()`)에만 기록, 텔레그램으로 전달 안 됨 |
| **수정** | `synth_errors` 리스트로 오류 추적, 실패 시 텔레그램으로 오류 원인 전달 |

---

## 신규 추가 함수

### `_synthesis_realtime_fallback(chain)`
- **역할**: 종합보고서 배치가 실패했을 때 실시간 `ask_ai()`로 대신 처리
- **동작**: 브로드캐스트 모드는 6개 처장 모두, 단일 모드는 해당 처장 1명이 실시간으로 답변
- **효과**: 배치 API가 실패해도 최종 보고서가 나옴

---

## 변경된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `web/ai_handler.py` | Anthropic 배치 API 경로 3곳 수정 (`beta.` 제거) |
| `web/mini_server.py` | 오류 추적 강화 + `_synthesis_realtime_fallback` 함수 신규 추가 |

---

## 현재 상태

- ✅ 코드 수정 완료
- ✅ 커밋 완료
- 🔄 배포 중 (자동 머지 트리거됨)

---

## 다음에 할 일

배포 후 텔레그램에서 `/batch` + "전원 출석체크" 재테스트:
- 오류가 해결됐으면 → 6개 부서 응답 수신
- 아직 오류이면 → 이제 텔레그램에 **구체적인 오류 원인**이 표시됨 → 그걸 보고 추가 수정

---

## 확인 방법

텔레그램에서:
1. `/batch` 입력 → "배치 모드로 전환했습니다"
2. "전원 출석체크" 입력 → 배치 체인 시작
3. 결과 확인:
   - **성공**: 6개 부서 각각 보고서 수신
   - **실패**: 이제 "⚠️ 전문가 배치 실패 — 원인: 프로바이더: 오류내용" 메시지가 텔레그램으로 전달됨
