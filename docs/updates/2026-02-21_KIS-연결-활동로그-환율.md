# KIS 연결 수정 + 전체 활동 로그 + 환율 실시간 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.01.001
- **브랜치**: claude/fix-auto-trading-pipeline, claude/fix-exchange-rate-and-docs
- **빌드**: #384 (첫 배포), #385 예정 (환율+CLAUDE.md)

---

## 변경 사항

### 수정한 것

| 파일 | 수정 내용 |
|------|----------|
| `web/kis_client.py` | KIS 토큰 만료돼도 잔고 ₩0이 아닌 **캐시된 값 표시** (3계층: 메모리→DB→API) |
| `web/arm_server.py` | "즉시 매매" 버튼 → paper_trading 설정 무시, **KIS 연결 시 실매매** 실행 |
| `web/arm_server.py` | 디버그 URL 3개 추가: `/api/debug/kis-token`, `/api/debug/auto-trading-pipeline`, `/api/debug/fx-rate` |
| `web/arm_server.py` | **전체 활동 로그 미들웨어** — 모든 API 요청 자동 기록 + WebSocket 실시간 전송 |
| `web/arm_server.py` | **환율 실시간 갱신** — yfinance로 1시간마다 USD/KRW 자동 업데이트 (1450원 하드코딩 제거) |
| `web/arm_server.py` | 비서실장 위임 표시 제거 — 처장 이름만 직접 표시 |
| `src/tools/cross_agent_protocol.py` | **에이전트 ID 검증 + 별칭 매핑** — AI가 `risk_manager` 보내면 `risk_management_specialist`로 자동 변환 |
| `web/templates/index.html` | 활동 로그 DB에서 로드 (새로고침해도 최근 50건 유지) |
| `web/templates/index.html` | "COMM LOG" → "ACTIVITY LOG" 이름 변경 |
| `CLAUDE.md` | 업데이트 기록 + 버그리포트 규칙 대폭 강화 |

### 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| 비서실 태그 잘못 표시 (risk_manager 등) | AI가 cross_agent_protocol에 가짜 에이전트 ID 전달, 검증 없이 실행 → _AGENT_DIVISION에서 "secretary" 기본값 | ✅ 수정 완료 |
| 즉시매매 버튼이 실매매 안 함 | paper_trading=True 설정이 수동 실행도 차단 | ✅ 수정 완료 |
| 잔고 ₩0 간헐적 표시 | KIS 토큰 24시간 만료 시 잔고 조회 실패 | ✅ 수정 완료 (캐시) |
| 환율 1450원 고정 | 실시간 환율 미연동, DB 기본값 사용 | ✅ 수정 완료 (yfinance 자동 갱신) |
| 비서실장 상태등 깜빡임 | 위임 시 chief_of_staff broadcast가 불필요하게 발생 | ✅ 수정 완료 |

### 현재 상태
- 자동매매: KIS 실계좌 연결됨, 실매매 가능
- 활동 로그: 모든 API 요청 자동 기록 (DB 저장 + 실시간 WebSocket)
- 환율: yfinance에서 1시간마다 자동 갱신 (서버 시작 시 즉시 1회)
- 에이전트 ID: cross_agent_protocol에 20개 별칭 매핑 + 퍼지 매칭

### 다음에 할 일
- CIO 분석 정확도 개선
- 포트폴리오 대시보드 리디자인
