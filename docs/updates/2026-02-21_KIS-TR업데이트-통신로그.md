# KIS TR_ID 신버전 업데이트 + 통신로그 탭 통합 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.01.003
- **브랜치**: claude/fix-kis-ui-connection
- **빌드**: #388

---

## 변경 사항

### 🔧 수정한 것

| 파일 | 수정 내용 |
|------|----------|
| `web/kis_client.py` | **KIS 국내주식 TR_ID 신버전 업데이트** — 구 TR(TTTC0802U/0801U)이 "사전고지 없이 차단 가능"이라 신 TR(TTTC0012U/0011U)로 교체. 이게 매매 안 된 원인일 수 있음 |
| `web/kis_client.py` | **KIS 해외 모의투자 매도 TR_ID 수정** — VTTT1006U → VTTT1001U (공식문서 기준) |
| `web/kis_client.py` | **국내주식 주문 body 파라미터 추가** — SLL_TYPE, EXCG_ID_DVSN_CD, CNDT_PRIC (최신 API 스펙) |
| `web/templates/index.html` | **통신로그 탭을 메인 탭으로 승격** — "더보기" 드롭다운에서 메인 탭 바로 옆으로 이동 |
| `web/templates/index.html` | **통신로그 = 활동로그 + 교신로그 통합** — 서브탭으로 전환 가능, 교신로그도 실시간 SSE |
| `web/templates/index.html` | **JSON 파싱 에러 처리** — 분석이 오래 걸려 nginx 타임아웃 시 "Unexpected token '<'" 대신 안내 메시지 표시 |
| `web/db.py` | **활동 로그 쿼리에 created_at 추가** — 페이지 새로고침 후에도 정확한 시간 표시 |

### 🐛 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| **매매 안 됨 (가장 큰 원인 후보)** | KIS 국내주식 TR_ID가 구버전(TTTC0802U/0801U). KIS가 "사전고지 없이 차단 가능"이라고 명시. 신TR(TTTC0012U/0011U)로 교체 필요 | ✅ 수정 완료 |
| 해외 모의투자 매도 TR_ID 불일치 | 코드: VTTT1006U, 공식문서: VTTT1001U | ✅ 수정 완료 |
| "분석 오류: Unexpected token '<'" | 분석 5~10분 소요 → nginx 프록시 60초 타임아웃 → HTML 에러 페이지 반환 → JSON 파싱 실패 | ✅ 에러 메시지 개선 |
| 통신로그 탭 안 보임 | "더보기" 드롭다운에 숨어있었음 | ✅ 메인 탭으로 이동 |
| 활동 로그 시간 부정확 | DB 쿼리에 created_at 미포함 → 페이지 로드 시각으로 표시 | ✅ 수정 완료 |

### 📊 분석 결과 (CEO 확인 필요)

| 항목 | 결과 |
|------|------|
| KIS Trading MCP | CEO가 발견한 한국투자증권 공식 MCP 서버. 우리 시스템은 직접 API 호출 방식이라 MCP 불필요. 단, TR_ID는 공식 문서와 동기화 필요 |
| 매매 안 된 원인 | 1순위: KIS TR_ID 구버전 차단 가능성. 2순위: nginx 타임아웃으로 HTTP 응답 끊김 (서버에서는 분석 완료, 주문은 진행됐을 수도). 다음 실행 시 활동 로그에서 정확한 원인 확인 가능 |
| trading_executor 도구 | CIO의 allowed_tools에 포함되어 있음. 코드 자체는 정상. KIS API 호출 부분만 TR_ID 문제 |

### 📋 다음에 할 일
- "즉시 분석·매매결정" 다시 실행 → 활동 로그에서 KIS 주문 응답 확인
- B안 구조 변경 (CIO + 리스크관리 2명 체제) — CEO 승인 완료, 미구현
- nginx proxy_read_timeout 늘리기 (선택: 분석 시간 동안 연결 유지)
