# v0.3.1 업데이트 — 에이전트 헬스체크 + 성과 대시보드

> 날짜: 2026-02-12
> 상태: **구현 완료**
> 브랜치: `claude/add-new-feature-qTgdv`

---

## 한 줄 요약

**시스템 상태를 진단하는 "헬스체크"와 에이전트별 비용/성공률/응답시간을 한눈에 보는 "성과 대시보드"를 추가했습니다.**

---

## 왜 만들었나?

| 문제 | 설명 |
|------|------|
| 장애 진단 불가 | API 키가 잘못됐는지, 프로바이더가 죽었는지, 에이전트 설정이 꼬였는지 알 수 있는 방법이 없었음 |
| 성과 파악 불가 | 어떤 에이전트가 비용을 많이 먹는지, 응답이 느린지, 실패가 잦은지 확인할 수 없었음 |
| `비용` 명령의 한계 | 모델별 비용만 보여줬지, 에이전트별 성과 지표(성공률, 응답시간)는 제공하지 않았음 |

---

## 1. 에이전트 헬스체크

### 기능

`헬스체크` 또는 `health` 명령으로 전체 시스템 상태를 한눈에 진단합니다.

### 점검 항목 (3가지)

| 항목 | 설명 | 판정 기준 |
|------|------|-----------|
| **LLM 프로바이더 연결** | OpenAI, Anthropic 각각 경량 ping 전송 | OK: 응답 성공 / WARN: API 키 미설정 / ERROR: 연결 실패 |
| **에이전트 설정 검증** | 25개 에이전트의 system_prompt, model_name, 매니저-부하 관계 확인 | OK: 전체 정상 / WARN: 설정 이상 발견 |
| **조직도 무결성** | 상관(superior_id)과 부하(subordinate_ids)가 실제 등록된 에이전트인지 교차 검증 | OK: 계층 정상 / ERROR: 미등록 참조 발견 |

### CLI 출력 예시

```
┌───────────────── 시스템 헬스체크 ──────────────────┐
│ 항목           │ 상태  │ 내용                │ 지연(ms) │
│────────────────┼───────┼─────────────────────┼──────────│
│ LLM:openai     │  OK   │ openai 연결 정상    │      342 │
│ LLM:anthropic  │  OK   │ anthropic 연결 정상 │      521 │
│ 에이전트 설정   │  OK   │ 전체 25개 설정 정상 │        - │
│ 조직도 무결성   │  OK   │ 상하 관계 정상      │        - │
│────────────────┼───────┼─────────────────────┼──────────│
│ 종합           │  OK   │ 에이전트 25개 │ 프로바이더 2개  │
└────────────────────────────────────────────────────┘
```

### 웹 API

```
GET /api/health
```

```json
{
  "overall": "ok",
  "agent_count": 25,
  "provider_count": 2,
  "checks": [
    {
      "name": "LLM:openai",
      "status": "ok",
      "message": "openai 연결 정상 (gpt-4o-mini)",
      "latency_ms": 342.1
    },
    ...
  ]
}
```

---

## 2. 성과 대시보드

### 기능

`성과` 또는 `performance` 명령으로 에이전트별 성과 지표를 테이블로 확인합니다.

### 추적 지표 (에이전트별)

| 지표 | 설명 | 데이터 소스 |
|------|------|-------------|
| **LLM 호출 수** | 해당 에이전트가 LLM을 호출한 횟수 | CostTracker |
| **토큰 (입/출)** | 입력 토큰과 출력 토큰 합계 | CostTracker |
| **비용 (USD)** | 누적 API 비용 | CostTracker |
| **태스크 수** | 받은 태스크 / 완료한 태스크 | SharedContext 대화 이력 |
| **성공률** | 완료 / (완료 + 실패) * 100% | SharedContext 대화 이력 |
| **평균 응답시간** | 태스크 처리에 걸린 평균 시간(초) | TaskResult.execution_time_seconds |

### CLI 출력 예시

```
총 LLM 호출: 15회 | 총 비용: $0.0342 | 총 태스크: 8건

┌──────────────────── 에이전트 성과 대시보드 ────────────────────┐
│ 에이전트     │ 역할      │ 모델        │ LLM │ 토큰        │ 비용     │ 태스크 │ 성공률 │ 평균(초) │
│──────────────┼───────────┼─────────────┼─────┼─────────────┼──────────┼────────┼────────┼──────────│
│ 비서실장     │ manager   │ gpt-4o      │   3 │ 2,100/890   │ $0.0120  │    3/3 │  100%  │     2.3  │
│ 기술개발처장 │ manager   │ gpt-4o      │   2 │ 1,500/620   │ $0.0080  │    2/2 │  100%  │     3.1  │
│ 프론트엔드   │ specialist│ gpt-4o-mini │   1 │   800/350   │ $0.0003  │    1/1 │  100%  │     1.5  │
│ ...          │           │             │     │             │          │        │        │          │
└────────────────────────────────────────────────────────────────┘
```

### 특징

- **비용 순 정렬**: 비용을 가장 많이 쓴 에이전트가 맨 위
- **활동 없는 에이전트 숨김**: LLM 호출 0 + 태스크 0인 에이전트는 표시하지 않음
- **성공률 색상**: 80% 이상 초록, 50% 이상 노랑, 미만 빨강

### 웹 API

```
GET /api/performance
```

```json
{
  "total_llm_calls": 15,
  "total_cost_usd": 0.0342,
  "total_tasks": 8,
  "agents": [
    {
      "agent_id": "chief_of_staff",
      "name_ko": "비서실장",
      "role": "manager",
      "model_name": "gpt-4o",
      "llm_calls": 3,
      "input_tokens": 2100,
      "output_tokens": 890,
      "cost_usd": 0.012,
      "tasks_received": 3,
      "tasks_completed": 3,
      "tasks_failed": 0,
      "success_rate": 100.0,
      "avg_execution_seconds": 2.3,
      "total_execution_seconds": 6.9
    },
    ...
  ]
}
```

---

## 수정/추가된 파일 (4개)

| 파일 | 변경 | 상세 |
|------|------|------|
| `src/core/healthcheck.py` | **신규** | 헬스체크 엔진. 프로바이더 ping, 에이전트 설정 검증, 조직도 무결성 검사를 `asyncio.gather`로 병렬 실행 |
| `src/core/performance.py` | **신규** | 성과 집계 엔진. CostTracker + SharedContext 대화 이력에서 에이전트별 통계 추출 |
| `src/cli/app.py` | **수정** | `헬스체크/health`, `성과/performance` 명령어 추가. `_bootstrap`이 registry/context도 반환하도록 변경. 도움말 텍스트 업데이트 |
| `web/app.py` | **수정** | `GET /api/health`, `GET /api/performance` 엔드포인트 추가 |

---

## 명령어 요약 (v0.3.1 기준)

| 명령어 | 설명 |
|--------|------|
| `자연어 명령` | 어떤 업무든 한국어로 입력 |
| `조직도` / `org` | 현재 조직 구조 표시 |
| `비용` / `cost` | 누적 API 비용 확인 (모델별) |
| `헬스체크` / `health` | **시스템 상태 진단** |
| `성과` / `performance` | **에이전트 성과 대시보드** |
| `도움말` / `help` | 도움말 표시 |
| `종료` / `exit` | 프로그램 종료 |

---

## 아키텍처 참고

```
                    ┌──────────────┐
                    │  CEO 명령어   │
                    └──────┬───────┘
                           │
              ┌────────────┴────────────┐
              │                         │
     CLI (main.py)              Web (run_web.py)
     ┌────────────────┐        ┌────────────────┐
     │ 헬스체크/health │        │ /api/health    │
     │ 성과/performance│        │ /api/performance│
     └───────┬────────┘        └───────┬────────┘
             │                         │
             ▼                         ▼
    ┌─────────────────────────────────────────┐
    │         src/core/healthcheck.py         │
    │  - _check_providers()  (LLM ping)       │
    │  - _check_agents()     (설정 검증)      │
    │  - _check_hierarchy()  (조직도 무결성)  │
    ├─────────────────────────────────────────┤
    │         src/core/performance.py         │
    │  - CostTracker 데이터 집계              │
    │  - SharedContext 대화이력 분석           │
    │  - 에이전트별 AgentStats 생성           │
    └─────────────────────────────────────────┘
```

---

## 다음 단계 (검토 필요)

- [ ] LLM 폴백 시스템 (프로바이더 장애 시 자동 전환)
- [ ] 태스크 히스토리 (세션 저장/조회, SQLite)
- [ ] 웹 UI에 헬스체크/성과 탭 추가
