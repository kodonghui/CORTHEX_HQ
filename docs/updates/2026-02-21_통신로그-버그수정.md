# 통신로그 전체 버그 수정 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.01.004
- **브랜치**: claude/fix-log-issues
- **빌드**: #392

---

## 변경 사항

### 🔧 수정한 것

| 파일 | 수정 내용 |
|------|----------|
| `web/templates/index.html` | **활동로그 이모지/내용 안 보이던 버그 수정** — SSE로 받은 데이터는 `message` 필드인데, 화면에 표시할 때 `action` 필드를 읽고 있었음. `message → action` 매핑 추가 |
| `web/templates/index.html` | **활동로그 빈 항목 필터링** — 내용 없는 로그는 화면에 안 보이게 처리 |
| `web/mini_server.py` | **활동로그 폴링 노이즈 제거** — budget, trading/summary, trading/history 등 자동 폴링 API 호출을 로그 스킵 목록에 추가 |
| `web/templates/index.html` | **교신로그 시간 정렬 수정** — SSE 새 메시지 도착 시 `created_at` 기준 내림차순 정렬 적용. 초기 로드 + WS + SSE 모든 경로에 정렬 통일 |
| `src/tools/cross_agent_protocol.py` | **P2P 에이전트 ID 해석 순서 수정** — AI가 보낸 `equity_analyst` 같은 가짜 ID를 SSE broadcast 전에 실제 ID로 변환하도록 수정 |
| `src/tools/cross_agent_protocol.py` | **handoff에도 에이전트 ID 사전 해석 적용** |

### 🐛 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| 활동로그 이모지/내용 안 보임 (탭 전환해야 보임) | SSE 데이터는 `message` 필드, 렌더링은 `log.action` 참조. DB 복원 시에만 매핑이 있었음 | ✅ 수정 완료 |
| 활동로그에 빈 항목 (시간만 보임) | 위와 동일한 원인 + API 폴링 노이즈 | ✅ 수정 완료 |
| 교신로그 시간 정렬 뒤죽박죽 | SSE `.unshift()`가 배열의 기존 시간순서를 무시하고 맨 앞에 강제 삽입 | ✅ 수정 완료 |
| 교신로그에 `equity_analyst` 표시 | P2P 메시지 저장 시 ID 해석이 SSE broadcast 후에 일어남 | ✅ 수정 완료 |
| **매매 안 됨** | 원인 복합: ①KIS TR_ID 구버전 차단(#388에서 수정) ②잔고 부족($171 < NVDA $189) ③로그 안 보여서 디버깅 불가(#392에서 수정) | ✅ 해결 — 첫 실매매 성공! |

### 📊 현재 상태
- 활동로그: 실시간 SSE로 이모지/내용 정상 표시
- 교신로그: 시간순 내림차순 정렬 (최신→오래된 순)
- P2P: equity_analyst → 종목분석 Specialist로 올바르게 표시

### 📋 다음에 할 일
- ~~"즉시 분석·매매결정" 재실행 후 활동로그에서 KIS 주문 로그 확인~~ → ✅ 확인 완료, 첫 실매매 성공!
- ~~매매 안 되는 근본 원인 파악~~ → ✅ TR_ID + 잔고 부족 + 로그 버그 복합 원인
- 잔고 조회 정상화 (해외 잔고 API)
- `enable_real`/`enable_mock` 설정 서버 반영
