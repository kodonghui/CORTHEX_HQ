# 배치 시스템 7가지 추가 수정 — 텔레그램 연동 + 치명적 버그 수정

## 버전
1.04.005

## 작업 날짜
2026-02-17

## 작업 브랜치
claude/fix-multi-provider-ai-chat

## 변경 사항 요약

배치 시스템을 추가 전수검사하여 발견한 **7가지 문제**를 모두 수정했습니다.
특히 **배치 체인이 영원히 멈추는 치명적 버그**를 발견하여 수정했습니다.

### 수정된 파일
| 파일 | 역할 | 변경 내용 |
|------|------|----------|
| `web/arm_server.py` (백엔드 서버) | 배치 체인 + 텔레그램 | 7가지 수정 전부 |

### 수정 상세

| # | 문제 | 원인 | 해결 |
|---|------|------|------|
| 1 | **배치 체인이 영원히 멈춤** (치명적!) | `_chain_submit_specialists()`에서 step을 "specialists"로 안 바꿈. 폴러(60초마다 확인하는 프로그램)가 "delegation" 단계를 처리하는 코드가 없어서 체인이 영원히 대기 | step 전환 코드 추가 + delegation 안전망 핸들러 추가 |
| 2 | step_labels에 delegation 빠져있음 | 4단계 체인인데 step_labels가 3단계만 표시 | "2단계: 처장 지시서" 추가, 번호 재배정 |
| 3 | 배치 시 에이전트 초록불 안 뜸 | 배치 체인은 `_broadcast_status()` 호출 안 함 | 처장 지시서 작성, 전문가 배치 처리, 종합보고서 단계마다 초록불 ON/OFF |
| 4 | 배치 중 대화 불가능 | 웹소켓이 `_start_batch_chain()`을 `await`로 기다려서 대화창이 잠김 | 배치를 `asyncio.create_task()`로 백그라운드 실행. 즉시 "접수 완료" 응답 후 대화 가능 |
| 5 | 텔레그램 배치 실행 안 됨 | 텔레그램 배치 모드에서 "접수만 완료"로 끝남. `_start_batch_chain()` 호출 안 함 | 배치 모드 + AI 연결 시 실제 배치 체인 실행 (백그라운드) |
| 6 | 텔레그램에 배치 결과 안 감 | `_deliver_chain_result()`가 웹소켓에만 전달 | `_send_batch_result_to_telegram()` 함수 추가, 텔레그램에도 결과 전달 |
| 7 | 텔레그램에 진행 상태 안 감 | `_broadcast_chain_status()`가 웹소켓에만 전달 | 텔레그램에도 "📦 1단계: 분류", "📦 2단계: 처장 지시서" 등 진행 알림 |

### 변경된 배치 체인 흐름

**변경 전** (문제):
```
CEO 명령 → 분류 → step="delegation" → 지시서 생성 → 전문가 배치 제출
  → step이 "delegation"인 채로 남아있음 ← 여기서 멈춤!
  → 폴러가 "delegation" 처리 코드 없음
  → 체인 영원히 대기
```

**변경 후** (정상):
```
CEO 명령 → 분류 → step="delegation" → 지시서 생성 → 전문가 배치 제출
  → step="specialists"로 변경 ← 이제 정상!
  → 폴러가 specialists 배치 상태 확인
  → 종합보고서 → 결과 전달 (웹 + 텔레그램)
```

### 배치 백그라운드화 (대화 차단 해결)

**변경 전**:
```
CEO: "시장 분석해줘" (배치)
  → "에이전트 작업중..." (대화창 잠김)
  → 배치 완료까지 다른 대화 불가능
```

**변경 후**:
```
CEO: "시장 분석해줘" (배치)
  → "📦 배치 접수 완료! 백그라운드에서 실행 중. 대화를 계속하실 수 있습니다."
  → 대화창 바로 풀림 → 다른 질문 가능
  → 배치 완료 시 자동으로 결과 알림
```

## 현재 상태
7가지 수정 모두 완료. 커밋 + 푸시 대기 중.

## 다음에 할 일
- 서버 배포 후 배치 명령 테스트
- 텔레그램에서 배치 모드 테스트
- 배치 중 실시간 대화가 되는지 확인
- 에이전트 초록불이 배치 시에도 켜지는지 확인
