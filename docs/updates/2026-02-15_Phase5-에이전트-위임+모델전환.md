# Phase 5: 에이전트 위임 시스템 + 모델 자동/수동 전환

## 버전
0.09.000

## 작업 날짜
2026-02-15

## 작업 브랜치
claude/phase5-model-routing-delegation

---

## 변경 사항 요약

### 기능 1: 에이전트 위임 시스템 (Phase 5)

이전까지는 모든 메시지를 "비서실장" 한 명이 혼자 처리했습니다.
이제부터는 **CEO의 명령을 자동으로 분류**하여 적합한 부서에 배분합니다.

**작동 방식 (하이브리드 분류)**:
1. **키워드 매칭** (무료, 즉시): "주식 분석" → CIO, "홈페이지 수정" → CTO
2. **AI 분류** (Haiku 모델, 건당 ~$0.001): 키워드로 못 잡으면 AI가 분류
3. **폴백**: 둘 다 실패하면 비서실장이 직접 처리

**6개 부서**:
| 부서 | 담당 분야 | 키워드 예시 |
|------|-----------|------------|
| CTO (기술개발처장) | 코드, 서버, 웹사이트, API | "버그 수정해줘", "홈페이지 디자인" |
| CSO (사업기획처장) | 시장조사, 사업계획, 매출 | "경쟁사 분석", "사업계획서" |
| CLO (법무IP처장) | 저작권, 특허, 계약, 법률 | "상표 등록해야 하는데", "약관 검토" |
| CMO (마케팅고객처장) | 마케팅, 광고, SNS, 콘텐츠 | "인스타 광고 전략", "브랜딩" |
| CIO (투자분석처장) | 주식, 투자, 종목, 시황 | "삼성전자 분석", "포트폴리오" |
| CPO (출판기록처장) | 회사기록, 블로그, 출판 | "빌딩로그 작성", "연대기" |

**응답에 담당자 표시**:
- 웹: 결과 카드 상단에 "CTO (기술개발처장)" + 사용 모델명 표시
- 텔레그램: "👤 CTO (기술개발처장) | 💰 $0.0012 | 🤖 sonnet"

### 기능 2: 모델 자동/수동 전환

CEO가 AI 모델을 직접 선택할 수 있게 되었습니다.

- **자동 모드 (기본)**: 짧은 질문 → Haiku(저비용), 복잡한 질문 → Sonnet(고품질)
- **수동 모드**: CEO가 선택한 하나의 모델을 **모든 에이전트에 일괄 적용**
  - Claude Haiku (저비용)
  - Claude Sonnet (균형)
  - Claude Opus (최고 성능)

**설정 위치**: 웹 대시보드 → CEO 사무실 → 설정 탭 → "AI 모델 모드" 섹션

---

## 수정한 파일

| 파일 | 설명 |
|------|------|
| `web/ai_handler.py` | AI 호출 모듈 — `classify_task()` 함수 추가 (AI 기반 업무 분류), `select_model()` 에 수동 모드 오버라이드 기능 추가 |
| `web/arm_server.py` | 미니 서버 — 키워드 라우팅 테이블, `_route_task()` 하이브리드 분류, `_load_agent_prompt()` 에이전트별 소울 로드, `_get_model_override()` 수동 모드 처리, `_process_ai_command()` 전면 개편, `GET/PUT /api/model-mode` API 추가, 텔레그램/웹소켓 응답에 담당자 표시 |
| `web/templates/index.html` | 웹 대시보드 — 모델 자동/수동 토글 UI 추가, 결과 카드에 담당자 이름 + 모델명 표시 |
| `docs/project-status.md` | 프로젝트 현재 상태 — 버전 0.09.000으로 업데이트, Phase 5 완료 기록 |

---

## 기술 상세 (개발자 참고용)

- **에이전트 소울 로드 우선순위**: DB 오버라이드 > `souls/*.md` 파일 > `agents.yaml`의 system_prompt > 기본 프롬프트
- **모델 모드 설정**: SQLite settings 테이블에 `model_mode` (auto/manual) + `model_override` (모델명) 저장
- **비용 추적**: 라우팅 비용(AI 분류 시) + AI 호출 비용을 합산하여 총 비용으로 DB에 기록
- **tasks 테이블**: `agent_id` 컬럼에 실제 처리한 에이전트 ID 기록

---

## 현재 상태

- **에이전트 위임**: 구현 완료, 배포 필요
- **모델 전환**: 구현 완료, 배포 필요

---

## 검증 체크리스트 (배포 후)

1. 자동 모드에서 짧은 질문 → Haiku로 처리되는지
2. 수동 모드로 전환 + Opus 선택 → 모든 질문이 Opus로 처리되는지
3. "삼성전자 분석해줘" → CIO가 답변하는지
4. "홈페이지 수정해" → CTO가 답변하는지
5. "마케팅 전략 짜줘" → CMO가 답변하는지
6. 텔레그램/웹 모두에서 담당자 이름이 표시되는지
