# 배치(Batch) 시스템 전수검사 — 3가지 버그 수정

## 버전
3.01.001

## 작업 날짜
2026-02-18

## 작업 브랜치
claude/autonomous-system-v3

---

## 작업 내용 요약

CORTHEX HQ의 배치(Batch) 시스템 — AI에게 여러 요청을 한꺼번에 보내서 비용을 50% 아끼는 기능 — 을 전수검사하고 3가지 버그를 발견하여 수정했습니다.

---

## 발견된 버그 목록

### 버그 1: OpenAI 배치 파일 업로드 형식 오류 (치명적)

| 항목 | 내용 |
|------|------|
| 파일 | `web/ai_handler.py` (1010~1012번 줄) |
| 증상 | OpenAI Batch API로 요청을 보낼 때 업로드가 실패함 |
| 원인 | OpenAI SDK(소프트웨어 개발 도구)에 파일을 올릴 때 파일 이름 없이 내용(bytes)만 넣으면 SDK가 어떤 종류의 파일인지 인식 못함 |
| 수정 전 | `file=jsonl_content.encode("utf-8")` — 내용만 전달 (파일명 없음) |
| 수정 후 | `file=("batch.jsonl", jsonl_content.encode("utf-8"))` — 파일명과 내용을 함께 전달 |

### 버그 2: 메모리 정리 함수 deprecated API 사용 (경미)

| 항목 | 내용 |
|------|------|
| 파일 | `web/ai_handler.py` (1339번 줄) |
| 증상 | Python 3.10+ 환경에서 경고 메시지가 뜰 수 있음 (당장 고장나지는 않음) |
| 원인 | `asyncio.get_event_loop()` — 이 함수는 Python의 최신 버전에서 "곧 없어질 예정"으로 표시된 함수임 |
| 수정 전 | `asyncio.get_event_loop().call_later(...)` |
| 수정 후 | `asyncio.get_running_loop().call_later(...)` — 현재 실행 중인 루프를 직접 가져오는 최신 방식 |

### 버그 3: 배치 대기열 플러시(즉시 제출) 함수의 프로바이더 라우팅 오류 (중간)

| 항목 | 내용 |
|------|------|
| 파일 | `web/mini_server.py` (1363~1417번 줄) |
| 증상 | 대기열에 Claude 요청과 GPT 요청이 섞여 있으면, Claude 전용 API로만 전부 보내져서 GPT 요청이 실패 |
| 원인 | `batch_submit()` 함수는 단일 프로바이더(Claude 또는 GPT 또는 Gemini 하나만)로만 보낼 수 있는데, 대기열 플러시는 여러 종류가 섞인 상황에서도 이 함수를 사용하고 있었음 |
| 수정 전 | `result = await batch_submit(queue_copy)` — 단일 프로바이더로 전체 전송 |
| 수정 후 | `batch_results = await batch_submit_grouped(queue_copy)` — 프로바이더별로 자동 분리해서 각각 전송 |
| 추가 개선 | 실패한 배치만 골라서 로그를 남기고, 성공한 배치는 각각 DB에 따로 저장하도록 처리 |

---

## 수정된 파일

| 파일 | 역할 | 수정 내용 |
|------|------|----------|
| `web/ai_handler.py` | AI 호출을 담당하는 엔진 | OpenAI 파일 업로드 형식 수정, deprecated API 교체 |
| `web/mini_server.py` | 웹 서버 전체 관리 | 대기열 플러시 로직 전면 개선 |

---

## 검사 결과 — 정상 작동 확인 항목

| 항목 | 상태 |
|------|------|
| Anthropic 배치 제출 (`_batch_submit_anthropic`) | 정상 — 코드 이상 없음 |
| Anthropic 배치 상태 확인 (`_batch_check_anthropic`) | 정상 |
| Anthropic 배치 결과 수집 (`_batch_retrieve_anthropic`) | 정상 — `async for result in ...` 패턴 올바름 |
| OpenAI 배치 제출 (`_batch_submit_openai`) | 수정 완료 |
| OpenAI 배치 결과 파싱 | 정상 — `response.body.choices[0].message.content` 구조 올바름 |
| Gemini 배치 제출 (`_batch_submit_google`) | 정상 |
| Gemini 배치 결과 파싱 | 정상 — 인라인/파일 기반 두 방식 모두 처리 |
| 배치 폴러(60초마다 자동 확인) | 정상 — 무한 루프 방지 로직 있음 |
| 배치 체인 (분류→전문가→종합보고서 4단계) | 정상 — 각 단계 에러 폴백 처리 있음 |
| 배치 결과 DB 저장 | 정상 |
| WebSocket 완료 알림 | 정상 |
| 텔레그램 최종 결과 전달 | 정상 |
| 아카이브 저장 | 정상 |

---

## 현재 상태

수정 완료. 3가지 버그 수정 후 배치 시스템 전체 흐름에 이상 없음.

## 다음에 할 일

없음 (이번 세션 작업 완료)
