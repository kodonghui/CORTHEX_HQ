# AI 모델 전면 반영 + 시스템 전수검사 + 버그 수정

## 버전
3.01.000

## 작업 날짜
2026-02-18

## 작업 브랜치
claude/autonomous-system-v3

---

## 변경 사항 요약

### 1. AI 모델명 전면 교체 (60+곳)

이전 세션에서 `agents.yaml`(에이전트 설정 파일)만 새 모델로 바꿨는데, 실제 서버 코드 3곳에 **옛날 모델명이 하드코딩**되어 있어서 화면에 반영이 안 되는 문제가 있었습니다.

| 파일 | 수정 개수 | 내용 |
|------|----------|------|
| `web/mini_server.py` (백엔드 서버) | 40+곳 | AGENTS 리스트 29명 + 모델 드롭다운 + 텔레그램 모델 + 배치 분류 모델 등 |
| `web/ai_handler.py` (AI 통신 모듈) | 12+곳 | 기본 모델 + 폴백 모델 + 가격표 + 배치 기본값 |
| `web/templates/index.html` (화면) | 6곳 | 모델 표시명 + 추론 레벨 매핑 + 기본값 |

### 2. 추론 레벨(reasoning_effort) 29명 전체 설정

각 에이전트마다 "얼마나 깊이 생각할지" 레벨을 설정했습니다:

| 레벨 | 에이전트 | 설명 |
|------|---------|------|
| xhigh | CIO(투자분석처장) | GPT-5.2 Pro — 돈 걸린 투자 판단 |
| high | 비서실장, CTO, CSO, CLO, CMO, CPO, 투자분석팀, Gemini 에이전트 3명 | 처장급 + 중요 분석 + Gemini(구글 크레딧 남아돌아서 최고로) |
| medium | 보좌관 3명, 일반 Specialist 14명 | 일상적 업무 처리 |

### 3. max_tokens 제한 제거

- `config/models.yaml`: 모든 모델에서 `max_tokens` 설정 삭제
- `web/ai_handler.py`: 4096 → 16384로 4배 증가 (AI 답변이 중간에 잘리는 문제 해결)

### 4. 기밀문서 "전체 삭제" 기능 추가

- `web/db.py`: `delete_all_archives()` 함수 추가
- `web/mini_server.py`: `DELETE /api/archive/all` API 추가
- `web/templates/index.html`: 기밀문서 탭에 "전체 삭제" 버튼 + 확인 모달("정말 전체 삭제하시겠습니까?")

### 5. 통신국(SNS) 연결 상태 수정

- 이전: 모든 플랫폼이 무조건 "미연결"로 표시 (하드코딩)
- 이후: 환경변수에서 API 키 유무를 확인해서 연결 상태 판단
- 스레드(Threads), 링크드인(LinkedIn) 삭제 → 5개 플랫폼만: 인스타그램, X, 유튜브, 틱톡, 페이스북

### 6. 누적비용 $0 문제 수정

- 이전: 대시보드 월간 비용이 "오늘 비용"만 보여줌
- 이후: `db.py`에 `get_monthly_cost()` 함수 추가 → 이번 달 전체 비용 정확하게 합산

### 7. 치명적 버그 수정 3건

| 버그 | 위치 | 수정 내용 |
|------|------|---------|
| async for await 이중사용 | ai_handler.py 줄 951 | `await` 제거 → 배치 결과 조회 정상화 |
| create_task() agent_id 누락 | db.py | `agent_id` 파라미터 추가 → 배치 API 오류 해결 |
| gpt-4.1-mini 존재하지 않는 모델 | ai_handler.py | `gpt-5-mini`로 교체 |

### 8. CLAUDE.md에 하드코딩 금지 규칙 추가

CEO 지시로 "모델명/설정값 하드코딩 절대 금지" 규칙과 모델 변경 시 체크리스트를 CLAUDE.md에 추가했습니다.

### 9. 기타 수정

- `config/quality_rules.yaml`: 품질검수 모델 `gpt-4o-mini` → `claude-haiku-4-5-20251001`
- `.env.example`: 구버전 모델명 업데이트
- `config/agents.json`: YAML에서 재생성 (최신 모델명 + 추론 레벨 반영)
- VS Code 설정: `claudeCode.selectedModel` → `"sonnet"` (= Sonnet 4.6)

---

## 수정한 파일 목록 (12개)

| # | 파일 | 설명 |
|---|------|------|
| 1 | `web/mini_server.py` | 백엔드 서버 — 모델 40+곳 교체 + SNS + 기밀문서 API + 월간비용 |
| 2 | `web/ai_handler.py` | AI 통신 모듈 — 모델 12+곳 교체 + max_tokens + 버그수정 |
| 3 | `web/db.py` | DB 모듈 — 함수 3개 추가 |
| 4 | `web/templates/index.html` | 화면 — 모델명 6곳 + 전체삭제 버튼 |
| 5 | `config/agents.yaml` | 에이전트 설정 — 추론 레벨 29개 추가 |
| 6 | `config/agents.json` | 에이전트 설정 JSON — YAML에서 재생성 |
| 7 | `config/models.yaml` | 모델 설정 — max_tokens 전부 제거 |
| 8 | `config/quality_rules.yaml` | 품질검수 설정 — 검수 모델 변경 |
| 9 | `config/quality_rules.json` | 품질검수 JSON — YAML에서 재생성 |
| 10 | `CLAUDE.md` | 프로젝트 규칙 — 하드코딩 금지 규칙 추가 |
| 11 | `.env.example` | 환경변수 예시 — 모델명 업데이트 |
| 12 | `knowledge/shared/company_rules.md` | 회사 규칙 — 모델명 업데이트 |

---

## 현재 상태
- 커밋 완료 → 자동 배포 대기 중
- 배포 후 https://corthex-hq.com 에서 확인 필요

## 다음에 할 일
- bulk API 중복 정의 (줄 922, 966) 정리 — 기능에는 영향 없음
- WebSocket disconnect 방어 코드 추가 — 안정성 개선
