# 빌드 #168 피드백 7가지 이슈 수정

## 버전
1.00.004

## 작업 날짜
2026-02-17

## 작업 브랜치
claude/fix-multi-provider-ai-chat

## 빌드 번호
#171

---

## 변경 사항 요약

CEO가 빌드 #168 배포 후 발견한 7가지 이슈를 전부 수정했습니다.

### 수정한 이슈 목록

| # | 이슈 | 수정 내용 | 수정 파일 |
|---|------|----------|----------|
| 1 | 비용이 $0.0000으로 표시됨 | 웹 접속하자마자 오늘 비용을 보내줌 + 대시보드에서 "오늘 비용"과 "누적 비용" 구분 표시 | arm_server.py, index.html |
| 2 | 노션에 아무것도 저장 안됨 | deploy.yml 확인 완료 — API키 전달 코드 정상, 다음 배포부터 적용됨 | (코드 변경 없음) |
| 3 | /api/notion-log 어디서 확인? | 대시보드에 "노션 연동" 상태 카드 추가 (연결됨/미연결 표시) | index.html |
| 4 | GPT-5.2, GPT-5.2 Pro 모델 추가 | 텔레그램 /models 명령에 4개 모델: 5 Mini < 5 < 5.2 < 5.2 Pro | arm_server.py |
| 5 | 텔레그램 모델 변경이 웹에 안 반영됨 | 텔레그램↔웹 같은 DB 키(model_override) 사용하도록 통일 | arm_server.py |
| 6 | 비서실장이 2~4번 중복 응답 | 백엔드: 체인 즉시 completed 처리 + 프론트: 같은 task_id 중복 체크 | arm_server.py, index.html |
| 7 | GitHub 브랜치 17개, PR 5개 쌓임 | PR 5개 닫기 + 브랜치 14개 삭제 완료 (main만 남김) | (GitHub 정리) |

### 수정한 파일

| 파일 | 설명 | 변경 내용 |
|------|------|----------|
| `web/arm_server.py` (백엔드 서버) | 7개 수정 | WebSocket 비용 전송, 대시보드 API 오늘비용/노션상태 추가, GPT-5.2 모델 추가, 모델 동기화 키 통일, 체인 중복 전달 방지 |
| `web/templates/index.html` (프론트엔드 화면) | 3개 수정 | 비용 오늘/누적 구분, 노션 연동 카드, 중복 result 메시지 무시 |

---

## 기술 상세

### 이슈1: 비용 $0.0000 문제
- **원인**: 웹 접속 시 비용이 0으로 시작하고, AI가 작업할 때만 WebSocket으로 비용을 업데이트함. 페이지만 열면 항상 $0.0000
- **해결**: WebSocket 연결 직후 서버가 `get_today_cost()`로 오늘 비용을 즉시 보내줌
- **추가**: 대시보드 비용 카드를 "오늘 비용" (크게 표시) + "누적: $XX.XX" (작게 표시)로 구분

### 이슈5: 모델 동기화
- **원인**: 텔레그램은 `global_model_override` 키, 웹은 `model_override` 키 → 서로 다른 저장소
- **해결**: 텔레그램에서 모델 변경 시 `model_override` + `model_mode` 키도 함께 저장 → 웹과 동기화

### 이슈6: 중복 응답
- **원인(백엔드)**: 배치 체인 결과 전달 함수가 WebSocket 전송 완료 전까지 `completed` 상태를 안 바꿈 → 폴러(주기적 확인기)가 재진입해서 여러 번 전달
- **해결(백엔드)**: 결과 전달 시작 즉시 `completed` 상태로 변경 (WebSocket 전송 전)
- **해결(프론트)**: 같은 task_id + content가 이미 messages 배열에 있으면 무시

---

## 현재 상태
- 빌드 #171 배포 완료
- 7가지 이슈 전부 수정 완료

## 다음에 할 일
- CEO가 서버에서 7가지 수정 사항 확인
- 노션 연동 실제 동작 확인 (API키 적용 후)
