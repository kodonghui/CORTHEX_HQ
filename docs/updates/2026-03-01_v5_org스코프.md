# v5 org 스코프 구현 완료 (빌드 #750~#752)

> 날짜: 2026-03-01
> PR: #724, #726, #727
> 빌드: #750 (에이전트 리네임), #751 (DB 마이그레이션), #752 (org 스코프 + saju 소울)

---

## 배경

v5 목표: 대표님(CEO) + 누나(sister) 이중 계정 운영 구조.
누나는 사주냥 서비스 전담 — 사주 에이전트만 접근, 사주 데이터만 조회.
탭 숨김이 아닌 **데이터 스코프** 방식 (ADR-7).

---

## 빌드 #750 — 에이전트 리네임 + CLI 라우팅 보호 (PR #724)

### 변경 파일
- `agents.yaml` — saju_executive, saju_eden, saju_zoe, saju_sage 추가 (`cli_owner: sister`)
- `web/agent_router.py` — `_can_command()` 신설, `_process_ai_command()` session_role 체인
- `web/arm_server.py` — WebSocket → `session_role` 추출 → `_run_agent_bg()` 전달
- `web/batch_system.py` — 전면 삭제 (글로벌 배치 시스템 제거)
- `web/scheduler.py`, `web/telegram_bot.py` — batch_system 참조 제거

### 핵심 로직

```python
def _can_command(session_role: str, agent_id: str) -> bool:
    """sister → saju_ 에이전트만, CEO → 전체 접근"""
    if agent_id == "chief_of_staff":
        return session_role == "ceo"
    detail = _AGENTS_DETAIL.get(agent_id, {})
    cli_owner = detail.get("cli_owner", "ceo")
    return session_role == cli_owner
```

@멘션 라우팅 (FR-11):
```python
_AGENT_DISPLAY_NAME_TO_ID = {
    detail.get("name", "").lower(): agent_id
    for agent_id, detail in _AGENTS_DETAIL.items() if detail.get("name")
}
# @Eden → saju_eden, @Zoe → saju_zoe, @Sage → saju_sage
```

---

## 빌드 #751 — DB 마이그레이션 (PR #726)

### 변경 파일
- `scripts/migrate_v5.py` — 신규 생성 (멱등, --dry-run 지원)
- `.github/workflows/deploy.yml` — 서버 재시작 전 자동 실행 추가

### 마이그레이션 내용
1. DB 백업 (`corthex_v5_backup_YYYYMMDD.db`)
2. 프로토타입 데이터 삭제 (conversations 5행, activity_logs 2922행)
3. org 컬럼 추가: conversations, reports, archives, activity_logs
4. sns_accounts 테이블 생성 + saju Instagram 플레이스홀더

---

## 빌드 #752 — org 스코프 + saju 소울 (PR #727)

### FR-5: 채팅 세션 org 필터링
- `db.py`: `create_conversation(org=)` + `list_conversations(org=)` 필터
- `conversation_handler.py`: POST body `org` 수신, GET `?org=` 파라미터

### FR-6: 기밀문서 org 필터링
- `archive_handler.py`: `GET /api/archive?org=saju` → `division.startswith(org)` 필터

### FR-9: SNS 계정 org 스코프
- `sns_handler.py`: `GET /api/sns/accounts?org=` 신규 엔드포인트
- sns_accounts 테이블 쿼리, org 필터링

### FR-10: 활동 로그 org 스코프
- `activity_handler.py`: `GET /api/activity-logs?org=` → `agent_id.startswith(org)` 필터

### JS (corthex-app.js)
- sister 로그인 감지 후 모든 API 호출에 `?org=saju` 자동 추가
- `loadConversationList()`, `startNewConversation()`, `loadArchive()`, `restoreActivityLogs()`
- @멘션 드롭다운: sister → saju_ 에이전트만 표시

### saju 소울 파일 3종
- `souls/agents/saju_eden.md` — Eden: 마케팅·사업기획 전략가
- `souls/agents/saju_zoe.md` — Zoe: 콘텐츠·SNS 커뮤니케이션
- `souls/agents/saju_sage.md` — Sage: 서비스기획·UX·리서치

---

## 실서버 검증

```
GET /api/conversation/sessions?limit=5&org=saju → [] ✅ (정상, 사주 세션 없음)
GET /api/sns/accounts?org=saju → [{id:1, org:saju, platform:instagram}] ✅
```

---

## 아키텍처 결정 (ADR-7 확정)

| 방식 | 설명 | 선택 |
|------|------|------|
| 탭 숨김 | sister 로그인 시 대표님 탭 숨김 | ❌ 보안 취약 |
| 데이터 스코프 | API 레벨에서 org 필터, 서버가 걸러줌 | ✅ 채택 |

---

## 다음 단계

- 누나 실제 합류 시 `CLAUDE_API_KEY_SISTER` GitHub Secrets 등록
- saju 에이전트 CLI 세션 테스트 (sister 로그인 → @Eden 호출)
- Phase 3 대개편 (채팅버블 리디자인, 홈 대시보드)
