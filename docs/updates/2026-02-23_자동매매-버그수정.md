# 자동매매 6건 버그 수정 — 2026-02-23

## 기본 정보
- **날짜**: 2026-02-23
- **버전**: 3.02.025
- **브랜치**: claude/sonnet-qa-fix
- **빌드**: #508
- **PR**: #518 (머지), #519 (머지)

## 변경 사항

### 🔧 수정한 것

| # | 파일 | 수정 내용 |
|---|------|----------|
| 1 | `config/agents.yaml` | **전문가 4명 모델 Sonnet 전환** — 시장분석/종목분석/기술분석/리스크관리 전문가를 GPT/Gemini → Claude Sonnet 4.6으로 변경. CIO는 GPT-5.2 Pro 유지 |
| 2 | `config/quality_rules.yaml` | **Q1 데이터정확성 critical 해제** — critical=true일 때 1점 받으면 전체 2점 캡. 도구로 가져온 데이터도 "확인 불가"로 1점 줘서 보고서 점수가 1.4~2.0밖에 안 나옴 → critical=false로 변경 |
| 3 | `src/core/quality_gate.py` | **QA 도구 데이터 신뢰 규칙 추가** — "도구(DART/KRX 등)로 가져온 수치는 정확한 것으로 간주하라"는 지시를 QA 검수관 프롬프트에 추가 |
| 4 | `web/ai_handler.py` | **OpenAI 스키마 재귀 수정** — GPT에 도구 넘길 때 서류 양식(스키마) 검증이 바깥만 하고 안쪽 안 함 → 재귀적으로 전부 처리 |
| 5 | `src/tools/ecos_macro.py` | **ECOS 분기 데이터 버그** — 2026Q1~Q4 미래 데이터 요청 → 마지막 완료 분기까지만 요청 |
| 6 | `web/kis_client.py` | **KIS 국내주식 거래소코드 누락** — EXCG_ID_DVSN_CD="" → "01"(한국거래소). 국내 주문 실패 원인 |
| 7 | `web/arm_server.py` | **CIO 독자분석에 도구 전달** — CIO가 38개 도구 가지고 있는데 분석 시 도구 안 넘겨줘서 맨눈으로 판단 → 도구 로드+전달 |

### 🐛 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| 보고서 점수 1.4~2.0 | Q1 critical + 도구 데이터 불인정 | ✅ 수정 |
| GPT 도구 스키마 400 에러 | nested object에 additionalProperties 누락 | ✅ 수정 |
| ECOS 빈 데이터 반환 | 미래 분기(2026Q1~Q4) 요청 | ✅ 수정 |
| 국내주식 주문 실패 | EXCG_ID_DVSN_CD 빈값 | ✅ 수정 |
| CIO 도구 미사용 | ask_ai()에 tools 파라미터 안 넘김 | ✅ 수정 |
| KIS EXCG_ID_DVSN_CD="01" 검증 필요 | 공식 문서에서 값 미확인 | ⚠️ 실주문 테스트 필요 |

### 📊 현재 상태
- 자동매매: 전문가 4명 Sonnet, CIO GPT-5.2 Pro
- QA 검수: 도구 데이터 신뢰 규칙 추가, Q1 critical 해제
- CIO 독자분석: 38개 도구 사용 가능

### 📋 다음에 할 일
- KIS EXCG_ID_DVSN_CD="01" 실주문 테스트 (장 열릴 때)
- 전문가 Sonnet 분석 결과 확인 (속도/품질 비교)
- 노션 DB 속성명 불일치 수정 (비긴급)
