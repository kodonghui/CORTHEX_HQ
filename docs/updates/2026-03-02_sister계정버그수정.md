# 2026-03-02 — sister(누나) 계정 4가지 버그 수정 + 로그아웃 버튼 수정

> PR #728 → 빌드 #759 배포 완료
> PR #729 → 빌드 #760 배포 완료 (로그아웃 버튼 수정)

## 근본 원인

로그인 토큰에 `org` 정보가 없었음 → 백엔드가 누나 요청인지 CEO 요청인지 식별 불가 → 데이터 격리 불가

## 수정 내용 (6파일)

### 문제 1: saju 에이전트 안 보임 (사이드바 "준비중")
- **원인**: `index.html`에서 사주 본부 섹션이 "에이전트 준비중" 하드코딩
- **수정**: 실제 4명 렌더링 (`saju_executive/eden/zoe/sage`)
- 누나에게 `saju_executive`(CEO 직속)는 숨김

### 문제 2: 대화 세션이 CEO와 공유됨
- **원인**: `conversation_handler.py`에 인증 기반 org 필터 없음
- **수정**: `get_auth_org(request)` → 인증 org 자동 적용 (프론트 파라미터 우회 방지)

### 문제 3: 작전일지(activity-logs) 공유됨
- **원인**: `activity_handler.py`에 인증 기반 org 필터 없음
- **수정**: `get_auth_org(request)` → 인증 org 자동 적용

### 문제 4: 비서실장이 누나 화면에 표시됨
- **원인**: `index.html` 비서실장 섹션에 `x-show` 조건 없음
- **수정**: `x-show="auth.role !== 'sister'"` 추가

### 추가: 기밀문서(archive) 격리
- `archive_handler.py`에도 `get_auth_org()` 적용

### 인프라 수정

| 파일 | 변경 |
|------|------|
| `auth_handler.py` | `_extract_token()` 통합 (header→query→쿠키), 세션에 org 저장, `get_auth_org()` API |
| `corthex-app.js` | 쿠키 토큰 저장/삭제 (로그인/로그아웃/복원), `auth.org` 상태 |

## 기술 설명

**쿠키 기반 토큰 자동 전송 방식 도입**
- 기존: 프론트에서 명시적으로 `Authorization` 헤더 보내는 경우에만 인증 가능
- 변경: 로그인 시 `document.cookie`에 토큰 저장 → 모든 fetch에 쿠키 자동 전송
- 백엔드: `_extract_token()`이 헤더 → 쿼리 → 쿠키 순으로 토큰 추출
- 장점: 기존 fetch 호출 수정 없이 모든 API에 인증 org 자동 적용

## PR #729 — 로그아웃 버튼 표시 수정

**문제**: 배포 후 서버 재시작 → 메모리 세션 초기화 → `bootstrapMode=true` → 로그인 성공해도 `bootstrapMode` 안 바뀜 → 로그아웃 버튼 조건 `!auth.bootstrapMode` 실패

**수정**: `corthex-app.js` 로그인 성공 시 `this.auth.bootstrapMode = false;` 추가

## 검증
- 빌드 #759: 서버 로그 에러 없음, 헬스체크 정상
- 빌드 #760: 로그아웃 버튼 정상 표시 확인 (대표님 스크린샷)
