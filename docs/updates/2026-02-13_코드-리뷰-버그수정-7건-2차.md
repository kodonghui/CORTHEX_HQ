# 코드 전면 리뷰 + 버그 7건 수정 (2차)

## 작업 날짜
2026-02-13

## 작업 브랜치
claude/code-review-bugs-bX6Vt

---

## 변경 사항 요약

전체 코드(약 100개 파일)를 처음부터 끝까지 읽으면서 **버그 7건**을 발견하고 수정했습니다.

---

### 버그 #1: gpt-4o-mini 비용이 $0으로 기록되던 문제

| 항목 | 내용 |
|------|------|
| **파일** | `src/llm/openai_provider.py` (OpenAI AI 호출을 담당하는 파일) |
| **문제** | 품질검수(보고서 검토)와 에이전트 학습에서 쓰는 `gpt-4o-mini` 모델의 가격이 빠져 있었음 |
| **결과** | 이 모델을 쓸 때마다 비용이 $0으로 기록되어, 대시보드의 비용 통계가 실제보다 낮게 나옴 |
| **수정** | `gpt-4o`와 `gpt-4o-mini` 가격표를 추가함 |

---

### 버그 #2: 지식 파일(knowledge) 보안 취약점

| 항목 | 내용 |
|------|------|
| **파일** | `src/core/knowledge.py` (에이전트 지식 파일 관리) |
| **문제** | 파일을 읽거나 저장할 때 `../../../etc/passwd` 같은 경로로 시스템 파일에 접근 가능 |
| **위험** | 외부에서 웹 API로 요청을 보내면, knowledge 폴더 바깥의 아무 파일이나 읽기/쓰기/삭제 가능 |
| **수정** | `_is_safe_path()` 검증 함수를 추가하여, knowledge 폴더 바깥으로 벗어나는 경로를 모두 차단 |

---

### 버그 #3: 보고서 보관소(archive) 보안 취약점

| 항목 | 내용 |
|------|------|
| **파일** | `web/app.py` (웹 서버) |
| **문제** | 보관소 파일을 읽을 때도 마찬가지로 경로 탈출이 가능했음 |
| **수정** | archive 폴더 바깥 경로 접근을 차단하는 검증 코드 추가 |

---

### 버그 #4: 스케줄러(예약 작업) 깨지기 쉬운 코드

| 항목 | 내용 |
|------|------|
| **파일** | `src/core/scheduler.py` (작업 예약 엔진) |
| **문제** | `TaskStatus`(작업 상태값)를 불러올 때 `__import__()`라는 비정상적인 방법을 사용 |
| **위험** | Python 버전이나 구조가 조금만 바뀌어도 바로 에러 발생 가능 |
| **수정** | 파일 상단에서 정상적으로 `from src.core.task_store import TaskStatus`로 교체. 함수 내부의 `import time`도 파일 상단으로 이동 |

---

### 버그 #5: 활동 로그 시간이 UTC로 표시

| 항목 | 내용 |
|------|------|
| **파일** | `web/ws_manager.py` (실시간 웹소켓 관리) |
| **문제** | 에이전트 활동 로그와 에러 알림의 시간이 `datetime.now()` (서버 시간, 보통 UTC)으로 표시됨 |
| **결과** | 한국에서 보면 시간이 9시간 뒤로 보임 (예: 오후 3시 → 오전 6시) |
| **수정** | `datetime.now(_KST)` (한국 시간대, UTC+9)로 변경 |

---

### 버그 #6: 사용자명에 콜론(:)이 있으면 로그인 후 모든 기능 실패

| 항목 | 내용 |
|------|------|
| **파일** | `src/core/auth.py` (사용자 인증) |
| **문제** | 인증 토큰(로그인 증명서) 형식이 `user_id:username:role:만료시각:서명`인데, 사용자명에 `:`이 있으면 파싱이 깨짐 |
| **결과** | `test:user`라는 이름으로 가입하면 로그인은 되지만, 이후 모든 API 호출에서 "토큰 오류" 발생 |
| **수정** | 토큰 파싱을 고정 위치(첫 번째=user_id, 마지막=만료시각, 뒤에서 두 번째=role)로 분리하여 중간의 사용자명에 `:`이 있어도 정상 작동 |

---

### 버그 #7: 작업 목록에서 중복 코드

| 항목 | 내용 |
|------|------|
| **파일** | `web/app.py` (웹 서버) |
| **문제** | `_task_to_dict` 함수에서 `correlation_id`를 2번 설정 (한 번은 `if include_result` 안, 한 번은 바깥) |
| **결과** | 안쪽 설정은 바깥쪽에서 항상 덮어씌워져서 의미 없는 코드 |
| **수정** | 중복된 안쪽 설정 제거 |

---

## 수정한 파일 목록

| 파일 | 설명 |
|------|------|
| `src/llm/openai_provider.py` | OpenAI 모델 가격 계산 |
| `src/core/knowledge.py` | 에이전트 지식 파일 관리 |
| `web/app.py` | 웹 서버 메인 파일 |
| `src/core/scheduler.py` | 작업 예약 엔진 |
| `web/ws_manager.py` | 실시간 웹소켓 통신 |
| `src/core/auth.py` | 사용자 인증 |

---

## 현재 상태
- 모든 수정 완료, 커밋 및 푸시 완료
- PR 생성 대기 중

## 다음에 할 일
- main 브랜치에 머지 (PR을 통해)
