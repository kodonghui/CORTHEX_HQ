# 배치 체인 3가지 추가 버그 수정

## 버전
1.05.001

## 작업 날짜
2026-02-17

## 작업 브랜치
claude/fix-multi-provider-ai-chat

---

## 문제 상황

텔레그램에서 `/batch` + "모든 에이전트 출석체크" 테스트 시:
- 처장 지시서 0/6 완료 (6개 부서 모두 실패)
- 전문가 배치 Google API 38개 validation 오류
- 종합 배치 Anthropic `async for` 오류

실시간 폴백이 작동해서 최종 보고서는 나왔지만 ($0.1633), 전문가 응답이 없어서 "전문가 응답 없음"이라는 내용의 보고서만 생성됨.

---

## 발견된 버그 3가지

### 버그 1: 처장 지시서 `max_tokens` TypeError (mini_server.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/mini_server.py` — `_chain_create_delegation_broadcast()` 내부 `_get_delegation()` |
| **문제** | `ask_ai(user_message=prompt, model=deleg_model, max_tokens=2048)` 호출 |
| **원인** | `ask_ai()` 함수에 `max_tokens` 파라미터가 없음 → `TypeError` 발생 |
| **결과** | 6개 처장 모두 except에 걸려 빈 딕셔너리 `{}` 반환 → "처장 지시서 0/6 완료" |
| **수정** | `max_tokens=2048` 파라미터 제거 (내부 기본값 4096이 이미 충분) |

### 버그 2: Google 배치 API 인라인 요청 포맷 오류 (ai_handler.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/ai_handler.py` — `_batch_submit_google()` |
| **문제** | `system_instruction`과 `generation_config`를 `config` 서브딕트 안에 넣음 |
| **원인** | google-genai SDK는 `system_instruction`을 최상위 필드, `generation_config`를 별도 최상위 키로 기대 |
| **결과** | "38 validation errors for BatchJobSource" → 19명 전문가 배치 전부 실패 |
| **수정** | `system_instruction` → 최상위, `config` → `generation_config` 이름 변경 |

### 버그 3: Anthropic 배치 결과 수집 `await` 누락 (ai_handler.py)

| 구분 | 내용 |
|------|------|
| **위치** | `web/ai_handler.py` — `_batch_retrieve_anthropic()` |
| **문제** | `async for result in _anthropic_client.messages.batches.results(batch_id):` |
| **원인** | `results()` 메서드가 코루틴(coroutine)을 반환 → `await` 없이 `async for` 사용 불가 |
| **결과** | "'async for' requires an object with __aiter__ method, got coroutine" 오류 |
| **수정** | `async for result in await _anthropic_client.messages.batches.results(batch_id):` |

---

## 변경된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `web/mini_server.py` | 줄 1738: `max_tokens=2048` 파라미터 제거 |
| `web/ai_handler.py` | Google 배치 포맷 수정 + Anthropic `await` 추가 |
| `docs/project-status.md` | 버전 1.05.001 업데이트 |

---

## 수정 후 기대 결과

| 단계 | 이전 (실패) | 이후 (정상) |
|------|-------------|-------------|
| 처장 지시서 | 0/6 (TypeError) | 6/6 (정상 JSON 파싱) |
| 전문가 배치 | Google 38개 오류 | Google 배치 정상 제출 |
| 종합 배치 | Anthropic async for 오류 | Anthropic 결과 정상 수집 |
| 최종 보고서 | "전문가 응답 없음" | 전문가 분석이 포함된 보고서 |

---

## 확인 방법

텔레그램에서:
1. `/batch` 입력 → 배치 모드 전환
2. "전원 출석체크" 입력 → 배치 체인 시작
3. 확인:
   - **처장 지시서**: "처장 지시서 6/6 완료" 표시
   - **전문가**: Google 배치 오류 없이 정상 제출
   - **종합**: Anthropic 오류 없이 정상 수집
   - **보고서**: 각 부서별 전문가 분석이 포함된 상세 보고서
