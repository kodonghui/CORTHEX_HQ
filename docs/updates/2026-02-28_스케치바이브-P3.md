# 2026-02-28 — SketchVibe Phase 3 (아키텍처 재설계)

## 요약
서버 변환 제거 + MCP 양방향 + SSE 실시간 캔버스 렌더링.
Claude Code가 캔버스를 읽고, 직접 Mermaid로 변환하고, 결과를 브라우저에 실시간 전송.

## 핵심 변경: 서버 → Claude Code 변환 주체 이전

### Phase 2 (이전)
```
캔버스 → 서버 API → Claude API 호출 → Mermaid 반환 → 브라우저 표시
```

### Phase 3 (변경 후)
```
① 캔버스 → "저장하기" → SQLite 저장
② Claude Code에서 read_canvas MCP 도구 호출 → 캔버스 구조 읽기
③ Claude Code가 직접 Mermaid 변환 (별도 API 호출 없음)
④ update_canvas MCP 도구 → REST API → SSE → 브라우저 실시간 렌더링
⑤ request_approval MCP 도구 → 브라우저에 확인 알림
⑥ 대표님 "맞아" → /approve → SSE → Claude Code 코딩 시작
```

## 변경 파일

| 파일 | 변경 | 설명 |
|------|------|------|
| `web/handlers/sketchvibe_handler.py` | 대폭 수정 | 변환 로직 제거, SSE 엔드포인트 4개 추가 |
| `web/mcp_sketchvibe.py` | 도구 2개 추가 | update_canvas + request_approval |
| `web/static/js/corthex-app.js` | 대폭 수정 | SSE 구독, 저장 전환, 팔레트 버그 수정 |
| `web/templates/index.html` | 대폭 수정 | SSE 기반 UI로 전면 교체 |

## 구현 내용

### 1. 서버 (`sketchvibe_handler.py`)
- **제거**: `/convert` 엔드포인트 (Claude API 직접 호출), `_SYSTEM_PROMPT`, `_extract_json()`, `_get_sketchvibe_model()`
- **추가**:
  - `POST /save-canvas` — 캔버스 JSON을 SQLite에 저장
  - `POST /push-event` — MCP가 호출, SSE로 Mermaid 코드 브라우저 전송
  - `POST /request-approval` — MCP가 호출, 확인 요청 알림 전송
  - `POST /approve` — 브라우저 "맞아" 클릭 시 승인 이벤트 발행
  - `GET /stream` — SSE 엔드포인트 (30초 keepalive)
- **보존**: `/canvas`, `/save-diagram`, `/confirmed`, `/confirmed/{name}`, `_parse_drawflow()`, `_gen_html_viewer()`

### 2. MCP 서버 (`mcp_sketchvibe.py`)
- **추가**:
  - `update_canvas(mermaid_code, description)` — Mermaid → 브라우저 실시간 렌더링
  - `request_approval(message)` — 대표님에게 확인 요청 알림
- **보존**: `read_canvas()`, `list_confirmed_diagrams()`, `get_confirmed_diagram()` (기존 3도구 변경 없음)

### 3. 프론트엔드
- **"변환하기 ▶" → "저장하기"**: API 변환 대신 캔버스 JSON 저장
- **SSE 구독**: `_connectSketchVibeSSE()` — `/api/sketchvibe/stream` 연결
  - `canvas_update` → Mermaid 렌더링
  - `approval_request` → 확인 알림 배너
  - `approved` → 알림 해제
- **승인 UI**: 확인 요청 시 "맞아 ✓" / "다시 해줘 ↩" 버튼
- **비용 표시 제거**: `$0.0079` 등 API 비용 표시 코드 삭제

### 4. 버그 수정
- **팔레트 노드 안 보이는 버그**: `initNexusCanvas()`에서 `querySelectorAll('#nexus-canvas')` → 보이는 요소 선택 (동일 ID 두 개 존재 시 대응)
- **노드 겹침**: `addCanvasNode()`의 고정 위치 (200,200) → 랜덤 오프셋으로 변경

## 새 엔드포인트

| 메서드 | 경로 | 용도 |
|--------|------|------|
| POST | `/api/sketchvibe/save-canvas` | 캔버스 JSON SQLite 저장 |
| POST | `/api/sketchvibe/push-event` | MCP→SSE Mermaid 전송 |
| POST | `/api/sketchvibe/request-approval` | MCP→SSE 확인 요청 |
| POST | `/api/sketchvibe/approve` | 브라우저 승인 응답 |
| GET | `/api/sketchvibe/stream` | SSE 실시간 스트림 |
