# Step 13: 멀티턴 대화 기능

- **날짜**: 2026-02-23
- **버전**: 3.02.022
- **브랜치**: claude/step13-multiturn

---

## 변경 요약

에이전트와의 대화를 **세션별로 분리**하여, 이전 대화 맥락을 유지하며 이어서 대화할 수 있는 기능 추가.

| 구분 | 이전 | 이후 |
|------|------|------|
| 대화 구조 | 모든 메시지 1개 덩어리 | 세션별 분리 (conversation_id) |
| 대화 기억 | 최근 10개, 500자 제한 | 최근 20개, 2000자 제한 |
| 세션 관리 | 없음 | 새 대화/대화목록/전환/삭제 |
| 턴 카운터 | 없음 | 실시간 턴 수 표시 |
| 비용 추적 | 없음 | 세션별 누적 비용 |

---

## 수정 파일 (5개)

### 1. `web/db.py` — DB 스키마 + CRUD 6개
- `conversations` 테이블 신규 (conversation_id, title, agent_id, turn_count, summary, total_cost, is_active, timestamps)
- `conversation_messages`에 `conversation_id` 컬럼 추가 (마이그레이션)
- CRUD 함수 6개: create/list/get/update/load_by_id/delete

### 2. `web/handlers/conversation_handler.py` — 세션 API 6개 추가
- POST `/api/conversation/sessions` — 새 세션 생성
- GET `/api/conversation/sessions` — 세션 목록 (최신순)
- GET `/api/conversation/sessions/{id}` — 세션 상세
- PATCH `/api/conversation/sessions/{id}` — 세션 수정
- DELETE `/api/conversation/sessions/{id}` — 세션 삭제
- GET `/api/conversation/sessions/{id}/messages` — 세션별 메시지
- 레거시 엔드포인트 3개 유지 (하위 호환)

### 3. `web/arm_server.py` — 히스토리 로딩 리팩토링
- `_build_conv_history()` 헬퍼 추출 (중복 코드 2곳 → 1곳)
- WS 핸들러: `conversation_id` 수신 + 전달
- `_run_agent_bg`: `conversation_id` 파라미터 + DB 저장 시 포함
- 세션별 비용 누적 (total_cost)
- 히스토리 확장: 10개→20개, 500자→2000자

### 4. `web/static/js/corthex-app.js` — 프론트엔드 상태+메서드
- 상태 4개: currentConversationId, conversationList, showConversationDrawer, conversationTurnCount
- 메서드 4개: newConversation(), loadConversationList(), switchConversation(), deleteConversationSession()
- 기존 수정 4개: sendMessage(자동생성), loadConversation(세션별), clearConversation(아카이브), WS핸들러(conversation_id)
- 3,815줄 → 3,938줄 (+123줄)

### 5. `web/templates/index.html` — UI 추가
- 사령관실 헤더: "대화목록" 토글 + "새 대화" 버튼 + 턴 카운터
- 대화목록 서랍(drawer): 좌측 슬라이드 패널 (제목, 턴수, 날짜, 비용, 삭제)
- 6,141줄 → 6,201줄 (+60줄)

---

## 하위 호환성

- conversation_id는 전부 NULL 허용 → 기존 메시지 그대로 동작
- 레거시 엔드포인트 유지 → 이전 코드/요청 정상 동작
- conversation_id 없이 sendMessage 해도 자동 생성

---

## 검증 포인트

1. 첫 메시지 전송 → 대화 세션 자동 생성
2. 후속 메시지 → 같은 conversation_id, 턴 카운트 증가
3. "새 대화" 클릭 → 메시지 초기화, 새 세션 생성
4. 대화 목록에서 이전 대화 클릭 → 메시지 전환
5. 레거시 메시지(conversation_id=NULL) 정상 표시
