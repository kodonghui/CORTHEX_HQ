# Phase 2~4 일괄 구현: 비서실장 AI + 웹 로그인 + 스마트 라우팅 + 예산 제한

## 버전
0.08.000

## 작업 날짜
2026-02-15

## 작업 브랜치
claude/phase2-4-ai-login-budget

---

## 한 줄 요약
CEO가 텔레그램이나 웹에서 메시지를 보내면, 비서실장 AI(Claude)가 실제로 답변합니다. 웹 로그인도 추가됐고, AI 비용이 하루 $7를 넘지 않도록 자동 제한됩니다.

---

## Phase 2: 비서실장 AI 연결

### 뭐가 바뀌었나?
- **이전**: 메시지를 보내면 "경량 모드 — AI 미연결"이라는 고정 답변만 함
- **이후**: 비서실장 AI(Claude Sonnet)가 실제로 답변함

### 한국어 텔레그램 명령어 추가
| 명령어 | 기능 |
|--------|------|
| `/실시간` | 이후 메시지를 AI가 즉시 처리 (기본값) |
| `/배치` | 이후 메시지를 저장만 하고 나중에 처리 |

### 웹에서도 AI 답변
- 웹 채팅으로 메시지를 보내면 AI가 실시간으로 답변
- 답변에 사용된 모델명과 비용($0.001 등)도 함께 표시

---

## Phase 3: 웹 로그인

### 뭐가 바뀌었나?
- **이전**: 누구나 웹에 접속하면 모든 기능 사용 가능 (보안 없음)
- **이후**: 비밀번호를 입력해야 관리 기능 사용 가능

### 로그인 방식
- 비밀번호만 입력 (사용자명 불필요 — 1인 CEO 시스템)
- **기본 비밀번호**: `corthex2026`
- 비밀번호는 언제든 변경 가능 (DB에 저장)
- 세션 유효 기간: 7일

### 부트스트랩 모드
- 처음 서버를 설치했을 때, 또는 아무도 로그인하지 않은 상태에서는 **부트스트랩 모드**가 활성화
- 부트스트랩 모드에서는 로그인 없이 CEO 권한으로 자동 진입
- 한 번이라도 비밀번호를 변경하면 부트스트랩 모드 해제

---

## Phase 4: 스마트 모델 라우팅 + 비용 제한

### 모델 자동 선택
| 메시지 유형 | 사용 모델 | 비용 |
|------------|----------|------|
| 짧은 질문 (50자 이하) | Claude Haiku | 저비용 (~$0.001) |
| 일반 질문 / 복잡한 분석 | Claude Sonnet | 중간 (~$0.01) |

"분석", "보고서", "전략", "계획" 등의 키워드가 있으면 복잡한 질문으로 판단

### 일일 비용 제한
- 기본 한도: **$7/일** (약 10,000원)
- 한도 초과 시 AI 호출 거부 + "오늘 예산을 초과했습니다" 메시지
- 한도는 웹 대시보드에서 변경 가능

### 비용 추적
- 모든 AI 호출의 비용이 DB에 자동 기록
- GET `/api/budget`으로 오늘 사용량, 한도, 남은 금액 조회 가능

---

## 변경된 파일

| 파일 | 작업 | 설명 |
|------|------|------|
| `web/ai_handler.py` | **새로 생성** | AI 호출, 모델 라우팅, 비용 계산을 담당하는 모듈 |
| `web/arm_server.py` | **수정** | 텔레그램/웹소켓 AI 연결, 로그인 API, 예산 API 추가 |
| `web/db.py` | **수정** | `get_today_cost()` 함수 추가 (오늘 총 AI 비용 조회) |
| `web/templates/index.html` | **수정** | 로그인 모달을 비밀번호 전용으로 변경, 로그아웃 버튼 추가 |
| `.github/workflows/deploy.yml` | **수정** | anthropic 패키지 설치, ai_handler.py 복사, API 키 주입 추가 |
| `docs/project-status.md` | **수정** | 프로젝트 상태 업데이트 (v0.08.000) |
| `CLAUDE.md` | **수정 (이전 세션)** | 데이터 저장 규칙 추가 |

---

## CEO가 확인해야 할 것들

### Phase 2 확인 (AI 답변)
1. **텔레그램**: 텔레그램에서 "삼성전자 분석해줘" 보내기 → AI가 실제 답변하는지 확인
2. **텔레그램**: `/배치` 보내기 → "배치 모드로 전환" 메시지 확인
3. **텔레그램**: `/실시간` 보내기 → "실시간 모드로 전환" 메시지 확인
4. **웹**: http://168.107.28.100 접속 → 채팅으로 메시지 보내기 → AI 답변 확인

### Phase 3 확인 (로그인)
5. **웹**: 비밀번호 변경 전까지는 로그인 없이 자동 진입 (부트스트랩 모드)
6. 나중에 비밀번호를 바꾸면 로그인 모달이 뜸

### Phase 4 확인 (비용)
7. **웹**: 대시보드에서 오늘 AI 사용 비용 표시 확인
8. **텔레그램**: AI 답변 끝에 비용 정보(모델명, $0.001 등) 표시 확인

### 사전 조건
- GitHub Secrets에 `ANTHROPIC_API_KEY`가 등록되어 있어야 함 (**이미 완료**)

---

## 현재 상태

- 코드 수정 완료
- 커밋 + 푸시 → 자동 머지 → 배포 진행 중

---

## 다음에 할 일

1. **29명 에이전트 소울(성격) 설정** — 각 에이전트의 성격과 행동 방식 정의
2. **노션 API 키 등록** — 에이전트 보고 시스템 활성화
3. **도메인 연결** — corthex.com 등으로 접속 가능하게
