# P0 버그 3건 수정 — 전문가 즉사 + QA 허위합격 + CIO 도구 미사용 — 2026-02-24

## 기본 정보
- **날짜**: 2026-02-24 (KST)
- **브랜치**: claude/qa-c1-finance-fix
- **심각도**: 🚨 P0 (전 부서 영향)

---

## 🔥 무슨 일이 있었나 (대표님용 요약)

### 증상
대표님이 "즉시 분석" 버튼을 눌렀는데:
1. 전문가 4명이 **0.023초 만에 전원 사망** (분석도 시작하기 전에!)
2. 아무도 보고서를 안 냈는데 QA가 **"전원 합격"**이라고 발표
3. CIO가 전문가 에러 메시지만 보고 **도구 없이 상상으로 보고서 작성** (할루시네이션)

### 비유로 설명하면
> 시험장에 학생 4명이 들어왔는데, 문이 잠겨서 시험지도 못 받고 다 돌아감.
> 그런데 감독관이 "백지답안 4장, 전원 합격!"이라고 발표.
> 교장선생님은 "학생들이 잘했다"고 거짓 보고서 작성.

---

## 🐛 버그 3건 상세

### 버그#1: `_apply_openai_strict_inline` NameError (★근본 원인)

| 항목 | 내용 |
|------|------|
| **파일** | `web/ai_handler.py` |
| **원인** | `_apply_openai_strict_inline()` 함수가 `_load_tool_schemas()` 함수 **내부에** 지역 함수로 정의됨. 그런데 `ask_ai()` 함수에서도 이 함수를 호출함 → **NameError** (변수를 찾을 수 없음) |
| **영향** | GPT 모델(GPT-5.2, GPT-5.2 Pro 등)을 쓰는 **모든 에이전트**가 도구(API)를 사용하려 하면 즉시 사망 |
| **왜 Anthropic/Gemini는 괜찮았나** | Anthropic과 Google 모델은 다른 코드 경로를 타서 이 함수를 호출하지 않음 |
| **수정** | 함수를 모듈 최상위 레벨로 이동 → 어디서든 호출 가능하게 |

**이 버그가 바로 "GPT 0회 문제"의 진짜 원인이었습니다!**
- GPT 모델 에이전트가 도구를 쓸 때마다 NameError로 즉사
- Claude로 폴백되면 다른 코드 경로라서 정상 작동
- 그래서 "GPT 0회, Claude만 작동"하는 현상이 발생

### 버그#2: QA 검수 대상 0명인데 "전원 합격"

| 항목 | 내용 |
|------|------|
| **파일** | `web/arm_server.py` (`_manager_with_delegation()`) |
| **원인** | 전문가 전원 에러 → 유효 보고서 0건 → QA 반복문이 0회 실행 → `failed_specs = []` → else 분기에서 "전원 합격" 로그 |
| **비유** | 빈 교실에 "낙제자 없음" → "전원 합격!" (학생이 0명인데!) |
| **수정** | `_qa_valid_count == 0`이면 QA 스킵 + "⚠️ 전원 에러, 품질검수 불가" 경고 로그 |

### 버그#3: CIO(처장)가 종합 시 도구를 못 씀

| 항목 | 내용 |
|------|------|
| **파일** | `web/arm_server.py` (`_manager_with_delegation()`) |
| **원인** | 처장 종합 호출: `ask_ai(prompt, model=model)` — `tools` 파라미터 없음 → 도구 사용 불가 → 전문가 에러 메시지만 보고 상상으로 보고서 작성 |
| **비유** | 편집장이 기자들 원고를 받아서 정리하는데, 인터넷 접속이 안 돼서 팩트체크 없이 상상으로 기사 작성 |
| **수정** | 처장(CIO/CSO/CMO/CPO)의 `agents.yaml`에 정의된 `allowed_tools`를 로드하여 `ask_ai()`에 전달 → 도구로 직접 데이터 검증 가능 |

---

## 📝 수정 내역

### `web/ai_handler.py`
| 수정 | 설명 |
|------|------|
| `_apply_openai_strict_inline()` 모듈 레벨로 이동 | 내부 함수 → 최상위 함수. `_load_tool_schemas()`와 `ask_ai()` 양쪽에서 호출 가능 |
| 기존 내부 정의 제거 | `_load_tool_schemas()` 안의 중복 정의 삭제, 주석으로 설명 |

### `web/arm_server.py`
| 수정 | 설명 |
|------|------|
| QA 유효 카운트 체크 | `_qa_valid_count == 0`이면 QA 스킵 + 경고 로그 |
| QA 합격 조건 강화 | `elif _qa_valid_count > 0:` 진짜 합격만 로그 |
| 처장 종합 시 도구 로드 | `mgr_allowed = mgr_detail.get("allowed_tools", [])` → 스키마 로드 → `ask_ai()` 전달 |
| 종합 도구 실행기 추가 | `_synth_tool_executor()` — 도구로그 탭에도 실시간 표시 |

### `CLAUDE.md`
| 수정 | 설명 |
|------|------|
| 활동 로그 API 추가 | `/api/activity-logs` 대문짝만하게 기재 |
| KST 날짜 규칙 추가 | 모든 날짜/시간은 한국 시간 기준 |

---

## 🔍 연쇄 실패 체인 (이번에 발견한 것)

```
NameError (버그#1)
  ↓
전문가 4명 즉사 (0.023초)
  ↓
유효 보고서 0건
  ↓
QA "전원 합격" (버그#2)
  ↓
CIO가 에러 메시지만 받음
  ↓
도구 없이 상상으로 종합 (버그#3)
  ↓
할루시네이션 보고서 → 거짓 매매 시그널
```

---

## 🌐 영향 범위

| 부서 | 영향 | 이유 |
|------|------|------|
| CIO (재무처) | ✅ 자동 적용 | `_manager_with_delegation()` 공용 함수 |
| CSO (전략처) | ✅ 자동 적용 | 동일 함수 사용 |
| CMO (마케팅처) | ✅ 자동 적용 | 동일 함수 사용 |
| CPO (기록처) | ✅ 자동 적용 | 동일 함수 사용 |
| 비서실 | ✅ 자동 적용 | `ask_ai()` 수정이라 전체 적용 |

---

## 📋 다음에 할 일
- 배포 후 "즉시 분석" 실행 → 4탭에서 도구 사용/보고서 제출 확인
- 전문가들이 0.023초가 아닌 정상 시간(30~120초) 동안 분석하는지 확인
- 블라인드 모델 비교 테스트 진행
