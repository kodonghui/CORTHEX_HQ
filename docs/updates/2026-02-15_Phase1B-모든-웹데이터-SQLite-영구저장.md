# Phase 1B: 모든 웹 데이터 SQLite 영구 저장

## 버전
0.07.002

## 작업 날짜
2026-02-15

## 작업 브랜치
claude/phase1b-all-data-to-sqlite

---

## 한 줄 요약
웹 화면에서 저장/수정하는 모든 데이터(프리셋, 예약, 워크플로우, 메모리, 예산, 에이전트 설정, 소울 등)가 이제 데이터베이스에 영구 저장됩니다. 서버를 재시작하거나 코드를 재배포해도 데이터가 사라지지 않습니다.

---

## 왜 이 작업을 했나요?

Phase 1에서 SQLite DB를 도입했지만, 그때는 **텔레그램/웹소켓 메시지 + 작업 기록 + 활동 로그 + 아카이브**만 DB에 저장했습니다.

그 외 웹에서 저장하는 데이터들(프리셋, 예약, 워크플로우, 메모리, 피드백, 예산, 에이전트 설정, 품질 검수 기준, 에이전트 소울 등)은 여전히 **JSON 파일**에 저장되고 있었습니다.

문제는: 서버에 새 코드를 배포하면 `git reset --hard` 명령어가 실행되는데, 이때 **config 폴더 안의 파일이 원래 상태로 돌아가면서 저장한 설정이 날아갈 수** 있었습니다.

이번 작업으로 **모든 웹 데이터**를 SQLite DB에 저장하도록 바꿨습니다. DB 파일은 git 저장소 밖(`/home/ubuntu/corthex.db`)에 있으므로, 배포해도 절대 안 날아갑니다.

---

## 변경된 파일

| 파일 | 작업 | 설명 |
|------|------|------|
| `web/db.py` | **수정** | `settings` 테이블(키-값 저장소) 추가 + `save_setting()` / `load_setting()` 함수 추가 |
| `web/mini_server.py` | **수정** | 모든 데이터 저장을 SQLite로 교체 (JSON 파일 의존 제거) |
| `CLAUDE.md` | **수정** | 데이터 저장 규칙 추가 ("모든 웹 데이터는 SQLite에 저장할 것") |
| `docs/project-status.md` | **수정** | 프로젝트 현재 상태 업데이트 |

---

## 구체적으로 뭐가 바뀌었나?

### 1. settings 테이블 추가 (db.py)
- DB에 새 테이블을 만들었습니다: `settings`
- 이 테이블은 "이름(key) → 값(value)" 형태로 아무 데이터나 저장할 수 있습니다
- 예: `save_setting("presets", [{이름: "기본", ...}])` → DB에 영구 저장

### 2. _load_data / _save_data 교체 (mini_server.py)
- **이전**: `data/presets.json` 같은 JSON 파일에서 읽고 씀
- **이후**: SQLite DB에서 읽고 씀
- **자동 마이그레이션**: 이미 JSON 파일에 저장된 데이터가 있으면, 처음 읽을 때 자동으로 DB로 옮겨줌

### 3. _save_config_file 교체 (mini_server.py)
- **이전**: `config/quality_rules.json` 같은 설정 파일에 씀 (git 저장소 안이라 위험!)
- **이후**: `config_quality_rules` 라는 이름으로 DB에 저장

### 4. 에이전트 소울(성격) 저장 교체
- **이전**: `config/souls/agent_id.md` 파일에 저장
- **이후**: `soul_agent_id` 라는 이름으로 DB에 저장
- 소울 조회 시에도 DB에 저장된 것을 우선으로 사용

### 5. 중복 아카이브 라우트 제거
- Phase 1에서 DB 기반 아카이브 API를 추가했는데, 기존의 파일 기반 아카이브 API가 남아있어서 충돌 가능성이 있었음
- 파일 기반 라우트 3개를 제거하고, DB 기반 라우트만 사용하도록 정리

---

## 영향받는 웹 기능들

| 기능 | 저장되는 데이터 | DB 키 이름 |
|------|--------------|-----------|
| 프리셋 | AI 프롬프트 템플릿 | `presets` |
| 예약 | 자동 실행 스케줄 | `schedules` |
| 워크플로우 | 작업 흐름 설정 | `workflows` |
| 메모리 | AI가 기억하는 정보 | `memories` |
| 피드백 | 사용자 피드백 | `feedback` |
| 예산 | AI 사용 비용 한도 | `budget` |
| 에이전트 설정 | 모델 선택, 오버라이드 | `agent_overrides` |
| 품질 검수 기준 | 부서별 검수 루브릭 | `config_quality_rules` |
| 에이전트 소울 | 에이전트 성격/행동 설정 | `soul_{agent_id}` |

---

## 현재 상태

- 코드 수정 완료, 커밋 + 푸시 완료
- auto-merge → 배포 진행 중

---

## 다음에 할 일

1. **Phase 2**: 비서실장 AI를 텔레그램에 연결 — CEO 명령을 실제로 AI가 처리
   - 텔레그램 명령어: `/실시간` (즉시 처리) / `/배치` (나중에 처리)
2. **Phase 3**: 웹 로그인 + PUT/POST API — 간단한 비밀번호 로그인
3. **Phase 4**: 스마트 모델 라우팅 + 비용 제한 — 작업 난이도별 모델 자동 선택
