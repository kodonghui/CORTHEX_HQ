# ARM 24GB 서버 이전 완료 + 배치 체인 오케스트레이터

## 버전
0.14.000

## 작업 날짜
2026-02-16

## 작업 브랜치
claude/fix-multi-provider-ai-chat

## 빌드 번호
#143 (새 ARM 서버 첫 배포)

---

## 변경 사항 요약

### 1. ARM 24GB 서버 이전 완료

**뭘 했는지**: 기존 1GB 마이크로 서버(168.107.28.100)에서 새 ARM 4코어 24GB 서버로 완전히 이전했습니다.

**수정한 파일**:
- `.github/workflows/deploy.yml` (자동 배포 설정 파일)
  - `SERVER_IP` → `SERVER_IP_ARM` (새 서버 IP 시크릿)
  - `SERVER_SSH_KEY` → `SERVER_SSH_KEY_ARM` (새 서버 SSH 키)
  - nginx에 `/ws` WebSocket 프록시 추가 (실시간 통신용)
  - `src/` 디렉토리 배포 추가 (100개+ 도구 모듈)
  - 서비스 설명 "Mini Server" → "Server (ARM 24GB)"
  - venv pip으로 직접 패키지 설치하도록 개선
- `CLAUDE.md` (프로젝트 규칙 파일)
  - 새 서버 스펙 정보 업데이트
  - 서버 디렉토리 구조 문서화
  - 이전 서버 "폐기됨"으로 표시
- `web/ai_handler.py` (AI 처리 파일)
  - `from __future__ import annotations` 추가 (Python 3.10 호환성)
  - `callable | None` 타입 힌트가 Python 3.10에서 에러나는 문제 해결

**왜 했는지**: 기존 1GB 서버는 메모리가 부족해서 100개+ 도구를 모두 로드할 수 없었습니다. 새 24GB 서버에서는 모든 기능을 제한 없이 실행할 수 있습니다.

### 2. 배치 체인 오케스트레이터

**뭘 했는지**: CEO가 명령을 내리면, 위임 체인(분류→전문가→종합→전달)의 모든 단계가 자동으로 Batch API를 통해 처리되는 시스템을 구현했습니다.

**수정한 파일**:
- `web/arm_server.py` (백엔드 서버)
  - 배치 체인 상태 관리 (시작/진행/완료)
  - 프로바이더별 자동 그룹화 (Claude/GPT/Gemini 각각의 배치로 분리)
  - 60초 폴러로 배치 결과 자동 수집 + 다음 단계 진행
  - WebSocket으로 진행 상태 실시간 알림
- `web/ai_handler.py` (AI 처리 파일)
  - `batch_submit_grouped()` 함수 추가 — 여러 AI 요청을 프로바이더별로 자동 분류하여 각각의 Batch API에 제출

**왜 했는지**: CEO가 "전체 부서에 보고서 쓰라"고 하면, 6개 부서 × 4명 전문가 = 24개 AI 요청이 발생합니다. Batch API를 쓰면 비용이 ~50% 절감되고, 모든 요청이 병렬로 처리됩니다.

**작동 방식**:
1. CEO가 명령 → 키워드로 담당 부서 자동 분류
2. 해당 부서 전문가들의 분석 요청을 Batch API로 제출 (프로바이더별 그룹)
3. 60초마다 결과 확인 → 모두 완료되면 다음 단계
4. 부서장이 전문가 결과를 종합하여 보고서 작성 (이것도 Batch API)
5. 최종 보고서를 CEO에게 전달 + 아카이브 저장

### 3. 배포 중 발생한 문제 해결

- **첫 배포 실패**: Python 3.10 서버에서 `callable | None` 타입 힌트가 에러 → `from __future__ import annotations` 추가로 해결
- **패키지 설치 확인 실패**: 시스템 python3 vs venv python3 경로 불일치 → venv python3으로 직접 확인하도록 수정

---

## 현재 상태
- 새 ARM 24GB 서버에서 빌드 #143 정상 운영 중
- 텔레그램 봇 정상 작동
- API 키 4개 등록 완료 (Anthropic, OpenAI, Google, Notion)
- ToolPool 경고 있음 (PyYAML 미설치 → JSON 변환으로 우회 중, 서비스에 영향 없음)

## 다음에 할 일
- venv에 PyYAML 설치하여 ToolPool 경고 해결
- 배치 체인 실제 테스트 (사령실에서 명령 보내서 전체 흐름 검증)
- 키움증권 API 연동 (모의투자 → 실거래)
- 도메인 연결 (corthex.com 등)
