# 코드 전체 리뷰 및 버그 9건 수정

## 작업 날짜
2026-02-13

## 작업 브랜치
claude/code-review-bugs-qG3K4

---

## 변경 사항 요약

전체 코드를 처음부터 끝까지 읽고 버그(오류) 9건을 찾아서 고쳤습니다.

### 수정한 파일 목록 (7개)

| 파일 | 설명 |
|------|------|
| `src/llm/cost_tracker.py` (LLM 비용 기록기) | 비용 기록에 "언제 쓴 돈인지" 날짜 정보 추가 |
| `src/core/budget.py` (예산 관리) | 오늘/이번달 비용만 계산하도록 수정 |
| `src/tools/pool.py` (도구 관리자) | 도구 사용 시 "누가 호출했는지" 정보가 전달되도록 수정 |
| `src/core/registry.py` (에이전트 등록소) | 조직도에서 "처장"급 에이전트를 못 찾던 문제 수정 |
| `web/app.py` (웹 서버) | API 주소 충돌 2건 수정 |
| `src/tools/sns/oauth_manager.py` (SNS 로그인 관리) | 로그인 URL이 깨지던 문제 수정 + 쓸모없는 코드 제거 |
| `src/tools/leet_survey.py` (LEET 서베이 도구) | 서베이 실행 시 시스템 멈추던 문제 수정 |

---

## 각 버그 상세 설명

### 버그 1: 예산 추적이 완전히 망가져 있었음 (심각)
- **문제**: 예산 계산 시 "오늘 쓴 돈"과 "이번달 쓴 돈"을 구분하지 않고 **모든 기록을 다 합산**하고 있었습니다. 서버를 며칠 켜놓으면 어제 쓴 돈도 "오늘 예산"에 포함되어 예산 초과(경고)가 잘못 뜸
- **수정**: 비용 기록에 날짜 도장(timestamp)을 찍고, 계산할 때 오늘/이번달 것만 골라서 합산하도록 수정

### 버그 2: 도구(tool) 권한 검사가 항상 실패 (심각)
- **문제**: 에이전트가 도구를 호출할 때 "누가 호출했는지(caller_id)" 정보가 도구에 전달되지 않았습니다. SNS 발행 같은 권한이 필요한 도구는 "누구인지 모르니까" 항상 거부됨
- **수정**: 도구 호출 시 caller_id를 같이 전달하도록 한 줄 수정

### 버그 3: 조직도에서 "처장"을 못 찾음 (중간)
- **문제**: `list_division_heads()` 함수(처장 목록 조회)가 역할이 "manager"인 것만 찾았는데, 실제 처장들의 역할은 "division_head"로 되어 있어서 아무도 안 잡힘
- **수정**: "division_head" 역할도 함께 찾도록 조건 추가

### 버그 4: 웹 API 주소 충돌 (중간)
- **문제**: `/api/health`라는 같은 주소에 2개의 다른 기능이 등록되어 있었음. 하나는 간단한 상태 확인, 하나는 정밀 진단인데 주소가 같아서 하나가 무시됨
- **수정**: 정밀 진단 기능을 `/api/healthcheck`로 주소 분리

### 버그 5: YouTube 웹훅 검증이 절대 실행 안 됨 (중간)
- **문제**: 같은 조건문(`hub.challenge`)이 2번 연속 있어서, 두 번째 YouTube용 검증 코드는 절대 도달 불가
- **수정**: Instagram용은 `hub.verify_token`도 같이 체크, YouTube용은 `hub.challenge`만 체크하도록 조건 분리

### 버그 6: SNS 로그인(OAuth) URL이 깨짐 (심각)
- **문제**: LinkedIn 로그인 URL에 공백이 포함된 파라미터가 인코딩(변환) 없이 그대로 들어가서 URL이 깨지고 로그인이 실패함
- **수정**: `urlencode()`를 사용하여 공백 등 특수문자를 올바르게 변환

### 버그 7: LEET 서베이 실행 시 서버 전체가 멈춤 (심각)
- **문제**: 서베이 수집 기능이 최대 10분 동안 "동기적으로"(기다리면서) 실행되어, 그 사이 다른 모든 기능(웹 대시보드, 다른 에이전트 등)이 완전히 멈춤
- **수정**: `asyncio.to_thread()`로 감싸서 서버가 멈추지 않고 백그라운드에서 실행되도록 변경

### 버그 8: 서베이 스크래퍼 실패를 감지 못함 (중간)
- **문제**: 스크래퍼(데이터 수집 프로그램)가 에러로 종료해도 종료 코드를 확인하지 않아서, "결과 파일이 없습니다"라는 엉뚱한 메시지만 보여줌
- **수정**: 종료 코드를 확인하고 실패 시 에러 내용을 바로 보여주도록 추가

### 버그 9: Tistory 관련 쓸모없는 코드 제거 (경미)
- **문제**: Tistory API가 2024년에 폐지되었는데 OAuth 코드에 Tistory 관련 분기(조건문)가 남아있었음. 이 코드는 절대 실행될 수 없는 죽은 코드
- **수정**: 깔끔하게 제거

---

## 현재 상태
- 9건 버그 수정 완료
- 커밋(저장) 완료
- PR(합치기 요청) 대기 중

## 다음에 할 일
- main 브랜치(메인 코드)에 합치기
- 추가 테스트 실행하여 수정 사항 검증
