# 전수검사 버그 수정 11건 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.02.003
- **브랜치**: claude/fix-corthex-bugs-v9a3P
- **빌드**: 배포 후 갱신

## 변경 사항

### 🔧 수정한 것
| 파일 | 수정 내용 (CEO가 이해할 수 있게 쉽게) |
|------|-------------------------------------|
| `web/mini_server.py` | 에이전트 3명(기록보좌관, 일정보좌관, 아카이브)의 AI 모델명이 존재하지 않는 이름(`claude-haiku-4-5`)으로 되어 있었음 → 올바른 이름(`claude-haiku-4-5-20251001`)으로 수정. 이 버그 때문에 해당 에이전트들이 AI 호출 시 에러 발생 가능했음 |
| `config/agents.yaml` | 같은 3명 에이전트(정보보좌관, 일정보좌관, 아카이브)의 모델명이 agents.yaml에서도 `claude-haiku-4-5`로 잘못 되어 있었음 → `claude-haiku-4-5-20251001`로 수정 (3곳) |
| `web/ai_handler.py` | AI 비용 계산표가 models.yaml과 불일치 — Opus $15→$5, Haiku $0.25→$0.80, GPT-5.2 $5→$1.75, GPT-5.2 Pro $18→$21 등 6개 모델 가격 수정. 이전까지 비용이 실제보다 과대/과소 계산되고 있었음 |
| `web/ai_handler.py` | OpenAI/Gemini API 응답이 빈 배열로 올 때 크래시(IndexError) 발생 가능 → 안전 검사 추가 |
| `src/tools/decision_tracker.py` | 의사결정 기록이 `data/decisions.json` 파일에 저장되어 배포할 때마다 사라짐 → SQLite DB 저장으로 변경 (P2-1 해결) |
| `src/tools/notification_engine.py` | 알림 발송 이력이 `data/notifications.json`에 저장되어 배포 시 사라짐 → SQLite DB 저장으로 변경 |
| `web/templates/index.html` | `_updateAgentCardLabel()` 함수가 2곳에 중복 정의 → 뒤쪽(기능 부족)을 삭제. 앞쪽(모델표시명 + 추론레벨 표시 기능 포함)만 유지 |
| `web/templates/index.html` | 페이지 닫을 때 WebSocket, SSE, 폴링 타이머가 정리 안 됨 → `beforeunload` 이벤트로 자동 정리 추가 (메모리 누수 방지) |
| `web/kis_client.py` | KIS 토큰 만료 감지 시 한국어 "만료"만 찾고 영어 "expired"를 무시 → msg_cd 우선 확인 + 영어 키워드 추가. 국내+해외 양쪽 수정 |
| `web/db.py` | 월간 비용 계산(`get_monthly_cost()`)이 로컬 시간으로 비교하여 UTC로 저장된 DB 데이터와 불일치 → KST→UTC 변환 후 비교하도록 수정 |
| `web/mini_server.py` | CIO 비중 기반 자동매매에서 잔고 조회 시 `kis_client.get_balance()` 호출 → `kis_client` 모듈이 import 안 돼서 NameError 크래시. `_kis_balance()`로 수정 (2곳) |

### 🐛 발견한 버그 (수정 여부 무관하게 전부 기록!)
| 버그 | 원인 | 상태 |
|------|------|------|
| 에이전트 3명 모델명 `claude-haiku-4-5` (mini_server.py) | 존재하지 않는 모델명 하드코딩 | ✅ 수정 완료 |
| 에이전트 3명 모델명 `claude-haiku-4-5` (agents.yaml) | 설정 파일에도 동일 오류 (3곳) | ✅ 수정 완료 |
| _PRICING 6개 모델 가격 불일치 | models.yaml과 ai_handler.py 이중 관리 | ✅ 수정 완료 |
| OpenAI/Gemini API 빈 응답 시 크래시 | choices[0] / candidates[0] 안전검사 없음 | ✅ 수정 완료 |
| decisions.json 배포 시 데이터 유실 | JSON 파일 저장 (P2-1) | ✅ 수정 완료 |
| notifications.json 배포 시 데이터 유실 | JSON 파일 저장 | ✅ 수정 완료 |
| _updateAgentCardLabel 중복 정의 | 두 번째 정의가 첫 번째를 덮어씀 | ✅ 수정 완료 |
| SSE/WebSocket/타이머 메모리 누수 | beforeunload 정리 없음 | ✅ 수정 완료 |
| KIS 토큰 만료 감지 불완전 | 한국어만 검사, 영어/코드 무시 | ✅ 수정 완료 |
| 월간비용 타임존 불일치 | 로컬시간 vs UTC 혼재 | ✅ 수정 완료 |
| CIO 비중매매 `kis_client.get_balance()` NameError | 모듈 import 없이 모듈 참조 호출 (2곳) | ✅ 수정 완료 |
| mini_server.py 미정의 함수 다수 | _manager_with_delegation 등 10+ 함수 정의 안 됨 | 🔴 미수정 (추가 조사 필요) |
| AGENTS 리스트 하드코딩 | agents.yaml과 이중 관리 | 🔴 미수정 (구조 변경 필요) |
| 환율 1450원 하드코딩 (폴백) | 실시간 환율 미연동 시 고정값 사용 | 🔴 미수정 |
| KIS 토큰 쿨다운 국내/해외 공유 | 국내 발급이 해외 쿨다운에 영향 | 🔴 미수정 |
| 해외 holdings_eval 환율 미적용 | USD 평가액을 KRW로 안 환산 | 🔴 미수정 |

### 📊 현재 상태
- 전수검사 Phase 1 완료 (6개 핵심 파일 + config + tools)
- 높은 심각도 버그 7건 + 중간 심각도 4건 = 총 11건 수정
- 미수정 항목 5건은 구조적 변경이 필요하여 다음 세션으로 이관

### 📋 다음에 할 일
- mini_server.py의 미정의 함수들 조사 (실제 사용되는지, 서버 기동 시 에러 나는지)
- AGENTS 리스트를 agents.yaml에서 동적 로드하도록 구조 변경
- 환율 실시간 반영 개선
- P2-2~P2-12 미수정 항목 처리
- Phase 2 도구 개발 (CMO 이미지 8개, CTO/CSO/CPO/비서실 도구)
