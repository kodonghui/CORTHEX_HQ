# 2026-02-28 — SketchVibe Phase 2 구현

## 요약
정확도 향상 + MCP 서버 + "맞아" 후 구현 브리지. Claude Code에서 캔버스/다이어그램 직접 접근 가능.

## 변경 파일

| 파일 | 변경 | 줄수 |
|------|------|------|
| `web/handlers/sketchvibe_handler.py` | 대폭 수정 | +234줄 |
| `web/mcp_sketchvibe.py` | **신규** — FastMCP 서버 | ~130줄 |
| `.mcp.json` | sketchvibe 서버 등록 | +7줄 |
| `web/static/js/corthex-app.js` | confirmSketchVibe 수정 + state 추가 | +20줄 |
| `web/templates/index.html` | 확인 후 안내 패널 추가 | +20줄 |

## 구현 내용

### 1. 정확도 향상 (`sketchvibe_handler.py`)
- **_parse_drawflow() 강화**:
  - 노드 타입 → Mermaid 형태 매핑 (start→`([])`, decide→`{}`, system→`[[]]` 등)
  - 위치 기반 레이아웃 판단 (x-spread > y-spread → LR, 반대 → TD)
  - 공간 그룹 감지 (300px 이내 클러스터 → subgraph 힌트)
  - 분기 포트 정보 (decide 노드의 output_1/output_2 → [분기 1/2])
- **Claude 프롬프트 확장**:
  - sequenceDiagram, stateDiagram, classDiagram 타입 추가
  - 노드 타입→Mermaid 형태 매핑표 포함
  - 레이아웃/그룹/분기 처리 규칙 + 예시 2개
- **모델 하드코딩 수정**: `load_setting("sketchvibe_model")` 기반

### 2. MCP 서버 (`web/mcp_sketchvibe.py`)
- FastMCP 3.0 기반 MCP 서버 (Claude Code와 stdio 통신)
- **도구 3개**:
  - `read_canvas()` — 현재 캔버스 스케치 상태
  - `list_confirmed_diagrams()` — 확인된 다이어그램 목록
  - `get_confirmed_diagram(name)` — 상세 (Mermaid + 해석 + 캔버스 JSON)
- **리소스 2개**: `sketchvibe://canvas`, `sketchvibe://confirmed`
- `.mcp.json`에 등록 → Claude Code 세션에서 자동 시작

### 3. 구현 브리지
- **백엔드**: save-diagram에 SQLite 저장 추가 (confirmed_list)
  - `GET /api/sketchvibe/confirmed` — 목록
  - `GET /api/sketchvibe/confirmed/{name}` — 상세
- **프론트엔드**: "맞아" 후 확인 안내 패널
  - MCP URI 표시 + HTML 뷰어 링크 + "새 다이어그램" 버튼
  - 캔버스 JSON도 함께 전송 (구현 시 참조용)

## 파이프라인 (Phase 2)
```
① 캔버스에 노드 배치 + 선 연결
② 자연어 설명 입력
③ "변환하기" → Claude가 타입/레이아웃/그룹 자동 판단
④ Mermaid 렌더링 + 해석 표시
⑤ "맞아 ✓" → .md + .html + SQLite 저장
⑥ 확인 안내 패널 (MCP URI + HTML 뷰어)
⑦ Claude Code에서 MCP 도구로 다이어그램 읽기
⑧ Claude Code가 실제 코드 구현
```

## 의존성
- `fastmcp>=3.0` + `httpx` (개발 환경, 서버 배포 불필요)
