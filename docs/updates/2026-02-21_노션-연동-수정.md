# 노션 연동 수정 — 속성 타입 일치 + 에이전트 도구 제거 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.01.001
- **브랜치**: claude/fix-notion-integration

## 변경 사항

### 🔧 수정한 것

| 파일 | 수정 내용 |
|------|----------|
| `web/arm_server.py` | `_save_to_notion` 속성 타입을 rich_text → select로 변경. 노션 DB 헤더와 속성명 일치시킴 |
| `web/arm_server.py` | 기본 DB ID를 실제 노션 DB URL에서 추출한 값으로 업데이트 |
| `config/agents.yaml` | 4명(비서실장, CPO, 연대기, 아카이브)의 allowed_tools에서 notion_api 제거 |
| `config/agents.json` | 동일하게 notion_api 제거 + CPO system_prompt에서 notion_api 가이드 삭제 |

### 상세 — 속성 매핑 변경

**변경 전 (저장 실패 원인):**
```python
properties["작성자"] = {"rich_text": ...}   # ❌ DB에 "작성자" 컬럼 없음 + 타입 틀림
properties["부서"] = {"rich_text": ...}     # ❌ DB는 select 타입
properties["보고 유형"] = {"rich_text": ...} # ❌ DB에 "보고 유형" 없음 (공백 차이)
properties["상태"] = {"rich_text": ...}     # ❌ DB는 select 타입
```

**변경 후:**
```python
# 산출물 DB → "에이전트" select, 비서실 DB → "담당자" select
properties["에이전트"/"담당자"] = {"select": {"name": agent_name}}
properties["부서"] = {"select": {"name": division}}      # 산출물 DB만
properties["보고유형"] = {"select": {"name": report_type}}
properties["상태"] = {"select": {"name": "완료"}}
properties["카테고리"] = {"select": {"name": "보고서"}}   # 비서실 DB만
```

### 에이전트 notion_api 도구 제거 이유
- 서버(`arm_server.py`)가 **자동으로** 노션에 저장하므로, 에이전트가 직접 호출할 필요 없음
- 에이전트 직접 호출 시 서버 자동 저장과 **이중 저장** 발생 가능
- 도구 정의(tools.yaml/json)는 유지 — 나중에 필요하면 다시 활성화 가능

### 🐛 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| 노션에 아무것도 안 올라감 | 코드 속성명/타입이 노션 DB 헤더와 불일치 (rich_text vs select, 이름 차이) | ✅ 수정 완료 |
| 기본 DB ID가 실제 DB와 다름 | 코드 하드코딩 기본값이 옛날 값 (`36880ed0...`, `4c20dd05...`)이었음 | ✅ 수정 완료 |

### 📊 현재 상태
- 노션 API 키: ✅ 서버에 설정됨
- 비서실 DB ID: `30a56b49-78dc-8153-bac1-dee5d04d6a74`
- 에이전트 산출물 DB ID: `30a56b49-78dc-81ce-aaca-ef3fc90a6fba`
- 서버 자동 저장: 속성 타입 수정 완료 → 배포 후 동작 확인 필요

### 📋 다음에 할 일
- 배포 후 에이전트 응답 시 노션 저장 확인 (`/api/notion-log`)
- soul 파일 29개에 있는 "노션 보고 의무" 섹션 정리 (선택 — 동작에 영향 없음)
