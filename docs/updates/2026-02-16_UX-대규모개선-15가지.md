# UX 대규모 개선 — 15가지 이슈 수정

## 버전
1.02.000

## 작업 날짜
2026-02-16

## 작업 브랜치
claude/fix-multi-provider-ai-chat

## 빌드 번호
#148

---

## 변경 사항 요약

CEO가 시스템을 실제로 테스트하면서 보고한 15가지 이슈/개선 요청을 일괄 처리한 업데이트입니다.

### 수정한 파일 목록

| 파일 | 설명 | 주요 변경 |
|------|------|----------|
| `web/templates/index.html` (웹 화면) | 프론트엔드 6가지 수정 | 사령관실 이름, 날짜구분선, 시간표시, 스크롤버튼, 모델버그, 폰트크기 |
| `web/mini_server.py` (시스템 백엔드) | 전력분석 API + AI 호출 기록 | agent_calls 연동, 성능 API 수정 |
| `web/db.py` (데이터베이스) | 에이전트별 비용 추적 테이블 | agent_calls 테이블 + save/load 함수 |
| `config/agents.yaml` (에이전트 설정) | 보좌관 이름 + 연대기 도구 | 기록관/일정관/연락관 + github_tool |
| `CLAUDE.md` (작업 규칙) | 서버 주소 업데이트 | 구 서버 IP → ARM 서버 IP |

---

### 15가지 수정 내역

#### 1. 배치 "현재 단계: ?" 버그 수정
- **문제**: 배치 체인(여러 에이전트가 동시에 일할 때) 시작하면 "현재 단계: ?" 로 표시됨
- **원인**: `_start_batch_chain()` 함수가 브로드캐스트(동시발송) 모드일 때 `step` 값을 안 돌려주고 있었음
- **수정**: 리턴값에 `"step": chain["step"]` 한 줄 추가

#### 2. "사령실" → "사령관실" 이름 변경
- **문제**: 탭 이름이 "사령실"로 되어 있었음
- **수정**: "사령관실"로 변경

#### 3. 채팅 날짜 구분선 + 시간 표시
- **문제**: 카카오톡처럼 날짜별 구분선이 없고, 메시지 보낸 시간도 안 보임
- **수정**:
  - 날짜가 바뀌면 "── 2026년 2월 16일 일요일 ──" 구분선 표시
  - 각 메시지 옆에 "오후 3:30" 같은 시간 표시
  - DB에서 메시지 불러올 때 타임스탬프(시간정보) 포함

#### 4. 스크롤 다운 버튼
- **문제**: 채팅이 길어지면 맨 아래로 내려가기 힘듦
- **수정**:
  - 스크롤을 올리면 우하단에 ↓ 버튼 나타남
  - 새 메시지가 오면 빨간 뱃지에 "3" 같이 개수 표시
  - 버튼 클릭하면 부드럽게 맨 아래로 이동

#### 5. 에이전트별 비용 추적 (전력분석 개선)
- **문제**: 전력분석 탭에서 에이전트별 비용이 전부 0으로 표시됨
- **원인**: 기존에는 CEO 명령 1개 = 기록 1개로만 저장해서, 개별 에이전트가 얼마나 썼는지 알 수 없었음
- **수정**:
  - `agent_calls` 테이블 신설 (에이전트별 AI 호출 기록: 모델, 비용, 토큰, 시간)
  - AI 호출할 때마다 자동으로 기록
  - 전력분석 API가 이 테이블에서 에이전트별 통계 집계

#### 6. 모델 일괄 변경 버그 수정
- **문제**: 전체 에이전트 모델을 한번에 바꿔도, 에이전트 상세 모달(팝업)에는 이전 모델이 그대로 표시됨
- **원인**: `applyBulkModel()` 함수가 사무실 카드는 업데이트하지만 모달 데이터는 안 바꿈
- **수정**: 모달이 열려 있으면 서버에서 최신 데이터를 다시 불러옴

#### 7. 에이전트 정보 모달 폰트 크기
- **문제**: 에이전트 정보 팝업의 글씨가 너무 작아서 읽기 힘듦 (12px)
- **수정**: 14px로 키움 (text-xs → text-sm)

#### 8. 배치 대기 상태등 (주황색)
- **문제**: 배치 처리 중 어떤 에이전트가 일하고 있고, 어떤 에이전트가 기다리는지 구분 안 됨
- **수정**: `waiting` 상태 추가 — 주황색(amber) 깜빡이는 불빛으로 "결과 대기 중" 표시
  - 초록색 깜빡임 = 작업 중
  - 주황색 깜빡임 = 대기 중
  - 초록색 고정 = 완료
  - 회색 = 미가동

#### 9. 보좌관 이름 변경
- **기존**: 총괄 보좌관, 전략 보좌관, 소통 보좌관
- **변경**: 기록관, 일정관, 연락관
- **이유**: 역할을 더 명확하게 표현 (기록관=노션 관리, 일정관=스케줄, 연락관=텔레그램/외부)

#### 10. 연대기 전문가 GitHub 도구
- **변경**: `chronicle_specialist` (회사 역사 담당 전문가)의 허용 도구에 `github_tool` 추가
- **이유**: 회사 히스토리를 관리하려면 GitHub 저장소 접근이 필요

#### 11. 대화 메시지 타임스탬프
- **변경**: DB에서 대화 기록 불러올 때 `timestamp` 필드 포함
- **이유**: 3번(날짜 구분선 + 시간 표시)이 작동하려면 각 메시지에 시간 정보가 있어야 함

#### 12. 전력분석 API 개선
- **변경**: `/api/performance` API가 `agent_calls` 테이블에서 에이전트별 통계를 집계하여 반환
- **이유**: 5번(에이전트별 비용 추적)이 화면에 표시되려면 API가 데이터를 제공해야 함

#### 13. AI 호출 자동 기록
- **변경**: `_call_agent()` 함수에서 AI 호출 후 자동으로 `save_agent_call()` 실행
- **기록 내용**: 에이전트 ID, 모델명, 비용(달러), 입출력 토큰, 처리 시간, 성공 여부

#### 14. CLAUDE.md 서버 주소 업데이트
- **변경**: 모든 `168.107.28.100` (구 1GB 서버) → `158.179.165.97` (새 ARM 24GB 서버)
- **이유**: 서버 이전이 이미 완료되었는데 문서가 아직 구 서버 주소를 참조하고 있었음

#### 15. 배치 step 값 전달
- **변경**: 배치 시작 시 WebSocket으로 보내는 데이터에 `step` 값 포함
- **이유**: 1번 버그의 근본 원인 해결 (비서실장이 "현재 단계: 2단계: 전문가 분석" 같이 표시할 수 있음)

---

## 현재 상태
- **빌드 #148** 배포 완료 (2026-02-16 17:50 KST)
- 15가지 변경 사항 모두 서버에 반영됨

## 다음에 할 일
- 노션 자동 업로드 (백엔드 → 📤 에이전트 산출물 DB)
- 에이전트 간 순차 협업 기능 (하이브리드형: 비서실장 허브 + 부서 간 순차 협업)
- 도구 건강 점검 기능 ("전체 도구 점검" 명령)
- 배치 "응답 없음" + 보고서 중복 표시 버그 수정
- 보고서 메타데이터 (사용한 도구 표시)
