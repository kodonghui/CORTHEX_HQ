# CIO 교신로그 SSE 수정 + 매매 로깅 강화 — 2026-02-21

## 기본 정보
- **날짜**: 2026-02-21
- **버전**: 3.01.002
- **브랜치**: claude/fix-exchange-rate-and-docs
- **이전 빌드**: #385

---

## 변경 사항

### 수정한 것

| 파일 | 수정 내용 |
|------|----------|
| `web/mini_server.py` | **교신 로그 SSE 수정** — ActivityLogMiddleware가 `/api/comms/stream` SSE 스트리밍을 감싸면서 깨뜨린 문제. 미들웨어 스킵 목록에 `/api/comms` 추가 |
| `web/mini_server.py` | **전문가 카운트 수정** — CIO 종합 에러 시 `specialists_used`가 0으로 반환되던 버그 수정. "CIO + 전문가 4명" → "CIO 포함 5명"으로 표시 변경 |
| `web/mini_server.py` | **CIO 독자 분석 교신 로그** — CIO가 전문가 위임 전에 혼자 하는 독자 분석도 교신 로그(delegation_log)에 기록되도록 추가 |
| `web/mini_server.py` | **매매 실행 상세 로깅** — 주문 전송/응답/에러 전 구간에 활동 로그 추가. 잔고 계산 과정, 주수 산출 공식, KIS 응답 내용까지 기록 |
| `web/mini_server.py` | **채팅 위임 표시 복구** — 이전에 무단 변경한 비서실장 broadcast, delegation_label, footer를 원래대로 되돌림 |

### 발견한 버그

| 버그 | 원인 | 상태 |
|------|------|------|
| 교신 로그 안 뜸 | ActivityLogMiddleware (BaseHTTPMiddleware)가 SSE 스트리밍 응답을 감싸서 깨뜨림 | ✅ 수정 완료 |
| "전문가 0명" 표시 | CIO 종합 단계에서 에러 나면 specialists_used가 누락되어 기본값 0 반환 | ✅ 수정 완료 |
| CIO 독자 분석 로그 안 남음 | ask_ai() 직접 호출이라 delegation_log에 기록 안 됨 | ✅ 수정 완료 |
| 매매 실행 원인 추적 불가 | 주문 과정 로깅이 부족해서 왜 안 됐는지 파악 불가 | ✅ 로깅 강화 |

### 분석 결과 (CEO 확인 필요)

| 항목 | 결과 |
|------|------|
| order_size = 0 | **의도적 설정** — "CIO 비중 자율" 모드. 잔고 × CIO 제시 비중%로 자동 계산. 잔고 조회 실패 시 기본 100만원 |
| 매매 안 됨 | 다음 수동 분석 실행 시 활동 로그에 상세 기록이 남음. 주문 전송/응답/에러가 단계별로 기록되므로 원인 파악 가능 |
| CIO 분석 흐름 | 1단계(독자 분석) → 2단계(전문가 4명 병렬) → 3단계(CIO 종합) = CIO 포함 총 5명 |
| B안 승인 | CEO가 "CIO + 리스크관리 2명 체제" 승인. 추후 별도 작업으로 구조 변경 예정 |

### 현재 상태
- 교신 로그: SSE 실시간 전송 정상화
- CIO 분석: 독자 분석도 교신 로그에 기록됨
- 매매 실행: 상세 로깅 추가 (다음 실행 시 원인 파악 가능)
- order_size=0: 정상 (CIO 비중 자율 모드)

### 다음에 할 일
- 매매 실행 후 활동 로그 확인 → 실패 원인 파악
- B안 구조 변경 (CIO + 리스크관리 2명 체제)
- Cloudflare Access API 경로 제외 설정 (디버그 편의)
