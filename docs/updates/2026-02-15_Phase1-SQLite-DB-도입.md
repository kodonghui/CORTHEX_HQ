# Phase 1: SQLite DB 도입 — 채팅/작업내역 영구 저장

## 버전
0.07.000

## 작업 날짜
2026-02-15

## 작업 브랜치
claude/phase1-sqlite-db

---

## 한 줄 요약
텔레그램/웹에서 보내는 모든 메시지와 작업 기록이 이제 데이터베이스(DB)에 영구 저장됩니다. 서버를 재시작하거나 코드를 재배포해도 데이터가 사라지지 않습니다.

---

## 왜 이 작업을 했나요?

이전까지 CORTHEX HQ 서버는 "껍데기"였습니다:
- 대시보드 화면은 예쁘지만, 모든 데이터(작업내역, 활동로그, 아카이브)가 항상 비어 있었음
- 텔레그램으로 메시지를 보내면 "접수했습니다"라고 답장만 하고, 메시지 내용은 저장되지 않았음
- 새로고침하면 모든 정보가 사라졌음

이번 작업으로 **SQLite 데이터베이스**를 추가하여 모든 데이터가 영구 저장되도록 했습니다.
이것이 Phase 2(비서실장 AI 연결) 이후 모든 기능의 **기반**입니다.

---

## 변경된 파일

| 파일 | 작업 | 설명 |
|------|------|------|
| `web/db.py` | **새로 생성** | SQLite DB 모듈 — 테이블 생성, 데이터 저장/조회 함수들 (~300줄) |
| `web/arm_server.py` | **수정** | DB 연동, API 7개 재작성/신규 추가, 텔레그램/웹소켓 핸들러 수정 |
| `.github/workflows/deploy.yml` | **수정** | 서버 배포 시 db.py 파일도 복사하도록 추가 |
| `docs/project-status.md` | **수정** | 프로젝트 현재 상태 업데이트 |

---

## 새로 만들어진 것들

### DB 테이블 4개

| 테이블 | 용도 | 쉬운 설명 |
|--------|------|-----------|
| `messages` | 메시지 원본 저장 | CEO가 텔레그램/웹으로 보낸 메시지 그대로 보관 |
| `tasks` | 작업 기록 | 모든 명령이 "작업"으로 기록됨 (작업내역 탭에 표시) |
| `activity_logs` | 활동 로그 | 에이전트가 뭘 했는지 로그 기록 |
| `archives` | 보고서 아카이브 | 완료된 보고서 보관소 |

### 수정/추가된 API

| API 주소 | 변경 내용 |
|----------|-----------|
| `GET /api/dashboard` | 더미 데이터 → **DB에서 실제 통계** (오늘 작업 수, 비용 등) |
| `GET /api/tasks` | 빈 배열 → **DB에서 실제 작업 목록** (검색/필터 지원) |
| `GET /api/tasks/{id}` | "not found" → **DB에서 실제 작업 상세** |
| `POST /api/tasks/{id}/bookmark` | **신규** — 북마크 토글 (DB 저장) |
| `GET /api/activity-logs` | **신규** — 활동 로그 조회 |
| `GET /api/archive` | **신규** — 아카이브 목록 조회 |
| `GET /api/archive/{div}/{file}` | **신규** — 아카이브 상세 조회 |

### 텔레그램 핸들러 변경

```
[이전] CEO 메시지 → "접수했습니다" 답장 → 끝 (저장 안 됨)
[이후] CEO 메시지 → DB에 메시지+작업 저장 → "접수했습니다 (작업ID: xxx)" 답장
       → 웹소켓으로 실시간 브로드캐스트 → 웹 대시보드에 즉시 표시
```

### 웹소켓 핸들러 변경

```
[이전] 명령 → "경량 모드입니다" 고정 답변 → 끝 (저장 안 됨)
[이후] 명령 → DB에 메시지+작업 저장 → task_accepted 이벤트 → 활동로그
       → "경량 모드입니다" 답변 → 작업내역 탭에 기록 남음
```

---

## DB 위치 (중요!)

- **서버**: `/home/ubuntu/corthex.db` — git 저장소 밖에 저장
  - 코드를 재배포해도(`git reset --hard`) DB 파일은 영향 안 받음
  - 서버가 재시작되어도 데이터 유지
- **로컬 개발**: `./corthex_dev.db` — 프로젝트 폴더에 생성됨

---

## 현재 상태

- 배포 완료 (Auto-merge + Deploy 성공)
- 서버 정상 작동 확인:
  - `/api/dashboard` — DB 실제 통계 반환
  - `/api/tasks` — 빈 배열 (아직 작업이 없어서 정상)
  - `/api/telegram-status` — 텔레그램 봇 정상 (`tg_started: true`)

---

## 테스트 방법

1. **텔레그램 테스트**: 텔레그램으로 아무 메시지 보내기 → 작업 ID가 포함된 답장 받는지 확인
2. **웹 확인**: `http://168.107.28.100/api/tasks` → 방금 보낸 메시지가 작업으로 표시되는지
3. **대시보드 확인**: `http://168.107.28.100/api/dashboard` → `today_task_count`가 0이 아닌지
4. **서버 재시작 후**: 데이터 그대로인지 확인
5. **새 배포 후**: 데이터 그대로인지 확인 (git reset --hard에 영향 안 받음)

---

## 다음에 할 일

1. **Phase 2**: 비서실장 AI를 텔레그램에 연결 — CEO 명령을 실제로 AI가 처리
2. **Phase 3**: 웹 로그인 + PUT/POST API — 간단한 비밀번호 로그인
3. **Phase 4**: 스마트 모델 라우팅 + 비용 제한 — 작업 난이도별 모델 자동 선택
