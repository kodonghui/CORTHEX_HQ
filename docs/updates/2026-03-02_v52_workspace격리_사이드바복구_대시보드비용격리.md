# v5.2 workspace-profile 404 수정 + 사이드바 에이전트 복구 + 대시보드 비용 격리

**날짜**: 2026-03-02 | **브랜치**: claude/v52-workspace-fix | **PR**: #732

---

## 수정한 버그 3건

### 🔴 버그 1: 사이드바 에이전트 안 보임 (근본 원인 수정)

**증상**: CEO 로그인해도 비서실장만 보이고 나머지 에이전트 7명 안 보임

**근본 원인**:
1. 페이지 로드 시 `initWorkspace()` 호출 → 토큰 없음 → `/api/workspace-profile` 호출
2. `get_auth_role()` → 'viewer' 반환 → `get_workspace_profile('viewer')` → None → **404**
3. 404 → workspace 기본값(`sidebarFilter` 미설정) 유지
4. 사이드바 조건: `agentCliOwner[id] === workspace.sidebarFilter` → undefined === undefined → chief_of_staff만 우연히 통과, 나머지 불일치

**수정 3가지**:
- `config/workspaces.yaml`: viewer 프로파일 추가 (`sidebarFilter: ""`)
- `web/arm_server.py`: 404 대신 viewer 폴백 프로파일 반환
- `web/static/js/corthex-app.js`: 토큰 없으면 `initWorkspace` 스킵

### 🟡 버그 2: $204.86 누나 대시보드 노출

**증상**: 누나 계정에서 CEO 전체 누적 비용 $204.86 표시됨

**수정**: `/api/dashboard`에 `request: Request` 추가 → `get_auth_role()` → sister면 사주 에이전트(cli_owner='sister') 비용만 집계

### 🟢 부가: viewer 프로파일 추가

로그인 전 / 미정의 role → viewer 프로파일 반환 (404 대신)

---

## 변경 파일

| 파일 | 변경 내용 |
|------|----------|
| `config/workspaces.yaml` | viewer 프로파일 추가 |
| `web/arm_server.py` | workspace-profile 폴백 + dashboard orgScope 필터 |
| `web/static/js/corthex-app.js` | initWorkspace 토큰 없으면 스킵 |

---

## 검증 체크리스트

- [ ] CEO 로그인 → 사이드바 에이전트 전부 보임 (비서실장, 팀장 6명 등)
- [ ] 누나 로그인 → Eden/Zoe/Sage 보임, CEO 에이전트 안 보임
- [ ] 누나 대시보드 → CEO 비용($204.86) 안 보임, 자신의 에이전트 비용만
- [ ] 비로그인 → viewer 프로파일 (에이전트 0개, 로그인 화면)
