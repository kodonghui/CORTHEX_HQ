# 2026-02-28 — arm_server.py 리팩토링 P8 (에이전트 라우팅 분리)

## 요약
arm_server.py에서 가장 어려운 핵심 허브 — 에이전트 라우팅 시스템 2,500줄을 `web/agent_router.py`로 분리.
4,509줄 → 1,843줄 (59% 감소). 전체 리팩토링 누적: 11,637줄 → 1,843줄 (84% 감소).

## 분리된 내용

### agent_router.py (2,500줄)
| 섹션 | 내용 |
|------|------|
| 상수 12개 | `_ROUTING_KEYWORDS`, `_AGENT_NAMES`, `_BROADCAST_KEYWORDS`, `_MANAGER_SPECIALISTS` 등 |
| 노션 API | `_save_to_notion()`, `_extract_notion_title()`, `_add_notion_log()` |
| QA 시스템 | `_QAModelRouter`, `_quality_review_specialists()`, `_handle_specialist_rework()` (비활성 보존) |
| 헬퍼 | `_tg_code()`, `_tg_convert_names()`, `_is_broadcast_command()`, `_broadcast_status()` |
| 프롬프트 | `_load_agent_prompt()`, `_load_chief_prompt()`, `_get_model_override()` |
| 에이전트 코어 | `_call_agent()`, `_manager_with_delegation()` (팀장=5번째 분석가 구조) |
| 라우팅 | `_determine_routing_level()` (Level 1~4), `_process_ai_command()` (최상위 라우터) |
| 브로드캐스트 | `_broadcast_to_managers_all()`, `_broadcast_with_debate()`, `_sequential_collaboration()` |
| 도구풀 | `_init_tool_pool()` + `_MiniModelRouter` 어댑터 |

### 아키텍처 결정
- **`_ms()` 패턴 호환**: batch_system/scheduler/trading_engine이 `sys.modules["arm_server"]`로 접근 → agent_router 함수들이 arm_server에 import되므로 동일하게 동작
- **router 없음**: agent_router에는 FastAPI APIRouter가 없음 (순수 로직 모듈)
- **QA 보존**: `_QUALITY_GATE_AVAILABLE = False`이지만 코드 보존 (향후 재활성화 대비)

### 기존 버그 수정
- `_flush_batch_api_queue`와 `_batch_api_queue`가 arm_server.py에 미임포트 → `/배치실행`, `/배치상태` 명령 실패 가능성 있었음 → agent_router에서 batch_system import로 수정

## 수정 파일
| 파일 | 변경 |
|------|------|
| `web/agent_router.py` | 신규 (2,500줄) |
| `web/arm_server.py` | 4,509→1,843줄 (2,666줄 제거, import 교체) |
| `CLAUDE.md` | 1M 컨텍스트 추천 규칙 추가 |
| `docs/project-status.md` | P8 완료 반영 |
| `docs/todo/BACKLOG.md` | P8 완료 체크 |
| `docs/todo/2026-02-28.md` | P8 기록 추가 |

## 리팩토링 전체 현황
| Phase | 모듈 | 줄수 | 빌드 |
|-------|------|------|------|
| P1 | config_loader.py | 343 | #656 |
| P2 | debug_handler.py | 591 | #658 |
| P3 | argos_handler.py | 505 | #659 |
| P4 | argos_collector.py | 1,026 | #660 |
| P5 | batch_system.py | 1,808 | #663 |
| P6 | trading_engine.py | 2,830 | #665 |
| P7 | scheduler.py | 508 | #667 |
| **P8** | **agent_router.py** | **2,500** | **진행중** |
| 합계 | 8개 모듈 | 10,111 | — |
