# 자율 운영 시스템 v3.00.000 구현

## 버전
`3.00.000`

## 작업 날짜
2026-02-18

## 작업 브랜치
`claude/autonomous-system-v3`

---

## 변경 사항 요약

### 이번 세션에서 구현한 것 4가지

---

### 1. 에이전트 장기 기억 (Agent Memory)

**무엇을 했는가?**
에이전트들이 CEO와의 대화를 기억해서 다음 대화에 활용하도록 구현.

**구체적 변경:**
- `web/mini_server.py` — `_extract_and_save_memory()` 함수 추가
  - 대화 후 Haiku(저렴한 모델)로 중요한 정보 자동 추출
  - CEO 취향, 중요 결정, 주의사항, 맥락 등 4가지 카테고리로 분류
  - SQLite DB(`settings` 테이블 `memory_categorized_{agent_id}` 키)에 영구 저장
- `web/mini_server.py` — `_call_agent()` 함수 수정
  - AI 호출 전에 해당 에이전트 기억을 DB에서 불러와 system_prompt 앞에 삽입
  - 기억이 없으면 영향 없음 (기존 동작 유지)
  - 대화 완료 후 자동으로 기억 추출 작업을 백그라운드로 실행

**비유:** 지금까지는 매 대화마다 기억이 초기화되는 직원 → 이제는 수첩에 메모해두고 다음에 활용하는 직원

---

### 2. 에이전트 토론 시스템 (Agent Debate)

**무엇을 했는가?**
CEO가 `/토론` 또는 `/심층토론` 명령을 입력하면 처장 6명이 다단계 토론을 진행하고 비서실장이 결론을 정리.

**구체적 변경:**
- `web/mini_server.py` — `DEBATE_ROTATION` 순서 테이블 추가
  - 3가지 순서 로테이션으로 균등하게 발언 기회 분배
- `web/mini_server.py` — `_call_agent_debate()` 함수 추가
  - 토론용 에이전트 호출 (주제 + 이전 발언들 + 추가 지시 포함)
- `web/mini_server.py` — `_broadcast_with_debate()` 함수 추가
  - 라운드 1: 처장 6명 병렬 독립 의견 (서로 모름)
  - 라운드 2+: 처장 6명 순차 재반박 ("동의합니다" 절대 금지)
  - 최종: 비서실장이 합의점/이견/권고사항 정리
  - 전체 토론 내역은 접기/펼치기 버튼으로 제공
- `web/mini_server.py` — `/토론`, `/심층토론` 명령어 처리 추가
  - `/토론 [주제]` → 2라운드 토론
  - `/심층토론 [주제]` → 3라운드 심층 토론
  - `/명령어` 도움말에도 추가됨

**비유:** 지금까지는 각 처장이 독립 보고서 제출 → 이제는 처장들이 서로 반박하는 임원 회의

---

### 3. 처장 토론 방법론 태그 (agents.yaml 업데이트)

**무엇을 했는가?**
토론 시 각 처장이 자기 부서 관점의 구체적인 태그를 사용하도록 Soul(system_prompt) 업데이트.

| 처장 | 필수 태그 |
|------|---------|
| CTO (기술개발처장) | [기술판정] [개발공수] [확장성] |
| CSO (사업기획처장) | [리스크시나리오] [발생확률] [대응책] |
| CLO (법무·IP처장) | [법적리스크] [준수여부] [권고사항] |
| CMO (마케팅·고객처장) | [채널] [전환율] [CAC] [LTV] |
| CIO (투자분석처장) | [ROI] [리스크등급] [예상수익] |
| CPO (출판·기록처장) | [우선순위] [사용자가치] [운영비용] |

**수정된 파일:** `config/agents.yaml` — 처장 6명 system_prompt 끝부분에 추가

---

### 4. 사령실 UI 업데이트 (index.html)

**무엇을 했는가?**
새로운 명령어와 기능을 UI에 반영.

**구체적 변경:**
- 슬래시 명령어 자동완성에 `/토론` (🗣️), `/심층토론` (💬) 추가
- WebSocket 핸들러에 `proactive_message` 이벤트 처리 추가
  - 스케줄러가 자동 보고할 때 채팅창에 특별 표시 (🤖 자동 보고)
  - 토스트 알림으로 "자동 보고 도착" 표시

---

### 이미 구현되어 있던 것 (변경 없음)

| 기능 | 상태 | 위치 |
|------|------|------|
| 스케줄러 (능동적 에이전트) | ✅ 기존 구현됨 | `_cron_loop()` 라인 2761 |
| 워크플로우 빌더 | ✅ 기존 구현됨 | `/api/workflows` + 자동화 탭 |
| 에이전트 기억 API | ✅ 기존 구현됨 | `/api/memory/{agent_id}` |
| 배치 처리 (비동기 작업) | ✅ 기존 구현됨 | `/api/batch` |

---

## 현재 상태

| 기능 | 상태 |
|------|------|
| 에이전트 장기 기억 | ✅ 구현 완료 — 자동 추출 + 주입 |
| 에이전트 토론 시스템 | ✅ 구현 완료 — `/토론`, `/심층토론` |
| 처장 방법론 태그 | ✅ 구현 완료 — 6명 전원 |
| 사령실 UI | ✅ 구현 완료 — 슬래시 명령어 추가 |

---

## 수정된 파일

| 파일 | 변경 내용 |
|------|---------|
| `web/mini_server.py` | `_extract_and_save_memory()` + 기억 주입 + `_broadcast_with_debate()` + 토론 명령어 |
| `web/db.py` | `async_tasks` 테이블 추가 (향후 확장용) |
| `config/agents.yaml` | 처장 6명 토론 방법론 태그 추가 |
| `web/templates/index.html` | /토론 슬래시 명령어 + proactive_message 핸들러 |

---

## 사용 방법

### 에이전트 토론
```
사령실에서 입력:
/토론 CORTHEX의 다음 분기 전략 방향
→ 처장 6명이 2라운드 토론 후 비서실장이 종합 보고

/심층토론 AI 서비스 출시 시기
→ 처장 6명이 3라운드 심층 토론 후 비서실장이 종합 보고
```

### 에이전트 기억
- 자동: 대화 후 중요한 정보가 자동으로 저장됨
- 수동 확인: 에이전트 클릭 → "기억" 버튼으로 기억 내용 조회/추가/삭제

---

## 다음에 할 일

1. **테스트**: `/토론` 명령어 실제 테스트 (사령실에서 입력)
2. **HTTPS 확인**: `https://corthex-hq.com` 접속해서 자물쇠 표시 확인
3. **비동기 작업 큐 UI**: async_tasks 테이블은 있으나 전용 UI 미구현 (향후)

---

## 전문 용어 해설

| 용어 | 쉬운 설명 |
|------|---------|\
| 장기 기억 | 에이전트가 이전 대화 내용을 기억해서 다음에 활용하는 것 |
| 토론 라운드 | 처장들이 순서대로 의견을 내는 횟수. 2라운드 = 의견 + 반박 |
| 방법론 태그 | 처장이 토론 시 자기 분야 관점으로 분석했다는 구체적 표시 |
| system_prompt | AI에게 "너는 이런 역할이야"라고 알려주는 사전 지시문 |
| Soul | CORTHEX에서 각 에이전트의 system_prompt를 부르는 이름 |
