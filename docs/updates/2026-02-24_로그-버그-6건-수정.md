# 2026-02-24 로그 시스템 버그 6건 수정

> **영향 범위**: 전략실(CIO)뿐 아니라 **모든 부서**(CSO/CMO/CPO)에 동일하게 적용되는 공통 로그 시스템 버그.
> 대표님 지시: "전략실 뿐 아니라 모든 부서 문제가 되는거의 작은 축소판이니까 원인이랑 어떻게 해결하는지 등등 구체적이고 자세하게 기록해놔"

---

## 버그 목록 요약

| # | 버그 | 파일 | 근본 원인 | 영향 부서 |
|---|------|------|----------|----------|
| 1 | COMMS LOG 중복 표시 | corthex-app.js | 3중 데이터 소스 + ID 형식 불일치 | 전체 |
| 2 | 전략실 활동로그 실시간 미반영 | corthex-app.js | WS→trading 라우팅 누락 | CIO |
| 3 | 전략실 활동 0건 표시 | corthex-app.js | 버그#2와 동일 원인 | CIO |
| 4 | 통신로그 개수 불일치 | index.html + corthex-app.js | 비배타적 카테고리 + null safety | 전체 |
| 5 | 활동로그 삭제 실패 | activity_handler.py | 테이블명 오타 (단수/복수) | 전체 |
| 6 | QA D1 허위 판정 | mini_server.py | 도구 사용 기록 미전달 | 전체 |

---

## 버그#1: COMMS LOG (사령관실 교신로그) 중복 표시

### 증상
- 사령관실 교신로그에 동일한 메시지가 2~3번 중복 표시
- 대표님이 분석 모니터링 중 스크린샷으로 보고

### 근본 원인: 3중 데이터 소스 + ID 형식 불일치

교신로그(`delegationLogs`)에 데이터가 들어오는 경로가 **3개**:

```
① REST API (/api/comms/messages)  → 초기 로딩 시 (ID 형식: "dl_951")
② SSE (/api/comms/stream)         → 실시간 push (ID 형식: 951)  ← 원본 숫자
③ WebSocket (delegation_log_update) → 실시간 push (ID 형식: 951)  ← 원본 숫자
```

**문제**: 중복 방지 로직이 `id`로 비교하는데, REST는 `"dl_951"`, SSE/WS는 `951`로 형식이 다름.
```javascript
// 기존 코드 — 이 비교가 실패함
if (!this.delegationLogs.find(l => l.id === msg.id))  // "dl_951" !== 951 → 중복 삽입!
```

### 해결: ID 정규화 (dl_ 접두사 통일)

**SSE 핸들러** (`_connectCommsSSE()` 내부):
```javascript
// ID 정규화: REST는 "dl_123" 형식, SSE/WS는 123 원본 → dl_ 접두사 통일
const rawId = msg.id;
const dlId = String(rawId).startsWith('dl_') ? rawId : 'dl_' + rawId;
msg.id = dlId;
// 중복 방지 — 원본 ID + dl_ 접두사 ID 모두 체크
if (!this.delegationLogs.find(l => l.id === dlId || l.id === rawId)) {
```

**WebSocket 핸들러** (`connectWebSocket()` 내부):
```javascript
const wsId = 'dl_' + (msg.data.id || '');
msg.data.id = wsId;  // REST/SSE 형식과 통일
if (!this.delegationLogs.find(l => l.id === wsId)) {
```

### 교훈
- **여러 실시간 채널이 같은 데이터를 보낼 때, ID 형식을 통일**해야 함
- REST API가 `dl_` 접두사를 붙이는 이유: `delegation_log`와 `cross_agent_messages` 테이블의 ID가 겹칠 수 있어서 구분용으로 접두사 사용
- SSE/WS는 DB 원본 ID를 그대로 보내므로 프론트에서 정규화 필요

---

## 버그#2+3: 전략실 활동로그 실시간 미반영 + 활동 0건

### 증상
- 전략실 탭의 활동로그가 분석 중에도 0건 표시
- 다른 탭 갔다 돌아와야 데이터가 보임 (새로고침 필요)

### 근본 원인: WebSocket → trading 라우팅 누락

WebSocket `activity_log` 이벤트 핸들러가 **사령관실(`delegationLogs`, `cioLogs`)에만** 데이터를 추가하고, **전략실(`trading.activityLog.logs`)에는 라우팅하지 않음**.

```
WS activity_log 이벤트
  ├→ delegationLogs (사령관실 교신) ✅ 추가됨
  ├→ trading.cioLogs (사령관실 CIO) ✅ 추가됨
  └→ trading.activityLog.logs (전략실) ❌ 누락!
```

x-show→x-if 전환(Step 5 최적화) 이후, 전략실 탭은 **열릴 때 DOM이 새로 생성**됨.
하지만 `trading.activityLog.logs` 배열이 WS로 갱신되지 않으니, 탭을 열어도 빈 배열.

### 해결: WS 핸들러에 CIO 에이전트 감지 + trading 라우팅 추가

```javascript
// WebSocket activity_log 핸들러 추가분
const cioAgents = ['cio_manager', 'stock_analysis', 'market_condition',
                   'technical_analysis', 'risk_management'];
const aid = (msg.data.agent_id || '').toLowerCase();
if (cioAgents.some(k => aid.includes(k))) {
    const alId = 'al_' + (msg.data.timestamp || Date.now());
    if (!this.trading.activityLog.logs.find(l => l.id === alId)) {
        this.trading.activityLog.logs.unshift({
            id: alId, type: 'activity',
            sender: msg.data.agent_id || '',
            message: msg.data.action || msg.data.message || '',
            level: msg.data.level || 'info',
            time: new Date().toISOString(),
        });
        // 100건 초과 방지
        if (this.trading.activityLog.logs.length > 100)
            this.trading.activityLog.logs = this.trading.activityLog.logs.slice(0, 100);
    }
}
```

### 교훈
- **x-if 전환 후에는 탭 데이터가 반응형 배열에 의존** → WS/SSE가 해당 배열을 갱신해야 함
- x-show 시절에는 DOM이 항상 존재해서 REST 폴링만으로 충분했음
- **새 부서 탭 추가 시에도 동일 패턴 적용 필요** (CSO/CMO/CPO 각각의 activityLog 라우팅)

---

## 버그#4: 통신로그 개수 불일치 (전체 66 ≠ 위임4+보고0+검수0+도구60)

### 증상
- 전략실 통신로그 상단 통계: 전체 66건인데 위임(4)+보고(0)+검수(0)+도구(60) = 64
- 2건이 어디에도 안 잡힘

### 근본 원인: 2가지

**원인 A — 비배타적 카테고리**:
기존 카테고리(위임/보고/검수/도구)가 서로 겹칠 수 있었음.
예: 한 로그가 `type: 'delegation'`이면서 `level: 'tool'`이면 위임+도구 양쪽에 카운트.
반대로, `type: 'activity'`이면서 `level: 'info'`인 로그는 어디에도 안 잡힘.

**원인 B — `tools` null safety 누락**:
```javascript
// 기존 코드 — l.tools가 undefined면 에러
logs.filter(l => l.tools.length > 0)  // TypeError: Cannot read 'length' of undefined
```

### 해결

**A. 배타적 카테고리로 변경** (index.html):
```
전체 = 모든 로그
활동 = delegation/report/qa/tool이 아닌 나머지
교신 = type이 delegation 또는 report
검수 = level이 qa_pass 또는 qa_fail
도구 = level이 tool
```

이렇게 하면 `전체 = 활동 + 교신 + 검수 + 도구` 항등식 성립.

**B. null safety 추가** (corthex-app.js):
```javascript
// 수정 후
logs.filter(l => (l.tools || []).length > 0 || l.level === 'tool')
```

### 교훈
- **통계 카드의 카테고리는 반드시 배타적(mutually exclusive)**이어야 합계가 맞음
- Alpine.js 인라인 표현식에서는 null safety를 꼭 챙길 것 (`|| []`, `|| ''`)

---

## 버그#5: 활동로그 삭제 API 실패 (테이블명 오타)

### 증상
- 대표님이 활동로그를 지운 적 없는데 "활동 0건" 표시
- 실제로는 삭제 API 자체가 실패하고 있었음 (오류가 조용히 무시됨)

### 근본 원인: 테이블명 단수/복수 불일치

```python
# activity_handler.py — DELETE API
conn.execute("DELETE FROM activity_log")     # ← 'activity_log' (단수) 🔴 틀림!

# db.py — CREATE/INSERT/SELECT
"CREATE TABLE IF NOT EXISTS activity_logs"   # ← 'activity_logs' (복수) ✅ 정답
```

`activity_handler.py`의 DELETE 문 4곳 모두 `activity_log`(단수)로 작성되어 있었음.
SQLite는 존재하지 않는 테이블에 DELETE하면 에러를 발생시키지만, 핸들러의 `except`가 이를 삼켜서 `{"success": False}` 반환만 함.

### 해결: 테이블명 통일 (replace_all)

```python
# 수정 전
"DELETE FROM activity_log WHERE ..."
# 수정 후
"DELETE FROM activity_logs WHERE ..."
```

4곳 모두 `activity_log` → `activity_logs`로 일괄 변경.

### 부가 발견: 자동 정리(auto-pruning) 기능
`db.py` 700~707줄에 activity_logs가 1000건 초과 시 자동 삭제 로직이 있음.
대표님이 지우지 않았는데 로그가 사라진 것은 이 기능 때문일 수 있음.

### 교훈
- **테이블명은 프로젝트 전체에서 검색(`grep`)하여 일관성 확인** 필수
- `except: pass` 패턴은 버그를 숨김 → 최소한 로그 남길 것
- 새 핸들러 작성 시 `db.py`의 테이블명을 반드시 확인

---

## 버그#6: QA D1 판정 허위 (도구 사용했는데 "미사용" 판정)

### 증상
- 전문가가 도구를 40회 이상 호출했는데, QA가 "D1 불합격 — 도구 미사용" 판정
- 대표님 지적: "gpt가 도구를 안쓴게 아니라, CIO가 도구를 안썼다고 판단한거일수 있어"

### 근본 원인: QA 리뷰어에게 도구 사용 기록이 전달되지 않음

```
전문가 분석 실행
  ├→ 보고서 텍스트 작성 (content)
  └→ 도구 호출 기록 (activity_logs에 저장)

QA 검수 호출
  └→ content만 전달됨 ← 도구 기록은 빠짐!
```

QA 리뷰어(AI)는 보고서 텍스트만 보고 판단함.
보고서에 "도구로 데이터를 가져왔다"는 언급이 없으면 D1 불합격 처리.
실제로는 `activity_logs`에 도구 호출 40건이 기록되어 있었음.

### D1 기준 (quality_rules.yaml)
```yaml
D1: "도구(API)로 가져온 실시간 시장 데이터를 분석에 활용하고 있는가?
     ※도구 호출 기록이 있으면 통과"
```

"도구 호출 기록이 있으면 통과"라고 명시했지만, 그 기록 자체가 QA에 안 갔음.

### 해결: QA content에 도구 사용 기록 첨부 (mini_server.py)

```python
# 전문가 결과의 tools_used를 QA content에 추가
_qa_content = content
_spec_tools = result_data.get("tools_used", [])
if _spec_tools:
    _unique_tools = list(dict.fromkeys(_spec_tools))
    _qa_content += (
        f"\n\n---\n## 사용한 도구 ({len(_spec_tools)}건, 고유 {len(_unique_tools)}개)\n"
        + ", ".join(_unique_tools)
    )
# _qa_content를 hybrid_review에 전달
```

이제 QA 리뷰어는 보고서 + 도구 사용 요약을 함께 보고 D1 판정.

### 교훈
- **QA 리뷰어에게 판단 근거를 충분히 제공**해야 함 (보고서만으론 부족)
- 이 문제는 **모든 부서에 동일 적용** — CSO/CMO/CPO 전문가도 같은 `_manager_with_delegation()` 경로를 타므로 자동 수정됨
- **"AI가 AI를 평가할 때, 평가 대상의 모든 증거를 전달"**하는 게 핵심 원칙

---

## 수정 파일 요약

| 파일 | 수정 내용 | 버그 번호 |
|------|----------|----------|
| `web/static/js/corthex-app.js` | SSE/WS ID 정규화, WS→trading 라우팅, tools null safety | #1, #2, #3, #4 |
| `web/templates/index.html` | 통계 카드 배타적 카테고리, 서브탭 null safety | #4 |
| `web/handlers/activity_handler.py` | `activity_log` → `activity_logs` (4곳) | #5 |
| `web/mini_server.py` | QA content에 tools_used 첨부 | #6 |

---

## 미해결 과제: CIO 독자 분석 워크플로우

대표님 지적: "전원 실패하던 말던 CIO는 독자분석/툴사용을 했어야해"

현재 CIO는 전문가 보고서를 **종합만** 함. 전문가가 전원 실패하면 종합할 게 없어서 CLASSIFIED(기밀문서)에 보고서 0건.

**개선 방향** (별도 작업):
- CIO가 전문가 결과와 **별개로** 자체 도구 호출(시세 조회, 재무 데이터 등) 수행
- 전문가 전원 실패해도 CIO 독자 분석 보고서 작성
- CLASSIFIED에 최소 1건(CIO 독자 보고서)은 항상 보관

이 건은 backend 로직 변경이 필요하여 별도 브랜치에서 작업 예정.
