# CORTHEX HQ 리팩토링 가이드

> **이 문서의 목적**: 리팩토링이 뭔지, 왜 하는지, 어떻게 하는지를 **비개발자도 알 수 있게** 설명합니다.
> 기술 계획서(무엇을 할지)와 비개발자 설명(왜/어떻게/뭐가 좋아지는지)을 함께 담았습니다.

---

## 1. 리팩토링이 뭔가요?

**한마디로: 방 청소입니다.**

집에 살면서 물건이 점점 쌓이잖아요? 기능은 다 있어요 — 옷도 있고, 책도 있고, 식기도 있고.
그런데 옷이 부엌에도 있고 거실에도 있고, 책이 침실에도 있고 화장실에도 있으면... 찾기 어렵고 정리하기도 어렵죠.

**리팩토링 = "옷은 옷장에, 책은 책장에, 식기는 주방에" 정리하는 것.**

- 기능은 그대로입니다 (옷을 버리는 게 아니에요)
- 위치만 바꿉니다 (찾기 쉽게)
- 사용자가 느끼는 변화는 없습니다 (겉모습 동일)

---

## 2. 왜 지금 해야 하나요?

### 현재 문제: mini_server.py가 너무 비대합니다

| 비유 | 현재 상태 |
|------|----------|
| 비유 | 사무실 1개에 29명 직원 + 모든 서류 + 전화기 + 복사기가 다 들어있는 상태 |
| 실제 | `mini_server.py` 파일 하나에 8,500줄의 코드. 모든 기능이 다 여기에 |

### 이게 왜 문제인가요?

1. **버그 찾기 어려움**: 8,500줄 중에서 문제 찾기 = 사전에서 오타 찾기
2. **고치다 다른 거 깨짐**: 매매 기능 고치다가 채팅이 안 되는 상황 (책상 옮기다 전화선 뽑힌 것)
3. **동시 작업 불가**: 두 명이 같은 파일을 동시에 수정하면 충돌 (좁은 방에 두 사람이 동시에 청소)
4. **새 기능 추가 어려움**: 새 직원 들어올 자리가 없음 (방이 꽉 차서)

### 구체적 숫자

| 항목 | 리팩토링 전 | 리팩토링 후 (목표) |
|------|-----------|-----------------|
| mini_server.py 줄 수 | 8,500줄 | ~3,000줄 (65% 감소) |
| 파일 1개당 평균 줄 수 | 8,500줄 (1파일) | ~300줄 (여러 파일) |
| 같은 코드 반복 횟수 | 30곳+ | 0곳 (헬퍼로 통합) |
| 전역변수 (아무데서나 바꿀 수 있는 값) | 44개 | 0개 (AppState로 관리) |

---

## 3. 어떻게 하나요? (14단계 계획)

### 비유: 이사 없이 리모델링하기

아파트에 살면서 리모델링하는 것과 같습니다.
- 한 방씩 정리합니다 (전체를 한 번에 뒤집지 않음)
- 매 단계마다 "집이 정상 작동하는지" 확인합니다 (수도, 전기 되는지)
- 문제 생기면 바로 원래대로 되돌립니다

### 14단계 요약

| 단계 | 비유 | 실제 작업 | 상태 |
|------|------|----------|------|
| **Step 1** | 방송실 만들기 | 30곳에 흩어진 "전체 알림" 코드 → `ws_manager.py` 1곳으로 | ✅ 완료 |
| **Step 2** | 관리사무소 만들기 | 44개 흩어진 설정값 → `AppState` 한 곳으로 | ⬜ 다음 |
| **Step 3** | 전화교환실 만들기 | 80개+ API 주소(엔드포인트) → 분야별 파일로 분리 | ⬜ 예정 |
| **Step 4** | 인사과 분리하기 | 에이전트 관리 코드 → `agent_manager.py`로 | ⬜ 예정 |
| **Step 5** | 채팅방 분리하기 | 대화 처리 코드 → `chat_handler.py`로 | ⬜ 예정 |
| **Step 6** | 증권사 분리하기 | 투자/매매 코드 → `trading/` 폴더로 | ⬜ 예정 |
| **Step 7** | 일정관리실 분리하기 | 예약/자동화 코드 → `scheduler/` 폴더로 | ⬜ 예정 |
| **Step 8** | 뉴스룸 분리하기 | 콘텐츠/SNS 코드 → `content/` 폴더로 | ⬜ 예정 |
| **Step 9** | 미들웨어 정리 | 인증/보안/로깅 코드 → `middleware/`로 | ⬜ 예정 |
| **Step 10** | 시작 절차 정리 | 서버 시작 코드 → `startup.py`로 | ⬜ 예정 |
| **Step 11** | 설정 파일 통합 | 여러 설정 → `config.py` 한 곳으로 | ⬜ 예정 |
| **Step 12** | 타입 힌트 추가 | 데이터 형식 명확하게 (빈칸 채우기) | ⬜ 예정 |
| **Step 13** | 테스트 작성 | 각 기능별 자동 테스트 (검사관 고용) | ⬜ 예정 |
| **Step 14** | 최종 정리 | import 정리, 불필요 코드 제거 | ⬜ 예정 |

### Step 1 상세: 뭘 했는가?

**문제**: mini_server.py 안에 "모든 접속자에게 메시지 보내기" 코드가 **30곳**에 복사-붙여넣기 되어 있었습니다.

```
비유: 학교에서 전교생한테 안내방송을 하려면 방송실에서 마이크로 한 번만 말하면 되는데,
     지금은 교실 30개를 일일이 돌아다니면서 같은 말을 반복하고 있는 상태.
```

**해결**: `ws_manager.py`라는 "방송실"을 만들었습니다.
- `wm.broadcast("이벤트명", 데이터)` — 한 줄로 전체 방송
- `wm.send_agent_status(...)` — 에이전트 상태 표시등 제어
- `wm.send_cost_update(...)` — 비용 알림
- `wm.send_delegation_log(...)` — 업무 위임 기록

30곳의 복사-붙여넣기 코드가 → 각각 1줄의 함수 호출로 줄었습니다.

---

## 4. 위험은 없나요?

| 걱정 | 답변 |
|------|------|
| 기능이 바뀌나요? | 아니요. 겉으로 보이는 건 100% 동일합니다 |
| 서비스가 중단되나요? | 아니요. 매 단계마다 배포 후 서버 확인합니다 |
| 되돌릴 수 있나요? | 네. git으로 언제든 이전 상태로 복원 가능합니다 |
| 비용이 드나요? | 코드 정리만이라 추가 비용 없습니다 |
| 얼마나 걸리나요? | 14단계를 1~2단계씩 진행. 각 단계는 1세션 |

---

## 5. 뭐가 좋아지나요?

리팩토링 완료 후:

1. **버그 수정 빨라짐**: "매매 버그"면 `trading/` 폴더만 보면 됨 (8,500줄 뒤지기 → 300줄만 확인)
2. **새 기능 추가 쉬움**: 새 부서 추가 = 새 파일 추가 (기존 코드 안 건드림)
3. **동시 작업 가능**: 팀장/팀원이 다른 파일을 동시에 수정해도 충돌 없음
4. **테스트 가능**: 방송실이 잘 되는지, 인사과가 잘 되는지 각각 검사 가능
5. **코드 이해 쉬움**: 새 개발자(또는 미래의 Claude)가 와도 바로 파악 가능

---

*이 문서는 리팩토링 진행에 따라 업데이트됩니다. 마지막 수정: 2026-02-23*
