# CORTHEX HQ - 프로젝트 현재 상태

> **이 파일의 목적**: 클로드가 새 세션을 시작하거나 대화 기억이 리셋될 때, 이 파일을 읽으면 "프로젝트가 지금 어디까지 진행됐는지"를 바로 파악할 수 있도록 하는 파일입니다.
>
> **규칙**: 매 작업이 끝날 때마다 이 파일을 업데이트할 것.

---

## 마지막 업데이트

- **날짜**: 2026-02-25
- **버전**: `3.02.031`
- **최신 빌드**: PR #577 (auto-merge 대기)
- **작업 브랜치**: claude/credit-fallback
- **접속 주소**: https://corthex-hq.com

---

## ✅ 완료 — AI 크레딧 소진 자동 폴백 (2026-02-25)

> Anthropic 크레딧 소진(400 에러) 시 Google/OpenAI로 자동 전환

- **문제**: 크레딧 떨어지면 전 에이전트 작동 중단, 다른 프로바이더로 전환 안 됨
- **수정**: 400 credit 에러 감지 → `mark_provider_exhausted()` → 세션 동안 소진 프로바이더 건너뜀
- **리셋**: 충전 후 `/api/debug/reset-exhausted-providers` 호출
- 상세: `docs/updates/2026-02-25_크레딧소진-자동폴백.md`

---

## ✅ 완료 — 긴급 버그 4건 + 사유 특정 재검수 (2026-02-25)

> PR #575: CIO 타임아웃/CSO 무단스폰/검수 D1/크론삭제
> PR #576: 반려 항목만 재평가, 통과 항목 점수 유지

- **CIO 타임아웃**: 300→600초
- **CSO 무단 스폰**: CSO→CIO 기본 크론 변경
- **QA D1 전원 불합격**: D1 기준 "도구사용→논리연결"로 변경
- **크론 삭제 안 됨**: deleted_schedules DB 기록
- **사유 특정 재검수**: `targeted_hybrid_review()` — D1, Q3 등 반려 항목만 재채점

---

## ✅ 완료 — NEXUS 대개편 (2026-02-25)

> 설계실 → NEXUS 리브랜딩. 풀스크린 오버레이 + 3D 시스템 맵 + 캔버스

- **2D 에디터 제거** → 3D 시스템 맵 + 비주얼 캔버스 2모드
- **3D 시스템 맵**: 70+ 노드 (7카테고리) SpriteText 라벨, 에이전트 클릭 → 사령관실
- **풀스크린 오버레이**: 헤더 4번째 버튼 (채팅/사무실/대시보드/NEXUS), ESC 닫기
- **캔버스 dblclick**: 노드 이름 인라인 편집
- **조직도 탭 삭제** (NEXUS 3D가 대체)
- 설계 문서: `docs/architecture/nexus-design.md`

---

## ✅ 완료 — 블라인드 채점 기반 전체 품질 개선 (2026-02-25)

> 13 Phase 대형 프로젝트. 아키텍처: `docs/architecture/quality-improvement/`

| Phase | 상태 | 내용 |
|-------|------|------|
| 0 | ✅ | 아키텍처 문서 6개 + CLAUDE.md 규칙 + CEO 아이디어 #008~#012 |
| 1 | ✅ | Soul/YAML 7개 파일 (BLUF + 도구출력 + 차트 + CTO dormant) |
| 2 | ✅ | 스폰 필터링 — 같은 부서=직접, 다른 부서=처장 경유, dormant 차단 |
| 3 | ✅ | 반려/재작업/학습 — 교신로그+기밀문서+warnings 자동 저장 |
| 4 | ✅ | 검수 로그 통합 — 전문가당 1건 + 아이콘 구분 |
| 5 | ✅ | 로그 소실 — 프론트 300건 + DB 5,000건 |
| 6 | ✅ | 배포 완료 (빌드#552) |
| 7 | ✅ | 모의투자 활성화 — 기본값 변경 + 3단 라디오 UI (빌드#554) |
| 8 | ✅ | CIO 7단계 — 독자분석+전문가 각각 기밀문서 저장 |
| 10 | ✅ | Soul 자동 진화 크론 — 매주 일요일 03:00 warnings 분석 + 제안 + 대표님 승인 |
| 11 | ✅ | 품질 대시보드 — quality_reviews 타임라인 + Chart.js 시간 추이 + 반려 Top 5 |
| 12 | ✅ | 부서 간 협업 로그 — collaboration_logs DB + 리다이렉트 시 자동 기록 + API |
| 13 | ✅ | 테스트 25건 — test_spawn_filter.py (13건) + test_rework.py (12건) 전체 통과 |

### Phase 10~13 수정 파일
- `web/handlers/soul_evolution_handler.py` — Soul 진화 API (신규)
- `web/handlers/quality_handler.py` — 품질 점수 타임라인 + 반려 Top N API
- `web/handlers/activity_handler.py` — 협업 로그 API
- `web/mini_server.py` — Soul 진화 크론 등록 + 협업 로그 콜백
- `web/db.py` — collaboration_logs 테이블 + 타임라인/협업 쿼리 함수
- `web/static/js/corthex-app.js` — Soul 진화 + 품질 대시보드 UI
- `web/templates/index.html` — 전력분석 탭에 품질 대시보드 + Soul 진화 섹션
- `src/tools/cross_agent_protocol.py` — 협업 로그 콜백 등록 + 리다이렉트 시 기록
- `tests/test_spawn_filter.py` + `tests/test_rework.py` — 테스트 25건 (신규)

---

## ✅ 로그 시스템 버그 6건 수정 (2026-02-24 야간)

> 전략실 CIO 분석 모니터링 중 대표님이 6건 발견. **전 부서 공통 영향**.

| # | 버그 | 수정 파일 |
|---|------|----------|
| 1 | COMMS LOG 중복 표시 (3중 소스 ID 불일치) | corthex-app.js |
| 2 | 전략실 활동로그 실시간 미반영 | corthex-app.js |
| 3 | 전략실 활동 0건 | corthex-app.js (버그#2와 동일) |
| 4 | 통신로그 개수 불일치 (비배타적 카테고리) | index.html + corthex-app.js |
| 5 | 활동로그 삭제 실패 (테이블명 오타) | activity_handler.py |
| 6 | QA D1 허위 판정 (도구 기록 미전달) | mini_server.py |

- 상세: `docs/updates/2026-02-24_로그-버그-6건-수정.md`

---

## ✅ P0 해결 — 전문가 즉사 + QA 허위합격 + CIO 할루시네이션 (2026-02-24)

> **2026-02-23 23:02 KST 발견 → 2026-02-24 00:30 KST 3건 수정 완료**

### 원인 (근본 원인 → 연쇄 실패)
1. **버그#1 (근본 원인)**: `_apply_openai_strict_inline()`이 `_load_tool_schemas()` 내부 지역함수로 정의됐으나 `ask_ai()`에서도 호출 → **NameError** → GPT 모델 전문가 전원 즉사 (0.023초)
2. **버그#2**: 전문가 전원 에러 → 유효 보고서 0건 → QA 반복문 0회 → `failed_specs=[]` → "전원 합격" (허위)
3. **버그#3**: CIO 종합 호출에 `tools` 파라미터 누락 → 도구 없이 상상으로 보고서 작성

### 수정 내역
| 파일 | 수정 |
|------|------|
| `web/ai_handler.py` | `_apply_openai_strict_inline()` 모듈 레벨로 이동 |
| `web/mini_server.py` | QA 유효카운트 0 체크 + 처장 종합 시 도구 전달 |

### 상세 문서
- `docs/updates/2026-02-24_P0-전문가즉사-버그수정.md`

---

## 🔴🔴🔴 CTO(기술개발처) — 동면 상태 🔴🔴🔴

> **2026-02-22 대표님 지시: CTO 부서는 현재 쓸 일이 없어 동면 상태.**
>
> - 리트마스터 연동 없음 → 홈페이지 개선 불가
> - CORTHEX 셀프 접근 불가 → 자체 버그 수정 불가
> - **모델도 미정** (현재 gemini-2.5-flash 임시 배정)
> - 용도가 확정될 때까지 CTO 부서 관련 작업/도구 개발 보류
> - Phase 2의 "CTO 교수급 도구 5개" → **보류**

---

## 🎉 첫 실매매 성공! (2026-02-21 04:38 KST)

**NVDA(엔비디아) 1주 매수 @ $189.115 — KIS 실계좌 체결 완료!**

- CIO(GPT-5.2 Pro)가 5개 종목 자동 분석 → NVDA 매수 판단(신뢰도 74%) → KIS API 주문 → 체결
- CEO가 KIS 앱에서 직접 확인: 보유잔고 1주, +58원(+0.02%)
- 상세 기록: `docs/updates/2026-02-21_첫-실매매-성공.md`

---

## 오늘 완료한 작업 (2026-02-23)

### 리팩토링 14단계 전체 완료

| 빌드 | 내용 |
|------|------|
| PR#493 | **Step 1: 브로드캐스트 헬퍼** — 30곳 반복 → ws_manager.py 1곳 통합 |
| PR#494 | **Step 2: 전역 상태 관리** — 44개 전역변수 → AppState 클래스 1개 |
| PR#495 | **Step 3+4: 메모리 누수 + 에러 핸들링** — TTL 자동 정리, AI 180초 타임아웃, pass 38곳→로깅 |
| PR#497 | **Step 5~7: 핸들러 20개 분리** — 144 endpoints, mini_server.py 11,906→8,527줄 |
| 배포 중 | **Step 8~11: ai_handler 정리 + WS 크기 제한** — 가격 YAML 로드, 도구결과 상수화, 64KB 제한 |
| — | **노션 API 키 corthex.hq로 전환** — elddlwkd 키 제거 |
| — | **CLAUDE.md 정비 + 리팩토링 가이드** — 비개발자용 문서 |
| #485 | **Step 12: index.html 외부 분리** — 10,666줄→6,049줄(-43%), CSS/JS 외부 파일 |
| #487 | **Step 12-2: 반응형 디자인** — 모바일 하단네비+더보기시트, 11개 탭 모바일 최적화, 노치지원 |
| 배포완료 | **Step 13: 멀티턴 대화** — 세션별 대화 분리, 새대화/대화목록/턴카운터, 히스토리 20개·2000자 확장 |
| 배포완료 | **Step 14: 아키텍처 맵** — 조직도(Mermaid.js) + 실시간 현황 + 비용 분석(Chart.js) + 에이전트 클릭→사령관실 |

### 자동매매 버그 수정 6건 (#508, PR#518~519)

| 빌드 | PR | 내용 |
|------|-----|------|
| #508 | PR#518 | **전문가4명 Sonnet전환 + QA도구신뢰 + OpenAI스키마재귀 + ECOS분기버그** |
| #508 | PR#519 | **KIS 거래소코드 EXCG_ID_DVSN_CD=01 + CIO 독자분석에 도구38개 전달** |

### 전략실 매매 버그 수정 + 활동로그 추가

| 빌드 | PR | 내용 |
|------|-----|------|
| #494 | PR#509 | **전략실 매매 4건 버그 수정** — 524 Cloudflare 타임아웃(백그라운드 전환), SVG Alpine 에러(x-for→computed), getAgentInitials null 체크, history 변수명 충돌 |
| #495 | PR#510 | **전략실 활동로그 서브탭 신설** — CIO팀 전용 위임/보고/도구사용 실시간 타임라인, 5개 필터, delegation_log tools_used 수정 |
| #496 | PR#511 | **포트폴리오 svgCircles 따옴표 충돌 수정** — x-data 큰따옴표 충돌 → HTML entity 이스케이프 |

## 🎉 리팩토링 전체 완료! (14단계 중 14단계 완료)

| 단계 | 비유 | 실제 작업 | 상태 |
|------|------|----------|------|
| **Step 1** | 방송실 만들기 | 30곳 → ws_manager.py | ✅ PR#493 |
| **Step 2** | 관리사무소 만들기 | 44개 전역변수 → AppState | ✅ PR#494 |
| **Step 3** | 메모리 청소 | TTL 자동 정리 + AI 타임아웃 | ✅ PR#495 |
| **Step 4** | 에러 잡기 | pass 38곳 → 로깅 | ✅ PR#495 |
| **Step 5~7** | 부서별 분리 | 핸들러 20개, 144 endpoints | ✅ PR#497 |
| **Step 8** | AI 정리 | models.yaml 가격 로드 | ✅ 배포 중 |
| **Step 9** | Config 통합 | deploy.yml에 이미 존재 | ✅ 해결됨 |
| **Step 10~11** | 입력 검증 | WS 64KB 제한, shutdown | ✅ 배포 중 |
| **Step 12** | 인테리어 분리 | index.html CSS/JS 외부 파일화 | ✅ #485 |
| **Step 12-2** | 반응형 인테리어 | 모바일/태블릿 완전 최적화 | ✅ #487 |
| **Step 13** | 대화 세션 분리 | 멀티턴 대화 + 세션 관리 UI | ✅ 배포대기 |
| **Step 14** | 조직도+비용 대시보드 | Mermaid 조직도 + Chart.js 비용 분석 | ✅ 배포대기 |

상세: `docs/REFACTORING_PLAN.md` 참조

---

## 이전 완료 작업 (2026-02-21)

| 빌드 | PR | 내용 |
|------|-----|------|
| 배포 후 | — | **📝 노션 품질 개선** — 제목 필터 강화(죄송/오류 차단), 부서+역할 자동 태그, 출판-마케팅 spawn 소통, Gemini reasoning high, 전역 제목 규칙 |
| 배포 후 | — | **💰 모델 비용 최적화** — 29명 에이전트 모델 재배치 (Opus 4→1명, Gemini 13명), 추론레벨 최적화, 권장 버튼 복귀 버그 수정 |
| 배포 후 | — | **📱 텔레그램 봇 수정 + schedule_tool** — /start 무반응 수정, 일정보좌관 크론 CRUD 도구, 크론 표현식 파서, 이름 검색 |
| 배포 후 | — | **📰 뉴스 브리핑 크론** — 매일 09:00 '예비창업자패키지'+'모두의 창업' 뉴스 검색→AI 요약→텔레그램 발송 |
| 배포 후 | — | **📱 텔레그램 자동 보고 + 캘린더 OAuth** — 웹 채팅 응답→텔레그램 자동 전달, 캘린더 도구 OAuth 전환 |
| 배포 후 | — | **📰 콘텐츠 파이프라인 구축** — 분석→작성→편집→CEO승인→발행 자동화 (API 6개 + 대시보드 UI) |
| 배포 후 | — | **🔍 기능 전수검사 9건 수정** — @에이전트 지정 무시 버그 + AI 대화 맥락 이해 추가. 173개 API + 11개 탭 + 5개 핵심 기능 검증 |
| 배포 후 | — | **🔍 코드 전수검사 25건 버그 수정** — 180개 파일 검사, 28개 파일 수정. 모델명/가격/크래시/JSON→DB(12파일)/환율/KIS쿨다운/AGENTS동적로드/config보완 |
| 배포 후 | — | **총자산 이중 계산 수정** — 한국 `total_eval`이 해외자산 포함 → 한국 현금+보유종목만 계산 |
| 배포 후 | — | **관심종목 전체 분석** — `[:10]` 제한 제거, 전 종목 CIO 분석 |
| 배포 후 | — | **CIO 성과 예측 현재가 저장** — 검증 기준가 추가 + 에러 로깅 |
| #394 | #416 | **7개 버그 수정** — 교신로그/포트폴리오/CIO성과/기밀문서/모의매매 |
| #388 | #414 | **KIS 국내주식 TR_ID 신버전 교체** — 구TR(TTTC0802U) → 신TR(TTTC0012U). 매매 안 된 핵심 원인 |
| #392 | #414 | **통신로그 버그 5건 수정** — 활동로그/교신로그/P2P ID/폴링 노이즈 |

## 이전 작업 (2026-02-20 저녁 세션)

| 빌드 | PR | 내용 |
|------|-----|------|
| #366 | #387 | 대시보드 슬리피지 간소화 + 최근거래/교신로그 확대 + 작전일지 삭제 버튼 |
| #367 | #388 | **VECTOR(trading_executor) 도구 구현** — CIO가 직접 매수/매도 주문 실행 |
| #368 | #389 | 포트폴리오 초기화 버튼 추가 |
| #369-370 | #390 | **수동 매매 KIS 실주문 연동** + 가상/실거래 모드 구분 + 주문 모달 한국/미국 선택 |
| 수동배포 | — | KIS 모의투자 키 3개 GitHub Secrets 등록 (MOCK_APP_KEY/SECRET/ACCOUNT) |
| #371 | #395 | 실/모의 비교 탭 레이아웃 변경 → 실거래(한국|미국) / 모의투자(한국|미국) |

### 주요 변경 파일
- `web/kis_client.py` — KIS TR_ID 신버전 교체, 해외 모의투자 매도 TR 수정
- `web/templates/index.html` — 통신로그 통합, 활동로그 SSE 수정, 교신로그 정렬
- `web/mini_server.py` — 폴링 노이즈 스킵, JSON 파싱 에러 처리
- `src/tools/cross_agent_protocol.py` — P2P 에이전트 ID 사전 해석
- `src/tools/trading_executor.py` — VECTOR 도구 (CIO → KIS API 주문)
- `docs/kis-api-reference.md` — KIS 공식 TR_ID 참고 문서 신규

---

## 🔴 CEO 지시 TODO (2026-02-20 저녁 — 자러가기 전 지시)

### Phase 1: 전수검사

CORTHEX HQ 프로그램 전체 전수검사:
- 버그 및 미작동 기능 수정
- @멘션, 크론, 자동화 점검
- 대화 맥락 이해 (에이전트 이전 대화 기억)
- 직원들 자기 작업 기억하게 하기
- batch, 텔레그램 등 각종 기능 점검
- 필요시 아이디어/옵션/추천 후 추천안대로 코딩 (CEO 컨펌 불필요)

### Phase 2: 도구 개발

| 대상 | 수량 | 상세 |
|------|------|------|
| CMO 이미지 생성 도구 | 8개 | Gemini 기반 (기존 gemini_*.py 8개 미커밋 파일 활용) |
| CTO 교수급 도구 | 5개 | 기술개발처 전문 도구 |
| CSO 교수급 도구 | 5개 | 사업기획처 전문 도구 |
| CPO 교수급 도구 | 5개 | 출판·기록처 전문 도구 |
| 비서실 교수급 도구 | 3개 | 비서실 전문 도구 |

### Phase 3: 등록 및 배포

- tools.yaml + agents.yaml 등록
- yaml2json 실행
- 커밋 + 푸시 + 배포
- CEO에게 최종 보고 (이슈 + 수정 내용)

---

## 이전 전수검사 항목 (P2-1 ~ P2-12)

| # | 영역 | 상태 |
|---|------|------|
| P2-1 | decisions 저장 버그 | ✅ JSON→DB 전환 완료 |
| P2-2 | 교신로그 탭 전환 버그 | ✅ 4탭 독립 구조 — 버그 없음 (2/25 전수검사 확인) |
| P2-3 | 교신로그 도구 사용 표시 | ✅ #495 활동로그 서브탭에서 🔧 태그 표시 |
| P2-4 | CIO 독자 분석 병렬 실행 | ✅ asyncio.gather 완전 구현 (Phase 0~8) |
| P2-5 | 새로고침 시 분석 재연결 | ⚠️ SSE 재연결 구현, UI 상태 복원은 낮은 우선순위 |
| P2-6 | 시세 새로고침 SSE (B안) | ⚠️ 30초 폴링만 구현, SSE는 낮은 우선순위 |
| P2-7 | CIO 목표가 산출 | ✅ 프롬프트+파싱+관심종목 반영 완전 구현 |
| P2-8 | 실거래 UI 확대 + 레이아웃 C안 | ✅ 빌드#371에서 레이아웃 변경 |
| P2-9 | 포트폴리오 반영 버그 | ✅ VECTOR + 수동매매 KIS 연동으로 해결 |
| P2-10 | CIO 성과 탭 전수검사 | ✅ trading_handler.py API 8개 존재 (2/25 전수검사 확인) |
| P2-11 | 종목 클릭 차트 (C안 슬라이드패널) | ⚠️ 모달로 구현, 슬라이드패널은 UX 선호 |
| P2-12 | order_size 10,000원 수정 | ✅ 0=CIO 비중 자율 (CLAUDE.md 규칙, 정상) |

---

## CEO 확정 설계 결정 (반복 설명 금지!)

### 실거래 UI C안 (2026-02-20 승인)
- **2행 2열 레이아웃**: 실거래(한국|미국) / 모의투자(한국|미국) — ✅ 빌드#371 적용
- **크기 확대**: 잔고 숫자 text-5xl, 카드 패딩 넉넉하게
- **스크롤 허용**: 카드 하나하나를 크게

### 사령관실 C안 + 전략실 C안 (2026-02-20 승인)
- **사령관실 내부통신 C안**: SSE 상시 + P2P 실시간 + 뱃지 + 네트워크 다이어그램 + 검색/필터
- **전략실 교신로그 C안**: 분석별 그룹핑 + 사령관실 통합 (사령관실 C안 이후)

### 시세/디버그/목표가 (2026-02-20)
- 시세 새로고침 **B안**(SSE) CEO 동의
- 디버그 URL: 어디든 버그 시 그때그때 만들어서 CEO에게 적극 제공
- 관심종목 목표가 무시 → CIO가 분석 후 목표가 산출하도록

### "지금 분석" C안 (2026-02-19 확정)
- 대시보드 "지금 분석" 버튼 → CIO+전문가4명 분석 → 매매 결정 일지 → 전략실 협업로그

---

## GitHub Secrets 현황

| 분류 | Secret 이름 | 상태 |
|------|------------|------|
| KIS 실거래 | APP_KEY, APP_SECRET, ACCOUNT, IS_MOCK | ✅ 등록 |
| KIS 모의투자 | MOCK_APP_KEY, MOCK_APP_SECRET, MOCK_ACCOUNT | ✅ 2026-02-20 등록 |
| AI | ANTHROPIC, OPENAI, GOOGLE, GEMINI | ✅ 등록 |
| 전체 | 50+ 시크릿 | ✅ 완료 |

---

## 프로젝트 기본 정보

- **저장소**: https://github.com/kodonghui/CORTHEX_HQ
- **서버**: Oracle Cloud ARM 24GB (corthex-hq.com)
- **현재 버전**: 3.02.025
- **에이전트**: 29명 (5개 부서)
- **도구**: 89개 등록 (tools.yaml 기준)
- **DB**: SQLite (서버: /home/ubuntu/corthex.db)
- **미커밋**: src/tools/gemini_*.py 8개 (CMO 이미지 도구) + docs/defining-age.md + docs/monetization.md
