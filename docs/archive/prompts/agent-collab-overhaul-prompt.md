# CORTHEX 에이전트 협업 구조 대 개편 — 완전한 맥락 프롬프트

> **사용 방법**: 이 파일을 `/compact` 후 Claude에게 통째로 붙여넣으면 됩니다.
> **작성일**: 2026-02-17 / **버전**: 2.00.000 (이번 작업으로 v2 선언)

---

## ⚠️ 이 프롬프트를 받은 Claude에게

당신은 CORTHEX HQ 프로젝트를 담당하는 Claude입니다.
오늘(2026-02-17) CEO와 약 3시간의 긴 논의를 통해 CORTHEX의 에이전트 시스템을 대 개편하기로 결정했습니다.
아래 내용을 전부 읽고 팀 에이전트를 구성해서 바로 구현을 시작하세요.

**작업 시작 전 반드시 읽을 파일:**
1. `docs/project-status.md` — "🔥 다음 대규모 작업" 섹션 (이 논의의 결론이 요약되어 있음)
2. `web/arm_server.py` 5396~5650번째 줄 (`_MANAGER_SPECIALISTS`, `_delegate_to_specialists`, `_manager_with_delegation`)
3. `src/tools/cross_agent_protocol.py` 전체
4. `web/ai_handler.py` 전체
5. `config/agents.yaml` — `chief_of_staff`, `cto_manager`, `cio_manager` 섹션

---

## 1. 배경: 오늘 CEO와 무엇을 논의했는가

### 출발점
CEO가 "클로드 에이전트 팀 시스템"을 발견하고 CORTHEX에 적용할 수 있는지 물었습니다.

클로드 팀 에이전트 시스템의 핵심 기능:
- 팀원 간 직접 메시지 교환 (SendMessage)
- 공유 태스크 목록 + 자율 분업 (TaskList, TaskUpdate)
- CEO(팀 리드)가 특정 팀원에게 직접 개입 가능
- 에이전트들이 자율적으로 "내가 이 태스크 할게" 선택

CEO가 이 기능들을 보고 "이게 내가 원하던 거야!"라고 했습니다.

### 현재 CORTHEX의 정확한 구조 (코드 기반)

```
CEO 명령 입력
    ↓
arm_server.py 코드가 판단: "이건 CIO에게 줘야겠다"
    ↓
_call_agent("cio_manager", text) — CIO AI 호출
    ↓
arm_server.py 코드가 _MANAGER_SPECIALISTS 딕셔너리 조회:
    cio_manager → [market_condition_specialist, stock_analysis_specialist,
                   technical_analysis_specialist, risk_management_specialist]
    4명 전원 무조건 병렬 호출 (_delegate_to_specialists)
    ↓
전문가 4명 각자 혼자 작업 (서로 소통 절대 불가)
    ↓
CIO가 4개 결과 취합 + 종합 보고서 작성
    ↓
비서실장이 모든 처장 결과 취합 → 최종 보고서 1개
    ↓
CEO가 보고서 1개 받음 ✅
```

**이 구조에서 핵심 파일들:**
- `web/arm_server.py` 5396번째 줄: `_MANAGER_SPECIALISTS` 딕셔너리 (처장 → 전문가 매핑, 코드로 고정)
- `web/arm_server.py` 5570번째 줄: `_delegate_to_specialists()` (처장 → 전문가 병렬 호출)
- `web/arm_server.py` 5592번째 줄: `_manager_with_delegation()` (처장 + 전문가 전체 흐름)
- `src/tools/cross_agent_protocol.py`: 에이전트 간 메시지를 파일에 저장만 함 (실시간 처리 안 됨)

### 현재 시스템의 6가지 한계

1. **코드가 모든 결정권을 가짐**: `arm_server.py` 코드가 "어느 처장에게 줄지", "어떤 전문가를 부를지"를 전부 결정. AI 에이전트는 시킨 것만 함.

2. **처장이 전문가 선택 못함**: CIO 처장이 "이번엔 시황 분석만 필요해, 리스크는 내가 직접 할게"라고 판단해도 불가능. 항상 4명 전원 호출 → 비용 낭비.

3. **처장 ↔ 처장 소통 불가**: CTO처장이 CIO처장에게 "이 기술의 비용 효율은 어떻게 봐?"라고 직접 물어볼 수 없음.

4. **전문가 ↔ 전문가 소통 불가**: 시황분석가가 종목분석가에게 "반도체 섹터 어떻게 봐?"라고 물어볼 수 없음. 서로의 존재 모름.

5. **CEO → 특정 에이전트 직접 개입 불가**: CEO가 "잠깐, 종목분석가야 삼성전자도 봐줘"라고 직접 말할 수 없음. 반드시 비서실장 통해야 함.

6. **cross_agent_protocol 껍데기**: `cross_agent_protocol.py`가 있지만 파일에 메시지 저장만 하고 아무도 실시간으로 읽거나 처리하지 않음. 사실상 작동 안 함.

---

## 2. 논의에서 탐색한 아이디어들 (결론까지의 과정)

이 맥락을 알아야 "왜 이렇게 구현하기로 했는지" 이해 가능.

### 아이디어 A: 소통 채널 추가형 ✅ 채택
- 기존 29명 구조 100% 그대로 유지
- 추가: 처장↔처장 직접 메시지, 전문가↔전문가 직접 질문, CEO→특정 에이전트 직접 개입
- **비유**: 지금 회사에 슬랙(메신저) 깔아준 것. 조직도는 그대로, 소통만 자유로워짐

### 아이디어 B: 프로젝트 팀형 ❌ 폐기
- 프로젝트마다 임시 팀 구성
- **폐기 이유**: 각 에이전트마다 Soul(system_prompt, 성격, 전문성)이 지정되어 있는데, 임시 팀이면 "어떤 Soul을 쓸지" 모호해짐. Soul을 합치거나 버리면 전문성 희석 + 비용 증가.
- **결론**: Soul 유지 + 협력 채널 추가(아이디어 A)로 B의 정신 흡수

### 아이디어 C: 완전 자율형 ❌ 폐기
- 29명이 공유 태스크 게시판에서 자유 선택
- **폐기 이유**: 29개 보고서가 CEO에게 올라올 수 있음. CEO는 "비서실장이 취합한 보고서 1개만 받는 것"이 핵심 설계 원칙.

### 아이디어 C+: 자율 + 보고서 1개 보장 ✅ 채택
- 에이전트들이 자율로 작업하되 비서실장이 최종 취합 → 보고서 1개 유지
- **핵심**: "아래에서 자유롭게 일하고, 위에서 하나로 모아줌"

### 스마트 라우팅: 4단계 복잡도별 자동 조정 ✅ 채택 (신규)
- 지금은 간단한 질문도 처장+전문가 전원 호출 → 비용 낭비
- 질문 복잡도에 따라 다른 규모로 자동 응답
- **기대 효과: AI 비용 평균 60~70% 절감**

---

## 3. 최종 결론: "A + C+ + 스마트 라우팅" 3가지 동시 구현

### 아이디어 A 상세: 소통 채널 추가

**처장 ↔ 처장 직접 소통:**
```
현재: CTO처장과 CIO처장은 서로의 존재 모름. 비서실장 통해서만 간접 전달.

개편 후: CTO처장이 CIO처장에게 직접 메시지:
  "이 AI 시스템 개발비가 500만원인데 투자 수익성 어떻게 봐?"
  CIO처장: "3개월 ROI 계산하면 회수 가능. 진행 추천."
  → 기술 관점 + 투자 관점 동시에 → 훨씬 풍부한 결론
```

**전문가 ↔ 전문가 직접 질문:**
```
현재: 시황분석가와 종목분석가는 서로 결과 못 봄. 각자 혼자 작업.

개편 후: 시황분석가가 종목분석가에게:
  "반도체 섹터 최근 실적 어떻게 봐?"
  종목분석가: "3분기 부진했는데 4분기 반등 예상. 삼성 PER 지금 13배."
  → 시황분석가가 그 정보 포함해서 분석 완성
```

**CEO → 특정 에이전트 직접 개입:**
```
현재: CEO가 중간에 "아 종목분석가야 삼성전자도 봐줘"하면
      비서실장 → CIO처장 → 종목분석가 3단계 거쳐야 함

개편 후: CEO가 종목분석가에게 직접 메시지 → 즉시 반영
```

### 아이디어 C+ 상세: 처장의 자율 전문가 선택

```
현재 (코드가 결정):
  CIO 호출 → _MANAGER_SPECIALISTS["cio_manager"] = 4명 → 항상 전원 호출
  "오늘 코스피 어때?" 같은 간단한 질문도 4명 전부 부름 → 낭비

개편 후 (처장 AI가 결정):
  CIO가 질문 분석:
    "이번엔 시황 분석만 필요해" → 시황분석가 1명만 호출
    "종목 추천인데?" → 시황 + 종목 2명만
    "종합 전략인데?" → 4명 전부
    "이건 내가 직접 처리할게" → 전문가 0명, 처장 혼자
```

**중요**: Soul은 반드시 유지. 처장 AI가 선택권을 갖는 것이지, 에이전트 구조나 Soul을 바꾸는 것이 아님.

### 스마트 라우팅 상세: 4단계 복잡도 자동 판단

```
비서실장이 CEO 질문을 받아서 Level 판단 후 라우팅:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LEVEL 1 | 간단한 질문
예시: "오늘 일정 정리해줘", "지난주 보고서 찾아줘", "회의 잡아줘"
처리: 비서실장이 직접 답변. 처장·전문가 아무도 안 부름.
비용: 극소 (Haiku 1회) / 시간: 2~3초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LEVEL 2 | 전문 지식이 필요한 질문
예시: "이 계약서 검토해줘", "우리 앱 기술 스택 추천해줘", "오늘 코스피 어때?"
처리: 해당 처장 1명만 호출. 처장이 Soul 기반으로 직접 처리. 전문가 안 부름.
비용: 낮음 (Sonnet 1회) / 시간: 10~15초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LEVEL 3 | 깊은 분석이 필요한 질문
예시: "다음달 투자 전략 분석해줘", "경쟁사 분석 보고서 만들어줘"
처리: 처장이 AI 판단으로 필요한 전문가만 선택 호출 (전원 X)
      전문가들 필요시 직접 소통 → 처장 취합 → 비서실장 최종 정리
비용: 중간 / 시간: 30~40초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LEVEL 4 | 전사 협력이 필요한 질문
예시: "연간 사업 계획 수립", "신규 서비스 런칭 전략"
처리: 여러 처장 동시 투입 + 처장끼리 직접 대화하며 협력
      비서실장이 전부 종합
비용: 높음 (필요할 때만) / 시간: 1~2분
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
항상: 비서실장 → CEO에게 최종 보고서 1개
```

**Level 판단 기준 (비서실장 Soul에 추가할 내용):**
- 인사/일정/검색/간단 요청 → Level 1
- 단일 전문 분야 질문 → Level 2
- 분석/보고서/전략 (단일 부서) → Level 3
- 여러 부서 관련 또는 전사 전략 → Level 4

---

## 4. 절대 바꾸면 안 되는 것 (이건 건드리면 큰일남)

1. **Soul 유지**: 각 에이전트의 Soul 파일(`src/souls/`) + agents.yaml의 `system_prompt` 완전 유지. 합치거나 삭제 절대 금지. Soul이 전문성의 원천.

2. **보고서 1개 원칙**: CEO는 비서실장이 최종 작성한 보고서 1개만 받아야 함. 처장이나 전문가 보고서가 직접 CEO에게 올라가면 안 됨.

3. **위계 구조 유지**: 비서실장 → 처장 → 전문가 3단계. 이 위계는 없애면 안 됨. 추가되는 것은 "수평 소통 채널"이지, 위계 해체가 아님.

4. **29명 에이전트 구성 유지**: 에이전트 추가/삭제 없이 기존 29명 그대로.

5. **SQLite DB 저장**: 새로운 소통 내역, 태스크 기록 등 모두 SQLite DB에 저장. JSON 파일 사용 금지 (배포 시 날아감). `db.py`의 `save_setting()` / `load_setting()` 사용.

6. **한국어 UI**: 추가되는 모든 UI 텍스트는 한국어.

---

## 5. 수정할 파일 목록 + 정확한 작업 내용

### 파일 1: `web/arm_server.py` (BE 담당)

**변경 1: 스마트 라우팅 Level 판단 함수 추가**
```python
# 비서실장이 질문을 받으면 Level 1~4 판단하는 함수
# 현재 위치 어딘가에 추가 (CEO 메시지 처리 부분 근처)
async def _determine_routing_level(text: str) -> int:
    # Level 1: 간단한 질문 키워드
    # Level 2: 단일 전문 분야
    # Level 3: 분석/전략
    # Level 4: 여러 부서 또는 전사
    ...
```

**변경 2: 처장의 자율 전문가 선택 로직**
```python
# 현재 _delegate_to_specialists() — 전원 무조건 호출
# 변경 후 — 처장 AI가 필요한 전문가 목록을 결정

async def _manager_decide_specialists(manager_id: str, text: str) -> list[str]:
    """처장 AI가 어떤 전문가를 쓸지 직접 판단"""
    # 처장에게 "이 질문에 필요한 전문가를 아래 목록에서 선택해" 요청
    # 처장이 JSON으로 ["시황분석가", "종목분석가"] 반환
    ...
```

**변경 3: Level별 라우팅 실제 적용**
- Level 1: 비서실장 직접 처리 (처장 호출 없음)
- Level 2: 처장 1명만 호출 (`_call_agent(manager_id, text)`)
- Level 3: 처장 호출 + 처장이 전문가 자율 선택
- Level 4: 여러 처장 병렬 호출 + 처장 간 소통 지원

**변경 4: 에이전트 간 실시간 소통 연결**
- `cross_agent_protocol`의 `request` 액션이 실제로 다른 에이전트를 호출하도록
- 현재: 파일에 저장만 → 변경 후: 실시간으로 target 에이전트 AI 호출

### 파일 2: `src/tools/cross_agent_protocol.py` (BE 담당)

**현재 문제**: `_request()` 메서드가 파일에 메시지 저장만 하고 끝남. 아무도 그 파일을 읽어서 처리 안 함.

**변경 내용**: `action=request`일 때 실제로 target 에이전트를 AI 호출
```python
async def _request(self, kwargs):
    to_agent = kwargs.get("to_agent")
    task = kwargs.get("task")

    # 기존: 파일에 저장만
    # 변경: 실제로 to_agent를 AI 호출하고 결과 반환
    result = await _call_agent(to_agent, task)  # arm_server의 _call_agent 참조
    return result
```

### 파일 3: `web/ai_handler.py` (BE 담당)

**추가**: `spawn_agent` 도구 정의
- 처장 AI가 Function Calling으로 이 도구를 호출하면 → 즉시 해당 전문가 AI 실행
- 결과를 처장 AI에게 반환 → 처장이 결과 포함한 최종 답변 작성

```python
SPAWN_AGENT_TOOL = {
    "name": "spawn_agent",
    "description": "소속 전문가 에이전트를 호출하여 특정 분석을 수행합니다.",
    "input_schema": {
        "type": "object",
        "properties": {
            "agent_id": {"type": "string", "description": "호출할 전문가 에이전트 ID"},
            "task": {"type": "string", "description": "전문가에게 지시할 작업 내용"}
        },
        "required": ["agent_id", "task"]
    }
}
```

### 파일 4: `config/agents.yaml` (BE 담당)

**처장들의 Soul(system_prompt)에 추가할 내용:**
```yaml
# 예: cio_manager의 system_prompt에 추가

## 전문가 자율 선택 규칙
당신은 이제 어떤 전문가를 쓸지 직접 결정합니다.
소속 전문가: 시황분석, 종목분석, 기술적분석, 리스크관리

질문 유형별 판단:
- 간단한 시황 질문 → 직접 처리 (전문가 불필요)
- 특정 종목 분석 → 시황분석 + 종목분석만 호출
- 기술적 패턴 질문 → 기술적분석만 호출
- 종합 전략 → 필요한 전문가 판단해서 선택
spawn_agent 도구를 써서 필요한 전문가만 호출하세요.
```

**비서실장(chief_of_staff)의 Soul에 추가할 내용:**
```yaml
## 라우팅 레벨 판단 규칙
CEO 질문을 받으면 먼저 복잡도를 판단합니다:

Level 1 (직접 처리): 일정, 검색, 간단 요청, 안부
Level 2 (처장 1명): 단일 전문 지식 질문 (법무/기술/투자/마케팅 중 하나)
Level 3 (처장+전문가): 분석, 보고서, 전략 (단일 부서)
Level 4 (다부서): 전사 전략, 여러 부서 관련

Level 1은 당신이 직접 답변하고 끝냅니다.
Level 2~4는 해당 처장(들)에게 위임합니다.
```

### 파일 5: `web/templates/index.html` (FE 담당)

**추가할 UI: CEO 직접 개입 기능**
- 사령실(채팅창) 입력란 옆에 에이전트 선택 드롭다운 추가
- 기본값: "비서실장에게 (자동 라우팅)"
- 선택 가능: "CTO처장에게 직접", "CIO처장에게 직접", "시황분석가에게 직접" 등 29명 전원
- 선택하면 선택한 에이전트에게 바로 전달 (비서실장 건너뜀)
- UI 예시:
  ```
  [메시지 입력란..................] [수신자▼] [전송]
                                    ↓
                              전체 (자동 라우팅)
                              ─────────────────
                              비서실장
                              CTO처장 (기술개발)
                              CIO처장 (투자분석)
                              시황분석가
                              종목분석가
                              ...
  ```

**추가할 UI: 에이전트 간 소통 표시**
- 처장끼리 대화 중일 때 작전현황(대시보드)에 "CTO ↔ CIO 협의 중..." 표시
- 전문가가 다른 전문가에게 질문할 때 상태등 동시 깜빡임

---

## 6. 팀 에이전트 구성 지시

**CLAUDE.md 팀 에이전트 규칙에 따라 팀을 구성하고 작업을 시작하세요.**

이번 작업 규모: "시스템 전면 개편" → 최대 5명 구성 가능하지만 기본팀 3명으로 시작.

### 팀 구성

| 팀원 | 코드명 | 담당 파일 | 구체적 작업 |
|------|--------|---------|-----------|
| 팀원1 | **BE** | `web/arm_server.py`, `web/ai_handler.py`, `src/tools/cross_agent_protocol.py` | 스마트 라우팅 Level 1~4, 처장 자율 전문가 선택, spawn_agent 도구, cross_agent_protocol 실시간화 |
| 팀원2 | **FE** | `web/templates/index.html` | CEO 직접 개입 드롭다운 UI, 에이전트 간 소통 표시 |
| 팀원3 | **QA** | 전체 파일 | 수정 결과 검증, Level 테스트, 보고서 1개 확인, Soul 유지 확인 |

**팀장(Claude 본인)의 역할:**
- 팀 구성 및 태스크 배분
- 같은 파일을 두 팀원이 동시에 수정하지 않도록 관리 (충돌 방지)
- FE/BE/QA 결과 취합 + 최종 커밋 + 배포

### 작업 순서 (의존성 있음 — 순서 지킬 것)

```
Phase 1 (BE 먼저):
  BE: cross_agent_protocol.py 실시간 소통으로 업그레이드
  BE: ai_handler.py에 spawn_agent 도구 스키마 추가
  BE: arm_server.py 스마트 라우팅 Level 1~4 로직 추가
  BE: arm_server.py 처장 자율 전문가 선택 로직 추가
  BE: config/agents.yaml 비서실장 + 처장들 Soul 업데이트

Phase 2 (BE 완료 후 FE):
  FE: 사령실 채팅창에 수신자 선택 드롭다운 추가
  FE: 백엔드 API에 "target_agent_id" 파라미터 전달
  FE: 에이전트 간 소통 시 UI 표시 추가

Phase 3 (QA):
  QA: Level 1 테스트: "오늘 일정?" → 비서실장만 답변, 처장 호출 없어야 함
  QA: Level 2 테스트: "이 계약서 검토해줘" → CLO처장 1명만, 전문가 없어야 함
  QA: Level 3 테스트: "다음달 투자 전략" → CIO처장 + 필요 전문가만
  QA: 보고서 개수 확인: CEO에게 1개만 와야 함
  QA: Soul 확인: 각 에이전트가 여전히 자기 전문성 발휘해야 함
  QA: CEO 직접 개입 테스트: 드롭다운에서 "시황분석가" 선택 후 메시지 → 바로 전달
```

---

## 7. 버전 및 브랜치 정보

- **이번 작업 버전**: `2.00.000` — v2 선언 (에이전트 자율 협업 시대)
- **이전 버전**: `1.05.006`
- **새 브랜치명**: `claude/agent-collab-overhaul` 로 생성
- **기존 브랜치**: `claude/uxui-feedback-fix-colors-lightmode` — 이미 main에 머지 완료됨
- **커밋 완료 필수**: CLAUDE.md, docs/project-status.md, .vscode/settings.json, docs/prompts/ 파일들이 아직 미커밋 상태일 수 있음. 새 브랜치 시작 전에 확인.

---

## 8. 구현 완료 후 CEO에게 보고할 체크리스트 형식

```
## 빌드 #XXX 배포 확인 체크리스트

| # | 확인할 곳 | 확인할 내용 | 이전 | 이후 |
|---|----------|-----------|------|------|
| 1 | 사령실 채팅창 | 수신자 드롭다운 있음 | 없음 | 있음 |
| 2 | "오늘 일정?" 입력 | 비서실장만 답변 (처장 불필요) | 처장+전문가 전원 호출 | 비서실장만 |
| 3 | "계약서 검토해줘" | CLO처장 1명만 답변 | 전원 호출 | 1명만 |
| 4 | "투자 전략 분석" | CIO처장 + 필요 전문가만 | 전원 | 선택적 |
| 5 | 작전현황 | 에이전트 간 소통 표시 | 없음 | 있음 |
```

---

## 9. 참고: 현재 코드에서 수정 시작점

### arm_server.py 수정 시작점
```python
# 5396번째 줄 — _MANAGER_SPECIALISTS 딕셔너리
# 이 딕셔너리는 폴백(fallback)으로만 남기고
# 실제 선택은 처장 AI가 동적으로 결정하도록 변경

_MANAGER_SPECIALISTS: dict[str, list[str]] = {
    "cio_manager": ["market_condition_specialist", "stock_analysis_specialist",
                    "technical_analysis_specialist", "risk_management_specialist"],
    # ...
}

# 5570번째 줄 — _delegate_to_specialists()
# 이 함수를 "처장이 선택한 전문가만" 호출하도록 변경

# 5592번째 줄 — _manager_with_delegation()
# Level 3/4에서 호출되는 함수. 처장 자율 선택 로직 추가.
```

### cross_agent_protocol.py 수정 시작점
```python
# 56번째 줄 — _request() 메서드
# 현재: 파일에 저장만
# 변경: 실제로 arm_server._call_agent() 호출
async def _request(self, kwargs: dict) -> str:
    # 현재 코드: 저장만 하고 끝
    # 변경: to_agent를 실제로 AI 호출하고 결과 반환
```

---

이 프롬프트의 내용이 오늘 3시간 논의의 전부입니다.
위 내용을 바탕으로 팀 에이전트를 구성하고 구현을 시작하세요.
