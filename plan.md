# CORTHEX HQ 대규모 개선 구현 계획

## 개요
11개 기능을 5단계로 나누어 구현합니다.
각 단계가 끝날 때마다 중간 커밋 + 푸시합니다.

---

## 1단계: UI 탭 시스템 리팩토링 + 대시보드 홈 + 명령 템플릿 (기능 3, 4)

### 왜 먼저 하는가
나머지 모든 기능이 UI 탭에 들어갈 공간이 필요합니다. 현재는 탭이 없이 채팅만 있으므로, 탭 시스템을 먼저 만들어야 합니다.

### 변경 파일
| 파일 | 작업 내용 |
|------|----------|
| `web/templates/index.html` | 상단 탭 네비게이션 추가 (홈/명령/사무실/성능/작업내역/예약/워크플로우), 홈 탭 구현 (요약 카드: 오늘 작업 수, 누적 비용, 에이전트 수, 최근 완료 작업 3개), 명령 입력창 아래에 프리셋 버튼 바 추가 |
| `web/app.py` | `/api/dashboard` 엔드포인트 추가 (집계 통계), 프리셋 API 활용 |

### 구현 상세
1. **탭 네비게이션 바**: 홈 | 명령 | 사무실 | 성능 | 작업내역 | 예약 | 워크플로우
2. **홈 탭**: 4개 요약 카드 + 최근 작업 목록 + 비용 그래프
3. **명령 템플릿**: `presets.yaml` 데이터를 버튼으로 표시 + 추가/삭제 관리

---

## 2단계: 작업 히스토리 검색/필터 + 대화 로그 + 결과 비교 (기능 2, 6, 7)

### 변경 파일
| 파일 | 작업 내용 |
|------|----------|
| `web/app.py` | `/api/tasks` 에 검색/필터 파라미터 추가 (query, date_from, date_to, status), `/api/tasks/{id}/bookmark` 북마크 토글 API |
| `src/core/task_store.py` | 검색/필터/북마크 필드 추가 |
| `web/templates/index.html` | 작업내역 탭에 검색바 + 날짜/상태 필터 + 북마크 기능 추가, 작업 결과에 "내부 대화 보기" 펼침 버튼 추가 (기존 `/api/replay` 활용), 두 작업을 선택해서 나란히 비교하는 모달 추가 |

### 구현 상세
1. **검색**: 키워드 입력 → 명령어 텍스트에서 검색
2. **필터**: 날짜 범위, 상태(성공/실패/전체), 부서별
3. **내부 대화 로그**: correlation_id로 `/api/replay/{id}` 호출 → 에이전트 간 메시지 트리 표시
4. **비교 기능**: 체크박스로 2개 선택 → 좌우 분할 모달

---

## 3단계: 에이전트 성능 대시보드 + 에러 알림 (기능 8, 9)

### 변경 파일
| 파일 | 작업 내용 |
|------|----------|
| `web/templates/index.html` | 성능 탭 구현 (에이전트별 응답시간/비용/호출수 테이블 + 막대 차트), 에러 알림 배너 (상단 빨간 배너, 자동 숨김) |
| `web/app.py` | `/api/performance` 이미 있음 (활용), 에러 이벤트 WebSocket 브로드캐스트 강화 |
| `web/ws_manager.py` | `send_error_alert()` 메서드 추가 |
| `src/core/context.py` | 에러 이벤트 로깅 + 콜백 |

### 구현 상세
1. **성능 탭**: CSS 막대 차트 (라이브러리 없이 Tailwind div로 구현), 에이전트별 평균 응답시간/총 비용/호출 수/성공률 테이블
2. **에러 알림**: WebSocket으로 에러 이벤트 수신 → 상단 빨간 배너 3초 표시 → 자동 숨김

---

## 4단계: 에이전트 메모리 + 작업 예약 (기능 11, 5)

### 새 파일
| 파일 | 역할 |
|------|------|
| `src/core/memory.py` | 에이전트별 장기 기억 저장소 (JSON 파일 기반) |
| `src/core/scheduler.py` | asyncio 기반 작업 예약 엔진 |
| `config/schedules.yaml` | 예약 작업 설정 저장 |

### 변경 파일
| 파일 | 작업 내용 |
|------|----------|
| `web/app.py` | `/api/memory` CRUD 엔드포인트, `/api/schedules` CRUD 엔드포인트 |
| `web/templates/index.html` | 사무실 탭 에이전트 상세에 "기억" 섹션 추가, 예약 탭 구현 |
| `src/core/agent.py` | `BaseAgent.think()`에 메모리 자동 주입 로직 추가 |

### 구현 상세
1. **에이전트 메모리**:
   - `data/memory/{agent_id}.json`에 key-value 저장
   - 작업 완료 시 핵심 정보 자동 추출 → 메모리 저장
   - `think()` 호출 시 관련 메모리를 시스템 프롬프트에 자동 주입
   - 웹 UI에서 수동 추가/삭제 가능

2. **작업 예약**:
   - cron 형식 스케줄 (`매일 09:00`, `매주 월요일 10:00`)
   - asyncio 루프에서 1분마다 체크
   - 실행 결과를 작업내역에 자동 기록
   - 웹 UI에서 추가/수정/삭제/활성화-비활성화

---

## 5단계: 워크플로우 빌더 + 멀티 유저 (기능 13, 14)

### 새 파일
| 파일 | 역할 |
|------|------|
| `src/core/workflow.py` | 워크플로우 정의 + 실행 엔진 |
| `src/core/auth.py` | 사용자 인증 + 권한 관리 |
| `config/workflows.yaml` | 워크플로우 템플릿 저장 |
| `data/users.json` | 사용자 계정 저장 |

### 변경 파일
| 파일 | 작업 내용 |
|------|----------|
| `web/app.py` | `/api/workflows` CRUD + 실행, `/api/auth` 로그인/회원가입, 미들웨어 인증 체크 |
| `web/templates/index.html` | 워크플로우 탭 (시각적 단계 편집기), 로그인 화면, 사용자 역할별 UI 제한 |

### 구현 상세
1. **워크플로우 빌더**:
   - 단계(Step) 리스트로 워크플로우 정의 (드래그앤드롭 대신 리스트 기반 편집기 - Alpine.js로 충분)
   - 각 단계: 에이전트 선택 + 명령 템플릿 + 이전 단계 결과 참조
   - 저장/불러오기/실행 기능
   - 실행 시 각 단계 순차 or 병렬 실행

2. **멀티 유저**:
   - 세션 기반 인증 (JWT 토큰)
   - 역할: CEO (전체 권한), Manager (부서 제한), Viewer (읽기만)
   - CEO만 에이전트 설정 변경, 워크플로우 생성, 예약 관리 가능
   - Manager는 자기 부서 명령만 실행 가능
   - Viewer는 작업 결과 열람만 가능

---

## 작업 순서 요약

| 단계 | 기능 | 예상 작업 |
|------|------|----------|
| 1단계 | 홈 대시보드 + 명령 템플릿 (3, 4) | 탭 시스템 + 홈 화면 + 프리셋 UI |
| 2단계 | 검색/필터 + 대화 로그 + 비교 (2, 6, 7) | 작업내역 탭 강화 |
| 3단계 | 성능 대시보드 + 에러 알림 (8, 9) | 성능 탭 + 에러 배너 |
| 4단계 | 메모리 + 예약 (11, 5) | 새 백엔드 모듈 2개 + UI |
| 5단계 | 워크플로우 + 멀티유저 (13, 14) | 새 백엔드 모듈 2개 + UI |

각 단계 완료 시 커밋 + 푸시하고, 모든 단계 완료 후 `[완료]` 커밋합니다.
