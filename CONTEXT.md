# CORTHEX HQ - 프로젝트 컨텍스트

> 이 문서는 CORTHEX HQ가 무엇이고, 왜 만들었고, 어떻게 동작하는지를 설명합니다.
> 프로젝트에 처음 접하는 사람이 전체 그림을 빠르게 이해할 수 있도록 작성했습니다.

---

## 1. 이 프로젝트는 뭔가요?

**CORTHEX HQ**는 "AI 에이전트 회사"입니다.

일반적인 AI 챗봇은 하나의 AI에게 모든 것을 물어보지만,
CORTHEX HQ는 **25명의 AI 에이전트를 실제 회사 조직도처럼 배치**하고,
각자의 전문 분야에 맞춰 **업무를 자동으로 배분하고 병렬 처리**합니다.

사용자는 CEO 역할로, 한국어로 자유롭게 명령을 내립니다.
비서실장이 명령을 분석해서 적절한 부서에 배분하고,
전문가들이 각자 작업한 뒤, 결과를 종합 보고서로 합쳐서 돌려줍니다.

### 핵심 콘셉트: "AI 직원에게 일을 시키는 것"

```
일반 AI 챗봇:    사용자 ↔ AI 1명 (만능이지만 깊이 없음)

CORTHEX HQ:     CEO(사용자)
                  └→ 비서실장 (명령 분석 + 배분)
                       ├→ CTO (기술팀 4명에게 병렬 지시)
                       ├→ CSO (기획팀 3명에게 병렬 지시)
                       ├→ CLO (법무팀 2명에게 병렬 지시)
                       ├→ CMO (마케팅팀 3명에게 병렬 지시)
                       └→ CIO (투자분석팀 4명에게 병렬 지시)
```

---

## 2. 왜 만들었나요?

### 문제 인식

1. **하나의 AI에게 복잡한 일을 시키면 깊이가 없다**
   - "인스타 마케팅 전략 만들어줘"라고 하면 피상적인 답변만 나옴
   - 사람이라면 리서치팀, 콘텐츠팀, 커뮤니티팀이 각각 깊이 작업한 뒤 합치는데, AI 1명에게는 그게 불가능

2. **전문 분야가 다른 업무를 하나의 프롬프트로 커버하기 어렵다**
   - 주식 분석과 마케팅 전략은 완전히 다른 도메인
   - 하나의 시스템 프롬프트로 모든 전문성을 주입하면 품질이 떨어짐

3. **실제 회사처럼 업무를 체계적으로 처리하고 싶다**
   - 명령 → 배분 → 실행 → 종합 → 보고의 체계적 흐름
   - 누가 무슨 작업을 했는지 추적 가능
   - 비용이 얼마나 들었는지 모니터링

### 해결 방법

각 AI 에이전트에게 **전문화된 역할과 시스템 프롬프트**를 부여하고,
**조직 구조를 통해 자동으로 업무를 배분하고 병렬 실행**하는 시스템을 만들었습니다.

---

## 3. 두 개의 사업부

CORTHEX HQ에는 두 개의 사업 영역이 있습니다:

### LEET MASTER 본부 (제품 개발)

"LEET MASTER"라는 서비스/제품을 만들기 위한 팀입니다.

| 부서 | 처장 | 전문가 | 하는 일 |
|------|------|--------|---------|
| 기술개발처 | CTO | 프론트엔드, 백엔드, 인프라, AI모델 | 서비스의 기술적 구현 |
| 사업기획처 | CSO | 시장조사, 사업계획서, 재무모델링 | 시장 분석, 사업 전략 수립 |
| 법무·IP처 | CLO | 저작권, 특허·약관 | 법적 보호, 이용약관 작성 |
| 마케팅·고객처 | CMO | 설문조사, 콘텐츠, 커뮤니티 | 사용자 확보, 콘텐츠 전략 |

### 투자분석 본부 (금융 분석)

주식/투자 분석을 담당합니다.

| 부서 | 처장 | 전문가 | 하는 일 |
|------|------|--------|---------|
| 투자분석처 | CIO | 시황분석, 종목분석, 기술적분석, 리스크관리 | 시장 동향, 개별 종목, 차트 분석, 위험도 평가 |

투자분석 본부의 4명 전문가 중 시황/종목/기술적분석은 **병렬로 동시 실행**되고,
리스크관리는 앞의 결과를 받아서 **순차 실행**됩니다.

---

## 4. 에이전트의 3가지 등급

| 등급 | 역할 | 모델 | 설명 |
|------|------|------|------|
| **Manager** (처장) | 업무 분해 + 배분 + 종합 | Claude Sonnet (고성능) | 큰 업무를 작은 단위로 쪼개서 부하 전문가들에게 병렬로 배분, 결과를 종합 보고서로 합성 |
| **Specialist** (전문가) | 실제 작업 수행 | Claude Haiku (빠르고 저렴) | 각 분야의 전문 지식으로 실제 업무 수행. 딥워크 모드에서 자율적으로 멀티스텝 작업 가능 |
| **Worker** (워커) | 단순 반복 작업 | Claude Haiku (최저 비용) | 보고 요약, 일정 추적 등 단순한 작업을 최저 비용으로 처리 |

### 비서실장은 특별한 Manager

비서실장(Chief of Staff)은 모든 CEO 명령을 처음 받는 에이전트입니다.
다른 Manager들은 자기 부서 업무만 관리하지만,
비서실장은 **명령을 분석해서 어떤 부서에 보낼지 판단**하는 역할을 합니다.

```
CEO: "삼성전자 주가 분석해줘"
  → 비서실장: "이건 투자 관련이니 CIO에게 보내겠습니다" (LLM 판단)
  → CIO: "4명 전문가에게 배분하겠습니다" (업무 분해)
  → 4명 병렬 작업 → CIO 종합 → 비서실장이 CEO에게 보고
```

---

## 5. 딥워크 (자율 멀티스텝 작업)

v0.6.0에서 추가된 핵심 기능입니다.

### 기존 방식 (v0.5.0 이하)

전문가가 LLM을 **1번만 호출**하고 끝. 답변이 짧고 피상적이었습니다.

```
"인스타 콘텐츠 전략 만들어줘"
→ 콘텐츠 전문가: (LLM 1번 호출) → "1. 릴스를 활용하세요 2. 해시태그를 쓰세요 ..."
```

### 딥워크 방식 (v0.6.0)

전문가가 **스스로 계획을 세우고, 단계별로 자율 작업**합니다.

```
"인스타 콘텐츠 전략 만들어줘" (심화 모드, 5단계)
→ 콘텐츠 전문가:
    1단계: "먼저 콘텐츠 방향성을 기획하겠습니다" (LLM 호출)
    2단계: "게시물 유형별 전략을 수립합니다" (LLM 호출)
    3단계: "예시 게시물 3개를 작성합니다" (LLM 호출)
    4단계: "최종 콘텐츠 가이드를 정리합니다" (LLM 호출)
```

각 단계의 결과가 다음 단계의 입력으로 들어가서,
점점 더 구체적이고 깊이 있는 결과물이 나옵니다.

### 깊이 선택

웹 대시보드 입력창 옆 드롭다운으로 선택합니다:

| 옵션 | 단계 수 | 예상 비용 (Haiku 기준) | 언제 쓰나 |
|------|---------|----------------------|-----------|
| 빠른 | 1단계 | ~5원 | "오늘 날씨 어때?" 같은 간단한 질문 |
| 보통 | 3단계 | ~15원 | 일반적인 업무 요청 |
| 심화 | 5단계 | ~30원 | 전략 보고서, 상세 분석 |

---

## 6. 지식 시스템

`knowledge/` 폴더에 마크다운(.md) 파일을 넣으면,
해당 부서의 에이전트들이 작업할 때 **시스템 프롬프트에 자동으로 주입**됩니다.

```
knowledge/
├── shared/              ← 모든 에이전트가 공유 (회사 규칙 등)
│   └── company_rules.md
├── leet_master/         ← LEET Master 본부 에이전트만 참조
│   └── product_info.md
└── finance/             ← 투자분석 본부 에이전트만 참조
    └── investment_policy.md
```

### 예시: company_rules.md의 역할

이 파일에 "모든 보고서는 한국어로 작성", "숫자는 구체적으로"라고 적어두면,
모든 에이전트가 이 규칙을 따릅니다.

### 웹에서 관리

웹 대시보드의 "지식관리" 탭에서 파일을 생성/수정/삭제할 수 있습니다.
서버 재시작 없이 즉시 반영됩니다.

---

## 7. 도구(Tool) 시스템

에이전트들은 LLM 외에 **전문 도구**를 호출할 수 있습니다.

| 도구 | 설명 | 허용된 에이전트 |
|------|------|----------------|
| 변리사 (patent_attorney) | 특허 출원, 선행기술 조사, 침해 분석 | CLO 산하 전문가 |
| 세무사 (tax_accountant) | 세무 상담, 절세 전략, 세금 계산 | CSO 산하 전문가 |
| 디자이너 (designer) | UI/UX 설계, 디자인 시스템, 와이어프레임 | CTO 산하 전문가 |
| 번역가 (translator) | 한영 번역, 기술 문서 번역 | 모든 에이전트 |
| 웹검색 (web_search) | 실시간 웹 검색, 정보 수집 | 모든 에이전트 |

**권한 제어:** 에이전트는 자신의 `allowed_tools`에 포함된 도구만 사용 가능합니다.
예를 들어, 마케팅 전문가가 변리사 도구를 호출하면 `ToolPermissionError`가 발생합니다.

---

## 8. 비용 추적

모든 LLM 호출의 토큰 사용량과 비용을 자동으로 기록합니다.

### 3가지 관점으로 분석

| 관점 | 예시 | 용도 |
|------|------|------|
| **모델별** | "Claude Sonnet에 $0.03, Haiku에 $0.01 썼다" | 어떤 모델이 비싼지 |
| **에이전트별** | "비서실장이 $0.012, CTO가 $0.008 썼다" | 누가 많이 쓰는지 |
| **프로바이더별** | "OpenAI에 $0.030, Anthropic에 $0.004 썼다" | 어떤 회사에 많이 내는지 |

### 비용 절감 전략

- **Manager (처장)**: 비싼 모델 (Claude Sonnet) — 판단이 중요해서
- **Specialist (전문가)**: 저렴한 모델 (Claude Haiku) — 실행 위주라서
- **Worker (워커)**: 최저가 모델 (Claude Haiku) — 단순 작업이라서

---

## 9. 웹 대시보드 구조

### 기술 스택

프론트엔드는 **빌드 도구 없이** 단일 HTML 파일로 구성됩니다:
- **Tailwind CSS** (CDN): 스타일링
- **Alpine.js** (CDN): 반응형 UI 상호작용
- **WebSocket**: 에이전트 상태 실시간 업데이트

### 실시간 동작 원리

```
[브라우저]                    [FastAPI 서버]                [에이전트]
    │                              │                          │
    │── WebSocket 연결 ──→         │                          │
    │                              │                          │
    │── {type:"command",    ──→    │                          │
    │    text:"주가분석해줘",       │                          │
    │    depth:3}                   │── 비서실장에게 전달 ──→  │
    │                              │                          │
    │  ←── task_accepted           │                          │
    │  ←── agent_status(비서실장)  │  ←── StatusUpdate        │
    │  ←── agent_status(CIO)      │  ←── StatusUpdate        │
    │  ←── activity_log(...)      │                          │
    │  ←── cost_update            │                          │
    │  ←── task_completed         │  ←── TaskResult          │
    │                              │                          │
```

브라우저를 닫았다가 다시 열어도, 서버에서 작업이 계속 진행되고,
재접속 시 "작업내역" 탭에서 결과를 확인할 수 있습니다.

---

## 10. 설정 파일 구조

CORTHEX HQ의 모든 설정은 **YAML 파일**로 관리됩니다.
개발자가 아니어도 에이전트의 성격, 모델, 도구 권한 등을 쉽게 수정할 수 있습니다.

### config/agents.yaml (핵심 설정)

25개 에이전트의 모든 정보가 여기 있습니다:

```yaml
agents:
  - agent_id: chief_of_staff        # 고유 식별자
    name: 비서실장                    # 한글 이름
    role: manager                    # 역할 등급 (manager/specialist/worker)
    model_name: claude-sonnet-4-5-20250929  # 사용할 AI 모델
    temperature: 0.3                 # LLM 창의성 (낮을수록 일관적)
    system_prompt: |                 # 이 에이전트의 "성격"
      당신은 CORTHEX HQ의 비서실장입니다...
    capabilities:                    # 능력 목록
      - 명령 분류 및 배분
      - 종합 보고서 작성
    subordinate_ids:                 # 부하 에이전트 ID
      - cto_manager
      - cso_manager
      - ...
    allowed_tools:                   # 사용 가능한 도구
      - web_search
```

### config/models.yaml (모델 목록)

사용 가능한 AI 모델과 가격 정보:

```yaml
providers:
  openai:
    models:
      - id: gpt-4o
        tier: manager
        pricing: { input: 2.50, output: 10.00 }  # per 1M tokens
  anthropic:
    models:
      - id: claude-sonnet-4-5-20250929
        tier: manager
        pricing: { input: 3.00, output: 15.00 }
```

### config/tools.yaml (도구 설정)

전문 도구의 정의와 설명:

```yaml
tools:
  - tool_id: patent_attorney
    name: 변리사
    description: 특허 출원, 선행기술 조사, 침해 분석
    capabilities:
      - 특허 출원서 초안
      - 선행기술 검색
```

---

## 11. 핵심 코드 모듈 설명

### src/core/ (코어 프레임워크)

| 파일 | 한 줄 설명 | 핵심 클래스/함수 |
|------|-----------|-----------------|
| `orchestrator.py` | CEO 명령을 비서실장에게 전달 | `Orchestrator.process_command()` |
| `agent.py` | 에이전트 기본 클래스 3종 | `ManagerAgent` (분해+배분+종합), `SpecialistAgent` (딥워크), `WorkerAgent` (단순 실행) |
| `registry.py` | YAML → 에이전트 인스턴스 생성 | `AgentRegistry.build_from_config()` |
| `context.py` | 에이전트 간 공유 상태 | `SharedContext` (대화 기록, 게시판, 상태 콜백) |
| `message.py` | 에이전트 간 통신 프로토콜 | `TaskRequest`, `TaskResult`, `StatusUpdate` |
| `knowledge.py` | 마크다운 지식파일 관리 | `KnowledgeManager.get_knowledge_for_agent()` |
| `task_store.py` | 백그라운드 작업 저장소 | `TaskStore`, `StoredTask` |

### src/llm/ (LLM 프로바이더)

| 파일 | 한 줄 설명 |
|------|-----------|
| `router.py` | 모델명(gpt-*/claude-*)으로 프로바이더 자동 분기 |
| `openai_provider.py` | OpenAI API 비동기 래퍼 |
| `anthropic_provider.py` | Anthropic API 비동기 래퍼 |
| `cost_tracker.py` | 모든 LLM 호출의 비용/토큰 누적 기록 |

### web/ (웹 대시보드)

| 파일 | 한 줄 설명 |
|------|-----------|
| `app.py` | FastAPI 서버 (REST API 15개 + WebSocket) |
| `ws_manager.py` | WebSocket 연결 관리 + 모든 클라이언트에 브로드캐스트 |
| `templates/index.html` | CEO 관제실 SPA (단일 HTML, Tailwind + Alpine.js) |

---

## 12. 개발 타임라인

| 버전 | 날짜 | 핵심 변경 |
|------|------|----------|
| v0.1.0 | 2026-02-12 | 최초 릴리즈: 25명 에이전트 + 웹 대시보드 + CLI |
| v0.2.0 | 2026-02-12 | 본부장 삭제 + 비서실장 승격 (LLM 호출 절감) |
| v0.3.0 | 2026-02-12 | LEET Master / 투자분석 본부 라벨 분리 |
| v0.4.0 | 2026-02-12 | 가상 사무실 + Soul 편집기 + 지식관리 시스템 |
| v0.5.0 | 2026-02-12 | 모델 전체 Claude 전환 + 웹 모델 선택기 |
| v0.6.0 | 2026-02-12 | 자율 딥워크 + 백그라운드 작업 + 작업내역 |

자세한 변경 이력은 [CHANGELOG.md](docs/CHANGELOG.md)를 참고하세요.

---

## 13. 만든 사람

- **CEO / 기획**: 고동희
- **개발**: Claude Code (Anthropic AI)
- **목표**: AI 에이전트가 실제 회사처럼 업무를 처리하는 시스템 구축
