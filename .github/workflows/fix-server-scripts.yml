name: ðŸ”§ ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì•ˆ ë°”ê¿ˆ)

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP_ARM }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY_ARM }}
          script: |
            # start-claude.sh ìˆ˜ì • (CORTHEX_HQ í´ë”ì—ì„œ ì‹œìž‘)
            cat > /home/ubuntu/start-claude.sh << 'SCRIPTEOF'
            #!/bin/bash
            cd /home/ubuntu/CORTHEX_HQ
            if tmux has-session -t claude 2>/dev/null; then
              tmux attach -t claude
            else
              tmux new -s claude -d
              tmux send-keys -t claude 'cd /home/ubuntu/CORTHEX_HQ && claude' Enter
              tmux attach -t claude
            fi
            SCRIPTEOF
            chmod +x /home/ubuntu/start-claude.sh

            # ë¡œê·¸ì¸ ì‹œ ìžë™ìœ¼ë¡œ Claude Code ì‹œìž‘
            BASHRC="/home/ubuntu/.bashrc"
            if ! grep -q "start-claude" "$BASHRC" 2>/dev/null; then
              cat >> "$BASHRC" << 'BASHEOF'

            # ëª¨ë°”ì¼ SSH ì ‘ì† ì‹œ ìžë™ìœ¼ë¡œ Claude Code ì‹œìž‘
            if [ -n "$SSH_CONNECTION" ] && [ -z "$TMUX" ]; then
              cd /home/ubuntu/CORTHEX_HQ
              exec /home/ubuntu/start-claude.sh
            fi
            BASHEOF
              echo "âœ… ë¡œê·¸ì¸ ì‹œ Claude Code ìžë™ ì‹œìž‘ ì„¤ì • ì™„ë£Œ"
            else
              echo "âœ… ì´ë¯¸ ì„¤ì •ë˜ì–´ ìžˆìŒ"
            fi

            echo "ðŸŽ‰ ì™„ë£Œ! ë‹¤ìŒ ì ‘ì†ë¶€í„° Claude Codeê°€ ìžë™ìœ¼ë¡œ ëœ¹ë‹ˆë‹¤."
