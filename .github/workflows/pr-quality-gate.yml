name: PR Quality Gate β€” Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'web/templates/**'
      - 'web/static/js/**'
      - 'web/handlers/**'
      - 'web/app.py'
      - 'web/arm_server.py'
      - 'config/**'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Quality Gate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_env: |
            ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            μ΄ PRμ λ³€κ²½λ νμΌλ“¤μ„ κ²€ν† ν•΄μ¤. CORTHEX HQ ν”„λ΅μ νΈμ ν•µμ‹¬ κ·μΉ™ μ„λ° μ—¬λ¶€λ¥Ό μ²΄ν¬ν•κ³  PR λ“κΈ€λ΅ κ²°κ³Όλ¥Ό λ‚¨κ²¨μ¤.

            ## π”΄ λ°λ“μ‹ μ²΄ν¬ν•  κ²ƒ (μ„λ° μ‹ FAIL)

            1. **role if/else ν•λ“μ½”λ”© κΈμ§€**
               - `auth.role === 'sister'`, `auth.role === 'ceo'` κ°™μ€ μ΅°κ±΄ μμΌλ©΄ FAIL
               - `x-show="auth.role"` ν¨ν„΄ μμΌλ©΄ FAIL
               - μ¬λ°”λ¥Έ λ°©μ‹: `workspace.sidebarFilter`, `workspace.showX`, `agentCliOwner[id]`

            2. **CEO λ°μ΄ν„° κ²©λ¦¬**
               - μƒλ΅ μ¶”κ°€λ μ„Ήμ…/μΉ΄λ“/νƒ­μ— workspace μ΅°κ±΄μ΄ μ—†μΌλ©΄ FAIL
               - λ„λ‚ κ³„μ •μ—μ„ CEO μ „μ© μ •λ³΄(λ§μ΅±λ„, ν€μ¥ 6λ… λ©λ΅, CEO SNS λ“±)κ°€ λ…Έμ¶λ  μ μλ” μ½”λ“ FAIL

            3. **API μ—”λ“ν¬μΈνΈ orgScope ν•„ν„°**
               - μƒ API μ—”λ“ν¬μΈνΈκ°€ org νλΌλ―Έν„° μ—†μ΄ μ „μ²΄ λ°μ΄ν„° λ°ν™ν•λ©΄ WARN
               - /api/agents, /api/performance λ“±μ— cli_owner/org ν•„ν„° λΉ μ§€λ©΄ WARN

            4. **μ—μ΄μ „νΈ ν•λ“μ½”λ”©**
               - `['chief_of_staff', 'fin_analyst', ...]` λ°°μ—΄ ν•λ“μ½”λ”© μƒλ΅ μ¶”κ°€λλ©΄ WARN
               - workspace.officeLayout, agentCliOwner λ“± λ™μ  λ°μ΄ν„° μ‚¬μ© κ¶μ¥

            ## π“‹ κ²°κ³Ό ν•μ‹
            μ•„λ ν•μ‹μΌλ΅ PRμ— λ“κΈ€ λ‹¬μ•„μ¤:

            ---
            ## π¤– CORTHEX Quality Gate

            ### κ²°κ³Ό: PASS / FAIL / WARN

            | μ²΄ν¬ ν•­λ© | κ²°κ³Ό | μƒμ„Έ |
            |---------|------|------|
            | role if/else μ—†μ | β…/β | νμΌ:λΌμΈ |
            | CEO λ°μ΄ν„° κ²©λ¦¬ | β…/β | νμΌ:λΌμΈ |
            | orgScope ν•„ν„° | β…/β οΈ | νμΌ:λΌμΈ |
            | μ—μ΄μ „νΈ ν•λ“μ½”λ”© | β…/β οΈ | νμΌ:λΌμΈ |

            ### μ„λ° μ‚¬ν•­
            (μμΌλ©΄ μƒμ„Έν, μ—†μΌλ©΄ "μ—†μ")

            ### κ¶μ¥ μμ •
            (μμΌλ©΄ μ½”λ“ μμ‹ ν¬ν•¨)
            ---

          claude_args: "--max-turns 5 --model claude-sonnet-4-6"
