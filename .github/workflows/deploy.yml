name: Deploy to Oracle Cloud Server

# 언제 실행? → main 브랜치에 코드가 합쳐질 때 자동 실행
on:
  push:
    branches:
      - main
    # paths 필터 제거 — main에 합쳐지면 무조건 배포 실행
    # (배포 스크립트가 가볍기 때문에 매번 실행해도 문제없음)

# 수동으로도 실행 가능 (GitHub에서 버튼 클릭)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 서버에 배포하기
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: BUILD_NUMBER
          script: |
            echo "🚀 배포 시작... (빌드 #${BUILD_NUMBER})"

            # 1단계: GitHub에서 최신 코드 가져오기
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "📦 처음 배포 - 저장소 복제 중..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "🔄 최신 코드 가져오는 중..."
              cd CORTHEX_HQ
              git pull origin main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2단계: 빌드 번호를 HTML에 주입
            echo "📝 빌드 번호 주입 중... (#${BUILD_NUMBER})"
            sed "s/BUILD_NUMBER_PLACEHOLDER/${BUILD_NUMBER}/g" web/templates/index.html > /tmp/index.html

            # 3단계: 대시보드 HTML 파일 복사 (웹서버 폴더로)
            echo "📄 대시보드 파일 복사 중..."
            sudo cp /tmp/index.html /var/www/html/index.html

            # 4단계: 미니 서버 파일 복사
            echo "🐍 미니 서버 파일 복사 중..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp /tmp/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "⚠️ config 파일 없음 (무시)"

            # 5단계: Python 의존성 설치 (PyYAML 등)
            echo "📦 Python 패키지 설치 중..."
            sudo apt-get install -y python3-yaml 2>/dev/null || echo "⚠️ python3-yaml 설치 실패"

            # 5.5단계: YAML → JSON 변환 (PyYAML 없이도 동작하도록 백업)
            echo "🔄 설정 파일 JSON 변환 중..."
            python3 /home/ubuntu/config/yaml2json.py 2>/dev/null || echo "⚠️ JSON 변환 건너뜀"

            # 6단계: 미니 서버 재시작
            echo "🔁 미니 서버 재시작 중..."
            sudo systemctl restart corthex

            # 7단계: 상태 확인
            sleep 2
            if sudo systemctl is-active --quiet corthex; then
              echo "✅ 배포 완료! 미니 서버 정상 실행 중 (빌드 #${BUILD_NUMBER})"
            else
              echo "❌ 미니 서버 시작 실패"
              sudo journalctl -u corthex --no-pager -n 10
              exit 1
            fi

            # 8단계: 배포 상태 JSON 저장 (프론트엔드에서 읽을 수 있도록)
            echo "{\"build\":${BUILD_NUMBER},\"time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"status\":\"success\",\"commit\":\"$(cd /home/ubuntu/CORTHEX_HQ && git rev-parse --short HEAD)\"}" | sudo tee /var/www/html/deploy-status.json > /dev/null

            # 9단계: nginx 캐시 방지 설정 (HTML 파일이 항상 최신 버전으로 보이도록)
            if ! grep -q "no-cache" /etc/nginx/sites-available/default 2>/dev/null; then
              sudo sed -i '/location \/ {/a\\t\tadd_header Cache-Control "no-cache, no-store, must-revalidate";\n\t\tadd_header Pragma "no-cache";\n\t\tadd_header Expires "0";' /etc/nginx/sites-available/default 2>/dev/null || echo "⚠️ nginx 캐시 설정 건너뜀"
              sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || echo "⚠️ nginx 리로드 건너뜀"
            fi

            echo "🎉 배포 성공! http://168.107.28.100 에서 확인 가능 (빌드 #${BUILD_NUMBER})"
