name: Deploy to Oracle Cloud Server

# 언제 실행? → main 브랜치에 코드가 합쳐질 때 자동 실행
on:
  push:
    branches:
      - main
    # paths 필터 제거 — main에 합쳐지면 무조건 배포 실행
    # (배포 스크립트가 가볍기 때문에 매번 실행해도 문제없음)

# 수동으로도 실행 가능 (GitHub에서 버튼 클릭)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 서버에 배포하기
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CEO_CHAT_ID: ${{ secrets.TELEGRAM_CEO_CHAT_ID }}
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_KEY: ${{ secrets.GOOGLE_API_KEY }}
          NOTION_KEY: ${{ secrets.NOTION_API_KEY }}
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: BUILD_NUMBER,TG_BOT_TOKEN,TG_CEO_CHAT_ID,ANTHROPIC_KEY,OPENAI_KEY,GOOGLE_KEY,NOTION_KEY
          script: |
            echo "🚀 배포 시작... (빌드 #${BUILD_NUMBER})"

            # 1단계: GitHub에서 최신 코드 가져오기
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "📦 처음 배포 - 저장소 복제 중..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "🔄 최신 코드 가져오는 중..."
              cd CORTHEX_HQ
              # ⚠️ 이전 배포에서 sed가 index.html을 수정하므로 로컬 변경사항 발생
              # git pull이 실패하지 않도록 로컬 변경사항을 먼저 버림
              git fetch origin main
              git reset --hard origin/main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2단계: 빌드 번호를 HTML에 주입
            echo "📝 빌드 번호 주입 중... (#${BUILD_NUMBER})"
            sed "s/BUILD_NUMBER_PLACEHOLDER/${BUILD_NUMBER}/g" web/templates/index.html > /tmp/index.html

            # 3단계: 대시보드 HTML 파일 복사 (웹서버 폴더로)
            echo "📄 대시보드 파일 복사 중..."
            sudo cp /tmp/index.html /var/www/html/index.html

            # 4단계: 미니 서버 파일 복사
            # 주의: corthex 서비스는 /home/ubuntu/CORTHEX_HQ/web/ (git 저장소)에서 실행됨
            echo "🐍 미니 서버 파일 복사 중..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp web/ai_handler.py /home/ubuntu/web/ai_handler.py
            cp web/db.py /home/ubuntu/web/db.py
            cp /tmp/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "⚠️ config 파일 없음 (무시)"
            # git 저장소의 templates에도 빌드번호 주입된 HTML 복사 (서버가 여기서 읽음)
            cp /tmp/index.html /home/ubuntu/CORTHEX_HQ/web/templates/index.html

            # 5단계: Python 의존성 설치
            echo "📦 Python 패키지 설치 중..."
            sudo apt-get install -y python3-yaml python3-pip 2>/dev/null || echo "⚠️ apt 패키지 설치 실패"
            # 시스템 Python에 설치
            sudo python3 -m pip install --break-system-packages --ignore-installed python-telegram-bot anthropic google-genai openai 2>&1 || true
            # ExecStart에서 사용하는 Python에도 설치
            SVC_EXEC=$(grep "ExecStart" /etc/systemd/system/corthex.service 2>/dev/null | head -1)
            echo "🔍 ExecStart: $SVC_EXEC"
            # venv의 pip를 찾아서 설치
            if echo "$SVC_EXEC" | grep -q "venv\|virtualenv"; then
              VENV_PIP=$(echo "$SVC_EXEC" | grep -oP '(/\S+)/bin/' | head -1)
              if [ -n "$VENV_PIP" ] && [ -x "${VENV_PIP}pip" ]; then
                echo "📦 가상환경 pip 사용: ${VENV_PIP}pip"
                "${VENV_PIP}pip" install python-telegram-bot anthropic google-genai openai 2>&1
              fi
            fi
            # ExecStart에서 Python 경로 추출해서 해당 Python에 설치
            SVC_PYTHON=$(echo "$SVC_EXEC" | grep -oP '/\S+python\S*' | head -1)
            if [ -n "$SVC_PYTHON" ] && [ -x "$SVC_PYTHON" ]; then
              echo "📦 서비스 Python으로 설치: $SVC_PYTHON"
              sudo "$SVC_PYTHON" -m pip install --break-system-packages --ignore-installed python-telegram-bot anthropic google-genai openai 2>&1 || true
            fi
            # 설치 확인
            python3 -c "import telegram; print(f'✅ python-telegram-bot v{telegram.__version__} 설치됨')" 2>&1 || echo "❌ telegram 모듈 임포트 실패!"
            python3 -c "import anthropic; print(f'✅ anthropic v{anthropic.__version__} 설치됨')" 2>&1 || echo "❌ anthropic 모듈 임포트 실패!"
            python3 -c "from google import genai; print('✅ google-genai 설치됨')" 2>&1 || echo "❌ google-genai 모듈 임포트 실패!"
            python3 -c "import openai; print(f'✅ openai v{openai.__version__} 설치됨')" 2>&1 || echo "❌ openai 모듈 임포트 실패!"

            # 5.5단계: YAML → JSON 변환 (서버의 Python에 PyYAML이 없어도 동작하도록)
            echo "🔄 설정 파일 JSON 변환 중..."
            /usr/bin/python3 /home/ubuntu/CORTHEX_HQ/config/yaml2json.py 2>&1 || echo "⚠️ JSON 변환 건너뜀"

            # 5.6단계: 텔레그램 봇 환경변수 설정
            if [ -n "${TG_BOT_TOKEN}" ]; then
              echo "🤖 텔레그램 봇 환경변수 설정 중..."
              ENV_FILE="/home/ubuntu/corthex.env"
              touch "$ENV_FILE"
              sed -i '/^TELEGRAM_/d' "$ENV_FILE"
              echo "TELEGRAM_BOT_TOKEN=${TG_BOT_TOKEN}" >> "$ENV_FILE"
              echo "TELEGRAM_CEO_CHAT_ID=${TG_CEO_CHAT_ID}" >> "$ENV_FILE"
              echo "📋 corthex.env 내용 확인:"
              cat "$ENV_FILE" | sed 's/\(BOT_TOKEN=\).*/\1***/'
              echo "✅ 텔레그램 봇 환경변수 설정 완료"
            fi

            # 5.7단계: API 키 환경변수 설정
            ENV_FILE="/home/ubuntu/corthex.env"
            if [ -n "${ANTHROPIC_KEY}" ]; then
              sed -i '/^ANTHROPIC_API_KEY/d' "$ENV_FILE"
              echo "ANTHROPIC_API_KEY=${ANTHROPIC_KEY}" >> "$ENV_FILE"
              echo "✅ Anthropic API 키 설정 완료"
            fi
            if [ -n "${OPENAI_KEY}" ]; then
              sed -i '/^OPENAI_API_KEY/d' "$ENV_FILE"
              echo "OPENAI_API_KEY=${OPENAI_KEY}" >> "$ENV_FILE"
              echo "✅ OpenAI API 키 설정 완료"
            fi
            if [ -n "${GOOGLE_KEY}" ]; then
              sed -i '/^GOOGLE_API_KEY/d' "$ENV_FILE"
              echo "GOOGLE_API_KEY=${GOOGLE_KEY}" >> "$ENV_FILE"
              echo "✅ Google API 키 설정 완료"
            fi
            if [ -n "${NOTION_KEY}" ]; then
              sed -i '/^NOTION_API_KEY/d' "$ENV_FILE"
              echo "NOTION_API_KEY=${NOTION_KEY}" >> "$ENV_FILE"
              echo "✅ Notion API 키 설정 완료"
            fi
            echo "📋 등록된 API 키 수: $(grep -c '_KEY=' "$ENV_FILE" || echo 0)개"

            # 6단계: 미니 서버 재시작
            echo "🔁 미니 서버 재시작 중..."
            # corthex.service가 mini_server.py를 실행하도록 확인
            if grep -q "app:app" /etc/systemd/system/corthex.service 2>/dev/null; then
              echo "♻️ corthex.service를 mini_server로 되돌리는 중..."
              sudo sed -i 's|ExecStart=.*|ExecStart=/usr/bin/python3 -m uvicorn mini_server:app --host 0.0.0.0 --port 8000|' /etc/systemd/system/corthex.service
              sudo sed -i 's|WorkingDirectory=.*|WorkingDirectory=/home/ubuntu/CORTHEX_HQ/web|' /etc/systemd/system/corthex.service
            fi
            sudo systemctl daemon-reload
            sudo systemctl restart corthex

            # 7단계: 상태 확인
            sleep 5
            if sudo systemctl is-active --quiet corthex; then
              echo "✅ 배포 완료! 미니 서버 정상 실행 중 (빌드 #${BUILD_NUMBER})"
              echo "📋 최근 서버 로그:"
              sudo journalctl -u corthex --no-pager -n 20 --no-hostname
              echo ""
              echo "📋 텔레그램 봇 진단:"
              curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "⚠️ 진단 API 호출 실패"
              echo ""
            else
              echo "❌ 미니 서버 시작 실패"
              sudo journalctl -u corthex --no-pager -n 30
              exit 1
            fi

            # 8단계: 배포 상태 JSON 저장
            echo "{\"build\":${BUILD_NUMBER},\"time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"status\":\"success\",\"commit\":\"$(cd /home/ubuntu/CORTHEX_HQ && git rev-parse --short HEAD)\"}" | sudo tee /var/www/html/deploy-status.json > /dev/null

            # 9단계: nginx 캐시 방지 설정
            if ! grep -q "no-cache" /etc/nginx/sites-available/default 2>/dev/null; then
              sudo sed -i '/location \/ {/a\\t\tadd_header Cache-Control "no-cache, no-store, must-revalidate";\n\t\tadd_header Pragma "no-cache";\n\t\tadd_header Expires "0";' /etc/nginx/sites-available/default 2>/dev/null || echo "⚠️ nginx 캐시 설정 건너뜀"
              sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || echo "⚠️ nginx 리로드 건너뜀"
            fi

            echo "🎉 배포 성공! http://168.107.28.100 에서 확인 가능 (빌드 #${BUILD_NUMBER})"
