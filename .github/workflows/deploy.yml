name: Deploy to Oracle Cloud Server

# 언제 실행? → main 브랜치에 코드가 합쳐질 때 자동 실행
on:
  push:
    branches:
      - main
    # paths 필터 제거 — main에 합쳐지면 무조건 배포 실행
    # (배포 스크립트가 가볍기 때문에 매번 실행해도 문제없음)

# 수동으로도 실행 가능 (GitHub에서 버튼 클릭)
  workflow_dispatch:

# 동시 배포 방지 — 같은 그룹은 순차 실행 (중복 배포/노션 로그 방지)
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 서버에 배포하기
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          SERVER_IP: ${{ secrets.SERVER_IP_ARM }}
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CEO_CHAT_ID: ${{ secrets.TELEGRAM_CEO_CHAT_ID }}
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_KEY_2: ${{ secrets.GOOGLE_API_KEY_2 }}
          GOOGLE_KEY_3: ${{ secrets.GOOGLE_API_KEY_3 }}
          GOOGLE_KEY_4: ${{ secrets.GOOGLE_API_KEY_4 }}
          NOTION_KEY: ${{ secrets.NOTION_API_KEY }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
          DART_KEY: ${{ secrets.DART_API_KEY }}
          ECOS_KEY: ${{ secrets.ECOS_API_KEY }}
          KIPRIS_KEY: ${{ secrets.KIPRIS_API_KEY }}
          LAW_KEY: ${{ secrets.LAW_API_KEY }}
          SERPAPI_KEY_VAR: ${{ secrets.SERPAPI_KEY }}
          SERPER_API_KEY_VAR: ${{ secrets.SERPER_API_KEY }}
          SMTP_HOST_VAR: ${{ secrets.SMTP_HOST }}
          SMTP_PORT_VAR: ${{ secrets.SMTP_PORT }}
          SMTP_USER_VAR: ${{ secrets.SMTP_USER }}
          SMTP_PASS_VAR: ${{ secrets.SMTP_PASS }}
          INSTA_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
          INSTA_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
          INSTA_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTA_REDIRECT_URI: ${{ secrets.INSTAGRAM_REDIRECT_URI }}
          INSTA_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
          YOUTUBE_CLIENT_ID_VAR: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET_VAR: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN_VAR: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DEFAULT_DB_ID }}
          NOTION_DB_SECRETARY_VAR: ${{ secrets.NOTION_DB_SECRETARY }}
          NOTION_DB_OUTPUT_VAR: ${{ secrets.NOTION_DB_OUTPUT }}
          GOOGLE_CLIENT_ID_VAR: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET_VAR: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI_VAR: ${{ secrets.GOOGLE_REDIRECT_URI }}
          GOOGLE_CAL_REDIRECT_URI: ${{ secrets.GOOGLE_CALENDAR_REDIRECT_URI }}
          REPO_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          KAKAO_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_ID_VAR: ${{ secrets.KAKAO_ID }}
          KAKAO_PW_VAR: ${{ secrets.KAKAO_PW }}
          NAVER_CLIENT_ID_VAR: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET_VAR: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_ID_VAR: ${{ secrets.NAVER_ID }}
          NAVER_PW_VAR: ${{ secrets.NAVER_PW }}
          NAVER_BLOG_ID_VAR: ${{ secrets.NAVER_BLOG_ID }}
          NAVER_REDIRECT_URI_VAR: ${{ secrets.NAVER_REDIRECT_URI }}
          DAUM_ID_VAR: ${{ secrets.DAUM_ID }}
          DAUM_PW_VAR: ${{ secrets.DAUM_PW }}
          DAUM_CAFE_ID_VAR: ${{ secrets.DAUM_CAFE_ID }}
          DAUM_CAFE_BOARD_ID_VAR: ${{ secrets.DAUM_CAFE_BOARD_ID }}
          KIS_APP_KEY: ${{ secrets.KOREA_INVEST_APP_KEY }}
          KIS_APP_SECRET: ${{ secrets.KOREA_INVEST_APP_SECRET }}
          KIS_ACCOUNT: ${{ secrets.KOREA_INVEST_ACCOUNT }}
          KIS_IS_MOCK: ${{ secrets.KOREA_INVEST_IS_MOCK }}
          KIS_MOCK_APP_KEY: ${{ secrets.KOREA_INVEST_MOCK_APP_KEY }}
          KIS_MOCK_APP_SECRET: ${{ secrets.KOREA_INVEST_MOCK_APP_SECRET }}
          KIS_MOCK_ACCOUNT: ${{ secrets.KOREA_INVEST_MOCK_ACCOUNT }}
        with:
          host: ${{ secrets.SERVER_IP_ARM }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY_ARM }}
          envs: BUILD_NUMBER,SERVER_IP,TG_BOT_TOKEN,TG_CEO_CHAT_ID,ANTHROPIC_KEY,OPENAI_KEY,GOOGLE_KEY,NOTION_KEY,CERTBOT_EMAIL,DART_KEY,ECOS_KEY,KIPRIS_KEY,LAW_KEY,SERPAPI_KEY_VAR,SMTP_HOST_VAR,SMTP_PORT_VAR,SMTP_USER_VAR,SMTP_PASS_VAR,INSTA_APP_ID,INSTA_APP_SECRET,INSTA_ACCESS_TOKEN,INSTA_REDIRECT_URI,INSTA_USER_ID,YOUTUBE_CLIENT_ID_VAR,YOUTUBE_CLIENT_SECRET_VAR,YOUTUBE_REFRESH_TOKEN_VAR,NOTION_DB_ID,NOTION_DB_SECRETARY_VAR,NOTION_DB_OUTPUT_VAR,GOOGLE_CLIENT_ID_VAR,GOOGLE_CLIENT_SECRET_VAR,GOOGLE_REDIRECT_URI_VAR,GOOGLE_CAL_REDIRECT_URI,REPO_TOKEN,KAKAO_API_KEY,KAKAO_ID_VAR,KAKAO_PW_VAR,NAVER_CLIENT_ID_VAR,NAVER_CLIENT_SECRET_VAR,NAVER_ID_VAR,NAVER_PW_VAR,NAVER_BLOG_ID_VAR,NAVER_REDIRECT_URI_VAR,DAUM_ID_VAR,DAUM_PW_VAR,DAUM_CAFE_ID_VAR,DAUM_CAFE_BOARD_ID_VAR,KIS_APP_KEY,KIS_APP_SECRET,KIS_ACCOUNT,KIS_IS_MOCK,KIS_MOCK_APP_KEY,KIS_MOCK_APP_SECRET,KIS_MOCK_ACCOUNT
          script: |
            echo "🚀 배포 시작... (빌드 #${BUILD_NUMBER})"

            # 0단계: 새 서버 초기 설정 (처음 한 번만 실행)
            if [ ! -f /home/ubuntu/venv/bin/python ]; then
              echo "🔧 새 서버 초기 설정 중..."
              sudo apt-get update -y
              sudo apt-get install -y python3-venv python3-pip nginx
              python3 -m venv /home/ubuntu/venv
              /home/ubuntu/venv/bin/pip install uvicorn fastapi httpx aiofiles
              # corthex.service 생성
              sudo tee /etc/systemd/system/corthex.service > /dev/null <<SVCEOF
            [Unit]
            Description=CORTHEX HQ Server (ARM 24GB)
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/CORTHEX_HQ/web
            ExecStart=/home/ubuntu/venv/bin/uvicorn arm_server:app --host 0.0.0.0 --port 8000
            EnvironmentFile=/home/ubuntu/corthex.env
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            SVCEOF
              sudo systemctl daemon-reload
              sudo systemctl enable corthex
              # nginx 기본 설정
              sudo tee /etc/nginx/sites-available/default > /dev/null <<NGXEOF
            server {
                listen 80 default_server;
                root /var/www/html;
                index index.html;

                # ── gzip 압축 (전송량 85% 감소) ──
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_comp_level 5;
                gzip_types text/plain text/css text/javascript application/javascript application/json image/svg+xml;

                # ── HTML: no-cache (빌드번호 캐시버스팅) ──
                location / {
                    try_files \$uri \$uri/ =404;
                    add_header Cache-Control "no-cache, no-store, must-revalidate";
                    add_header Pragma "no-cache";
                    add_header Expires "0";
                }

                # ── 정적 파일(CSS/JS/이미지): 30일 캐시 + ETag ──
                location /static/ {
                    expires 30d;
                    add_header Cache-Control "public, max-age=2592000, immutable";
                    etag on;
                }

                # ── API 프록시 ──
                location /api/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host \$host;
                    proxy_read_timeout 600s;
                    proxy_send_timeout 600s;
                    proxy_connect_timeout 60s;
                }

                # ── WebSocket 프록시 ──
                location /ws {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host \$host;
                    proxy_read_timeout 600s;
                }
            }
            NGXEOF
              sudo nginx -t && sudo systemctl restart nginx
              sudo mkdir -p /var/www/html
              # corthex.env 파일 생성 (없으면)
              touch /home/ubuntu/corthex.env
              # Oracle Cloud ARM 방화벽 열기 (iptables)
              echo "🔓 방화벽 포트 열기 중..."
              sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 8000 -j ACCEPT
              sudo mkdir -p /etc/iptables
              sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
              echo "✅ 방화벽 포트 80, 443, 8000 열림"
              echo "✅ 새 서버 초기 설정 완료"
            fi

            # 0.5단계: 방화벽 확인 (매 배포 시)
            if ! sudo iptables -C INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null; then
              echo "🔓 방화벽 포트 80 다시 열기..."
              sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 8000 -j ACCEPT
              sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
            fi

            # 1단계: GitHub에서 최신 코드 가져오기
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "📦 처음 배포 - 저장소 복제 중..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "🔄 최신 코드 가져오는 중..."
              cd CORTHEX_HQ
              # ⚠️ 이전 배포에서 sed가 index.html을 수정하므로 로컬 변경사항 발생
              # git pull이 실패하지 않도록 로컬 변경사항을 먼저 버림
              git fetch origin main
              git reset --hard origin/main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2단계: 빌드 번호를 HTML에 주입
            echo "📝 빌드 번호 주입 중... (#${BUILD_NUMBER})"
            sed "s/BUILD_NUMBER_PLACEHOLDER/${BUILD_NUMBER}/g" web/templates/index.html > /tmp/index.html

            # 3단계: 대시보드 HTML 파일 + 정적 파일 복사 (웹서버 폴더로)
            echo "📄 대시보드 파일 복사 중..."
            sudo cp /tmp/index.html /var/www/html/index.html
            # 정적 파일 (로고 이미지 등) 복사
            if [ -d "web/static" ]; then
              sudo mkdir -p /var/www/html/static
              sudo cp -r web/static/* /var/www/html/static/ 2>/dev/null || echo "⚠️ 정적 파일 없음 (무시)"
              echo "✅ 정적 파일 복사 완료 (로고, 이미지 등)"
            fi

            # 4단계: 서버 파일 복사
            # corthex 서비스는 /home/ubuntu/CORTHEX_HQ/web/ (git 저장소)에서 실행됨
            echo "🐍 서버 파일 복사 중..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/arm_server.py /home/ubuntu/web/arm_server.py
            cp web/ai_handler.py /home/ubuntu/web/ai_handler.py
            cp web/db.py /home/ubuntu/web/db.py
            cp /tmp/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "⚠️ config 파일 없음 (무시)"
            # git 저장소의 templates에도 빌드번호 주입된 HTML 복사 (서버가 여기서 읽음)
            cp /tmp/index.html /home/ubuntu/CORTHEX_HQ/web/templates/index.html
            # src/ 디렉토리 (100개+ 도구, 에이전트 모듈) — 새 서버(24GB)에서는 전부 사용 가능
            echo "🔧 도구/에이전트 모듈 복사 중..."
            if [ -d "src" ]; then
              cp -r src /home/ubuntu/CORTHEX_HQ/src 2>/dev/null || echo "⚠️ src 이미 존재 (git 저장소에서 사용)"
              echo "✅ src/ 디렉토리 (도구 모듈) 배포 완료"
            fi

            # 5단계: Python 의존성 설치 (requirements.txt 전체 설치)
            echo "📦 Python 패키지 설치 중..."
            VENV_PIP="/home/ubuntu/venv/bin/pip"
            VENV_PYTHON="/home/ubuntu/venv/bin/python3"
            if [ -x "$VENV_PIP" ]; then
              echo "📦 venv pip 사용: $VENV_PIP"
              "$VENV_PIP" install -r /home/ubuntu/CORTHEX_HQ/requirements.txt 2>&1
              # 시세 조회 핵심 패키지 강제 설치 (requirements.txt 설치 실패 시 보완)
              "$VENV_PIP" install yfinance pykrx --quiet 2>&1 || echo "⚠️ yfinance/pykrx 설치 실패"
              # 도구 필수 패키지 강제 설치 (의존성 충돌 우회 — requirements.txt 실패 시 보완)
              "$VENV_PIP" install notion-client --quiet 2>&1 || echo "⚠️ notion-client 설치 실패"
              "$VENV_PIP" install chromadb --quiet 2>&1 || echo "⚠️ chromadb 설치 실패"
              "$VENV_PIP" install bandit ruff pytest pytest-cov --quiet 2>&1 || echo "⚠️ bandit/ruff/pytest 설치 실패"
              "$VENV_PIP" install numpy-financial --quiet 2>&1 || echo "⚠️ numpy-financial 설치 실패"
              "$VENV_PIP" install "pandas-ta>=0.3.14b" --quiet 2>&1 || echo "⚠️ pandas-ta 설치 실패"
              "$VENV_PIP" install yt-dlp google-play-scraper --quiet 2>&1 || echo "⚠️ yt-dlp/google-play-scraper 설치 실패"
              echo "✅ yfinance: $("$VENV_PYTHON" -c 'import yfinance; print(yfinance.__version__)' 2>/dev/null || echo '미설치')"
              echo "✅ pykrx: $("$VENV_PYTHON" -c 'import pykrx; print("설치됨")' 2>/dev/null || echo '미설치')"
            else
              echo "⚠️ venv pip 없음 — 시스템 pip 사용"
              sudo python3 -m pip install --break-system-packages -r /home/ubuntu/CORTHEX_HQ/requirements.txt 2>&1 || true
            fi
            # 설치 확인 (venv python으로 확인)
            "$VENV_PYTHON" -c "import telegram; print(f'✅ python-telegram-bot v{telegram.__version__} 설치됨')" 2>&1 || echo "❌ telegram 모듈 임포트 실패!"
            "$VENV_PYTHON" -c "import anthropic; print(f'✅ anthropic v{anthropic.__version__} 설치됨')" 2>&1 || echo "❌ anthropic 모듈 임포트 실패!"
            "$VENV_PYTHON" -c "from google import genai; print('✅ google-genai 설치됨')" 2>&1 || echo "❌ google-genai 모듈 임포트 실패!"
            "$VENV_PYTHON" -c "import openai; print(f'✅ openai v{openai.__version__} 설치됨')" 2>&1 || echo "❌ openai 모듈 임포트 실패!"
            "$VENV_PYTHON" -c "import notion_client; print('✅ notion-client 설치됨')" 2>&1 || echo "❌ notion-client 임포트 실패!"
            "$VENV_PYTHON" -c "import chromadb; print('✅ chromadb 설치됨')" 2>&1 || echo "❌ chromadb 임포트 실패!"
            "$VENV_PYTHON" -c "import yt_dlp; print('✅ yt-dlp 설치됨')" 2>&1 || echo "❌ yt-dlp 임포트 실패!"

            # 5.5단계: YAML → JSON 변환 (venv Python 사용 — PyYAML이 venv에 설치됨)
            echo "🔄 설정 파일 JSON 변환 중..."
            "$VENV_PYTHON" /home/ubuntu/CORTHEX_HQ/config/yaml2json.py 2>&1 || echo "⚠️ JSON 변환 건너뜀"

            # 5.6단계: 텔레그램 봇 환경변수 설정
            if [ -n "${TG_BOT_TOKEN}" ]; then
              echo "🤖 텔레그램 봇 환경변수 설정 중..."
              ENV_FILE="/home/ubuntu/corthex.env"
              touch "$ENV_FILE"
              sed -i '/^TELEGRAM_/d' "$ENV_FILE"
              echo "TELEGRAM_BOT_TOKEN=${TG_BOT_TOKEN}" >> "$ENV_FILE"
              echo "TELEGRAM_CEO_CHAT_ID=${TG_CEO_CHAT_ID}" >> "$ENV_FILE"
              echo "📋 corthex.env 내용 확인:"
              cat "$ENV_FILE" | sed 's/\(BOT_TOKEN=\).*/\1***/'
              echo "✅ 텔레그램 봇 환경변수 설정 완료"
            fi

            # 5.7단계: API 키 환경변수 설정
            ENV_FILE="/home/ubuntu/corthex.env"
            if [ -n "${ANTHROPIC_KEY}" ]; then
              sed -i '/^ANTHROPIC_API_KEY/d' "$ENV_FILE"
              echo "ANTHROPIC_API_KEY=${ANTHROPIC_KEY}" >> "$ENV_FILE"
              echo "✅ Anthropic API 키 설정 완료"
            fi
            if [ -n "${OPENAI_KEY}" ]; then
              sed -i '/^OPENAI_API_KEY/d' "$ENV_FILE"
              echo "OPENAI_API_KEY=${OPENAI_KEY}" >> "$ENV_FILE"
              echo "✅ OpenAI API 키 설정 완료"
            fi
            if [ -n "${GOOGLE_KEY}" ]; then
              sed -i '/^GOOGLE_API_KEY/d' "$ENV_FILE"
              echo "GOOGLE_API_KEY=${GOOGLE_KEY}" >> "$ENV_FILE"
              echo "✅ Google API 키 설정 완료"
            fi
            # Google 멀티 키 로테이션 (프로젝트별 키 → RPM 분산)
            for i in 2 3 4; do
              eval "GK=\${GOOGLE_KEY_${i}}"
              if [ -n "${GK}" ]; then
                sed -i "/^GOOGLE_API_KEY_${i}/d" "$ENV_FILE"
                echo "GOOGLE_API_KEY_${i}=${GK}" >> "$ENV_FILE"
                echo "✅ Google API 키 #${i} 설정 완료"
              fi
            done
            if [ -n "${NOTION_KEY}" ]; then
              sed -i '/^NOTION_API_KEY/d' "$ENV_FILE"
              echo "NOTION_API_KEY=${NOTION_KEY}" >> "$ENV_FILE"
              echo "✅ Notion API 키 설정 완료"
            fi

            # 5.8단계: 전문가 도구 + 기타 API 키 설정
            if [ -n "${DART_KEY}" ]; then
              sed -i '/^DART_API_KEY/d' "$ENV_FILE"
              echo "DART_API_KEY=${DART_KEY}" >> "$ENV_FILE"
              echo "✅ DART (금감원) API 키 설정 완료"
            fi
            if [ -n "${ECOS_KEY}" ]; then
              sed -i '/^ECOS_API_KEY/d' "$ENV_FILE"
              echo "ECOS_API_KEY=${ECOS_KEY}" >> "$ENV_FILE"
              echo "✅ ECOS (한국은행) API 키 설정 완료"
            fi
            if [ -n "${KIPRIS_KEY}" ]; then
              sed -i '/^KIPRIS_API_KEY/d' "$ENV_FILE"
              echo "KIPRIS_API_KEY=${KIPRIS_KEY}" >> "$ENV_FILE"
              echo "✅ KIPRIS (특허/상표) API 키 설정 완료"
            fi
            if [ -n "${LAW_KEY}" ]; then
              sed -i '/^LAW_API_KEY/d' "$ENV_FILE"
              echo "LAW_API_KEY=${LAW_KEY}" >> "$ENV_FILE"
              echo "✅ 국가법령정보 API 키 설정 완료"
            fi
            if [ -n "${SERPAPI_KEY_VAR}" ]; then
              sed -i '/^SERPAPI_KEY/d' "$ENV_FILE"
              echo "SERPAPI_KEY=${SERPAPI_KEY_VAR}" >> "$ENV_FILE"
              echo "✅ SerpAPI (웹 검색) 키 설정 완료"
            fi
            if [ -n "${SERPER_API_KEY_VAR}" ]; then
              sed -i '/^SERPER_API_KEY/d' "$ENV_FILE"
              echo "SERPER_API_KEY=${SERPER_API_KEY_VAR}" >> "$ENV_FILE"
              echo "✅ Serper.dev (웹 검색, 월 2500회 무료) 키 설정 완료"
            fi
            if [ -n "${SMTP_HOST_VAR}" ]; then
              sed -i '/^SMTP_HOST/d; /^SMTP_PORT/d; /^SMTP_USER/d; /^SMTP_PASS/d' "$ENV_FILE"
              echo "SMTP_HOST=${SMTP_HOST_VAR}" >> "$ENV_FILE"
              echo "SMTP_PORT=${SMTP_PORT_VAR}" >> "$ENV_FILE"
              echo "SMTP_USER=${SMTP_USER_VAR}" >> "$ENV_FILE"
              echo "SMTP_PASS=${SMTP_PASS_VAR}" >> "$ENV_FILE"
              echo "✅ Gmail SMTP 설정 완료"
            fi
            if [ -n "${INSTA_APP_ID}" ]; then
              sed -i '/^INSTAGRAM_APP_ID/d; /^INSTAGRAM_APP_SECRET/d; /^INSTAGRAM_ACCESS_TOKEN/d; /^INSTAGRAM_REDIRECT_URI/d' "$ENV_FILE"
              echo "INSTAGRAM_APP_ID=${INSTA_APP_ID}" >> "$ENV_FILE"
              echo "INSTAGRAM_APP_SECRET=${INSTA_APP_SECRET}" >> "$ENV_FILE"
              echo "INSTAGRAM_ACCESS_TOKEN=${INSTA_ACCESS_TOKEN}" >> "$ENV_FILE"
              echo "INSTAGRAM_REDIRECT_URI=${INSTA_REDIRECT_URI}" >> "$ENV_FILE"
              echo "✅ Instagram API 설정 완료 (토큰 포함)"
            fi
            if [ -n "${INSTA_USER_ID}" ]; then
              sed -i '/^INSTAGRAM_USER_ID/d' "$ENV_FILE"
              echo "INSTAGRAM_USER_ID=${INSTA_USER_ID}" >> "$ENV_FILE"
              echo "✅ Instagram Business User ID 설정 완료"
            fi
            if [ -n "${YOUTUBE_CLIENT_ID_VAR}" ]; then
              sed -i '/^YOUTUBE_CLIENT_ID/d; /^YOUTUBE_CLIENT_SECRET/d; /^YOUTUBE_REFRESH_TOKEN/d' "$ENV_FILE"
              echo "YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "YOUTUBE_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN_VAR}" >> "$ENV_FILE"
              echo "✅ YouTube Data API (OAuth2) 설정 완료"
            fi
            if [ -n "${NOTION_DB_SECRETARY_VAR}" ] || [ -n "${NOTION_DB_OUTPUT_VAR}" ]; then
              sed -i '/^NOTION_DB_SECRETARY/d; /^NOTION_DB_OUTPUT/d; /^NOTION_DEFAULT_DB_ID/d; /^NOTION_DB_ARCHIVE/d' "$ENV_FILE"
              echo "NOTION_DB_SECRETARY=${NOTION_DB_SECRETARY_VAR}" >> "$ENV_FILE"
              echo "NOTION_DB_OUTPUT=${NOTION_DB_OUTPUT_VAR}" >> "$ENV_FILE"
              echo "NOTION_DB_ARCHIVE=31256b49-78dc-81c9-9ad2-e31a076d0d97" >> "$ENV_FILE"
              if [ -n "${NOTION_DB_ID}" ]; then
                echo "NOTION_DEFAULT_DB_ID=${NOTION_DB_ID}" >> "$ENV_FILE"
              fi
              echo "✅ Notion DB ID 설정 완료 (비서실/산출물/아카이브)"
            fi

            # 5.9단계: Google OAuth + SNS 계정 설정
            if [ -n "${GOOGLE_CLIENT_ID_VAR}" ]; then
              sed -i '/^GOOGLE_CLIENT_ID/d; /^GOOGLE_CLIENT_SECRET/d; /^GOOGLE_REDIRECT_URI/d; /^GOOGLE_CALENDAR_REDIRECT_URI/d' "$ENV_FILE"
              echo "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_CALENDAR_REDIRECT_URI=${GOOGLE_CAL_REDIRECT_URI}" >> "$ENV_FILE"
              echo "✅ Google OAuth (YouTube/Calendar) 설정 완료"
            fi
            if [ -n "${REPO_TOKEN}" ]; then
              sed -i '/^GITHUB_TOKEN/d; /^GITHUB_REPO/d' "$ENV_FILE"
              echo "GITHUB_TOKEN=${REPO_TOKEN}" >> "$ENV_FILE"
              echo "GITHUB_REPO=kodonghui/CORTHEX_HQ" >> "$ENV_FILE"
              echo "✅ GitHub 토큰 설정 완료"
            fi
            if [ -n "${KAKAO_API_KEY}" ]; then
              sed -i '/^KAKAO_REST_API_KEY/d; /^KAKAO_ID/d; /^KAKAO_PW/d' "$ENV_FILE"
              echo "KAKAO_REST_API_KEY=${KAKAO_API_KEY}" >> "$ENV_FILE"
              echo "KAKAO_ID=${KAKAO_ID_VAR}" >> "$ENV_FILE"
              echo "KAKAO_PW=${KAKAO_PW_VAR}" >> "$ENV_FILE"
              echo "✅ 카카오 API + 계정 설정 완료"
            fi
            if [ -n "${NAVER_CLIENT_ID_VAR}" ]; then
              sed -i '/^NAVER_CLIENT_ID/d; /^NAVER_CLIENT_SECRET/d; /^NAVER_ID/d; /^NAVER_PW/d; /^NAVER_BLOG_ID/d; /^NAVER_REDIRECT_URI/d' "$ENV_FILE"
              echo "NAVER_CLIENT_ID=${NAVER_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "NAVER_ID=${NAVER_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_PW=${NAVER_PW_VAR}" >> "$ENV_FILE"
              echo "NAVER_BLOG_ID=${NAVER_BLOG_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_REDIRECT_URI=${NAVER_REDIRECT_URI_VAR}" >> "$ENV_FILE"
              echo "✅ 네이버 API + 블로그 계정 설정 완료"
            fi
            if [ -n "${DAUM_ID_VAR}" ]; then
              sed -i '/^DAUM_ID/d; /^DAUM_PW/d; /^DAUM_CAFE_ID/d; /^DAUM_CAFE_BOARD_ID/d' "$ENV_FILE"
              echo "DAUM_ID=${DAUM_ID_VAR}" >> "$ENV_FILE"
              echo "DAUM_PW=${DAUM_PW_VAR}" >> "$ENV_FILE"
              echo "DAUM_CAFE_ID=${DAUM_CAFE_ID_VAR}" >> "$ENV_FILE"
              echo "DAUM_CAFE_BOARD_ID=${DAUM_CAFE_BOARD_ID_VAR}" >> "$ENV_FILE"
              echo "✅ 다음 카페 계정 설정 완료"
            fi
            if [ -n "${KIS_APP_KEY}" ]; then
              sed -i '/^KOREA_INVEST_APP_KEY/d; /^KOREA_INVEST_APP_SECRET/d; /^KOREA_INVEST_ACCOUNT/d; /^KOREA_INVEST_IS_MOCK/d' "$ENV_FILE"
              echo "KOREA_INVEST_APP_KEY=${KIS_APP_KEY}" >> "$ENV_FILE"
              echo "KOREA_INVEST_APP_SECRET=${KIS_APP_SECRET}" >> "$ENV_FILE"
              echo "KOREA_INVEST_ACCOUNT=${KIS_ACCOUNT}" >> "$ENV_FILE"
              echo "KOREA_INVEST_IS_MOCK=${KIS_IS_MOCK}" >> "$ENV_FILE"
              echo "✅ 한국투자증권 KIS API 설정 완료"
            fi
            if [ -n "${KIS_MOCK_APP_KEY}" ]; then
              sed -i '/^KOREA_INVEST_MOCK_APP_KEY/d; /^KOREA_INVEST_MOCK_APP_SECRET/d; /^KOREA_INVEST_MOCK_ACCOUNT/d' "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_APP_KEY=${KIS_MOCK_APP_KEY}" >> "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_APP_SECRET=${KIS_MOCK_APP_SECRET}" >> "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_ACCOUNT=${KIS_MOCK_ACCOUNT}" >> "$ENV_FILE"
              echo "✅ KIS 모의투자 Shadow Trading 설정 완료"
            fi
            echo "📋 등록된 API 키 수: $(grep -c '_KEY\|_ID\|_PASS\|_HOST\|_PORT\|_USER\|_TOKEN' "$ENV_FILE" || echo 0)개"

            # 6단계: 서버 재시작
            echo "🔁 서버 재시작 중..."
            # corthex.service가 올바른 경로로 arm_server.py를 실행하도록 강제 설정
            echo "♻️ corthex.service ExecStart 복원 중..."
            sudo sed -i 's|ExecStart=.*|ExecStart=/home/ubuntu/venv/bin/uvicorn arm_server:app --host 0.0.0.0 --port 8000|' /etc/systemd/system/corthex.service
            sudo sed -i 's|WorkingDirectory=.*|WorkingDirectory=/home/ubuntu/CORTHEX_HQ/web|' /etc/systemd/system/corthex.service
            sudo systemctl daemon-reload
            sudo systemctl restart corthex

            # 7단계: 상태 확인
            sleep 5
            if sudo systemctl is-active --quiet corthex; then
              echo "✅ 배포 완료! 서버 정상 실행 중 (빌드 #${BUILD_NUMBER})"
              echo "📋 최근 서버 로그:"
              sudo journalctl -u corthex --no-pager -n 20 --no-hostname
              echo ""
              echo "📋 텔레그램 봇 진단:"
              TG_STATUS=$(curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "API_FAIL")
              echo "$TG_STATUS"
              # 봇 시작 실패 시 한 번 더 재시작 시도
              if echo "$TG_STATUS" | grep -q '"tg_started": false\|"tg_started":false\|API_FAIL'; then
                echo "⚠️ 텔레그램 봇 미시작 — 서버 재시작 재시도..."
                sleep 3
                sudo systemctl restart corthex
                sleep 8
                curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "⚠️ 재시도 후에도 진단 실패"
              fi
              echo ""
            else
              echo "❌ 서버 시작 실패"
              sudo journalctl -u corthex --no-pager -n 30
              exit 1
            fi

            # 8단계: 배포 상태 JSON 저장
            echo "{\"build\":${BUILD_NUMBER},\"time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"status\":\"success\",\"commit\":\"$(cd /home/ubuntu/CORTHEX_HQ && git rev-parse --short HEAD)\"}" | sudo tee /var/www/html/deploy-status.json > /dev/null

            # 8.5단계: 노션 배포 로그 자동 기록
            if [ -n "${NOTION_KEY}" ]; then
              echo "📝 노션 배포 로그 기록 중..."
              export NOTION_KEY="${NOTION_KEY}"
              export BUILD_NUMBER="${BUILD_NUMBER}"
              cd /home/ubuntu/CORTHEX_HQ
              # 머지 커밋이면 실제 작업 커밋 메시지 추출, 아니면 현재 커밋 메시지
              if git rev-parse HEAD^2 >/dev/null 2>&1; then
                export DEPLOY_COMMIT="$(git log -1 --pretty=%s HEAD^2 | sed 's/\[완료\]//g; s/^feat: //; s/^fix: //; s/^refactor: //; s/^docs: //' | head -c 200)"
                export DEPLOY_BODY="$(git log -1 --pretty=%b HEAD^2 | head -c 1800)"
              else
                export DEPLOY_COMMIT="$(git log -1 --pretty=%s | sed 's/\[완료\]//g; s/^feat: //; s/^fix: //; s/^refactor: //; s/^docs: //' | head -c 200)"
                export DEPLOY_BODY="$(git log -1 --pretty=%b | head -c 1800)"
              fi
              export DEPLOY_FILES="$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')"
              export DEPLOY_DATE="$(TZ=Asia/Seoul date +%Y-%m-%d)"
              # 버전: 4.00.{빌드번호} — 빌드마다 자동 증가, 순환 커밋 없음
              export DEPLOY_VERSION="4.00.${BUILD_NUMBER}"
              # 내용 열 없으면 먼저 DB 스키마에 추가
              /home/ubuntu/venv/bin/python3 << 'PYEOF'
            import urllib.request, json, os, sys
            notion_key = os.environ.get("NOTION_KEY", "")
            db_id = "30e56b49-78dc-819d-b666-e50aec6a04aa"
            headers = {
                "Authorization": "Bearer " + notion_key,
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
            }
            # DB 스키마 조회 → 내용 열 없으면 추가
            try:
                req = urllib.request.Request(f"https://api.notion.com/v1/databases/{db_id}", headers=headers)
                with urllib.request.urlopen(req, timeout=10) as r:
                    db_info = json.loads(r.read())
                if "내용" not in db_info.get("properties", {}):
                    patch_body = json.dumps({"properties": {"내용": {"rich_text": {}}}}).encode()
                    req2 = urllib.request.Request(f"https://api.notion.com/v1/databases/{db_id}",
                                                   data=patch_body, headers=headers, method="PATCH")
                    urllib.request.urlopen(req2, timeout=10)
                    print("내용 열 추가 완료")
            except Exception as e:
                print(f"스키마 확인 실패 (무시): {e}")
            # 페이지 저장
            url = "https://api.notion.com/v1/pages"
            commit = os.environ.get("DEPLOY_COMMIT", "auto deploy").strip()
            body_text = os.environ.get("DEPLOY_BODY", "").strip()
            build = int(os.environ.get("BUILD_NUMBER", "0"))
            date = os.environ.get("DEPLOY_DATE", "")
            version = os.environ.get("DEPLOY_VERSION", "")
            files = int(os.environ.get("DEPLOY_FILES", "0"))
            props = {
                "Name": {"title": [{"text": {"content": commit}}]},
                "빌드": {"number": build},
                "날짜": {"date": {"start": date}},
                "카테고리": {"select": {"name": "자동배포"}},
                "상태": {"select": {"name": "배포완료"}},
                "변경파일수": {"number": files},
                "중요도": {"select": {"name": "중"}},
                "버전": {"rich_text": [{"text": {"content": version}}]},
            }
            if body_text:
                props["내용"] = {"rich_text": [{"text": {"content": body_text[:1900]}}]}
            page_body = json.dumps({
                "parent": {"database_id": db_id},
                "properties": props
            }).encode("utf-8")
            req = urllib.request.Request(url, data=page_body, headers=headers, method="POST")
            try:
                urllib.request.urlopen(req)
                print(f"OK - recorded build #{build} v{version}")
            except Exception as e:
                print("FAIL: " + str(e))
                sys.exit(1)
            PYEOF
              if [ $? -eq 0 ]; then
                echo "✅ 노션 배포 로그 기록 완료 (빌드 #${BUILD_NUMBER}, v${DEPLOY_VERSION})"
              else
                echo "⚠️ 노션 배포 로그 기록 실패 (배포 자체는 성공)"
              fi
            fi

            # 9단계: nginx 캐시 방지 설정
            if ! grep -q "no-cache" /etc/nginx/sites-available/default 2>/dev/null; then
              sudo sed -i '/location \/ {/a\\t\tadd_header Cache-Control "no-cache, no-store, must-revalidate";\n\t\tadd_header Pragma "no-cache";\n\t\tadd_header Expires "0";' /etc/nginx/sites-available/default 2>/dev/null || echo "⚠️ nginx 캐시 설정 건너뜀"
              sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || echo "⚠️ nginx 리로드 건너뜀"
            fi

            # 9.3단계: 시스템 패키지 자동 설치 (처음 한 번만)
            # pandoc (문서 변환 도구 — Word/Markdown/PDF 상호 변환)
            if ! command -v pandoc &>/dev/null; then
              echo "📄 pandoc 설치 중..."
              sudo apt-get install -y pandoc 2>&1 | tail -3
              echo "✅ pandoc 설치 완료: $(pandoc --version | head -1)"
            else
              echo "✅ pandoc 이미 설치됨: $(pandoc --version | head -1)"
            fi

            # Chromium 브라우저 자동 설치 (처음 한 번만)
            if ! command -v chromium-browser &>/dev/null && ! command -v chromium &>/dev/null; then
              echo "Chromium + ChromeDriver 설치 중... (Selenium SNS 도구용)"
              sudo apt-get install -y chromium-browser chromium-chromedriver 2>&1 | tail -5 || \n              sudo apt-get install -y chromium chromium-driver 2>&1 | tail -5 || \n              echo "⚠️ Chromium 설치 실패 (별도 안내로 후처리 가능)"
              if command -v chromium-browser &>/dev/null; then
                echo "✅ chromium-browser 설치 완료: $(chromium-browser --version)"
              elif command -v chromium &>/dev/null; then
                echo "✅ chromium 설치 완료: $(chromium --version)"
              fi
            else
              echo "✅ Chromium 이미 설치됨 -- Selenium SNS 도구 사용 가능"
            fi

            # 9.5단계: HTTPS (Let's Encrypt 무료 인증서) 설정
            CERT_PATH="/etc/letsencrypt/live/corthex-hq.com/fullchain.pem"
            if [ ! -f "$CERT_PATH" ]; then
              echo "🔒 HTTPS 인증서 발급 중... (첫 배포 시 1회만 실행)"
              sudo apt-get install -y certbot python3-certbot-nginx 2>&1 | tail -3
              if [ -n "${CERTBOT_EMAIL}" ]; then
                sudo certbot --nginx -d corthex-hq.com -d www.corthex-hq.com \
                  --non-interactive --agree-tos --email "${CERTBOT_EMAIL}" \
                  --redirect 2>&1
              else
                sudo certbot --nginx -d corthex-hq.com -d www.corthex-hq.com \
                  --non-interactive --agree-tos --register-unsafely-without-email \
                  --redirect 2>&1
              fi
              if [ -f "$CERT_PATH" ]; then
                echo "✅ HTTPS 인증서 발급 완료! https://corthex-hq.com 접속 가능"
              else
                echo "⚠️ HTTPS 인증서 발급 실패 — HTTP로 계속 운영됨"
              fi
            else
              echo "✅ HTTPS 인증서 이미 존재 — 만료 전 자동 갱신 확인 중..."
              sudo certbot renew --quiet 2>&1 || echo "⚠️ 인증서 갱신 건너뜀 (아직 만료 아님)"
            fi

            echo "🎉 배포 성공! https://corthex-hq.com 에서 확인 가능 (빌드 #${BUILD_NUMBER})"
