name: Deploy to Oracle Cloud Server

# ì–¸ì œ ì‹¤í–‰? â†’ main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í•©ì³ì§ˆ ë•Œ ìë™ ì‹¤í–‰
on:
  push:
    branches:
      - main
    # paths í•„í„° ì œê±° â€” mainì— í•©ì³ì§€ë©´ ë¬´ì¡°ê±´ ë°°í¬ ì‹¤í–‰
    # (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ê°€ë³ê¸° ë•Œë¬¸ì— ë§¤ë²ˆ ì‹¤í–‰í•´ë„ ë¬¸ì œì—†ìŒ)

# ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥ (GitHubì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:

# ë™ì‹œ ë°°í¬ ë°©ì§€ â€” ê°™ì€ ê·¸ë£¹ì€ ìˆœì°¨ ì‹¤í–‰ (ì¤‘ë³µ ë°°í¬/ë…¸ì…˜ ë¡œê·¸ ë°©ì§€)
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ì„œë²„ì— ë°°í¬í•˜ê¸°
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          SERVER_IP: ${{ secrets.SERVER_IP_ARM }}
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CEO_CHAT_ID: ${{ secrets.TELEGRAM_CEO_CHAT_ID }}
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_KEY: ${{ secrets.GOOGLE_API_KEY }}
          NOTION_KEY: ${{ secrets.NOTION_API_KEY }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
          DART_KEY: ${{ secrets.DART_API_KEY }}
          ECOS_KEY: ${{ secrets.ECOS_API_KEY }}
          KIPRIS_KEY: ${{ secrets.KIPRIS_API_KEY }}
          LAW_KEY: ${{ secrets.LAW_API_KEY }}
          SERPAPI_KEY_VAR: ${{ secrets.SERPAPI_KEY }}
          SERPER_API_KEY_VAR: ${{ secrets.SERPER_API_KEY }}
          SMTP_HOST_VAR: ${{ secrets.SMTP_HOST }}
          SMTP_PORT_VAR: ${{ secrets.SMTP_PORT }}
          SMTP_USER_VAR: ${{ secrets.SMTP_USER }}
          SMTP_PASS_VAR: ${{ secrets.SMTP_PASS }}
          INSTA_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
          INSTA_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
          INSTA_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTA_REDIRECT_URI: ${{ secrets.INSTAGRAM_REDIRECT_URI }}
          INSTA_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
          YOUTUBE_CLIENT_ID_VAR: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET_VAR: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN_VAR: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DEFAULT_DB_ID }}
          NOTION_DB_SECRETARY_VAR: ${{ secrets.NOTION_DB_SECRETARY }}
          NOTION_DB_OUTPUT_VAR: ${{ secrets.NOTION_DB_OUTPUT }}
          GOOGLE_CLIENT_ID_VAR: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET_VAR: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI_VAR: ${{ secrets.GOOGLE_REDIRECT_URI }}
          GOOGLE_CAL_REDIRECT_URI: ${{ secrets.GOOGLE_CALENDAR_REDIRECT_URI }}
          REPO_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          KAKAO_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_ID_VAR: ${{ secrets.KAKAO_ID }}
          KAKAO_PW_VAR: ${{ secrets.KAKAO_PW }}
          NAVER_CLIENT_ID_VAR: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET_VAR: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_ID_VAR: ${{ secrets.NAVER_ID }}
          NAVER_PW_VAR: ${{ secrets.NAVER_PW }}
          NAVER_BLOG_ID_VAR: ${{ secrets.NAVER_BLOG_ID }}
          NAVER_REDIRECT_URI_VAR: ${{ secrets.NAVER_REDIRECT_URI }}
          DAUM_ID_VAR: ${{ secrets.DAUM_ID }}
          DAUM_PW_VAR: ${{ secrets.DAUM_PW }}
          DAUM_CAFE_ID_VAR: ${{ secrets.DAUM_CAFE_ID }}
          DAUM_CAFE_BOARD_ID_VAR: ${{ secrets.DAUM_CAFE_BOARD_ID }}
          KIS_APP_KEY: ${{ secrets.KOREA_INVEST_APP_KEY }}
          KIS_APP_SECRET: ${{ secrets.KOREA_INVEST_APP_SECRET }}
          KIS_ACCOUNT: ${{ secrets.KOREA_INVEST_ACCOUNT }}
          KIS_IS_MOCK: ${{ secrets.KOREA_INVEST_IS_MOCK }}
          KIS_MOCK_APP_KEY: ${{ secrets.KOREA_INVEST_MOCK_APP_KEY }}
          KIS_MOCK_APP_SECRET: ${{ secrets.KOREA_INVEST_MOCK_APP_SECRET }}
          KIS_MOCK_ACCOUNT: ${{ secrets.KOREA_INVEST_MOCK_ACCOUNT }}
        with:
          host: ${{ secrets.SERVER_IP_ARM }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY_ARM }}
          envs: BUILD_NUMBER,SERVER_IP,TG_BOT_TOKEN,TG_CEO_CHAT_ID,ANTHROPIC_KEY,OPENAI_KEY,GOOGLE_KEY,NOTION_KEY,CERTBOT_EMAIL,DART_KEY,ECOS_KEY,KIPRIS_KEY,LAW_KEY,SERPAPI_KEY_VAR,SMTP_HOST_VAR,SMTP_PORT_VAR,SMTP_USER_VAR,SMTP_PASS_VAR,INSTA_APP_ID,INSTA_APP_SECRET,INSTA_ACCESS_TOKEN,INSTA_REDIRECT_URI,INSTA_USER_ID,YOUTUBE_CLIENT_ID_VAR,YOUTUBE_CLIENT_SECRET_VAR,YOUTUBE_REFRESH_TOKEN_VAR,NOTION_DB_ID,NOTION_DB_SECRETARY_VAR,NOTION_DB_OUTPUT_VAR,GOOGLE_CLIENT_ID_VAR,GOOGLE_CLIENT_SECRET_VAR,GOOGLE_REDIRECT_URI_VAR,GOOGLE_CAL_REDIRECT_URI,REPO_TOKEN,KAKAO_API_KEY,KAKAO_ID_VAR,KAKAO_PW_VAR,NAVER_CLIENT_ID_VAR,NAVER_CLIENT_SECRET_VAR,NAVER_ID_VAR,NAVER_PW_VAR,NAVER_BLOG_ID_VAR,NAVER_REDIRECT_URI_VAR,DAUM_ID_VAR,DAUM_PW_VAR,DAUM_CAFE_ID_VAR,DAUM_CAFE_BOARD_ID_VAR,KIS_APP_KEY,KIS_APP_SECRET,KIS_ACCOUNT,KIS_IS_MOCK,KIS_MOCK_APP_KEY,KIS_MOCK_APP_SECRET,KIS_MOCK_ACCOUNT
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘... (ë¹Œë“œ #${BUILD_NUMBER})"

            # 0ë‹¨ê³„: ìƒˆ ì„œë²„ ì´ˆê¸° ì„¤ì • (ì²˜ìŒ í•œ ë²ˆë§Œ ì‹¤í–‰)
            if [ ! -f /home/ubuntu/venv/bin/python ]; then
              echo "ğŸ”§ ìƒˆ ì„œë²„ ì´ˆê¸° ì„¤ì • ì¤‘..."
              sudo apt-get update -y
              sudo apt-get install -y python3-venv python3-pip nginx
              python3 -m venv /home/ubuntu/venv
              /home/ubuntu/venv/bin/pip install uvicorn fastapi httpx aiofiles
              # corthex.service ìƒì„±
              sudo tee /etc/systemd/system/corthex.service > /dev/null <<SVCEOF
            [Unit]
            Description=CORTHEX HQ Server (ARM 24GB)
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/CORTHEX_HQ/web
            ExecStart=/home/ubuntu/venv/bin/uvicorn mini_server:app --host 0.0.0.0 --port 8000
            EnvironmentFile=/home/ubuntu/corthex.env
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            SVCEOF
              sudo systemctl daemon-reload
              sudo systemctl enable corthex
              # nginx ê¸°ë³¸ ì„¤ì •
              sudo tee /etc/nginx/sites-available/default > /dev/null <<NGXEOF
            server {
                listen 80 default_server;
                root /var/www/html;
                index index.html;
                location / {
                    try_files \$uri \$uri/ =404;
                    add_header Cache-Control "no-cache, no-store, must-revalidate";
                    add_header Pragma "no-cache";
                    add_header Expires "0";
                }
                location /api/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host \$host;
                    proxy_read_timeout 600s;
                    proxy_send_timeout 600s;
                    proxy_connect_timeout 60s;
                }
                location /ws {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host \$host;
                    proxy_read_timeout 600s;
                }
            }
            NGXEOF
              sudo nginx -t && sudo systemctl restart nginx
              sudo mkdir -p /var/www/html
              # corthex.env íŒŒì¼ ìƒì„± (ì—†ìœ¼ë©´)
              touch /home/ubuntu/corthex.env
              # Oracle Cloud ARM ë°©í™”ë²½ ì—´ê¸° (iptables)
              echo "ğŸ”“ ë°©í™”ë²½ í¬íŠ¸ ì—´ê¸° ì¤‘..."
              sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 8000 -j ACCEPT
              sudo mkdir -p /etc/iptables
              sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
              echo "âœ… ë°©í™”ë²½ í¬íŠ¸ 80, 443, 8000 ì—´ë¦¼"
              echo "âœ… ìƒˆ ì„œë²„ ì´ˆê¸° ì„¤ì • ì™„ë£Œ"
            fi

            # 0.5ë‹¨ê³„: ë°©í™”ë²½ í™•ì¸ (ë§¤ ë°°í¬ ì‹œ)
            if ! sudo iptables -C INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null; then
              echo "ğŸ”“ ë°©í™”ë²½ í¬íŠ¸ 80 ë‹¤ì‹œ ì—´ê¸°..."
              sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
              sudo iptables -I INPUT -p tcp --dport 8000 -j ACCEPT
              sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
            fi

            # 1ë‹¨ê³„: GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "ğŸ“¦ ì²˜ìŒ ë°°í¬ - ì €ì¥ì†Œ ë³µì œ ì¤‘..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
              cd CORTHEX_HQ
              # âš ï¸ ì´ì „ ë°°í¬ì—ì„œ sedê°€ index.htmlì„ ìˆ˜ì •í•˜ë¯€ë¡œ ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë°œìƒ
              # git pullì´ ì‹¤íŒ¨í•˜ì§€ ì•Šë„ë¡ ë¡œì»¬ ë³€ê²½ì‚¬í•­ì„ ë¨¼ì € ë²„ë¦¼
              git fetch origin main
              git reset --hard origin/main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2ë‹¨ê³„: ë¹Œë“œ ë²ˆí˜¸ë¥¼ HTMLì— ì£¼ì…
            echo "ğŸ“ ë¹Œë“œ ë²ˆí˜¸ ì£¼ì… ì¤‘... (#${BUILD_NUMBER})"
            sed "s/BUILD_NUMBER_PLACEHOLDER/${BUILD_NUMBER}/g" web/templates/index.html > /tmp/index.html

            # 3ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ HTML íŒŒì¼ + ì •ì  íŒŒì¼ ë³µì‚¬ (ì›¹ì„œë²„ í´ë”ë¡œ)
            echo "ğŸ“„ ëŒ€ì‹œë³´ë“œ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            sudo cp /tmp/index.html /var/www/html/index.html
            # ì •ì  íŒŒì¼ (ë¡œê³  ì´ë¯¸ì§€ ë“±) ë³µì‚¬
            if [ -d "web/static" ]; then
              sudo mkdir -p /var/www/html/static
              sudo cp -r web/static/* /var/www/html/static/ 2>/dev/null || echo "âš ï¸ ì •ì  íŒŒì¼ ì—†ìŒ (ë¬´ì‹œ)"
              echo "âœ… ì •ì  íŒŒì¼ ë³µì‚¬ ì™„ë£Œ (ë¡œê³ , ì´ë¯¸ì§€ ë“±)"
            fi

            # 4ë‹¨ê³„: ì„œë²„ íŒŒì¼ ë³µì‚¬
            # corthex ì„œë¹„ìŠ¤ëŠ” /home/ubuntu/CORTHEX_HQ/web/ (git ì €ì¥ì†Œ)ì—ì„œ ì‹¤í–‰ë¨
            echo "ğŸ ì„œë²„ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp web/ai_handler.py /home/ubuntu/web/ai_handler.py
            cp web/db.py /home/ubuntu/web/db.py
            cp /tmp/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "âš ï¸ config íŒŒì¼ ì—†ìŒ (ë¬´ì‹œ)"
            # git ì €ì¥ì†Œì˜ templatesì—ë„ ë¹Œë“œë²ˆí˜¸ ì£¼ì…ëœ HTML ë³µì‚¬ (ì„œë²„ê°€ ì—¬ê¸°ì„œ ì½ìŒ)
            cp /tmp/index.html /home/ubuntu/CORTHEX_HQ/web/templates/index.html
            # src/ ë””ë ‰í† ë¦¬ (100ê°œ+ ë„êµ¬, ì—ì´ì „íŠ¸ ëª¨ë“ˆ) â€” ìƒˆ ì„œë²„(24GB)ì—ì„œëŠ” ì „ë¶€ ì‚¬ìš© ê°€ëŠ¥
            echo "ğŸ”§ ë„êµ¬/ì—ì´ì „íŠ¸ ëª¨ë“ˆ ë³µì‚¬ ì¤‘..."
            if [ -d "src" ]; then
              cp -r src /home/ubuntu/CORTHEX_HQ/src 2>/dev/null || echo "âš ï¸ src ì´ë¯¸ ì¡´ì¬ (git ì €ì¥ì†Œì—ì„œ ì‚¬ìš©)"
              echo "âœ… src/ ë””ë ‰í† ë¦¬ (ë„êµ¬ ëª¨ë“ˆ) ë°°í¬ ì™„ë£Œ"
            fi

            # 5ë‹¨ê³„: Python ì˜ì¡´ì„± ì„¤ì¹˜ (requirements.txt ì „ì²´ ì„¤ì¹˜)
            echo "ğŸ“¦ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            VENV_PIP="/home/ubuntu/venv/bin/pip"
            VENV_PYTHON="/home/ubuntu/venv/bin/python3"
            if [ -x "$VENV_PIP" ]; then
              echo "ğŸ“¦ venv pip ì‚¬ìš©: $VENV_PIP"
              "$VENV_PIP" install -r /home/ubuntu/CORTHEX_HQ/requirements.txt 2>&1
              # ì‹œì„¸ ì¡°íšŒ í•µì‹¬ íŒ¨í‚¤ì§€ ê°•ì œ ì„¤ì¹˜ (requirements.txt ì„¤ì¹˜ ì‹¤íŒ¨ ì‹œ ë³´ì™„)
              "$VENV_PIP" install yfinance pykrx --quiet 2>&1 || echo "âš ï¸ yfinance/pykrx ì„¤ì¹˜ ì‹¤íŒ¨"
              # ë„êµ¬ í•„ìˆ˜ íŒ¨í‚¤ì§€ ê°•ì œ ì„¤ì¹˜ (ì˜ì¡´ì„± ì¶©ëŒ ìš°íšŒ â€” requirements.txt ì‹¤íŒ¨ ì‹œ ë³´ì™„)
              "$VENV_PIP" install notion-client --quiet 2>&1 || echo "âš ï¸ notion-client ì„¤ì¹˜ ì‹¤íŒ¨"
              "$VENV_PIP" install chromadb --quiet 2>&1 || echo "âš ï¸ chromadb ì„¤ì¹˜ ì‹¤íŒ¨"
              "$VENV_PIP" install bandit ruff pytest pytest-cov --quiet 2>&1 || echo "âš ï¸ bandit/ruff/pytest ì„¤ì¹˜ ì‹¤íŒ¨"
              "$VENV_PIP" install numpy-financial --quiet 2>&1 || echo "âš ï¸ numpy-financial ì„¤ì¹˜ ì‹¤íŒ¨"
              "$VENV_PIP" install "pandas-ta>=0.3.14b" --quiet 2>&1 || echo "âš ï¸ pandas-ta ì„¤ì¹˜ ì‹¤íŒ¨"
              "$VENV_PIP" install yt-dlp google-play-scraper --quiet 2>&1 || echo "âš ï¸ yt-dlp/google-play-scraper ì„¤ì¹˜ ì‹¤íŒ¨"
              echo "âœ… yfinance: $("$VENV_PYTHON" -c 'import yfinance; print(yfinance.__version__)' 2>/dev/null || echo 'ë¯¸ì„¤ì¹˜')"
              echo "âœ… pykrx: $("$VENV_PYTHON" -c 'import pykrx; print("ì„¤ì¹˜ë¨")' 2>/dev/null || echo 'ë¯¸ì„¤ì¹˜')"
            else
              echo "âš ï¸ venv pip ì—†ìŒ â€” ì‹œìŠ¤í…œ pip ì‚¬ìš©"
              sudo python3 -m pip install --break-system-packages -r /home/ubuntu/CORTHEX_HQ/requirements.txt 2>&1 || true
            fi
            # ì„¤ì¹˜ í™•ì¸ (venv pythonìœ¼ë¡œ í™•ì¸)
            "$VENV_PYTHON" -c "import telegram; print(f'âœ… python-telegram-bot v{telegram.__version__} ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ telegram ëª¨ë“ˆ ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "import anthropic; print(f'âœ… anthropic v{anthropic.__version__} ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ anthropic ëª¨ë“ˆ ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "from google import genai; print('âœ… google-genai ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ google-genai ëª¨ë“ˆ ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "import openai; print(f'âœ… openai v{openai.__version__} ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ openai ëª¨ë“ˆ ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "import notion_client; print('âœ… notion-client ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ notion-client ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "import chromadb; print('âœ… chromadb ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ chromadb ì„í¬íŠ¸ ì‹¤íŒ¨!"
            "$VENV_PYTHON" -c "import yt_dlp; print('âœ… yt-dlp ì„¤ì¹˜ë¨')" 2>&1 || echo "âŒ yt-dlp ì„í¬íŠ¸ ì‹¤íŒ¨!"

            # 5.5ë‹¨ê³„: YAML â†’ JSON ë³€í™˜ (venv Python ì‚¬ìš© â€” PyYAMLì´ venvì— ì„¤ì¹˜ë¨)
            echo "ğŸ”„ ì„¤ì • íŒŒì¼ JSON ë³€í™˜ ì¤‘..."
            "$VENV_PYTHON" /home/ubuntu/CORTHEX_HQ/config/yaml2json.py 2>&1 || echo "âš ï¸ JSON ë³€í™˜ ê±´ë„ˆëœ€"

            # 5.6ë‹¨ê³„: í…”ë ˆê·¸ë¨ ë´‡ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            if [ -n "${TG_BOT_TOKEN}" ]; then
              echo "ğŸ¤– í…”ë ˆê·¸ë¨ ë´‡ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
              ENV_FILE="/home/ubuntu/corthex.env"
              touch "$ENV_FILE"
              sed -i '/^TELEGRAM_/d' "$ENV_FILE"
              echo "TELEGRAM_BOT_TOKEN=${TG_BOT_TOKEN}" >> "$ENV_FILE"
              echo "TELEGRAM_CEO_CHAT_ID=${TG_CEO_CHAT_ID}" >> "$ENV_FILE"
              echo "ğŸ“‹ corthex.env ë‚´ìš© í™•ì¸:"
              cat "$ENV_FILE" | sed 's/\(BOT_TOKEN=\).*/\1***/'
              echo "âœ… í…”ë ˆê·¸ë¨ ë´‡ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
            fi

            # 5.7ë‹¨ê³„: API í‚¤ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            ENV_FILE="/home/ubuntu/corthex.env"
            if [ -n "${ANTHROPIC_KEY}" ]; then
              sed -i '/^ANTHROPIC_API_KEY/d' "$ENV_FILE"
              echo "ANTHROPIC_API_KEY=${ANTHROPIC_KEY}" >> "$ENV_FILE"
              echo "âœ… Anthropic API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${OPENAI_KEY}" ]; then
              sed -i '/^OPENAI_API_KEY/d' "$ENV_FILE"
              echo "OPENAI_API_KEY=${OPENAI_KEY}" >> "$ENV_FILE"
              echo "âœ… OpenAI API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${GOOGLE_KEY}" ]; then
              sed -i '/^GOOGLE_API_KEY/d' "$ENV_FILE"
              echo "GOOGLE_API_KEY=${GOOGLE_KEY}" >> "$ENV_FILE"
              echo "âœ… Google API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${NOTION_KEY}" ]; then
              sed -i '/^NOTION_API_KEY/d' "$ENV_FILE"
              echo "NOTION_API_KEY=${NOTION_KEY}" >> "$ENV_FILE"
              echo "âœ… Notion API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi

            # 5.8ë‹¨ê³„: ì „ë¬¸ê°€ ë„êµ¬ + ê¸°íƒ€ API í‚¤ ì„¤ì •
            if [ -n "${DART_KEY}" ]; then
              sed -i '/^DART_API_KEY/d' "$ENV_FILE"
              echo "DART_API_KEY=${DART_KEY}" >> "$ENV_FILE"
              echo "âœ… DART (ê¸ˆê°ì›) API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${ECOS_KEY}" ]; then
              sed -i '/^ECOS_API_KEY/d' "$ENV_FILE"
              echo "ECOS_API_KEY=${ECOS_KEY}" >> "$ENV_FILE"
              echo "âœ… ECOS (í•œêµ­ì€í–‰) API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${KIPRIS_KEY}" ]; then
              sed -i '/^KIPRIS_API_KEY/d' "$ENV_FILE"
              echo "KIPRIS_API_KEY=${KIPRIS_KEY}" >> "$ENV_FILE"
              echo "âœ… KIPRIS (íŠ¹í—ˆ/ìƒí‘œ) API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${LAW_KEY}" ]; then
              sed -i '/^LAW_API_KEY/d' "$ENV_FILE"
              echo "LAW_API_KEY=${LAW_KEY}" >> "$ENV_FILE"
              echo "âœ… êµ­ê°€ë²•ë ¹ì •ë³´ API í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${SERPAPI_KEY_VAR}" ]; then
              sed -i '/^SERPAPI_KEY/d' "$ENV_FILE"
              echo "SERPAPI_KEY=${SERPAPI_KEY_VAR}" >> "$ENV_FILE"
              echo "âœ… SerpAPI (ì›¹ ê²€ìƒ‰) í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${SERPER_API_KEY_VAR}" ]; then
              sed -i '/^SERPER_API_KEY/d' "$ENV_FILE"
              echo "SERPER_API_KEY=${SERPER_API_KEY_VAR}" >> "$ENV_FILE"
              echo "âœ… Serper.dev (ì›¹ ê²€ìƒ‰, ì›” 2500íšŒ ë¬´ë£Œ) í‚¤ ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${SMTP_HOST_VAR}" ]; then
              sed -i '/^SMTP_HOST/d; /^SMTP_PORT/d; /^SMTP_USER/d; /^SMTP_PASS/d' "$ENV_FILE"
              echo "SMTP_HOST=${SMTP_HOST_VAR}" >> "$ENV_FILE"
              echo "SMTP_PORT=${SMTP_PORT_VAR}" >> "$ENV_FILE"
              echo "SMTP_USER=${SMTP_USER_VAR}" >> "$ENV_FILE"
              echo "SMTP_PASS=${SMTP_PASS_VAR}" >> "$ENV_FILE"
              echo "âœ… Gmail SMTP ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${INSTA_APP_ID}" ]; then
              sed -i '/^INSTAGRAM_APP_ID/d; /^INSTAGRAM_APP_SECRET/d; /^INSTAGRAM_ACCESS_TOKEN/d; /^INSTAGRAM_REDIRECT_URI/d' "$ENV_FILE"
              echo "INSTAGRAM_APP_ID=${INSTA_APP_ID}" >> "$ENV_FILE"
              echo "INSTAGRAM_APP_SECRET=${INSTA_APP_SECRET}" >> "$ENV_FILE"
              echo "INSTAGRAM_ACCESS_TOKEN=${INSTA_ACCESS_TOKEN}" >> "$ENV_FILE"
              echo "INSTAGRAM_REDIRECT_URI=${INSTA_REDIRECT_URI}" >> "$ENV_FILE"
              echo "âœ… Instagram API ì„¤ì • ì™„ë£Œ (í† í° í¬í•¨)"
            fi
            if [ -n "${INSTA_USER_ID}" ]; then
              sed -i '/^INSTAGRAM_USER_ID/d' "$ENV_FILE"
              echo "INSTAGRAM_USER_ID=${INSTA_USER_ID}" >> "$ENV_FILE"
              echo "âœ… Instagram Business User ID ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${YOUTUBE_CLIENT_ID_VAR}" ]; then
              sed -i '/^YOUTUBE_CLIENT_ID/d; /^YOUTUBE_CLIENT_SECRET/d; /^YOUTUBE_REFRESH_TOKEN/d' "$ENV_FILE"
              echo "YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "YOUTUBE_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN_VAR}" >> "$ENV_FILE"
              echo "âœ… YouTube Data API (OAuth2) ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${NOTION_DB_SECRETARY_VAR}" ] || [ -n "${NOTION_DB_OUTPUT_VAR}" ]; then
              sed -i '/^NOTION_DB_SECRETARY/d; /^NOTION_DB_OUTPUT/d; /^NOTION_DEFAULT_DB_ID/d' "$ENV_FILE"
              echo "NOTION_DB_SECRETARY=${NOTION_DB_SECRETARY_VAR}" >> "$ENV_FILE"
              echo "NOTION_DB_OUTPUT=${NOTION_DB_OUTPUT_VAR}" >> "$ENV_FILE"
              if [ -n "${NOTION_DB_ID}" ]; then
                echo "NOTION_DEFAULT_DB_ID=${NOTION_DB_ID}" >> "$ENV_FILE"
              fi
              echo "âœ… Notion DB ID ì„¤ì • ì™„ë£Œ (ë¹„ì„œì‹¤ DB / ì—ì´ì „íŠ¸ ì‚°ì¶œë¬¼ DB)"
            fi

            # 5.9ë‹¨ê³„: Google OAuth + SNS ê³„ì • ì„¤ì •
            if [ -n "${GOOGLE_CLIENT_ID_VAR}" ]; then
              sed -i '/^GOOGLE_CLIENT_ID/d; /^GOOGLE_CLIENT_SECRET/d; /^GOOGLE_REDIRECT_URI/d; /^GOOGLE_CALENDAR_REDIRECT_URI/d' "$ENV_FILE"
              echo "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI_VAR}" >> "$ENV_FILE"
              echo "GOOGLE_CALENDAR_REDIRECT_URI=${GOOGLE_CAL_REDIRECT_URI}" >> "$ENV_FILE"
              echo "âœ… Google OAuth (YouTube/Calendar) ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${REPO_TOKEN}" ]; then
              sed -i '/^GITHUB_TOKEN/d; /^GITHUB_REPO/d' "$ENV_FILE"
              echo "GITHUB_TOKEN=${REPO_TOKEN}" >> "$ENV_FILE"
              echo "GITHUB_REPO=kodonghui/CORTHEX_HQ" >> "$ENV_FILE"
              echo "âœ… GitHub í† í° ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${KAKAO_API_KEY}" ]; then
              sed -i '/^KAKAO_REST_API_KEY/d; /^KAKAO_ID/d; /^KAKAO_PW/d' "$ENV_FILE"
              echo "KAKAO_REST_API_KEY=${KAKAO_API_KEY}" >> "$ENV_FILE"
              echo "KAKAO_ID=${KAKAO_ID_VAR}" >> "$ENV_FILE"
              echo "KAKAO_PW=${KAKAO_PW_VAR}" >> "$ENV_FILE"
              echo "âœ… ì¹´ì¹´ì˜¤ API + ê³„ì • ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${NAVER_CLIENT_ID_VAR}" ]; then
              sed -i '/^NAVER_CLIENT_ID/d; /^NAVER_CLIENT_SECRET/d; /^NAVER_ID/d; /^NAVER_PW/d; /^NAVER_BLOG_ID/d; /^NAVER_REDIRECT_URI/d' "$ENV_FILE"
              echo "NAVER_CLIENT_ID=${NAVER_CLIENT_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET_VAR}" >> "$ENV_FILE"
              echo "NAVER_ID=${NAVER_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_PW=${NAVER_PW_VAR}" >> "$ENV_FILE"
              echo "NAVER_BLOG_ID=${NAVER_BLOG_ID_VAR}" >> "$ENV_FILE"
              echo "NAVER_REDIRECT_URI=${NAVER_REDIRECT_URI_VAR}" >> "$ENV_FILE"
              echo "âœ… ë„¤ì´ë²„ API + ë¸”ë¡œê·¸ ê³„ì • ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${DAUM_ID_VAR}" ]; then
              sed -i '/^DAUM_ID/d; /^DAUM_PW/d; /^DAUM_CAFE_ID/d; /^DAUM_CAFE_BOARD_ID/d' "$ENV_FILE"
              echo "DAUM_ID=${DAUM_ID_VAR}" >> "$ENV_FILE"
              echo "DAUM_PW=${DAUM_PW_VAR}" >> "$ENV_FILE"
              echo "DAUM_CAFE_ID=${DAUM_CAFE_ID_VAR}" >> "$ENV_FILE"
              echo "DAUM_CAFE_BOARD_ID=${DAUM_CAFE_BOARD_ID_VAR}" >> "$ENV_FILE"
              echo "âœ… ë‹¤ìŒ ì¹´í˜ ê³„ì • ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${KIS_APP_KEY}" ]; then
              sed -i '/^KOREA_INVEST_APP_KEY/d; /^KOREA_INVEST_APP_SECRET/d; /^KOREA_INVEST_ACCOUNT/d; /^KOREA_INVEST_IS_MOCK/d' "$ENV_FILE"
              echo "KOREA_INVEST_APP_KEY=${KIS_APP_KEY}" >> "$ENV_FILE"
              echo "KOREA_INVEST_APP_SECRET=${KIS_APP_SECRET}" >> "$ENV_FILE"
              echo "KOREA_INVEST_ACCOUNT=${KIS_ACCOUNT}" >> "$ENV_FILE"
              echo "KOREA_INVEST_IS_MOCK=${KIS_IS_MOCK}" >> "$ENV_FILE"
              echo "âœ… í•œêµ­íˆ¬ìì¦ê¶Œ KIS API ì„¤ì • ì™„ë£Œ"
            fi
            if [ -n "${KIS_MOCK_APP_KEY}" ]; then
              sed -i '/^KOREA_INVEST_MOCK_APP_KEY/d; /^KOREA_INVEST_MOCK_APP_SECRET/d; /^KOREA_INVEST_MOCK_ACCOUNT/d' "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_APP_KEY=${KIS_MOCK_APP_KEY}" >> "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_APP_SECRET=${KIS_MOCK_APP_SECRET}" >> "$ENV_FILE"
              echo "KOREA_INVEST_MOCK_ACCOUNT=${KIS_MOCK_ACCOUNT}" >> "$ENV_FILE"
              echo "âœ… KIS ëª¨ì˜íˆ¬ì Shadow Trading ì„¤ì • ì™„ë£Œ"
            fi
            echo "ğŸ“‹ ë“±ë¡ëœ API í‚¤ ìˆ˜: $(grep -c '_KEY\|_ID\|_PASS\|_HOST\|_PORT\|_USER\|_TOKEN' "$ENV_FILE" || echo 0)ê°œ"

            # 6ë‹¨ê³„: ì„œë²„ ì¬ì‹œì‘
            echo "ğŸ” ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
            # corthex.serviceê°€ ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ mini_server.pyë¥¼ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œ ì„¤ì •
            echo "â™»ï¸ corthex.service ExecStart ë³µì› ì¤‘..."
            sudo sed -i 's|ExecStart=.*|ExecStart=/home/ubuntu/venv/bin/uvicorn mini_server:app --host 0.0.0.0 --port 8000|' /etc/systemd/system/corthex.service
            sudo sed -i 's|WorkingDirectory=.*|WorkingDirectory=/home/ubuntu/CORTHEX_HQ/web|' /etc/systemd/system/corthex.service
            sudo systemctl daemon-reload
            sudo systemctl restart corthex

            # 7ë‹¨ê³„: ìƒíƒœ í™•ì¸
            sleep 5
            if sudo systemctl is-active --quiet corthex; then
              echo "âœ… ë°°í¬ ì™„ë£Œ! ì„œë²„ ì •ìƒ ì‹¤í–‰ ì¤‘ (ë¹Œë“œ #${BUILD_NUMBER})"
              echo "ğŸ“‹ ìµœê·¼ ì„œë²„ ë¡œê·¸:"
              sudo journalctl -u corthex --no-pager -n 20 --no-hostname
              echo ""
              echo "ğŸ“‹ í…”ë ˆê·¸ë¨ ë´‡ ì§„ë‹¨:"
              TG_STATUS=$(curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "API_FAIL")
              echo "$TG_STATUS"
              # ë´‡ ì‹œì‘ ì‹¤íŒ¨ ì‹œ í•œ ë²ˆ ë” ì¬ì‹œì‘ ì‹œë„
              if echo "$TG_STATUS" | grep -q '"tg_started": false\|"tg_started":false\|API_FAIL'; then
                echo "âš ï¸ í…”ë ˆê·¸ë¨ ë´‡ ë¯¸ì‹œì‘ â€” ì„œë²„ ì¬ì‹œì‘ ì¬ì‹œë„..."
                sleep 3
                sudo systemctl restart corthex
                sleep 8
                curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "âš ï¸ ì¬ì‹œë„ í›„ì—ë„ ì§„ë‹¨ ì‹¤íŒ¨"
              fi
              echo ""
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              sudo journalctl -u corthex --no-pager -n 30
              exit 1
            fi

            # 8ë‹¨ê³„: ë°°í¬ ìƒíƒœ JSON ì €ì¥
            echo "{\"build\":${BUILD_NUMBER},\"time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"status\":\"success\",\"commit\":\"$(cd /home/ubuntu/CORTHEX_HQ && git rev-parse --short HEAD)\"}" | sudo tee /var/www/html/deploy-status.json > /dev/null

            # 8.5ë‹¨ê³„: ë…¸ì…˜ ë°°í¬ ë¡œê·¸ ìë™ ê¸°ë¡
            if [ -n "${NOTION_KEY}" ]; then
              echo "ğŸ“ ë…¸ì…˜ ë°°í¬ ë¡œê·¸ ê¸°ë¡ ì¤‘..."
              export NOTION_KEY="${NOTION_KEY}"
              export BUILD_NUMBER="${BUILD_NUMBER}"
              # ë¨¸ì§€ ì»¤ë°‹ì´ë©´ ì‹¤ì œ ì‘ì—… ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ, ì•„ë‹ˆë©´ í˜„ì¬ ì»¤ë°‹ ë©”ì‹œì§€
              cd /home/ubuntu/CORTHEX_HQ
              if git rev-parse HEAD^2 >/dev/null 2>&1; then
                export DEPLOY_COMMIT="$(git log -1 --pretty=%s HEAD^2 | sed 's/\[ì™„ë£Œ\]//g; s/^feat: //; s/^fix: //; s/^refactor: //' | head -c 200)"
              else
                export DEPLOY_COMMIT="$(git log -1 --pretty=%s | sed 's/\[ì™„ë£Œ\]//g; s/^feat: //; s/^fix: //; s/^refactor: //' | head -c 200)"
              fi
              export DEPLOY_FILES="$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')"
              export DEPLOY_DATE="$(TZ=Asia/Seoul date +%Y-%m-%d)"
              export DEPLOY_VERSION="$(grep -oP 'í˜„ì¬ ë²„ì „\*\*: \K[0-9.]+' docs/project-status.md 2>/dev/null || echo '')"
              /home/ubuntu/venv/bin/python3 << 'PYEOF'
            import urllib.request, json, os, sys
            url = "https://api.notion.com/v1/pages"
            commit = os.environ.get("DEPLOY_COMMIT", "auto deploy").strip()
            build = int(os.environ.get("BUILD_NUMBER", "0"))
            date = os.environ.get("DEPLOY_DATE", "")
            version = os.environ.get("DEPLOY_VERSION", "")
            files = int(os.environ.get("DEPLOY_FILES", "0"))
            props = {
                "Name": {"title": [{"text": {"content": commit}}]},
                "\ube4c\ub4dc": {"number": build},
                "\ub0a0\uc9dc": {"date": {"start": date}},
                "\uce74\ud14c\uace0\ub9ac": {"select": {"name": "\uc790\ub3d9\ubc30\ud3ec"}},
                "\uc0c1\ud0dc": {"select": {"name": "\ubc30\ud3ec\uc644\ub8cc"}},
                "\ubcc0\uacbd\ud30c\uc77c\uc218": {"number": files}
            }
            if version:
                props["\ubc84\uc804"] = {"rich_text": [{"text": {"content": version}}]}
            body = json.dumps({
                "parent": {"database_id": "30e56b49-78dc-819d-b666-e50aec6a04aa"},
                "properties": props
            }).encode("utf-8")
            req = urllib.request.Request(url, data=body, headers={
                "Authorization": "Bearer " + os.environ.get("NOTION_KEY", ""),
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
            }, method="POST")
            try:
                urllib.request.urlopen(req)
                print("OK - recorded build #" + str(build))
            except Exception as e:
                print("FAIL: " + str(e))
                sys.exit(1)
            PYEOF
              if [ $? -eq 0 ]; then
                echo "âœ… ë…¸ì…˜ ë°°í¬ ë¡œê·¸ ê¸°ë¡ ì™„ë£Œ (ë¹Œë“œ #${BUILD_NUMBER})"
              else
                echo "âš ï¸ ë…¸ì…˜ ë°°í¬ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨ (ë°°í¬ ìì²´ëŠ” ì„±ê³µ)"
              fi
            fi

            # 9ë‹¨ê³„: nginx ìºì‹œ ë°©ì§€ ì„¤ì •
            if ! grep -q "no-cache" /etc/nginx/sites-available/default 2>/dev/null; then
              sudo sed -i '/location \/ {/a\\t\tadd_header Cache-Control "no-cache, no-store, must-revalidate";\n\t\tadd_header Pragma "no-cache";\n\t\tadd_header Expires "0";' /etc/nginx/sites-available/default 2>/dev/null || echo "âš ï¸ nginx ìºì‹œ ì„¤ì • ê±´ë„ˆëœ€"
              sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸ nginx ë¦¬ë¡œë“œ ê±´ë„ˆëœ€"
            fi

            # 9.3ë‹¨ê³„: ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ìë™ ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)
            # pandoc (ë¬¸ì„œ ë³€í™˜ ë„êµ¬ â€” Word/Markdown/PDF ìƒí˜¸ ë³€í™˜)
            if ! command -v pandoc &>/dev/null; then
              echo "ğŸ“„ pandoc ì„¤ì¹˜ ì¤‘..."
              sudo apt-get install -y pandoc 2>&1 | tail -3
              echo "âœ… pandoc ì„¤ì¹˜ ì™„ë£Œ: $(pandoc --version | head -1)"
            else
              echo "âœ… pandoc ì´ë¯¸ ì„¤ì¹˜ë¨: $(pandoc --version | head -1)"
            fi

            # Chromium ë¸Œë¼ìš°ì € ìë™ ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)
            if ! command -v chromium-browser &>/dev/null && ! command -v chromium &>/dev/null; then
              echo "Chromium + ChromeDriver ì„¤ì¹˜ ì¤‘... (Selenium SNS ë„êµ¬ìš©)"
              sudo apt-get install -y chromium-browser chromium-chromedriver 2>&1 | tail -5 || \n              sudo apt-get install -y chromium chromium-driver 2>&1 | tail -5 || \n              echo "âš ï¸ Chromium ì„¤ì¹˜ ì‹¤íŒ¨ (ë³„ë„ ì•ˆë‚´ë¡œ í›„ì²˜ë¦¬ ê°€ëŠ¥)"
              if command -v chromium-browser &>/dev/null; then
                echo "âœ… chromium-browser ì„¤ì¹˜ ì™„ë£Œ: $(chromium-browser --version)"
              elif command -v chromium &>/dev/null; then
                echo "âœ… chromium ì„¤ì¹˜ ì™„ë£Œ: $(chromium --version)"
              fi
            else
              echo "âœ… Chromium ì´ë¯¸ ì„¤ì¹˜ë¨ -- Selenium SNS ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥"
            fi

            # 9.5ë‹¨ê³„: HTTPS (Let's Encrypt ë¬´ë£Œ ì¸ì¦ì„œ) ì„¤ì •
            CERT_PATH="/etc/letsencrypt/live/corthex-hq.com/fullchain.pem"
            if [ ! -f "$CERT_PATH" ]; then
              echo "ğŸ”’ HTTPS ì¸ì¦ì„œ ë°œê¸‰ ì¤‘... (ì²« ë°°í¬ ì‹œ 1íšŒë§Œ ì‹¤í–‰)"
              sudo apt-get install -y certbot python3-certbot-nginx 2>&1 | tail -3
              if [ -n "${CERTBOT_EMAIL}" ]; then
                sudo certbot --nginx -d corthex-hq.com -d www.corthex-hq.com \
                  --non-interactive --agree-tos --email "${CERTBOT_EMAIL}" \
                  --redirect 2>&1
              else
                sudo certbot --nginx -d corthex-hq.com -d www.corthex-hq.com \
                  --non-interactive --agree-tos --register-unsafely-without-email \
                  --redirect 2>&1
              fi
              if [ -f "$CERT_PATH" ]; then
                echo "âœ… HTTPS ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ! https://corthex-hq.com ì ‘ì† ê°€ëŠ¥"
              else
                echo "âš ï¸ HTTPS ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨ â€” HTTPë¡œ ê³„ì† ìš´ì˜ë¨"
              fi
            else
              echo "âœ… HTTPS ì¸ì¦ì„œ ì´ë¯¸ ì¡´ì¬ â€” ë§Œë£Œ ì „ ìë™ ê°±ì‹  í™•ì¸ ì¤‘..."
              sudo certbot renew --quiet 2>&1 || echo "âš ï¸ ì¸ì¦ì„œ ê°±ì‹  ê±´ë„ˆëœ€ (ì•„ì§ ë§Œë£Œ ì•„ë‹˜)"
            fi

            echo "ğŸ‰ ë°°í¬ ì„±ê³µ! https://corthex-hq.com ì—ì„œ í™•ì¸ ê°€ëŠ¥ (ë¹Œë“œ #${BUILD_NUMBER})"
