name: Deploy to Oracle Cloud Server

# ì–¸ì œ ì‹¤í–‰? â†’ main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í•©ì³ì§ˆ ë•Œ ìë™ ì‹¤í–‰
on:
  push:
    branches:
      - main
    paths:
      - 'web/**'           # web í´ë” ì•ˆì˜ íŒŒì¼ì´ ë°”ë€Œì—ˆì„ ë•Œë§Œ ë°°í¬
      - 'requirements.txt'  # íŒ¨í‚¤ì§€ ëª©ë¡ì´ ë°”ë€Œì—ˆì„ ë•Œë„ ë°°í¬

# ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥ (GitHubì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ì„œë²„ì— ë°°í¬í•˜ê¸°
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # 1ë‹¨ê³„: GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "ğŸ“¦ ì²˜ìŒ ë°°í¬ - ì €ì¥ì†Œ ë³µì œ ì¤‘..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
              cd CORTHEX_HQ
              git pull origin main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ HTML íŒŒì¼ ë³µì‚¬ (ì›¹ì„œë²„ í´ë”ë¡œ)
            echo "ğŸ“„ ëŒ€ì‹œë³´ë“œ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            sudo cp web/templates/index.html /var/www/html/index.html

            # 3ë‹¨ê³„: ë¯¸ë‹ˆ ì„œë²„ íŒŒì¼ ë³µì‚¬
            echo "ğŸ ë¯¸ë‹ˆ ì„œë²„ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            mkdir -p /home/ubuntu/web/templates
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp web/templates/index.html /home/ubuntu/web/templates/index.html

            # 4ë‹¨ê³„: ë¯¸ë‹ˆ ì„œë²„ ì¬ì‹œì‘
            echo "ğŸ” ë¯¸ë‹ˆ ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl restart corthex

            # 5ë‹¨ê³„: ìƒíƒœ í™•ì¸
            sleep 2
            if sudo systemctl is-active --quiet corthex; then
              echo "âœ… ë°°í¬ ì™„ë£Œ! ë¯¸ë‹ˆ ì„œë²„ ì •ìƒ ì‹¤í–‰ ì¤‘"
            else
              echo "âŒ ë¯¸ë‹ˆ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              sudo journalctl -u corthex --no-pager -n 10
              exit 1
            fi

            echo "ğŸ‰ ë°°í¬ ì„±ê³µ! http://168.107.28.100 ì—ì„œ í™•ì¸ ê°€ëŠ¥"
