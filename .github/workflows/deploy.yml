name: Deploy to Oracle Cloud Server

# 언제 실행? → main 브랜치에 코드가 합쳐질 때 자동 실행
on:
  push:
    branches:
      - main
    # paths 필터 제거 — main에 합쳐지면 무조건 배포 실행
    # (배포 스크립트가 가볍기 때문에 매번 실행해도 문제없음)

# 수동으로도 실행 가능 (GitHub에서 버튼 클릭)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 서버에 배포하기
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CEO_CHAT_ID: ${{ secrets.TELEGRAM_CEO_CHAT_ID }}
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: BUILD_NUMBER,TG_BOT_TOKEN,TG_CEO_CHAT_ID
          script: |
            echo "🚀 배포 시작... (빌드 #${BUILD_NUMBER})"

            # 1단계: GitHub에서 최신 코드 가져오기
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "📦 처음 배포 - 저장소 복제 중..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "🔄 최신 코드 가져오는 중..."
              cd CORTHEX_HQ
              # ⚠️ 이전 배포에서 sed가 index.html을 수정하므로 로컬 변경사항 발생
              # git pull이 실패하지 않도록 로컬 변경사항을 먼저 버림
              git fetch origin main
              git reset --hard origin/main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2단계: 빌드 번호를 HTML에 주입
            echo "📝 빌드 번호 주입 중... (#${BUILD_NUMBER})"
            sed "s/BUILD_NUMBER_PLACEHOLDER/${BUILD_NUMBER}/g" web/templates/index.html > /tmp/index.html

            # 3단계: 대시보드 HTML 파일 복사 (웹서버 폴더로)
            echo "📄 대시보드 파일 복사 중..."
            sudo cp /tmp/index.html /var/www/html/index.html

            # 4단계: 미니 서버 파일 복사
            # 주의: corthex 서비스는 /home/ubuntu/CORTHEX_HQ/web/ (git 저장소)에서 실행됨
            echo "🐍 미니 서버 파일 복사 중..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp /tmp/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "⚠️ config 파일 없음 (무시)"
            # git 저장소의 templates에도 빌드번호 주입된 HTML 복사 (서버가 여기서 읽음)
            cp /tmp/index.html /home/ubuntu/CORTHEX_HQ/web/templates/index.html

            # 5단계: Python 의존성 설치 (PyYAML + 텔레그램 봇)
            echo "📦 Python 패키지 설치 중..."
            sudo apt-get install -y python3-yaml python3-pip 2>/dev/null || echo "⚠️ apt 패키지 설치 실패"
            # ⚠️ sudo 필수! ubuntu 사용자는 시스템 Python 패키지 폴더에 쓸 권한 없음
            sudo python3 -m pip install --break-system-packages python-telegram-bot 2>&1 || echo "⚠️ python-telegram-bot 설치 실패"
            # 설치 확인
            python3 -c "import telegram; print(f'✅ python-telegram-bot v{telegram.__version__} 설치됨')" 2>&1 || echo "❌ telegram 모듈 임포트 실패!"

            # 5.5단계: YAML → JSON 변환 (서버의 Python에 PyYAML이 없어도 동작하도록)
            # 시스템 Python3에 yaml이 설치되어 있으므로 시스템 Python으로 실행
            echo "🔄 설정 파일 JSON 변환 중..."
            /usr/bin/python3 /home/ubuntu/CORTHEX_HQ/config/yaml2json.py 2>&1 || echo "⚠️ JSON 변환 건너뜀"

            # 5.6단계: 텔레그램 봇 환경변수 설정
            if [ -n "${TG_BOT_TOKEN}" ]; then
              echo "🤖 텔레그램 봇 환경변수 설정 중..."
              # corthex 서비스의 환경변수 파일에 텔레그램 설정 추가
              ENV_FILE="/home/ubuntu/corthex.env"
              # 기존 텔레그램 설정 제거 후 새로 추가
              touch "$ENV_FILE"
              sed -i '/^TELEGRAM_/d' "$ENV_FILE"
              echo "TELEGRAM_BOT_TOKEN=${TG_BOT_TOKEN}" >> "$ENV_FILE"
              echo "TELEGRAM_CEO_CHAT_ID=${TG_CEO_CHAT_ID}" >> "$ENV_FILE"
              echo "📋 corthex.env 내용 확인:"
              cat "$ENV_FILE" | sed 's/\(BOT_TOKEN=\).*/\1***/' # 토큰은 마스킹해서 출력
              echo "✅ 텔레그램 봇 환경변수 설정 완료"
            fi

            # 6단계: 미니 서버 재시작
            echo "🔁 미니 서버 재시작 중..."
            sudo systemctl daemon-reload
            sudo systemctl restart corthex

            # 7단계: 상태 확인
            sleep 5
            if sudo systemctl is-active --quiet corthex; then
              echo "✅ 배포 완료! 미니 서버 정상 실행 중 (빌드 #${BUILD_NUMBER})"
              echo "📋 최근 서버 로그:"
              sudo journalctl -u corthex --no-pager -n 20 --no-hostname
              echo ""
              echo "📋 텔레그램 봇 진단:"
              curl -s http://localhost:8000/api/telegram-status 2>/dev/null || echo "⚠️ 진단 API 호출 실패"
              echo ""
            else
              echo "❌ 미니 서버 시작 실패"
              sudo journalctl -u corthex --no-pager -n 30
              exit 1
            fi

            # 8단계: 배포 상태 JSON 저장 (프론트엔드에서 읽을 수 있도록)
            echo "{\"build\":${BUILD_NUMBER},\"time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"status\":\"success\",\"commit\":\"$(cd /home/ubuntu/CORTHEX_HQ && git rev-parse --short HEAD)\"}" | sudo tee /var/www/html/deploy-status.json > /dev/null

            # 9단계: nginx 캐시 방지 설정 (HTML 파일이 항상 최신 버전으로 보이도록)
            if ! grep -q "no-cache" /etc/nginx/sites-available/default 2>/dev/null; then
              sudo sed -i '/location \/ {/a\\t\tadd_header Cache-Control "no-cache, no-store, must-revalidate";\n\t\tadd_header Pragma "no-cache";\n\t\tadd_header Expires "0";' /etc/nginx/sites-available/default 2>/dev/null || echo "⚠️ nginx 캐시 설정 건너뜀"
              sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || echo "⚠️ nginx 리로드 건너뜀"
            fi

            echo "🎉 배포 성공! http://168.107.28.100 에서 확인 가능 (빌드 #${BUILD_NUMBER})"
