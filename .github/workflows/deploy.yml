name: Deploy to Oracle Cloud Server

# ì–¸ì œ ì‹¤í–‰? â†’ main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í•©ì³ì§ˆ ë•Œ ìë™ ì‹¤í–‰
on:
  push:
    branches:
      - main
    # paths í•„í„° ì œê±° â€” mainì— í•©ì³ì§€ë©´ ë¬´ì¡°ê±´ ë°°í¬ ì‹¤í–‰
    # (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ê°€ë³ê¸° ë•Œë¬¸ì— ë§¤ë²ˆ ì‹¤í–‰í•´ë„ ë¬¸ì œì—†ìŒ)

# ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥ (GitHubì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ì„œë²„ì— ë°°í¬í•˜ê¸°
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # 1ë‹¨ê³„: GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            cd /home/ubuntu
            if [ ! -d "CORTHEX_HQ" ]; then
              echo "ğŸ“¦ ì²˜ìŒ ë°°í¬ - ì €ì¥ì†Œ ë³µì œ ì¤‘..."
              git clone https://github.com/kodonghui/CORTHEX_HQ.git
            else
              echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
              cd CORTHEX_HQ
              git pull origin main
            fi

            cd /home/ubuntu/CORTHEX_HQ

            # 2ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ HTML íŒŒì¼ ë³µì‚¬ (ì›¹ì„œë²„ í´ë”ë¡œ)
            echo "ğŸ“„ ëŒ€ì‹œë³´ë“œ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            sudo cp web/templates/index.html /var/www/html/index.html

            # 3ë‹¨ê³„: ë¯¸ë‹ˆ ì„œë²„ íŒŒì¼ ë³µì‚¬
            echo "ğŸ ë¯¸ë‹ˆ ì„œë²„ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            mkdir -p /home/ubuntu/web/templates
            mkdir -p /home/ubuntu/config
            cp web/mini_server.py /home/ubuntu/web/mini_server.py
            cp web/templates/index.html /home/ubuntu/web/templates/index.html
            cp -r config/* /home/ubuntu/config/ 2>/dev/null || echo "âš ï¸ config íŒŒì¼ ì—†ìŒ (ë¬´ì‹œ)"

            # 3.5ë‹¨ê³„: Python ì˜ì¡´ì„± ì„¤ì¹˜ (PyYAML ë“±)
            echo "ğŸ“¦ Python íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
            pip3 install pyyaml 2>/dev/null || pip install pyyaml 2>/dev/null || echo "âš ï¸ pip ì„¤ì¹˜ ì‹¤íŒ¨ (yaml ì—†ì´ ë™ì‘ ê°€ëŠ¥)"

            # 4ë‹¨ê³„: ë¯¸ë‹ˆ ì„œë²„ ì¬ì‹œì‘
            echo "ğŸ” ë¯¸ë‹ˆ ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl restart corthex

            # 5ë‹¨ê³„: ìƒíƒœ í™•ì¸
            sleep 2
            if sudo systemctl is-active --quiet corthex; then
              echo "âœ… ë°°í¬ ì™„ë£Œ! ë¯¸ë‹ˆ ì„œë²„ ì •ìƒ ì‹¤í–‰ ì¤‘"
            else
              echo "âŒ ë¯¸ë‹ˆ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              sudo journalctl -u corthex --no-pager -n 10
              exit 1
            fi

            echo "ğŸ‰ ë°°í¬ ì„±ê³µ! http://168.107.28.100 ì—ì„œ í™•ì¸ ê°€ëŠ¥"
