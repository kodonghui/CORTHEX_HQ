name: ğŸ“± ëª¨ë°”ì¼ SSH ì…‹ì—… (1íšŒìš©)

# ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰ (GitHub Actions í˜ì´ì§€ì—ì„œ ë²„íŠ¼ í´ë¦­)
on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: ì„œë²„ì— ëª¨ë°”ì¼ ì ‘ì† í™˜ê²½ êµ¬ì„±
        uses: appleboy/ssh-action@v1
        env:
          SERVER_IP: ${{ secrets.SERVER_IP_ARM }}
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          host: ${{ secrets.SERVER_IP_ARM }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY_ARM }}
          envs: SERVER_IP,ANTHROPIC_KEY
          script: |
            echo "========================================="
            echo "ğŸ“± ëª¨ë°”ì¼ SSH ì…‹ì—… ì‹œì‘"
            echo "========================================="

            # 0ë‹¨ê³„: SSH í¬íŠ¸(22) ë°©í™”ë²½ ì—´ê¸°
            echo "ğŸ”“ SSH í¬íŠ¸ ë°©í™”ë²½ ì—´ê¸°..."
            sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT
            sudo mkdir -p /etc/iptables
            sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
            echo "âœ… SSH í¬íŠ¸ 22 ë°©í™”ë²½ ì—´ë¦¼"

            # 1ë‹¨ê³„: tmux ì„¤ì¹˜ (ì„¸ì…˜ ìœ ì§€ ë„êµ¬)
            echo "ğŸ“¦ tmux ì„¤ì¹˜ ì¤‘..."
            sudo apt-get update -y -qq
            sudo apt-get install -y tmux fail2ban
            echo "âœ… tmux ì„¤ì¹˜ ì™„ë£Œ: $(tmux -V)"

            # 2ë‹¨ê³„: Node.js ì„¤ì¹˜ (Claude Codeìš©)
            if ! command -v node &>/dev/null; then
              echo "ğŸ“¦ Node.js ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "âœ… Node.js: $(node -v)"
            echo "âœ… npm: $(npm -v)"

            # 3ë‹¨ê³„: Claude Code CLI ì„¤ì¹˜
            if ! command -v claude &>/dev/null; then
              echo "ğŸ“¦ Claude Code CLI ì„¤ì¹˜ ì¤‘..."
              sudo npm install -g @anthropic-ai/claude-code
            fi
            echo "âœ… Claude Code: $(claude --version 2>/dev/null || echo 'ì„¤ì¹˜ë¨')"

            # 4ë‹¨ê³„: Claude Code í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            BASHRC="/home/ubuntu/.bashrc"
            if ! grep -q "ANTHROPIC_API_KEY" "$BASHRC" 2>/dev/null; then
              echo "export ANTHROPIC_API_KEY=${ANTHROPIC_KEY}" >> "$BASHRC"
              echo "âœ… ANTHROPIC_API_KEYë¥¼ .bashrcì— ì¶”ê°€"
            fi

            # 5ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ ìƒì„± + ì„¤ì •
            PASS=$(openssl rand -base64 16 | tr -d '/+=')
            echo "ubuntu:${PASS}" | sudo chpasswd

            # 6ë‹¨ê³„: SSH ë¹„ë°€ë²ˆí˜¸ ì ‘ì† í™œì„±í™” (ë©”ì¸ ì„¤ì • + cloud-init ì˜¤ë²„ë¼ì´ë“œ)
            SSHD_CONFIG="/etc/ssh/sshd_config"
            sudo cp "$SSHD_CONFIG" "${SSHD_CONFIG}.bak"
            sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' "$SSHD_CONFIG"
            sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' "$SSHD_CONFIG"
            if ! grep -q "^PasswordAuthentication yes" "$SSHD_CONFIG"; then
              echo "PasswordAuthentication yes" | sudo tee -a "$SSHD_CONFIG"
            fi
            # cloud-init ì˜¤ë²„ë¼ì´ë“œ íŒŒì¼ë„ ìˆ˜ì • (Ubuntu Cloudì—ì„œ ë©”ì¸ ì„¤ì •ì„ ë®ì–´ì”€)
            for f in /etc/ssh/sshd_config.d/*.conf; do
              if [ -f "$f" ]; then
                sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' "$f"
                echo "  ìˆ˜ì •ë¨: $f"
              fi
            done
            # KbdInteractiveAuthenticationë„ í™œì„±í™” (Ubuntu 22.04+)
            sudo sed -i 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' "$SSHD_CONFIG"
            sudo sed -i 's/^#KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' "$SSHD_CONFIG"
            for f in /etc/ssh/sshd_config.d/*.conf; do
              if [ -f "$f" ]; then
                sudo sed -i 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' "$f"
              fi
            done
            sudo systemctl restart sshd
            echo "âœ… SSH ë¹„ë°€ë²ˆí˜¸ ì ‘ì† í™œì„±í™” ì™„ë£Œ (cloud-init ì˜¤ë²„ë¼ì´ë“œ í¬í•¨)"

            # 7ë‹¨ê³„: fail2ban ì„¤ì • (ë¬´ì°¨ë³„ ë¹„ë°€ë²ˆí˜¸ ì‹œë„ ì°¨ë‹¨)
            sudo systemctl enable fail2ban
            sudo systemctl start fail2ban
            echo "âœ… fail2ban í™œì„±í™” (ë¹„ë°€ë²ˆí˜¸ ë¬´ì°¨ë³„ ì‹œë„ ì°¨ë‹¨)"

            # 8ë‹¨ê³„: tmux í¸ì˜ ì„¤ì •
            cat > /home/ubuntu/.tmux.conf << 'TMUXEOF'
            set -g mouse on
            set -g history-limit 10000
            set -g status-bg colour235
            set -g status-fg white
            TMUXEOF
            echo "âœ… tmux ì„¤ì • ì™„ë£Œ (ë§ˆìš°ìŠ¤ ìŠ¤í¬ë¡¤ ì§€ì›)"

            # 9ë‹¨ê³„: ê°„í¸ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
            cat > /home/ubuntu/start-claude.sh << 'SCRIPTEOF'
            #!/bin/bash
            # tmux ì„¸ì…˜ì´ ìˆìœ¼ë©´ ë¶™ì´ê³ , ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê¸°
            if tmux has-session -t claude 2>/dev/null; then
              tmux attach -t claude
            else
              tmux new -s claude -d
              tmux send-keys -t claude 'claude' Enter
              tmux attach -t claude
            fi
            SCRIPTEOF
            chmod +x /home/ubuntu/start-claude.sh
            echo "âœ… ê°„í¸ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (start-claude.sh)"

            # IPë¥¼ GitHubê°€ ìë™ ë§ˆìŠ¤í‚¹í•˜ë¯€ë¡œ, ì (.)ì„ ì¹˜í™˜í•´ì„œ ì¶œë ¥
            SAFE_IP=$(echo "${SERVER_IP}" | sed 's/\./ . /g')

            echo ""
            echo "========================================="
            echo "ğŸ“± Termius ì•±ì— ì…ë ¥í•  ì ‘ì† ì •ë³´"
            echo "========================================="
            echo "Hostname (ì  ì‚¬ì´ ê³µë°± ì œê±°í•˜ì„¸ìš”): ${SAFE_IP}"
            echo "Username: ubuntu"
            echo "Password: ${PASS}"
            echo "========================================="
            echo ""
            echo "ğŸ“Œ ì ‘ì† í›„ ì´ê²ƒë§Œ ì¹˜ì„¸ìš”:"
            echo "   ./start-claude.sh"
            echo ""
            echo "ğŸ‰ ëª¨ë°”ì¼ SSH ì…‹ì—… ì™„ë£Œ!"
