name: Deploy v2 Platform

# v2 ë¸Œëœì¹˜ì— push ì‹œ ìë™ ë°°í¬ (ë‚˜ì¤‘ì— v2 ì•± ê°œë°œ ì‹œì‘ ì‹œ ì‚¬ìš©)
on:
  push:
    branches:
      - v2
  workflow_dispatch:

concurrency:
  group: deploy-v2
  cancel-in-progress: false

jobs:
  deploy-v2:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: v2 ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v1
        env:
          BUILD_NUMBER: ${{ github.run_number }}
        with:
          host: ${{ secrets.SERVER_IP_ARM }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY_ARM }}
          envs: BUILD_NUMBER
          script: |
            echo "ğŸŸ¦ v2 ë°°í¬ ì‹œì‘... (ë¹Œë“œ #${BUILD_NUMBER})"

            # v2 ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            cd /home/ubuntu
            if [ ! -d "CORTHEX_V2/.git" ]; then
              echo "ğŸ“¦ v2 ì €ì¥ì†Œ í´ë¡  ì¤‘..."
              git clone -b v2 https://github.com/kodonghui/CORTHEX_HQ.git CORTHEX_V2
            else
              echo "ğŸ”„ v2 ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
              cd CORTHEX_V2
              git fetch origin v2
              git reset --hard origin/v2
            fi

            cd /home/ubuntu/CORTHEX_V2

            # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            npm install --production

            # pm2ë¡œ v2 ì•± ì‹œì‘/ì¬ì‹œì‘
            echo "ğŸ” v2 ì•± ì¬ì‹œì‘ ì¤‘..."
            if pm2 describe corthex-v2 > /dev/null 2>&1; then
              pm2 reload corthex-v2
            else
              pm2 start npm --name "corthex-v2" -- start
              pm2 save
            fi

            sleep 3
            if pm2 describe corthex-v2 | grep -q "online"; then
              echo "âœ… v2 ë°°í¬ ì™„ë£Œ! (ë¹Œë“œ #${BUILD_NUMBER})"
            else
              echo "âŒ v2 ì•± ì‹œì‘ ì‹¤íŒ¨"
              pm2 logs corthex-v2 --lines 20
              exit 1
            fi
