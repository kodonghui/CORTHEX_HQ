name: Auto-merge Claude branches

# 언제 실행? → claude/ 로 시작하는 브랜치에 push될 때
on:
  push:
    branches:
      - 'claude/**'

# GitHub 토큰 권한 설정
permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit and create PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          echo "🔄 브랜치: $BRANCH"

          # 최신 커밋 메시지 확인
          COMMIT_MSG=$(git log -1 --format=%s)
          echo "📝 커밋 메시지: $COMMIT_MSG"

          # 1단계: PR이 이미 있는지 확인, 없으면 생성
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "✅ 기존 PR #$EXISTING_PR 발견"
          else
            echo "📝 새 PR 생성 중..."
            gh pr create \
              --base main \
              --head "$BRANCH" \
              --title "Auto-merge: ${BRANCH}" \
              --body "Claude Code 세션에서 자동 생성된 PR입니다."
            echo "✅ PR 생성 완료"
          fi

          # 2단계: [완료] 키워드 확인
          if echo "$COMMIT_MSG" | grep -q '\[완료\]'; then
            echo "🏁 [완료] 키워드 발견 → 자동 머지 진행"
          else
            echo "⏸️ [완료] 키워드 없음 → PR만 생성하고 머지는 건너뜀"
            echo "   (작업이 끝나면 커밋 메시지에 [완료]를 넣고 push하세요)"
            exit 0
          fi

          # 3단계: GitHub가 PR 상태를 계산할 시간을 줌
          echo "⏳ 10초 대기 (GitHub 처리 시간)..."
          sleep 10

          # 4단계: 머지 시도 (최대 3회 재시도)
          MERGE_SUCCESS=false
          for i in 1 2 3; do
            echo "🔀 머지 시도 ($i/3)..."
            if gh pr merge "$BRANCH" --merge --delete-branch 2>&1; then
              echo "🎉 머지 완료! 브랜치도 자동 삭제됨"
              MERGE_SUCCESS=true
              break
            fi
            echo "⏳ 재시도 전 10초 대기..."
            sleep 10
          done

          if [ "$MERGE_SUCCESS" = "false" ]; then
            echo "❌ 머지 실패 — GitHub에서 수동 머지가 필요합니다."
            exit 1
          fi

          # 5단계: 머지 성공 후 → 서버 배포 워크플로우 직접 실행
          # (GitHub 보안 정책: 워크플로우가 만든 push는 다른 워크플로우를 트리거하지 않음)
          # (그래서 여기서 직접 deploy 워크플로우를 실행시켜야 함)
          echo "🚀 서버 배포 워크플로우 실행 중..."
          gh workflow run deploy.yml --ref main 2>&1 || echo "⚠️ 배포 워크플로우 실행 실패 (수동 실행 필요)"
          echo "✅ 배포 트리거 완료!"
