# v0.4.0 업데이트 — 토큰 예산 + 명령 프리셋 + 실시간 스트리밍 + 대화 컨텍스트

> 날짜: 2026-02-13
> 상태: **구현 완료**
> 브랜치: `claude/add-new-feature-qTgdv`

---

## 한 줄 요약

**예산 관리로 비용 통제, 프리셋으로 반복 명령 자동화, 실시간 스트리밍으로 작업 과정 시각화, 대화 컨텍스트로 후속 질문이 가능해졌습니다.**

---

## 왜 만들었나?

| 기준 | 문제 | 해결 |
|------|------|------|
| **저렴** | 비용이 얼마나 쓰이는지 한도/경고 없이 무제한 소진 | 일일/월간 예산 + 80% 경고 |
| **편리** | 자주 쓰는 긴 명령을 매번 타이핑 | 프리셋 한 마디로 실행 |
| **몰입** | 스피너만 돌다 결과가 뜬금없이 출력 | 에이전트별 실시간 진행 상황 |
| **편리** | 이전 대화를 기억 못해 매번 처음부터 설명 | 최근 5턴 대화 맥락 자동 전달 |

---

## 1. 토큰 예산 관리 시스템

### 기능

일일/월간 예산 한도를 설정하고, 소진율이 임계값에 도달하면 경고합니다.

### 설정 파일

`config/budget.yaml`:

```yaml
daily_limit_usd: 5.0        # 일일 한도
monthly_limit_usd: 100.0    # 월간 한도
warn_threshold_pct: 80       # 경고 임계값 (%)
```

### 동작 방식

| 소진율 | 동작 |
|--------|------|
| 0~79% | 정상 (초록) |
| 80~99% | 명령 실행 후 경고 메시지 표시 (노랑) |
| 100%+ | 초과 알림 표시 (빨강) |

> 다운그레이드 없음 — 순수 모니터링 + 경고만 합니다. 사용을 차단하지 않습니다.

### CLI 출력 예시

```
CEO> 예산

┌─────────── 토큰 예산 현황 ────────────┐
│ 구분 │   한도  │   사용   │   잔여   │ 소진율 │
│──────┼─────────┼──────────┼──────────┼────────│
│ 일일 │  $5.00  │ $0.0342  │ $4.9658  │   0.7% │
│ 월간 │ $100.00 │ $0.0342  │ $99.9658 │   0.0% │
└───────────────────────────────────────┘
경고 임계값: 80% | 설정 파일: config/budget.yaml
```

### 웹 API

```
GET /api/budget
```

```json
{
  "daily_limit": 5.0,
  "monthly_limit": 100.0,
  "daily_used": 0.0342,
  "monthly_used": 0.0342,
  "daily_remaining": 4.9658,
  "monthly_remaining": 99.9658,
  "daily_pct": 0.7,
  "monthly_pct": 0.0,
  "daily_warning": false,
  "monthly_warning": false,
  "daily_exceeded": false,
  "monthly_exceeded": false
}
```

---

## 2. 명령 프리셋 (즐겨찾기)

### 기능

자주 쓰는 명령을 이름으로 저장하고, 한 마디로 실행합니다.

### 두 가지 설정 방법

**방법 1: CLI에서 저장**

```
CEO> 프리셋 저장 주간보고 이번 주 전체 사업부 현황을 요약 보고해줘
프리셋 '주간보고' 저장 완료.

CEO> 주간보고
프리셋 '주간보고' 실행 → 이번 주 전체 사업부 현황을 요약 보고해줘
```

**방법 2: YAML 직접 편집**

`config/presets.yaml`:

```yaml
presets:
  - name: "주간보고"
    command: "이번 주 전체 사업부 현황을 요약 보고해줘"
  - name: "시장분석"
    command: "현재 주요 시장 동향과 투자 관련 이슈를 분석해줘"
  - name: "기술검토"
    command: "LEET MASTER 서비스의 기술 스택 현황을 검토하고 개선점을 제안해줘"
```

### CLI 명령어

| 명령 | 설명 |
|------|------|
| `프리셋 저장 <이름> <명령>` | 새 프리셋 저장 (동일 이름이면 덮어쓰기) |
| `프리셋 삭제 <이름>` | 프리셋 삭제 |
| `프리셋 목록` | 전체 프리셋 조회 |
| `<프리셋 이름>` | 저장된 명령 바로 실행 |

### 기본 내장 프리셋 3개

| 이름 | 명령 |
|------|------|
| `주간보고` | 이번 주 전체 사업부 현황을 요약 보고해줘 |
| `시장분석` | 현재 주요 시장 동향과 투자 관련 이슈를 분석해줘 |
| `기술검토` | LEET MASTER 서비스의 기술 스택 현황을 검토하고 개선점을 제안해줘 |

### 웹 API

| 메서드 | 경로 | 설명 |
|--------|------|------|
| `GET` | `/api/presets` | 전체 프리셋 조회 |
| `POST` | `/api/presets` | 프리셋 추가 `{"name": "...", "command": "..."}` |
| `DELETE` | `/api/presets/{name}` | 프리셋 삭제 |

---

## 3. 실시간 작업 스트리밍

### 기능

명령 실행 시 스피너 대신, 에이전트별 작업 진행 상황을 실시간으로 보여줍니다.

### Before vs After

**v0.3.x (이전):**
```
CEO> 삼성전자 주가를 분석해줘
⠋ 에이전트 조직이 업무를 처리하고 있습니다...
(10초간 스피너만 돌고 결과 출력)
```

**v0.4.0 (이후):**
```
CEO> 삼성전자 주가를 분석해줘
┌──────── 작업 진행 상황 ────────┐
│ ▶ 비서실장 작업 중...          │
│ ▶ 투자분석처장 작업 중...      │
│ ✓ 비서실장 완료                │
│ ▶ 시황분석 전문가 작업 중...   │
│ ▶ 종목분석 전문가 작업 중...   │
│ ▶ 기술적분석 전문가 작업 중... │
│ ✓ 시황분석 전문가 완료         │
│ ✓ 종목분석 전문가 완료         │
│ ✓ 기술적분석 전문가 완료       │
│ ▶ 리스크관리 전문가 작업 중... │
│ ✓ 리스크관리 전문가 완료       │
│ ✓ 투자분석처장 완료            │
└────────────────────────────────┘
(결과 패널 출력)
```

### 구현 방식

- Rich `Live` 컴포넌트로 250ms 간격 화면 갱신
- `SharedContext.status_callback`을 활용해 `TaskRequest`/`TaskResult` 메시지를 수신
- 작업 시작 시 `▶ 에이전트명 작업 중...`, 완료 시 `✓ 에이전트명 완료`로 갱신
- 결과 출력 후 자동으로 Live 패널 제거 (`transient=True`)

---

## 4. 대화 컨텍스트 유지

### 기능

이전 대화를 기억해서 후속 질문에 대응합니다.

### 사용 예시

```
CEO> 삼성전자 주가를 분석해줘
(삼성전자 분석 결과 출력...)

CEO> 아까 분석한 리스크 요인을 좀 더 자세히 설명해줘
(이전 분석 결과를 참조하여 리스크 상세 설명)

CEO> 그러면 이 리스크를 회피하려면 어떻게 해야 해?
(연속 대화로 리스크 회피 전략 제안)
```

### 동작 방식

| 항목 | 값 |
|------|-----|
| 기억하는 턴 수 | 최근 5턴 |
| 전달 대상 | 비서실장 (chief_of_staff) |
| 전달 방식 | `TaskRequest.context["conversation_history"]` |
| 매니저 활용 | `_plan_decomposition()` 프롬프트에 "이전 대화 맥락" 섹션 삽입 |

### 내부 데이터 구조

```
Orchestrator._history = [
  ConversationTurn(command="삼성전자 주가 분석해줘", summary="삼성전자는 ..."),
  ConversationTurn(command="리스크 요인 설명해줘", summary="주요 리스크는 ..."),
]
```

비서실장이 받는 프롬프트:

```
## 이전 대화 맥락
[CEO 명령] 삼성전자 주가를 분석해줘
[결과 요약] 삼성전자는 현재 72,000원으로...

## 업무 지시
아까 분석한 리스크 요인을 좀 더 자세히 설명해줘
```

### 웹 API

```
GET /api/conversation
```

```json
[
  {
    "command": "삼성전자 주가를 분석해줘",
    "summary": "삼성전자는 현재 72,000원으로..."
  },
  {
    "command": "리스크 요인을 좀 더 자세히 설명해줘",
    "summary": "주요 리스크 요인은..."
  }
]
```

---

## 수정/추가된 파일 (8개)

| 파일 | 변경 | 상세 |
|------|------|------|
| `src/core/budget.py` | **신규** | BudgetManager: YAML 설정 로드, 소진율 계산, 경고 판단 |
| `src/core/preset.py` | **신규** | PresetManager: YAML 기반 프리셋 저장/삭제/조회/실행 |
| `config/budget.yaml` | **신규** | 일일 $5 / 월간 $100 / 경고 80% 기본 설정 |
| `config/presets.yaml` | **신규** | 기본 프리셋 3개 (주간보고, 시장분석, 기술검토) |
| `src/core/orchestrator.py` | **수정** | ConversationTurn 기반 대화 이력 추적, 최근 5턴 컨텍스트 전달 |
| `src/core/agent.py` | **수정** | ManagerAgent._plan_decomposition에 "이전 대화 맥락" 섹션 삽입 |
| `src/cli/app.py` | **수정** | 4개 기능 전체 통합 (예산/프리셋/스트리밍/컨텍스트), v0.4.0 |
| `web/app.py` | **수정** | 5개 API 엔드포인트 추가 (budget, presets CRUD, conversation), v0.4.0 |

---

## 명령어 요약 (v0.4.0 기준)

| 명령어 | 설명 | 신규 |
|--------|------|------|
| `자연어 명령` | 어떤 업무든 한국어로 입력 | |
| `조직도` / `org` | 현재 조직 구조 표시 | |
| `비용` / `cost` | 누적 API 비용 확인 | |
| `예산` / `budget` | 토큰 예산 현황 | v0.4.0 |
| `헬스체크` / `health` | 시스템 상태 진단 | |
| `성과` / `performance` | 에이전트 성과 대시보드 | |
| `프리셋 저장 <이름> <명령>` | 명령 프리셋 저장 | v0.4.0 |
| `프리셋 삭제 <이름>` | 명령 프리셋 삭제 | v0.4.0 |
| `프리셋 목록` | 저장된 프리셋 조회 | v0.4.0 |
| `<프리셋 이름>` | 프리셋 바로 실행 | v0.4.0 |
| `도움말` / `help` | 도움말 표시 | |
| `종료` / `exit` | 프로그램 종료 | |

---

## 웹 API 요약 (v0.4.0 기준)

| 메서드 | 경로 | 설명 | 신규 |
|--------|------|------|------|
| GET | `/api/agents` | 전체 에이전트 조회 | |
| GET | `/api/cost` | 비용 추적 데이터 | |
| GET | `/api/health` | 시스템 헬스체크 | |
| GET | `/api/performance` | 에이전트 성과 통계 | |
| GET | `/api/budget` | 예산 현황 | v0.4.0 |
| GET | `/api/presets` | 프리셋 전체 조회 | v0.4.0 |
| POST | `/api/presets` | 프리셋 추가 | v0.4.0 |
| DELETE | `/api/presets/{name}` | 프리셋 삭제 | v0.4.0 |
| GET | `/api/conversation` | 대화 이력 조회 | v0.4.0 |
| GET | `/api/tools` | 도구 목록 | |
| WS | `/ws` | 실시간 WebSocket | |

---

## 다음 단계 (검토 필요)

- [ ] LLM 폴백 시스템 (프로바이더 장애 시 자동 전환)
- [ ] 태스크 히스토리 영구 저장 (SQLite)
- [ ] 웹 UI에 예산/프리셋/대화이력 탭 추가
- [ ] 예산 초과 시 확인 프롬프트 (실행 전 "예산 초과입니다. 계속하시겠습니까?")
