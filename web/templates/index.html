<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTHEX HQ - Cyber Command Center</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'hq-bg': 'rgb(var(--hq-bg) / <alpha-value>)',
            'hq-surface': 'rgb(var(--hq-surface) / <alpha-value>)',
            'hq-panel': 'rgb(var(--hq-panel) / <alpha-value>)',
            'hq-border': 'rgb(var(--hq-border) / <alpha-value>)',
            'hq-border-light': 'rgb(var(--hq-border-light) / <alpha-value>)',
            'hq-accent': 'rgb(var(--hq-accent) / <alpha-value>)',
            'hq-cyan': 'rgb(var(--hq-cyan) / <alpha-value>)',
            'hq-purple': 'rgb(var(--hq-purple) / <alpha-value>)',
            'hq-green': 'rgb(var(--hq-green) / <alpha-value>)',
            'hq-yellow': 'rgb(var(--hq-yellow) / <alpha-value>)',
            'hq-red': 'rgb(var(--hq-red) / <alpha-value>)',
            'hq-text': 'rgb(var(--hq-text) / <alpha-value>)',
            'hq-muted': 'rgb(var(--hq-muted) / <alpha-value>)',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;600;700&display=swap');

    /* ═══ 사이버 사령부 팔레트 (Cyber Command Center — 네온 다크) ═══ */
    :root, .dark {
      --hq-bg: 18 22 32;
      --hq-surface: 26 32 46;
      --hq-panel: 34 42 58;
      --hq-border: 55 65 88;
      --hq-border-light: 70 82 108;
      --hq-accent: 0 200 150;
      --hq-cyan: 0 230 255;
      --hq-purple: 140 100 255;
      --hq-green: 0 255 136;
      --hq-yellow: 255 210 0;
      --hq-red: 255 60 80;
      --hq-text: 225 238 245;
      --hq-muted: 135 155 175;
      --hq-shadow: 0 0 0;
    }
    /* ═══ 라이트모드 팔레트 (살짝 어두운 라벤더) ═══ */
    html:not(.dark) {
      --hq-bg: 218 214 228;         /* 라벤더 배경 (15% 어둡게) */
      --hq-surface: 228 225 238;    /* 라벤더 표면 (15% 어둡게) */
      --hq-panel: 210 206 222;      /* 패널 (15% 어둡게) */
      --hq-border: 190 185 208;
      --hq-border-light: 170 164 190;
      --hq-accent: 70 120 230;
      --hq-cyan: 6 172 200;
      --hq-purple: 114 48 220;
      --hq-green: 16 175 120;
      --hq-yellow: 207 109 6;
      --hq-red: 210 38 38;
      --hq-text: 25 22 40;
      --hq-muted: 85 80 108;
      --hq-shadow: 0 0 0;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Pretendard Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }

    /* ═══ 사이버 사령부 배경 (딥 다크 + 네온 글로우) ═══ */
    .dark body {
      background: linear-gradient(145deg, #10141E 0%, #141A28 30%, #121820 60%, #161222 100%);
      background-attachment: fixed;
    }
    /* 네온 글로우 — 사이버 그린 (왼쪽 위) */
    .dark body::before {
      content: '';
      position: fixed;
      top: -25%;
      left: -15%;
      width: 65%;
      height: 65%;
      background: radial-gradient(ellipse at center, rgba(0,255,136,0.06) 0%, transparent 65%);
      pointer-events: none;
      z-index: 0;
    }
    /* 네온 글로우 — 시안 (오른쪽 아래) */
    .dark body::after {
      content: '';
      position: fixed;
      bottom: -25%;
      right: -15%;
      width: 65%;
      height: 65%;
      background: radial-gradient(ellipse at center, rgba(0,230,255,0.05) 0%, transparent 65%);
      pointer-events: none;
      z-index: 0;
    }

    /* ═══ 라이트 모드 배경 (살짝 어두운 라벤더 그라데이션) ═══ */
    html:not(.dark) body {
      background: linear-gradient(135deg, #DAD6E4 0%, #D2CDE2 35%, #D8D4E4 65%, #E0DCF0 100%);
      background-attachment: fixed;
    }

    .font-mono { font-family: 'JetBrains Mono', monospace; }

    /* Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgb(var(--hq-border)); border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgb(var(--hq-border-light)); }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-16px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(16px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.92); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.85); }
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink {
      50% { border-color: transparent; }
    }
    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.4; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    @keyframes gridPulse {
      0%, 100% { opacity: 0.03; }
      50% { opacity: 0.06; }
    }
    .fade-in-up { animation: fadeInUp 0.4s ease-out; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-in-left { animation: slideInLeft 0.3s ease-out; }
    .slide-in-right { animation: slideInRight 0.3s ease-out; }
    .scale-in { animation: scaleIn 0.25s ease-out; }
    .bounce-in { animation: bounceIn 0.5s ease-out; }
    .pulse-dot { animation: pulseDot 1.5s ease-in-out infinite; }
    .progress-bar { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .msg-user { animation: slideInRight 0.35s ease-out; }
    .msg-result { animation: slideInLeft 0.4s ease-out; }
    .msg-processing { animation: scaleIn 0.3s ease-out; }
    .shimmer { background: linear-gradient(90deg, transparent 25%, rgba(var(--hq-accent),0.08) 50%, transparent 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

    /* ═══ 사이버 사령부 전용 애니메이션 ═══ */
    @keyframes cyberGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(0,255,136,0.1), inset 0 0 5px rgba(0,255,136,0.05); }
      50% { box-shadow: 0 0 20px rgba(0,255,136,0.2), inset 0 0 10px rgba(0,255,136,0.1); }
    }
    @keyframes scanLine {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100vh); }
    }
    @keyframes dataStream {
      0% { background-position: 0% 0%; }
      100% { background-position: 0% 100%; }
    }
    @keyframes neonPulse {
      0%, 100% { text-shadow: 0 0 4px rgba(0,255,136,0.4), 0 0 11px rgba(0,255,136,0.2); }
      50% { text-shadow: 0 0 8px rgba(0,255,136,0.6), 0 0 20px rgba(0,255,136,0.3), 0 0 40px rgba(0,255,136,0.1); }
    }
    @keyframes borderGlow {
      0%, 100% { border-color: rgba(0,255,136,0.15); }
      50% { border-color: rgba(0,255,136,0.4); }
    }
    .cyber-glow { animation: cyberGlow 3s ease-in-out infinite; }
    .neon-text { animation: neonPulse 2s ease-in-out infinite; }
    .cyber-border { animation: borderGlow 2.5s ease-in-out infinite; }

    /* 사이버 카드 호버 효과 */
    .cyber-card {
      transition: all 0.3s ease;
      border: 1px solid rgba(0,255,136,0.1);
    }
    .cyber-card:hover {
      border-color: rgba(0,255,136,0.4);
      box-shadow: 0 0 15px rgba(0,255,136,0.1), 0 4px 20px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    /* 스캔라인 오버레이 (미세한 CRT 효과) */
    .scan-overlay::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,255,136,0.01) 2px,
        rgba(0,255,136,0.01) 4px
      );
      pointer-events: none;
      z-index: 1;
    }

    /* Gradient text — 사이버 사령부 네온 그라디언트 */
    .gradient-text {
      background: linear-gradient(135deg, #00ff88, #00e6ff, #8c64ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient border */
    .gradient-border {
      position: relative;
      background: rgb(var(--hq-surface));
      border: 1px solid transparent;
      background-clip: padding-box;
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(135deg, rgb(var(--hq-cyan) / 0.2), rgb(var(--hq-accent) / 0.2), rgb(var(--hq-purple) / 0.2));
      z-index: -1;
    }

    /* Glow effects */
    .glow-cyan { box-shadow: 0 0 20px rgb(var(--hq-cyan) / 0.25), 0 0 40px rgb(var(--hq-cyan) / 0.1); }
    .glow-blue { box-shadow: 0 0 20px rgb(var(--hq-accent) / 0.25), 0 0 40px rgb(var(--hq-accent) / 0.1); }
    .glow-purple { box-shadow: 0 0 20px rgb(var(--hq-purple) / 0.25), 0 0 40px rgb(var(--hq-purple) / 0.1); }
    .glow-accent { box-shadow: 0 0 24px rgb(var(--hq-accent) / 0.3); }

    /* Glass effect — 반투명 유리 효과 (Glassmorphism) */
    .glass {
      background: rgb(var(--hq-surface) / 0.55);
      backdrop-filter: blur(20px) saturate(1.4);
      -webkit-backdrop-filter: blur(20px) saturate(1.4);
      border-color: rgb(255 255 255 / 0.06);
    }

    /* Background grid pattern — 격자 무늬는 ::before 가상 요소로만 표시 */
    /* ⚠️ 주의: gridPulse 애니메이션을 .bg-grid 자체에 걸면 opacity가 */
    /*    요소 전체(글자, 버튼 등)에 적용되어 콘텐츠가 안 보이게 됨! */
    .bg-grid {
      position: relative;
    }
    .bg-grid::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgb(var(--hq-accent) / 0.07) 1px, transparent 1px),
        linear-gradient(90deg, rgb(var(--hq-accent) / 0.07) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridPulse 8s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    .bg-grid > * {
      position: relative;
      z-index: 1;
    }

    /* Hover transitions */
    .hover-lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgb(var(--hq-shadow) / 0.15);
    }

    /* Card hover glow — 유리 위 보라빛 글로우 */
    .hover-glow {
      transition: box-shadow 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
    }
    .hover-glow:hover {
      box-shadow: 0 0 24px rgb(var(--hq-green) / 0.15), 0 4px 16px rgb(var(--hq-cyan) / 0.1);
      border-color: rgb(var(--hq-green) / 0.25);
    }

    /* Agent avatar */
    .agent-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
      transition: transform 0.15s ease;
    }
    .agent-avatar:hover { transform: scale(1.1); }

    /* Status badge */
    .status-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    /* Markdown body — 보고서 스타일 (Pretendard 통일) */
    .markdown-body { line-height: 1.85; font-family: 'Pretendard Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; font-size: 0.9rem; letter-spacing: -0.01em; }
    .markdown-body h1 { font-size: 1.3rem; font-weight: 700; margin: 1.2rem 0 0.6rem; color: rgb(var(--hq-text)); font-family: 'Pretendard Variable', sans-serif; border-bottom: 1px solid rgb(var(--hq-border) / 0.3); padding-bottom: 0.4rem; }
    .markdown-body h2 { font-size: 1.15rem; font-weight: 600; margin: 1rem 0 0.5rem; color: rgb(var(--hq-accent)); font-family: 'Pretendard Variable', sans-serif; }
    .markdown-body h3 { font-size: 1.02rem; font-weight: 600; margin: 0.8rem 0 0.3rem; color: rgb(var(--hq-cyan)); font-family: 'Pretendard Variable', sans-serif; }
    .markdown-body p { margin: 0.5rem 0; color: rgb(var(--hq-text) / 0.88); }
    .markdown-body ul, .markdown-body ol { margin: 0.4rem 0; padding-left: 1.5rem; }
    .markdown-body li { margin: 0.25rem 0; color: rgb(var(--hq-text) / 0.88); }
    .markdown-body li::marker { color: rgb(var(--hq-accent) / 0.6); }
    .markdown-body strong { color: rgb(var(--hq-text)); font-weight: 600; }
    .markdown-body em { color: rgb(var(--hq-cyan) / 0.9); font-style: italic; }
    .markdown-body code { background: rgb(var(--hq-bg)); padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.82rem; font-family: 'JetBrains Mono', monospace; color: rgb(var(--hq-cyan)); border: 1px solid rgb(var(--hq-border) / 0.5); }
    .markdown-body pre { background: rgb(var(--hq-bg) / 0.8); padding: 1rem; border-radius: 10px; overflow-x: auto; margin: 0.6rem 0; border: 1px solid rgb(var(--hq-border) / 0.5); }
    .markdown-body pre code { background: transparent; padding: 0; border: none; color: rgb(var(--hq-text)); font-size: 0.82rem; }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.6rem 0; font-family: 'Pretendard Variable', sans-serif; font-size: 0.85rem; }
    .markdown-body th, .markdown-body td { border: 1px solid rgb(var(--hq-border) / 0.4); padding: 0.5rem 0.8rem; text-align: left; }
    .markdown-body th { background: rgb(var(--hq-surface)); color: rgb(var(--hq-cyan)); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.03em; }
    .markdown-body blockquote { border-left: 3px solid rgb(var(--hq-accent)); padding: 0.5rem 1rem; margin: 0.6rem 0; color: rgb(var(--hq-muted)); background: rgb(var(--hq-surface) / 0.4); border-radius: 0 8px 8px 0; }
    .markdown-body a { color: rgb(var(--hq-accent)); text-decoration: underline; text-underline-offset: 2px; }
    .markdown-body hr { border-color: rgb(var(--hq-border) / 0.3); margin: 1.2rem 0; }
    .markdown-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 1em 0; border: 1px solid rgba(255,255,255,0.1); }

    /* ■ 네모 배지 — 계층별 색상 구분 */
    .badge-marker { display: inline-block; width: 8px; height: 8px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
    .badge-marker-primary { background: linear-gradient(135deg, #8c64ff, #a78bfa); box-shadow: 0 0 6px rgba(140, 100, 255, 0.5); }
    /* 2단계 중첩: 시안색 */
    .markdown-body ul ul .badge-marker,
    .markdown-body ol ul .badge-marker,
    .markdown-body li li .badge-marker { background: linear-gradient(135deg, #00e6ff, #06b6d4); box-shadow: 0 0 6px rgba(0, 230, 255, 0.5); }
    /* 3단계 중첩: 초록색 */
    .markdown-body ul ul ul .badge-marker,
    .markdown-body ol ol ul .badge-marker,
    .markdown-body li li li .badge-marker { background: linear-gradient(135deg, #00ff88, #34d399); box-shadow: 0 0 6px rgba(0, 255, 136, 0.5); }

    /* Typing effect for welcome */
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid rgb(var(--hq-accent));
      animation: typing 2s steps(30) 0.5s forwards, blink 0.8s step-end infinite;
      width: 0;
    }

    /* Input focus ring */
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgb(var(--hq-accent) / 0.15), 0 0 20px rgb(var(--hq-accent) / 0.1);
    }

    /* Animated gradient border for command input */
    .input-glow-animated:focus {
      animation: borderGlow 3s ease-in-out infinite;
      border-color: rgb(var(--hq-accent));
    }
    @keyframes borderGlow {
      0%, 100% {
        border-color: rgb(var(--hq-accent));
        box-shadow: 0 0 0 3px rgb(var(--hq-accent) / 0.15), 0 0 20px rgb(var(--hq-accent) / 0.08);
      }
      50% {
        border-color: rgb(var(--hq-purple));
        box-shadow: 0 0 0 3px rgb(var(--hq-purple) / 0.15), 0 0 20px rgb(var(--hq-purple) / 0.08);
      }
    }

    /* Floating animation for empty state */
    @keyframes floatY {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .float-anim { animation: floatY 3s ease-in-out infinite; }

    /* Activity log item */
    .log-item {
      transition: background 0.15s ease;
      border-radius: 6px;
      padding: 4px 8px;
    }
    .log-item:hover {
      background: rgb(var(--hq-accent) / 0.05);
    }

    /* Light mode: reduced glow intensity */
    html:not(.dark) .glow-cyan,
    html:not(.dark) .glow-blue,
    html:not(.dark) .glow-purple,
    html:not(.dark) .glow-accent { box-shadow: 0 0 16px rgb(var(--hq-accent) / 0.08); }

    /* ═══ Toast animations ═══ */
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast-in { animation: toastIn 0.3s ease-out forwards; }
    .toast-out { animation: toastOut 0.3s ease-in forwards; }

    /* ═══ Agent working glow ═══ */
    @keyframes agentGlow {
      0%, 100% { box-shadow: 0 0 4px rgba(250,204,21,0.3); }
      50% { box-shadow: 0 0 14px rgba(250,204,21,0.6), 0 0 28px rgba(250,204,21,0.15); }
    }
    .agent-working-glow { animation: agentGlow 2s ease-in-out infinite; border-radius: 50%; }

    /* ═══ Office floor plan ═══ */
    .office-room { border-radius: 16px; padding: 20px; transition: all 0.3s ease; }
    .desk-card {
      border-radius: 12px; padding: 12px; cursor: pointer;
      transition: all 0.2s ease; position: relative; min-width: 100px;
      border: 1px solid rgb(var(--hq-border) / 0.7);
      background: rgb(var(--hq-surface));
    }
    .desk-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgb(var(--hq-shadow) / 0.2); border-color: rgb(var(--hq-accent) / 0.6); }
    .status-light { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-light-working { background: rgb(var(--hq-green)); box-shadow: 0 0 10px rgb(var(--hq-green) / 0.6); animation: pulseDot 1.5s ease-in-out infinite; }
    .status-light-idle { background: rgb(var(--hq-yellow)); box-shadow: 0 0 6px rgb(var(--hq-yellow) / 0.4); animation: pulseDot 2s ease-in-out infinite; }
    .status-light-done { background: rgb(var(--hq-green)); animation: pulseDot 2.5s ease-in-out infinite; }
    .status-light-off { background: rgb(var(--hq-muted) / 0.7); }

    /* ═══ #11: Mobile responsive ═══ */
    @media (max-width: 768px) {
      /* 사이드바 숨김 (모바일) */
      .mobile-sidebar-hidden { display: none !important; }
      /* 탭 바 가로 스크롤 */
      .mobile-tabs-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .mobile-tabs-scroll::-webkit-scrollbar { display: none; }
      /* 카드 1열 */
      .mobile-grid-1 { grid-template-columns: 1fr !important; }
      /* 대시보드 카드 2열 → 1열 */
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      .lg\:grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
      /* 비교 모달 1열 */
      .grid-cols-2.gap-6 { grid-template-columns: 1fr !important; }
    }
    @media (max-width: 480px) {
      .lg\:grid-cols-4, .grid-cols-4 { grid-template-columns: 1fr !important; }
    }

    /* ═══════════════════════════════════════════════════════════════════ */
    /* ═══ PURE CSS COLOR SYSTEM v2 (CSS 변수 기반 — 자동 테마 전환) ═══ */
    /* 모든 색상이 CSS 변수를 참조 → 다크/라이트 모드 자동 전환 */
    /* ═══════════════════════════════════════════════════════════════════ */

    /* --- body 기본 색상 --- */
    body { color: rgb(var(--hq-text)) !important; }
    h1, h2, h3, h4 { color: rgb(var(--hq-text)) !important; }
    header { color: rgb(var(--hq-text)) !important; }
    .gradient-text { -webkit-text-fill-color: transparent !important; }
    svg { color: inherit; }

    /* --- Tailwind 흰색/검정색 텍스트 보호 (body !important에 덮이지 않게) --- */
    .text-white { color: #ffffff !important; }
    .text-black { color: #000000 !important; }

    /* --- 다크모드 구조 요소 (Glass 효과) --- */
    .dark .glass {
      background-color: rgb(var(--hq-surface) / 0.65) !important;
      backdrop-filter: blur(20px) saturate(1.4) !important;
      -webkit-backdrop-filter: blur(20px) saturate(1.4) !important;
      border-color: rgb(255 255 255 / 0.08) !important;
      color: rgb(var(--hq-text)) !important;
    }
    .dark aside {
      background-color: rgb(var(--hq-surface) / 0.55) !important;
      backdrop-filter: blur(24px) saturate(1.5) !important;
      -webkit-backdrop-filter: blur(24px) saturate(1.5) !important;
      border-color: rgb(255 255 255 / 0.07) !important;
      color: rgb(var(--hq-text)) !important;
    }
    .dark .desk-card {
      background: rgb(var(--hq-surface) / 0.55) !important;
      backdrop-filter: blur(12px) saturate(1.3) !important;
      -webkit-backdrop-filter: blur(12px) saturate(1.3) !important;
      border-color: rgb(255 255 255 / 0.08) !important;
    }
    .dark .office-room {
      background: rgb(var(--hq-bg) / 0.6) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border-color: rgb(255 255 255 / 0.06) !important;
    }
    .dark input, .dark textarea, .dark select {
      background-color: rgb(var(--hq-bg) / 0.7) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border-color: rgb(255 255 255 / 0.10) !important;
      color: rgb(var(--hq-text)) !important;
    }
    .dark input::placeholder, .dark textarea::placeholder {
      color: rgb(var(--hq-muted) / 0.7) !important;
    }
    .dark .log-item:hover { background: rgb(var(--hq-accent) / 0.1) !important; }

    /* --- 라이트모드 구조 요소 (소프트 Glass) --- */
    html:not(.dark) .glass {
      background-color: rgb(var(--hq-surface) / 0.7) !important;
      backdrop-filter: blur(20px) saturate(1.3) !important;
      -webkit-backdrop-filter: blur(20px) saturate(1.3) !important;
      border-color: rgb(var(--hq-border) / 0.4) !important;
      color: rgb(var(--hq-text)) !important;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.04);
    }
    html:not(.dark) aside {
      background-color: rgb(var(--hq-surface) / 0.65) !important;
      backdrop-filter: blur(24px) saturate(1.3) !important;
      -webkit-backdrop-filter: blur(24px) saturate(1.3) !important;
      border-color: rgb(var(--hq-border) / 0.3) !important;
      color: rgb(var(--hq-text)) !important;
      box-shadow: 1px 0 6px rgb(0 0 0 / 0.03);
    }
    html:not(.dark) .desk-card {
      background: rgb(var(--hq-surface) / 0.6) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border-color: rgb(var(--hq-border) / 0.3) !important;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.04);
    }
    html:not(.dark) .office-room {
      background: rgb(var(--hq-panel) / 0.5) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border-color: rgb(var(--hq-border) / 0.3) !important;
    }
    html:not(.dark) input, html:not(.dark) textarea, html:not(.dark) select {
      background-color: rgb(255 255 255 / 0.9) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border-color: rgb(var(--hq-border) / 0.7) !important;
      color: rgb(var(--hq-text)) !important;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.06) !important;
    }
    html:not(.dark) input::placeholder, html:not(.dark) textarea::placeholder {
      color: rgb(var(--hq-muted) / 0.7) !important;
    }
    html:not(.dark) .log-item:hover { background: rgb(var(--hq-accent) / 0.08) !important; }

    /* ═══ text-hq-* 텍스트 색상 (CSS 변수 기반) ═══ */
    .text-hq-text { color: rgb(var(--hq-text)) !important; }
    .text-hq-muted { color: rgb(var(--hq-muted)) !important; }
    .text-hq-accent { color: rgb(var(--hq-accent)) !important; }
    .text-hq-cyan { color: rgb(var(--hq-cyan)) !important; }
    .text-hq-purple { color: rgb(var(--hq-purple)) !important; }
    .text-hq-green { color: rgb(var(--hq-green)) !important; }
    .text-hq-yellow { color: rgb(var(--hq-yellow)) !important; }
    .text-hq-red { color: rgb(var(--hq-red)) !important; }

    /* ═══ text-hq-* 투명도 변형 ═══ */
    .text-hq-text\/90 { color: rgb(var(--hq-text) / 0.9) !important; }
    .text-hq-text\/80 { color: rgb(var(--hq-text) / 0.8) !important; }
    .text-hq-text\/60 { color: rgb(var(--hq-text) / 0.6) !important; }
    .text-hq-muted\/85 { color: rgb(var(--hq-muted) / 0.85) !important; }
    .text-hq-muted\/80 { color: rgb(var(--hq-muted) / 0.8) !important; }
    .text-hq-muted\/70 { color: rgb(var(--hq-muted) / 0.7) !important; }
    .text-hq-muted\/40 { color: rgb(var(--hq-muted) / 0.4) !important; }
    .text-hq-muted\/30 { color: rgb(var(--hq-muted) / 0.3) !important; }
    .text-hq-muted\/10 { color: rgb(var(--hq-muted) / 0.1) !important; }
    .text-hq-accent\/80 { color: rgb(var(--hq-accent) / 0.8) !important; }
    .text-hq-cyan\/85 { color: rgb(var(--hq-cyan) / 0.85) !important; }
    .text-hq-cyan\/80 { color: rgb(var(--hq-cyan) / 0.8) !important; }
    .text-hq-cyan\/70 { color: rgb(var(--hq-cyan) / 0.7) !important; }
    .text-hq-cyan\/40 { color: rgb(var(--hq-cyan) / 0.4) !important; }
    .text-hq-purple\/80 { color: rgb(var(--hq-purple) / 0.8) !important; }
    .text-hq-purple\/60 { color: rgb(var(--hq-purple) / 0.6) !important; }
    .text-hq-purple\/40 { color: rgb(var(--hq-purple) / 0.4) !important; }
    .text-hq-green\/80 { color: rgb(var(--hq-green) / 0.8) !important; }
    .text-hq-green\/60 { color: rgb(var(--hq-green) / 0.6) !important; }
    .text-hq-yellow\/80 { color: rgb(var(--hq-yellow) / 0.8) !important; }
    .text-hq-yellow\/50 { color: rgb(var(--hq-yellow) / 0.5) !important; }
    .text-hq-red\/70 { color: rgb(var(--hq-red) / 0.7) !important; }
    .text-hq-red\/60 { color: rgb(var(--hq-red) / 0.6) !important; }
    .text-hq-red\/50 { color: rgb(var(--hq-red) / 0.5) !important; }

    /* ═══ bg-hq-* 배경 색상 (CSS 변수 기반) ═══ */
    .bg-hq-bg { background-color: rgb(var(--hq-bg)) !important; }
    .bg-hq-surface { background-color: rgb(var(--hq-surface)) !important; }
    .bg-hq-panel { background-color: rgb(var(--hq-panel)) !important; }
    .bg-hq-accent { background-color: rgb(var(--hq-accent)) !important; }
    .bg-hq-cyan { background-color: rgb(var(--hq-cyan)) !important; }
    .bg-hq-green { background-color: rgb(var(--hq-green)) !important; }
    .bg-hq-red { background-color: rgb(var(--hq-red)) !important; }
    .bg-hq-yellow { background-color: rgb(var(--hq-yellow)) !important; }
    .bg-hq-purple { background-color: rgb(var(--hq-purple)) !important; }

    /* ═══ bg-hq-* 투명도 변형 ═══ */
    .bg-hq-bg\/95 { background-color: rgb(var(--hq-bg) / 0.95) !important; }
    .bg-hq-panel\/15 { background-color: rgb(var(--hq-panel) / 0.15) !important; }
    .bg-hq-panel\/20 { background-color: rgb(var(--hq-panel) / 0.2) !important; }
    .bg-hq-panel\/25 { background-color: rgb(var(--hq-panel) / 0.25) !important; }
    .bg-hq-accent\/5 { background-color: rgb(var(--hq-accent) / 0.05) !important; }
    .bg-hq-accent\/10 { background-color: rgb(var(--hq-accent) / 0.1) !important; }
    .bg-hq-accent\/15 { background-color: rgb(var(--hq-accent) / 0.15) !important; }
    .bg-hq-accent\/20 { background-color: rgb(var(--hq-accent) / 0.2) !important; }
    .bg-hq-accent\/30 { background-color: rgb(var(--hq-accent) / 0.3) !important; }
    .bg-hq-accent\/40 { background-color: rgb(var(--hq-accent) / 0.4) !important; }
    .bg-hq-accent\/50 { background-color: rgb(var(--hq-accent) / 0.5) !important; }
    .bg-hq-accent\/80 { background-color: rgb(var(--hq-accent) / 0.8) !important; }
    .bg-hq-cyan\/5 { background-color: rgb(var(--hq-cyan) / 0.05) !important; }
    .bg-hq-cyan\/10 { background-color: rgb(var(--hq-cyan) / 0.1) !important; }
    .bg-hq-cyan\/20 { background-color: rgb(var(--hq-cyan) / 0.2) !important; }
    .bg-hq-cyan\/40 { background-color: rgb(var(--hq-cyan) / 0.4) !important; }
    .bg-hq-purple\/5 { background-color: rgb(var(--hq-purple) / 0.05) !important; }
    .bg-hq-purple\/10 { background-color: rgb(var(--hq-purple) / 0.1) !important; }
    .bg-hq-purple\/15 { background-color: rgb(var(--hq-purple) / 0.15) !important; }
    .bg-hq-purple\/20 { background-color: rgb(var(--hq-purple) / 0.2) !important; }
    .bg-hq-green\/5 { background-color: rgb(var(--hq-green) / 0.05) !important; }
    .bg-hq-green\/10 { background-color: rgb(var(--hq-green) / 0.1) !important; }
    .bg-hq-green\/15 { background-color: rgb(var(--hq-green) / 0.15) !important; }
    .bg-hq-green\/20 { background-color: rgb(var(--hq-green) / 0.2) !important; }
    .bg-hq-green\/30 { background-color: rgb(var(--hq-green) / 0.3) !important; }
    .bg-hq-yellow\/10 { background-color: rgb(var(--hq-yellow) / 0.1) !important; }
    .bg-hq-yellow\/15 { background-color: rgb(var(--hq-yellow) / 0.15) !important; }
    .bg-hq-yellow\/20 { background-color: rgb(var(--hq-yellow) / 0.2) !important; }
    .bg-hq-yellow\/60 { background-color: rgb(var(--hq-yellow) / 0.6) !important; }
    .bg-hq-red\/5 { background-color: rgb(var(--hq-red) / 0.05) !important; }
    .bg-hq-red\/10 { background-color: rgb(var(--hq-red) / 0.1) !important; }
    .bg-hq-red\/15 { background-color: rgb(var(--hq-red) / 0.15) !important; }
    .bg-hq-red\/20 { background-color: rgb(var(--hq-red) / 0.2) !important; }
    .bg-hq-red\/30 { background-color: rgb(var(--hq-red) / 0.3) !important; }
    .bg-hq-red\/40 { background-color: rgb(var(--hq-red) / 0.4) !important; }
    .bg-hq-muted\/10 { background-color: rgb(var(--hq-muted) / 0.1) !important; }
    .bg-hq-muted\/15 { background-color: rgb(var(--hq-muted) / 0.15) !important; }
    .bg-hq-muted\/30 { background-color: rgb(var(--hq-muted) / 0.3) !important; }
    .bg-hq-muted\/40 { background-color: rgb(var(--hq-muted) / 0.4) !important; }
    .bg-hq-muted\/80 { background-color: rgb(var(--hq-muted) / 0.8) !important; }

    /* ═══ border-hq-* 테두리 색상 (CSS 변수 기반) ═══ */
    .border-hq-border { border-color: rgb(var(--hq-border)) !important; }
    .border-hq-border-light { border-color: rgb(var(--hq-border-light)) !important; }
    .border-hq-accent { border-color: rgb(var(--hq-accent)) !important; }
    .border-hq-cyan { border-color: rgb(var(--hq-cyan)) !important; }
    .border-hq-green { border-color: rgb(var(--hq-green)) !important; }
    .border-hq-yellow { border-color: rgb(var(--hq-yellow)) !important; }
    .border-hq-red { border-color: rgb(var(--hq-red)) !important; }
    .border-hq-purple { border-color: rgb(var(--hq-purple)) !important; }
    .border-hq-muted { border-color: rgb(var(--hq-muted)) !important; }

    /* ═══ border-hq-* 투명도 변형 ═══ */
    .border-hq-border\/30 { border-color: rgb(var(--hq-border) / 0.3) !important; }
    .border-hq-border\/40 { border-color: rgb(var(--hq-border) / 0.4) !important; }
    .border-hq-border\/50 { border-color: rgb(var(--hq-border) / 0.5) !important; }
    .border-hq-accent\/20 { border-color: rgb(var(--hq-accent) / 0.2) !important; }
    .border-hq-accent\/30 { border-color: rgb(var(--hq-accent) / 0.3) !important; }
    .border-hq-accent\/40 { border-color: rgb(var(--hq-accent) / 0.4) !important; }
    .border-hq-accent\/50 { border-color: rgb(var(--hq-accent) / 0.5) !important; }
    .border-hq-cyan\/20 { border-color: rgb(var(--hq-cyan) / 0.2) !important; }
    .border-hq-cyan\/30 { border-color: rgb(var(--hq-cyan) / 0.3) !important; }
    .border-hq-green\/20 { border-color: rgb(var(--hq-green) / 0.2) !important; }
    .border-hq-green\/30 { border-color: rgb(var(--hq-green) / 0.3) !important; }
    .border-hq-green\/40 { border-color: rgb(var(--hq-green) / 0.4) !important; }
    .border-hq-yellow\/15 { border-color: rgb(var(--hq-yellow) / 0.15) !important; }
    .border-hq-yellow\/20 { border-color: rgb(var(--hq-yellow) / 0.2) !important; }
    .border-hq-yellow\/30 { border-color: rgb(var(--hq-yellow) / 0.3) !important; }
    .border-hq-yellow\/40 { border-color: rgb(var(--hq-yellow) / 0.4) !important; }
    .border-hq-red\/20 { border-color: rgb(var(--hq-red) / 0.2) !important; }
    .border-hq-red\/30 { border-color: rgb(var(--hq-red) / 0.3) !important; }
    .border-hq-red\/40 { border-color: rgb(var(--hq-red) / 0.4) !important; }
    .border-hq-purple\/20 { border-color: rgb(var(--hq-purple) / 0.2) !important; }
    .border-hq-purple\/30 { border-color: rgb(var(--hq-purple) / 0.3) !important; }

    /* ═══ 그래디언트 (from/to/via) — CSS 변수 기반 ═══ */
    .from-hq-accent { --tw-gradient-from: rgb(var(--hq-accent)) !important; --tw-gradient-to: rgb(var(--hq-accent) / 0) !important; }
    .from-hq-cyan { --tw-gradient-from: rgb(var(--hq-cyan)) !important; --tw-gradient-to: rgb(var(--hq-cyan) / 0) !important; }
    .from-hq-green { --tw-gradient-from: rgb(var(--hq-green)) !important; --tw-gradient-to: rgb(var(--hq-green) / 0) !important; }
    .from-hq-yellow { --tw-gradient-from: rgb(var(--hq-yellow)) !important; --tw-gradient-to: rgb(var(--hq-yellow) / 0) !important; }
    .from-hq-accent\/5 { --tw-gradient-from: rgb(var(--hq-accent) / 0.05) !important; }
    .from-hq-accent\/10 { --tw-gradient-from: rgb(var(--hq-accent) / 0.1) !important; }
    .from-hq-accent\/15 { --tw-gradient-from: rgb(var(--hq-accent) / 0.15) !important; }
    .from-hq-accent\/20 { --tw-gradient-from: rgb(var(--hq-accent) / 0.2) !important; }
    .to-hq-purple { --tw-gradient-to: rgb(var(--hq-purple)) !important; }
    .to-hq-cyan { --tw-gradient-to: rgb(var(--hq-cyan)) !important; }
    .to-hq-yellow { --tw-gradient-to: rgb(var(--hq-yellow)) !important; }
    .to-hq-accent { --tw-gradient-to: rgb(var(--hq-accent)) !important; }
    .to-hq-purple\/5 { --tw-gradient-to: rgb(var(--hq-purple) / 0.05) !important; }
    .to-hq-purple\/10 { --tw-gradient-to: rgb(var(--hq-purple) / 0.1) !important; }
    .to-hq-purple\/15 { --tw-gradient-to: rgb(var(--hq-purple) / 0.15) !important; }
    .via-hq-accent { --tw-gradient-via: rgb(var(--hq-accent)) !important; }

    /* ═══ shadow, placeholder, ring ═══ */
    .shadow-hq-accent\/20 { --tw-shadow-color: rgb(var(--hq-accent) / 0.2) !important; }
    .placeholder-hq-muted\/70::placeholder { color: rgb(var(--hq-muted) / 0.7) !important; }
    .ring-hq-accent\/50 { --tw-ring-color: rgb(var(--hq-accent) / 0.5) !important; }
    .ring-hq-green { --tw-ring-color: rgb(var(--hq-green)) !important; }

    /* ═══ hover: 변형 ═══ */
    .hover\:text-hq-text:hover { color: rgb(var(--hq-text)) !important; }
    .hover\:text-hq-accent:hover { color: rgb(var(--hq-accent)) !important; }
    .hover\:text-hq-accent\/80:hover { color: rgb(var(--hq-accent) / 0.8) !important; }
    .hover\:text-hq-red:hover { color: rgb(var(--hq-red)) !important; }
    .hover\:text-hq-green:hover { color: rgb(var(--hq-green)) !important; }
    .hover\:text-hq-yellow:hover { color: rgb(var(--hq-yellow)) !important; }
    .hover\:text-hq-yellow\/50:hover { color: rgb(var(--hq-yellow) / 0.5) !important; }
    .hover\:text-hq-cyan\/80:hover { color: rgb(var(--hq-cyan) / 0.8) !important; }

    .hover\:bg-hq-bg:hover { background-color: rgb(var(--hq-bg)) !important; }
    .hover\:bg-hq-surface:hover { background-color: rgb(var(--hq-surface)) !important; }
    .hover\:bg-hq-panel:hover { background-color: rgb(var(--hq-panel)) !important; }
    .hover\:bg-hq-panel\/20:hover { background-color: rgb(var(--hq-panel) / 0.2) !important; }
    .hover\:bg-hq-panel\/25:hover { background-color: rgb(var(--hq-panel) / 0.25) !important; }
    .hover\:bg-hq-accent\/10:hover { background-color: rgb(var(--hq-accent) / 0.1) !important; }
    .hover\:bg-hq-accent\/20:hover { background-color: rgb(var(--hq-accent) / 0.2) !important; }
    .hover\:bg-hq-accent\/30:hover { background-color: rgb(var(--hq-accent) / 0.3) !important; }
    .hover\:bg-hq-accent\/80:hover { background-color: rgb(var(--hq-accent) / 0.8) !important; }
    .hover\:bg-hq-cyan\/10:hover { background-color: rgb(var(--hq-cyan) / 0.1) !important; }
    .hover\:bg-hq-cyan\/20:hover { background-color: rgb(var(--hq-cyan) / 0.2) !important; }
    .hover\:bg-hq-green\/10:hover { background-color: rgb(var(--hq-green) / 0.1) !important; }
    .hover\:bg-hq-green\/20:hover { background-color: rgb(var(--hq-green) / 0.2) !important; }
    .hover\:bg-hq-green\/30:hover { background-color: rgb(var(--hq-green) / 0.3) !important; }
    .hover\:bg-hq-purple\/10:hover { background-color: rgb(var(--hq-purple) / 0.1) !important; }
    .hover\:bg-hq-purple\/20:hover { background-color: rgb(var(--hq-purple) / 0.2) !important; }
    .hover\:bg-hq-yellow\/10:hover { background-color: rgb(var(--hq-yellow) / 0.1) !important; }
    .hover\:bg-hq-yellow\/20:hover { background-color: rgb(var(--hq-yellow) / 0.2) !important; }
    .hover\:bg-hq-red\/10:hover { background-color: rgb(var(--hq-red) / 0.1) !important; }
    .hover\:bg-hq-red\/20:hover { background-color: rgb(var(--hq-red) / 0.2) !important; }
    .hover\:bg-hq-red\/30:hover { background-color: rgb(var(--hq-red) / 0.3) !important; }

    .hover\:border-hq-border:hover { border-color: rgb(var(--hq-border)) !important; }
    .hover\:border-hq-border-light:hover { border-color: rgb(var(--hq-border-light)) !important; }
    .hover\:border-hq-muted:hover { border-color: rgb(var(--hq-muted)) !important; }
    .hover\:border-hq-accent\/20:hover { border-color: rgb(var(--hq-accent) / 0.2) !important; }
    .hover\:border-hq-accent\/30:hover { border-color: rgb(var(--hq-accent) / 0.3) !important; }
    .hover\:border-hq-accent\/40:hover { border-color: rgb(var(--hq-accent) / 0.4) !important; }
    .hover\:border-hq-cyan\/30:hover { border-color: rgb(var(--hq-cyan) / 0.3) !important; }
    .hover\:border-hq-yellow\/30:hover { border-color: rgb(var(--hq-yellow) / 0.3) !important; }
    .hover\:border-hq-purple\/30:hover { border-color: rgb(var(--hq-purple) / 0.3) !important; }

    .hover\:from-hq-accent\/15:hover { --tw-gradient-from: rgb(var(--hq-accent) / 0.15) !important; }
    .hover\:to-hq-purple\/15:hover { --tw-gradient-to: rgb(var(--hq-purple) / 0.15) !important; }
    .hover\:shadow-hq-accent\/20:hover { --tw-shadow-color: rgb(var(--hq-accent) / 0.2) !important; }

    /* ═══ focus: 변형 ═══ */
    .focus\:border-hq-accent:focus { border-color: rgb(var(--hq-accent)) !important; }
    .focus\:border-hq-accent\/50:focus { border-color: rgb(var(--hq-accent) / 0.5) !important; }
    .focus\:ring-hq-accent\/50:focus { --tw-ring-color: rgb(var(--hq-accent) / 0.5) !important; }

    /* ═══ group-hover: 변형 ═══ */
    .group:hover .group-hover\:text-hq-text { color: rgb(var(--hq-text)) !important; }
    .group:hover .group-hover\:text-hq-accent { color: rgb(var(--hq-accent)) !important; }

    /* ═══ disabled: 변형 ═══ */
    .disabled\:text-hq-muted:disabled { color: rgb(var(--hq-muted)) !important; }

    /* ═══ 상태 뱃지 색상 보장 ═══ */
    .status-badge { color: inherit !important; }
  </style>
</head>

<body class="text-hq-text h-screen flex flex-col overflow-hidden"
      x-data="corthexApp()" x-init="init()">

  <!-- ═══ Top Bar ═══ -->
  <header class="h-14 glass border-b border-hq-border flex items-center justify-between px-5 shrink-0 z-20">
    <div class="flex items-center gap-4">
      <!-- Sidebar Toggle -->
      <button @click="sidebarOpen = !sidebarOpen"
              class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-hq-panel/50 transition-colors text-hq-muted hover:text-hq-text"
              :title="sidebarOpen ? '사이드바 접기' : '사이드바 펼치기'">
        <svg x-show="sidebarOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/>
        </svg>
        <svg x-show="!sidebarOpen" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/>
        </svg>
      </button>
      <!-- Logo (클릭 → 홈) -->
      <div class="flex items-center gap-2.5 cursor-pointer hover:opacity-80 transition-opacity"
           @click="viewMode = 'chat'; activeTab = 'command'; $nextTick(() => scrollToBottom()); setTimeout(() => scrollToBottom(), 300)">
        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGrad" x1="0" y1="0" x2="32" y2="32">
              <stop offset="0%" stop-color="#00ff88"/>
              <stop offset="50%" stop-color="#00e6ff"/>
              <stop offset="100%" stop-color="#8c64ff"/>
            </linearGradient>
          </defs>
          <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#logoGrad)" stroke-width="1.5" fill="none"/>
          <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#logoGrad)" stroke-width="1" fill="none" opacity="0.5"/>
          <circle cx="16" cy="16" r="4" fill="url(#logoGrad)" opacity="0.8"/>
          <circle cx="16" cy="16" r="2" fill="rgb(10 12 18)"/>
          <line x1="16" y1="12" x2="16" y2="6" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="16" y1="20" x2="16" y2="26" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
        </svg>
        <div>
          <div class="text-base font-bold tracking-widest gradient-text font-mono">CORTHEX <span class="text-hq-muted/50 text-xs">HQ</span></div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-[10px] font-mono text-hq-muted bg-hq-surface border border-hq-border rounded-md px-2 py-0.5">빌드 #BUILD_NUMBER_PLACEHOLDER</span>
        <span class="text-[10px] font-mono text-hq-cyan/85 bg-hq-cyan/5 border border-hq-cyan/20 rounded-md px-2 py-0.5">CEO 관제</span>
      </div>
    </div>

    <!-- 로그아웃 버튼 (로그인 상태이고 부트스트랩 모드가 아닐 때만) -->
    <template x-if="auth.token && !auth.bootstrapMode">
      <button @click="doLogout()"
              class="text-[10px] text-hq-muted hover:text-hq-red border border-hq-border hover:border-hq-red/30 rounded-md px-2 py-0.5 transition mr-2"
              title="로그아웃">로그아웃</button>
    </template>

    <div class="flex items-center gap-5">
      <!-- System Status (click → health popover) -->
      <div class="flex items-center gap-2 relative">
        <template x-if="systemStatus === 'idle'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-green/10 border border-hq-green/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-green/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-green"></span>
            <span class="text-xs font-medium text-hq-green">대기</span>
          </div>
        </template>
        <template x-if="systemStatus === 'working'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-yellow/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
            <span class="text-xs font-medium text-hq-yellow">처리중</span>
          </div>
        </template>
        <template x-if="systemStatus === 'error'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-red/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-red"></span>
            <span class="text-xs font-medium text-hq-red">오류</span>
          </div>
        </template>
        <!-- Health Popover -->
        <div x-show="showHealthPopover" @click.outside="showHealthPopover = false" x-transition
             class="absolute top-full mt-2 right-0 w-72 glass border border-hq-border rounded-xl p-4 shadow-xl z-30"
             style="display: none;">
          <h4 class="text-xs font-bold text-hq-text uppercase tracking-wider mb-3">시스템 상태 상세</h4>
          <template x-if="healthData">
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs text-hq-muted">전체</span>
                <span class="text-xs font-bold" :class="(healthData.status === 'ok' || healthData.overall === 'ok') ? 'text-hq-green' : (healthData.status === 'warning' || healthData.overall === 'warning') ? 'text-hq-yellow' : 'text-hq-red'"
                      x-text="(healthData.status === 'ok' || healthData.overall === 'ok') ? '정상' : (healthData.status === 'warning' || healthData.overall === 'warning') ? '경고' : '오류'"></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-hq-muted">서버</span>
                <span class="text-xs" x-text="healthData.mode || '미니서버'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.agents !== undefined">
                <span class="text-xs text-hq-muted">등록 에이전트</span>
                <span class="text-xs font-mono text-hq-accent" x-text="healthData.agents + '명'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.telegram !== undefined">
                <span class="text-xs text-hq-muted">텔레그램</span>
                <span class="text-xs" x-text="healthData.telegram ? '연결됨' : '미연결'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.model_router !== undefined">
                <span class="text-xs text-hq-muted">모델 라우터 (경로 배정)</span>
                <span class="text-xs" x-text="healthData.model_router ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.registry !== undefined">
                <span class="text-xs text-hq-muted">에이전트 레지스트리 (등록소)</span>
                <span class="text-xs" x-text="healthData.registry ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.knowledge_mgr !== undefined">
                <span class="text-xs text-hq-muted">지식 관리자</span>
                <span class="text-xs" x-text="healthData.knowledge_mgr ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.agent_count !== undefined">
                <span class="text-xs text-hq-muted">등록된 에이전트</span>
                <span class="text-xs font-mono text-hq-accent" x-text="healthData.agent_count + '명'"></span>
              </div>
              <template x-if="healthData.checks && healthData.checks.length > 0">
                <div class="border-t border-hq-border/50 pt-2 mt-2 space-y-1">
                  <template x-for="check in healthData.checks" :key="check.name || check">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] text-hq-muted" x-text="check.name || check"></span>
                      <span class="text-[11px]" :class="check.ok ? 'text-hq-green' : 'text-hq-red'" x-text="check.ok ? '✅' : '❌'"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
          <template x-if="!healthData">
            <div class="text-xs text-hq-muted text-center py-2">로딩 중...</div>
          </template>
        </div>
      </div>

      <!-- Metrics -->
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-green/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span class="text-xs font-mono text-hq-green" x-text="'$' + totalCost.toFixed(4)"></span>
        </div>
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-purple/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
          <span class="text-xs font-mono text-hq-text/90" x-text="totalTokens.toLocaleString()"></span>
        </div>
      </div>

      <!-- Connection -->
      <div class="flex items-center gap-1.5" :class="wsConnected ? 'text-hq-green' : 'text-hq-red'">
        <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
        <span class="text-[11px] font-mono" x-text="wsConnected ? '연결됨' : '끊김'"></span>
      </div>

      <!-- View Toggle: 채팅/사무실/대시보드 -->
      <div class="flex items-center bg-hq-surface border border-hq-border rounded-lg">
        <button @click="if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);dashboardRefreshTimer=null;} viewMode = 'chat'"
                :class="viewMode === 'chat' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold rounded-l-lg transition-colors">채팅</button>
        <button @click="if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);dashboardRefreshTimer=null;} viewMode = 'office'"
                :class="viewMode === 'office' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold border-x border-hq-border transition-colors">사무실</button>
        <button @click="viewMode = 'dashboard'; loadDashboard(); if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);} dashboardRefreshTimer = setInterval(() => loadDashboard(), 30000)"
                :class="viewMode === 'dashboard' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold rounded-r-lg transition-colors">대시보드</button>
      </div>

      <!-- Dark/Light Toggle -->
      <button @click="toggleTheme()" class="text-hq-muted hover:text-hq-text transition" title="다크/라이트 모드 전환">
        <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
      </button>

      <!-- Quality Settings Button -->
      <button @click="showQualitySettings = true; loadQualityRules()"
              class="text-hq-muted hover:text-hq-text transition" title="품질 검수 설정">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
    </div>
  </header>
  <div class="h-[2px] bg-gradient-to-r from-hq-cyan via-hq-accent to-hq-purple shrink-0"></div>

  <!-- ═══ Toast Notifications ═══ -->
  <div class="fixed top-16 right-4 z-50 space-y-2 max-w-sm" style="pointer-events:none;">
    <template x-for="toast in toasts" :key="toast.id">
      <div :class="[
        toast.visible ? 'toast-in' : 'toast-out',
        toast.type === 'success' ? 'border-hq-green/40 bg-hq-green/10' :
        toast.type === 'error' ? 'border-hq-red/40 bg-hq-red/10' :
        toast.type === 'warning' ? 'border-hq-yellow/40 bg-hq-yellow/10' :
        'border-hq-accent/40 bg-hq-accent/10'
      ]" class="glass border rounded-xl px-4 py-3 text-sm shadow-lg" style="pointer-events:auto;">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full shrink-0"
                :class="toast.type==='success'?'bg-hq-green':toast.type==='error'?'bg-hq-red':toast.type==='warning'?'bg-hq-yellow':'bg-hq-accent'"></span>
          <span class="flex-1 text-hq-text text-sm" x-text="toast.message"></span>
          <button @click="removeToast(toast.id)" class="text-hq-muted hover:text-hq-text text-lg leading-none ml-2">&times;</button>
        </div>
      </div>
    </template>
  </div>

  <!-- ═══ Connection Lost Banner ═══ -->
  <div x-show="connectionLost" x-transition
       class="bg-hq-red/15 border-b border-hq-red/30 text-center py-2 text-sm text-hq-red shrink-0 flex items-center justify-center gap-2">
    <span class="w-2 h-2 bg-hq-red rounded-full pulse-dot"></span>
    서버 연결이 끊어졌습니다. 재연결 시도중... (<span x-text="reconnectAttempt"></span>회)
  </div>

  <!-- ═══ Main Layout ═══ -->
  <div class="flex flex-1 overflow-hidden">

    <!-- ═══ Left Panel: Organization ═══ -->
    <aside x-show="sidebarOpen"
           x-transition:enter="transition-all ease-out duration-300"
           x-transition:enter-start="opacity-0 -translate-x-full w-0"
           x-transition:enter-end="opacity-100 translate-x-0 w-[280px]"
           x-transition:leave="transition-all ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-x-0 w-[280px]"
           x-transition:leave-end="opacity-0 -translate-x-full w-0"
           class="w-[280px] bg-hq-surface border-r border-hq-border flex flex-col shrink-0 overflow-hidden">

      <!-- Org Tree -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-1.5">
        <div class="flex items-center justify-between px-2 mb-3">
          <div class="text-[10px] font-bold text-hq-muted uppercase tracking-[0.15em] font-mono">ORG TREE</div>
          <div class="text-[10px] font-mono text-hq-muted" x-text="Object.keys(agentNames).length + '명'"></div>
        </div>
        <!-- 에이전트 상태 요약 -->
        <div class="flex items-center gap-3 px-2 py-2 mb-3 rounded-lg bg-hq-panel border border-hq-border/30 text-[10px]">
          <span class="flex items-center gap-1 text-hq-green"><span class="w-1.5 h-1.5 rounded-full bg-hq-green animate-pulse"></span> <span x-text="Object.values(activeAgents).filter(a => a.status === 'working').length"></span> 활동</span>
          <span class="flex items-center gap-1 text-hq-yellow"><span class="w-1.5 h-1.5 rounded-full bg-hq-yellow"></span> <span x-text="Object.values(activeAgents).filter(a => a.status === 'idle').length"></span> 대기</span>
          <span class="flex items-center gap-1 text-hq-muted"><span class="w-1.5 h-1.5 rounded-full bg-hq-muted/80"></span> <span x-text="Object.keys(agentNames).length - Object.values(activeAgents).filter(a => a.status === 'working' || a.status === 'idle').length"></span> 비활성</span>
        </div>

        <!-- CEO -->
        <div class="mb-3">
          <div @click="showCeoProfile = true" class="flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-gradient-to-r from-hq-accent/10 to-hq-purple/10 border border-hq-accent/20 cursor-pointer hover:border-hq-accent/40 hover:from-hq-accent/15 hover:to-hq-purple/15 transition-all">
            <div class="agent-avatar bg-gradient-to-br from-hq-accent to-hq-purple text-white">
              CEO
            </div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-hq-text font-mono">CEO</div>
              <div class="text-[10px] text-hq-muted font-mono">COMMANDER</div>
            </div>
            <span class="text-[10px] text-hq-muted/85">&#9654;</span>
          </div>
        </div>

        <!-- 비서실 -->
        <div class="mb-1.5">
          <button @click="toggleSection('secretary')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.secretary ? 'bg-hq-yellow/10 border-hq-yellow/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-hq-yellow/20 flex items-center justify-center text-hq-yellow text-[10px] font-bold shrink-0">BS</div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">비서실</div>
                <div class="text-[10px] text-hq-muted">AI 에이전트 4명</div>
              </div>
              <span class="status-badge" :class="getSectionBadgeClass('secretary')"
                    x-text="getSectionStatusText('secretary')"></span>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.secretary ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.secretary" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-yellow/20 space-y-0.5">
            <template x-for="id in ['chief_of_staff', 'report_specialist', 'schedule_specialist', 'relay_specialist']" :key="id">
              <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-hq-yellow/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                <span class="w-1.5 h-1.5 rounded-full transition-colors shrink-0 mt-0.5" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-hq-text" x-text="getAgentName(id)"></div>
                </div>
                <span x-show="activeAgents[id]?.status === 'working'"
                      class="ml-auto text-[9px] font-mono text-hq-yellow shrink-0"
                      x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- LEET Master 본부 -->
        <div class="mb-1.5">
          <button @click="toggleSection('leet_master')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.leet_master ? 'bg-hq-cyan/10 border-hq-cyan/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-hq-cyan/20 flex items-center justify-center text-hq-cyan text-[10px] font-bold shrink-0">LM</div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">LEET Master 본부</div>
                <div class="text-[10px] text-hq-muted">4개 부서 · AI 에이전트 21명</div>
              </div>
              <span class="status-badge" :class="getSectionBadgeClass('leet_master')"
                    x-text="getSectionStatusText('leet_master')"></span>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.leet_master ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.leet_master" x-collapse class="space-y-0.5 mt-1">

            <!-- 기술개발팀 CTO -->
            <div class="ml-4 mb-1.5">
              <button @click="toggleSection('tech')"
                      class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                      :class="expanded.tech ? 'bg-hq-cyan/10 border-hq-cyan/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-lg bg-hq-cyan/20 flex items-center justify-center text-hq-cyan text-[10px] font-bold shrink-0"
                       :class="getAgentDotClass('cto_manager').includes('pulse') ? 'ring-1 ring-hq-green ring-offset-1 ring-offset-hq-bg' : ''">CTO</div>
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-hq-text">기술개발팀</div>
                    <div class="text-[10px] text-hq-muted">AI 에이전트 5명</div>
                  </div>
                  <span class="status-badge" :class="getSectionBadgeClass('tech')" x-text="getSectionStatusText('tech')"></span>
                  <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.tech ? 'rotate-90' : ''">&#9654;</span>
                </div>
              </button>
              <div x-show="expanded.tech" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-cyan/20 space-y-0.5">
                <template x-for="id in ['cto_manager','frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                  <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-cyan/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 전략기획팀 CSO -->
            <div class="ml-4 mb-1.5">
              <button @click="toggleSection('strategy')"
                      class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                      :class="expanded.strategy ? 'bg-hq-purple/10 border-hq-purple/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-lg bg-hq-purple/20 flex items-center justify-center text-hq-purple text-[10px] font-bold shrink-0">CSO</div>
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-hq-text">전략기획팀</div>
                    <div class="text-[10px] text-hq-muted">AI 에이전트 4명</div>
                  </div>
                  <span class="status-badge" :class="getSectionBadgeClass('strategy')" x-text="getSectionStatusText('strategy')"></span>
                  <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.strategy ? 'rotate-90' : ''">&#9654;</span>
                </div>
              </button>
              <div x-show="expanded.strategy" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-purple/20 space-y-0.5">
                <template x-for="id in ['cso_manager','market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                  <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-purple/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 법무팀 CLO -->
            <div class="ml-4 mb-1.5">
              <button @click="toggleSection('legal')"
                      class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                      :class="expanded.legal ? 'bg-hq-green/10 border-hq-green/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-lg bg-hq-green/20 flex items-center justify-center text-hq-green text-[10px] font-bold shrink-0">CLO</div>
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-hq-text">법무팀</div>
                    <div class="text-[10px] text-hq-muted">AI 에이전트 3명</div>
                  </div>
                  <span class="status-badge" :class="getSectionBadgeClass('legal')" x-text="getSectionStatusText('legal')"></span>
                  <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.legal ? 'rotate-90' : ''">&#9654;</span>
                </div>
              </button>
              <div x-show="expanded.legal" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-green/20 space-y-0.5">
                <template x-for="id in ['clo_manager','copyright_specialist','patent_specialist']" :key="id">
                  <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-green/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 마케팅팀 CMO -->
            <div class="ml-4 mb-1.5">
              <button @click="toggleSection('marketing')"
                      class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                      :class="expanded.marketing ? 'bg-hq-yellow/10 border-hq-yellow/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-lg bg-hq-yellow/20 flex items-center justify-center text-hq-yellow text-[10px] font-bold shrink-0">CMO</div>
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-hq-text">마케팅팀</div>
                    <div class="text-[10px] text-hq-muted">AI 에이전트 4명</div>
                  </div>
                  <span class="status-badge" :class="getSectionBadgeClass('marketing')" x-text="getSectionStatusText('marketing')"></span>
                  <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.marketing ? 'rotate-90' : ''">&#9654;</span>
                </div>
              </button>
              <div x-show="expanded.marketing" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-yellow/20 space-y-0.5">
                <template x-for="id in ['cmo_manager','survey_specialist','content_specialist','community_specialist']" :key="id">
                  <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-yellow/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

          </div>
        </div>

        <!-- 금융분석팀 CIO -->
        <div class="mb-1.5">
          <button @click="toggleSection('finance')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.finance ? 'bg-hq-red/10 border-hq-red/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-hq-red/20 flex items-center justify-center text-hq-red text-[10px] font-bold shrink-0">CIO</div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">금융분석팀</div>
                <div class="text-[10px] text-hq-muted">AI 에이전트 5명</div>
              </div>
              <span class="status-badge" :class="getSectionBadgeClass('finance')" x-text="getSectionStatusText('finance')"></span>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.finance ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.finance" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-red/20 space-y-0.5">
            <template x-for="id in ['cio_manager','market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
              <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-red/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                <!-- 동시/순서대로 표시는 에이전트 상세 팝업에서만 노출 -->
              </div>
            </template>
          </div>
        </div>

        <!-- 콘텐츠팀 CPO -->
        <div class="mb-1.5">
          <button @click="toggleSection('publishing')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.publishing ? 'bg-hq-accent/10 border-hq-accent/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-hq-accent/20 flex items-center justify-center text-hq-accent text-[10px] font-bold shrink-0">CPO</div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">콘텐츠팀</div>
                <div class="text-[10px] text-hq-muted">AI 에이전트 4명</div>
              </div>
              <span class="status-badge" :class="getSectionBadgeClass('publishing')" x-text="getSectionStatusText('publishing')"></span>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.publishing ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.publishing" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-accent/20 space-y-0.5">
            <template x-for="id in ['cpo_manager', 'chronicle_specialist', 'editor_specialist', 'archive_specialist']" :key="id">
              <div :id="'agent-' + id" @click="openAgentConfig(id)" class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-hq-accent/10 transition-all duration-300 cursor-pointer" title="클릭하면 모델·추론·소울 설정 가능">
                <span class="w-1.5 h-1.5 rounded-full transition-colors shrink-0 mt-0.5" :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-hq-text" x-text="getAgentName(id)"></div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Tool Pool -->
        <div class="mb-1.5">
          <button @click="toggleSection('tools')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.tools ? 'bg-hq-red/10 border-hq-red/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-hq-red/15 flex items-center justify-center text-hq-red shrink-0">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">도구함</div>
                <div class="text-[10px] text-hq-muted" x-text="(toolsList || []).length + '개 도구'"></div>
              </div>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.tools ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.tools" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-red/20 space-y-0.5 max-h-48 overflow-y-auto scrollbar-thin">
            <template x-for="t in (toolsList || [])" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-red/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-red/40"></span>
                <span class="text-xs text-hq-text/90" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
            <template x-if="!toolsList || toolsList.length === 0">
              <div class="text-[10px] text-hq-muted/80 px-2 py-2">서버 연결 후 표시됩니다</div>
            </template>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="border-t border-hq-border shrink-0 mt-2">
        <button @click="logExpanded = !logExpanded"
                class="w-full flex items-center justify-between px-4 py-2 hover:bg-hq-panel/20 transition-colors">
          <div class="flex items-center gap-2">
            <svg class="w-3.5 h-3.5 text-hq-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            <span class="text-[10px] font-bold text-hq-muted uppercase tracking-[0.15em]">활동 로그</span>
          </div>
          <div class="flex items-center gap-2">
            <span x-show="activityLogs.length > 0"
                  class="text-[9px] font-mono bg-hq-accent/10 text-hq-accent px-1.5 py-0.5 rounded"
                  x-text="activityLogs.length"></span>
            <svg class="w-3 h-3 text-hq-muted transition-transform duration-200"
                 :class="logExpanded ? 'rotate-180' : ''"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </div>
        </button>
        <div x-show="logExpanded" x-collapse>
          <!-- 전체삭제 버튼 -->
          <div x-show="activityLogs.length > 0" class="flex items-center justify-end px-3 pb-1">
            <button @click="activityLogs = []; saveActivityLogs()" class="text-[10px] text-hq-red/60 hover:text-hq-red transition">전체 삭제</button>
          </div>
          <div class="overflow-y-auto scrollbar-thin max-h-52 px-3 pb-3 space-y-0.5">
            <template x-for="(log, i) in activityLogs.slice(-50).reverse()" :key="i">
              <div class="log-item text-[11px] text-hq-muted fade-in group flex items-center gap-1">
                <div class="flex-1 min-w-0">
                  <span class="font-mono text-hq-muted/80" x-text="(log.time || '').substring(0, 5)"></span>
                  <span class="text-hq-cyan/70 font-medium" x-text="log.agent_id"></span>
                  <span x-text="log.action"></span>
                </div>
                <button @click="activityLogs.splice(activityLogs.indexOf(log), 1); saveActivityLogs()"
                        class="opacity-0 group-hover:opacity-100 text-hq-red/50 hover:text-hq-red transition shrink-0" title="삭제">&times;</button>
              </div>
            </template>
            <template x-if="activityLogs.length === 0">
              <div class="text-[11px] text-hq-muted/80 italic px-2 py-2">아직 활동이 없습니다</div>
            </template>
          </div>
        </div>
      </div>
    </aside>

    <!-- ═══ Right Panel: Tabs + Content ═══ -->
    <main class="flex-1 flex flex-col overflow-hidden bg-hq-bg">

      <!-- ═══ Error Alert Banner ═══ -->
      <div x-show="errorAlert.visible" x-transition
           class="bg-hq-red/15 border-b border-hq-red/30 px-5 py-2 flex items-center justify-between shrink-0" style="display:none;">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
          <span class="text-sm text-hq-red font-medium" x-text="errorAlert.message"></span>
        </div>
        <button @click="errorAlert.visible = false" class="text-hq-red/50 hover:text-hq-red text-lg">&times;</button>
      </div>

      <!-- ═══ Tab Navigation (채팅 모드일 때만 표시) ═══ -->
      <div x-show="viewMode === 'chat'" class="flex items-center gap-0.5 px-3 pt-2 pb-0 border-b border-hq-border bg-hq-surface shrink-0 mobile-tabs-scroll">
        <!-- 기본 탭 5개 (#12) -->
        <template x-for="tab in getPrimaryTabs()" :key="tab.id">
          <button @click="switchTab(tab.id); showMoreTabs = false"
                  :class="activeTab === tab.id
                    ? 'text-hq-accent border-hq-accent bg-hq-accent/10 font-bold'
                    : 'text-hq-muted border-transparent hover:text-hq-text hover:bg-hq-panel/20'"
                  class="flex items-center gap-1.5 px-3 py-2 text-[11px] font-semibold border-b-2 transition-all rounded-t-lg whitespace-nowrap">
            <span x-html="tab.icon" class="w-3.5 h-3.5"></span>
            <span x-text="tab.label"></span>
          </button>
        </template>
        <!-- 더보기 드롭다운 -->
        <div class="relative">
          <button @click="showMoreTabs = !showMoreTabs"
                  :class="getSecondaryTabs().some(t => t.id === activeTab)
                    ? 'text-hq-accent border-hq-accent bg-hq-accent/10 font-bold'
                    : 'text-hq-muted border-transparent hover:text-hq-text hover:bg-hq-panel/20'"
                  class="flex items-center gap-1 px-3 py-2 text-[11px] font-semibold border-b-2 transition-all rounded-t-lg whitespace-nowrap">
            <span x-text="getSecondaryTabs().find(t => t.id === activeTab)?.label || '더보기'"></span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div x-show="showMoreTabs" @click.outside="showMoreTabs = false" x-transition
               class="absolute top-full left-0 mt-1 glass border border-hq-border rounded-xl py-1 shadow-xl z-30 min-w-[140px]" style="display:none;">
            <template x-for="tab in getSecondaryTabs()" :key="tab.id">
              <button @click="switchTab(tab.id); showMoreTabs = false"
                      :class="activeTab === tab.id ? 'bg-hq-accent/10 text-hq-accent' : 'text-hq-muted hover:text-hq-text hover:bg-hq-panel/20'"
                      class="flex items-center gap-2 w-full px-3 py-2 text-xs transition">
                <span x-html="tab.icon" class="w-3.5 h-3.5"></span>
                <span x-text="tab.label"></span>
              </button>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 홈 (Home Dashboard) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'home'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin px-6 pt-8 pb-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">
          <div class="mb-6">
            <h1 class="text-2xl font-bold gradient-text mb-1">CYBER COMMAND CENTER</h1>
            <p class="text-sm text-hq-muted">작전 현황 — 29개 유닛 실시간 모니터링</p>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-accent/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-text" x-text="dashboard.todayTasks || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">오늘 작업</div>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[11px]">
                <span class="text-hq-green" x-text="'완료 ' + (dashboard.todayCompleted || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-yellow" x-text="'진행 ' + (dashboard.runningCount || 0)"></span>
              </div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-green/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-text" x-text="'$' + (dashboard.totalCost || 0).toFixed(4)"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">누적 비용</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted" x-text="(dashboard.totalTokens || 0).toLocaleString() + ' AI 사용량'"></div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-purple/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-text" x-text="dashboard.agentCount || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">에이전트</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted">4개 본부 운영 중</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-accent/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                </div>
                <div>
                  <div class="text-sm font-bold text-hq-text">API 키</div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">연결 상태</div>
                </div>
              </div>
              <div class="space-y-1 text-[11px]">
                <template x-for="key in [
                  {id: 'anthropic', label: 'Anthropic'},
                  {id: 'openai', label: 'OpenAI'},
                  {id: 'telegram', label: 'Telegram'},
                  {id: 'notion', label: 'Notion'},
                ]" :key="key.id">
                  <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full" :class="dashboard.apiKeys?.[key.id] ? 'bg-hq-green' : 'bg-hq-red'"></span>
                    <span class="text-hq-muted" x-text="key.label"></span>
                    <span class="ml-auto font-mono" :class="dashboard.apiKeys?.[key.id] ? 'text-hq-green' : 'text-hq-red/70'" x-text="dashboard.apiKeys?.[key.id] ? '등록됨' : '미등록'"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Feedback + Budget Row -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
            <!-- CEO 만족도 카드 (#7) -->
            <div class="glass border border-hq-border rounded-xl p-5 hover-glow">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-9 h-9 rounded-lg bg-hq-yellow/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div class="flex-1">
                  <div class="text-xl font-bold text-hq-text" x-text="(feedbackStats.satisfaction_rate || 0) + '%'"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">CEO 만족도</div>
                </div>
                <!-- 만족도 시각 표시 바 -->
                <div class="w-20 h-20 relative flex items-center justify-center shrink-0">
                  <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="rgb(var(--hq-border))" stroke-width="3"/>
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="rgb(var(--hq-yellow))" stroke-width="3"
                          :stroke-dasharray="(feedbackStats.satisfaction_rate || 0) + ', 100'"/>
                  </svg>
                  <span class="absolute text-[11px] font-bold text-hq-yellow" x-text="(feedbackStats.satisfaction_rate || 0) + '%'"></span>
                </div>
              </div>
              <div class="flex items-center gap-3 text-[11px]">
                <span class="text-hq-green" x-text="'좋아요 ' + (feedbackStats.good || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-red" x-text="'아쉬워요 ' + (feedbackStats.bad || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-muted" x-text="'총 ' + (feedbackStats.total || 0) + '건'"></span>
              </div>
            </div>
            <!-- 예산 현황 + 수정 카드 (#8) -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-cyan/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
                <div class="flex-1">
                  <div class="text-sm font-bold text-hq-text">예산</div>
                  <div class="text-[10px] text-hq-muted">일일 $<span x-text="(budget.daily_limit || 0).toFixed(2)"></span> / 월 $<span x-text="(budget.monthly_limit || 0).toFixed(2)"></span></div>
                </div>
                <button @click="showBudgetEdit = true; budgetEditDaily = budget.daily_limit || 0; budgetEditMonthly = budget.monthly_limit || 0"
                        class="text-xs text-hq-accent hover:text-hq-accent/80 px-2 py-1 border border-hq-accent/20 rounded-lg">수정</button>
              </div>
              <div class="w-full bg-hq-bg rounded-full h-2 mt-1">
                <div class="bg-gradient-to-r from-hq-green to-hq-yellow h-2 rounded-full transition-all"
                     :style="'width:' + Math.min(100, ((budget.today_spent || 0) / Math.max(budget.daily_limit || 1, 0.01)) * 100) + '%'"></div>
              </div>
              <div class="text-[10px] text-hq-muted mt-1">오늘 사용: $<span x-text="(budget.today_spent || 0).toFixed(4)"></span></div>
            </div>
          </div>

          <!-- Recent Completed Tasks -->
          <div class="glass border border-hq-border rounded-xl p-5 mb-6">
            <h2 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              최근 완료 작업
            </h2>
            <template x-if="dashboard.recentCompleted && dashboard.recentCompleted.length > 0">
              <div class="space-y-2">
                <template x-for="task in dashboard.recentCompleted" :key="task.task_id">
                  <div class="flex items-center justify-between p-3 bg-hq-panel rounded-lg hover:bg-hq-bg transition cursor-pointer"
                       @click="switchTab('history')">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm text-hq-text truncate" x-text="task.command"></div>
                      <div class="text-[11px] text-hq-muted mt-0.5" x-text="new Date(task.created_at).toLocaleString('ko-KR', {timeZone:'Asia/Seoul'})"></div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0 ml-4">
                      <span class="text-[11px] font-mono text-hq-green" x-text="task.time_seconds + '초'"></span>
                      <span class="text-[11px] font-mono text-hq-muted" x-text="'$' + (task.cost || 0).toFixed(4)"></span>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!dashboard.recentCompleted || dashboard.recentCompleted.length === 0">
              <div class="text-center py-8 text-hq-muted/80 text-sm">아직 완료된 작업이 없습니다</div>
            </template>
          </div>

          <!-- Quick Commands (프리셋 카드 그리드) -->
          <div class="glass border border-hq-border rounded-xl p-5">
            <h2 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              빠른 명령
            </h2>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
              <!-- 서버 프리셋 -->
              <template x-for="p in presets.items" :key="p.name">
                <button @click="switchTab('command'); $nextTick(() => sendPreset(p.command))"
                        class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                  <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent" x-text="p.name"></div>
                  <div class="text-[11px] text-hq-muted mt-1 truncate" x-text="p.command"></div>
                </button>
              </template>
              <!-- 기본 프리셋 (서버 프리셋이 없을 때만 표시) -->
              <template x-if="!presets.items || presets.items.length === 0">
                <div class="contents">
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '전 부서 현황 보고'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">📊 전 부서 현황</div>
                    <div class="text-[11px] text-hq-muted mt-1">전 부서 현황 보고</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@CTO 기술 점검 실행'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">🔧 기술 점검</div>
                    <div class="text-[11px] text-hq-muted mt-1">@CTO 기술 점검 실행</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@CSO 보안 스캔 시작'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">🛡️ 보안 스캔</div>
                    <div class="text-[11px] text-hq-muted mt-1">@CSO 보안 스캔 시작</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@CMO 마케팅 전략 분석'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">📈 마케팅 분석</div>
                    <div class="text-[11px] text-hq-muted mt-1">@CMO 마케팅 전략 분석</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@CFO 예산 현황 정리'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">💰 예산 현황</div>
                    <div class="text-[11px] text-hq-muted mt-1">@CFO 예산 현황 정리</div>
                  </button>
                </div>
              </template>
              <button @click="switchTab('command')"
                      class="text-left p-4 bg-hq-panel/30 rounded-xl border border-dashed border-hq-border hover:border-hq-accent/30 transition group flex items-center justify-center min-h-[60px]">
                <span class="text-sm text-hq-muted group-hover:text-hq-accent">+ 직접 명령</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 명령 (Command) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'command'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 flex flex-col overflow-hidden relative">

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto scrollbar-thin px-6 pt-8 pb-6 space-y-4 bg-grid" id="chatArea" x-ref="chatArea" @scroll="onChatScroll($event)">

          <!-- ═══ Welcome Screen ═══ -->
          <template x-if="messages.length === 0 && viewMode === 'chat'">
            <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">
              <div class="mb-6 relative">
                <svg width="72" height="72" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-lg">
                  <defs><linearGradient id="heroGrad" x1="0" y1="0" x2="32" y2="32"><stop offset="0%" stop-color="#00ff88"/><stop offset="50%" stop-color="#00e6ff"/><stop offset="100%" stop-color="#8c64ff"/></linearGradient></defs>
                  <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#heroGrad)" stroke-width="1.5" fill="none"/>
                  <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#heroGrad)" stroke-width="1" fill="none" opacity="0.4"/>
                  <circle cx="16" cy="16" r="4" fill="url(#heroGrad)" opacity="0.8"/><circle cx="16" cy="16" r="2" fill="rgb(10 12 18)"/>
                  <line x1="16" y1="12" x2="16" y2="6" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="16" y1="20" x2="16" y2="26" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                </svg>
                <div class="absolute inset-0 bg-hq-accent/10 rounded-full blur-3xl scale-150"></div>
              </div>

              <h1 class="text-4xl font-extrabold gradient-text mb-2 tracking-tight" style="letter-spacing: 0.15em;">CYBER COMMAND</h1>
              <p class="text-lg text-hq-green/90 mb-1 font-mono" x-text="greeting"></p>
              <p class="text-hq-cyan/60 text-sm mb-8 max-w-sm leading-relaxed font-mono">
                [ SYSTEM ONLINE ] 29 UNITS STANDING BY
              </p>

              <div class="flex gap-3 mb-6">
                <div class="glass border border-hq-green/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.1s">
                  <div class="text-lg font-bold text-hq-green font-mono">7</div><div class="text-[10px] text-hq-green/50 uppercase tracking-wider font-mono">DIVISION</div>
                </div>
                <div class="glass border border-hq-cyan/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.2s">
                  <div class="text-lg font-bold text-hq-cyan font-mono" x-text="agentsList.length || 29"></div><div class="text-[10px] text-hq-cyan/50 uppercase tracking-wider font-mono">AGENTS</div>
                </div>
                <div class="glass border border-hq-purple/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.3s">
                  <div class="text-lg font-bold text-hq-purple font-mono" x-text="toolsList.length || 103"></div><div class="text-[10px] text-hq-purple/50 uppercase tracking-wider font-mono">WEAPONS</div>
                </div>
                <div class="glass border border-hq-accent/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.4s">
                  <div class="text-lg font-bold text-hq-accent font-mono">3</div><div class="text-[10px] text-hq-accent/50 uppercase tracking-wider font-mono">AI ENGINE</div>
                </div>
              </div>

              <!-- Preset Category Tabs -->
              <div class="flex gap-2 mb-4">
                <template x-for="tab in presetTabs" :key="tab">
                  <button @click="presetTab = tab"
                    :class="presetTab === tab ? 'bg-hq-accent/20 border-hq-accent/40 text-hq-accent' : 'bg-hq-surface border-hq-border text-hq-muted hover:text-hq-text'"
                    class="border rounded-lg px-3 py-1.5 text-xs font-semibold transition-all" x-text="tab"></button>
                </template>
              </div>

              <!-- Preset Commands Grid -->
              <div class="grid grid-cols-2 gap-3 max-w-lg w-full max-h-[300px] overflow-y-auto scrollbar-thin">
                <template x-for="preset in getFilteredPresets()" :key="preset.name">
                  <div class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group relative">
                    <div @click="sendPreset(preset.command)" class="cursor-pointer">
                      <div class="flex items-center gap-2 mb-1.5">
                        <div class="w-7 h-7 rounded-lg flex items-center justify-center" :class="'bg-' + preset.color + '/15'">
                          <span class="w-3 h-3 rounded-full" :class="'bg-' + preset.color"></span>
                        </div>
                        <span class="text-sm font-semibold text-hq-text group-hover:text-hq-text transition-colors" x-text="preset.name"></span>
                      </div>
                      <p class="text-[11px] text-hq-muted leading-relaxed" x-text="preset.desc"></p>
                    </div>
                    <button x-show="preset.isServer" @click.stop="deletePreset(preset.name)"
                      class="absolute top-2 right-2 text-hq-muted/70 hover:text-hq-red text-xs transition opacity-0 group-hover:opacity-100" title="삭제">&times;</button>
                  </div>
                </template>
              </div>
              <!-- Add Preset Button & Form -->
              <div class="mt-3 max-w-lg w-full">
                <button x-show="!showAddPreset" @click="showAddPreset = true"
                  class="text-xs text-hq-accent hover:text-hq-accent/80 transition">+ 새 프리셋 추가</button>
                <div x-show="showAddPreset" x-transition class="glass border border-hq-border rounded-xl p-3 space-y-2">
                  <input x-model="newPresetName" placeholder="프리셋 이름" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text placeholder-hq-muted/70">
                  <input x-model="newPresetCommand" placeholder="명령어" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text placeholder-hq-muted/70">
                  <div class="flex gap-2">
                    <button @click="addPreset()" class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-3 py-1 text-xs">추가</button>
                    <button @click="showAddPreset = false; newPresetName = ''; newPresetCommand = ''" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-3 py-1 text-xs">취소</button>
                  </div>
                </div>
              </div>
              <!-- 텍스트 제거됨 (#17) -->
            </div>
          </template>

          <!-- ═══ Messages ═══ -->
          <template x-for="(msg, i) in messages" :key="i">
            <div>

              <!-- 날짜 구분선 (카카오톡 스타일) -->
              <template x-if="shouldShowDateSeparator(messages, i)">
                <div class="flex items-center my-4 gap-3">
                  <div class="flex-1 h-px bg-hq-muted/20"></div>
                  <span class="text-xs text-hq-muted/60 whitespace-nowrap" x-text="formatDate(msg.timestamp)"></span>
                  <div class="flex-1 h-px bg-hq-muted/20"></div>
                </div>
              </template>

              <!-- User message -->
              <template x-if="msg.type === 'user'">
                <div class="flex justify-end mb-4 msg-user">
                  <div class="max-w-2xl">
                    <div class="bg-gradient-to-br from-hq-accent/20 to-hq-purple/10 border border-hq-accent/20 rounded-2xl rounded-tr-md px-5 py-3.5 glow-blue">
                      <div class="flex items-center gap-2 mb-1.5">
                        <div class="w-5 h-5 rounded-md bg-gradient-to-br from-hq-accent to-hq-purple flex items-center justify-center">
                          <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                        <span class="text-[11px] font-bold text-hq-accent uppercase tracking-wider" x-text="msg.source === 'telegram' ? 'CEO 명령 (텔레그램)' : 'CEO 명령'"></span>
                      </div>
                      <div class="text-hq-text text-sm leading-relaxed whitespace-pre-wrap" x-text="msg.text"></div>
                      <span class="text-[10px] text-hq-muted/40 ml-2 shrink-0 self-end block text-right mt-1" x-text="formatTime(msg.timestamp)"></span>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Processing indicator -->
              <template x-if="msg.type === 'processing'">
                <div class="mb-4 msg-processing">
                  <div class="max-w-3xl">
                    <div class="glass border border-hq-yellow/20 rounded-2xl rounded-tl-md px-5 py-4">
                      <div class="flex items-center gap-2 mb-3">
                        <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
                        <span class="text-xs font-bold text-hq-yellow uppercase tracking-wider">에이전트 작업중</span>
                        <div class="ml-auto flex gap-1">
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0s"></span>
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0.3s"></span>
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0.6s"></span>
                        </div>
                      </div>
                      <div class="space-y-2.5">
                        <template x-for="(status, agentId) in activeAgents" :key="agentId">
                          <div x-show="status.status === 'working'" class="fade-in cursor-pointer" @click="scrollToAgent(agentId)">
                            <div class="flex items-center justify-between mb-1">
                              <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold"
                                     :class="getAgentAvatarClass(agentId)" x-text="getAgentInitials(agentId)"></div>
                                <span class="text-xs text-hq-text/80 font-medium" x-text="getAgentName(agentId)"></span>
                              </div>
                              <span class="text-[10px] font-mono text-hq-yellow" x-text="Math.round(status.progress * 100) + '%'"></span>
                            </div>
                            <div x-show="status.detail" class="text-[10px] text-hq-muted mb-1 pl-7 truncate" x-text="status.detail"></div>
                            <div class="h-1 bg-hq-bg rounded-full overflow-hidden">
                              <div class="h-full rounded-full progress-bar bg-gradient-to-r from-hq-yellow to-hq-accent"
                                   :style="'width:' + (status.progress * 100) + '%'"></div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Agent result -->
              <template x-if="msg.type === 'result'">
                <div class="mb-4 msg-result">
                  <div class="max-w-4xl">
                    <div class="glass border border-hq-green/20 rounded-2xl rounded-tl-md overflow-hidden">
                      <div class="flex items-center justify-between px-5 py-3 border-b border-hq-border/50 bg-hq-green/[0.03]">
                        <div class="flex items-center gap-2.5">
                          <div class="w-2 h-2 rounded-full bg-hq-green"></div>
                          <span class="text-xs font-bold text-hq-green tracking-wider" x-text="msg.delegation || msg.handled_by || '비서실장'"></span>
                          <template x-if="msg.quality_score">
                            <span class="status-badge border" :class="getQualityBadge(msg.quality_score).cls" x-text="getQualityBadge(msg.quality_score).label"></span>
                          </template>
                        </div>
                        <div class="flex items-center gap-3">
                          <div class="flex items-center gap-4 text-[11px] font-mono text-hq-muted">
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                              <span x-text="msg.time_seconds + 's'"></span>
                            </div>
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                              <span x-text="'$' + (msg.cost || 0).toFixed(4)"></span>
                            </div>
                            <template x-if="msg.model">
                              <div class="flex items-center gap-1">
                                <span class="text-hq-accent">&#9679;</span>
                                <span x-text="msg.model.includes('-') ? msg.model.split('-')[1] : msg.model"></span>
                              </div>
                            </template>
                          </div>
                          <button @click="copyToClipboard(msg.content)" class="text-hq-muted hover:text-hq-green transition p-1" title="복사">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                          </button>
                          <!-- Feedback Buttons -->
                          <div class="flex items-center gap-0.5 border-l border-hq-border/40 pl-2 ml-1">
                            <button @click="sendFeedback(msg, 'good')"
                              :class="msg.feedbackRating === 'good' ? 'text-hq-green scale-110 bg-green-500/20 ring-1 ring-green-400/50 rounded' : 'text-hq-muted hover:text-hq-green'"
                              class="transition-all duration-200 p-1" :title="msg.feedbackRating === 'good' ? '좋아요 취소' : '좋아요'">
                              <svg class="w-4 h-4" :fill="msg.feedbackRating === 'good' ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg>
                            </button>
                            <button @click="sendFeedback(msg, 'bad')"
                              :class="msg.feedbackRating === 'bad' ? 'text-hq-red scale-110 bg-red-500/20 ring-1 ring-red-400/50 rounded' : 'text-hq-muted hover:text-hq-red'"
                              class="transition-all duration-200 p-1" :title="msg.feedbackRating === 'bad' ? '아쉬워요 취소' : '아쉬워요'">
                              <svg class="w-4 h-4" :fill="msg.feedbackRating === 'bad' ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a3.5 3.5 0 003.5 3.5h.5a2 2 0 002-2v-.5c0-.966-.393-1.84-1.027-2.472L17 13V4m-7 10h2M17 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/></svg>
                            </button>
                          </div>
                          <button x-show="isLongContent(msg.content)" @click="msg.collapsed = !msg.collapsed"
                            class="text-hq-muted hover:text-hq-text transition p-1" title="접기/펼치기">
                            <svg class="w-4 h-4 transition-transform" :class="msg.collapsed ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                          </button>
                        </div>
                      </div>
                      <div class="px-5 py-4" x-show="!msg.collapsed" x-collapse>
                        <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(msg.content)"></div>
                      </div>
                      <div x-show="msg.collapsed" class="px-5 py-3">
                        <div class="text-sm text-hq-muted italic">결과가 접혀있습니다. 위 버튼을 클릭하면 펼칩니다. <span class="text-[11px] font-mono ml-2" x-text="'(' + (msg.content?.length || 0) + '자)'"></span></div>
                      </div>
                      <div class="px-5 pb-2 text-right">
                        <span class="text-[10px] text-hq-muted/40" x-text="formatTime(msg.timestamp)"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Error -->
              <template x-if="msg.type === 'error'">
                <div class="mb-4 scale-in">
                  <div class="max-w-2xl">
                    <div class="bg-hq-red/5 border border-hq-red/20 rounded-2xl rounded-tl-md px-5 py-4">
                      <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                        <span class="text-xs font-bold text-hq-red uppercase tracking-wider">오류</span>
                      </div>
                      <div class="text-sm text-hq-text/80" x-text="msg.text"></div>
                      <span class="text-[10px] text-hq-muted/40 block text-right mt-1" x-text="formatTime(msg.timestamp)"></span>
                    </div>
                  </div>
                </div>
              </template>

            </div>
          </template>
        </div>

        <!-- 스크롤 다운 버튼 -->
        <button x-show="showScrollBtn" x-transition @click="scrollToBottomSmooth()"
          class="absolute bottom-20 right-6 z-30 w-10 h-10 rounded-full bg-hq-accent/80 hover:bg-hq-accent text-white shadow-lg flex items-center justify-center backdrop-blur-sm transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
          <span x-show="newMsgCount > 0" x-text="newMsgCount"
            class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center"></span>
        </button>

        <!-- ═══ Input Bar ═══ -->
        <div class="border-t-2 border-hq-accent/20 bg-hq-surface/90 backdrop-blur-md p-4 shrink-0 shadow-[0_-4px_16px_rgb(var(--hq-shadow)/0.08)] relative z-50">
          <div class="max-w-4xl mx-auto relative">
            <!-- 슬래시 명령어 팝업 -->
            <div x-show="showSlashDropdown" x-transition
                 class="absolute bottom-full mb-2 left-0 w-96 bg-[rgb(var(--hq-surface))] border border-hq-border rounded-xl overflow-hidden shadow-2xl z-[999]">
              <div class="px-4 py-2 border-b border-hq-border/30">
                <span class="text-xs text-hq-muted font-semibold tracking-wide">명령어</span>
              </div>
              <template x-for="(cmd, idx) in filteredSlashCommands" :key="cmd.cmd">
                <button @click="insertSlashCommand(cmd)" @mouseenter="slashSelectedIndex = idx"
                  class="w-full px-4 py-2.5 text-left flex items-center gap-3 transition-colors"
                  :class="idx === slashSelectedIndex ? 'bg-hq-accent/15' : 'hover:bg-hq-accent/5'">
                  <span class="text-lg w-7 text-center" x-text="cmd.icon"></span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="text-hq-accent font-mono font-bold text-sm" x-text="cmd.cmd"></span>
                      <span class="text-hq-muted/60 text-xs" x-text="cmd.args"></span>
                    </div>
                    <div class="text-[13px] text-hq-muted font-medium truncate mt-0.5" x-text="cmd.desc"></div>
                  </div>
                </button>
              </template>
            </div>
            <!-- @mention dropdown -->
            <div x-show="showMentionDropdown" x-transition
                 class="absolute bottom-full mb-2 left-0 w-64 glass border border-hq-border rounded-xl overflow-hidden shadow-xl z-10">
              <template x-for="agent in mentionResults" :key="agent.id">
                <button @click="insertMention(agent)"
                  class="w-full px-3 py-2 text-left text-sm hover:bg-hq-accent/10 flex items-center gap-2 transition-colors">
                  <span class="w-6 h-6 rounded-md flex items-center justify-center text-[9px] font-bold"
                    :class="getAgentAvatarClass(agent.id)" x-text="getAgentInitials(agent.id)"></span>
                  <span class="text-hq-text" x-text="agent.name"></span>
                  <span class="text-hq-muted text-xs ml-auto" x-text="'@' + agent.id"></span>
                </button>
              </template>
            </div>
            <div class="flex items-end gap-3">
              <!-- Batch/실시간 세그먼트 토글 -->
              <div class="flex rounded-xl border border-hq-border/40 overflow-hidden shrink-0 self-stretch">
                <button @click="useBatch = false"
                        class="text-xs px-3 py-2 transition-all"
                        :class="!useBatch
                          ? 'bg-hq-accent/15 text-hq-accent'
                          : 'text-hq-muted/60 hover:text-hq-muted'">⚡ 실시간</button>
                <button @click="useBatch = true"
                        class="text-xs px-3 py-2 transition-all"
                        :class="useBatch
                          ? 'bg-hq-purple/15 text-hq-purple'
                          : 'text-hq-muted/60 hover:text-hq-muted'">📦 Batch</button>
              </div>
              <div class="flex-1 relative">
                <textarea x-model="inputText" x-ref="inputArea"
                  @keydown="handleInputKeydown($event)" @input="handleInputChange($event)"
                  :disabled="systemStatus === 'working'"
                  :placeholder="inputHints[inputHintIndex]"
                  rows="1"
                  class="w-full bg-hq-bg border-2 border-hq-border-light rounded-xl px-4 py-3 pr-10 text-sm text-hq-text
                         placeholder-hq-muted/70 focus:outline-none focus:border-hq-accent/60 input-glow-animated
                         disabled:opacity-40 disabled:cursor-not-allowed transition-all resize-none overflow-hidden
                         shadow-sm"
                  style="min-height:44px; max-height:200px;" autofocus></textarea>
                <div class="absolute right-3 bottom-3 text-[10px] font-mono text-hq-muted/70"
                     x-show="!inputText.trim() && systemStatus !== 'working'">Enter &#9166;</div>
              </div>
              <button x-show="systemStatus !== 'working'" @click="sendMessage()"
                :disabled="!inputText.trim()"
                :class="inputText.trim()
                  ? 'bg-gradient-to-r from-hq-green/80 to-hq-cyan/80 hover:from-hq-green hover:to-hq-cyan text-black shadow-lg shadow-hq-green/30 hover:shadow-xl hover:shadow-hq-green/40'
                  : 'border-2 border-hq-accent/30 bg-hq-accent/10 text-hq-accent/40'"
                class="rounded-full w-12 h-12 flex items-center justify-center transition-all shrink-0"
                title="보내기">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18"/>
                </svg>
              </button>
              <button x-show="systemStatus === 'working'" @click="cancelTask()"
                class="bg-hq-red/20 border border-hq-red/30 hover:bg-hq-red/30
                       text-hq-red rounded-xl px-6 py-3 text-sm font-semibold transition-all shrink-0 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                취소
              </button>
            </div>
          </div>
          <!-- Preset Chips + 대화 내보내기 (프리셋이 있거나 메시지가 있을 때만 표시) -->
          <div x-show="(presets.items && presets.items.length > 0) || messages.length > 0" class="flex items-center gap-2 flex-wrap mt-2 max-w-4xl mx-auto overflow-x-auto scrollbar-thin">
            <template x-for="p in presets.items" :key="p.name">
              <button @click="sendPreset(p.command)"
                      :disabled="systemStatus === 'working'"
                      class="text-[11px] bg-hq-panel border border-hq-border rounded-lg px-2.5 py-1 hover:border-hq-accent/40 hover:text-hq-accent transition disabled:opacity-30 text-hq-muted whitespace-nowrap shrink-0">
                <span x-text="p.name"></span>
              </button>
            </template>
            <button x-show="presets.items && presets.items.length > 0" @click="presets.showModal = true" class="text-[11px] text-hq-muted/80 hover:text-hq-accent transition px-1 shrink-0">
              <svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            </button>
            <!-- 대화 내보내기 + 비우기 (오른쪽 끝) -->
            <div x-show="messages.length > 0" class="flex items-center gap-2 ml-auto shrink-0">
              <button @click="exportConversation()"
                      class="text-[10px] text-hq-muted/70 hover:text-hq-accent flex items-center gap-1 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                내보내기
              </button>
              <span class="text-hq-border">|</span>
              <button @click="clearConversation()"
                      class="text-[10px] text-hq-muted/70 hover:text-hq-red flex items-center gap-1 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                대화 비우기
              </button>
            </div>
          </div>
        </div>
      </div><!-- /command tab -->

      <!-- ═══ Tab: 성능 (Performance) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'performance'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">
          <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-wide">POWER ANALYSIS</h1>
          <p class="text-sm text-hq-muted mb-6">에이전트별 작업 통계를 확인하세요</p>

          <!-- Performance Summary Cards -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-text" x-text="performance.totalCalls || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 LLM 호출</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-green" x-text="'$' + (performance.totalCost || 0).toFixed(4)"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 비용</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-text" x-text="performance.totalTasks || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 작업</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-cyan" x-text="(performance.avgSuccessRate || 0).toFixed(0) + '%'"></div>
              <div class="text-[10px] text-hq-muted uppercase">평균 성공률</div>
            </div>
          </div>

          <!-- Agent Performance Table -->
          <div class="glass border border-hq-border rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-hq-border text-[11px] text-hq-muted uppercase">
                  <th class="text-left px-4 py-3">에이전트</th>
                  <th class="text-right px-4 py-3">호출</th>
                  <th class="text-right px-4 py-3">비용</th>
                  <th class="text-right px-4 py-3">작업</th>
                  <th class="text-right px-4 py-3">성공률</th>
                  <th class="text-right px-4 py-3">평균 시간</th>
                  <th class="px-4 py-3 w-32">비용 비율</th>
                  <th class="px-4 py-3">기억</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="a in performance.agents" :key="a.agent_id">
                  <tr class="border-b border-hq-border/50 hover:bg-hq-panel/20">
                    <td class="px-4 py-2.5">
                      <div class="text-hq-text font-medium" x-text="a.name_ko"></div>
                      <div class="text-[10px] text-hq-muted" x-text="a.role"></div>
                    </td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.llm_calls"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-green" x-text="'$' + (a.cost_usd || 0).toFixed(4)"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.tasks_completed"></td>
                    <td class="text-right px-4 py-2.5">
                      <span class="font-mono" :class="(a.success_rate||0) >= 80 ? 'text-hq-green' : (a.success_rate||0) >= 50 ? 'text-hq-yellow' : 'text-hq-red'"
                            x-text="(a.success_rate || 0).toFixed(0) + '%'"></span>
                    </td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-muted" x-text="(a.avg_execution_seconds || 0).toFixed(1) + '초'"></td>
                    <td class="px-4 py-2.5">
                      <div class="h-2 bg-hq-bg rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-hq-accent to-hq-cyan rounded-full transition-all"
                             :style="'width:' + (performance.maxCost > 0 ? ((a.cost_usd || 0) / performance.maxCost * 100) : 0) + '%'"></div>
                      </div>
                    </td>
                    <td class="px-4 py-2.5 text-center">
                      <button @click="openMemoryModal(a.agent_id, a.name_ko)"
                              class="text-[10px] px-2 py-1 rounded border border-hq-purple/30 text-hq-purple hover:bg-hq-purple/10 transition">기억</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <template x-if="!performance.agents || performance.agents.length === 0">
              <div class="text-center py-12 text-hq-muted/80 text-sm">성능 데이터가 없습니다. 작업을 실행하면 통계가 쌓입니다.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Office View (가상 사무실) ═══ -->
      <div x-show="viewMode === 'office'" x-transition.opacity.duration.200ms class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto space-y-5 fade-in-up">

          <!-- CEO 사무실 -->
          <div class="office-room glass border border-hq-accent/20 bg-gradient-to-br from-hq-accent/5 to-hq-purple/5">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-accent border border-hq-accent/10">
              <span class="text-lg">⚡</span>
              <span class="text-sm font-bold text-hq-accent uppercase tracking-wider font-mono">COMMAND CENTER</span>
            </div>
            <div class="flex gap-3">
              <div class="desk-card glass border border-hq-accent/30 w-[160px] cursor-pointer" @click="showCeoProfile = true">
                <div class="flex items-center justify-between mb-2">
                  <div class="agent-avatar bg-gradient-to-br from-hq-accent to-hq-purple text-white text-[10px]">CEO</div>
                  <div class="status-light status-light-working"></div>
                </div>
                <div class="text-sm font-semibold text-hq-text font-mono">CEO</div>
                <div class="text-[10px] text-hq-muted font-mono">COMMANDER (You)</div>
              </div>
            </div>
          </div>

          <!-- 비서실 -->
          <div class="office-room glass border border-hq-yellow/20 bg-hq-yellow/[0.06]">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-yellow border border-hq-yellow/10">
              <span class="text-lg">🎖️</span>
              <span class="text-sm font-bold text-hq-yellow uppercase tracking-wider font-mono">STAFF OPS</span>
              <span class="text-[10px] text-hq-muted ml-auto">4명</span>
            </div>
            <div class="grid grid-cols-4 gap-3">
              <template x-for="id in ['chief_of_staff', 'report_specialist', 'schedule_specialist', 'relay_specialist']" :key="id">
                <div class="desk-card glass border border-hq-border hover:border-hq-yellow/30" @click="openAgentConfig(id)">
                  <div class="flex items-center justify-between mb-2">
                    <div class="agent-avatar bg-hq-yellow/20 text-hq-yellow text-[9px]" x-text="getAgentInitials(id)"></div>
                    <div class="status-light" :class="getAgentStatusLight(id)"></div>
                  </div>
                  <div class="text-xs font-semibold text-hq-text truncate" x-text="getAgentName(id)"></div>
                  <div class="text-[10px] text-hq-muted truncate" x-text="agentRoles[id] || id"></div>
                  <div x-show="agentModels[id]" class="text-[9px] text-hq-muted/85 font-mono truncate" x-text="getModelDisplayName(agentModels[id]) + (agentReasonings[id] ? ' (' + agentReasonings[id] + ')' : '')"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- LEET Master 본부 -->
          <div class="office-room glass border border-hq-cyan/20 bg-hq-cyan/[0.06]">
            <div class="flex items-center gap-3 mb-4 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-cyan border border-hq-cyan/10">
              <span class="text-lg">🛡️</span>
              <span class="text-sm font-bold text-hq-cyan uppercase tracking-wider font-mono">LEET MASTER HQ</span>
              <span class="text-[10px] text-hq-muted ml-auto">16명 (4개 처)</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <!-- 기술개발처 CTO -->
              <div class="bg-hq-panel border border-hq-border rounded-xl p-3">
                <div class="flex items-center gap-2 mb-3 px-2 py-1.5 rounded-md bg-hq-surface/50 border-l-2 border-l-hq-cyan">
                  <span class="text-sm">🔧</span>
                  <span class="text-xs font-bold text-hq-cyan">기술개발처 (CTO)</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <template x-for="id in ['cto_manager','frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                    <div class="desk-card bg-hq-surface border border-hq-border hover:border-hq-cyan/30" @click="openAgentConfig(id)">
                      <div class="flex items-center justify-between mb-1.5">
                        <div class="agent-avatar bg-hq-cyan/20 text-hq-cyan text-[8px]" x-text="getAgentInitials(id)"></div>
                        <div class="status-light" :class="getAgentStatusLight(id)"></div>
                      </div>
                      <div class="text-[11px] font-medium text-hq-text truncate" x-text="getAgentName(id)"></div>
                      <div class="text-[9px] text-hq-muted truncate" x-show="agentRoles[id]" x-text="agentRoles[id]"></div>
                    </div>
                  </template>
                </div>
              </div>
              <!-- 사업기획처 CSO -->
              <div class="bg-hq-panel border border-hq-border rounded-xl p-3">
                <div class="flex items-center gap-2 mb-3 px-2 py-1.5 rounded-md bg-hq-surface/50 border-l-2 border-l-hq-cyan">
                  <span class="text-sm">📊</span>
                  <span class="text-xs font-bold text-hq-cyan">사업기획처 (CSO)</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <template x-for="id in ['cso_manager','market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                    <div class="desk-card bg-hq-surface border border-hq-border hover:border-hq-cyan/30" @click="openAgentConfig(id)">
                      <div class="flex items-center justify-between mb-1.5">
                        <div class="agent-avatar bg-hq-cyan/20 text-hq-cyan text-[8px]" x-text="getAgentInitials(id)"></div>
                        <div class="status-light" :class="getAgentStatusLight(id)"></div>
                      </div>
                      <div class="text-[11px] font-medium text-hq-text truncate" x-text="getAgentName(id)"></div>
                      <div class="text-[9px] text-hq-muted truncate" x-show="agentRoles[id]" x-text="agentRoles[id]"></div>
                    </div>
                  </template>
                </div>
              </div>
              <!-- 법무 IP처 CLO -->
              <div class="bg-hq-panel border border-hq-border rounded-xl p-3">
                <div class="flex items-center gap-2 mb-3 px-2 py-1.5 rounded-md bg-hq-surface/50 border-l-2 border-l-hq-cyan">
                  <span class="text-sm">⚖️</span>
                  <span class="text-xs font-bold text-hq-cyan">법무 IP처 (CLO)</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <template x-for="id in ['clo_manager','copyright_specialist','patent_specialist']" :key="id">
                    <div class="desk-card bg-hq-surface border border-hq-border hover:border-hq-cyan/30" @click="openAgentConfig(id)">
                      <div class="flex items-center justify-between mb-1.5">
                        <div class="agent-avatar bg-hq-cyan/20 text-hq-cyan text-[8px]" x-text="getAgentInitials(id)"></div>
                        <div class="status-light" :class="getAgentStatusLight(id)"></div>
                      </div>
                      <div class="text-[11px] font-medium text-hq-text truncate" x-text="getAgentName(id)"></div>
                      <div class="text-[9px] text-hq-muted truncate" x-show="agentRoles[id]" x-text="agentRoles[id]"></div>
                    </div>
                  </template>
                </div>
              </div>
              <!-- 마케팅 고객처 CMO -->
              <div class="bg-hq-panel border border-hq-border rounded-xl p-3">
                <div class="flex items-center gap-2 mb-3 px-2 py-1.5 rounded-md bg-hq-surface/50 border-l-2 border-l-hq-cyan">
                  <span class="text-sm">📣</span>
                  <span class="text-xs font-bold text-hq-cyan">마케팅 고객처 (CMO)</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <template x-for="id in ['cmo_manager','survey_specialist','content_specialist','community_specialist']" :key="id">
                    <div class="desk-card bg-hq-surface border border-hq-border hover:border-hq-cyan/30" @click="openAgentConfig(id)">
                      <div class="flex items-center justify-between mb-1.5">
                        <div class="agent-avatar bg-hq-cyan/20 text-hq-cyan text-[8px]" x-text="getAgentInitials(id)"></div>
                        <div class="status-light" :class="getAgentStatusLight(id)"></div>
                      </div>
                      <div class="text-[11px] font-medium text-hq-text truncate" x-text="getAgentName(id)"></div>
                      <div class="text-[9px] text-hq-muted truncate" x-show="agentRoles[id]" x-text="agentRoles[id]"></div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- 투자분석 본부 -->
          <div class="office-room glass border border-hq-purple/20 bg-hq-purple/[0.06]">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-purple border border-hq-purple/10">
              <span class="text-lg">📡</span>
              <span class="text-sm font-bold text-hq-purple uppercase tracking-wider font-mono">INVESTMENT HQ</span>
              <span class="text-[10px] text-hq-muted ml-auto">5명</span>
            </div>
            <div class="grid grid-cols-5 gap-3">
              <template x-for="id in ['cio_manager','market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
                <div class="desk-card glass border border-hq-border hover:border-hq-purple/30" @click="openAgentConfig(id)">
                  <div class="flex items-center justify-between mb-2">
                    <div class="agent-avatar bg-hq-purple/20 text-hq-purple text-[8px]" x-text="getAgentInitials(id)"></div>
                    <div class="status-light" :class="getAgentStatusLight(id)"></div>
                  </div>
                  <div class="text-[11px] font-medium text-hq-text truncate" x-text="getAgentName(id)"></div>
                  <div class="text-[9px] text-hq-muted truncate" x-show="agentRoles[id]" x-text="agentRoles[id]"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- 도구 풀 -->
          <div class="office-room glass border border-hq-border bg-hq-red/[0.06]">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-red border border-hq-red/10">
              <span class="text-lg">⚔️</span>
              <span class="text-sm font-bold text-hq-red/70 uppercase tracking-wider font-mono">WEAPON POOL</span>
              <span class="text-[10px] text-hq-muted ml-auto">5개</span>
            </div>
            <div class="grid grid-cols-5 gap-3">
              <template x-for="tool in [{n:'변리사',c:'amber'},{n:'세무사',c:'emerald'},{n:'디자이너',c:'pink'},{n:'번역가',c:'sky'},{n:'웹검색',c:'orange'}]" :key="tool.n">
                <div class="desk-card bg-hq-surface border border-hq-border cursor-default">
                  <div class="flex items-center justify-between mb-2">
                    <div class="agent-avatar bg-hq-muted/10 text-hq-muted text-[9px]">T</div>
                    <div class="status-light status-light-off"></div>
                  </div>
                  <div class="text-[11px] font-medium text-hq-muted" x-text="tool.n"></div>
                  <div class="text-[9px] text-hq-muted/80">외부 도구</div>
                </div>
              </template>
            </div>
          </div>

          <p class="text-center text-[11px] text-hq-muted/80 mt-4">에이전트를 클릭하면 모델, 추론 정도, 소울(성격)을 설정할 수 있습니다</p>
        </div>
      </div>

      <!-- ═══ Dashboard View ═══ -->
      <div x-show="viewMode === 'dashboard'" x-transition.opacity.duration.200ms class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">

          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-wide">DASHBOARD</h1>
              <p class="text-sm text-hq-muted font-mono">실시간 운영 현황</p>
            </div>
            <button @click="loadDashboard()" class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-muted hover:text-hq-text transition flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              새로고침
            </button>
          </div>

          <!-- Loading -->
          <template x-if="!dashboard.loaded">
            <div class="flex items-center justify-center py-20">
              <div class="text-hq-muted flex items-center gap-2">
                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                대시보드 로딩 중...
              </div>
            </div>
          </template>

          <!-- Content -->
          <template x-if="dashboard.loaded">
            <div class="space-y-6">

              <!-- Summary Cards -->
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">오늘 작업</div>
                  <div class="text-2xl font-bold text-hq-text" x-text="dashboard.todayTasks"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">완료</div>
                  <div class="text-2xl font-bold text-hq-green" x-text="dashboard.todayCompleted"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">실패</div>
                  <div class="text-2xl font-bold text-hq-red" x-text="dashboard.todayFailed"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">진행중</div>
                  <div class="text-2xl font-bold text-hq-yellow" x-text="dashboard.runningCount"></div>
                </div>
              </div>

              <!-- Cost & Agent Info -->
              <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">총 비용</div>
                  <div class="text-lg font-bold text-hq-accent">$<span x-text="(dashboard.totalCost || 0).toFixed(2)"></span></div>
                  <div class="text-[10px] text-hq-muted mt-1" x-text="(dashboard.totalTokens || 0).toLocaleString() + ' 토큰'"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">에이전트</div>
                  <div class="text-lg font-bold text-hq-cyan" x-text="(dashboard.agentCount || 0) + '명'"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">시스템 상태</div>
                  <div class="flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" :class="dashboard.systemHealth === 'ok' ? 'bg-hq-green' : 'bg-hq-red'"></span>
                    <span class="text-lg font-bold" :class="dashboard.systemHealth === 'ok' ? 'text-hq-green' : 'text-hq-red'" x-text="dashboard.systemHealth === 'ok' ? '정상' : '이상'"></span>
                  </div>
                </div>
              </div>

              <!-- Budget Section (항상 표시) -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <span class="text-hq-yellow">$</span> 예산 현황
                  </h3>
                  <button @click="showBudgetEdit = true; budgetEditDaily = budget.daily_limit || 0; budgetEditMonthly = budget.monthly_limit || 0"
                          class="text-xs text-hq-accent hover:text-hq-accent/80 px-2 py-1 border border-hq-accent/20 rounded-lg transition">한도 수정</button>
                </div>
                <!-- 한도 미설정 안내 -->
                <div x-show="!budget.daily_limit && !budget.monthly_limit" class="text-center py-4">
                  <div class="text-xs text-hq-muted mb-2">예산 한도가 설정되지 않았습니다</div>
                  <button @click="showBudgetEdit = true; budgetEditDaily = 10; budgetEditMonthly = 200"
                          class="text-xs bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-lg px-3 py-1.5 hover:bg-hq-accent/20 transition">한도 설정하기</button>
                </div>
                <div class="space-y-4" x-show="budget.daily_limit || budget.monthly_limit">
                  <!-- Daily Budget -->
                  <div x-show="budget.daily_limit">
                    <div class="flex justify-between text-xs mb-1.5">
                      <span class="text-hq-muted">일일 예산</span>
                      <span class="text-hq-text font-mono">$<span x-text="(budget.daily_used || 0).toFixed(2)"></span> / $<span x-text="(budget.daily_limit || 0).toFixed(2)"></span></span>
                    </div>
                    <div class="w-full bg-hq-bg rounded-full h-2.5">
                      <div class="h-2.5 rounded-full transition-all duration-500"
                           :class="(budget.daily_used / budget.daily_limit * 100) > 80 ? 'bg-hq-red' : 'bg-hq-green'"
                           :style="'width: ' + Math.min(100, (budget.daily_used || 0) / (budget.daily_limit || 1) * 100) + '%'"></div>
                    </div>
                  </div>
                  <!-- Monthly Budget -->
                  <div x-show="budget.monthly_limit">
                    <div class="flex justify-between text-xs mb-1.5">
                      <span class="text-hq-muted">월간 예산</span>
                      <span class="text-hq-text font-mono">$<span x-text="(budget.monthly_used || 0).toFixed(2)"></span> / $<span x-text="(budget.monthly_limit || 0).toFixed(2)"></span></span>
                    </div>
                    <div class="w-full bg-hq-bg rounded-full h-2.5">
                      <div class="h-2.5 rounded-full transition-all duration-500"
                           :class="(budget.monthly_used / budget.monthly_limit * 100) > 80 ? 'bg-hq-red' : 'bg-hq-accent'"
                           :style="'width: ' + Math.min(100, (budget.monthly_used || 0) / (budget.monthly_limit || 1) * 100) + '%'"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Model Mode Section -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <span class="text-hq-accent">&#9881;</span> AI 모델 모드
                  </h3>
                </div>
                <div class="flex gap-2 mb-3">
                  <button @click="modelMode = 'auto'; saveModelMode()"
                          :class="modelMode === 'auto' ? 'bg-hq-accent text-white' : 'bg-hq-bg text-hq-muted border border-hq-border'"
                          class="flex-1 text-xs font-bold px-3 py-2 rounded-lg transition">
                    자동
                  </button>
                  <button @click="modelMode = 'manual'; saveModelMode()"
                          :class="modelMode === 'manual' ? 'bg-hq-accent text-white' : 'bg-hq-bg text-hq-muted border border-hq-border'"
                          class="flex-1 text-xs font-bold px-3 py-2 rounded-lg transition">
                    수동
                  </button>
                </div>
                <div x-show="modelMode === 'auto'" class="text-[10px] text-hq-muted">
                  질문 길이/내용에 따라 Haiku(저비용) 또는 Sonnet(고품질) 자동 선택
                </div>
                <div x-show="modelMode === 'manual'" class="mt-1">
                  <div class="text-[10px] text-hq-muted">각 에이전트에 개별 지정된 모델을 사용합니다</div>
                  <div class="text-[10px] text-hq-accent mt-1">에이전트 클릭 → 모델 탭에서 개별 변경 가능</div>
                </div>

                <!-- 전체 모델 일괄 변경 -->
                <div class="border-t border-hq-border mt-4 pt-4">
                  <div class="text-[11px] font-bold text-hq-text mb-2">전체 에이전트 모델 일괄 변경</div>
                  <div class="text-[10px] text-hq-muted mb-3">29명 전원의 모델과 추론 정도를 한번에 바꿉니다</div>
                  <!-- 모델 선택 -->
                  <select x-model="bulkModelSelection"
                          @change="bulkReasoningOptions = _getDefaultReasoning(bulkModelSelection); bulkReasoningSelection = ''"
                          class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text mb-2">
                    <option value="">모델 선택...</option>
                    <template x-for="[provLabel, models] of Object.entries(getModelsByProvider())" :key="provLabel">
                      <optgroup :label="provLabel">
                        <template x-for="m in models" :key="m.name">
                          <option :value="m.name" x-text="getModelDisplayName(m.name)"></option>
                        </template>
                      </optgroup>
                    </template>
                  </select>
                  <!-- 추론 정도 -->
                  <div x-show="bulkReasoningOptions.length > 0" class="flex flex-wrap gap-1.5 mb-3">
                    <button @click="bulkReasoningSelection = ''"
                            :class="!bulkReasoningSelection ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-hq-muted border-hq-border'"
                            class="text-[10px] border rounded-md px-2 py-1 transition">기본</button>
                    <template x-for="lv in bulkReasoningOptions" :key="lv">
                      <button @click="bulkReasoningSelection = lv"
                              :class="bulkReasoningSelection === lv
                                ? (lv === 'none' ? 'bg-hq-muted/20 text-hq-muted border-hq-muted'
                                  : lv === 'low' ? 'bg-hq-green/20 text-hq-green border-hq-green'
                                  : lv === 'medium' ? 'bg-hq-yellow/20 text-hq-yellow border-hq-yellow'
                                  : lv === 'high' ? 'bg-hq-purple/20 text-hq-purple border-hq-purple'
                                  : 'bg-hq-red/20 text-hq-red border-hq-red')
                                : 'text-hq-muted border-hq-border'"
                              class="text-[10px] border rounded-md px-2 py-1 transition"
                              x-text="({'none':'⛔ none','low':'⚡ low','medium':'🧠 medium','high':'🔬 high','xhigh':'🔥 xhigh'})[lv] || lv"></button>
                    </template>
                  </div>
                  <!-- 적용 버튼 -->
                  <button @click="applyBulkModel()"
                          :disabled="!bulkModelSelection || bulkModelSaving"
                          :class="bulkModelSelection ? 'bg-hq-accent hover:bg-blue-600 text-white' : 'bg-hq-bg text-hq-muted cursor-not-allowed border border-hq-border'"
                          class="w-full text-xs font-bold px-3 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                    <span x-show="bulkModelSaving" class="animate-spin">&#8987;</span>
                    <span x-text="bulkModelSaving ? '변경 중...' : '29명 전체 적용'"></span>
                  </button>
                </div>
              </div>

              <!-- Quality Section -->
              <div class="glass border border-hq-border rounded-xl p-5" x-show="quality && quality.total_reviews">
                <h3 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
                  <span class="text-hq-green">&#10003;</span> 품질 검수
                </h3>
                <div class="grid grid-cols-3 gap-4">
                  <div class="text-center">
                    <div class="text-2xl font-bold" :class="(quality.pass_rate || 0) >= 80 ? 'text-hq-green' : 'text-hq-yellow'" x-text="(quality.pass_rate || 0).toFixed(0) + '%'"></div>
                    <div class="text-[10px] text-hq-muted">합격률</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-hq-text" x-text="quality.total_reviews || 0"></div>
                    <div class="text-[10px] text-hq-muted">총 검수</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-hq-red" x-text="quality.failed || 0"></div>
                    <div class="text-[10px] text-hq-muted">불합격</div>
                  </div>
                </div>
              </div>

              <!-- Deploy Status (배포 현황) -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <svg class="w-4 h-4 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                    배포 현황
                  </h3>
                  <div class="flex items-center gap-2">
                    <button @click="loadDeployStatus()" class="text-[10px] text-hq-muted hover:text-hq-text transition">새로고침</button>
                    <a href="https://github.com/kodonghui/CORTHEX_HQ/actions" target="_blank"
                       class="text-[10px] text-hq-accent hover:underline">GitHub Actions ↗</a>
                  </div>
                </div>

                <!-- 배포 상태 카드 (정렬 통일) -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 2h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 8.172V3L8 2z"/></svg>
                      현재 빌드
                    </div>
                    <div class="text-base font-bold font-mono" :class="deployStatus.status === 'success' ? 'text-hq-green' : 'text-hq-red'" x-text="deployStatus.build ? '#' + deployStatus.build : '-'"></div>
                  </div>
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
                      서버 상태
                    </div>
                    <div class="text-base font-bold" :class="deployStatus.status === 'success' ? 'text-hq-green' : deployStatus.status === 'loading' ? 'text-hq-yellow' : 'text-hq-red'"
                         x-text="deployStatus.status === 'success' ? '정상' : deployStatus.status === 'loading' ? '확인중...' : '확인 불가'"></div>
                  </div>
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                      마지막 배포
                    </div>
                    <div class="text-base font-bold text-hq-text font-mono" x-text="deployStatus.time ? new Date(deployStatus.time).toLocaleString('ko-KR', {timeZone:'Asia/Seoul', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '-'"></div>
                  </div>
                </div>

                <!-- 최근 배포 로그 -->
                <div class="space-y-2" x-show="deployLogs.length > 0">
                  <div class="text-[10px] text-hq-muted font-bold uppercase tracking-wider mb-2">최근 배포 기록</div>
                  <template x-for="log in deployLogs" :key="log.id">
                    <div class="flex items-center gap-3 p-2 rounded-lg bg-hq-bg border border-hq-border/30">
                      <span class="w-2 h-2 rounded-full shrink-0" :class="log.conclusion === 'success' ? 'bg-hq-green' : log.conclusion === 'failure' ? 'bg-hq-red' : 'bg-hq-yellow'"></span>
                      <div class="flex-1 min-w-0">
                        <div class="text-xs text-hq-text truncate" x-text="'#' + log.number + ' — ' + log.title"></div>
                        <div class="text-[10px] text-hq-muted" x-text="new Date(log.time).toLocaleString('ko-KR', {timeZone:'Asia/Seoul', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})"></div>
                      </div>
                      <span class="text-[10px] font-mono shrink-0" :class="log.conclusion === 'success' ? 'text-hq-green' : 'text-hq-red'" x-text="log.conclusion === 'success' ? '성공' : '실패'"></span>
                    </div>
                  </template>
                </div>
                <div x-show="deployLogs.length === 0 && deployStatus.status !== 'loading'" class="text-center py-3">
                  <div class="text-xs text-hq-muted">배포 기록을 불러올 수 없습니다</div>
                  <div class="text-[10px] text-hq-muted mt-1">서버 연결 상태를 확인해주세요</div>
                </div>
              </div>

              <!-- Recent Completed -->
              <div class="glass border border-hq-border rounded-xl p-5" x-show="dashboard.recentCompleted && dashboard.recentCompleted.length > 0">
                <h3 class="text-sm font-bold text-hq-text mb-4">최근 완료 작업</h3>
                <div class="space-y-2">
                  <template x-for="task in dashboard.recentCompleted.slice(0, 8)" :key="task.task_id">
                    <div class="flex items-center gap-3 p-2.5 bg-hq-panel rounded-lg">
                      <span class="w-2 h-2 rounded-full bg-hq-green shrink-0"></span>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm text-hq-text truncate" x-text="task.command || task.task_id"></div>
                      </div>
                      <span class="text-[10px] text-hq-muted font-mono shrink-0" x-text="task.time_seconds ? task.time_seconds.toFixed(1) + '초' : ''"></span>
                    </div>
                  </template>
                </div>
              </div>

            </div>
          </template>

        </div>
      </div>

      <!-- ═══ Tab: 작업내역 (History) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'history'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 flex flex-col overflow-hidden">
        <div class="px-6 pt-5 pb-3 shrink-0 border-b border-hq-border bg-hq-surface">
          <!-- 통계 카드 (아이콘 + 색상 강화) -->
          <div class="grid grid-cols-4 gap-3 max-w-5xl mx-auto mb-4">
            <!-- 전체 작업 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-accent rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-accent/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-text" x-text="taskHistory.items?.length || 0"></div>
                <div class="text-[10px] text-hq-muted">전체 작업</div>
              </div>
            </div>
            <!-- 완료 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-green rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-green/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-green" x-text="(taskHistory.items || []).filter(t => t.status === 'completed').length"></div>
                <div class="text-[10px] text-hq-muted">완료</div>
              </div>
            </div>
            <!-- 실패 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-red rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-red/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-red" x-text="(taskHistory.items || []).filter(t => t.status === 'failed').length"></div>
                <div class="text-[10px] text-hq-muted">실패</div>
              </div>
            </div>
            <!-- 총 비용 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-cyan rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-cyan/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-cyan" x-text="'$' + ((taskHistory.items || []).reduce((s, t) => s + (t.cost || 0), 0)).toFixed(2)"></div>
                <div class="text-[10px] text-hq-muted">총 비용</div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-3 max-w-5xl mx-auto">
            <!-- Search -->
            <div class="flex-1 relative">
              <svg class="w-4 h-4 text-hq-muted absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              <input type="text" x-model="taskHistory.search" @input.debounce.300ms="loadTaskHistory()"
                     placeholder="작업 검색..."
                     class="w-full bg-hq-bg border border-hq-border rounded-lg pl-9 pr-4 py-2 text-sm text-hq-text placeholder-hq-muted/70 focus:outline-none focus:border-hq-accent/50">
            </div>
            <!-- Status Filter -->
            <select x-model="taskHistory.filterStatus" @change="loadTaskHistory()"
                    class="bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:outline-none min-w-[100px]">
              <option value="all">전체</option>
              <option value="completed">완료</option>
              <option value="failed">실패</option>
              <option value="running">진행중</option>
            </select>
            <!-- Bookmark Filter -->
            <button @click="taskHistory.bookmarkOnly = !taskHistory.bookmarkOnly; loadTaskHistory()"
                    :class="taskHistory.bookmarkOnly ? 'text-hq-yellow border-hq-yellow/30' : 'text-hq-muted border-hq-border'"
                    class="border rounded-lg px-3 py-2 text-sm transition hover:text-hq-yellow">
              &#9733;
            </button>
            <!-- Compare Button -->
            <button x-show="taskHistory.selectedIds.length === 2"
                    @click="openComparison()"
                    class="bg-hq-accent/20 text-hq-accent border border-hq-accent/30 rounded-lg px-3 py-2 text-xs font-semibold hover:bg-hq-accent/30 transition">
              비교하기
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
          <div class="max-w-5xl mx-auto space-y-2">
            <!-- 로딩 표시 -->
            <div x-show="taskHistory.loading" class="flex items-center justify-center py-12">
              <div class="flex items-center gap-3 text-hq-muted">
                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                <span class="text-sm">작업 기록을 불러오는 중...</span>
              </div>
            </div>
            <!-- 에러 표시 -->
            <div x-show="taskHistory.error && !taskHistory.loading" class="mb-3 flex items-center gap-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-4 py-2 text-xs text-hq-red">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              <span x-text="taskHistory.error"></span>
              <button @click="loadTaskHistory()" class="ml-auto underline hover:text-hq-text">다시 시도</button>
            </div>
            <!-- 샘플 데이터 배너 -->
            <div x-show="taskHistory.isSample && !taskHistory.loading" class="mb-3 flex items-center gap-2 bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-4 py-2 text-xs text-hq-yellow">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              미리보기용 샘플 데이터입니다 — 실제 명령을 내리면 진짜 기록으로 대체됩니다
            </div>
            <!-- ═══ 타임라인 뷰 ═══ -->
            <template x-for="(group, gi) in getGroupedTaskHistory()" :key="group.label">
              <div class="mb-4">
                <!-- 날짜 헤더 -->
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-3 h-3 rounded-full bg-hq-accent/30 border-2 border-hq-accent shrink-0"></div>
                  <h3 class="text-xs font-bold text-hq-accent uppercase tracking-wide" x-text="group.label"></h3>
                  <div class="flex-1 h-px bg-hq-border/30"></div>
                  <span class="text-[10px] text-hq-muted" x-text="group.items.length + '건'"></span>
                </div>
                <!-- 타임라인 아이템 -->
                <div class="ml-1.5 border-l-2 border-hq-border/20 pl-5 space-y-1">
                  <template x-for="task in group.items" :key="task.task_id">
                    <div class="relative group">
                      <!-- 타임라인 점 -->
                      <div class="absolute -left-[25px] top-3 w-2.5 h-2.5 rounded-full border-2 border-hq-bg"
                           :class="task.status === 'completed' ? 'bg-hq-green' : task.status === 'failed' ? 'bg-hq-red' : task.status === 'running' ? 'bg-hq-yellow animate-pulse' : 'bg-hq-muted/40'"></div>
                      <!-- 타임라인 카드 -->
                      <div class="bg-hq-panel/80 border rounded-lg overflow-hidden hover:border-hq-accent/30 transition-all"
                           :class="taskHistory.selectedIds.includes(task.task_id) ? 'border-hq-accent/40 ring-1 ring-hq-accent/20' : 'border-hq-border/30'">
                        <div class="px-4 py-2.5">
                          <!-- 한 줄: 시간 + 명령어 + 상태 + 액션 -->
                          <div class="flex items-center gap-2">
                            <span class="text-[10px] text-hq-muted font-mono shrink-0 w-12" x-text="new Date(task.created_at).toLocaleTimeString('ko-KR', {timeZone:'Asia/Seoul', hour:'2-digit', minute:'2-digit'})"></span>
                            <!-- 명령어 (클릭하면 펼치기) -->
                            <div class="flex-1 min-w-0 cursor-pointer"
                                 @click="taskHistory.expandedId = taskHistory.expandedId === task.task_id ? null : task.task_id; if(taskHistory.expandedId === task.task_id) loadTaskDetail(task.task_id)">
                              <div class="text-xs text-hq-text group-hover:text-hq-accent transition truncate" x-text="task.command"></div>
                            </div>
                            <!-- 태그 -->
                            <template x-for="tag in (task.tags || []).slice(0,2)" :key="tag">
                              <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-hq-accent/10 text-hq-accent shrink-0" x-text="tag"></span>
                            </template>
                            <!-- 상태 뱃지 -->
                            <span class="text-[9px] px-1.5 py-0.5 rounded font-medium shrink-0"
                                  :class="task.status === 'completed' ? 'bg-hq-green/15 text-hq-green' : task.status === 'failed' ? 'bg-hq-red/15 text-hq-red' : task.status === 'running' ? 'bg-hq-yellow/15 text-hq-yellow' : 'bg-hq-muted/15 text-hq-muted'"
                                  x-text="task.status === 'completed' ? '완료' : task.status === 'failed' ? '실패' : task.status === 'running' ? '진행중' : '대기'"></span>
                            <!-- 비용 -->
                            <span class="text-[9px] font-mono text-hq-cyan shrink-0" x-text="task.cost ? '$' + task.cost.toFixed(3) : ''"></span>
                            <!-- 액션 (호버 시 표시) -->
                            <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition shrink-0">
                              <button @click.stop="toggleBookmark(task.task_id)"
                                      class="w-5 h-5 rounded flex items-center justify-center text-xs transition"
                                      :class="task.bookmarked ? 'text-hq-yellow' : 'text-hq-muted/40 hover:text-hq-yellow'">&#9733;</button>
                              <button @click.stop="deleteTask(task.task_id)"
                                      class="w-5 h-5 rounded flex items-center justify-center text-[10px] transition text-hq-muted/30 hover:text-hq-red">&times;</button>
                              <input type="checkbox" :value="task.task_id"
                                     @change.stop="toggleTaskSelect(task.task_id)"
                                     :checked="taskHistory.selectedIds.includes(task.task_id)"
                                     class="w-3 h-3 rounded border-hq-border bg-hq-bg text-hq-accent cursor-pointer">
                            </div>
                          </div>
                          <!-- 요약 (접혀있을 때) -->
                          <div x-show="task.summary && taskHistory.expandedId !== task.task_id" class="text-[11px] text-hq-muted truncate mt-1 pl-14" x-text="task.summary"></div>
                          <!-- 펼침 상세 -->
                          <div x-show="taskHistory.expandedId === task.task_id" class="mt-3 pt-3 border-t border-hq-border/20 pl-14">
                            <div class="text-sm markdown-body max-h-96 overflow-y-auto" x-html="renderMarkdown(task._fullResult || '')"></div>
                            <div class="flex items-center gap-3 mt-3">
                              <button x-show="task.correlation_id"
                                      @click.stop="loadReplay(task.correlation_id, task.task_id)"
                                      class="text-xs text-hq-accent hover:text-hq-accent/80 flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                내부 대화 보기
                              </button>
                              <span class="text-[10px] font-mono text-hq-muted" x-text="task.time_seconds ? task.time_seconds + '초 소요' : ''"></span>
                            </div>
                            <div x-show="taskHistory.replayData[task.task_id]" class="mt-3 pl-4 border-l-2 border-hq-accent/20">
                              <div class="text-xs text-hq-muted mb-2 font-semibold">에이전트 간 대화 흐름</div>
                              <div x-html="renderReplayTree(taskHistory.replayData[task.task_id])"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <!-- 더 보기 버튼 -->
            <div x-show="hasMoreTasks()" class="text-center py-4">
              <button @click="loadMoreTasks()"
                      class="text-xs text-hq-accent hover:text-hq-accent/80 bg-hq-accent/10 border border-hq-accent/20 rounded-lg px-6 py-2 transition">
                더 보기 (<span x-text="taskHistory.items.length - taskHistoryPage * taskHistoryPageSize"></span>건 남음)
              </button>
            </div>
            <template x-if="!taskHistory.items || taskHistory.items.length === 0">
              <div class="text-center py-16 relative">
                <!-- 플로팅 일러스트 -->
                <div class="relative inline-block mb-6">
                  <div class="float-anim">
                    <svg class="w-20 h-20 mx-auto text-hq-accent/40" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                      <rect x="2" y="3" width="20" height="14" rx="2"/>
                      <path d="M8 21h8M12 17v4"/>
                      <circle cx="12" cy="10" r="2" fill="currentColor" opacity="0.3"/>
                    </svg>
                  </div>
                  <!-- 장식 도트 -->
                  <div class="absolute -top-2 -right-2 w-3 h-3 rounded-full bg-hq-green/30 float-anim" style="animation-delay:0.5s"></div>
                  <div class="absolute -bottom-1 -left-3 w-2 h-2 rounded-full bg-hq-accent/30 float-anim" style="animation-delay:1s"></div>
                  <div class="absolute top-1/2 -right-5 w-2 h-2 rounded-full bg-hq-yellow/30 float-anim" style="animation-delay:1.5s"></div>
                </div>
                <div class="text-base font-semibold text-hq-text mb-1 font-mono">에이전트 대기 중</div>
                <div class="text-xs text-hq-muted/70 mb-6 font-mono">명령을 내리면 작전 기록이 쌓입니다</div>
                <!-- 빠른 명령 버튼 -->
                <div class="flex flex-wrap justify-center gap-2">
                  <button @click="commandInput='전 부서 현황 보고'; switchTab('command')"
                          class="text-xs bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-full px-4 py-1.5 hover:bg-hq-accent/20 transition">
                    📊 전 부서 현황 보고
                  </button>
                  <button @click="commandInput='CTO 기술 점검 실행'; switchTab('command')"
                          class="text-xs bg-hq-green/10 text-hq-green border border-hq-green/20 rounded-full px-4 py-1.5 hover:bg-hq-green/20 transition">
                    🔧 CTO 기술 점검
                  </button>
                  <button @click="commandInput='CSO 보안 스캔 시작'; switchTab('command')"
                          class="text-xs bg-hq-red/10 text-hq-red border border-hq-red/20 rounded-full px-4 py-1.5 hover:bg-hq-red/20 transition">
                    🛡️ CSO 보안 스캔
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 예약 (Schedule) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'schedule'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-wide">CRON BASE</h1>
              <p class="text-sm text-hq-muted">반복 작업을 자동으로 실행합니다</p>
            </div>
            <button @click="schedules.showModal = true"
                    class="bg-hq-green/20 hover:bg-hq-green/30 text-hq-green border border-hq-green/40 rounded-lg px-4 py-2 text-sm font-semibold font-mono transition">
              + NEW SCHEDULE
            </button>
          </div>

          <div class="space-y-3">
            <template x-for="s in schedules.items" :key="s.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="mb-1.5"><span class="inline-block w-2 h-2 rounded-full mr-1.5 align-middle" :class="s.enabled ? 'bg-emerald-400' : 'bg-gray-500'"></span><span class="text-sm font-semibold align-middle text-hq-text" x-text="s.name"></span></div>
                    <div class="text-[12px] text-hq-muted mb-1" x-text="s.command"></div>
                    <div class="flex items-center gap-3 text-[11px] text-hq-muted/70">
                      <span x-text="'주기: ' + (s.cron_label || s.cron)"></span>
                      <span x-show="s.last_run" x-text="'마지막: ' + s.last_run"></span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button @click="toggleSchedule(s.id)"
                            class="text-xs px-3 py-1.5 rounded-lg border transition"
                            :class="s.enabled ? 'border-hq-yellow/30 text-hq-yellow hover:bg-hq-yellow/10' : 'border-hq-green/30 text-hq-green hover:bg-hq-green/10'"
                            x-text="s.enabled ? '중지' : '시작'"></button>
                    <button @click="confirmDelete = {type:'schedule', id:s.id, name:s.name||s.command||'이름 없음'}"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!schedules.items || schedules.items.length === 0">
              <div class="text-center py-16 text-hq-muted/80 text-sm">예약된 작업이 없습니다. 새 예약을 추가해보세요.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 워크플로우 (Workflow) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'workflow'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-wide">AUTOMATION</h1>
              <p class="text-sm text-hq-muted">여러 단계를 연결해서 자동화 흐름을 만드세요</p>
            </div>
            <button @click="workflows.showEditor = true; workflows.editing = null; workflows.editSteps = [{name:'', command:''}]"
                    class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-semibold transition">
              + 새 워크플로우
            </button>
          </div>

          <div class="space-y-3">
            <template x-for="wf in workflows.items" :key="wf.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap mb-1">
                      <span class="inline-block w-2 h-2 rounded-full bg-violet-400 shrink-0"></span>
                      <span class="text-sm font-semibold text-hq-text" x-text="wf.name"></span>
                      <template x-for="(step, i) in wf.steps" :key="i">
                        <div class="flex items-center gap-1">
                          <span x-show="i > 0" class="text-hq-muted/40 text-[10px]">→</span>
                          <span class="text-[10px] bg-hq-accent/10 text-hq-accent rounded-md px-2 py-0.5 font-medium" x-text="step.name || ('단계 ' + (i+1))"></span>
                        </div>
                      </template>
                    </div>
                    <div class="text-[12px] text-hq-muted ml-3.5" x-text="wf.description || wf.steps.length + '단계'"></div>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <button @click="runWorkflow(wf.id)"
                            :disabled="workflows.runningId === wf.id"
                            class="bg-hq-green/20 text-hq-green border border-hq-green/30 rounded-lg px-3 py-1.5 text-xs font-semibold hover:bg-hq-green/30 transition disabled:opacity-50">
                      <span x-show="workflows.runningId !== wf.id">실행</span>
                      <span x-show="workflows.runningId === wf.id">진행중...</span>
                    </button>
                    <button @click="editWorkflow(wf)"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-border text-hq-muted hover:text-hq-text transition">수정</button>
                    <button @click="confirmDelete = {type:'workflow', id:wf.id, name:wf.name||'이름 없음'}"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!workflows.items || workflows.items.length === 0">
              <div class="text-center py-16 text-hq-muted/80 text-sm">워크플로우가 없습니다. 새 워크플로우를 만들어보세요.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Activity Log View (활동 로그) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'activityLog'" class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-hq-text font-mono tracking-wide">COMM LOG</h2>
            <div class="flex items-center gap-3">
              <select x-model="activityLogFilter"
                      class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text min-w-[120px]">
                <option value="all">전체 에이전트</option>
                <template x-for="(name, id) in agentNames" :key="id">
                  <option :value="id" x-text="name"></option>
                </template>
              </select>
              <span class="text-xs text-hq-muted font-mono" x-text="activityLogs.length + '건'"></span>
            </div>
          </div>
          <div class="text-[11px] text-hq-muted/80 mb-4 bg-hq-surface border border-hq-border/50 rounded-lg px-3 py-2">
            실시간 WebSocket 로그입니다. 페이지 새로고침 시 초기화됩니다.
          </div>
          <div class="space-y-1">
            <template x-for="(log, i) in activityLogs.filter(l => activityLogFilter === 'all' || l.agent_id === activityLogFilter).slice().reverse()" :key="i">
              <div class="flex items-center gap-3 bg-hq-surface border border-hq-border/30 rounded-lg px-4 py-2.5 hover:bg-hq-surface transition">
                <div class="shrink-0 text-right" style="min-width:72px;">
                  <div class="text-[10px] font-mono text-hq-muted/60 leading-tight" x-text="log.timeDate || log.time?.split(' ')[0] || ''"></div>
                  <div class="text-[13px] font-mono font-semibold text-hq-muted leading-tight" x-text="log.timeClock || log.time?.split(' ')[1] || log.time || ''"></div>
                </div>
                <span class="w-7 h-7 rounded-md flex items-center justify-center text-[9px] font-bold shrink-0"
                      :class="getAgentAvatarClass(log.agent_id)" x-text="getAgentInitials(log.agent_id)"></span>
                <span class="text-xs font-medium text-hq-cyan/80 shrink-0 w-24 truncate" x-text="getAgentName(log.agent_id)"></span>
                <span class="text-xs text-hq-text/90 flex-1" x-text="log.action"></span>
              </div>
            </template>
            <template x-if="activityLogs.length === 0">
              <div class="text-center text-hq-muted/80 py-12">아직 활동 로그가 없습니다. 에이전트에 작업을 지시하면 여기에 표시됩니다.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Knowledge View (지식 관리) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'knowledge'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-hidden flex bg-grid">
        <!-- Left: File Tree -->
        <div class="w-64 border-r border-hq-border overflow-y-auto scrollbar-thin p-4 bg-hq-surface shrink-0">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-bold text-hq-text uppercase tracking-wider font-mono">참고 자료</h3>
            <button @click="knowledge.showCreateForm = !knowledge.showCreateForm" class="text-hq-accent text-xs hover:text-hq-accent/80">+ 새 파일</button>
          </div>
          <div x-show="knowledge.showCreateForm" x-transition class="mb-3 space-y-1">
            <input x-model="knowledge.newFolder" placeholder="폴더명" class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
            <input x-model="knowledge.newFileName" placeholder="파일명" class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
            <button @click="createKnowledgeFile()" class="bg-hq-accent text-white rounded-lg px-2 py-1 text-xs w-full">생성</button>
          </div>
          <template x-if="knowledge.loading">
            <div class="text-xs text-hq-muted text-center py-4">로딩 중...</div>
          </template>
          <div class="space-y-0.5">
            <template x-for="file in knowledge.files" :key="file.folder + '/' + file.filename">
              <button @click="selectKnowledgeFile(file)"
                :class="knowledge.selectedFile && knowledge.selectedFile.folder === file.folder && knowledge.selectedFile.filename === file.filename ? 'bg-hq-accent/15 text-hq-accent' : 'text-hq-text/90 hover:bg-hq-surface'"
                class="w-full text-left px-2 py-1.5 rounded-lg text-xs transition truncate">
                <span class="text-hq-muted/80" x-text="file.folder + '/'"></span><span x-text="file.filename"></span>
              </button>
            </template>
          </div>
          <template x-if="!knowledge.loading && knowledge.files.length === 0">
            <div class="text-xs text-hq-muted/80 text-center py-4">파일이 없습니다</div>
          </template>
        </div>
        <!-- Right: Editor/Viewer -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-6">
          <template x-if="knowledge.selectedFile">
            <div class="fade-in-up">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-hq-text" x-text="knowledge.selectedFile.folder + '/' + knowledge.selectedFile.filename"></h3>
                <div class="flex items-center gap-2">
                  <button @click="knowledge.editMode = !knowledge.editMode"
                    :class="knowledge.editMode ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                    class="text-xs px-3 py-1 rounded-lg transition" x-text="knowledge.editMode ? '미리보기' : '편집'"></button>
                  <button x-show="knowledge.editMode" @click="saveKnowledge()" :disabled="knowledge.saving"
                    class="bg-hq-accent hover:bg-blue-600 disabled:opacity-50 text-white rounded-lg px-3 py-1 text-xs">저장</button>
                  <button @click="deleteKnowledge()" class="text-hq-red/60 hover:text-hq-red text-xs px-2 py-1">삭제</button>
                </div>
              </div>
              <div x-show="knowledge.editMode">
                <textarea x-model="knowledge.content" rows="25"
                  class="w-full bg-hq-bg border border-hq-border rounded-xl px-4 py-3 text-sm text-hq-text font-mono resize-y"></textarea>
              </div>
              <div x-show="!knowledge.editMode" class="bg-hq-surface border border-hq-border rounded-xl px-5 py-4">
                <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(knowledge.content)"></div>
              </div>
            </div>
          </template>
          <template x-if="!knowledge.selectedFile">
            <div class="flex items-center justify-center h-full text-hq-muted/80 text-sm">왼쪽에서 파일을 선택하세요</div>
          </template>
        </div>
      </div>

      <!-- ═══ Archive View (아카이브) — 2단 레이아웃 ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'archive'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-hidden p-6 bg-grid">
        <div class="max-w-7xl mx-auto fade-in-up h-full flex flex-col">
          <!-- 상단: 제목 + 검색 -->
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-hq-text flex items-center gap-2 font-mono tracking-wide">
              <svg class="w-5 h-5 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              CLASSIFIED
              <span class="text-xs text-hq-muted font-normal ml-1" x-text="'총 ' + archive.files.length + '건'" x-show="archive.files.length > 0"></span>
            </h2>
            <div class="flex items-center gap-2">
              <input x-model="archive.searchCorrelation" placeholder="작업 ID로 검색"
                class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text w-48" @keydown.enter="searchArchiveByCorrelation()">
              <button @click="searchArchiveByCorrelation()" class="bg-hq-accent text-white rounded-lg px-3 py-1.5 text-xs">검색</button>
            </div>
          </div>

          <!-- 2단 레이아웃 -->
          <div class="flex gap-4 flex-1 min-h-0">
            <!-- 왼쪽: 카드 목록 (1/3) -->
            <div class="w-1/3 min-w-[280px] overflow-y-auto scrollbar-thin pr-1 flex flex-col">
              <!-- 부서 필터 (sticky) -->
              <div class="flex flex-wrap gap-1.5 mb-2 sticky top-0 z-10 pb-1" style="background: rgb(var(--hq-bg));">
                <button @click="archive.filterDivision = 'all'; loadArchive()"
                  :class="archive.filterDivision === 'all' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                  class="px-2.5 py-1 text-[11px] font-semibold rounded-lg transition">전체</button>
                <template x-for="div in ['secretary','leet_master.tech','leet_master.strategy','leet_master.legal','leet_master.marketing','finance.investment']" :key="div">
                  <button @click="archive.filterDivision = div; loadArchive()"
                    :class="archive.filterDivision === div ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                    class="px-2.5 py-1 text-[11px] font-semibold rounded-lg transition" x-text="getDivisionLabel(div)"></button>
                </template>
              </div>
              <!-- 직급 필터 -->
              <div class="flex gap-1.5 mb-3 sticky top-8 z-10 pb-1" style="background: rgb(var(--hq-bg));">
                <template x-for="tier in [{id:'all',label:'전체'},{id:'executive',label:'임원급 (C-Level)'},{id:'specialist',label:'전문가급'},{id:'staff',label:'보좌관급'}]" :key="tier.id">
                  <button @click="archive.filterTier = tier.id"
                    :class="archive.filterTier === tier.id ? 'bg-hq-purple/20 text-hq-purple' : 'text-hq-muted'"
                    class="px-2 py-0.5 text-[10px] font-semibold rounded-md transition" x-text="tier.label"></button>
                </template>
              </div>

              <template x-if="archive.loading">
                <div class="text-center py-8 text-hq-muted">로딩 중...</div>
              </template>

              <!-- 보고서 카드 목록 (세로) -->
              <div class="space-y-2 flex-1" x-show="!archive.loading">
                <template x-for="file in archive.files.filter(f => {
                  if (archive.filterDivision !== 'all' && f.division !== archive.filterDivision) return false;
                  if (archive.filterTier !== 'all') {
                    const tier = getAgentTier(f.agent_id);
                    if (archive.filterTier !== tier) return false;
                  }
                  return true;
                })" :key="file.division + '/' + file.filename">
                  <div @click="readArchiveReport(file)"
                    :class="archive.selectedReport && archive.selectedReport.filename === file.filename ? 'border-hq-accent/50 bg-hq-accent/10 shadow-lg shadow-hq-accent/10' : 'border-hq-border/50 hover:border-hq-accent/30'"
                    class="glass border rounded-xl p-3 cursor-pointer transition-all duration-200">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="status-badge text-[9px]"
                        :class="file.division?.includes('tech') ? 'bg-hq-cyan/10 text-hq-cyan' :
                                file.division?.includes('strategy') ? 'bg-hq-purple/10 text-hq-purple' :
                                file.division?.includes('legal') ? 'bg-hq-red/10 text-hq-red' :
                                file.division?.includes('marketing') ? 'bg-hq-green/10 text-hq-green' :
                                file.division?.includes('finance') ? 'bg-hq-yellow/10 text-hq-yellow' :
                                'bg-hq-accent/10 text-hq-accent'"
                        x-text="getDivisionLabel(file.division)"></span>
                      <span class="text-[9px] px-1.5 py-0.5 rounded font-medium"
                        :class="getAgentTier(file.agent_id) === 'executive' ? 'bg-amber-500/15 text-amber-400' :
                                getAgentTier(file.agent_id) === 'staff' ? 'bg-sky-500/15 text-sky-400' :
                                'bg-hq-muted/10 text-hq-muted'"
                        x-text="getAgentTierLabel(file.agent_id)"></span>
                    </div>
                    <!-- 작성자 + 날짜 -->
                    <div class="text-sm font-medium text-hq-text truncate" x-text="getArchiveAuthor(file.agent_id)"></div>
                    <div class="flex items-center justify-between mt-0.5">
                      <span class="text-[10px] text-hq-muted" x-text="formatArchiveDate(file.created_at)"></span>
                      <span class="text-[10px] text-hq-muted font-mono" x-text="file.size ? (file.size / 1024).toFixed(1) + 'KB' : ''"></span>
                    </div>
                  </div>
                </template>

                <!-- 빈 화면 안내 -->
                <div x-show="archive.files.filter(f => {
                  if (archive.filterDivision !== 'all' && f.division !== archive.filterDivision) return false;
                  if (archive.filterTier !== 'all' && getAgentTier(f.agent_id) !== archive.filterTier) return false;
                  return true;
                }).length === 0"
                     class="flex flex-col items-center justify-center py-12 text-center">
                  <div class="w-16 h-16 rounded-2xl bg-hq-purple/10 flex items-center justify-center mb-3 float-anim">
                    <svg class="w-8 h-8 text-hq-purple/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                  </div>
                  <div class="text-xs font-semibold text-hq-text/60 mb-1">보관된 보고서 없음</div>
                  <div class="text-[11px] text-hq-muted">에이전트 작업 완료 시 자동 저장됩니다</div>
                </div>
              </div>
            </div>

            <!-- 오른쪽: 보고서 내용 (2/3) -->
            <div class="w-2/3 overflow-y-auto scrollbar-thin">
              <template x-if="archive.content">
                <div class="glass border border-hq-border/50 rounded-xl p-6 h-full">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-hq-text" x-text="archive.selectedReport?.filename || ''"></h3>
                    <button @click="copyToClipboard(archive.content)" class="text-xs text-hq-muted hover:text-hq-green transition">복사</button>
                  </div>
                  <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(archive.content)"></div>
                </div>
              </template>
              <template x-if="!archive.content">
                <div class="flex items-center justify-center h-full text-hq-muted">
                  <div class="text-center">
                    <svg class="w-12 h-12 mx-auto mb-3 text-hq-purple/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <div class="text-sm text-hq-muted">왼쪽에서 보고서를 선택하세요</div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ SNS Management View (SNS 관리) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'sns'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">
          <h2 class="text-lg font-bold text-hq-text mb-4 font-mono tracking-wide">COMM STATION</h2>
          <!-- Sub Tabs -->
          <div class="flex gap-2 mb-6">
            <button @click="sns.tab = 'status'; loadSNS()" :class="sns.tab === 'status' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition">연결 상태</button>
            <button @click="sns.tab = 'publish'" :class="sns.tab === 'publish' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition">게시하기</button>
            <button @click="sns.tab = 'queue'; loadSNSQueue()" :class="sns.tab === 'queue' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition">승인 대기열</button>
            <button @click="sns.tab = 'events'; loadSNSEvents()" :class="sns.tab === 'events' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition">이벤트</button>
          </div>
          <template x-if="sns.loading">
            <div class="text-center py-8 text-hq-muted">로딩 중...</div>
          </template>

          <!-- SNS Tab 1: Connection Status -->
          <div x-show="sns.tab === 'status' && !sns.loading">
            <div class="bg-hq-surface border border-hq-border/50 rounded-lg px-4 py-3 mb-4 text-xs text-hq-muted">
              SNS 플랫폼을 연결하려면 각 플랫폼의 API 키가 필요합니다. <code class="bg-hq-bg px-1 rounded text-hq-cyan">.env</code> 파일에 해당 플랫폼의 API 키를 설정한 뒤 "연결하기"를 누르세요.
            </div>
            <div class="grid grid-cols-2 gap-4">
              <template x-for="platform in ['instagram','youtube','linkedin','threads','tistory','naver_blog','naver_cafe','daum_cafe']" :key="platform">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-bold text-hq-text" x-text="getSNSPlatformName(platform)"></span>
                    <span class="status-badge text-[9px]"
                      :class="(sns.oauthStatus?.platforms || {})[platform]?.connected ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-muted/10 text-hq-muted'"
                      x-text="(sns.oauthStatus?.platforms || {})[platform]?.connected ? '연결됨' : '미연결'"></span>
                  </div>
                  <button @click="connectPlatform(platform)"
                    class="w-full bg-hq-accent/10 border border-hq-accent/20 hover:bg-hq-accent/20 text-hq-accent rounded-lg px-3 py-2 text-xs transition"
                    x-text="(sns.oauthStatus?.platforms || {})[platform]?.connected ? '재연결' : '연결하기'"></button>
                </div>
              </template>
            </div>
          </div>

          <!-- SNS Tab 2: Publish -->
          <div x-show="sns.tab === 'publish' && !sns.loading" class="space-y-6">
            <!-- Instagram Photo -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">Instagram 사진 게시</h3>
              <div class="space-y-2">
                <input x-model="sns.igImageUrl" placeholder="이미지 URL" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.igCaption" placeholder="캡션" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <button @click="postInstagramPhoto()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg px-4 py-2 text-sm font-semibold">게시</button>
              </div>
            </div>
            <!-- Instagram Reel -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">Instagram 릴스 게시</h3>
              <div class="space-y-2">
                <input x-model="sns.igVideoUrl" placeholder="비디오 URL" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.igReelCaption" placeholder="캡션" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <button @click="postInstagramReel()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg px-4 py-2 text-sm font-semibold">게시</button>
              </div>
            </div>
            <!-- YouTube Upload -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">YouTube 업로드</h3>
              <div class="space-y-2">
                <input x-model="sns.ytFilePath" placeholder="파일 경로 (서버 내)" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <input x-model="sns.ytTitle" placeholder="제목" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.ytDesc" placeholder="설명" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <div class="flex gap-2">
                  <input x-model="sns.ytTags" placeholder="태그 (쉼표 구분)" class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                  <select x-model="sns.ytPrivacy" class="bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                    <option value="private">비공개</option>
                    <option value="unlisted">일부공개</option>
                    <option value="public">공개</option>
                  </select>
                </div>
                <button @click="postYouTubeVideo()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 text-sm font-semibold">업로드</button>
              </div>
            </div>
          </div>

          <!-- SNS Tab 3: Approval Queue -->
          <div x-show="sns.tab === 'queue' && !sns.loading">
            <div class="flex gap-2 mb-4">
              <template x-for="f in ['all','pending','approved','published','rejected']" :key="f">
                <button @click="sns.queueFilter = f"
                  :class="sns.queueFilter === f ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                  class="px-3 py-1 text-xs rounded-lg transition"
                  x-text="f === 'all' ? '전체' : f === 'pending' ? '대기' : f === 'approved' ? '승인' : f === 'published' ? '발행' : '거절'"></button>
              </template>
            </div>
            <div class="space-y-2">
              <template x-for="item in (Array.isArray(sns.queue) ? sns.queue : sns.queue?.pending_requests || []).filter(q => sns.queueFilter === 'all' || q.status === sns.queueFilter)" :key="item.id || item.request_id">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-bold text-hq-text capitalize" x-text="item.platform || '-'"></span>
                      <span class="status-badge text-[9px]"
                        :class="item.status === 'pending' ? 'bg-hq-yellow/10 text-hq-yellow' : item.status === 'approved' ? 'bg-hq-green/10 text-hq-green' : item.status === 'published' ? 'bg-hq-cyan/10 text-hq-cyan' : 'bg-hq-red/10 text-hq-red'"
                        x-text="item.status === 'pending' ? '대기' : item.status === 'approved' ? '승인' : item.status === 'published' ? '발행' : '거절'"></span>
                    </div>
                    <div class="flex items-center gap-2" x-show="item.status === 'pending'">
                      <button @click="approveSNS(item.id || item.request_id)" class="bg-hq-green/20 text-hq-green rounded-lg px-3 py-1 text-xs hover:bg-hq-green/30">승인</button>
                      <button @click="sns.rejectingId = item.id || item.request_id" class="bg-hq-red/20 text-hq-red rounded-lg px-3 py-1 text-xs hover:bg-hq-red/30">거절</button>
                    </div>
                  </div>
                  <div class="text-xs text-hq-muted" x-text="item.caption || item.title || item.content || '-'"></div>
                  <!-- Reject form -->
                  <div x-show="sns.rejectingId === (item.id || item.request_id)" class="mt-2 flex gap-2">
                    <input x-model="sns.rejectReason" placeholder="거절 사유" class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
                    <button @click="rejectSNS(item.id || item.request_id)" class="bg-hq-red text-white rounded-lg px-3 py-1 text-xs">확인</button>
                  </div>
                </div>
              </template>
              <template x-if="(Array.isArray(sns.queue) ? sns.queue : sns.queue?.pending_requests || []).length === 0">
                <div class="text-center text-hq-muted/80 py-8">대기열이 비어있습니다</div>
              </template>
            </div>
          </div>

          <!-- SNS Tab 4: Events -->
          <div x-show="sns.tab === 'events' && !sns.loading">
            <div class="bg-hq-surface border border-hq-border/50 rounded-lg px-4 py-3 mb-4 text-xs text-hq-muted">
              SNS 이벤트는 연결된 플랫폼에서 발생한 활동 기록입니다. 게시물 발행, 댓글 알림, 팔로워 변동 등의 이벤트가 여기에 자동으로 기록됩니다.
            </div>
            <div class="space-y-2">
              <template x-for="(event, i) in sns.events" :key="i">
                <div class="glass border border-hq-border rounded-xl px-4 py-3">
                  <div class="flex items-center gap-3">
                    <span class="text-[10px] font-mono text-hq-muted/85 shrink-0" x-text="event.time || event.timestamp || '-'"></span>
                    <span class="text-xs font-bold text-hq-cyan capitalize" x-text="event.platform || '-'"></span>
                    <span class="text-xs text-hq-text/90" x-text="event.type || event.event || '-'"></span>
                  </div>
                  <div x-show="event.data" class="text-[11px] text-hq-muted mt-1 truncate" x-text="typeof event.data === 'string' ? event.data : JSON.stringify(event.data || '').substring(0, 150)"></div>
                </div>
              </template>
              <template x-if="sns.events.length === 0">
                <div class="text-center text-hq-muted/80 py-8">이벤트가 없습니다</div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ TRADING OPS (전략실) 탭 ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'trading'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-6xl mx-auto fade-in-up">

          <!-- 헤더 -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-lg font-bold text-hq-text font-mono tracking-wide">TRADING OPS</h2>
              <p class="text-xs text-hq-muted">키움증권 자동매매 시스템 — 모의투자 모드</p>
            </div>
            <div class="flex items-center gap-3">
              <button @click="trading.tab='signals'; generateTradingSignals()" class="bg-hq-purple/20 text-hq-purple hover:bg-hq-purple/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">
                📊 CIO 분석 요청
              </button>
              <button @click="trading.showOrderModal = true" class="bg-hq-green/20 text-hq-green hover:bg-hq-green/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">
                📈 주문 실행
              </button>
              <button @click="trading.showSettingsModal = true; trading.settings = {...(trading.summary.settings || {})}" class="bg-hq-surface border border-hq-border hover:border-hq-accent/30 rounded-lg px-3 py-1.5 text-xs text-hq-muted transition">
                ⚙️ 설정
              </button>
            </div>
          </div>

          <!-- 서브 탭 -->
          <div class="flex gap-2 mb-6">
            <template x-for="tab in [{id:'dashboard',l:'대시보드'},{id:'portfolio',l:'포트폴리오'},{id:'strategies',l:'매매 전략'},{id:'watchlist',l:'관심종목'},{id:'history',l:'거래내역'},{id:'signals',l:'시그널'}]" :key="tab.id">
              <button @click="trading.tab = tab.id" :class="trading.tab === tab.id ? 'bg-hq-accent/20 text-hq-accent border-hq-accent/30' : 'text-hq-muted border-transparent hover:text-hq-text'" class="px-3 py-1.5 text-xs font-semibold rounded-lg border transition" x-text="tab.l"></button>
            </template>
          </div>

          <template x-if="trading.loading">
            <div class="text-center py-12 text-hq-muted">로딩 중...</div>
          </template>

          <!-- ▸ 서브탭 1: 대시보드 -->
          <div x-show="trading.tab === 'dashboard' && !trading.loading">

            <!-- 자동매매 봇 상태 배너 -->
            <div class="glass border rounded-xl p-4 mb-6 flex items-center justify-between"
                 :class="trading.botActive ? 'border-hq-green/40 bg-hq-green/[0.05]' : 'border-hq-border'">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full" :class="trading.botActive ? 'bg-hq-green animate-pulse' : 'bg-hq-muted/30'"></div>
                <div>
                  <span class="text-sm font-bold font-mono" :class="trading.botActive ? 'text-hq-green' : 'text-hq-muted'" x-text="trading.botActive ? 'CIO 자동매매 : 가동 중' : 'CIO 자동매매 : 대기'"></span>
                  <p class="text-[10px] text-hq-muted" x-text="trading.botActive ? 'CIO + 전문가 4명이 매 5분마다 관심종목 분석 중 (장 시간에만 작동)' : 'CIO 자동매매가 꺼져 있습니다. 설정에서 켜세요.'"></p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-[10px] px-2 py-1 rounded-full font-mono" :class="(trading.summary.settings||{}).paper_trading !== false ? 'bg-hq-yellow/10 text-hq-yellow' : 'bg-hq-red/10 text-hq-red'"
                      x-text="(trading.summary.settings||{}).paper_trading !== false ? '모의투자' : '실거래'"></span>
                <span class="text-[10px] px-2 py-1 rounded-full font-mono" :class="(trading.summary.settings||{}).kiwoom_connected ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-muted/10 text-hq-muted'"
                      x-text="(trading.summary.settings||{}).kiwoom_connected ? '키움 연결' : '키움 미연결'"></span>
                <button @click="toggleTradingBot()" class="rounded-lg px-4 py-1.5 text-xs font-bold transition"
                        :class="trading.botActive ? 'bg-hq-red/20 text-hq-red hover:bg-hq-red/30' : 'bg-hq-green/20 text-hq-green hover:bg-hq-green/30'"
                        x-text="trading.botActive ? '중지' : '시작'"></button>
              </div>
            </div>

            <!-- 포트폴리오 요약 카드 4개 -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <!-- 총 자산 -->
              <div class="glass border border-hq-green/20 rounded-xl p-4 hover-glow">
                <div class="text-[10px] text-hq-green/60 uppercase tracking-wider mb-1 font-mono">총 자산</div>
                <div class="text-xl font-bold text-hq-text" x-text="formatKRW((trading.summary.portfolio||{}).total_asset || 0) + '원'"></div>
                <div class="text-[11px] mt-1" :class="tradingPnlColor((trading.summary.portfolio||{}).total_pnl || 0)"
                     x-text="((trading.summary.portfolio||{}).total_pnl >= 0 ? '+' : '') + formatKRW((trading.summary.portfolio||{}).total_pnl || 0) + '원 (' + ((trading.summary.portfolio||{}).pnl_pct || 0) + '%)'"></div>
              </div>
              <!-- 보유 현금 -->
              <div class="glass border border-hq-cyan/20 rounded-xl p-4 hover-glow">
                <div class="text-[10px] text-hq-cyan/60 uppercase tracking-wider mb-1 font-mono">보유 현금</div>
                <div class="text-xl font-bold text-hq-text" x-text="formatKRW((trading.summary.portfolio||{}).cash || 0) + '원'"></div>
                <div class="text-[11px] text-hq-muted mt-1" x-text="(trading.summary.portfolio||{}).holdings_count + '종목 보유'"></div>
              </div>
              <!-- 오늘 거래 -->
              <div class="glass border border-hq-purple/20 rounded-xl p-4 hover-glow">
                <div class="text-[10px] text-hq-purple/60 uppercase tracking-wider mb-1 font-mono">오늘 거래</div>
                <div class="text-xl font-bold text-hq-text" x-text="(trading.summary.today||{}).trades || 0"></div>
                <div class="text-[11px] mt-1" :class="tradingPnlColor((trading.summary.today||{}).pnl || 0)"
                     x-text="'손익 ' + formatKRW((trading.summary.today||{}).pnl || 0) + '원'"></div>
              </div>
              <!-- 활성 전략 -->
              <div class="glass border border-hq-accent/20 rounded-xl p-4 hover-glow">
                <div class="text-[10px] text-hq-accent/60 uppercase tracking-wider mb-1 font-mono">매매 전략</div>
                <div class="text-xl font-bold text-hq-text" x-text="(trading.summary.strategies||{}).active + '/' + (trading.summary.strategies||{}).total"></div>
                <div class="text-[11px] text-hq-muted mt-1" x-text="'관심종목 ' + (trading.summary.watchlist_count || 0) + '개'"></div>
              </div>
            </div>

            <!-- 2단 레이아웃: 보유종목 + 최근거래 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
              <!-- 보유 종목 -->
              <div class="glass border border-hq-green/15 rounded-xl p-4 hover-glow">
                <h3 class="text-sm font-bold text-hq-green/80 mb-3 font-mono">보유 종목</h3>
                <template x-if="(trading.portfolio.holdings||[]).length === 0">
                  <div class="text-center text-hq-muted/70 py-6 text-xs">보유 종목이 없습니다</div>
                </template>
                <div class="space-y-2">
                  <template x-for="h in (trading.portfolio.holdings||[])" :key="h.ticker">
                    <div class="flex items-center justify-between bg-hq-surface rounded-lg px-3 py-2">
                      <div>
                        <div class="text-xs font-bold text-hq-text" x-text="h.name"></div>
                        <div class="text-[10px] text-hq-muted" x-text="h.ticker + ' · ' + h.qty + '주'"></div>
                      </div>
                      <div class="text-right">
                        <div class="text-xs font-bold text-hq-text" x-text="(h.current_price||0).toLocaleString() + '원'"></div>
                        <div class="text-[10px]" :class="tradingPnlColor((h.current_price - h.avg_price) * h.qty)"
                             x-text="(((h.current_price - h.avg_price) / h.avg_price) * 100).toFixed(1) + '%'"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- 최근 거래 -->
              <div class="glass border border-hq-cyan/15 rounded-xl p-4 hover-glow">
                <h3 class="text-sm font-bold text-hq-cyan/80 mb-3 font-mono">최근 거래</h3>
                <template x-if="trading.history.length === 0">
                  <div class="text-center text-hq-muted/70 py-6 text-xs">거래 내역이 없습니다</div>
                </template>
                <div class="space-y-2">
                  <template x-for="t in trading.history.slice(0, 8)" :key="t.id">
                    <div class="flex items-center justify-between bg-hq-surface rounded-lg px-3 py-2">
                      <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" :class="t.action === 'buy' ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-red/10 text-hq-red'"
                              x-text="t.action === 'buy' ? '매수' : '매도'"></span>
                        <div>
                          <div class="text-xs font-bold text-hq-text" x-text="t.name"></div>
                          <div class="text-[10px] text-hq-muted" x-text="t.qty + '주 × ' + (t.price||0).toLocaleString()"></div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-xs text-hq-text" x-text="(t.total||0).toLocaleString() + '원'"></div>
                        <div x-show="t.pnl" class="text-[10px]" :class="tradingPnlColor(t.pnl)" x-text="(t.pnl > 0 ? '+' : '') + (t.pnl||0).toLocaleString() + '원'"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- 시그널 미리보기 -->
            <div class="glass border border-hq-purple/15 rounded-xl p-4 hover-glow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-hq-purple/80 font-mono">최근 CIO 시그널</h3>
                <span class="text-[10px] text-hq-muted" x-text="trading.signals.length + '개 시그널'"></span>
              </div>
              <template x-if="trading.signals.length === 0">
                <div class="text-center text-hq-muted/70 py-6 text-xs">시그널이 없습니다 — "CIO 분석 요청" 버튼을 눌러보세요</div>
              </template>
              <div class="space-y-2">
                <template x-for="s in trading.signals.slice(0, 5)" :key="s.id">
                  <div class="bg-hq-surface rounded-lg px-3 py-2">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-[10px] font-mono text-hq-muted" x-text="(s.date||'').substring(0, 16)"></span>
                      <div class="flex items-center gap-1.5">
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-hq-purple/10 text-hq-purple" x-text="s.strategy || 'ai'"></span>
                        <button @click="deleteSignal(s.id)" class="text-hq-muted/40 hover:text-hq-red text-sm transition" title="삭제">&times;</button>
                      </div>
                    </div>
                    <div class="text-xs text-hq-text/90 line-clamp-2" x-text="s.analysis || s.reason || '-'"></div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- ▸ 서브탭 2: 포트폴리오 -->
          <div x-show="trading.tab === 'portfolio' && !trading.loading">
            <div class="glass border border-hq-border rounded-xl p-5 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-hq-text font-mono">포트폴리오 상세</h3>
                <div class="flex items-center gap-2">
                  <input type="number" x-model.number="trading.initialCashInput" class="bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text w-36 text-right" placeholder="초기자금">
                  <button @click="resetTradingPortfolio()" class="bg-hq-red/10 text-hq-red hover:bg-hq-red/20 rounded-lg px-3 py-1 text-xs font-semibold transition">초기화</button>
                </div>
              </div>

              <!-- 자산 요약 바 -->
              <div class="flex gap-6 mb-4 p-3 bg-hq-surface rounded-lg">
                <div>
                  <div class="text-[10px] text-hq-muted">초기 자금</div>
                  <div class="text-sm font-bold text-hq-text" x-text="(trading.portfolio.initial_cash||50000000).toLocaleString() + '원'"></div>
                </div>
                <div>
                  <div class="text-[10px] text-hq-muted">보유 현금</div>
                  <div class="text-sm font-bold text-hq-cyan" x-text="(trading.portfolio.cash||0).toLocaleString() + '원'"></div>
                </div>
                <div>
                  <div class="text-[10px] text-hq-muted">평가 금액</div>
                  <div class="text-sm font-bold text-hq-text" x-text="formatKRW((trading.summary.portfolio||{}).total_eval || 0) + '원'"></div>
                </div>
                <div>
                  <div class="text-[10px] text-hq-muted">총 손익</div>
                  <div class="text-sm font-bold" :class="tradingPnlColor((trading.summary.portfolio||{}).total_pnl || 0)"
                       x-text="((trading.summary.portfolio||{}).total_pnl >= 0 ? '+' : '') + formatKRW((trading.summary.portfolio||{}).total_pnl || 0) + '원'"></div>
                </div>
              </div>

              <!-- 보유 종목 상세 테이블 -->
              <template x-if="(trading.portfolio.holdings||[]).length === 0">
                <div class="text-center text-hq-muted/70 py-8 text-xs">보유 종목이 없습니다 — "주문 실행"으로 매수해보세요</div>
              </template>
              <template x-if="(trading.portfolio.holdings||[]).length > 0">
                <div class="overflow-x-auto">
                  <table class="w-full text-xs">
                    <thead>
                      <tr class="text-hq-muted text-[10px] uppercase tracking-wider border-b border-hq-border">
                        <th class="py-2 text-left">종목</th>
                        <th class="py-2 text-right">수량</th>
                        <th class="py-2 text-right">평균단가</th>
                        <th class="py-2 text-right">현재가</th>
                        <th class="py-2 text-right">평가금액</th>
                        <th class="py-2 text-right">수익률</th>
                        <th class="py-2 text-right">손익</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="h in trading.portfolio.holdings" :key="h.ticker">
                        <tr class="border-b border-hq-border/30">
                          <td class="py-2">
                            <div class="font-bold text-hq-text" x-text="h.name"></div>
                            <div class="text-[10px] text-hq-muted" x-text="h.ticker"></div>
                          </td>
                          <td class="py-2 text-right text-hq-text" x-text="h.qty + '주'"></td>
                          <td class="py-2 text-right text-hq-text" x-text="(h.avg_price||0).toLocaleString()"></td>
                          <td class="py-2 text-right text-hq-text" x-text="(h.current_price||0).toLocaleString()"></td>
                          <td class="py-2 text-right text-hq-text" x-text="((h.current_price||0) * h.qty).toLocaleString()"></td>
                          <td class="py-2 text-right" :class="tradingPnlColor(h.current_price - h.avg_price)"
                              x-text="(((h.current_price - h.avg_price) / h.avg_price) * 100).toFixed(2) + '%'"></td>
                          <td class="py-2 text-right" :class="tradingPnlColor((h.current_price - h.avg_price) * h.qty)"
                              x-text="((h.current_price - h.avg_price) * h.qty).toLocaleString() + '원'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </template>
            </div>
          </div>

          <!-- ▸ 서브탭 3: 매매 전략 -->
          <div x-show="trading.tab === 'strategies' && !trading.loading">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-bold text-hq-text font-mono">매매 전략</h3>
              <button @click="trading.showStrategyModal = true" class="bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">+ 전략 추가</button>
            </div>
            <template x-if="trading.strategies.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted/70 text-xs mb-3">등록된 전략이 없습니다</p>
                <button @click="trading.showStrategyModal = true" class="bg-hq-accent/20 text-hq-accent rounded-lg px-4 py-2 text-xs font-semibold">첫 번째 전략 만들기</button>
              </div>
            </template>
            <div class="space-y-3">
              <template x-for="s in trading.strategies" :key="s.id">
                <div class="glass border rounded-xl p-4" :class="s.active ? 'border-hq-green/30 bg-hq-green/[0.03]' : 'border-hq-border'">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full" :class="s.active ? 'bg-hq-green' : 'bg-hq-muted/30'"></div>
                      <span class="text-sm font-bold text-hq-text" x-text="s.name"></span>
                      <span class="text-[10px] px-2 py-0.5 rounded-full bg-hq-purple/10 text-hq-purple font-mono" x-text="s.type || s.indicator || '-'"></span>
                    </div>
                    <div class="flex items-center gap-2">
                      <button @click="toggleTradingStrategy(s.id)" class="text-[10px] px-2 py-1 rounded-lg transition"
                              :class="s.active ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-muted/10 text-hq-muted'"
                              x-text="s.active ? '활성' : '비활성'"></button>
                      <button @click="deleteTradingStrategy(s.id)" class="text-[10px] px-2 py-1 rounded-lg bg-hq-red/10 text-hq-red hover:bg-hq-red/20 transition">삭제</button>
                    </div>
                  </div>
                  <div class="grid grid-cols-4 gap-3 text-[10px]">
                    <div><span class="text-hq-muted">매수:</span> <span class="text-hq-green" x-text="s.buy_condition || '-'"></span></div>
                    <div><span class="text-hq-muted">매도:</span> <span class="text-hq-red" x-text="s.sell_condition || '-'"></span></div>
                    <div><span class="text-hq-muted">손절:</span> <span class="text-hq-red" x-text="(s.stop_loss_pct || 0) + '%'"></span></div>
                    <div><span class="text-hq-muted">익절:</span> <span class="text-hq-green" x-text="'+' + (s.take_profit_pct || 0) + '%'"></span></div>
                  </div>
                  <div x-show="(s.target_tickers||[]).length > 0" class="mt-2 flex gap-1 flex-wrap">
                    <template x-for="tk in (s.target_tickers||[])" :key="tk">
                      <span class="text-[9px] px-1.5 py-0.5 rounded bg-hq-cyan/10 text-hq-cyan" x-text="tk"></span>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- ▸ 서브탭 4: 관심종목 -->
          <div x-show="trading.tab === 'watchlist' && !trading.loading">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <h3 class="text-sm font-bold text-hq-text font-mono">관심종목</h3>
                <button @click="loadWatchlistPrices()" :disabled="trading.watchPricesLoading"
                        class="text-[10px] px-2 py-0.5 rounded bg-hq-cyan/10 text-hq-cyan hover:bg-hq-cyan/20 transition disabled:opacity-50">
                  <span x-show="!trading.watchPricesLoading">🔄 시세 새로고침</span>
                  <span x-show="trading.watchPricesLoading">⏳ 조회 중...</span>
                </button>
                <span x-show="trading.watchPricesUpdatedAt" class="text-[9px] text-hq-muted"
                      x-text="'최근 갱신: ' + trading.watchPricesUpdatedAt"></span>
              </div>
              <button @click="trading.showWatchModal = true" class="bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">+ 종목 추가</button>
            </div>
            <template x-if="trading.watchlist.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted/70 text-xs mb-3">관심 종목이 없습니다</p>
                <button @click="trading.showWatchModal = true" class="bg-hq-accent/20 text-hq-accent rounded-lg px-4 py-2 text-xs font-semibold">종목 추가하기</button>
              </div>
            </template>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="w in trading.watchlist" :key="w.ticker">
                <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                  <!-- 헤더: 종목명 + 삭제 -->
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-xs" x-text="(w.market||'KR')==='US' ? '🇺🇸' : '🇰🇷'"></span>
                      <div>
                        <div class="text-sm font-bold text-hq-text" x-text="w.name"></div>
                        <div class="text-[10px] text-hq-muted font-mono" x-text="w.ticker"></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <button @click="openWatchlistChart(w)" class="text-hq-muted/70 hover:text-hq-cyan transition" title="차트 보기">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                      </button>
                      <button @click="removeWatchlistItem(w.ticker)" class="text-hq-muted/70 hover:text-hq-red transition" title="삭제">&times;</button>
                    </div>
                  </div>

                  <!-- 현재가 + 등락률 (실시간 데이터) -->
                  <template x-if="trading.watchPrices[w.ticker] && !trading.watchPrices[w.ticker].error">
                    <div class="mb-2">
                      <div class="flex items-baseline gap-2">
                        <span class="text-lg font-bold"
                              :class="trading.watchPrices[w.ticker].change >= 0 ? 'text-hq-red' : 'text-blue-400'"
                              x-text="(trading.watchPrices[w.ticker].currency === 'USD' ? '$' : '') + (trading.watchPrices[w.ticker].current_price||0).toLocaleString() + (trading.watchPrices[w.ticker].currency === 'KRW' ? '원' : '')"></span>
                        <span class="text-xs font-bold px-1.5 py-0.5 rounded"
                              :class="trading.watchPrices[w.ticker].change >= 0 ? 'bg-hq-red/15 text-hq-red' : 'bg-blue-500/15 text-blue-400'"
                              x-text="(trading.watchPrices[w.ticker].change >= 0 ? '▲' : '▼') + ' ' + Math.abs(trading.watchPrices[w.ticker].change).toLocaleString() + ' (' + (trading.watchPrices[w.ticker].change_pct >= 0 ? '+' : '') + trading.watchPrices[w.ticker].change_pct + '%)'"></span>
                      </div>
                      <div class="flex gap-3 mt-1 text-[9px] text-hq-muted">
                        <span x-text="'고가 ' + (trading.watchPrices[w.ticker].high||0).toLocaleString()"></span>
                        <span x-text="'저가 ' + (trading.watchPrices[w.ticker].low||0).toLocaleString()"></span>
                        <span x-text="'거래량 ' + (trading.watchPrices[w.ticker].volume||0).toLocaleString()"></span>
                      </div>
                    </div>
                  </template>
                  <!-- 가격 데이터 없을 때 -->
                  <template x-if="!trading.watchPrices[w.ticker]">
                    <div class="mb-2 text-[10px] text-hq-muted/60 italic">
                      🔄 시세 새로고침을 눌러 현재가를 확인하세요
                    </div>
                  </template>
                  <!-- 가격 조회 에러 (상세 원인 표시) -->
                  <template x-if="trading.watchPrices[w.ticker] && trading.watchPrices[w.ticker].error">
                    <div class="mb-2 text-[10px] text-hq-yellow/70">
                      ⚠️ 시세 조회 실패: <span x-text="trading.watchPrices[w.ticker].error" class="text-hq-muted"></span>
                    </div>
                  </template>

                  <!-- 목표가 vs 현재가 비교 -->
                  <template x-if="w.target_price && trading.watchPrices[w.ticker] && !trading.watchPrices[w.ticker].error">
                    <div class="mb-2">
                      <div class="flex items-center justify-between text-[10px] mb-1">
                        <span class="text-hq-muted">현재가 → 목표가</span>
                        <span class="font-mono"
                              :class="trading.watchPrices[w.ticker].current_price >= w.target_price ? 'text-hq-green' : 'text-hq-cyan'"
                              x-text="(() => { const cur = trading.watchPrices[w.ticker].current_price; const tgt = w.target_price; const diff = ((tgt - cur) / cur * 100).toFixed(1); return (diff > 0 ? '+' : '') + diff + '%'; })()"></span>
                      </div>
                      <div class="w-full bg-hq-surface rounded-full h-1.5">
                        <div class="h-1.5 rounded-full transition-all"
                             :class="trading.watchPrices[w.ticker].current_price >= w.target_price ? 'bg-hq-green' : 'bg-hq-cyan'"
                             :style="'width:' + Math.min(100, Math.max(5, (trading.watchPrices[w.ticker].current_price / w.target_price * 100))) + '%'"></div>
                      </div>
                      <div class="flex justify-between text-[9px] text-hq-muted mt-0.5">
                        <span x-text="(trading.watchPrices[w.ticker].current_price||0).toLocaleString()"></span>
                        <span x-text="'목표 ' + (w.target_price||0).toLocaleString() + ((w.market||'KR')==='US' ? '$' : '원')"></span>
                      </div>
                    </div>
                  </template>
                  <!-- 목표가만 있고 현재가 없을 때 -->
                  <template x-if="w.target_price && (!trading.watchPrices[w.ticker] || trading.watchPrices[w.ticker].error)">
                    <div class="text-[10px] text-hq-cyan mb-1">
                      <span x-text="(w.alert_type === 'above' ? '↑ ' : '↓ ') + '목표: ' + (w.target_price||0).toLocaleString() + ((w.market||'KR')==='US' ? '$' : '원')"></span>
                    </div>
                  </template>

                  <div x-show="w.notes" class="text-[10px] text-hq-muted/80 truncate mb-1" x-text="w.notes"></div>
                  <div class="flex gap-2 mt-2">
                    <button @click="trading.orderForm = {action:'buy', ticker:w.ticker, name:w.name, qty:0, price:(trading.watchPrices[w.ticker]||{}).current_price||0}; trading.showOrderModal = true;"
                            class="flex-1 bg-hq-green/10 text-hq-green hover:bg-hq-green/20 rounded-lg py-1 text-[10px] font-bold transition">매수</button>
                    <button @click="trading.orderForm = {action:'sell', ticker:w.ticker, name:w.name, qty:0, price:(trading.watchPrices[w.ticker]||{}).current_price||0}; trading.showOrderModal = true;"
                            class="flex-1 bg-hq-red/10 text-hq-red hover:bg-hq-red/20 rounded-lg py-1 text-[10px] font-bold transition">매도</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- ▸ 서브탭 5: 거래내역 -->
          <div x-show="trading.tab === 'history' && !trading.loading">
            <h3 class="text-sm font-bold text-hq-text mb-4 font-mono">거래 내역</h3>
            <template x-if="trading.history.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center text-hq-muted/70 text-xs">거래 내역이 없습니다</div>
            </template>
            <template x-if="trading.history.length > 0">
              <div class="glass border border-hq-border rounded-xl overflow-hidden">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="text-hq-muted text-[10px] uppercase tracking-wider border-b border-hq-border bg-hq-surface">
                      <th class="py-2 px-3 text-left">시간</th>
                      <th class="py-2 px-3 text-left">구분</th>
                      <th class="py-2 px-3 text-left">종목</th>
                      <th class="py-2 px-3 text-right">수량</th>
                      <th class="py-2 px-3 text-right">단가</th>
                      <th class="py-2 px-3 text-right">금액</th>
                      <th class="py-2 px-3 text-right">손익</th>
                      <th class="py-2 px-3 text-left">전략</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="t in trading.history.slice(0, 50)" :key="t.id">
                      <tr class="border-b border-hq-border/30 hover:bg-hq-surface/50">
                        <td class="py-2 px-3 text-hq-muted font-mono text-[10px]" x-text="(t.date||'').substring(5, 16)"></td>
                        <td class="py-2 px-3">
                          <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" :class="t.action === 'buy' ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-red/10 text-hq-red'"
                                x-text="t.action === 'buy' ? '매수' : '매도'"></span>
                        </td>
                        <td class="py-2 px-3 font-bold text-hq-text" x-text="t.name"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="t.qty"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="(t.price||0).toLocaleString()"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="(t.total||0).toLocaleString()"></td>
                        <td class="py-2 px-3 text-right" :class="tradingPnlColor(t.pnl||0)" x-text="t.pnl ? ((t.pnl > 0 ? '+' : '') + (t.pnl).toLocaleString()) : '-'"></td>
                        <td class="py-2 px-3 text-hq-muted" x-text="t.strategy || '-'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>

          <!-- ▸ 서브탭 6: 시그널 (CIO 분석) -->
          <div x-show="trading.tab === 'signals' && !trading.loading">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-sm font-bold text-hq-text font-mono">CIO 매매 시그널</h3>
                <p class="text-[10px] text-hq-muted mt-0.5">CIO(투자분석처장) + 전문가 4명이 분석한 매매 시그널</p>
              </div>
              <button @click="generateTradingSignals()" class="bg-hq-purple/20 text-hq-purple hover:bg-hq-purple/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">📊 CIO 분석 요청</button>
            </div>
            <template x-if="trading.signals.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted/70 text-xs mb-3">시그널이 없습니다</p>
                <p class="text-hq-muted/50 text-[10px]">관심종목을 추가하고 "CIO 분석 요청"을 눌러보세요</p>
              </div>
            </template>
            <div class="space-y-4">
              <template x-for="s in trading.signals" :key="s.id">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <span class="text-[10px] font-mono text-hq-muted" x-text="(s.date||'').substring(0, 16)"></span>
                      <span x-show="s.auto_bot" class="text-[9px] px-1.5 py-0.5 rounded bg-hq-yellow/10 text-hq-yellow">자동봇</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span x-show="s.cost_usd" class="text-[9px] text-hq-muted" x-text="'$' + (s.cost_usd||0).toFixed(4)"></span>
                      <span class="text-[10px] px-2 py-0.5 rounded-full bg-hq-purple/10 text-hq-purple" x-text="s.analyzed_by || s.strategy || '-'"></span>
                      <button @click="deleteSignal(s.id)" class="text-hq-muted/40 hover:text-hq-red text-sm transition ml-1" title="시그널 삭제">&times;</button>
                    </div>
                  </div>

                  <!-- 파싱된 시그널 카드 (매수/매도/관망) -->
                  <template x-if="s.parsed_signals && s.parsed_signals.length > 0">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                      <template x-for="ps in s.parsed_signals" :key="ps.ticker">
                        <div class="bg-hq-bg/50 border border-hq-border/50 rounded-lg p-2.5 flex items-center justify-between">
                          <div class="flex items-center gap-2">
                            <span class="text-xs" x-text="(ps.market||'KR')==='US' ? '🇺🇸' : '🇰🇷'"></span>
                            <div>
                              <div class="text-xs font-bold text-hq-text" x-text="ps.name"></div>
                              <div class="text-[9px] text-hq-muted font-mono" x-text="ps.ticker"></div>
                            </div>
                          </div>
                          <div class="text-right">
                            <div class="text-[10px] font-bold px-2 py-0.5 rounded"
                                 :class="ps.action==='buy' ? 'bg-hq-green/15 text-hq-green' : ps.action==='sell' ? 'bg-hq-red/15 text-hq-red' : 'bg-hq-muted/10 text-hq-muted'"
                                 x-text="ps.action==='buy' ? '매수' : ps.action==='sell' ? '매도' : '관망'"></div>
                            <div class="text-[9px] text-hq-muted mt-0.5" x-text="(ps.confidence||0) + '%'"></div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- CIO 전체 분석 보고서 (접기/펼치기) -->
                  <details class="text-xs">
                    <summary class="text-hq-cyan cursor-pointer hover:text-hq-accent text-[10px] font-semibold">📋 CIO 전체 분석 보고서 보기</summary>
                    <div class="mt-2 text-hq-text/80 whitespace-pre-wrap text-[11px] leading-relaxed max-h-[300px] overflow-y-auto scrollbar-thin bg-hq-bg/30 rounded-lg p-3" x-text="s.analysis || '-'"></div>
                  </details>
                </div>
              </template>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <!-- ═══ Trading Order Modal (주문 실행) ═══ -->
  <div x-show="trading.showOrderModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showOrderModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[420px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text font-mono">주문 실행</h2>
        <button @click="trading.showOrderModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-3">
        <div class="flex gap-2">
          <button @click="trading.orderForm.action = 'buy'" :class="trading.orderForm.action === 'buy' ? 'bg-hq-green text-white' : 'bg-hq-surface text-hq-muted'" class="flex-1 py-2 rounded-lg text-sm font-bold transition">매수</button>
          <button @click="trading.orderForm.action = 'sell'" :class="trading.orderForm.action === 'sell' ? 'bg-hq-red text-white' : 'bg-hq-surface text-hq-muted'" class="flex-1 py-2 rounded-lg text-sm font-bold transition">매도</button>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목코드</label>
          <input x-model="trading.orderForm.ticker" placeholder="예: 005930" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목명</label>
          <input x-model="trading.orderForm.name" placeholder="예: 삼성전자" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">수량 (주)</label>
            <input type="number" x-model.number="trading.orderForm.qty" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">가격 (원)</label>
            <input type="number" x-model.number="trading.orderForm.price" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="bg-hq-surface rounded-lg p-3 text-xs">
          <div class="flex justify-between text-hq-muted">
            <span>주문 총액</span>
            <span class="font-bold text-hq-text" x-text="((trading.orderForm.qty || 0) * (trading.orderForm.price || 0)).toLocaleString() + '원'"></span>
          </div>
        </div>
        <button @click="tradingOrder()" class="w-full py-2.5 rounded-lg text-sm font-bold transition"
                :class="trading.orderForm.action === 'buy' ? 'bg-hq-green text-white hover:bg-hq-green/80' : 'bg-hq-red text-white hover:bg-hq-red/80'"
                x-text="trading.orderForm.action === 'buy' ? '매수 실행' : '매도 실행'"></button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Strategy Modal (전략 추가) ═══ -->
  <div x-show="trading.showStrategyModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showStrategyModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text font-mono">새 매매 전략</h2>
        <button @click="trading.showStrategyModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">전략 이름</label>
          <input x-model="trading.strategyForm.name" placeholder="예: RSI 반등 전략" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">전략 유형</label>
            <select x-model="trading.strategyForm.type" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
              <option value="rsi">RSI</option>
              <option value="macd">MACD</option>
              <option value="golden_cross">골든크로스</option>
              <option value="bollinger">볼린저밴드</option>
              <option value="value">가치투자</option>
              <option value="momentum">모멘텀</option>
              <option value="custom">직접 입력</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">지표</label>
            <input x-model="trading.strategyForm.indicator" placeholder="RSI, MACD 등" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">매수 조건</label>
            <input x-model="trading.strategyForm.buy_condition" placeholder="예: RSI < 30" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">매도 조건</label>
            <input x-model="trading.strategyForm.sell_condition" placeholder="예: RSI > 70" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">대상 종목코드 (쉼표 구분)</label>
          <input x-model="trading.strategyForm.target_tickers" placeholder="005930, 000660, 035420" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">손절 (%)</label>
            <input type="number" x-model.number="trading.strategyForm.stop_loss_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">익절 (%)</label>
            <input type="number" x-model.number="trading.strategyForm.take_profit_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">주문 금액</label>
            <input type="number" x-model.number="trading.strategyForm.order_size" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <button @click="addTradingStrategy()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition">전략 저장</button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Watchlist Modal (관심종목 추가) ═══ -->
  <div x-show="trading.showWatchModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showWatchModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[420px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text font-mono">관심종목 추가</h2>
        <button @click="trading.showWatchModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">시장</label>
          <div class="flex gap-2">
            <button @click="trading.watchForm.market='KR'"
                    :class="trading.watchForm.market==='KR' ? 'bg-hq-accent/30 text-hq-accent border-hq-accent' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">🇰🇷 한국</button>
            <button @click="trading.watchForm.market='US'"
                    :class="trading.watchForm.market==='US' ? 'bg-hq-cyan/30 text-hq-cyan border-hq-cyan' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">🇺🇸 미국</button>
          </div>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목코드</label>
          <input x-model="trading.watchForm.ticker"
                 :placeholder="trading.watchForm.market==='KR' ? '예: 005930' : '예: AAPL, TSLA, NVDA'"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목명</label>
          <input x-model="trading.watchForm.name"
                 :placeholder="trading.watchForm.market==='KR' ? '예: 삼성전자' : '예: Apple'"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1" x-text="trading.watchForm.market==='KR' ? '목표 가격 (원)' : '목표 가격 ($)'"></label>
          <input type="number" x-model.number="trading.watchForm.target_price" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">메모</label>
          <input x-model="trading.watchForm.notes" placeholder="메모 (선택)" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <button @click="addWatchlistItem()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition">관심종목 추가</button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Chart Modal (종목 차트) ═══ -->
  <div x-show="trading.showChartModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showChartModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-bold text-hq-text font-mono" x-text="trading.chartName + ' (' + trading.chartTicker + ')'"></h2>
          <p class="text-[10px] text-hq-muted mt-0.5">최근 30일 일별 종가 차트</p>
        </div>
        <button @click="trading.showChartModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <!-- 차트 영역 -->
      <div class="relative">
        <div x-show="trading.chartLoading" class="flex items-center justify-center py-20">
          <span class="text-hq-muted text-xs">📊 차트 데이터 불러오는 중...</span>
        </div>
        <div x-show="!trading.chartLoading && trading.chartData.length === 0" class="text-center py-20 text-hq-muted/70 text-xs">
          차트 데이터가 없습니다
        </div>
        <div x-show="!trading.chartLoading && trading.chartData.length > 0">
          <!-- SVG 선 그래프 -->
          <div class="bg-hq-bg rounded-xl p-4 border border-hq-border/50">
            <svg viewBox="0 0 560 200" class="w-full" style="height: 200px;">
              <!-- 배경 가로선 (격자) -->
              <line x1="40" y1="10" x2="550" y2="10" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
              <line x1="40" y1="60" x2="550" y2="60" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
              <line x1="40" y1="110" x2="550" y2="110" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
              <line x1="40" y1="160" x2="550" y2="160" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
              <!-- 그래프 영역 (그라데이션) -->
              <defs>
                <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="rgb(var(--hq-cyan))" stop-opacity="0.3"/>
                  <stop offset="100%" stop-color="rgb(var(--hq-cyan))" stop-opacity="0.02"/>
                </linearGradient>
              </defs>
              <!-- 영역 (면) -->
              <polygon :points="getChartAreaPoints()" fill="url(#chartGrad)"/>
              <!-- 선 -->
              <polyline :points="getChartLinePoints()" fill="none" stroke="rgb(var(--hq-cyan))" stroke-width="2" stroke-linejoin="round"/>
              <!-- Y축 라벨 -->
              <text x="36" y="14" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(1)"></text>
              <text x="36" y="64" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0.67)"></text>
              <text x="36" y="114" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0.33)"></text>
              <text x="36" y="164" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0)"></text>
            </svg>
            <!-- X축 날짜 라벨 -->
            <div class="flex justify-between px-10 text-[8px] text-hq-muted -mt-1">
              <span x-text="trading.chartData.length > 0 ? trading.chartData[0].date : ''"></span>
              <span x-text="trading.chartData.length > 10 ? trading.chartData[Math.floor(trading.chartData.length/2)].date : ''"></span>
              <span x-text="trading.chartData.length > 0 ? trading.chartData[trading.chartData.length-1].date : ''"></span>
            </div>
          </div>
          <!-- 가격 요약 -->
          <div class="grid grid-cols-4 gap-2 mt-3">
            <div class="bg-hq-surface rounded-lg p-2 text-center">
              <div class="text-[9px] text-hq-muted">시작가</div>
              <div class="text-xs font-bold text-hq-text" x-text="trading.chartData.length > 0 ? trading.chartData[0].close.toLocaleString() : '-'"></div>
            </div>
            <div class="bg-hq-surface rounded-lg p-2 text-center">
              <div class="text-[9px] text-hq-muted">최고가</div>
              <div class="text-xs font-bold text-hq-red" x-text="trading.chartData.length > 0 ? Math.max(...trading.chartData.map(d=>d.close)).toLocaleString() : '-'"></div>
            </div>
            <div class="bg-hq-surface rounded-lg p-2 text-center">
              <div class="text-[9px] text-hq-muted">최저가</div>
              <div class="text-xs font-bold text-blue-400" x-text="trading.chartData.length > 0 ? Math.min(...trading.chartData.map(d=>d.close)).toLocaleString() : '-'"></div>
            </div>
            <div class="bg-hq-surface rounded-lg p-2 text-center">
              <div class="text-[9px] text-hq-muted">현재가</div>
              <div class="text-xs font-bold text-hq-cyan" x-text="trading.chartData.length > 0 ? trading.chartData[trading.chartData.length-1].close.toLocaleString() : '-'"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Settings Modal (자동매매 설정) ═══ -->
  <div x-show="trading.showSettingsModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showSettingsModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text font-mono">자동매매 설정</h2>
        <button @click="trading.showSettingsModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">종목당 최대 비중 (%)</label>
            <input type="number" x-model.number="trading.settings.max_position_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">일일 최대 거래 횟수</label>
            <input type="number" x-model.number="trading.settings.max_daily_trades" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">일일 최대 손실 (%)</label>
            <input type="number" x-model.number="trading.settings.max_daily_loss_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">기본 주문 금액 (원)</label>
            <input type="number" x-model.number="trading.settings.order_size" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">기본 손절 (%)</label>
            <input type="number" x-model.number="trading.settings.default_stop_loss_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">기본 익절 (%)</label>
            <input type="number" x-model.number="trading.settings.default_take_profit_pct" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="text-[10px] text-hq-muted font-semibold mt-2 mb-1 font-mono">장 시간 (KST 기준)</div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">🇰🇷 한국장 시작</label>
            <input x-model="trading.settings.trading_hours_kr && trading.settings.trading_hours_kr.start" placeholder="09:00" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">🇰🇷 한국장 마감</label>
            <input x-model="trading.settings.trading_hours_kr && trading.settings.trading_hours_kr.end" placeholder="15:20" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">🇺🇸 미국장 시작 (KST)</label>
            <input x-model="trading.settings.trading_hours_us && trading.settings.trading_hours_us.start" placeholder="22:30" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">🇺🇸 미국장 마감 (KST)</label>
            <input x-model="trading.settings.trading_hours_us && trading.settings.trading_hours_us.end" placeholder="05:00" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">자동매매 최소 신뢰도 (%)</label>
            <input type="number" x-model.number="trading.settings.min_confidence" placeholder="70" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 p-3 bg-hq-surface rounded-lg">
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_stop_loss" class="rounded">
            <span>자동 손절</span>
          </label>
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_take_profit" class="rounded">
            <span>자동 익절</span>
          </label>
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.paper_trading" class="rounded">
            <span>모의투자</span>
          </label>
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_execute" class="rounded">
            <span class="text-hq-yellow font-bold">CIO 자동실행</span>
          </label>
        </div>
        <div class="bg-hq-purple/10 border border-hq-purple/20 rounded-lg p-3 text-[10px] text-hq-purple">
          <strong>CIO 자동매매</strong>: 봇이 켜져 있으면 5분마다 CIO + 전문가 4명이 관심종목을 분석합니다. "CIO 자동실행"을 켜면 신뢰도 70% 이상 시그널을 자동 매수/매도합니다.
        </div>
        <div class="bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg p-3 text-[10px] text-hq-yellow">
          키움증권 API 미연결 — 현재 모의투자 모드. 미국 주식은 yfinance 데이터 사용.
        </div>
        <button @click="saveTradingSettings()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition">설정 저장</button>
      </div>
    </div>
  </div>

  <!-- ═══ Schedule Add Modal (예약 추가) ═══ -->
  <div x-show="schedules.showModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="schedules.showModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">새 예약 추가</h2>
        <button @click="schedules.showModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">예약 이름</label>
          <input x-model="schedules.editName" placeholder="예: 일일 보고서"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행할 명령</label>
          <textarea x-model="schedules.editCommand" placeholder="예: 오늘 회사 현황을 보고서로 작성해줘" rows="2"
                    class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none resize-none"></textarea>
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행 주기</label>
          <div class="grid grid-cols-2 gap-2">
            <template x-for="preset in schedules.cronPresets" :key="preset">
              <button @click="schedules.editCronPreset = preset"
                      class="text-xs px-3 py-2 rounded-lg border transition text-left"
                      :class="schedules.editCronPreset === preset
                        ? 'border-hq-accent bg-hq-accent/15 text-hq-accent'
                        : 'border-hq-border text-hq-muted hover:border-hq-border-light'"
                      x-text="preset"></button>
            </template>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="schedules.showModal = false"
                class="px-4 py-2 text-sm text-hq-muted hover:text-hq-text transition">취소</button>
        <button @click="addSchedule()"
                class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition">추가</button>
      </div>
    </div>
  </div>

  <!-- ═══ Universal Delete Confirm Modal (범용 삭제 확인) ═══ -->
  <div x-show="confirmDelete.type" x-transition.opacity
       class="fixed inset-0 z-[60] flex items-center justify-center backdrop-blur-lg"
       :class="darkMode ? 'bg-black/60' : 'bg-black/30'"
       @click.self="confirmDelete = {type:null, id:null, name:null}" style="display: none;">
    <div class="relative overflow-hidden rounded-3xl w-full max-w-[400px] mx-4 text-center" @click.stop
         :style="darkMode
           ? 'background: rgba(18,10,36,0.92); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(239,68,68,0.12), 0 0 120px rgba(139,92,246,0.08), 0 8px 32px rgba(0,0,0,0.4);'
           : 'background: rgba(255,255,255,0.96); border: 1px solid rgba(220,120,160,0.2); box-shadow: 0 0 40px rgba(220,100,140,0.06), 0 8px 32px rgba(0,0,0,0.08);'"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-90 translate-y-4"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0">
      <!-- 오로라 배경 그라데이션 -->
      <div :style="darkMode
        ? 'position:absolute; inset:0; background: linear-gradient(135deg, rgba(239,68,68,0.06) 0%, rgba(139,92,246,0.08) 40%, rgba(236,72,153,0.06) 70%, rgba(239,68,68,0.04) 100%); pointer-events:none;'
        : 'position:absolute; inset:0; background: linear-gradient(135deg, rgba(236,72,153,0.03) 0%, rgba(168,85,247,0.03) 40%, rgba(244,114,182,0.02) 100%); pointer-events:none;'"></div>
      <!-- 상단 분홍 라인 -->
      <div :style="darkMode
        ? 'position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, transparent, rgba(239,68,68,0.6), rgba(236,72,153,0.4), transparent);'
        : 'position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, transparent, rgba(236,72,153,0.4), rgba(168,85,247,0.25), transparent);'"></div>
      <div class="relative px-8 pt-8 pb-7">
        <!-- 큰 아이콘 + 분홍 글로우 -->
        <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"
             :style="darkMode
               ? 'background: radial-gradient(circle, rgba(239,68,68,0.2) 0%, rgba(239,68,68,0.05) 70%); border: 1.5px solid rgba(239,68,68,0.3); box-shadow: 0 0 30px rgba(239,68,68,0.25), 0 0 60px rgba(239,68,68,0.1);'
               : 'background: radial-gradient(circle, rgba(236,72,153,0.1) 0%, rgba(244,114,182,0.03) 70%); border: 1.5px solid rgba(236,72,153,0.2); box-shadow: 0 0 20px rgba(236,72,153,0.08);'">
          <svg class="w-9 h-9" :style="darkMode
            ? 'color: rgb(252,129,129); filter: drop-shadow(0 0 8px rgba(239,68,68,0.4));'
            : 'color: rgb(219,39,119); filter: drop-shadow(0 0 6px rgba(236,72,153,0.2));'" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </div>
        <!-- 제목 (타입에 따라 다르게) -->
        <h3 class="text-lg font-bold text-hq-text mb-3" x-text="confirmDelete.type === 'workflow' ? '워크플로우를 삭제하시겠습니까?' : '예약을 삭제하시겠습니까?'"></h3>
        <!-- 이름 하이라이트 -->
        <div class="mb-6">
          <div class="inline-block rounded-lg px-4 py-2"
               :style="darkMode
                 ? 'background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.15);'
                 : 'background: rgba(236,72,153,0.06); border: 1px solid rgba(236,72,153,0.12);'">
            <span class="text-sm font-semibold"
                  :style="darkMode ? 'color: rgb(252,165,165);' : 'color: rgb(190,24,93);'"
                  x-text="confirmDelete.name || '이름 없음'"></span>
          </div>
          <p class="text-[13px] mt-3" :style="darkMode ? 'color: rgba(200,195,220,0.6);' : 'color: rgba(100,95,120,0.65);'">이 항목은 영구적으로 삭제되며 복구할 수 없습니다.</p>
        </div>
        <!-- 버튼 (전체 너비, 세로 배치) -->
        <div class="space-y-2.5">
          <button @click="if(confirmDelete.type==='schedule') deleteSchedule(confirmDelete.id); else if(confirmDelete.type==='workflow') deleteWorkflow(confirmDelete.id); confirmDelete={type:null,id:null,name:null};"
                  class="w-full py-3 text-sm text-white rounded-2xl font-semibold transition-all duration-200"
                  :style="darkMode
                    ? 'background: linear-gradient(135deg, rgb(220,50,50), rgb(180,30,80)); box-shadow: 0 0 20px rgba(239,68,68,0.3), 0 4px 12px rgba(0,0,0,0.3);'
                    : 'background: linear-gradient(135deg, rgb(219,39,119), rgb(190,24,93)); box-shadow: 0 2px 12px rgba(219,39,119,0.25);'"
                  @mouseover="$el.style.transform='translateY(-1px)'; $el.style.boxShadow=darkMode ? '0 0 35px rgba(239,68,68,0.5), 0 4px 16px rgba(0,0,0,0.4)' : '0 4px 20px rgba(219,39,119,0.35)'"
                  @mouseout="$el.style.transform='translateY(0)'; $el.style.boxShadow=darkMode ? '0 0 20px rgba(239,68,68,0.3), 0 4px 12px rgba(0,0,0,0.3)' : '0 2px 12px rgba(219,39,119,0.25)'">삭제하기</button>
          <button @click="confirmDelete = {type:null, id:null, name:null}"
                  class="w-full py-3 text-sm rounded-2xl transition-all duration-200 font-medium"
                  :style="darkMode
                    ? 'color: rgba(200,195,220,0.8); border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04);'
                    : 'color: rgba(85,80,108,0.7); border: 1px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.02);'"
                  @mouseover="$el.style.background=darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)'; $el.style.borderColor=darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'"
                  @mouseout="$el.style.background=darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.02)'; $el.style.borderColor=darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Agent Memory Modal (에이전트 기억) ═══ -->
  <div x-show="memoryModal.visible" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="memoryModal.visible = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[80vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">
          <span x-text="memoryModal.agentName"></span> 기억 관리
        </h2>
        <button @click="memoryModal.visible = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <!-- 기억 추가 -->
      <div class="bg-hq-bg rounded-xl p-4 mb-4">
        <div class="text-xs text-hq-muted font-semibold mb-2">새 기억 추가</div>
        <div class="flex gap-2 mb-2">
          <input x-model="memoryModal.newKey" placeholder="제목 (예: 선호하는 보고서 형식)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div class="flex gap-2">
          <input x-model="memoryModal.newValue" placeholder="내용 (예: 표와 그래프를 포함한 형식 선호)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text focus:border-hq-accent outline-none"
                 @keydown.enter="addMemory()">
          <button @click="addMemory()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-1.5 text-xs font-semibold transition">추가</button>
        </div>
      </div>

      <!-- 기억 목록 -->
      <div class="space-y-2">
        <template x-for="mem in memoryModal.items" :key="mem.memory_id">
          <div class="flex items-start gap-3 bg-hq-bg rounded-lg p-3 group">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-semibold text-hq-accent" x-text="mem.key"></span>
                <span class="text-[10px] px-1.5 py-0.5 rounded"
                      :class="mem.source === 'auto' ? 'bg-hq-purple/15 text-hq-purple' : 'bg-hq-green/15 text-hq-green'"
                      x-text="mem.source === 'auto' ? '자동' : '수동'"></span>
              </div>
              <div class="text-xs text-hq-muted" x-text="mem.value"></div>
            </div>
            <button @click="deleteMemory(mem.memory_id)"
                    class="text-hq-red/50 hover:text-hq-red text-sm opacity-0 group-hover:opacity-100 transition">&times;</button>
          </div>
        </template>
        <template x-if="!memoryModal.items || memoryModal.items.length === 0">
          <div class="text-center py-8 text-hq-muted/80 text-sm">아직 저장된 기억이 없습니다.</div>
        </template>
      </div>
    </div>
  </div>

  <!-- ═══ Workflow Editor Modal (워크플로우 편집기) ═══ -->
  <div x-show="workflows.showEditor" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="workflows.showEditor = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[80vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text" x-text="workflows.editing ? '워크플로우 수정' : '새 워크플로우'"></h2>
        <button @click="workflows.showEditor = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">이름</label>
          <input x-model="workflows.editName" placeholder="워크플로우 이름"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">설명</label>
          <input x-model="workflows.editDesc" placeholder="워크플로우 설명 (선택)"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>

        <!-- Steps -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="text-xs text-hq-muted font-semibold">단계 목록</label>
            <button @click="workflows.editSteps.push({name:'', command:''})"
                    class="text-[10px] px-2 py-1 rounded border border-hq-accent/30 text-hq-accent hover:bg-hq-accent/10 transition">+ 단계 추가</button>
          </div>
          <div class="space-y-2">
            <template x-for="(step, idx) in workflows.editSteps" :key="idx">
              <div class="bg-hq-bg rounded-lg p-3">
                <div class="flex items-start gap-2">
                  <div class="text-xs text-hq-muted mt-1.5 font-mono w-6 shrink-0" x-text="(idx+1) + '.'"></div>
                  <div class="flex-1 space-y-1.5">
                    <input x-model="step.name" :placeholder="'단계 ' + (idx+1) + ' 이름'"
                           class="w-full bg-hq-panel border border-hq-border rounded px-2 py-1 text-xs text-hq-text focus:border-hq-accent outline-none">
                    <textarea x-model="step.command" :placeholder="idx === 0 ? '이 단계에서 AI에게 시킬 작업을 입력하세요' : '이 단계에서 AI에게 시킬 작업 (아래 버튼으로 이전 결과를 가져올 수 있어요)'" rows="2"
                              :id="'wf-step-cmd-' + idx"
                              class="w-full bg-hq-panel border border-hq-border rounded px-2 py-1 text-xs text-hq-text focus:border-hq-accent outline-none resize-none"></textarea>
                    <!-- 이전 결과 삽입 버튼 (2단계부터만 표시) -->
                    <button x-show="idx > 0"
                            @click="(() => { const ta = document.getElementById('wf-step-cmd-' + idx); const pos = ta.selectionStart || step.command.length; step.command = step.command.slice(0, pos) + '{prev_result}' + step.command.slice(pos); $nextTick(() => { ta.focus(); ta.setSelectionRange(pos + 13, pos + 13); }); })()"
                            class="inline-flex items-center gap-1 text-[10px] px-2 py-0.5 rounded border border-hq-cyan/30 text-hq-cyan hover:bg-hq-cyan/10 transition">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                      이전 결과 삽입
                    </button>
                  </div>
                  <button @click="workflows.editSteps.splice(idx, 1)"
                          class="text-hq-red/50 hover:text-hq-red text-sm mt-1"
                          x-show="workflows.editSteps.length > 1">&times;</button>
                </div>
                <!-- 단계 간 화살표 -->
                <div x-show="idx < workflows.editSteps.length - 1" class="flex justify-center mt-2 text-hq-muted/30">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                </div>
              </div>
            </template>
          </div>
          <div class="text-[10px] text-hq-muted/80 mt-2 bg-hq-panel/50 rounded-lg px-3 py-1.5">
            💡 2단계부터 '이전 결과 삽입' 버튼으로 앞 단계의 AI 답변을 가져올 수 있어요
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="workflows.showEditor = false"
                class="px-4 py-2 text-sm text-hq-muted hover:text-hq-text transition">취소</button>
        <button @click="saveWorkflow()"
                class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition">저장</button>
      </div>
    </div>
  </div>

  <!-- ═══ Login Overlay (로그인 오버레이) ═══ -->
  <div x-show="auth.showLogin" x-transition.opacity
       class="fixed inset-0 z-[60] flex items-center justify-center bg-hq-bg/95"
       style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[400px] mx-4 p-8">
      <div class="text-center mb-6">
        <div class="text-2xl font-bold gradient-text mb-2 font-mono tracking-wide">CYBER COMMAND</div>
        <p class="text-sm text-hq-muted font-mono">[ ACCESS RESTRICTED ] 인증이 필요합니다</p>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">비밀번호</label>
          <input x-model="auth.loginPass" type="password" placeholder="비밀번호"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2.5 text-sm text-hq-text focus:border-hq-accent outline-none"
                 @keydown.enter="doLogin()">
          <p class="text-[10px] text-hq-muted/60 mt-1">기본 비밀번호: corthex2026</p>
        </div>
      </div>

      <div x-show="auth.loginError" class="mt-3 text-xs text-hq-red" x-text="auth.loginError"></div>

      <div class="flex flex-col gap-2 mt-6">
        <button @click="doLogin()"
                class="bg-hq-green/20 hover:bg-hq-green/30 text-hq-green border border-hq-green/40 rounded-lg px-5 py-2.5 text-sm font-semibold font-mono tracking-wide transition w-full">ACCESS</button>
      </div>
    </div>
  </div>

  <!-- ═══ Quality Gate Settings Modal ═══ -->
  <div x-show="showQualitySettings" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showQualitySettings = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[720px] mx-4 max-h-[85vh] flex flex-col"
         @click.stop>

      <!-- Sticky Header -->
      <div class="flex items-center justify-between p-5 pb-4 border-b border-hq-border/50 shrink-0">
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white text-xs font-bold shadow-lg shadow-blue-500/20">QA</span>
          <div>
            <h2 class="text-base font-bold text-hq-text">품질 검수 설정</h2>
            <p class="text-[11px] text-hq-muted/70">매니저급 에이전트가 보고서를 검수할 때 적용되는 기준</p>
          </div>
        </div>
        <button @click="showQualitySettings = false" class="text-hq-muted hover:text-hq-text w-8 h-8 flex items-center justify-center rounded-lg hover:bg-hq-surface transition">&times;</button>
      </div>

      <!-- Scrollable Content -->
      <div class="overflow-y-auto flex-1 p-5 space-y-5">

        <!-- Section 1: Review Model -->
        <div class="p-4 bg-hq-bg rounded-xl border border-hq-border/30">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">🤖</span>
            <h3 class="text-sm font-semibold text-hq-text">검수 모델</h3>
          </div>
          <p class="text-xs text-hq-muted/70 mb-3">모든 품질 검수에 사용할 AI 모델을 선택하세요.</p>
          <div class="flex items-center gap-3">
            <select x-model="selectedReviewModel"
                    class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent transition">
              <template x-for="[provLabel, models] in Object.entries(getModelsByProvider())" :key="provLabel">
                <optgroup :label="provLabel">
                  <template x-for="m in models" :key="m.name">
                    <option :value="m.name"
                            x-text="getModelDisplayName(m.name) + ' ($' + (m.cost_input ?? 0) + '/' + (m.cost_output ?? 0) + ')'">
                    </option>
                  </template>
                </optgroup>
              </template>
            </select>
            <button @click="saveReviewModel()"
                    class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm whitespace-nowrap transition">
              저장
            </button>
          </div>
        </div>

        <!-- Section 2: Common Rubric -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">📋</span>
            <h3 class="text-sm font-semibold text-hq-text">공통 검수 기준</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-muted/10 text-hq-muted">기본값</span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-3">부서별 기준이 없는 부서에 기본 적용되는 검수 기준입니다.</p>

          <div class="p-4 bg-hq-bg rounded-xl border border-hq-border/30 hover:border-hq-border/60 transition cursor-pointer"
               @click="editingRubric === 'default' ? (editingRubric = null) : startEditRubric('default')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-hq-text">기본 (전체 공통)</span>
                <span x-show="qualityRules.rubrics && qualityRules.rubrics['default']"
                      class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-green/10 text-hq-green font-medium">설정됨</span>
              </div>
              <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="editingRubric === 'default' ? 'rotate-90' : ''">&#9654;</span>
            </div>
            <template x-if="qualityRules.rubrics && qualityRules.rubrics['default'] && editingRubric !== 'default'">
              <p class="text-xs text-hq-muted/60 mt-2 line-clamp-2"
                 x-text="qualityRules.rubrics['default'].prompt.substring(0, 120) + '...'"></p>
            </template>
          </div>
          <!-- Inline Editor -->
          <div x-show="editingRubric === 'default'" x-collapse class="mt-2 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
            <div class="mb-3">
              <label class="text-xs text-hq-muted mb-1 block">기준 이름</label>
              <input x-model="rubricEditName" class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text" placeholder="예: 기본 검수 기준">
            </div>
            <div class="mb-3">
              <label class="text-xs text-hq-muted mb-1 block">검수 기준</label>
              <textarea x-model="rubricEditPrompt" rows="5" class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-[13px] text-hq-text resize-y" style="font-family:'Pretendard Variable','Pretendard',sans-serif; line-height:1.8; letter-spacing:0.01em;" placeholder="다음 기준으로 검수하세요:&#10;1. ..."></textarea>
            </div>
            <div class="flex items-center gap-2">
              <button @click.stop="saveRubric()" class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-1.5 text-xs font-medium transition">저장</button>
              <button @click.stop="editingRubric = null" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-4 py-1.5 text-xs transition">취소</button>
            </div>
          </div>
        </div>

        <!-- Section 3: Department-Specific Rubrics -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">🏢</span>
            <h3 class="text-sm font-semibold text-hq-text">부서별 검수 기준</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-accent/10 text-hq-accent"
                  x-text="(qualityRules.known_divisions || []).length + '개 부서'"></span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-3">각 부서의 카드를 클릭하면 전용 검수 기준을 설정할 수 있습니다.</p>

          <div class="grid grid-cols-1 gap-2">
            <template x-for="div in (qualityRules.known_divisions || [])" :key="div">
              <div>
                <!-- Department Card -->
                <div class="p-3.5 bg-hq-bg rounded-xl border border-hq-border/30 hover:border-hq-border/60 transition cursor-pointer group"
                     :class="editingRubric === div ? 'border-hq-accent/40' : ''"
                     @click="editingRubric === div ? (editingRubric = null) : startEditRubric(div)">
                  <div class="flex items-center gap-3">
                    <span class="text-lg w-8 h-8 flex items-center justify-center rounded-lg shrink-0"
                          :class="'bg-gradient-to-br ' + getDivisionStyle(div).bg"
                          x-text="getDivisionStyle(div).icon"></span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="text-sm text-hq-text font-medium" x-text="getDivisionLabel(div)"></span>
                        <span x-show="qualityRules.rubrics && qualityRules.rubrics[div]"
                              class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-green/10 text-hq-green font-medium shrink-0">설정됨</span>
                        <span x-show="!qualityRules.rubrics || !qualityRules.rubrics[div]"
                              class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-muted/10 text-hq-muted shrink-0">공통 적용</span>
                      </div>
                      <template x-if="qualityRules.rubrics && qualityRules.rubrics[div] && editingRubric !== div">
                        <p class="text-xs text-hq-muted/60 mt-0.5 truncate"
                           x-text="qualityRules.rubrics[div].prompt.substring(0, 80) + '...'"></p>
                      </template>
                      <template x-if="(!qualityRules.rubrics || !qualityRules.rubrics[div]) && editingRubric !== div">
                        <p class="text-xs text-hq-muted/40 mt-0.5">클릭하여 이 부서만의 기준을 설정하세요</p>
                      </template>
                    </div>
                    <span class="text-[10px] text-hq-muted/50 group-hover:text-hq-muted transition-transform duration-200 shrink-0" :class="editingRubric === div ? 'rotate-90' : ''">&#9654;</span>
                  </div>
                </div>
                <!-- Inline Editor -->
                <div x-show="editingRubric === div" x-collapse class="mt-1 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
                  <div class="mb-3">
                    <label class="text-xs text-hq-muted mb-1 block">기준 이름</label>
                    <input x-model="rubricEditName" class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text" placeholder="예: 기술개발팀 검수 기준">
                  </div>
                  <div class="mb-3">
                    <label class="text-xs text-hq-muted mb-1 block">검수 기준</label>
                    <textarea x-model="rubricEditPrompt" rows="5" class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-[13px] text-hq-text resize-y" style="font-family:'Pretendard Variable','Pretendard',sans-serif; line-height:1.8; letter-spacing:0.01em;" placeholder="다음 기준으로 검수하세요:&#10;1. ..."></textarea>
                  </div>
                  <div class="flex items-center gap-2">
                    <button @click.stop="saveRubric()" class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-1.5 text-xs font-medium transition">저장</button>
                    <button @click.stop="editingRubric = null" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-4 py-1.5 text-xs transition">취소</button>
                    <button x-show="qualityRules.rubrics && qualityRules.rubrics[div]"
                            @click.stop="deleteRubric(div)"
                            class="text-hq-red/60 hover:text-hq-red text-xs ml-auto flex items-center gap-1 transition"
                            title="이 부서의 검수 기준을 삭제하고 공통 기준으로 되돌립니다">
                      ↩ 공통 기준으로 초기화
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

      </div>

      <!-- Sticky Footer -->
      <div class="p-3 border-t border-hq-border/30 text-center shrink-0">
        <span x-show="qualitySaveStatus === 'saving'" class="text-xs text-hq-yellow animate-pulse">저장 중...</span>
        <span x-show="qualitySaveStatus === 'saved'" class="text-xs text-hq-green">저장 완료</span>
        <span x-show="qualitySaveStatus === 'error'" class="text-xs text-hq-red">저장 실패</span>
        <span x-show="!qualitySaveStatus" class="text-xs text-hq-muted/40">변경사항은 서버에 자동 동기화됩니다</span>
      </div>
    </div>
  </div>

  <!-- ═══ Agent Config Modal (에이전트 설정) ═══ -->
  <div x-show="showAgentConfig" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showAgentConfig = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[85vh] overflow-y-auto p-6"
         @click.stop>

      <!-- Loading -->
      <div x-show="agentConfigLoading" class="flex items-center justify-center py-12">
        <svg class="animate-spin w-6 h-6 text-hq-accent" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
        </svg>
      </div>

      <!-- Content -->
      <div x-show="!agentConfigLoading && agentConfigData">
        <!-- Header -->
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold"
                 :class="getAgentAvatarClass(agentConfigId)"
                 x-text="getAgentInitials(agentConfigId)"></div>
            <div>
              <h2 class="text-lg font-bold text-hq-text" x-text="agentConfigData?.name_ko || agentConfigData?.name || agentConfigId"></h2>
              <div class="text-xs text-hq-muted" x-text="(agentConfigData?.role || '') + ' · ' + (agentConfigData?.division || '')"></div>
            </div>
          </div>
          <button @click="showAgentConfig = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1 mb-5 bg-hq-bg rounded-xl p-1">
          <button @click="agentConfigTab = 'info'"
                  :class="agentConfigTab === 'info' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-colors">기본 정보</button>
          <button @click="agentConfigTab = 'model'"
                  :class="agentConfigTab === 'model' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-colors">모델 설정</button>
          <button @click="agentConfigTab = 'reasoning'"
                  :class="agentConfigTab === 'reasoning' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-colors">추론 정도</button>
          <button @click="agentConfigTab = 'soul'"
                  :class="agentConfigTab === 'soul' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-colors">소울</button>
          <button @click="agentConfigTab = 'skills'"
                  :class="agentConfigTab === 'skills' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-colors">스킬</button>
        </div>

        <!-- Tab: Info -->
        <div x-show="agentConfigTab === 'info'">
          <div class="bg-hq-bg rounded-xl p-4 space-y-3">
            <div class="flex justify-between"><span class="text-sm text-hq-muted">에이전트 ID</span><span class="text-xs font-mono text-hq-text" x-text="agentConfigId"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">이름 (한국어)</span><span class="text-sm text-hq-text" x-text="agentConfigData?.name_ko || '-'"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">역할</span><span class="text-sm text-hq-text" x-text="agentConfigData?.role || '-'"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">부서</span><span class="text-sm text-hq-text" x-text="agentConfigData?.division || '-'"></span></div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-hq-muted">현재 모델</span>
              <span class="text-xs font-mono text-hq-cyan font-semibold"
                    x-text="getModelDisplayName(agentConfigData?.model_name) + (agentConfigData?.reasoning_effort ? ' (' + agentConfigData.reasoning_effort + ')' : '')"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-hq-muted">추론 정도</span>
              <span class="text-sm font-semibold"
                    :class="({'none':'text-hq-muted','minimal':'text-hq-cyan','low':'text-hq-green','medium':'text-hq-yellow','high':'text-hq-purple','xhigh':'text-hq-red'})[agentConfigData?.reasoning_effort] || 'text-hq-text'"
                    x-text="agentConfigData?.reasoning_effort ? (({'none':'⛔ none','minimal':'💨 minimal','low':'⚡ low','medium':'🧠 medium','high':'🔬 high','xhigh':'🔥 xhigh'})[agentConfigData.reasoning_effort] || agentConfigData.reasoning_effort) : 'default'"></span>
            </div>
            <div x-show="agentConfigData?.capabilities?.length > 0">
              <span class="text-sm text-hq-muted block mb-1">능력치</span>
              <div class="flex flex-wrap gap-1">
                <template x-for="cap in (agentConfigData?.capabilities || [])" :key="cap">
                  <span class="text-[10px] bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-md px-2 py-0.5" x-text="cap"></span>
                </template>
              </div>
            </div>
            <!-- 상관 -->
            <div x-show="agentConfigData?.superior_id">
              <span class="text-sm text-hq-muted block mb-1">상관</span>
              <div @click="openAgentConfig(agentConfigData?.superior_id)" class="inline-flex items-center gap-2 bg-hq-purple/10 border border-hq-purple/20 rounded-lg px-3 py-1.5 cursor-pointer hover:bg-hq-purple/20 transition">
                <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold" :class="getAgentAvatarClass(agentConfigData?.superior_id)" x-text="getAgentInitials(agentConfigData?.superior_id)"></div>
                <span class="text-xs text-hq-text" x-text="getAgentName(agentConfigData?.superior_id)"></span>
              </div>
            </div>
            <!-- 부하직원 -->
            <div x-show="agentConfigData?.subordinate_ids?.length > 0">
              <span class="text-sm text-hq-muted block mb-1">부하직원</span>
              <div class="flex flex-wrap gap-1.5">
                <template x-for="subId in (agentConfigData?.subordinate_ids || [])" :key="subId">
                  <div @click="openAgentConfig(subId)" class="inline-flex items-center gap-2 bg-hq-cyan/10 border border-hq-cyan/20 rounded-lg px-3 py-1.5 cursor-pointer hover:bg-hq-cyan/20 transition">
                    <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold" :class="getAgentAvatarClass(subId)" x-text="getAgentInitials(subId)"></div>
                    <span class="text-xs text-hq-text" x-text="getAgentName(subId)"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Model -->
        <div x-show="agentConfigTab === 'model'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">AI 모델 선택</label>
            <p class="text-[11px] text-hq-muted/70 mb-3">이 에이전트가 사용할 AI 모델을 변경합니다. 변경 즉시 적용됩니다.</p>
            <select x-model="agentModelSelection"
                    class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2.5 text-sm text-hq-text mb-3">
              <template x-for="[provLabel, models] in Object.entries(getModelsByProvider())" :key="provLabel">
                <optgroup :label="provLabel">
                  <template x-for="m in models" :key="m.name">
                    <option :value="m.name" x-text="getModelDisplayName(m.name) + ' ($' + (m.cost_input ?? 0) + '/' + (m.cost_output ?? 0) + ')'"></option>
                  </template>
                </optgroup>
              </template>
            </select>
            <div class="flex items-center gap-2">
              <button @click="saveAgentModel()"
                      class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm transition-colors">모델 변경</button>
              <span class="text-xs text-hq-muted" x-show="agentModelSelection !== agentConfigData?.model_name">
                현재: <span class="font-mono text-hq-cyan" x-text="agentConfigData?.model_name"></span>
              </span>
            </div>
          </div>
        </div>

        <!-- Tab: Reasoning -->
        <div x-show="agentConfigTab === 'reasoning'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">추론 정도 (Reasoning Effort)</label>
            <p class="text-[11px] text-hq-muted/70 mb-4">에이전트가 답변할 때 얼마나 깊이 생각할지 결정합니다. 높을수록 정확하지만 느리고 비용이 더 듭니다.</p>

            <!-- 추론 미지원 모델 -->
            <template x-if="agentReasoningOptions.length === 0">
              <div class="text-center py-6">
                <div class="text-3xl mb-2">🚫</div>
                <p class="text-sm text-hq-muted">이 모델은 추론 정도 설정을 지원하지 않습니다.</p>
                <p class="text-[11px] text-hq-muted/85 mt-1">추론을 지원하는 모델로 변경하면 설정할 수 있습니다.</p>
              </div>
            </template>

            <!-- 추론 지원 모델: 동적 버튼 -->
            <template x-if="agentReasoningOptions.length > 0">
              <div>
                <div class="grid gap-3 mb-3" :class="agentReasoningOptions.length <= 3 ? 'grid-cols-3' : (agentReasoningOptions.length <= 4 ? 'grid-cols-2 sm:grid-cols-4' : 'grid-cols-2 sm:grid-cols-3')">
                  <template x-for="level in agentReasoningOptions" :key="level">
                    <button @click="agentReasoningSelection = level"
                            :class="agentReasoningSelection === level
                              ? (level === 'none' ? 'border-hq-muted bg-hq-muted/10 text-hq-muted'
                                : level === 'minimal' ? 'border-hq-cyan bg-hq-cyan/10 text-hq-cyan'
                                : level === 'low' ? 'border-hq-green bg-hq-green/10 text-hq-green'
                                : level === 'medium' ? 'border-hq-yellow bg-hq-yellow/10 text-hq-yellow'
                                : level === 'high' ? 'border-hq-purple bg-hq-purple/10 text-hq-purple'
                                : 'border-hq-red bg-hq-red/10 text-hq-red')
                              : 'border-hq-border text-hq-muted hover:text-hq-text'"
                            class="border-2 rounded-xl p-4 text-center transition-all">
                      <div class="text-2xl mb-1" x-text="({none:'⛔',minimal:'💨',low:'⚡',medium:'🧠',high:'🔬',xhigh:'🔥'})[level] || '❓'"></div>
                      <div class="text-sm font-bold font-mono" x-text="level"></div>
                      <div class="text-[10px] mt-1" x-text="({none:'추론 비활성화',minimal:'아주 빠름',low:'빠르고 저렴',medium:'균형잡힌 성능',high:'정확하지만 느림',xhigh:'최대 깊이'})[level] || ''"></div>
                    </button>
                  </template>
                </div>
                <div class="flex items-center gap-2">
                  <button @click="saveAgentReasoning()"
                          class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm transition-colors">추론 정도 변경</button>
                  <button @click="agentReasoningSelection = ''; saveAgentReasoning()"
                          class="border border-hq-border hover:border-hq-muted text-hq-muted hover:text-hq-text rounded-lg px-4 py-2 text-sm transition-colors">초기화 (기본값)</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Tab: Soul -->
        <div x-show="agentConfigTab === 'soul'">
          <div class="bg-hq-bg rounded-xl p-4">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-base">🧠</span>
              <label class="text-xs font-semibold text-hq-text">시스템 프롬프트</label>
            </div>
            <p class="text-[11px] text-hq-muted/60 mb-3">에이전트의 성격과 행동 방식을 결정합니다. 변경하면 즉시 반영됩니다.</p>
            <textarea x-model="agentSoulText" rows="14"
                      class="w-full rounded-xl border border-hq-border/50 px-5 py-4 text-[13px] text-hq-text resize-y focus:outline-none focus:border-hq-accent/40 transition-colors"
                      style="font-family: 'Pretendard Variable', 'Pretendard', sans-serif; line-height: 1.9; background:rgb(var(--hq-panel)/0.5); letter-spacing:0.01em;"
                      placeholder="이 에이전트의 시스템 프롬프트를 입력하세요..."></textarea>
            <div class="flex items-center justify-between mt-3">
              <span class="text-[10px] text-hq-muted/60" x-text="agentSoulText.length + '자'"></span>
              <button @click="saveAgentSoul()"
                      class="bg-hq-accent hover:bg-blue-600 text-white rounded-xl px-5 py-2.5 text-sm font-medium transition-colors">
                저장
              </button>
            </div>
          </div>
        </div>

        <!-- Tab: Skills -->
        <div x-show="agentConfigTab === 'skills'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">사용 가능한 도구 (스킬)</label>
            <p class="text-[11px] text-hq-muted/70 mb-4">이 에이전트가 작업할 때 쓸 수 있는 도구 목록입니다.</p>
            <template x-if="(agentConfigData?.allowed_tools || []).length === 0">
              <div class="text-center py-8">
                <div class="text-3xl mb-2">🚫</div>
                <p class="text-sm text-hq-muted">이 에이전트는 도구를 사용하지 않습니다.</p>
                <p class="text-[11px] text-hq-muted/85 mt-1">순수 분석·요약 전문 에이전트입니다.</p>
              </div>
            </template>
            <template x-if="(agentConfigData?.allowed_tools || []).length > 0">
              <div class="grid grid-cols-2 gap-2">
                <template x-for="tool in (agentConfigData?.allowed_tools || [])" :key="tool">
                  <div class="bg-hq-panel border border-hq-border/50 rounded-lg p-3 flex items-center gap-2.5">
                    <div class="w-7 h-7 rounded-md bg-hq-accent/10 flex items-center justify-center text-sm shrink-0">🔧</div>
                    <div class="min-w-0">
                      <div class="text-xs font-semibold text-hq-text truncate" x-text="getToolDisplayName(tool)"></div>
                      <div class="text-[10px] text-hq-muted truncate" x-text="getToolDescription(tool)"></div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>

        <!-- Save status -->
        <div class="mt-4 text-center h-5">
          <span x-show="agentConfigSaveStatus === 'saving'" class="text-xs text-hq-yellow">저장 중...</span>
          <span x-show="agentConfigSaveStatus === 'saved'" class="text-xs text-hq-green">저장 완료</span>
          <span x-show="agentConfigSaveStatus === 'error'" class="text-xs text-hq-red">저장 실패</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Task Detail Modal (작업 상세) ═══ -->
  <div x-show="showTaskDetail" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showTaskDetail = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[800px] mx-4 max-h-[85vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-hq-text">작업 상세</h2>
        <button @click="showTaskDetail = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <template x-if="taskDetailData">
        <div>
          <!-- Task Info -->
          <div class="bg-hq-bg rounded-xl p-4 mb-4">
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div><span class="text-hq-muted">명령:</span> <span class="text-hq-text ml-1" x-text="taskDetailData.command"></span></div>
              <div><span class="text-hq-muted">상태:</span>
                <span class="ml-1 status-badge"
                      :class="taskDetailData.status === 'completed' ? 'bg-hq-green/10 text-hq-green' : taskDetailData.status === 'failed' ? 'bg-hq-red/10 text-hq-red' : 'bg-hq-yellow/10 text-hq-yellow'"
                      x-text="taskDetailData.status === 'completed' ? '완료' : taskDetailData.status === 'failed' ? '실패' : '진행중'"></span>
              </div>
              <div><span class="text-hq-muted">소요시간:</span> <span class="text-hq-text font-mono ml-1" x-text="(taskDetailData.time_seconds || 0) + 's'"></span></div>
              <div><span class="text-hq-muted">비용:</span> <span class="text-hq-green font-mono ml-1" x-text="'$' + (taskDetailData.cost || 0).toFixed(4)"></span></div>
              <div x-show="taskDetailData.tokens_used"><span class="text-hq-muted">토큰(사용량):</span> <span class="text-hq-purple font-mono ml-1" x-text="(taskDetailData.tokens_used || 0).toLocaleString()"></span></div>
              <div><span class="text-hq-muted">생성일:</span> <span class="text-hq-text font-mono ml-1" x-text="taskDetailData.created_at ? new Date(taskDetailData.created_at).toLocaleString('ko-KR') : '-'"></span></div>
            </div>
          </div>
          <!-- Tabs -->
          <div class="flex gap-2 mb-4">
            <button @click="taskDetailTab = 'result'" :class="taskDetailTab === 'result' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1 text-xs font-semibold rounded-lg transition">결과</button>
            <button @click="taskDetailTab = 'replay'; loadTaskReplay(taskDetailData.task_id)" :class="taskDetailTab === 'replay' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1 text-xs font-semibold rounded-lg transition">리플레이 (실행 과정)</button>
          </div>
          <!-- Result Tab -->
          <div x-show="taskDetailTab === 'result'" class="bg-hq-bg rounded-xl p-4">
            <template x-if="taskDetailData.result_data">
              <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(taskDetailData.result_data)"></div>
            </template>
            <template x-if="!taskDetailData.result_data">
              <div class="text-sm text-hq-muted text-center py-4">결과 데이터가 없습니다</div>
            </template>
          </div>
          <!-- Replay Tab -->
          <div x-show="taskDetailTab === 'replay'" class="bg-hq-bg rounded-xl p-4">
            <template x-if="taskReplay && taskReplay.root">
              <div class="space-y-2" x-html="renderTaskDetailReplay(taskReplay.root, 0)"></div>
            </template>
            <template x-if="!taskReplay">
              <div class="text-sm text-hq-muted text-center py-4">리플레이 데이터를 불러오는 중...</div>
            </template>
            <template x-if="taskReplay && !taskReplay.root">
              <div class="text-sm text-hq-muted text-center py-4">리플레이 데이터가 없습니다</div>
            </template>
          </div>
        </div>
      </template>
      <template x-if="!taskDetailData">
        <div class="text-center py-8 text-hq-muted">로딩 중...</div>
      </template>
    </div>
  </div>

  <!-- ═══ Task Comparison Modal (#9) ═══ -->
  <div x-show="taskHistory.compareMode" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" style="display:none;" @click.self="taskHistory.compareMode = false">
    <div class="glass border border-hq-border rounded-2xl w-full max-w-6xl max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between px-6 py-4 border-b border-hq-border">
        <h3 class="text-lg font-bold text-hq-text">작업 비교</h3>
        <button @click="taskHistory.compareMode = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="flex-1 overflow-auto p-6">
        <div class="grid grid-cols-2 gap-6">
          <!-- Left -->
          <div class="space-y-3">
            <div class="bg-hq-surface border border-hq-border rounded-xl p-4">
              <div class="text-xs text-hq-muted mb-1">명령</div>
              <div class="text-sm text-hq-text font-medium" x-text="taskHistory.compareA?.command || '-'"></div>
              <div class="flex items-center gap-3 mt-2 text-[10px] text-hq-muted">
                <span x-text="taskHistory.compareA?.created_at ? new Date(taskHistory.compareA.created_at).toLocaleString('ko-KR') : ''"></span>
                <span :class="taskHistory.compareA?.success ? 'text-hq-green' : 'text-hq-red'" x-text="taskHistory.compareA?.success ? '성공' : '실패'"></span>
              </div>
            </div>
            <div class="bg-hq-bg rounded-xl p-4 text-sm markdown-body max-h-96 overflow-auto" x-html="renderMarkdown(taskHistory.compareA?.result_data || taskHistory.compareA?.result_summary || '결과 없음')"></div>
          </div>
          <!-- Right -->
          <div class="space-y-3">
            <div class="bg-hq-surface border border-hq-border rounded-xl p-4">
              <div class="text-xs text-hq-muted mb-1">명령</div>
              <div class="text-sm text-hq-text font-medium" x-text="taskHistory.compareB?.command || '-'"></div>
              <div class="flex items-center gap-3 mt-2 text-[10px] text-hq-muted">
                <span x-text="taskHistory.compareB?.created_at ? new Date(taskHistory.compareB.created_at).toLocaleString('ko-KR') : ''"></span>
                <span :class="taskHistory.compareB?.success ? 'text-hq-green' : 'text-hq-red'" x-text="taskHistory.compareB?.success ? '성공' : '실패'"></span>
              </div>
            </div>
            <div class="bg-hq-bg rounded-xl p-4 text-sm markdown-body max-h-96 overflow-auto" x-html="renderMarkdown(taskHistory.compareB?.result_data || taskHistory.compareB?.result_summary || '결과 없음')"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Budget Edit Modal (#8) ═══ -->
  <div x-show="showBudgetEdit" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" style="display:none;" @click.self="showBudgetEdit = false">
    <div class="glass border border-hq-border rounded-2xl w-full max-w-md p-6">
      <h3 class="text-lg font-bold text-hq-text mb-4">예산 한도 수정</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-hq-muted mb-1">일일 한도 ($)</label>
          <input x-model.number="budgetEditDaily" type="number" step="0.1" min="0"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div>
          <label class="block text-xs text-hq-muted mb-1">월간 한도 ($)</label>
          <input x-model.number="budgetEditMonthly" type="number" step="1" min="0"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div class="flex gap-3">
          <button @click="saveBudget()" class="flex-1 bg-hq-accent hover:bg-hq-accent/80 text-white rounded-lg py-2 text-sm font-semibold transition">저장</button>
          <button @click="showBudgetEdit = false" class="px-4 text-hq-muted hover:text-hq-text border border-hq-border rounded-lg py-2 text-sm transition">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ CEO Profile Modal ═══ -->
  <div x-show="showCeoProfile" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showCeoProfile = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-hq-accent to-hq-purple flex items-center justify-center text-white font-bold text-sm">CEO</div>
          <div>
            <h2 class="text-lg font-bold text-hq-text">CEO</h2>
            <div class="text-xs text-hq-muted">총괄 사령관 · CORTHEX HQ</div>
          </div>
        </div>
        <button @click="showCeoProfile = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="bg-hq-bg rounded-xl p-4 space-y-3 mb-4">
        <div class="flex justify-between"><span class="text-xs text-hq-muted">직책</span><span class="text-xs text-hq-text">총괄 사령관 (CEO)</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">직속 보고</span><span class="text-xs text-hq-cyan cursor-pointer hover:underline" @click="showCeoProfile = false; openAgentConfig('chief_of_staff')">비서실장 → CEO</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">관리 부서</span><span class="text-xs text-hq-text">전체 (7개 부서)</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">총 에이전트</span><span class="text-xs text-hq-text" x-text="Object.keys(agentNames).length + '명'"></span></div>
      </div>
      <div class="bg-hq-bg rounded-xl p-4">
        <div class="text-xs text-hq-muted font-semibold mb-3">오늘 현황</div>
        <div class="grid grid-cols-3 gap-3">
          <div class="text-center">
            <div class="text-lg font-bold text-hq-accent" x-text="dashboard.todayTasks || 0"></div>
            <div class="text-[10px] text-hq-muted">명령</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-hq-green" x-text="dashboard.todayCompleted || 0"></div>
            <div class="text-[10px] text-hq-muted">완료</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-hq-yellow">$<span x-text="(totalCost || 0).toFixed(2)"></span></div>
            <div class="text-[10px] text-hq-muted">비용</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Tool Detail Modal ═══ -->
  <div x-show="toolDetailVisible" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="toolDetailVisible = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[400px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-hq-red/15 flex items-center justify-center text-hq-red text-lg">🔧</div>
          <div>
            <h2 class="text-base font-bold text-hq-text" x-text="toolDetailData?.name_ko || toolDetailData?.name || ''"></h2>
            <div class="text-[10px] text-hq-muted">외부 도구</div>
          </div>
        </div>
        <button @click="toolDetailVisible = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="bg-hq-bg rounded-xl p-4 space-y-3">
        <div class="flex justify-between"><span class="text-xs text-hq-muted">도구 ID</span><span class="text-xs font-mono text-hq-text" x-text="toolDetailData?.name || '-'"></span></div>
        <div x-show="toolDetailData?.description"><span class="text-xs text-hq-muted block mb-1">설명</span><span class="text-xs text-hq-text" x-text="toolDetailData?.description || ''"></span></div>
        <div x-show="toolDetailData?.category"><div class="flex justify-between"><span class="text-xs text-hq-muted">분류</span><span class="text-xs text-hq-text" x-text="toolDetailData?.category || '-'"></span></div></div>
      </div>
    </div>
  </div>

  <script>
    function corthexApp() {
      return {
        // State
        inputText: '',
        messages: [],
        showScrollBtn: false,
        newMsgCount: 0,
        systemStatus: 'idle',
        wsConnected: false,
        totalCost: 0,
        totalTokens: 0,
        activityLogs: [],
        activeAgents: {},
        ws: null,
        logExpanded: true,
        sidebarOpen: true,

        // ── Tab System ──
        activeTab: 'home',
        tabs: [
          { id: 'home', label: '작전현황', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>' },
          { id: 'command', label: '사령관실', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
          { id: 'performance', label: '전력분석', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>' },
          { id: 'history', label: '작전일지', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' },
          { id: 'schedule', label: '크론기지', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
          { id: 'workflow', label: '자동화', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>' },
          { id: 'activityLog', label: '통신로그', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>' },
          { id: 'knowledge', label: '정보국', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' },
          { id: 'archive', label: '기밀문서', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/></svg>' },
          { id: 'sns', label: '통신국', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/></svg>' },
          { id: 'trading', label: '전략실', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>' },
        ],

        // ── Dashboard (홈) ──
        dashboard: { todayTasks: 0, todayCompleted: 0, todayFailed: 0, runningCount: 0, totalCost: 0, totalTokens: 0, agentCount: 0, recentCompleted: [], systemHealth: 'ok', loaded: false },

        // ── Presets (명령 템플릿) ──
        presets: { items: [], showModal: false, editName: '', editCommand: '' },

        // ── Task History (작업내역) ──
        taskHistory: { items: [], search: '', filterStatus: 'all', filterDateFrom: '', filterDateTo: '', bookmarkOnly: false, selectedIds: [], expandedId: null, replayData: {}, compareMode: false, compareA: null, compareB: null, loaded: false, isSample: false, loading: false, error: null },

        // ── Performance (성능) ──
        performance: { agents: [], totalCalls: 0, totalCost: 0, totalTasks: 0, avgSuccessRate: 0, maxCost: 0, loaded: false },

        // ── Error Alert ──
        errorAlert: { visible: false, message: '', severity: 'error' },

        // ── Schedules (예약) ──
        schedules: {
          items: [], showModal: false, editName: '', editCommand: '',
          editCronPreset: '매일 오전 9시',
          cronPresets: ['매일 오전 9시', '매일 오후 6시', '매주 월요일 오전 10시', '매주 금요일 오후 5시', '매시간', '30분마다'],
        },

        // ── Workflows (워크플로우) ──
        workflows: { items: [], showEditor: false, editing: null, editName: '', editDesc: '', editSteps: [{ name: '', command: '' }], runningId: null },

        // ── Auth (인증) ──
        auth: { user: null, token: null, showLogin: false, loginUser: '', loginPass: '', loginError: '', role: 'ceo', bootstrapMode: true },

        // ── Memory Modal (에이전트 기억) ──
        memoryModal: { visible: false, agentId: '', agentName: '', items: [], newKey: '', newValue: '' },

        // Dark/Light mode
        darkMode: true,

        // ── Universal Delete Confirm (범용 삭제 확인) ──
        confirmDelete: { type: null, id: null, name: null },

        // Toast/Notification
        toasts: [],
        toastCounter: 0,
        notificationsEnabled: false,
        connectionLost: false,
        reconnectAttempt: 0,

        // Input experience
        commandHistory: [],
        historyIndex: -1,
        showMentionDropdown: false,
        mentionQuery: '',
        mentionResults: [],
        // 슬래시 명령어 자동완성
        showSlashDropdown: false,
        slashSelectedIndex: 0,
        slashCommands: [
          { cmd: '/전체', args: '[메시지]', desc: '6명 처장에게 동시 지시', icon: '📡' },
          { cmd: '/순차', args: '[메시지]', desc: '에이전트 릴레이 모드', icon: '🔗' },
          { cmd: '/도구점검', args: '', desc: '전체 도구 상태 확인', icon: '🔧' },
          { cmd: '/배치실행', args: '', desc: 'Gemini 배치 모드 실행', icon: '⚡' },
          { cmd: '/배치상태', args: '', desc: '배치 작업 진행 확인', icon: '📊' },
          { cmd: '/명령어', args: '', desc: '전체 명령어 목록', icon: '📋' },
        ],
        filteredSlashCommands: [],
        currentTaskId: null,

        // Welcome screen
        greeting: '',
        presetTab: '전체',
        presetTabs: ['전체', '전략', '분석', '법무', '마케팅'],
        backendPresets: [],
        // presetsLoaded 제거됨 (loadPresets에 통합)

        // View mode (chat panel)
        viewMode: 'chat',

        // Quality gate settings
        showQualitySettings: false,
        qualityRules: { rules: {}, rubrics: {}, known_divisions: [] },
        availableModels: [],
        selectedReviewModel: '',
        editingRubric: null,
        rubricEditName: '',
        rubricEditPrompt: '',
        rubricEditModel: '',
        rubricEditReasoning: '',
        qualitySaveStatus: '',

        // CEO profile modal
        showCeoProfile: false,

        // Tool detail modal
        toolDetailVisible: false,
        toolDetailData: null,

        // Agent config modal
        showAgentConfig: false,
        agentConfigData: null,
        agentConfigId: '',
        agentConfigTab: 'info',
        agentConfigLoading: false,
        agentSoulText: '',
        agentModelSelection: '',
        agentReasoningSelection: '',
        agentReasoningOptions: [],
        agentConfigSaveStatus: '',

        // Health check
        healthData: null,
        showHealthPopover: false,

        // Deploy status (배포 현황)
        deployStatus: { build: null, time: null, status: 'loading', commit: null },
        deployLogs: [],

        // Dashboard extras (budget, quality, task detail)
        dashboardRefreshTimer: null,
        budget: {},
        modelMode: 'auto',
        modelOverride: 'claude-sonnet-4-5-20250929',
        bulkModelSelection: '',
        bulkReasoningSelection: '',
        bulkReasoningOptions: [],
        bulkModelSaving: false,
        quality: {},
        showTaskDetail: false,
        taskDetailData: null,
        taskReplay: null,
        taskDetailTab: 'result',

        // Preset management
        showAddPreset: false,
        newPresetName: '',
        newPresetCommand: '',

        // More menu + new views
        // showMoreMenu 제거됨 (탭 바로 대체)
        activityLogFilter: 'all',

        // Knowledge management
        knowledge: { files: [], loading: false, selectedFile: null, content: '', editMode: false, saving: false, newFileName: '', newFolder: '', showCreateForm: false },

        // Archive browser
        archive: { files: [], loading: false, selectedReport: null, content: '', filterDivision: 'all', filterTier: 'all', searchCorrelation: '' },

        // SNS management
        sns: { tab: 'status', status: {}, oauthStatus: {}, queue: [], events: [], loading: false,
               igCaption: '', igImageUrl: '', igVideoUrl: '', igReelCaption: '',
               ytFilePath: '', ytTitle: '', ytDesc: '', ytTags: '', ytPrivacy: 'private',
               rejectReason: '', rejectingId: null, queueFilter: 'all' },

        // ── Trading (자동매매 시스템) ──
        trading: {
          tab: 'dashboard',
          loading: false,
          summary: { portfolio: {}, strategies: {}, watchlist_count: 0, today: {}, signals_count: 0, bot_active: false, settings: {} },
          portfolio: { cash: 0, initial_cash: 50000000, holdings: [] },
          strategies: [],
          watchlist: [],
          history: [],
          signals: [],
          settings: {},
          botActive: false,
          // 주문 폼
          orderForm: { action: 'buy', ticker: '', name: '', qty: 0, price: 0 },
          // 전략 추가 폼
          strategyForm: { name: '', type: 'rsi', indicator: 'RSI', buy_condition: 'RSI < 30', sell_condition: 'RSI > 70', target_tickers: '', stop_loss_pct: -5, take_profit_pct: 10, order_size: 1000000 },
          showStrategyModal: false,
          showOrderModal: false,
          showSettingsModal: false,
          // 관심종목 추가 폼
          watchForm: { ticker: '', name: '', target_price: 0, notes: '', market: 'KR' },
          showWatchModal: false,
          // 관심종목 실시간 가격
          watchPrices: {},
          watchPricesLoading: false,
          watchPricesUpdatedAt: '',
          // 관심종목 차트
          showChartModal: false,
          chartTicker: '',
          chartName: '',
          chartMarket: 'KR',
          chartData: [],
          chartLoading: false,
          // 초기자금 설정
          initialCashInput: 50000000,
        },

        // Org tree expand state
        expanded: {
          secretary: false,
          leet_master: true,
          tech: false,
          strategy: false,
          legal: false,
          marketing: false,
          investment: true,
          finance: false,
          publishing: false,
          tools: false,
        },

        // Agent name mapping
        agentNames: {
          'chief_of_staff': '비서실장',
          'report_specialist': '기록 보좌관',
          'schedule_specialist': '일정 보좌관',
          'relay_specialist': '소통 보좌관',
          'cto_manager': 'CTO 기술개발처장',
          'frontend_specialist': '프론트엔드',
          'backend_specialist': '백엔드/API',
          'infra_specialist': 'DB/인프라',
          'ai_model_specialist': 'AI 모델',
          'cso_manager': 'CSO 사업기획처장',
          'market_research_specialist': '시장조사',
          'business_plan_specialist': '사업계획서',
          'financial_model_specialist': '재무모델링',
          'clo_manager': 'CLO 법무 IP처장',
          'copyright_specialist': '저작권',
          'patent_specialist': '특허/약관',
          'cmo_manager': 'CMO 마케팅처장',
          'survey_specialist': '설문/리서치',
          'content_specialist': '콘텐츠',
          'community_specialist': '커뮤니티',
          'cio_manager': 'CIO 투자분석처장',
          'market_condition_specialist': '시황분석',
          'stock_analysis_specialist': '종목분석',
          'technical_analysis_specialist': '기술적분석',
          'risk_management_specialist': '리스크관리',
          'cpo_manager': '출판·기록처장 (CPO)',
          'chronicle_specialist': '회사연대기',
          'editor_specialist': '콘텐츠편집',
          'archive_specialist': '아카이브',
        },

        // Agent initials for avatars
        agentInitials: {
          'chief_of_staff': 'CS',
          'report_specialist': '총괄',
          'schedule_specialist': '전략',
          'relay_specialist': '소통',
          'cto_manager': 'CTO',
          'frontend_specialist': 'FE',
          'backend_specialist': 'BE',
          'infra_specialist': 'IF',
          'ai_model_specialist': 'AI',
          'cso_manager': 'CSO',
          'market_research_specialist': 'MR',
          'business_plan_specialist': 'BP',
          'financial_model_specialist': 'FM',
          'clo_manager': 'CLO',
          'copyright_specialist': 'CR',
          'patent_specialist': 'PT',
          'cmo_manager': 'CMO',
          'survey_specialist': 'SV',
          'content_specialist': 'CT',
          'community_specialist': 'CM',
          'cio_manager': 'CIO',
          'market_condition_specialist': 'MC',
          'stock_analysis_specialist': 'SA',
          'technical_analysis_specialist': 'TA',
          'risk_management_specialist': 'RM',
          'cpo_manager': 'CPO',
          'chronicle_specialist': 'CH',
          'editor_specialist': 'ED',
          'archive_specialist': 'AR',
        },

        // Division mapping for auto-expand
        agentDivision: {
          'chief_of_staff': 'secretary', 'report_specialist': 'secretary',
          'schedule_specialist': 'secretary', 'relay_specialist': 'secretary',
          'cto_manager': 'tech',
          'frontend_specialist': 'tech', 'backend_specialist': 'tech',
          'infra_specialist': 'tech', 'ai_model_specialist': 'tech',
          'cso_manager': 'strategy', 'market_research_specialist': 'strategy',
          'business_plan_specialist': 'strategy', 'financial_model_specialist': 'strategy',
          'clo_manager': 'legal', 'copyright_specialist': 'legal',
          'patent_specialist': 'legal', 'cmo_manager': 'marketing',
          'survey_specialist': 'marketing', 'content_specialist': 'marketing',
          'community_specialist': 'marketing',
          'cio_manager': 'finance', 'market_condition_specialist': 'finance',
          'stock_analysis_specialist': 'finance', 'technical_analysis_specialist': 'finance',
          'risk_management_specialist': 'finance',
          'cpo_manager': 'publishing', 'chronicle_specialist': 'publishing',
          'editor_specialist': 'publishing', 'archive_specialist': 'publishing',
        },

        // Agent color mapping
        agentColorMap: {
          'secretary': 'bg-hq-yellow/20 text-hq-yellow',
          'tech': 'bg-hq-cyan/20 text-hq-cyan',
          'strategy': 'bg-hq-cyan/20 text-hq-cyan',
          'legal': 'bg-hq-cyan/20 text-hq-cyan',
          'marketing': 'bg-hq-cyan/20 text-hq-cyan',
          'finance': 'bg-hq-purple/20 text-hq-purple',
          'publishing': 'bg-hq-green/20 text-hq-green',
        },
        agentRoles: {},
        agentModels: {},
        agentModelRaw: {},
        agentReasonings: {},

        // Dynamic agents/tools list (#5)
        agentsList: [],
        toolsList: [],

        // Feedback stats (#7)
        feedbackStats: { good: 0, bad: 0, total: 0, satisfaction_rate: 0 },

        // Budget edit (#8)
        showBudgetEdit: false,
        budgetEditDaily: 0,
        budgetEditMonthly: 0,

        // Tab grouping (#12)
        showMoreTabs: false,

        // Task history pagination (#14)
        taskHistoryPage: 1,
        taskHistoryPageSize: 20,

        // Batch mode toggle (#5)
        useBatch: false,

        // Input hint — 고정 텍스트 (#18)
        inputHints: ['명령을 입력하세요 · /명령어 로 명령어 목록 확인'],
        inputHintIndex: 0,

        init() {
          // Dark mode
          const savedTheme = localStorage.getItem('corthex-theme');
          if (savedTheme === 'light') {
            this.darkMode = false;
            document.documentElement.classList.remove('dark');
          }
          // Greeting
          this.greeting = this.getGreeting();
          // Notification permission
          this.requestNotificationPermission();
          // Auth
          this.checkAuth();
          // Dynamic agent/tool loading
          this.loadAgentsAndTools();
          // Load tools list (#5)
          this.loadToolsList();
          // Load feedback stats (#7)
          this.loadFeedbackStats();
          // Restore activity logs from localStorage (#13)
          this.restoreActivityLogs();
          // Restore conversation
          this.loadConversation();
          this.connectWebSocket();
          this.loadDashboard();
          this.loadPresets();
          // Keyboard shortcuts (#16)
          this.initKeyboardShortcuts();
          // Input hint — 순환 제거, 고정 텍스트 사용 (#18)
        },

        // ── Theme ──
        toggleTheme() {
          this.darkMode = !this.darkMode;
          if (this.darkMode) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('corthex-theme', 'dark');
          } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('corthex-theme', 'light');
          }
        },

        // ── Toast/Notification ──
        showToast(message, type = 'info') {
          const id = ++this.toastCounter;
          this.toasts.push({ id, message, type, visible: true });
          setTimeout(() => this.removeToast(id), 4000);
        },
        removeToast(id) {
          const t = this.toasts.find(t => t.id === id);
          if (t) t.visible = false;
          setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 300);
        },
        requestNotificationPermission() {
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(p => { this.notificationsEnabled = p === 'granted'; });
          } else if ('Notification' in window && Notification.permission === 'granted') {
            this.notificationsEnabled = true;
          }
        },
        sendDesktopNotification(title, body) {
          if (this.notificationsEnabled && document.hidden) {
            new Notification(title, { body });
          }
        },

        // ── WebSocket ──
        connectWebSocket() {
          const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
          this.ws = new WebSocket(`${protocol}//${location.host}/ws`);

          this.ws.onopen = () => {
            this.wsConnected = true;
            if (this.connectionLost) {
              this.connectionLost = false;
              this.reconnectAttempt = 0;
              this.showToast('서버에 다시 연결되었습니다.', 'success');
            }
          };

          this.ws.onclose = () => {
            this.wsConnected = false;
            this.connectionLost = true;
            this.reconnectAttempt++;
            setTimeout(() => this.connectWebSocket(), 3000);
          };

          this.ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            this.handleWsMessage(msg);
          };
        },

        handleWsMessage(msg) {
          switch (msg.event) {
            case 'processing_start':
            case 'task_accepted':
              this.systemStatus = 'working';
              if (msg.data?.task_id) this.currentTaskId = msg.data.task_id;
              if (!this.messages.some(m => m.type === 'processing')) {
                this.messages.push({ type: 'processing', id: Date.now(), timestamp: new Date().toISOString() });
              }
              break;

            case 'agent_status':
              const d = msg.data;
              this.activeAgents[d.agent_id] = {
                status: d.status,
                progress: d.progress || 0,
                detail: d.detail || '',
              };

              if (d.status === 'working') {
                const div = this.agentDivision[d.agent_id];
                if (div) {
                  this.expanded[div] = true;
                  if (['tech','strategy','legal','marketing'].includes(div)) {
                    this.expanded.leet_master = true;
                  }
                  if (div === 'finance') {
                    this.expanded.investment = true;
                  }
                }
              }

              if (d.status === 'working' && d.progress < 0.9) {
                this.simulateProgress(d.agent_id);
              }
              break;

            case 'activity_log':
              { const now = new Date(); const d = now.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\.\s*/g, '.').replace(/\.$/, ''); const t = now.toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false, hour: '2-digit', minute: '2-digit' }); msg.data.timeDate = d; msg.data.timeClock = t; msg.data.time = d + ' ' + t; }
              msg.data.timestamp = Date.now();
              this.activityLogs.push(msg.data);
              if (this.activityLogs.length > 50) this.activityLogs = this.activityLogs.slice(-50);
              this.saveActivityLogs();
              break;

            case 'cost_update':
              this.totalCost = msg.data.total_cost;
              this.totalTokens = msg.data.total_tokens;
              break;

            case 'telegram_message':
              // 텔레그램에서 온 CEO 메시지를 웹 채팅에 표시
              this.messages.push({ type: 'user', text: msg.data.text, source: 'telegram', timestamp: new Date().toISOString() });
              if (this.showScrollBtn) this.newMsgCount++;
              this.$nextTick(() => this.scrollToBottom());
              break;

            case 'result':
            case 'task_completed':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              const resultMsg = {
                type: 'result',
                content: msg.data.content,
                sender_id: msg.data.sender_id || 'chief_of_staff',
                handled_by: msg.data.handled_by || '비서실장',
                delegation: msg.data.delegation || '',
                model: msg.data.model || '',
                time_seconds: msg.data.time_seconds,
                cost: msg.data.cost,
                quality_score: msg.data.quality_score || null,
                task_id: this.currentTaskId || msg.data.task_id || '',
                collapsed: false,
                feedbackSent: false,
                feedbackRating: null,
                source: msg.data.source || 'web',
                timestamp: new Date().toISOString(),
              };
              this.messages.push(resultMsg);
              if (this.showScrollBtn) this.newMsgCount++;

              // DB에 AI 응답 저장
              (async () => {
                try {
                  await fetch('/api/conversation/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      type: 'result',
                      content: resultMsg.content,
                      sender_id: resultMsg.sender_id,
                      handled_by: resultMsg.handled_by,
                      delegation: resultMsg.delegation,
                      model: resultMsg.model,
                      time_seconds: resultMsg.time_seconds,
                      cost: resultMsg.cost,
                      quality_score: resultMsg.quality_score,
                      task_id: resultMsg.task_id,
                      source: resultMsg.source,
                    }),
                  });
                } catch (e) {
                  console.warn('AI 응답 저장 실패:', e);
                }
              })();

              this.systemStatus = 'idle';
              this.currentTaskId = null;
              this.totalCost = msg.data.cost || this.totalCost;
              this.showToast('작업이 완료되었습니다.', 'success');
              this.sendDesktopNotification('CORTHEX HQ', '작업이 완료되었습니다.');
              this.$nextTick(() => this.scrollToBottom());
              // 이중 스크롤: 마크다운 렌더링 후에도 스크롤
              setTimeout(() => this.scrollToBottom(), 300);
              // 남아있는 working 에이전트를 done으로 전환
              Object.keys(this.activeAgents).forEach(id => {
                if (this.activeAgents[id]?.status === 'working') {
                  this.activeAgents[id].status = 'done';
                  this.activeAgents[id].progress = 1.0;
                }
              });
              // (#17) 에이전트 완료 상태 5초 유지 후 idle로
              Object.keys(this.activeAgents).forEach(id => {
                if (this.activeAgents[id]?.status === 'done') {
                  setTimeout(() => {
                    if (this.activeAgents[id]?.status === 'done') {
                      delete this.activeAgents[id];
                    }
                  }, 5000);
                }
              });
              // Refresh dashboard/history/feedback if currently viewing
              if (this.activeTab === 'home') { this.loadDashboard(); this.loadFeedbackStats(); }
              if (this.activeTab === 'history') this.loadTaskHistory();
              break;

            case 'error':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({ type: 'error', text: msg.data.message, timestamp: new Date().toISOString() });
              if (this.showScrollBtn) this.newMsgCount++;
              this.systemStatus = 'error';
              this.currentTaskId = null;
              this.errorAlert = { visible: true, message: msg.data.message || '오류가 발생했습니다', severity: 'error' };
              this.showToast(msg.data.message || '오류가 발생했습니다.', 'error');
              setTimeout(() => { this.systemStatus = 'idle'; }, 3000);
              setTimeout(() => { this.errorAlert.visible = false; }, 10000);
              break;

            case 'error_alert':
              this.errorAlert = { visible: true, message: msg.data.message, severity: msg.data.severity || 'error' };
              if (msg.data.severity !== 'critical') {
                setTimeout(() => { this.errorAlert.visible = false; }, 10000);
              }
              break;
          }
        },

        simulateProgress(agentId) {
          const interval = setInterval(() => {
            if (!this.activeAgents[agentId] || this.activeAgents[agentId].status !== 'working') {
              clearInterval(interval);
              return;
            }
            const current = this.activeAgents[agentId].progress;
            if (current < 0.9) {
              this.activeAgents[agentId].progress = Math.min(0.9, current + 0.05 + Math.random() * 0.1);
            } else {
              clearInterval(interval);
            }
          }, 800);
        },

        // ── Input Experience ──
        async sendMessage() {
          const text = this.inputText.trim();
          if (!text || this.systemStatus === 'working') return;

          this.commandHistory.push(text);
          if (this.commandHistory.length > 50) this.commandHistory.shift();
          this.historyIndex = -1;

          this.messages.push({ type: 'user', text, timestamp: new Date().toISOString() });
          this.inputText = '';
          this.activeAgents = {};

          if (this.$refs.inputArea) this.$refs.inputArea.style.height = 'auto';

          // DB에 사용자 메시지 저장
          try {
            await fetch('/api/conversation/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'user', text }),
            });
          } catch (e) {
            console.warn('메시지 저장 실패:', e);
          }

          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'command', text, batch: this.useBatch }));
          }

          this.$nextTick(() => this.scrollToBottom());
          setTimeout(() => this.scrollToBottom(), 150);
        },

        sendPreset(text) {
          this.inputText = text;
          this.sendMessage();
        },

        handleInputKeydown(e) {
          // 슬래시 팝업이 열려있을 때 키보드 내비게이션
          if (this.showSlashDropdown) {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              this.slashSelectedIndex = Math.min(this.slashSelectedIndex + 1, this.filteredSlashCommands.length - 1);
              return;
            }
            if (e.key === 'ArrowUp') {
              e.preventDefault();
              this.slashSelectedIndex = Math.max(0, this.slashSelectedIndex - 1);
              return;
            }
            if (e.key === 'Enter' || e.key === 'Tab') {
              e.preventDefault();
              if (this.filteredSlashCommands[this.slashSelectedIndex]) {
                this.insertSlashCommand(this.filteredSlashCommands[this.slashSelectedIndex]);
              }
              return;
            }
            if (e.key === 'Escape') {
              e.preventDefault();
              this.showSlashDropdown = false;
              return;
            }
          }
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
            return;
          }
          if (e.key === 'ArrowUp' && !this.inputText.trim()) {
            e.preventDefault();
            if (this.commandHistory.length > 0) {
              if (this.historyIndex < this.commandHistory.length - 1) this.historyIndex++;
              this.inputText = this.commandHistory[this.commandHistory.length - 1 - this.historyIndex];
            }
            return;
          }
          if (e.key === 'ArrowDown' && this.historyIndex >= 0) {
            e.preventDefault();
            this.historyIndex--;
            this.inputText = this.historyIndex < 0 ? '' : this.commandHistory[this.commandHistory.length - 1 - this.historyIndex];
            return;
          }
          if (e.key === 'Escape') { this.showMentionDropdown = false; this.showSlashDropdown = false; }
        },

        handleInputChange(e) {
          const el = e.target;
          el.style.height = 'auto';
          el.style.height = Math.min(el.scrollHeight, 200) + 'px';

          const text = this.inputText;

          // 슬래시 명령어 감지 — /로 시작하고 공백 전까지
          if (text.startsWith('/')) {
            const spaceIdx = text.indexOf(' ');
            const query = spaceIdx === -1 ? text : text.substring(0, spaceIdx);
            if (spaceIdx === -1) {
              this.filteredSlashCommands = this.slashCommands.filter(c =>
                c.cmd.startsWith(query) || c.cmd.includes(query)
              );
              this.showSlashDropdown = this.filteredSlashCommands.length > 0;
              this.slashSelectedIndex = 0;
            } else {
              this.showSlashDropdown = false;
            }
            this.showMentionDropdown = false;
            return;
          }
          this.showSlashDropdown = false;

          // @멘션 감지
          const cursorPos = el.selectionStart;
          const textBefore = text.substring(0, cursorPos);
          const atMatch = textBefore.match(/@(\S*)$/);

          if (atMatch) {
            this.mentionQuery = atMatch[1].toLowerCase();
            this.mentionResults = Object.entries(this.agentNames)
              .filter(([id, name]) => id.toLowerCase().includes(this.mentionQuery) || name.toLowerCase().includes(this.mentionQuery))
              .slice(0, 6)
              .map(([id, name]) => ({ id, name }));
            this.showMentionDropdown = this.mentionResults.length > 0;
          } else {
            this.showMentionDropdown = false;
          }
        },

        insertSlashCommand(cmd) {
          this.inputText = cmd.args ? cmd.cmd + ' ' : cmd.cmd;
          this.showSlashDropdown = false;
          this.$nextTick(() => {
            const el = this.$refs.inputArea;
            if (el) { el.focus(); el.selectionStart = el.selectionEnd = this.inputText.length; }
          });
        },

        insertMention(agent) {
          const el = this.$refs.inputArea;
          const cursorPos = el.selectionStart;
          const textBefore = this.inputText.substring(0, cursorPos);
          const textAfter = this.inputText.substring(cursorPos);
          const replaced = textBefore.replace(/@\S*$/, `@${agent.name} `);
          this.inputText = replaced + textAfter;
          this.showMentionDropdown = false;
          this.$nextTick(() => { el.focus(); el.selectionStart = el.selectionEnd = replaced.length; });
        },

        cancelTask() {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'cancel', task_id: this.currentTaskId }));
          }
          this.systemStatus = 'idle';
          this.currentTaskId = null;
          this.messages = this.messages.filter(m => m.type !== 'processing');
          this.showToast('작업 취소를 요청했습니다.', 'warning');
        },

        // ── Welcome Screen ──
        getGreeting() {
          const hour = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })).getHours();
          if (hour < 6) return '새벽에도 열일하시네요, 고동희 대표님';
          if (hour < 12) return '좋은 아침입니다, 고동희 대표님';
          if (hour < 18) return '환영합니다, 고동희 대표님';
          if (hour < 22) return '좋은 저녁입니다, 고동희 대표님';
          return '오늘도 수고하셨습니다, 고동희 대표님';
        },

        // loadBackendPresets는 loadPresets()에 통합됨

        getFilteredPresets() {
          const defaults = [
            { name: '기술 스택 제안', command: 'LEET MASTER 서비스의 기술 스택을 제안해줘', category: '전략', color: 'hq-cyan', desc: 'CTO + 기술팀이 최적의 아키텍처를 설계합니다' },
            { name: '주가 분석', command: '삼성전자 주가를 분석해줘', category: '분석', color: 'hq-purple', desc: '4명의 투자분석팀이 병렬로 분석합니다' },
            { name: '이용약관 작성', command: '서비스 이용약관 초안을 만들어줘', category: '법무', color: 'hq-green', desc: 'CLO + 법무팀이 법적 문서를 작성합니다' },
            { name: '마케팅 전략', command: '마케팅 콘텐츠 전략을 수립해줘', category: '마케팅', color: 'hq-yellow', desc: 'CMO + 마케팅팀이 전략을 수립합니다' },
            { name: '사업계획서', command: '스타트업 사업계획서 초안을 작성해줘', category: '전략', color: 'hq-cyan', desc: 'CSO + 사업기획팀이 사업계획을 수립합니다' },
            { name: '특허 분석', command: '우리 서비스의 특허 가능성을 분석해줘', category: '법무', color: 'hq-green', desc: 'CLO + 법무팀이 특허 가능성을 분석합니다' },
            ...this.backendPresets.map(p => ({
              name: p.name, command: p.command, category: '전체', color: 'hq-accent',
              desc: p.command.length > 40 ? p.command.substring(0, 40) + '...' : p.command,
              isServer: true,
            })),
          ];
          if (this.presetTab === '전체') return defaults;
          return defaults.filter(p => p.category === this.presetTab);
        },

        // ── Result Helpers ──
        copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(
            () => this.showToast('클립보드에 복사되었습니다.', 'success'),
            () => this.showToast('복사에 실패했습니다.', 'error')
          );
        },
        isLongContent(content) { return content && content.length > 1500; },
        getQualityBadge(score) {
          if (!score) return { label: '-', cls: 'bg-hq-muted/10 text-hq-muted' };
          if (score >= 90) return { label: 'A+', cls: 'bg-hq-green/20 text-hq-green border-hq-green/30' };
          if (score >= 80) return { label: 'A', cls: 'bg-hq-green/15 text-hq-green/80 border-hq-green/20' };
          if (score >= 70) return { label: 'B', cls: 'bg-hq-yellow/15 text-hq-yellow border-hq-yellow/20' };
          if (score >= 60) return { label: 'C', cls: 'bg-hq-yellow/10 text-hq-yellow/80 border-hq-yellow/15' };
          return { label: 'D', cls: 'bg-hq-red/15 text-hq-red border-hq-red/20' };
        },

        // ── Agent Helpers ──
        scrollToAgent(agentId) {
          const div = this.agentDivision[agentId];
          if (div) {
            this.expanded[div] = true;
            if (['tech','strategy','legal','marketing'].includes(div)) this.expanded.leet_master = true;
            if (div === 'finance') this.expanded.investment = true;
          }
          this.$nextTick(() => {
            const el = document.getElementById('agent-' + agentId);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
              el.classList.add('bg-hq-yellow/10');
              setTimeout(() => el.classList.remove('bg-hq-yellow/10'), 2000);
            }
          });
        },

        // ── Task Detail Modal ──
        async openTaskDetail(taskId) {
          this.taskDetailData = null;
          this.taskReplay = null;
          this.taskDetailTab = 'result';
          this.showTaskDetail = true;
          try {
            const res = await fetch(`/api/tasks/${taskId}`);
            if (res.ok) this.taskDetailData = await res.json();
            else this.showToast('작업 정보를 불러올 수 없습니다.', 'error');
          } catch {
            this.showToast('작업 상세 로드 실패', 'error');
          }
        },

        async loadTaskReplay(taskId) {
          this.taskReplay = null;
          try {
            const res = await fetch(`/api/replay/${taskId}`);
            if (res.ok) this.taskReplay = await res.json();
            else {
              const latest = await fetch('/api/replay/latest');
              if (latest.ok) this.taskReplay = await latest.json();
              else this.taskReplay = {};
            }
          } catch {
            this.taskReplay = {};
          }
        },

        renderTaskDetailReplay(node, depth) {
          if (!node) return '';
          const indent = depth * 20;
          const color = depth === 0 ? 'hq-accent' : depth === 1 ? 'hq-cyan' : 'hq-purple';
          let html = `<div style="margin-left:${indent}px" class="flex items-start gap-2 p-2 bg-hq-surface rounded-lg mb-1">
            <span class="w-2 h-2 rounded-full bg-${color} mt-1.5 shrink-0"></span>
            <div>
              <span class="text-xs font-bold text-${color}">${this.getAgentName(node.agent_id || node.agent || '')}</span>
              ${node.action ? `<span class="text-xs text-hq-muted ml-2">${node.action}</span>` : ''}
              ${node.result ? `<div class="text-xs text-hq-text/60 mt-1 truncate max-w-lg">${(node.result || '').substring(0, 100)}${(node.result||'').length > 100 ? '...' : ''}</div>` : ''}
            </div>
          </div>`;
          if (node.children && Array.isArray(node.children)) {
            node.children.forEach(child => { html += this.renderTaskDetailReplay(child, depth + 1); });
          }
          return html;
        },

        // ── Existing Helpers ──
        toggleSection(section) {
          this.expanded[section] = !this.expanded[section];
        },

        getAgentName(id) {
          return this.agentNames[id] || id;
        },

        getAgentInitials(id) {
          return this.agentInitials[id] || id.substring(0, 2).toUpperCase();
        },

        getAgentAvatarClass(id) {
          const div = this.agentDivision[id];
          return this.agentColorMap[div] || 'bg-hq-accent/20 text-hq-accent';
        },

        getAgentDotClass(id) {
          const status = this.activeAgents[id];
          if (!status) return 'bg-hq-muted/40';
          switch (status.status) {
            case 'working': return 'bg-hq-green pulse-dot';
            case 'waiting': return 'bg-amber-400 animate-pulse shadow-[0_0_10px_rgba(251,191,36,0.6)]';
            case 'done': return 'bg-hq-green';
            case 'idle': return 'bg-hq-muted/40';
            default: return 'bg-hq-muted/30';
          }
        },

        getSectionBadgeClass(section) {
          const ids = this.getSectionAgentIds(section);
          const hasWorking = ids.some(id => this.activeAgents[id]?.status === 'working');
          if (hasWorking) return 'bg-hq-yellow/15 text-hq-yellow border border-hq-yellow/20';
          const hasDone = ids.some(id => this.activeAgents[id]?.status === 'done');
          if (hasDone) return 'bg-hq-green/15 text-hq-green border border-hq-green/20';
          return 'hidden';
        },

        getSectionStatusColor(section) {
          const ids = this.getSectionAgentIds(section);
          const hasWorking = ids.some(id => this.activeAgents[id]?.status === 'working');
          if (hasWorking) return 'text-hq-yellow';
          const hasDone = ids.some(id => this.activeAgents[id]?.status === 'done');
          if (hasDone) return 'text-hq-green';
          return 'text-hq-muted/70';
        },

        getSectionStatusText(section) {
          const ids = this.getSectionAgentIds(section);
          const working = ids.filter(id => this.activeAgents[id]?.status === 'working').length;
          if (working > 0) return `${working}명 작업중`;
          const done = ids.filter(id => this.activeAgents[id]?.status === 'done').length;
          if (done > 0) return `${done}명 완료`;
          return '';
        },

        getSectionAgentIds(section) {
          if (section === 'leet_master') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => ['tech','strategy','legal','marketing'].includes(div))
              .map(([id]) => id);
          }
          if (section === 'investment') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => div === 'finance')
              .map(([id]) => id);
          }
          return Object.entries(this.agentDivision)
            .filter(([_, div]) => div === section)
            .map(([id]) => id);
        },

        renderMarkdown(text) {
          try {
            let html = marked.parse(text || '');
            // ■ 문자를 글로우 배지로 변환 (계층 구분은 CSS에서 처리)
            html = html.replace(/■\s*/g, '<span class="badge-marker badge-marker-primary"></span>');
            return html;
          }
          catch { return text; }
        },

        // ── Quality Gate Settings ──────────────────

        sortModels(models) {
          const tierOrder = { executive: 0, manager: 1, specialist: 2, worker: 3 };
          return models.sort((a, b) => {
            const ta = tierOrder[a.tier] ?? 99;
            const tb = tierOrder[b.tier] ?? 99;
            if (ta !== tb) return ta - tb;
            return (b.cost_output || 0) - (a.cost_output || 0);
          });
        },

        getModelDisplayName(modelName) {
          const names = {
            'claude-opus-4-6': 'Claude Opus 4.6',
            'claude-sonnet-4-5-20250929': 'Claude Sonnet 4.5',
            'claude-haiku-4-5-20251001': 'Claude Haiku 4.5',
            'gpt-5.2-pro': 'GPT-5.2 Pro',
            'gpt-5.2': 'GPT-5.2',
            'gpt-5.1': 'GPT-5.1',
            'gpt-5': 'GPT-5',
            'gpt-5-mini': 'GPT-5 Mini',
            'gemini-3-pro-preview': 'Gemini 3.0 Pro Preview',
            'gemini-2.5-pro': 'Gemini 2.5 Pro',
            'gemini-2.5-flash': 'Gemini 2.5 Flash',
          };
          return names[modelName] || modelName;
        },

        // 모델별 기본 추론 옵션 (서버에서 reasoning_levels를 못 받았을 때 fallback)
        _getDefaultReasoning(modelName) {
          const map = {
            'claude-opus-4-6': ['low','medium','high'],
            'claude-sonnet-4-5-20250929': ['low','medium','high'],
            'claude-haiku-4-5-20251001': [],
            'gpt-5-mini': ['low','medium','high'],
            'gpt-5': ['none','low','medium','high'],
            'gpt-5.1': ['none','low','medium','high'],
            'gpt-5.2': ['none','low','medium','high','xhigh'],
            'gpt-5.2-pro': ['medium','high','xhigh'],
            'gemini-3-pro-preview': ['low','high'],
            'gemini-2.5-pro': ['low','medium','high'],
            'gemini-2.5-flash': ['none','low','medium','high'],
          };
          return map[modelName] || [];
        },

        // 에이전트 카드 라벨 업데이트: "Claude Sonnet 4.5 (medium)" 형식
        _updateAgentCardLabel(agentId) {
          const modelName = this.agentConfigData?.model_name || this.agentModelRaw[agentId] || '';
          const reasoning = this.agentConfigData?.reasoning_effort || this.agentReasonings[agentId] || '';
          const displayName = this.getModelDisplayName(modelName);
          this.agentModels[agentId] = reasoning ? `${displayName} (${reasoning})` : displayName;
          this.agentModelRaw[agentId] = modelName;
          this.agentReasonings[agentId] = reasoning;
        },

        getModelTierLabel(tier) {
          const labels = { executive: '임원급', manager: '매니저급', specialist: '전문가급', worker: '실무급' };
          return labels[tier] || tier;
        },

        getModelsByProvider() {
          const ordered = { 'Anthropic (Claude)': [], 'Google (Gemini)': [], 'OpenAI': [] };
          for (const m of (this.availableModels || [])) {
            const prov = m.provider || 'other';
            const label = prov === 'anthropic' ? 'Anthropic (Claude)' : prov === 'google' ? 'Google (Gemini)' : prov === 'openai' ? 'OpenAI' : prov;
            if (!ordered[label]) ordered[label] = [];
            ordered[label].push(m);
          }
          // 빈 그룹 제거
          for (const key of Object.keys(ordered)) {
            if (ordered[key].length === 0) delete ordered[key];
          }
          return ordered;
        },

        async loadQualityRules() {
          try {
            const [rulesRes, modelsRes] = await Promise.all([
              fetch('/api/quality-rules').then(r => r.json()),
              fetch('/api/available-models').then(r => r.json()),
            ]);
            this.qualityRules = rulesRes;
            this.availableModels = this.sortModels(Array.isArray(modelsRes) ? modelsRes : []);
            this.selectedReviewModel = rulesRes.rules?.review_model || (this.availableModels.length ? this.availableModels[0].name : '');
          } catch (e) {
            console.error('Failed to load quality rules:', e);
          }
        },

        async saveReviewModel() {
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch('/api/quality-rules/model', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ review_model: this.selectedReviewModel }),
            }).then(r => r.json());
            this.qualitySaveStatus = res.success ? 'saved' : 'error';
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        startEditRubric(division) {
          this.editingRubric = division;
          const rubric = this.qualityRules.rubrics?.[division] || { name: '', prompt: '', model: '', reasoning_effort: '' };
          this.rubricEditName = rubric.name || '';
          this.rubricEditPrompt = rubric.prompt || '';
          this.rubricEditModel = rubric.model || '';
          this.rubricEditReasoning = rubric.reasoning_effort || '';
        },

        async saveRubric() {
          if (!this.editingRubric) return;
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch(`/api/quality-rules/rubric/${this.editingRubric}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
                model: this.rubricEditModel || null,
                reasoning_effort: this.rubricEditReasoning || null,
              }),
            }).then(r => r.json());
            if (res.success) {
              if (!this.qualityRules.rubrics) this.qualityRules.rubrics = {};
              this.qualityRules.rubrics[this.editingRubric] = {
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
                model: this.rubricEditModel,
                reasoning_effort: this.rubricEditReasoning,
              };
              this.editingRubric = null;
              this.qualitySaveStatus = 'saved';
            } else {
              this.qualitySaveStatus = 'error';
            }
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        async deleteRubric(division) {
          if (!division || division === 'default') return;
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch(`/api/quality-rules/rubric/${division}`, {
              method: 'DELETE',
            }).then(r => r.json());
            if (res.success) {
              if (this.qualityRules.rubrics) delete this.qualityRules.rubrics[division];
              this.editingRubric = null;
              this.qualitySaveStatus = 'saved';
            } else {
              this.qualitySaveStatus = 'error';
            }
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        // ── Office & Agent Config ──
        getAgentStatusLight(agentId) {
          const agent = this.activeAgents[agentId];
          if (!agent) return 'status-light-idle';
          if (agent.status === 'working') return 'status-light-working';
          if (agent.status === 'done') return 'status-light-done';
          return 'status-light-idle';
        },

        showToolDetail(tool) {
          this.toolDetailData = tool;
          this.toolDetailVisible = true;
        },

        async openAgentConfig(agentId) {
          this.agentConfigId = agentId;
          this.agentConfigLoading = true;
          this.showAgentConfig = true;
          this.agentConfigTab = 'info';
          this.agentConfigSaveStatus = '';
          try {
            const [agentRes, modelsRes] = await Promise.all([
              fetch(`/api/agents/${agentId}`).then(r => r.json()),
              this.availableModels.length ? Promise.resolve(this.availableModels) :
                fetch('/api/available-models').then(r => r.json()),
            ]);
            // 서버 에러 체크 (서버 초기화 실패 등)
            if (agentRes.error) {
              this.showToast('에이전트 로드 실패: ' + agentRes.error, 'error');
              this.showAgentConfig = false;
              return;
            }
            this.agentConfigData = agentRes;
            if (!this.availableModels.length && Array.isArray(modelsRes)) {
              this.availableModels = this.sortModels(modelsRes);
            }
            this.agentSoulText = agentRes.system_prompt || '';
            this.agentModelSelection = agentRes.model_name || '';
            this.agentReasoningSelection = agentRes.reasoning_effort || '';
            // 현재 모델의 추론 정도 옵션 조회
            const currentModel = this.availableModels.find(m => m.name === this.agentModelSelection);
            this.agentReasoningOptions = currentModel?.reasoning_levels || [];
            // Fallback: 모델 목록 로딩 실패해도 기본 추론 옵션 제공
            if (this.agentReasoningOptions.length === 0 && this.agentModelSelection) {
              this.agentReasoningOptions = this._getDefaultReasoning(this.agentModelSelection);
            }
          } catch (e) {
            this.showToast('에이전트 정보를 불러올 수 없습니다: ' + (e.message || '서버 연결 실패'), 'error');
            this.showAgentConfig = false;
          } finally {
            this.agentConfigLoading = false;
          }
        },

        async saveAgentSoul() {
          this.agentConfigSaveStatus = 'saving';
          try {
            const res = await fetch(`/api/agents/${this.agentConfigId}/soul`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ system_prompt: this.agentSoulText }),
            }).then(r => r.json());
            if (res.error) {
              this.showToast(res.error, 'error');
              this.agentConfigSaveStatus = 'error';
            } else {
              this.agentConfigData.system_prompt = this.agentSoulText;
              this.agentConfigSaveStatus = 'saved';
              this.showToast('소울이 저장되었습니다.', 'success');
            }
          } catch (e) {
            this.agentConfigSaveStatus = 'error';
            this.showToast('소울 저장 실패: ' + (e.message || '서버 연결 오류'), 'error');
          }
          setTimeout(() => { this.agentConfigSaveStatus = ''; }, 2500);
        },

        async saveAgentModel() {
          this.agentConfigSaveStatus = 'saving';
          try {
            const res = await fetch(`/api/agents/${this.agentConfigId}/model`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model_name: this.agentModelSelection }),
            }).then(r => r.json());
            if (res.error) {
              this.showToast(res.error, 'error');
              this.agentConfigSaveStatus = 'error';
            } else {
              this.agentConfigData.model_name = this.agentModelSelection;
              // 모델 변경 시 추론 옵션도 갱신
              const newModel = this.availableModels.find(m => m.name === this.agentModelSelection);
              this.agentReasoningOptions = newModel?.reasoning_levels || [];
              // Fallback
              if (this.agentReasoningOptions.length === 0 && this.agentModelSelection) {
                this.agentReasoningOptions = this._getDefaultReasoning(this.agentModelSelection);
              }
              // 현재 선택된 추론 정도가 새 모델에서 지원 안 되면 초기화
              if (this.agentReasoningSelection && !this.agentReasoningOptions.includes(this.agentReasoningSelection)) {
                this.agentReasoningSelection = '';
                this.agentConfigData.reasoning_effort = '';
              }
              // 사무실 뷰 카드에도 반영 (표시명 + 추론레벨 형식)
              this._updateAgentCardLabel(this.agentConfigId);
              this.agentConfigSaveStatus = 'saved';
              this.showToast('모델이 변경되었습니다.', 'success');
            }
          } catch (e) {
            this.agentConfigSaveStatus = 'error';
            this.showToast('모델 변경 실패: ' + (e.message || '서버 연결 오류'), 'error');
          }
          setTimeout(() => { this.agentConfigSaveStatus = ''; }, 2500);
        },

        async saveAgentReasoning() {
          this.agentConfigSaveStatus = 'saving';
          try {
            const res = await fetch(`/api/agents/${this.agentConfigId}/reasoning`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reasoning_effort: this.agentReasoningSelection }),
            }).then(r => r.json());
            if (res.error) {
              this.showToast(res.error, 'error');
              this.agentConfigSaveStatus = 'error';
            } else {
              this.agentConfigData.reasoning_effort = this.agentReasoningSelection;
              // 사무실 뷰 카드에도 반영 (표시명 + 추론레벨 형식)
              this._updateAgentCardLabel(this.agentConfigId);
              this.agentConfigSaveStatus = 'saved';
              this.showToast('추론 정도가 변경되었습니다.', 'success');
            }
          } catch (e) {
            this.agentConfigSaveStatus = 'error';
            this.showToast('추론 정도 변경 실패: ' + (e.message || '서버 연결 오류'), 'error');
          }
          setTimeout(() => { this.agentConfigSaveStatus = ''; }, 2500);
        },

        // ── 헬퍼: 모델별 기본 추론 옵션 ──
        _getDefaultReasoning(modelName) {
          const defaults = {
            'claude-opus-4-6': ['low','medium','high'],
            'claude-sonnet-4-5-20250929': ['low','medium','high'],
            'claude-haiku-4-5-20251001': [],
            'gpt-5-mini': ['low','medium','high'],
            'gpt-5': ['none','low','medium','high'],
            'gpt-5.1': ['none','low','medium','high'],
            'gpt-5.2': ['none','low','medium','high','xhigh'],
            'gpt-5.2-pro': ['medium','high','xhigh'],
            'gemini-3-pro-preview': ['low','high'],
            'gemini-2.5-pro': ['low','medium','high'],
            'gemini-2.5-flash': ['none','low','medium','high'],
          };
          return defaults[modelName] || [];
        },

        // ── 헬퍼: 사무실 뷰 카드에 모델+추론 반영 ──
        _updateAgentCardLabel(agentId) {
          this.agentModels[agentId] = this.agentConfigData?.model_name || '';
          this.agentReasonings[agentId] = this.agentConfigData?.reasoning_effort || '';
        },

        // ── Tab Switching ──

        switchTab(tabId) {
          this.activeTab = tabId;
          if (tabId === 'home' && !this.dashboard.loaded) this.loadDashboard();
          if (tabId === 'performance' && !this.performance.loaded) this.loadPerformance();
          if (tabId === 'history') this.loadTaskHistory();
          if (tabId === 'schedule') this.loadSchedules();
          if (tabId === 'workflow') this.loadWorkflows();
          if (tabId === 'knowledge') this.loadKnowledge();
          if (tabId === 'archive') this.loadArchive();
          if (tabId === 'sns') this.loadSNS();
          if (tabId === 'trading') this.loadTradingSummary();
          if (tabId === 'command') {
            this.$nextTick(() => { this.scrollToBottom(); });
          }
        },

        // ── Dashboard ──

        async loadDashboard() {
          try {
            const [data, budgetRes, qualityRes] = await Promise.all([
              fetch('/api/dashboard').then(r => r.ok ? r.json() : {}),
              fetch('/api/budget').then(r => r.ok ? r.json() : {}),
              fetch('/api/quality').then(r => r.ok ? r.json() : {}),
            ]);
            this.loadModelMode();
            this.dashboard = {
              todayTasks: data.today_task_count || 0,
              todayCompleted: data.today_completed || 0,
              todayFailed: data.today_failed || 0,
              runningCount: data.running_count || 0,
              totalCost: data.total_cost || 0,
              totalTokens: data.total_tokens || 0,
              agentCount: data.agent_count || 0,
              recentCompleted: data.recent_completed || [],
              systemHealth: data.system_health || 'ok',
              apiKeys: data.api_keys || {},
              loaded: true,
            };
            this.budget = budgetRes;
            this.quality = qualityRes;
          } catch (e) { console.error('Dashboard load failed:', e); }
          // 배포 상태도 함께 로드
          this.loadDeployStatus();
        },

        async loadDeployStatus() {
          // 1) 서버의 deploy-status.json 읽기
          try {
            const res = await fetch('/deploy-status.json?t=' + Date.now());
            if (res.ok) {
              const d = await res.json();
              this.deployStatus = { build: d.build, time: d.time, status: d.status || 'success', commit: d.commit || '' };
            } else {
              this.deployStatus.status = 'error';
            }
          } catch (e) {
            this.deployStatus.status = 'error';
          }
          // 2) GitHub Actions API에서 최근 배포 기록 가져오기
          try {
            const res = await fetch('https://api.github.com/repos/kodonghui/CORTHEX_HQ/actions/runs?per_page=5&event=workflow_dispatch');
            if (res.ok) {
              const data = await res.json();
              this.deployLogs = (data.workflow_runs || [])
                .filter(r => r.name === 'Deploy to Oracle Cloud Server')
                .slice(0, 5)
                .map(r => ({
                  id: r.id,
                  number: r.run_number,
                  title: r.display_title,
                  conclusion: r.conclusion || 'in_progress',
                  time: r.created_at,
                }));
            }
          } catch (e) {
            console.error('Deploy logs fetch failed:', e);
          }
        },

        // ── Presets ──

        async loadPresets() {
          try {
            const data = await fetch('/api/presets').then(r => r.json());
            this.presets.items = data || [];
            this.backendPresets = data || [];
          } catch (e) { console.error('Presets load failed:', e); }
        },

        // ── Performance ──

        async loadPerformance() {
          try {
            const data = await fetch('/api/performance').then(r => r.json());
            const agents = data.agents || [];
            const maxCost = Math.max(...agents.map(a => a.cost_usd || 0), 0.0001);
            const totalTasks = agents.reduce((s, a) => s + (a.tasks_completed || 0), 0);
            const rates = agents.filter(a => a.tasks_completed > 0).map(a => a.success_rate || 0);
            const avgRate = rates.length > 0 ? rates.reduce((s, r) => s + r, 0) / rates.length : 0;
            this.performance = {
              agents,
              totalCalls: data.total_llm_calls || 0,
              totalCost: data.total_cost_usd || 0,
              totalTasks,
              avgSuccessRate: avgRate,
              maxCost,
              loaded: true,
            };
          } catch (e) { console.error('Performance load failed:', e); }
        },

        // ── Task History ──

        async loadTaskHistory() {
          try {
            this.taskHistory.loading = true;
            const params = new URLSearchParams();
            if (this.taskHistory.search) params.set('keyword', this.taskHistory.search);
            if (this.taskHistory.filterStatus !== 'all') params.set('status', this.taskHistory.filterStatus);
            if (this.taskHistory.bookmarkOnly) params.set('bookmarked', 'true');
            const resp = await fetch('/api/tasks?' + params.toString());
            if (!resp.ok) throw new Error('API 응답 오류: ' + resp.status);
            const data = await resp.json();
            if (data && data.length > 0) {
              this.taskHistory.items = data;
              this.taskHistory.isSample = false;
            } else {
              this.taskHistory.items = this._getSampleTaskHistory();
              this.taskHistory.isSample = true;
            }
            this.taskHistory.loaded = true;
            this.taskHistory.error = null;
          } catch (e) {
            console.error('Task history load failed:', e);
            this.taskHistory.error = e.message || '데이터를 불러올 수 없습니다';
            if (this.taskHistory.items.length === 0) {
              this.taskHistory.items = this._getSampleTaskHistory();
              this.taskHistory.isSample = true;
            }
            this.taskHistory.loaded = true;
          } finally {
            this.taskHistory.loading = false;
          }
        },

        _getSampleTaskHistory() {
          const now = Date.now();
          return [
            { task_id: 'sample_1', command: '@CTO 이번 주 기술 현황 리포트 작성해줘', status: 'completed', created_at: new Date(now - 3600000).toISOString(), summary: '기술 현황 리포트 완료 — 서버 가동률 99.7%, 응답 시간 평균 120ms', time_seconds: 12.4, cost: 0.0156, bookmarked: true, correlation_id: null },
            { task_id: 'sample_2', command: '전 부서 일일 업무 현황 보고', status: 'completed', created_at: new Date(now - 7200000).toISOString(), summary: '29개 에이전트의 일일 업무 현황을 종합했습니다', time_seconds: 28.7, cost: 0.0423, bookmarked: false, correlation_id: 'corr_sample_1' },
            { task_id: 'sample_3', command: '@CMO 경쟁사 마케팅 전략 분석', status: 'completed', created_at: new Date(now - 14400000).toISOString(), summary: '주요 경쟁사 3곳의 마케팅 전략을 비교 분석했습니다', time_seconds: 45.2, cost: 0.0687, bookmarked: false, correlation_id: null },
            { task_id: 'sample_4', command: '@CFO 이번 달 예산 집행 현황 정리', status: 'failed', created_at: new Date(now - 21600000).toISOString(), summary: '예산 데이터 소스 접근 실패 — API 키 만료', time_seconds: 3.1, cost: 0.0012, bookmarked: false, correlation_id: null },
            { task_id: 'sample_5', command: '@CLO 개인정보처리방침 최신 법령 반영 검토', status: 'completed', created_at: new Date(now - 43200000).toISOString(), summary: '2026년 2월 기준 개인정보보호법 개정사항 3건을 반영했습니다', time_seconds: 67.8, cost: 0.0934, bookmarked: true, correlation_id: 'corr_sample_2' },
            { task_id: 'sample_6', command: '@CSO 보안 취약점 스캔 실행', status: 'running', created_at: new Date(now - 300000).toISOString(), summary: '시스템 보안 취약점을 스캔하고 있습니다...', time_seconds: null, cost: 0.0045, bookmarked: false, correlation_id: null },
          ];
        },

        async loadTaskDetail(taskId) {
          try {
            const data = await fetch(`/api/tasks/${taskId}`).then(r => r.json());
            const task = this.taskHistory.items.find(t => t.task_id === taskId);
            if (task) {
              task._fullResult = data.result_data || '';
              task.correlation_id = data.correlation_id || '';
            }
          } catch (e) { console.error('Task detail load failed:', e); }
        },

        async toggleBookmark(taskId) {
          try {
            const res = await fetch(`/api/tasks/${taskId}/bookmark`, { method: 'POST' }).then(r => r.json());
            const task = this.taskHistory.items.find(t => t.task_id === taskId);
            if (task) task.bookmarked = res.bookmarked;
          } catch (e) { console.error('Bookmark toggle failed:', e); }
        },

        async deleteTask(taskId) {
          if (!confirm('이 작업 기록을 삭제하시겠습니까?')) return;
          try {
            await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
            this.taskHistory.items = this.taskHistory.items.filter(t => t.task_id !== taskId);
            this.showToast('작업 기록 삭제됨', 'success');
          } catch (e) { this.showToast('삭제 실패', 'error'); }
        },

        toggleTaskSelect(taskId) {
          const idx = this.taskHistory.selectedIds.indexOf(taskId);
          if (idx >= 0) {
            this.taskHistory.selectedIds.splice(idx, 1);
          } else {
            if (this.taskHistory.selectedIds.length >= 2) this.taskHistory.selectedIds.shift();
            this.taskHistory.selectedIds.push(taskId);
          }
        },

        async openComparison() {
          if (this.taskHistory.selectedIds.length !== 2) return;
          try {
            const [a, b] = await Promise.all(
              this.taskHistory.selectedIds.map(id => fetch(`/api/tasks/${id}`).then(r => r.json()))
            );
            this.taskHistory.compareA = a;
            this.taskHistory.compareB = b;
            this.taskHistory.compareMode = true;
          } catch (e) { console.error('Comparison load failed:', e); }
        },

        async loadReplay(correlationId, taskId) {
          if (this.taskHistory.replayData[taskId]) {
            this.taskHistory.replayData[taskId] = null;
            return;
          }
          try {
            const data = await fetch(`/api/replay/${correlationId}`).then(r => r.json());
            this.taskHistory.replayData[taskId] = data;
          } catch (e) { console.error('Replay load failed:', e); }
        },

        renderReplayTree(data) {
          if (!data || !data.root) return '<div class="text-xs text-hq-muted">데이터 없음</div>';
          const renderNode = (node, depth = 0) => {
            const indent = depth * 16;
            const icon = node.type === 'task_request' ? '→' : '←';
            const color = node.success === false ? 'text-hq-red' : node.type === 'task_result' ? 'text-hq-green' : 'text-hq-cyan';
            let html = `<div style="margin-left:${indent}px" class="py-1 text-[11px]">`;
            html += `<span class="${color} font-semibold">${icon} ${node.sender_id || ''}</span>`;
            html += `<span class="text-hq-muted ml-1">${(node.detail || node.summary || '').substring(0, 100)}</span>`;
            if (node.time) html += `<span class="text-hq-muted/80 ml-1 font-mono">${node.time}s</span>`;
            html += '</div>';
            if (node.children) {
              for (const child of node.children) {
                html += renderNode(child, depth + 1);
              }
            }
            return html;
          };
          return renderNode(data.root);
        },

        // ── Memory (에이전트 기억) ──

        async openMemoryModal(agentId, agentName) {
          this.memoryModal.agentId = agentId;
          this.memoryModal.agentName = agentName;
          this.memoryModal.newKey = '';
          this.memoryModal.newValue = '';
          this.memoryModal.visible = true;
          await this.loadMemory(agentId);
        },

        async loadMemory(agentId) {
          try {
            const data = await fetch(`/api/memory/${agentId}`).then(r => r.json());
            this.memoryModal.items = Array.isArray(data) ? data : [];
          } catch (e) { this.memoryModal.items = []; }
        },

        async addMemory() {
          const key = this.memoryModal.newKey.trim();
          const value = this.memoryModal.newValue.trim();
          if (!key || !value) return;
          try {
            await fetch(`/api/memory/${this.memoryModal.agentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ key, value }),
            });
            this.memoryModal.newKey = '';
            this.memoryModal.newValue = '';
            await this.loadMemory(this.memoryModal.agentId);
          } catch (e) { console.error('Add memory failed:', e); }
        },

        async deleteMemory(memoryId) {
          try {
            await fetch(`/api/memory/${this.memoryModal.agentId}/${memoryId}`, { method: 'DELETE' });
            await this.loadMemory(this.memoryModal.agentId);
          } catch (e) { console.error('Delete memory failed:', e); }
        },

        // ── Schedules ──

        async loadSchedules() {
          try {
            const data = await fetch('/api/schedules').then(r => r.json());
            this.schedules.items = (Array.isArray(data) ? data : data.schedules || []).map(s => ({
              ...s, id: s.id || s.schedule_id, cron_label: s.cron_preset || s.cron || '',
            }));
          } catch (e) { this.schedules.items = []; }
        },

        async addSchedule() {
          const name = this.schedules.editName.trim();
          const command = this.schedules.editCommand.trim();
          const cron_preset = this.schedules.editCronPreset;
          if (!name || !command) return;
          try {
            await fetch('/api/schedules', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, command, cron_preset }),
            });
            this.schedules.editName = '';
            this.schedules.editCommand = '';
            this.schedules.showModal = false;
            await this.loadSchedules();
          } catch (e) { console.error('Add schedule failed:', e); }
        },

        async toggleSchedule(id) {
          try {
            await fetch(`/api/schedules/${id}/toggle`, { method: 'POST' });
            await this.loadSchedules();
          } catch (e) { console.error('Toggle schedule failed:', e); }
        },

        async deleteSchedule(id) {
          try {
            await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
            await this.loadSchedules();
          } catch (e) { console.error('Delete schedule failed:', e); }
        },

        // ── Workflows ──

        async loadWorkflows() {
          try {
            const data = await fetch('/api/workflows').then(r => r.json());
            this.workflows.items = (Array.isArray(data) ? data : data.workflows || []).map(w => ({
              ...w, id: w.id || w.workflow_id,
            }));
          } catch (e) { this.workflows.items = []; }
        },

        editWorkflow(wf) {
          this.workflows.editing = wf.id || wf.workflow_id;
          this.workflows.editName = wf.name;
          this.workflows.editDesc = wf.description || '';
          this.workflows.editSteps = wf.steps.map(s => ({ ...s }));
          this.workflows.showEditor = true;
        },

        async saveWorkflow() {
          const name = this.workflows.editName.trim();
          if (!name || this.workflows.editSteps.length === 0) return;
          const body = {
            name,
            description: this.workflows.editDesc,
            steps: this.workflows.editSteps.filter(s => s.command.trim()),
          };
          try {
            if (this.workflows.editing) {
              await fetch(`/api/workflows/${this.workflows.editing}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
              });
            } else {
              await fetch('/api/workflows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
              });
            }
            this.workflows.showEditor = false;
            await this.loadWorkflows();
          } catch (e) { console.error('Save workflow failed:', e); }
        },

        async deleteWorkflow(id) {
          try {
            await fetch(`/api/workflows/${id}`, { method: 'DELETE' });
            await this.loadWorkflows();
          } catch (e) { console.error('Delete workflow failed:', e); }
        },

        async runWorkflow(id) {
          this.workflows.runningId = id;
          try {
            await fetch(`/api/workflows/${id}/run`, { method: 'POST' });
          } catch (e) { console.error('Run workflow failed:', e); }
          finally { setTimeout(() => { this.workflows.runningId = null; }, 2000); }
        },

        // ── Auth (인증) ──

        async checkAuth() {
          try {
            const token = localStorage.getItem('corthex_token');
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
            const data = await fetch('/api/auth/status', { headers }).then(r => r.json());
            this.auth.bootstrapMode = data.bootstrap_mode;
            if (data.authenticated) {
              this.auth.role = data.role || 'ceo';
              this.auth.showLogin = false;
              if (token) {
                this.auth.token = token;
                const userJson = localStorage.getItem('corthex_user');
                if (userJson) this.auth.user = JSON.parse(userJson);
              }
              return;
            }
            // 인증 실패
            localStorage.removeItem('corthex_token');
            localStorage.removeItem('corthex_user');
            this.auth.showLogin = true;
          } catch (e) {
            this.auth.bootstrapMode = true;
            this.auth.role = 'ceo';
          }
        },

        async doLogin() {
          this.auth.loginError = '';
          const password = this.auth.loginPass.trim();
          if (!password) { this.auth.loginError = '비밀번호를 입력하세요'; return; }
          try {
            const data = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password }),
            }).then(r => r.json());
            if (data.success) {
              localStorage.setItem('corthex_token', data.token);
              localStorage.setItem('corthex_user', JSON.stringify(data.user || {role:'ceo'}));
              this.auth.token = data.token;
              this.auth.user = data.user || {role:'ceo'};
              this.auth.role = 'ceo';
              this.auth.showLogin = false;
              this.auth.loginPass = '';
              this.showToast('로그인 성공', 'success');
            } else {
              this.auth.loginError = data.error || '로그인 실패';
            }
          } catch (e) { this.auth.loginError = '서버 연결 오류'; }
        },

        async doLogout() {
          try {
            const token = localStorage.getItem('corthex_token');
            if (token) {
              await fetch('/api/auth/logout', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
              });
            }
          } catch (e) { /* 무시 */ }
          localStorage.removeItem('corthex_token');
          localStorage.removeItem('corthex_user');
          this.auth.token = null;
          this.auth.user = null;
          this.auth.role = 'viewer';
          if (!this.auth.bootstrapMode) {
            this.auth.showLogin = true;
          }
          this.showToast('로그아웃 되었습니다', 'info');
        },

        // ── Dynamic Loading ──
        async loadAgentsAndTools() {
          try {
            const [agents, tools] = await Promise.all([
              fetch('/api/agents').then(r => r.ok ? r.json() : []),
              fetch('/api/tools').then(r => r.ok ? r.json() : []),
            ]);
            // 대시보드 통계 카드용 배열 저장
            this.agentsList = Array.isArray(agents) ? agents : [];
            this.toolsList = Array.isArray(tools) ? tools : [];
            if (Array.isArray(agents) && agents.length > 0) {
              agents.forEach(a => {
                this.agentNames[a.agent_id] = a.name_ko || a.agent_id;
                const nameKo = a.name_ko || a.agent_id;
                this.agentInitials[a.agent_id] = nameKo.length >= 2 ? nameKo.substring(0, 2) : nameKo.toUpperCase();
                this.agentRoles[a.agent_id] = a.role || '';
                // 모델 원본 이름과 추론 레벨 저장 (내부 데이터용)
                this.agentModelRaw[a.agent_id] = a.model_name || '';
                this.agentReasonings[a.agent_id] = a.reasoning_effort || '';
                // 에이전트 카드에 "표시명 (추론레벨)" 형식으로 표시
                const displayName = this.getModelDisplayName(a.model_name || '');
                const re = a.reasoning_effort || '';
                this.agentModels[a.agent_id] = re ? `${displayName} (${re})` : displayName;
                if (a.division) {
                  const divMap = { '비서실': 'secretary', '기술개발처': 'tech', '사업기획처': 'strategy',
                                   '법무처': 'legal', '마케팅처': 'marketing', '투자분석처': 'finance',
                                   '출판기록처': 'publishing', '출판처': 'publishing' };
                  this.agentDivision[a.agent_id] = divMap[a.division] || a.division;
                }
              });
            }
          } catch (e) {
            console.warn('에이전트/도구 동적 로딩 실패, 하드코딩 사용:', e);
          }
        },

        async loadConversation() {
          try {
            const res = await fetch('/api/conversation');
            if (!res.ok) return;
            const messages = await res.json();
            if (Array.isArray(messages) && messages.length > 0) {
              this.messages = messages;
              // 복원 후 스크롤 — 마크다운 렌더링 시간까지 고려하여 여러 번 시도
              this.$nextTick(() => this.scrollToBottom());
              setTimeout(() => this.scrollToBottom(), 200);
              setTimeout(() => this.scrollToBottom(), 500);
              setTimeout(() => this.scrollToBottom(), 1000);
              setTimeout(() => this.scrollToBottom(), 2000);
            }
          } catch (e) {
            console.warn('대화 기록 복원 실패:', e);
          }
        },

        async sendFeedback(msg, rating) {
          // 토글 로직: 같은 버튼 다시 누르면 취소, 다른 버튼 누르면 변경
          let action = 'send';
          let previous_rating = null;

          if (msg.feedbackSent && msg.feedbackRating === rating) {
            // 같은 버튼 다시 클릭 → 피드백 취소
            action = 'cancel';
          } else if (msg.feedbackSent && msg.feedbackRating !== rating) {
            // 다른 버튼 클릭 → 피드백 변경
            action = 'change';
            previous_rating = msg.feedbackRating;
          }

          try {
            const res = await fetch('/api/feedback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                correlation_id: msg.task_id || '',
                rating,
                action,
                previous_rating,
                agent_id: msg.sender_id || '',
              }),
            });
            const data = await res.json();
            if (data.success) {
              if (action === 'cancel') {
                // 취소: 피드백 상태 초기화
                msg.feedbackSent = false;
                msg.feedbackRating = null;
                this.showToast('피드백을 취소했습니다.', 'success');
              } else {
                // 보내기 또는 변경
                msg.feedbackSent = true;
                msg.feedbackRating = rating;
                if (action === 'change') {
                  this.showToast(rating === 'good' ? '긍정 피드백으로 변경했습니다.' : '부정 피드백으로 변경했습니다.', 'success');
                } else {
                  this.showToast(rating === 'good' ? '긍정 피드백을 보냈습니다.' : '부정 피드백을 보냈습니다.', 'success');
                }
              }
            } else {
              this.showToast(data.error || '피드백 전송 실패', 'error');
            }
          } catch {
            this.showToast('피드백 전송에 실패했습니다.', 'error');
          }
        },

        async loadHealth() {
          try {
            const res = await fetch('/api/health');
            if (res.ok) this.healthData = await res.json();
          } catch { /* 무시 */ }
        },

        // ── Preset Management (웰컴화면용) ──
        async addPreset() {
          const name = this.newPresetName.trim();
          const command = this.newPresetCommand.trim();
          if (!name || !command) { this.showToast('이름과 명령어를 모두 입력하세요.', 'warning'); return; }
          try {
            const res = await fetch('/api/presets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, command }),
            });
            const data = await res.json();
            if (data.success) {
              this.showAddPreset = false;
              this.newPresetName = '';
              this.newPresetCommand = '';
              this.showToast('프리셋이 추가되었습니다.', 'success');
              await this.loadPresets();
            } else {
              this.showToast(data.error || '프리셋 추가 실패', 'error');
            }
          } catch { this.showToast('프리셋 추가에 실패했습니다.', 'error'); }
        },

        async deletePreset(name) {
          try {
            const res = await fetch(`/api/presets/${encodeURIComponent(name)}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
              this.showToast(`프리셋 '${name}'이 삭제되었습니다.`, 'success');
              await this.loadPresets();
            } else {
              this.showToast(data.error || '프리셋 삭제 실패', 'error');
            }
          } catch { this.showToast('프리셋 삭제에 실패했습니다.', 'error'); }
        },

        // ── Knowledge Management ──
        async loadKnowledge() {
          this.knowledge.loading = true;
          try {
            const res = await fetch('/api/knowledge');
            if (res.ok) {
              const data = await res.json();
              this.knowledge.files = data.entries || data || [];
            }
          } catch { this.showToast('지식 파일 목록을 불러올 수 없습니다.', 'error'); }
          finally { this.knowledge.loading = false; }
        },

        async selectKnowledgeFile(file) {
          this.knowledge.selectedFile = file;
          this.knowledge.editMode = false;
          try {
            const res = await fetch(`/api/knowledge/${encodeURIComponent(file.folder)}/${encodeURIComponent(file.filename)}`);
            if (res.ok) {
              const data = await res.json();
              this.knowledge.content = data.content || '';
            }
          } catch { this.showToast('파일 내용을 불러올 수 없습니다.', 'error'); }
        },

        async saveKnowledge() {
          if (!this.knowledge.selectedFile) return;
          this.knowledge.saving = true;
          try {
            const res = await fetch('/api/knowledge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ folder: this.knowledge.selectedFile.folder, filename: this.knowledge.selectedFile.filename, content: this.knowledge.content }),
            });
            const data = await res.json();
            if (data.success) {
              this.showToast('파일이 저장되었습니다.', 'success');
              this.knowledge.editMode = false;
            } else { this.showToast(data.error || '저장 실패', 'error'); }
          } catch { this.showToast('파일 저장에 실패했습니다.', 'error'); }
          finally { this.knowledge.saving = false; }
        },

        async deleteKnowledge() {
          if (!this.knowledge.selectedFile) return;
          const f = this.knowledge.selectedFile;
          try {
            const res = await fetch(`/api/knowledge/${encodeURIComponent(f.folder)}/${encodeURIComponent(f.filename)}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
              this.knowledge.files = this.knowledge.files.filter(x => x.folder !== f.folder || x.filename !== f.filename);
              this.knowledge.selectedFile = null;
              this.knowledge.content = '';
              this.showToast('파일이 삭제되었습니다.', 'success');
            } else { this.showToast(data.error || '삭제 실패', 'error'); }
          } catch { this.showToast('파일 삭제에 실패했습니다.', 'error'); }
        },

        async createKnowledgeFile() {
          const folder = this.knowledge.newFolder.trim() || 'general';
          const filename = this.knowledge.newFileName.trim();
          if (!filename) { this.showToast('파일명을 입력하세요.', 'warning'); return; }
          try {
            const res = await fetch('/api/knowledge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ folder, filename, content: '' }),
            });
            const data = await res.json();
            if (data.success) {
              await this.loadKnowledge();
              this.knowledge.showCreateForm = false;
              this.knowledge.newFolder = '';
              this.knowledge.newFileName = '';
              this.showToast('파일이 생성되었습니다.', 'success');
            } else { this.showToast(data.error || '생성 실패', 'error'); }
          } catch { this.showToast('파일 생성에 실패했습니다.', 'error'); }
        },

        // ── Archive Browser ──
        async loadArchive() {
          this.archive.content = '';
          this.archive.selectedReport = null;
          this.archive.loading = true;
          try {
            const res = await fetch('/api/archive');
            if (res.ok) this.archive.files = await res.json();
          } catch { this.showToast('아카이브를 불러올 수 없습니다.', 'error'); }
          finally { this.archive.loading = false; }
        },

        async readArchiveReport(file) {
          this.archive.selectedReport = file;
          try {
            const res = await fetch(`/api/archive/${encodeURIComponent(file.division)}/${encodeURIComponent(file.filename)}`);
            if (res.ok) {
              const data = await res.json();
              this.archive.content = data.content || '';
            }
          } catch { this.showToast('보고서를 불러올 수 없습니다.', 'error'); }
        },

        async searchArchiveByCorrelation() {
          const id = this.archive.searchCorrelation.trim();
          if (!id) return;
          try {
            const res = await fetch(`/api/archive/by-correlation/${encodeURIComponent(id)}`);
            if (res.ok) {
              const data = await res.json();
              if (Array.isArray(data) && data.length > 0) {
                this.archive.content = data.map(d => `### ${d.division}/${d.filename}\n\n${d.content}`).join('\n\n---\n\n');
                this.archive.selectedReport = { filename: `검색: ${id}` };
              } else {
                this.showToast('해당 작업 ID의 보고서를 찾을 수 없습니다.', 'warning');
              }
            }
          } catch { this.showToast('검색에 실패했습니다.', 'error'); }
        },

        // ── SNS Management ──
        async loadSNS() {
          this.sns.loading = true;
          try {
            const [status, oauth] = await Promise.all([
              fetch('/api/sns/status').then(r => r.ok ? r.json() : {}),
              fetch('/api/sns/oauth/status').then(r => r.ok ? r.json() : {}),
            ]);
            this.sns.status = status;
            this.sns.oauthStatus = oauth;
          } catch { /* 무시 */ }
          finally { this.sns.loading = false; }
        },

        async connectPlatform(platform) {
          const platformNames = {instagram:'Instagram',youtube:'YouTube',linkedin:'LinkedIn',tistory:'Tistory',naver_blog:'네이버 블로그',naver_cafe:'네이버 카페',daum_cafe:'다음 카페'};
          const name = platformNames[platform] || platform;
          try {
            const res = await fetch(`/api/sns/auth/${platform}`);
            if (res.ok) {
              const data = await res.json();
              if (data.auth_url) {
                window.open(data.auth_url, '_blank', 'width=600,height=700');
                this.showToast(`${name} 인증 창이 열렸습니다. 인증 완료 후 이 페이지를 새로고침하세요.`, 'info');
              } else {
                this.showToast(`${name} API 키가 설정되지 않았습니다. .env 파일에 해당 플랫폼의 API 키를 추가해주세요.`, 'warning');
              }
            } else {
              this.showToast(`${name} 연결 실패: API 키가 설정되지 않았거나 서버에서 응답이 없습니다. .env 파일을 확인해주세요.`, 'warning');
            }
          } catch { this.showToast(`${name} 연결에 실패했습니다. 서버가 실행 중인지 확인해주세요.`, 'error'); }
        },

        async postInstagramPhoto() {
          if (!this.sns.igImageUrl.trim()) { this.showToast('이미지 URL을 입력하세요.', 'warning'); return; }
          try {
            const res = await fetch('/api/sns/instagram/photo', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image_url: this.sns.igImageUrl, caption: this.sns.igCaption }),
            });
            const data = await res.json();
            data.success ? this.showToast('Instagram 사진이 게시되었습니다.', 'success') : this.showToast(data.error || '게시 실패', 'error');
          } catch { this.showToast('게시에 실패했습니다.', 'error'); }
        },

        async postInstagramReel() {
          if (!this.sns.igVideoUrl.trim()) { this.showToast('비디오 URL을 입력하세요.', 'warning'); return; }
          try {
            const res = await fetch('/api/sns/instagram/reel', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ video_url: this.sns.igVideoUrl, caption: this.sns.igReelCaption }),
            });
            const data = await res.json();
            data.success ? this.showToast('Instagram 릴스가 게시되었습니다.', 'success') : this.showToast(data.error || '게시 실패', 'error');
          } catch { this.showToast('게시에 실패했습니다.', 'error'); }
        },

        async postYouTubeVideo() {
          if (!this.sns.ytFilePath.trim() || !this.sns.ytTitle.trim()) { this.showToast('파일 경로와 제목을 입력하세요.', 'warning'); return; }
          try {
            const res = await fetch('/api/sns/youtube/upload', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                file_path: this.sns.ytFilePath, title: this.sns.ytTitle, description: this.sns.ytDesc,
                tags: this.sns.ytTags.split(',').map(t => t.trim()).filter(Boolean), privacy: this.sns.ytPrivacy,
              }),
            });
            const data = await res.json();
            data.success ? this.showToast('YouTube 업로드가 완료되었습니다.', 'success') : this.showToast(data.error || '업로드 실패', 'error');
          } catch { this.showToast('업로드에 실패했습니다.', 'error'); }
        },

        async loadSNSQueue() {
          this.sns.loading = true;
          try {
            const res = await fetch('/api/sns/queue');
            if (res.ok) this.sns.queue = await res.json();
          } catch { /* 무시 */ }
          finally { this.sns.loading = false; }
        },

        async approveSNS(id) {
          try {
            const res = await fetch(`/api/sns/approve/${id}`, { method: 'POST' });
            const data = await res.json();
            if (!data.error) {
              this.showToast('승인되었습니다.', 'success');
              this.loadSNSQueue();
            } else { this.showToast(data.error, 'error'); }
          } catch { this.showToast('승인에 실패했습니다.', 'error'); }
        },

        async rejectSNS(id) {
          try {
            const res = await fetch(`/api/sns/reject/${id}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reason: this.sns.rejectReason }),
            });
            const data = await res.json();
            if (!data.error) {
              this.showToast('거절되었습니다.', 'success');
              this.sns.rejectingId = null;
              this.sns.rejectReason = '';
              this.loadSNSQueue();
            } else { this.showToast(data.error, 'error'); }
          } catch { this.showToast('거절에 실패했습니다.', 'error'); }
        },

        async loadSNSEvents() {
          this.sns.loading = true;
          try {
            const res = await fetch('/api/sns/events?limit=50');
            if (res.ok) {
              const data = await res.json();
              this.sns.events = data.events || [];
            }
          } catch { /* 무시 */ }
          finally { this.sns.loading = false; }
        },

        // ── Trading (자동매매 시스템) 함수 ──
        async deleteSignal(signalId) {
          if (!confirm('이 시그널을 삭제하시겠습니까?')) return;
          try {
            const resp = await fetch(`/api/trading/signals/${signalId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
              this.trading.signals = this.trading.signals.filter(s => s.id !== signalId);
              this.showToast('시그널이 삭제되었습니다.', 'success');
            } else {
              this.showToast(data.error || '삭제 실패', 'error');
            }
          } catch (e) {
            console.error('Signal delete error:', e);
            this.showToast('시그널 삭제 중 오류가 발생했습니다.', 'error');
          }
        },

        async loadTradingSummary() {
          this.trading.loading = true;
          try {
            const [summary, portfolio, strategies, watchlist, history, signals] = await Promise.all([
              fetch('/api/trading/summary').then(r => r.ok ? r.json() : {}),
              fetch('/api/trading/portfolio').then(r => r.ok ? r.json() : {}),
              fetch('/api/trading/strategies').then(r => r.ok ? r.json() : []),
              fetch('/api/trading/watchlist').then(r => r.ok ? r.json() : []),
              fetch('/api/trading/history').then(r => r.ok ? r.json() : []),
              fetch('/api/trading/signals').then(r => r.ok ? r.json() : []),
            ]);
            this.trading.summary = summary;
            this.trading.portfolio = portfolio;
            this.trading.strategies = Array.isArray(strategies) ? strategies : [];
            this.trading.watchlist = Array.isArray(watchlist) ? watchlist : [];
            this.trading.history = Array.isArray(history) ? history : [];
            this.trading.signals = Array.isArray(signals) ? signals : [];
            this.trading.botActive = summary.bot_active || false;
            this.trading.settings = summary.settings || {};
            // 관심종목이 있으면 시세도 자동 조회 (캐시가 비어있을 때만)
            if (this.trading.watchlist.length > 0 && Object.keys(this.trading.watchPrices).length === 0) {
              this.loadWatchlistPrices();
            }
          } catch(e) { console.error('Trading load error:', e); }
          finally { this.trading.loading = false; }
        },

        async tradingOrder() {
          const f = this.trading.orderForm;
          if (!f.ticker || !f.qty || !f.price) { this.showToast('종목코드, 수량, 가격을 입력하세요', 'error'); return; }
          try {
            const res = await fetch('/api/trading/order', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({action: f.action, ticker: f.ticker, name: f.name || f.ticker, qty: parseInt(f.qty), price: parseInt(f.price)}),
            }).then(r => r.json());
            if (res.success) {
              const ko = f.action === 'buy' ? '매수' : '매도';
              this.showToast(`${ko} 완료: ${f.name || f.ticker} ${f.qty}주`, 'success');
              this.trading.showOrderModal = false;
              this.trading.orderForm = {action:'buy', ticker:'', name:'', qty:0, price:0};
              await this.loadTradingSummary();
            } else { this.showToast(res.error || '주문 실패', 'error'); }
          } catch { this.showToast('주문 실행 오류', 'error'); }
        },

        async addTradingStrategy() {
          const f = this.trading.strategyForm;
          if (!f.name) { this.showToast('전략 이름을 입력하세요', 'error'); return; }
          try {
            const tickers = f.target_tickers ? f.target_tickers.split(',').map(t => t.trim()).filter(Boolean) : [];
            const res = await fetch('/api/trading/strategies', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({...f, target_tickers: tickers}),
            }).then(r => r.json());
            if (res.success) {
              this.showToast(`전략 저장: ${f.name}`, 'success');
              this.trading.showStrategyModal = false;
              this.trading.strategyForm = {name:'', type:'rsi', indicator:'RSI', buy_condition:'RSI < 30', sell_condition:'RSI > 70', target_tickers:'', stop_loss_pct:-5, take_profit_pct:10, order_size:1000000};
              await this.loadTradingSummary();
            } else { this.showToast(res.error || '전략 저장 실패', 'error'); }
          } catch { this.showToast('전략 저장 오류', 'error'); }
        },

        async deleteTradingStrategy(id) {
          try {
            await fetch(`/api/trading/strategies/${id}`, {method:'DELETE'});
            await this.loadTradingSummary();
            this.showToast('전략 삭제됨', 'success');
          } catch { this.showToast('삭제 실패', 'error'); }
        },

        async toggleTradingStrategy(id) {
          try {
            await fetch(`/api/trading/strategies/${id}/toggle`, {method:'PUT'});
            await this.loadTradingSummary();
          } catch { this.showToast('토글 실패', 'error'); }
        },

        async addWatchlistItem() {
          const f = this.trading.watchForm;
          if (!f.ticker) { this.showToast('종목코드를 입력하세요', 'error'); return; }
          try {
            const res = await fetch('/api/trading/watchlist', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify(f),
            }).then(r => r.json());
            if (res.success) {
              this.showToast(`관심종목 추가: ${f.name || f.ticker}`, 'success');
              this.trading.showWatchModal = false;
              this.trading.watchForm = {ticker:'', name:'', target_price:0, notes:'', market:'KR'};
              await this.loadTradingSummary();
              this.loadWatchlistPrices();  // 새 종목 가격도 바로 조회
            } else { this.showToast(res.error || '추가 실패', 'error'); }
          } catch { this.showToast('관심종목 추가 오류', 'error'); }
        },

        async removeWatchlistItem(ticker) {
          try {
            await fetch(`/api/trading/watchlist/${ticker}`, {method:'DELETE'});
            delete this.trading.watchPrices[ticker];
            await this.loadTradingSummary();
            this.showToast('관심종목 삭제됨', 'success');
          } catch { this.showToast('삭제 실패', 'error'); }
        },

        // 관심종목 실시간 가격 조회
        async loadWatchlistPrices() {
          if (this.trading.watchlist.length === 0) return;
          this.trading.watchPricesLoading = true;
          try {
            const res = await fetch('/api/trading/watchlist/prices').then(r => r.ok ? r.json() : {prices:{}});
            this.trading.watchPrices = res.prices || {};
            if (res.updated_at) {
              const d = new Date(res.updated_at);
              this.trading.watchPricesUpdatedAt = d.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'});
            }
          } catch(e) { console.error('Price load error:', e); }
          finally { this.trading.watchPricesLoading = false; }
        },

        // 종목 차트 열기
        async openWatchlistChart(w) {
          this.trading.chartTicker = w.ticker;
          this.trading.chartName = w.name;
          this.trading.chartMarket = w.market || 'KR';
          this.trading.chartData = [];
          this.trading.chartLoading = true;
          this.trading.showChartModal = true;
          try {
            const res = await fetch(`/api/trading/watchlist/chart/${w.ticker}?market=${w.market||'KR'}&days=30`).then(r => r.ok ? r.json() : {chart:[]});
            this.trading.chartData = res.chart || [];
          } catch(e) { console.error('Chart load error:', e); }
          finally { this.trading.chartLoading = false; }
        },

        // SVG 차트: 선 좌표 계산
        getChartLinePoints() {
          const data = this.trading.chartData;
          if (!data || data.length === 0) return '';
          const closes = data.map(d => d.close);
          const min = Math.min(...closes);
          const max = Math.max(...closes);
          const range = max - min || 1;
          const xStart = 45, xEnd = 550, yStart = 10, yEnd = 170;
          const xStep = (xEnd - xStart) / Math.max(data.length - 1, 1);
          return data.map((d, i) => {
            const x = xStart + i * xStep;
            const y = yEnd - ((d.close - min) / range) * (yEnd - yStart);
            return `${x},${y}`;
          }).join(' ');
        },

        // SVG 차트: 영역(면) 좌표 계산
        getChartAreaPoints() {
          const data = this.trading.chartData;
          if (!data || data.length === 0) return '';
          const closes = data.map(d => d.close);
          const min = Math.min(...closes);
          const max = Math.max(...closes);
          const range = max - min || 1;
          const xStart = 45, xEnd = 550, yStart = 10, yEnd = 170;
          const xStep = (xEnd - xStart) / Math.max(data.length - 1, 1);
          let pts = data.map((d, i) => {
            const x = xStart + i * xStep;
            const y = yEnd - ((d.close - min) / range) * (yEnd - yStart);
            return `${x},${y}`;
          });
          // 아래쪽 닫기
          const lastX = xStart + (data.length - 1) * xStep;
          pts.push(`${lastX},${yEnd}`);
          pts.push(`${xStart},${yEnd}`);
          return pts.join(' ');
        },

        // SVG 차트: Y축 라벨
        getChartYLabel(ratio) {
          const data = this.trading.chartData;
          if (!data || data.length === 0) return '';
          const closes = data.map(d => d.close);
          const min = Math.min(...closes);
          const max = Math.max(...closes);
          const val = min + (max - min) * ratio;
          if (val >= 1000000) return (val / 10000).toFixed(0) + '만';
          if (val >= 1000) return val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          return val.toFixed(2);
        },

        async toggleTradingBot() {
          try {
            const res = await fetch('/api/trading/bot/toggle', {method:'POST'}).then(r => r.json());
            if (res.success) {
              this.trading.botActive = res.bot_active;
              this.showToast(res.bot_active ? 'CIO 자동매매 가동!' : 'CIO 자동매매 중지', res.bot_active ? 'success' : 'info');
            }
          } catch { this.showToast('봇 토글 실패', 'error'); }
        },

        async generateTradingSignals() {
          this.showToast('CIO + 전문가 4명 분석 중... (30초~1분 소요)', 'info');
          try {
            const res = await fetch('/api/trading/signals/generate', {method:'POST'}).then(r => r.json());
            if (res.success) {
              const ps = res.parsed_signals || [];
              const buy = ps.filter(s => s.action === 'buy').length;
              const sell = ps.filter(s => s.action === 'sell').length;
              this.showToast(`CIO 분석 완료! 매수 ${buy}건, 매도 ${sell}건`, 'success');
              await this.loadTradingSummary();
            } else { this.showToast(res.error || '분석 실패', 'error'); }
          } catch { this.showToast('CIO 분석 요청 오류', 'error'); }
        },

        async resetTradingPortfolio() {
          if (!confirm('모의투자를 초기화하시겠습니까? 모든 보유종목과 거래 내역이 삭제됩니다.')) return;
          try {
            const res = await fetch('/api/trading/portfolio/reset', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({initial_cash: parseInt(this.trading.initialCashInput) || 50000000}),
            }).then(r => r.json());
            if (res.success) {
              this.showToast('모의투자 초기화 완료!', 'success');
              await this.loadTradingSummary();
            }
          } catch { this.showToast('초기화 실패', 'error'); }
        },

        async saveTradingSettings() {
          try {
            const res = await fetch('/api/trading/settings', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify(this.trading.settings),
            }).then(r => r.json());
            if (res.success) {
              this.showToast('자동매매 설정 저장됨', 'success');
              this.trading.showSettingsModal = false;
            }
          } catch { this.showToast('설정 저장 실패', 'error'); }
        },

        tradingPnlColor(val) {
          if (val > 0) return 'text-hq-green';
          if (val < 0) return 'text-hq-red';
          return 'text-hq-muted';
        },

        formatKRW(val) {
          if (Math.abs(val) >= 100000000) return (val / 100000000).toFixed(1) + '억';
          if (Math.abs(val) >= 10000) return (val / 10000).toFixed(0) + '만';
          return val.toLocaleString();
        },

        // ── #5: Dynamic Tools Loading ──
        async loadToolsList() {
          try {
            const data = await fetch('/api/tools').then(r => r.ok ? r.json() : []);
            this.toolsList = Array.isArray(data) ? data : [];
          } catch { this.toolsList = []; }
        },

        // ── #7: Feedback Stats ──
        async loadFeedbackStats() {
          try {
            const data = await fetch('/api/feedback').then(r => r.ok ? r.json() : {});
            this.feedbackStats = {
              good: data.good || 0,
              bad: data.bad || 0,
              total: data.total || 0,
              satisfaction_rate: data.total > 0 ? Math.round((data.good / data.total) * 100) : 0,
            };
          } catch { /* 무시 */ }
        },

        // ── #8: Budget Edit ──
        async saveBudget() {
          try {
            const res = await fetch('/api/budget', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ daily_limit: this.budgetEditDaily, monthly_limit: this.budgetEditMonthly }),
            }).then(r => r.json());
            if (res.success) {
              this.budget.daily_limit = res.daily_limit;
              this.budget.monthly_limit = res.monthly_limit;
              this.showBudgetEdit = false;
              this.showToast('예산 한도가 수정되었습니다.', 'success');
            } else {
              this.showToast(res.error || '예산 수정 실패', 'error');
            }
          } catch { this.showToast('예산 수정에 실패했습니다.', 'error'); }
        },

        // ── Model Mode (자동/수동) ──
        async loadModelMode() {
          try {
            const [res, modelsRes] = await Promise.all([
              fetch('/api/model-mode').then(r => r.json()),
              !this.availableModels.length ? fetch('/api/available-models').then(r => r.json()) : Promise.resolve(null),
            ]);
            this.modelMode = res.mode || 'auto';
            this.modelOverride = res.override || 'claude-sonnet-4-5-20250929';
            if (modelsRes && Array.isArray(modelsRes)) {
              this.availableModels = this.sortModels(modelsRes);
            }
          } catch {}
        },
        async saveModelMode() {
          try {
            await fetch('/api/model-mode', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mode: this.modelMode }),
            });
            const label = this.modelMode === 'auto' ? '자동 모드 (질문에 따라 자동 선택)' : '수동 모드 (에이전트별 개별 모델)';
            this.showToast(label, 'success');
          } catch { this.showToast('모델 모드 변경 실패', 'error'); }
        },

        async applyBulkModel() {
          if (!this.bulkModelSelection) return;
          const displayName = this.getModelDisplayName(this.bulkModelSelection);
          const label = this.bulkReasoningSelection ? `${displayName} (${this.bulkReasoningSelection})` : displayName;
          if (!confirm(`29명 전체 에이전트의 모델을 "${label}"(으)로 변경합니다.\n\n정말 진행할까요?`)) return;
          this.bulkModelSaving = true;
          try {
            const res = await fetch('/api/agents/bulk-model', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model_name: this.bulkModelSelection, reasoning_effort: this.bulkReasoningSelection }),
            }).then(r => r.json());
            if (res.error) {
              this.showToast(res.error, 'error');
            } else {
              // 모든 에이전트 카드 표시 갱신
              for (const a of Object.keys(this.agentModels)) {
                this.agentModelRaw[a] = this.bulkModelSelection;
                this.agentReasonings[a] = this.bulkReasoningSelection;
                this.agentModels[a] = this.bulkReasoningSelection ? `${displayName} (${this.bulkReasoningSelection})` : displayName;
              }
              this.showToast(`${res.changed}명 에이전트 → ${label} 변경 완료`, 'success');
              // 모달이 열려있으면 데이터 재로드
              if (this.showAgentConfig && this.agentConfigId) {
                try {
                  const updatedAgent = await fetch(`/api/agents/${this.agentConfigId}`).then(r => r.json());
                  if (!updatedAgent.error) {
                    this.agentConfigData = updatedAgent;
                    this.agentModelSelection = updatedAgent.model_name || '';
                    this.agentReasoningSelection = updatedAgent.reasoning_effort || '';
                  }
                } catch (e) { /* 무시 */ }
              }
            }
          } catch (e) {
            this.showToast('일괄 변경 실패: ' + (e.message || '서버 연결 오류'), 'error');
          } finally {
            this.bulkModelSaving = false;
          }
        },

        // ── #13: Activity Log Persistence ──
        restoreActivityLogs() {
          try {
            const saved = localStorage.getItem('corthex-activity-logs');
            if (saved) {
              let logs = JSON.parse(saved);
              // 자동 정리: 7일 이상 된 로그 삭제, 최대 50개 유지
              const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
              logs = logs.filter(l => !l.timestamp || l.timestamp > sevenDaysAgo);
              this.activityLogs = logs.slice(-50);
            }
          } catch { /* 무시 */ }
        },
        saveActivityLogs() {
          try {
            localStorage.setItem('corthex-activity-logs', JSON.stringify(this.activityLogs.slice(-100)));
          } catch { /* 무시 */ }
        },

        // ── #14: Task History Pagination ──
        getPagedTaskHistory() {
          const end = this.taskHistoryPage * this.taskHistoryPageSize;
          return this.taskHistory.items.slice(0, end);
        },
        getGroupedTaskHistory() {
          const items = this.getPagedTaskHistory();
          const groups = [];
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          let currentLabel = '';
          let currentGroup = null;
          for (const task of items) {
            const d = new Date(task.created_at);
            d.setHours(0, 0, 0, 0);
            let label;
            if (d.getTime() === today.getTime()) label = '오늘';
            else if (d.getTime() === yesterday.getTime()) label = '어제';
            else label = d.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', month: 'long', day: 'numeric' });
            if (label !== currentLabel) {
              currentLabel = label;
              currentGroup = { label, items: [] };
              groups.push(currentGroup);
            }
            currentGroup.items.push(task);
          }
          return groups;
        },
        loadMoreTasks() {
          this.taskHistoryPage++;
        },
        hasMoreTasks() {
          return this.taskHistoryPage * this.taskHistoryPageSize < this.taskHistory.items.length;
        },

        // ── #15: Conversation Export ──
        exportConversation() {
          let md = '# CORTHEX HQ 대화 기록\n\n';
          md += `날짜: ${new Date().toLocaleDateString('ko-KR')}\n\n---\n\n`;
          this.messages.forEach(msg => {
            if (msg.type === 'user') {
              md += `## CEO 명령\n\n${msg.text}\n\n`;
            } else if (msg.type === 'result') {
              md += `## 결과 (${msg.sender_id || 'system'})\n\n${msg.content || ''}\n\n---\n\n`;
            } else if (msg.type === 'error') {
              md += `## 오류\n\n${msg.text}\n\n`;
            }
          });
          const blob = new Blob([md], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `corthex-대화-${new Date().toISOString().slice(0, 10)}.md`;
          a.click();
          URL.revokeObjectURL(url);
          this.showToast('대화 기록이 다운로드되었습니다.', 'success');
        },

        // ── 대화 비우기 ──
        async clearConversation() {
          if (this.messages.length === 0) return;
          if (!confirm('대화 기록을 모두 삭제하시겠습니까?\n(삭제 후 복구할 수 없습니다)')) return;
          try {
            await fetch('/api/conversation', { method: 'DELETE' });
            this.messages = [];
            this.activeAgents = {};
            this.systemStatus = 'idle';
            this.showToast('대화 기록이 삭제되었습니다.', 'success');
          } catch (e) {
            this.showToast('대화 삭제에 실패했습니다.', 'error');
          }
        },

        // ── #16: Keyboard Shortcuts ──
        initKeyboardShortcuts() {
          document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K → 명령 입력창으로 포커스
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
              e.preventDefault();
              this.activeTab = 'command';
              this.viewMode = 'chat';
              this.$nextTick(() => {
                if (this.$refs.inputArea) this.$refs.inputArea.focus();
                this.scrollToBottom();
              });
              setTimeout(() => this.scrollToBottom(), 300);
            }
            // Esc → 모달 닫기
            if (e.key === 'Escape') {
              if (this.showAgentConfig) { this.showAgentConfig = false; return; }
              if (this.showQualitySettings) { this.showQualitySettings = false; return; }
              if (this.showTaskDetail) { this.showTaskDetail = false; return; }
              if (this.showBudgetEdit) { this.showBudgetEdit = false; return; }
              if (this.taskHistory.compareMode) { this.taskHistory.compareMode = false; return; }
              if (this.memoryModal.visible) { this.memoryModal.visible = false; return; }
            }
          });
        },

        // ── #12: Tab grouping helpers ──
        getPrimaryTabs() {
          return this.tabs.filter(t => ['home', 'command', 'performance', 'history', 'schedule', 'trading'].includes(t.id));
        },
        getSecondaryTabs() {
          return this.tabs.filter(t => !['home', 'command', 'performance', 'history', 'schedule', 'trading'].includes(t.id));
        },

        // ── #4: Publishing division support ──
        getDivisionLabel(division) {
          const labels = {
            'default': '기본 (전체 공통)',
            'secretary': '비서실',
            'leet_master.tech': '기술개발팀 (CTO)',
            'leet_master.strategy': '전략기획팀 (CSO)',
            'leet_master.legal': '법무팀 (CLO)',
            'leet_master.marketing': '마케팅팀 (CMO)',
            'finance.investment': '금융분석팀 (CIO)',
            'publishing': '콘텐츠팀 (CPO)',
          };
          return labels[division] || division;
        },

        // 에이전트 직급 분류
        getAgentTier(agentId) {
          if (!agentId) return 'unknown';
          const executives = ['chief_of_staff','cto_manager','cso_manager','clo_manager','cmo_manager','cio_manager','cpo_manager'];
          const staffList = ['report_specialist','schedule_specialist','relay_specialist'];
          if (executives.includes(agentId)) return 'executive';
          if (staffList.includes(agentId)) return 'staff';
          if (agentId.includes('specialist') || agentId.includes('_specialist')) return 'specialist';
          return 'specialist';
        },

        getAgentTierLabel(agentId) {
          const tier = this.getAgentTier(agentId);
          if (tier === 'executive') return '임원급';
          if (tier === 'staff') return '보좌관급';
          return '전문가급';
        },

        // 기밀문서 카드용: agent_id → 한글 이름
        getArchiveAuthor(agentId) {
          if (!agentId) return '알 수 없음';
          return this.agentNames[agentId] || agentId;
        },

        // 기밀문서 카드용: created_at → "2/16 오후 4:36" 형태
        formatArchiveDate(dateStr) {
          if (!dateStr) return '';
          try {
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const h = d.getHours();
            const min = String(d.getMinutes()).padStart(2, '0');
            const ampm = h < 12 ? '오전' : '오후';
            const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
            return `${m}/${day} ${ampm} ${h12}:${min}`;
          } catch { return dateStr; }
        },

        getDivisionStyle(division) {
          const styles = {
            'secretary': { icon: '📋', bg: 'from-amber-500/10 to-orange-500/10' },
            'leet_master.tech': { icon: '💻', bg: 'from-blue-500/10 to-cyan-500/10' },
            'leet_master.strategy': { icon: '📊', bg: 'from-purple-500/10 to-pink-500/10' },
            'leet_master.legal': { icon: '⚖️', bg: 'from-red-500/10 to-rose-500/10' },
            'leet_master.marketing': { icon: '📣', bg: 'from-green-500/10 to-emerald-500/10' },
            'finance.investment': { icon: '💰', bg: 'from-yellow-500/10 to-amber-500/10' },
            'publishing': { icon: '✍️', bg: 'from-indigo-500/10 to-violet-500/10' },
          };
          return styles[division] || { icon: '📌', bg: 'from-gray-500/10 to-slate-500/10' };
        },

        getToolDisplayName(toolId) {
          const t = (this.toolsList || []).find(t => t.tool_id === toolId || t.name === toolId);
          return t?.name_ko || toolId;
        },

        getToolDescription(toolId) {
          const t = (this.toolsList || []).find(t => t.tool_id === toolId || t.name === toolId);
          return t?.description || '';
        },

        // ── SNS platform name mapping (#6) ──
        getSNSPlatformName(platform) {
          const names = {
            'instagram': 'Instagram',
            'youtube': 'YouTube',
            'linkedin': 'LinkedIn',
            'threads': 'Threads',
            'tistory': 'Tistory',
            'naver_blog': '네이버 블로그',
            'naver_cafe': '네이버 카페',
            'daum_cafe': '다음 카페',
          };
          return names[platform] || platform;
        },

        shouldShowDateSeparator(messages, i) {
          if (i === 0) return true;
          const prev = messages[i-1]?.timestamp;
          const curr = messages[i]?.timestamp;
          if (!prev || !curr) return i === 0;
          return new Date(prev).toDateString() !== new Date(curr).toDateString();
        },
        formatDate(ts) {
          if (!ts) return '';
          const d = new Date(ts);
          const days = ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'];
          return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 ${days[d.getDay()]}`;
        },
        formatTime(ts) {
          if (!ts) return '';
          const d = new Date(ts);
          const h = d.getHours();
          const m = d.getMinutes().toString().padStart(2,'0');
          return `${h < 12 ? '오전' : '오후'} ${h % 12 || 12}:${m}`;
        },

        onChatScroll(e) {
          const el = e.target;
          const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 100;
          this.showScrollBtn = !atBottom;
          if (atBottom) this.newMsgCount = 0;
        },
        scrollToBottomSmooth() {
          const el = this.$refs.chatArea;
          if (el) el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
          this.showScrollBtn = false;
          this.newMsgCount = 0;
        },

        scrollToBottom() {
          const el = this.$refs.chatArea || document.getElementById('chatArea');
          if (el) {
            el.scrollTop = el.scrollHeight;
            // 마크다운 렌더링 이후에도 한 번 더
            requestAnimationFrame(() => { el.scrollTop = el.scrollHeight; });
          }
        },
      };
    }
  </script>
</body>
</html>
