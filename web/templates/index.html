<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTHEX HQ - CEO ê´€ì œì‹¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'hq-bg': '#0f172a',
            'hq-panel': '#1e293b',
            'hq-border': '#334155',
            'hq-accent': '#3b82f6',
            'hq-green': '#22c55e',
            'hq-yellow': '#eab308',
            'hq-red': '#ef4444',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
    .progress-bar { transition: width 0.5s ease-in-out; }
    @keyframes float { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-3px); } }
    .agent-working { animation: float 2s ease-in-out infinite; }
    .markdown-body h1 { font-size: 1.25rem; font-weight: 700; margin: 1rem 0 0.5rem; }
    .markdown-body h2 { font-size: 1.1rem; font-weight: 600; margin: 0.8rem 0 0.4rem; }
    .markdown-body h3 { font-size: 1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; }
    .markdown-body p { margin: 0.4rem 0; }
    .markdown-body ul, .markdown-body ol { margin: 0.3rem 0; padding-left: 1.5rem; }
    .markdown-body li { margin: 0.2rem 0; }
    .markdown-body code { background: #334155; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.85rem; }
    .markdown-body pre { background: #0f172a; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
    .markdown-body pre code { background: transparent; padding: 0; }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
    .markdown-body th, .markdown-body td { border: 1px solid #475569; padding: 0.4rem 0.8rem; text-align: left; }
    .markdown-body th { background: #1e293b; }
    .desk-card { transition: all 0.2s; }
    .desk-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(59,130,246,0.15); }
  </style>
</head>

<body class="bg-hq-bg text-gray-200 h-screen flex flex-col overflow-hidden"
      x-data="corthexApp()" x-init="init()">

  <!-- Top Bar -->
  <header class="h-14 bg-hq-panel border-b border-hq-border flex items-center justify-between px-4 shrink-0">
    <div class="flex items-center gap-4">
      <div class="text-xl font-bold tracking-wide">
        <span class="text-hq-accent">CORTHEX</span> <span class="text-gray-400">HQ</span>
      </div>
      <span class="text-xs text-gray-500 border border-hq-border rounded px-2 py-0.5">v0.4.0</span>

      <!-- Tab Navigation -->
      <nav class="flex items-center gap-1 ml-4">
        <button @click="currentTab = 'command'"
                :class="currentTab === 'command' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-gray-400 border-transparent hover:text-gray-300'"
                class="text-sm px-3 py-1.5 rounded-lg border transition font-medium">
          ê´€ì œì‹¤
        </button>
        <button @click="currentTab = 'office'; loadOfficeData()"
                :class="currentTab === 'office' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-gray-400 border-transparent hover:text-gray-300'"
                class="text-sm px-3 py-1.5 rounded-lg border transition font-medium">
          ì‚¬ë¬´ì‹¤
        </button>
        <button @click="currentTab = 'knowledge'; loadKnowledge()"
                :class="currentTab === 'knowledge' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-gray-400 border-transparent hover:text-gray-300'"
                class="text-sm px-3 py-1.5 rounded-lg border transition font-medium">
          ì§€ì‹ê´€ë¦¬
        </button>
      </nav>
    </div>

    <div class="flex items-center gap-6">
      <div class="flex items-center gap-2 text-sm">
        <template x-if="systemStatus === 'idle'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-green"></span>
            <span class="text-gray-400">ëŒ€ê¸°ì¤‘</span>
          </span>
        </template>
        <template x-if="systemStatus === 'working'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
            <span class="text-hq-yellow">ì²˜ë¦¬ì¤‘</span>
          </span>
        </template>
        <template x-if="systemStatus === 'error'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-red"></span>
            <span class="text-hq-red">ì˜¤ë¥˜</span>
          </span>
        </template>
      </div>
      <div class="text-sm text-gray-400">
        <span class="text-gray-500">ë¹„ìš©</span>
        <span class="text-hq-green font-mono ml-1" x-text="'$' + totalCost.toFixed(4)"></span>
      </div>
      <div class="text-sm text-gray-400">
        <span class="text-gray-500">í† í°</span>
        <span class="font-mono ml-1" x-text="totalTokens.toLocaleString()"></span>
      </div>
      <div class="flex items-center gap-1.5 text-xs cursor-pointer" :class="wsConnected ? 'text-hq-green' : 'text-hq-red'"
           @click="if(!wsConnected) { connectWebSocket(); }"
           :title="wsConnected ? 'ì„œë²„ ì—°ê²° ì •ìƒ' : 'í´ë¦­í•˜ì—¬ ì¬ì—°ê²° ì‹œë„'">
        <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
        <span x-text="wsConnected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€ (í´ë¦­: ì¬ì—°ê²°)'"></span>
      </div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB 1: ê´€ì œì‹¤ (Command Center)            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="currentTab === 'command'" class="flex flex-1 overflow-hidden">

    <!-- Left Panel: Org Tree + Activity Log -->
    <aside class="w-72 bg-hq-panel border-r border-hq-border flex flex-col shrink-0">
      <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-1">ì¡°ì§ë„</div>

        <!-- CEO -->
        <div class="mb-1">
          <div class="flex items-center gap-2 px-2 py-1.5 rounded text-sm font-semibold text-white">
            <span class="text-lg">ğŸ‘¤</span> CEO (ë™í¬ ë‹˜)
          </div>
        </div>

        <!-- ë¹„ì„œì‹¤ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('secretary')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.secretary ? 'â–¼' : 'â–¶'"></span>
            <span class="text-yellow-400">ğŸ“‹</span>
            <span>ë¹„ì„œì‹¤</span>
            <span class="ml-auto text-xs" :class="getSectionStatusColor('secretary')"
                  x-text="getSectionStatusText('secretary')"></span>
          </button>
          <div x-show="expanded.secretary" x-collapse class="ml-6 space-y-0.5">
            <template x-for="id in ['chief_of_staff','report_worker','schedule_worker','relay_worker']" :key="id">
              <div class="flex items-center gap-2 px-2 py-0.5 rounded text-xs text-gray-400 hover:bg-white/5 cursor-pointer"
                   @click="currentTab='office'; selectAgent(id)">
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                <span x-text="getAgentName(id)"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- LEET Master ë³¸ë¶€ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('leet_master')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.leet_master ? 'â–¼' : 'â–¶'"></span>
            <span class="text-cyan-400">ğŸ—ï¸</span>
            <span class="text-cyan-400 font-medium">LEET Master ë³¸ë¶€</span>
            <span class="ml-auto text-xs" :class="getSectionStatusColor('leet_master')"
                  x-text="getSectionStatusText('leet_master')"></span>
          </button>
          <div x-show="expanded.leet_master" x-collapse>

            <!-- CTO -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('tech')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.tech ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cto_manager')"></span>
                <span class="text-cyan-400">ê¸°ìˆ ê°œë°œì²˜ (CTO)</span>
              </button>
              <div x-show="expanded.tech" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['cto_manager','frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400 hover:bg-white/5 cursor-pointer rounded"
                       @click="currentTab='office'; selectAgent(id)">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- CSO -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('strategy')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.strategy ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cso_manager')"></span>
                <span class="text-cyan-400">ì‚¬ì—…ê¸°íšì²˜ (CSO)</span>
              </button>
              <div x-show="expanded.strategy" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['cso_manager','market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400 hover:bg-white/5 cursor-pointer rounded"
                       @click="currentTab='office'; selectAgent(id)">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- CLO -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('legal')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.legal ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('clo_manager')"></span>
                <span class="text-cyan-400">ë²•ë¬´Â·IPì²˜ (CLO)</span>
              </button>
              <div x-show="expanded.legal" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['clo_manager','copyright_specialist','patent_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400 hover:bg-white/5 cursor-pointer rounded"
                       @click="currentTab='office'; selectAgent(id)">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- CMO -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('marketing')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.marketing ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cmo_manager')"></span>
                <span class="text-cyan-400">ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ (CMO)</span>
              </button>
              <div x-show="expanded.marketing" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['cmo_manager','survey_specialist','content_specialist','community_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400 hover:bg-white/5 cursor-pointer rounded"
                       @click="currentTab='office'; selectAgent(id)">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- íˆ¬ìë¶„ì„ ë³¸ë¶€ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('investment')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.investment ? 'â–¼' : 'â–¶'"></span>
            <span class="text-purple-400">ğŸ“Š</span>
            <span class="text-purple-400 font-medium">íˆ¬ìë¶„ì„ ë³¸ë¶€</span>
          </button>
          <div x-show="expanded.investment" x-collapse>
            <div class="ml-4 mb-1">
              <button @click="toggleSection('finance')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.finance ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cio_manager')"></span>
                <span class="text-purple-400">íˆ¬ìë¶„ì„ì²˜ (CIO)</span>
              </button>
              <div x-show="expanded.finance" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['cio_manager','market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400 hover:bg-white/5 cursor-pointer rounded"
                       @click="currentTab='office'; selectAgent(id)">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Tool Pool -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('tools')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.tools ? 'â–¼' : 'â–¶'"></span>
            <span class="text-red-400">ğŸ”§</span>
            <span>AgentTool Pool</span>
          </button>
          <div x-show="expanded.tools" x-collapse class="ml-6 space-y-0.5">
            <template x-for="t in ['ë³€ë¦¬ì‚¬','ì„¸ë¬´ì‚¬','ë””ìì´ë„ˆ','ë²ˆì—­ê°€','ì›¹ê²€ìƒ‰']" :key="t">
              <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-500">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                <span x-text="t + ' Tool'"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="h-48 border-t border-hq-border shrink-0">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 pt-2 pb-1">í™œë™ ë¡œê·¸</div>
        <div class="overflow-y-auto scrollbar-thin h-36 px-3 space-y-1">
          <template x-for="(log, i) in activityLogs.slice(-20).reverse()" :key="i">
            <div class="text-[11px] text-gray-500 fade-in">
              <span class="text-gray-600 font-mono" x-text="log.time"></span>
              <span class="text-gray-400" x-text="log.agent_id"></span>
              <span x-text="log.action"></span>
            </div>
          </template>
          <template x-if="activityLogs.length === 0">
            <div class="text-[11px] text-gray-600 italic">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </template>
        </div>
      </div>
    </aside>

    <!-- Right Panel: Chat -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <div class="flex-1 overflow-y-auto scrollbar-thin p-6 space-y-4" x-ref="chatArea">

        <!-- Welcome -->
        <template x-if="messages.length === 0">
          <div class="flex flex-col items-center justify-center h-full text-center">
            <div class="text-5xl mb-4">ğŸ¢</div>
            <h2 class="text-2xl font-bold text-white mb-2">CORTHEX HQ</h2>
            <p class="text-gray-400 mb-6 max-w-md">
              25ëª…ì˜ AI ì—ì´ì „íŠ¸ê°€ ëŒ€ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
              í•œêµ­ì–´ë¡œ ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <div class="flex flex-wrap gap-2 justify-center max-w-lg">
              <button @click="sendPreset('LEET MASTER ì„œë¹„ìŠ¤ì˜ ê¸°ìˆ  ìŠ¤íƒì„ ì œì•ˆí•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ–¥ï¸ ê¸°ìˆ  ìŠ¤íƒ ì œì•ˆ
              </button>
              <button @click="sendPreset('ì‚¼ì„±ì „ì ì£¼ê°€ë¥¼ ë¶„ì„í•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“Š ì£¼ê°€ ë¶„ì„
              </button>
              <button @click="sendPreset('ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ì´ˆì•ˆì„ ë§Œë“¤ì–´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“‹ ì´ìš©ì•½ê´€ ì‘ì„±
              </button>
              <button @click="sendPreset('ë§ˆì¼€íŒ… ì½˜í…ì¸  ì „ëµì„ ìˆ˜ë¦½í•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“£ ë§ˆì¼€íŒ… ì „ëµ
              </button>
            </div>
          </div>
        </template>

        <!-- Messages -->
        <template x-for="(msg, i) in messages" :key="i">
          <div class="fade-in">
            <template x-if="msg.type === 'user'">
              <div class="flex justify-end mb-4">
                <div class="bg-hq-accent/20 border border-hq-accent/30 rounded-2xl rounded-tr-sm px-4 py-3 max-w-2xl">
                  <div class="text-xs text-hq-accent mb-1 font-semibold">CEO</div>
                  <div class="text-gray-200" x-text="msg.text"></div>
                </div>
              </div>
            </template>
            <template x-if="msg.type === 'processing'">
              <div class="mb-4">
                <div class="bg-hq-panel border border-hq-border rounded-2xl rounded-tl-sm px-4 py-3 max-w-3xl">
                  <div class="text-xs text-hq-yellow mb-2 font-semibold flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
                    ì—ì´ì „íŠ¸ ì¡°ì§ì´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...
                  </div>
                  <div class="space-y-2">
                    <template x-for="(status, agentId) in activeAgents" :key="agentId">
                      <div x-show="status.status === 'working'" class="fade-in">
                        <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
                          <span x-text="getAgentName(agentId)"></span>
                          <span x-text="Math.round(status.progress * 100) + '%'"></span>
                        </div>
                        <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                          <div class="h-full bg-hq-accent rounded-full progress-bar"
                               :style="'width:' + (status.progress * 100) + '%'"></div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="msg.type === 'result'">
              <div class="mb-4">
                <div class="bg-hq-panel border border-hq-border rounded-2xl rounded-tl-sm px-5 py-4 max-w-4xl">
                  <div class="flex items-center justify-between mb-3">
                    <div class="text-xs text-hq-green font-semibold flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-hq-green"></span>
                      <span x-text="getAgentName(msg.sender_id) || 'ê²°ê³¼'"></span>
                    </div>
                    <div class="flex items-center gap-3 text-[11px] text-gray-500">
                      <span x-text="msg.time_seconds + 'ì´ˆ'"></span>
                      <span x-text="'$' + (msg.cost || 0).toFixed(4)"></span>
                    </div>
                  </div>
                  <div class="text-gray-300 text-sm leading-relaxed markdown-body"
                       x-html="renderMarkdown(msg.content)"></div>
                </div>
              </div>
            </template>
            <template x-if="msg.type === 'error'">
              <div class="mb-4">
                <div class="bg-red-900/20 border border-hq-red/30 rounded-2xl rounded-tl-sm px-4 py-3 max-w-2xl">
                  <div class="text-xs text-hq-red mb-1 font-semibold">ì˜¤ë¥˜</div>
                  <div class="text-gray-300 text-sm" x-text="msg.text"></div>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>

      <!-- Input Bar -->
      <div class="border-t border-hq-border bg-hq-panel p-4 shrink-0">
        <form @submit.prevent="sendMessage()" class="flex items-center gap-3 max-w-4xl mx-auto">
          <input type="text" x-model="inputText" :disabled="systemStatus === 'working'"
                 placeholder="ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”..."
                 class="flex-1 bg-hq-bg border border-hq-border rounded-xl px-4 py-3 text-sm text-gray-200
                        placeholder-gray-500 focus:outline-none focus:border-hq-accent focus:ring-1
                        focus:ring-hq-accent/50 disabled:opacity-50 transition" autofocus>
          <button type="submit" :disabled="!inputText.trim() || systemStatus === 'working'"
                  class="bg-hq-accent hover:bg-blue-600 disabled:bg-gray-700 disabled:text-gray-500
                         text-white rounded-xl px-6 py-3 text-sm font-medium transition shrink-0">
            <span x-show="systemStatus !== 'working'">ë³´ë‚´ê¸°</span>
            <span x-show="systemStatus === 'working'" class="flex items-center gap-2">
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              ì²˜ë¦¬ì¤‘
            </span>
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB 2: ì‚¬ë¬´ì‹¤ (Virtual Office)             -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="currentTab === 'office'" class="flex flex-1 overflow-hidden">

    <!-- Office Floor Plan -->
    <div class="flex-1 overflow-y-auto scrollbar-thin p-6" :class="selectedAgent ? '' : ''">

      <!-- CEO Room -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">CEO Office</div>
        <div class="bg-gradient-to-r from-yellow-900/20 to-amber-900/20 border border-yellow-700/30 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-yellow-600/30 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¤</div>
            <div>
              <div class="font-bold text-yellow-300">ë™í¬ ë‹˜</div>
              <div class="text-xs text-yellow-600">CEO / Founder</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Secretary Office -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">ğŸ“‹ ë¹„ì„œì‹¤</div>
        <div class="grid grid-cols-4 gap-3">
          <template x-for="id in ['chief_of_staff','report_worker','schedule_worker','relay_worker']" :key="id">
            <div @click="selectAgent(id)"
                 class="desk-card bg-hq-panel border rounded-xl p-3 cursor-pointer"
                 :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border hover:border-gray-500'">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-9 h-9 rounded-lg flex items-center justify-center text-lg"
                     :class="getAgentAvatarBg(id)"
                     x-text="getAgentEmoji(id)">
                </div>
                <div class="w-2 h-2 rounded-full" :class="getAgentDotClass(id)"></div>
              </div>
              <div class="text-xs font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
              <div class="text-[10px] text-gray-500 truncate" x-text="agentMeta[id]?.role || ''"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- LEET Master Division -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-cyan-500 uppercase tracking-wider mb-3">ğŸ—ï¸ LEET Master ë³¸ë¶€</div>
        <div class="grid grid-cols-2 gap-4">

          <!-- CTO Room -->
          <div class="bg-cyan-900/10 border border-cyan-800/30 rounded-xl p-4">
            <div class="text-xs font-semibold text-cyan-400 mb-3">ê¸°ìˆ ê°œë°œì²˜ (CTO)</div>
            <div class="grid grid-cols-2 gap-2">
              <template x-for="id in ['cto_manager','frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                <div @click="selectAgent(id)"
                     class="desk-card bg-hq-panel/80 border rounded-lg p-2.5 cursor-pointer"
                     :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border/50 hover:border-gray-500'">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="w-7 h-7 rounded-md flex items-center justify-center text-sm"
                         :class="getAgentAvatarBg(id)"
                         x-text="getAgentEmoji(id)"></div>
                    <div class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></div>
                  </div>
                  <div class="text-[11px] font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- CSO Room -->
          <div class="bg-cyan-900/10 border border-cyan-800/30 rounded-xl p-4">
            <div class="text-xs font-semibold text-cyan-400 mb-3">ì‚¬ì—…ê¸°íšì²˜ (CSO)</div>
            <div class="grid grid-cols-2 gap-2">
              <template x-for="id in ['cso_manager','market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                <div @click="selectAgent(id)"
                     class="desk-card bg-hq-panel/80 border rounded-lg p-2.5 cursor-pointer"
                     :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border/50 hover:border-gray-500'">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="w-7 h-7 rounded-md flex items-center justify-center text-sm"
                         :class="getAgentAvatarBg(id)"
                         x-text="getAgentEmoji(id)"></div>
                    <div class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></div>
                  </div>
                  <div class="text-[11px] font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- CLO Room -->
          <div class="bg-cyan-900/10 border border-cyan-800/30 rounded-xl p-4">
            <div class="text-xs font-semibold text-cyan-400 mb-3">ë²•ë¬´Â·IPì²˜ (CLO)</div>
            <div class="grid grid-cols-2 gap-2">
              <template x-for="id in ['clo_manager','copyright_specialist','patent_specialist']" :key="id">
                <div @click="selectAgent(id)"
                     class="desk-card bg-hq-panel/80 border rounded-lg p-2.5 cursor-pointer"
                     :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border/50 hover:border-gray-500'">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="w-7 h-7 rounded-md flex items-center justify-center text-sm"
                         :class="getAgentAvatarBg(id)"
                         x-text="getAgentEmoji(id)"></div>
                    <div class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></div>
                  </div>
                  <div class="text-[11px] font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- CMO Room -->
          <div class="bg-cyan-900/10 border border-cyan-800/30 rounded-xl p-4">
            <div class="text-xs font-semibold text-cyan-400 mb-3">ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ (CMO)</div>
            <div class="grid grid-cols-2 gap-2">
              <template x-for="id in ['cmo_manager','survey_specialist','content_specialist','community_specialist']" :key="id">
                <div @click="selectAgent(id)"
                     class="desk-card bg-hq-panel/80 border rounded-lg p-2.5 cursor-pointer"
                     :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border/50 hover:border-gray-500'">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="w-7 h-7 rounded-md flex items-center justify-center text-sm"
                         :class="getAgentAvatarBg(id)"
                         x-text="getAgentEmoji(id)"></div>
                    <div class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></div>
                  </div>
                  <div class="text-[11px] font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance Division -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-purple-400 uppercase tracking-wider mb-3">ğŸ“Š íˆ¬ìë¶„ì„ ë³¸ë¶€</div>
        <div class="bg-purple-900/10 border border-purple-800/30 rounded-xl p-4">
          <div class="text-xs font-semibold text-purple-400 mb-3">íˆ¬ìë¶„ì„ì²˜ (CIO)</div>
          <div class="grid grid-cols-5 gap-2">
            <template x-for="id in ['cio_manager','market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
              <div @click="selectAgent(id)"
                   class="desk-card bg-hq-panel/80 border rounded-lg p-2.5 cursor-pointer"
                   :class="selectedAgent === id ? 'border-hq-accent ring-1 ring-hq-accent/50' : 'border-hq-border/50 hover:border-gray-500'">
                <div class="flex items-center gap-2 mb-1">
                  <div class="w-7 h-7 rounded-md flex items-center justify-center text-sm"
                       :class="getAgentAvatarBg(id)"
                       x-text="getAgentEmoji(id)"></div>
                  <div class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></div>
                </div>
                <div class="text-[11px] font-medium text-gray-300 truncate" x-text="getAgentName(id)"></div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Detail Side Panel -->
    <aside x-show="selectedAgent" x-transition
           class="w-96 bg-hq-panel border-l border-hq-border flex flex-col shrink-0 overflow-hidden">
      <template x-if="agentDetail">
        <div class="flex flex-col h-full">
          <!-- Header -->
          <div class="p-4 border-b border-hq-border shrink-0">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                     :class="getAgentAvatarBg(agentDetail.agent_id)"
                     x-text="getAgentEmoji(agentDetail.agent_id)"></div>
                <div>
                  <div class="font-bold text-white" x-text="agentDetail.name_ko"></div>
                  <div class="text-xs text-gray-500" x-text="agentDetail.name"></div>
                </div>
              </div>
              <button @click="selectedAgent = null; agentDetail = null"
                      class="text-gray-500 hover:text-gray-300 text-lg">âœ•</button>
            </div>

            <!-- Tags -->
            <div class="flex flex-wrap gap-1.5">
              <span class="text-[10px] px-2 py-0.5 rounded-full border"
                    :class="{
                      'border-blue-600 text-blue-400 bg-blue-900/20': agentDetail.role === 'manager',
                      'border-green-600 text-green-400 bg-green-900/20': agentDetail.role === 'specialist',
                      'border-yellow-600 text-yellow-400 bg-yellow-900/20': agentDetail.role === 'worker',
                    }"
                    x-text="agentDetail.role"></span>
              <div class="relative inline-flex items-center gap-1">
                <select x-model="agentDetail.model_name"
                        @change="saveModel()"
                        class="text-[10px] px-2 py-0.5 rounded-full border border-hq-border text-gray-400
                               bg-hq-bg appearance-none cursor-pointer hover:border-hq-accent
                               focus:outline-none focus:border-hq-accent pr-5"
                        :disabled="modelSaving">
                  <template x-for="m in availableModels" :key="m.name">
                    <option :value="m.name" x-text="m.name" :selected="m.name === agentDetail.model_name"></option>
                  </template>
                </select>
                <span x-show="modelSaving" class="text-[9px] text-hq-yellow">...</span>
                <span x-show="modelSaved" class="text-[9px] text-hq-green fade-in">&#10003;</span>
              </div>
              <span class="text-[10px] px-2 py-0.5 rounded-full border border-hq-border text-gray-400"
                    x-text="agentDetail.division"></span>
            </div>
          </div>

          <!-- Info -->
          <div class="p-4 border-b border-hq-border shrink-0 space-y-2">
            <div class="text-xs text-gray-500">ëŠ¥ë ¥ì¹˜</div>
            <div class="flex flex-wrap gap-1">
              <template x-for="cap in (agentDetail.capabilities || [])" :key="cap">
                <span class="text-[10px] px-2 py-0.5 bg-hq-bg rounded-md text-gray-400" x-text="cap"></span>
              </template>
            </div>
            <template x-if="agentDetail.subordinate_ids && agentDetail.subordinate_ids.length > 0">
              <div>
                <div class="text-xs text-gray-500 mt-2">ë¶€í•˜ ì§ì›</div>
                <div class="flex flex-wrap gap-1 mt-1">
                  <template x-for="sid in agentDetail.subordinate_ids" :key="sid">
                    <span class="text-[10px] px-2 py-0.5 bg-blue-900/20 border border-blue-800/30 rounded-md text-blue-400 cursor-pointer hover:bg-blue-900/40"
                          @click="selectAgent(sid)" x-text="getAgentName(sid)"></span>
                  </template>
                </div>
              </div>
            </template>
            <template x-if="agentDetail.superior_id">
              <div>
                <div class="text-xs text-gray-500 mt-2">ìƒê´€</div>
                <span class="text-[10px] px-2 py-0.5 bg-amber-900/20 border border-amber-800/30 rounded-md text-amber-400 cursor-pointer hover:bg-amber-900/40"
                      @click="selectAgent(agentDetail.superior_id)"
                      x-text="getAgentName(agentDetail.superior_id)"></span>
              </div>
            </template>
          </div>

          <!-- Soul Editor -->
          <div class="flex-1 flex flex-col overflow-hidden p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs font-semibold text-gray-400">Soul (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸)</div>
              <div class="flex items-center gap-2">
                <span x-show="soulSaving" class="text-[10px] text-hq-yellow">ì €ì¥ì¤‘...</span>
                <span x-show="soulSaved" class="text-[10px] text-hq-green fade-in">ì €ì¥ ì™„ë£Œ!</span>
              </div>
            </div>
            <textarea x-model="soulText"
                      @input="soulChanged = true; soulSaved = false"
                      class="flex-1 bg-hq-bg border border-hq-border rounded-lg p-3 text-xs text-gray-300
                             font-mono leading-relaxed resize-none scrollbar-thin
                             focus:outline-none focus:border-hq-accent focus:ring-1 focus:ring-hq-accent/50"
                      placeholder="ì—ì´ì „íŠ¸ì˜ ì„±ê²©ê³¼ ì—­í• ì„ ì •ì˜í•˜ì„¸ìš”..."></textarea>
            <button @click="saveSoul()"
                    :disabled="!soulChanged || soulSaving"
                    class="mt-3 bg-hq-accent hover:bg-blue-600 disabled:bg-gray-700 disabled:text-gray-500
                           text-white text-xs rounded-lg px-4 py-2 font-medium transition">
              Soul ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)
            </button>
          </div>
        </div>
      </template>
    </aside>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB 3: ì§€ì‹ê´€ë¦¬ (Knowledge Management)     -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="currentTab === 'knowledge'" class="flex flex-1 overflow-hidden">

    <!-- File List -->
    <aside class="w-72 bg-hq-panel border-r border-hq-border flex flex-col shrink-0">
      <div class="p-3 border-b border-hq-border">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">ì§€ì‹ íŒŒì¼</div>
          <button @click="showNewFileForm = !showNewFileForm"
                  class="text-xs text-hq-accent hover:text-blue-400 font-medium">+ ìƒˆ íŒŒì¼</button>
        </div>

        <!-- New File Form -->
        <div x-show="showNewFileForm" class="space-y-2 mt-2 fade-in">
          <select x-model="newFileFolder"
                  class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1.5 text-xs text-gray-300">
            <option value="shared">shared (ì „ì²´ ê³µìœ )</option>
            <option value="leet_master">leet_master (LEET Master ë³¸ë¶€)</option>
            <option value="finance">finance (íˆ¬ìë¶„ì„ ë³¸ë¶€)</option>
          </select>
          <input x-model="newFileName" placeholder="íŒŒì¼ëª… (ì˜ˆ: CONTEXT)"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1.5 text-xs text-gray-300 placeholder-gray-600">
          <button @click="createNewFile()"
                  :disabled="!newFileName.trim()"
                  class="w-full bg-hq-accent hover:bg-blue-600 disabled:bg-gray-700 text-white text-xs rounded-lg py-1.5 font-medium transition">
            ìƒì„±
          </button>
        </div>
      </div>

      <!-- File Tree (folder accordion) -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-3 space-y-2">
        <template x-for="group in getKnowledgeFolders()" :key="group.folder">
          <div>
            <button @click="toggleKnowledgeFolder(group.folder)"
                    class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-white/5 w-full text-left text-xs font-semibold"
                    :class="getKnowledgeFolderStyle(group.folder).color">
              <span class="text-[10px] text-gray-500"
                    x-text="knowledgeExpanded[group.folder] ? 'â–¼' : 'â–¶'"></span>
              <span>ğŸ“</span>
              <span x-text="getKnowledgeFolderStyle(group.folder).label"></span>
              <span class="ml-auto text-[10px] text-gray-600"
                    x-text="group.files.length + 'ê°œ'"></span>
            </button>
            <div x-show="knowledgeExpanded[group.folder]" x-collapse class="ml-4 space-y-0.5 mt-1">
              <template x-for="file in group.files" :key="file.path">
                <div @click="selectKnowledgeFile(file)"
                     class="flex items-center gap-2 px-2 py-1.5 rounded-lg cursor-pointer text-xs"
                     :class="selectedFile?.path === file.path
                       ? 'bg-hq-accent/20 text-hq-accent border border-hq-accent/30'
                       : 'text-gray-400 hover:bg-white/5'">
                  <span class="text-gray-600">ğŸ“„</span>
                  <div class="flex-1 min-w-0">
                    <div class="truncate font-medium" x-text="file.filename"></div>
                  </div>
                  <div class="text-[10px] text-gray-600 shrink-0"
                       x-text="(file.size / 1024).toFixed(1) + 'KB'"></div>
                </div>
              </template>
            </div>
          </div>
        </template>
        <template x-if="knowledgeFiles.length === 0">
          <div class="text-xs text-gray-600 italic p-2">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </template>
      </div>
    </aside>

    <!-- Knowledge Editor -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <template x-if="selectedFile">
        <div class="flex flex-col h-full">
          <!-- File Header -->
          <div class="p-4 border-b border-hq-border flex items-center justify-between shrink-0">
            <div class="flex items-center gap-3">
              <span class="text-lg">ğŸ“„</span>
              <div>
                <div class="font-medium text-white text-sm" x-text="selectedFile.filename"></div>
                <div class="text-xs text-gray-500" x-text="'knowledge/' + selectedFile.path"></div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <span x-show="fileSaving" class="text-xs text-hq-yellow">ì €ì¥ì¤‘...</span>
              <span x-show="fileSaved" class="text-xs text-hq-green fade-in">ì €ì¥ë¨!</span>
              <button @click="saveKnowledgeFile()"
                      :disabled="!fileChanged || fileSaving"
                      class="bg-hq-accent hover:bg-blue-600 disabled:bg-gray-700 disabled:text-gray-500
                             text-white text-xs rounded-lg px-4 py-2 font-medium transition">
                ì €ì¥
              </button>
              <button @click="deleteKnowledgeFile()"
                      class="bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs rounded-lg px-3 py-2 font-medium transition border border-red-800/30">
                ì‚­ì œ
              </button>
            </div>
          </div>
          <!-- Editor -->
          <textarea x-model="fileContent"
                    @input="fileChanged = true; fileSaved = false"
                    class="flex-1 bg-hq-bg p-6 text-sm text-gray-300 font-mono leading-relaxed
                           resize-none scrollbar-thin focus:outline-none"
                    placeholder="ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
      </template>
      <template x-if="!selectedFile">
        <div class="flex-1 flex items-center justify-center">
          <div class="text-center">
            <div class="text-4xl mb-3">ğŸ“š</div>
            <div class="text-gray-500 text-sm">ì™¼ìª½ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>ìƒˆ íŒŒì¼ì„ ë§Œë“œì„¸ìš”</div>
            <div class="mt-4 text-xs text-gray-600 max-w-sm">
              ì—¬ê¸°ì— CONTEXT.md, README.md, STATUS.md, TODO.md ê°™ì€<br>
              í”„ë¡œì íŠ¸ ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—ì´ì „íŠ¸ë“¤ì´ ê³µìœ  ì§€ì‹ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </template>
    </main>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  Script                                     -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    function corthexApp() {
      return {
        // Tab state
        currentTab: 'command',

        // Command Center state
        inputText: '',
        messages: [],
        systemStatus: 'idle',
        wsConnected: false,
        totalCost: 0,
        totalTokens: 0,
        activityLogs: [],
        activeAgents: {},
        ws: null,

        // Org tree
        expanded: {
          secretary: false, leet_master: true, tech: false, strategy: false,
          legal: false, marketing: false, investment: true, finance: false, tools: false,
        },

        // Office state
        selectedAgent: null,
        agentDetail: null,
        soulText: '',
        soulChanged: false,
        soulSaving: false,
        soulSaved: false,
        agentMeta: {},
        availableModels: [],
        modelSaving: false,
        modelSaved: false,

        // Knowledge state
        knowledgeFiles: [],
        knowledgeExpanded: { shared: true, leet_master: true, finance: true },
        selectedFile: null,
        fileContent: '',
        fileChanged: false,
        fileSaving: false,
        fileSaved: false,
        showNewFileForm: false,
        newFileFolder: 'shared',
        newFileName: '',

        // Agent info
        agentNames: {
          'chief_of_staff': 'ë¹„ì„œì‹¤ì¥',
          'report_worker': 'ë³´ê³  ìš”ì•½ Worker',
          'schedule_worker': 'ì¼ì •/ë¯¸ê²° ì¶”ì  Worker',
          'relay_worker': 'ì •ë³´ ì¤‘ê³„ Worker',
          'cto_manager': 'CTO ê¸°ìˆ ê°œë°œì²˜ì¥',
          'frontend_specialist': 'í”„ë¡ íŠ¸ì—”ë“œ',
          'backend_specialist': 'ë°±ì—”ë“œ/API',
          'infra_specialist': 'DB/ì¸í”„ë¼',
          'ai_model_specialist': 'AI ëª¨ë¸',
          'cso_manager': 'CSO ì‚¬ì—…ê¸°íšì²˜ì¥',
          'market_research_specialist': 'ì‹œì¥ì¡°ì‚¬',
          'business_plan_specialist': 'ì‚¬ì—…ê³„íšì„œ',
          'financial_model_specialist': 'ì¬ë¬´ëª¨ë¸ë§',
          'clo_manager': 'CLO ë²•ë¬´Â·IPì²˜ì¥',
          'copyright_specialist': 'ì €ì‘ê¶Œ',
          'patent_specialist': 'íŠ¹í—ˆ/ì•½ê´€',
          'cmo_manager': 'CMO ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ì¥',
          'survey_specialist': 'ì„¤ë¬¸/ë¦¬ì„œì¹˜',
          'content_specialist': 'ì½˜í…ì¸ ',
          'community_specialist': 'ì»¤ë®¤ë‹ˆí‹°',
          'cio_manager': 'CIO íˆ¬ìë¶„ì„ì²˜ì¥',
          'market_condition_specialist': 'ì‹œí™©ë¶„ì„',
          'stock_analysis_specialist': 'ì¢…ëª©ë¶„ì„',
          'technical_analysis_specialist': 'ê¸°ìˆ ì ë¶„ì„',
          'risk_management_specialist': 'ë¦¬ìŠ¤í¬ê´€ë¦¬',
        },

        agentEmojis: {
          'chief_of_staff': 'ğŸ–ï¸', 'report_worker': 'ğŸ“', 'schedule_worker': 'ğŸ“…', 'relay_worker': 'ğŸ“¡',
          'cto_manager': 'ğŸ§‘â€ğŸ’»', 'frontend_specialist': 'ğŸ¨', 'backend_specialist': 'âš™ï¸',
          'infra_specialist': 'ğŸ—„ï¸', 'ai_model_specialist': 'ğŸ¤–',
          'cso_manager': 'ğŸ“ˆ', 'market_research_specialist': 'ğŸ”',
          'business_plan_specialist': 'ğŸ“‹', 'financial_model_specialist': 'ğŸ’°',
          'clo_manager': 'âš–ï¸', 'copyright_specialist': 'Â©ï¸', 'patent_specialist': 'ğŸ“œ',
          'cmo_manager': 'ğŸ“£', 'survey_specialist': 'ğŸ“Š', 'content_specialist': 'âœï¸', 'community_specialist': 'ğŸ‘¥',
          'cio_manager': 'ğŸ’¹', 'market_condition_specialist': 'ğŸŒ',
          'stock_analysis_specialist': 'ğŸ“‰', 'technical_analysis_specialist': 'ğŸ“',
          'risk_management_specialist': 'ğŸ›¡ï¸',
        },

        agentDivision: {
          'chief_of_staff': 'secretary', 'report_worker': 'secretary',
          'schedule_worker': 'secretary', 'relay_worker': 'secretary',
          'cto_manager': 'tech', 'frontend_specialist': 'tech', 'backend_specialist': 'tech',
          'infra_specialist': 'tech', 'ai_model_specialist': 'tech',
          'cso_manager': 'strategy', 'market_research_specialist': 'strategy',
          'business_plan_specialist': 'strategy', 'financial_model_specialist': 'strategy',
          'clo_manager': 'legal', 'copyright_specialist': 'legal', 'patent_specialist': 'legal',
          'cmo_manager': 'marketing', 'survey_specialist': 'marketing',
          'content_specialist': 'marketing', 'community_specialist': 'marketing',
          'cio_manager': 'finance', 'market_condition_specialist': 'finance',
          'stock_analysis_specialist': 'finance', 'technical_analysis_specialist': 'finance',
          'risk_management_specialist': 'finance',
        },

        // â”€â”€â”€ Init â”€â”€â”€
        init() {
          this.connectWebSocket();
        },

        // â”€â”€â”€ WebSocket â”€â”€â”€
        connectWebSocket() {
          try {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.ws = new WebSocket(`${protocol}//${location.host}/ws`);
            this.ws.onopen = () => { this.wsConnected = true; console.log('WebSocket ì—°ê²°ë¨'); };
            this.ws.onclose = () => {
              this.wsConnected = false;
              console.log('WebSocket ì—°ê²° ëŠê¹€, 3ì´ˆ í›„ ì¬ì‹œë„...');
              setTimeout(() => this.connectWebSocket(), 3000);
            };
            this.ws.onerror = (e) => { console.error('WebSocket ì—ëŸ¬:', e); };
            this.ws.onmessage = (event) => { this.handleWsMessage(JSON.parse(event.data)); };
          } catch (e) {
            console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', e);
            this.wsConnected = false;
            setTimeout(() => this.connectWebSocket(), 3000);
          }
        },

        handleWsMessage(msg) {
          switch (msg.event) {
            case 'processing_start':
              this.systemStatus = 'working';
              this.messages.push({ type: 'processing', id: Date.now() });
              break;
            case 'agent_status':
              const d = msg.data;
              this.activeAgents[d.agent_id] = { status: d.status, progress: d.progress || 0 };
              if (d.status === 'working') {
                const div = this.agentDivision[d.agent_id];
                if (div) {
                  this.expanded[div] = true;
                  if (['tech','strategy','legal','marketing'].includes(div)) this.expanded.leet_master = true;
                  if (div === 'finance') this.expanded.investment = true;
                }
                if (d.progress < 0.9) this.simulateProgress(d.agent_id);
              }
              break;
            case 'activity_log':
              this.activityLogs.push(msg.data);
              break;
            case 'cost_update':
              this.totalCost = msg.data.total_cost;
              this.totalTokens = msg.data.total_tokens;
              break;
            case 'result':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({
                type: 'result', content: msg.data.content, sender_id: msg.data.sender_id,
                time_seconds: msg.data.time_seconds, cost: msg.data.cost,
              });
              this.systemStatus = 'idle';
              this.totalCost = msg.data.cost || this.totalCost;
              this.$nextTick(() => this.scrollToBottom());
              break;
            case 'error':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({ type: 'error', text: msg.data.message });
              this.systemStatus = 'error';
              setTimeout(() => { this.systemStatus = 'idle'; }, 3000);
              break;
          }
        },

        simulateProgress(agentId) {
          const interval = setInterval(() => {
            if (!this.activeAgents[agentId] || this.activeAgents[agentId].status !== 'working') {
              clearInterval(interval); return;
            }
            const cur = this.activeAgents[agentId].progress;
            if (cur < 0.9) {
              this.activeAgents[agentId].progress = Math.min(0.9, cur + 0.05 + Math.random() * 0.1);
            } else { clearInterval(interval); }
          }, 800);
        },

        // â”€â”€â”€ Chat â”€â”€â”€
        sendMessage() {
          const text = this.inputText.trim();
          if (!text || this.systemStatus === 'working') return;
          this.messages.push({ type: 'user', text });
          this.inputText = '';
          this.activeAgents = {};
          if (this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'command', text }));
          }
          this.$nextTick(() => this.scrollToBottom());
        },

        sendPreset(text) { this.inputText = text; this.sendMessage(); },

        // â”€â”€â”€ Office â”€â”€â”€
        async loadOfficeData() {
          if (Object.keys(this.agentMeta).length > 0) return;
          try {
            const [agentsRes, modelsRes] = await Promise.all([
              fetch('/api/agents'),
              fetch('/api/models'),
            ]);
            const agents = await agentsRes.json();
            agents.forEach(a => { this.agentMeta[a.agent_id] = a; });
            this.availableModels = await modelsRes.json();
          } catch (e) { console.error('Failed to load office data:', e); }
        },

        async selectAgent(id) {
          this.selectedAgent = id;
          this.soulChanged = false;
          this.soulSaved = false;
          this.modelSaving = false;
          this.modelSaved = false;
          try {
            const res = await fetch(`/api/agents/${id}`);
            this.agentDetail = await res.json();
            this.soulText = this.agentDetail.system_prompt || '';
          } catch (e) { console.error('Failed to load agent:', e); }
        },

        async saveSoul() {
          if (!this.selectedAgent || !this.soulChanged) return;
          this.soulSaving = true;
          try {
            await fetch(`/api/agents/${this.selectedAgent}/soul`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ system_prompt: this.soulText }),
            });
            this.soulChanged = false;
            this.soulSaved = true;
            this.soulSaving = false;
            setTimeout(() => { this.soulSaved = false; }, 2000);
          } catch (e) {
            this.soulSaving = false;
            alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
          }
        },

        async saveModel() {
          if (!this.selectedAgent || !this.agentDetail) return;
          this.modelSaving = true;
          this.modelSaved = false;
          try {
            const res = await fetch(`/api/agents/${this.selectedAgent}/model`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model_name: this.agentDetail.model_name }),
            });
            const data = await res.json();
            if (data.error) {
              alert('ëª¨ë¸ ë³€ê²½ ì‹¤íŒ¨: ' + data.error);
              this.modelSaving = false;
              return;
            }
            if (this.agentMeta[this.selectedAgent]) {
              this.agentMeta[this.selectedAgent].model_name = this.agentDetail.model_name;
            }
            this.modelSaving = false;
            this.modelSaved = true;
            setTimeout(() => { this.modelSaved = false; }, 2000);
          } catch (e) {
            this.modelSaving = false;
            alert('ëª¨ë¸ ë³€ê²½ ì‹¤íŒ¨: ' + e.message);
          }
        },

        // â”€â”€â”€ Knowledge â”€â”€â”€
        async loadKnowledge() {
          try {
            const res = await fetch('/api/knowledge');
            this.knowledgeFiles = await res.json();
          } catch (e) { console.error('Failed to load knowledge:', e); }
        },

        async selectKnowledgeFile(file) {
          this.selectedFile = file;
          this.fileChanged = false;
          this.fileSaved = false;
          try {
            const res = await fetch(`/api/knowledge/${file.folder}/${file.filename}`);
            const data = await res.json();
            this.fileContent = data.content || '';
          } catch (e) { console.error('Failed to load file:', e); }
        },

        async saveKnowledgeFile() {
          if (!this.selectedFile || !this.fileChanged) return;
          this.fileSaving = true;
          try {
            const res = await fetch('/api/knowledge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                folder: this.selectedFile.folder,
                filename: this.selectedFile.filename,
                content: this.fileContent,
              }),
            });
            const data = await res.json();
            if (data.error) {
              this.fileSaving = false;
              alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
              return;
            }
            this.fileChanged = false;
            this.fileSaved = true;
            this.fileSaving = false;
            setTimeout(() => { this.fileSaved = false; }, 2000);
          } catch (e) {
            this.fileSaving = false;
            alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
          }
        },

        async deleteKnowledgeFile() {
          if (!this.selectedFile) return;
          if (!confirm(`"${this.selectedFile.filename}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
          try {
            await fetch(`/api/knowledge/${this.selectedFile.folder}/${this.selectedFile.filename}`, {
              method: 'DELETE',
            });
            this.selectedFile = null;
            this.fileContent = '';
            await this.loadKnowledge();
          } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
        },

        async createNewFile() {
          if (!this.newFileName.trim()) return;
          try {
            const res = await fetch('/api/knowledge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                folder: this.newFileFolder,
                filename: this.newFileName.trim(),
                content: `# ${this.newFileName.trim()}\n\në‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\n`,
              }),
            });
            const data = await res.json();
            if (data.error) {
              alert('ìƒì„± ì‹¤íŒ¨: ' + data.error + '\n\nrun.batìœ¼ë¡œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
              return;
            }
            this.showNewFileForm = false;
            this.newFileName = '';
            await this.loadKnowledge();
          } catch (e) { alert('ìƒì„± ì‹¤íŒ¨: ' + e.message + '\n\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.'); }
        },

        // â”€â”€â”€ Helpers â”€â”€â”€
        toggleSection(s) { this.expanded[s] = !this.expanded[s]; },
        toggleKnowledgeFolder(folder) { this.knowledgeExpanded[folder] = !this.knowledgeExpanded[folder]; },

        getKnowledgeFolders() {
          const grouped = {};
          for (const file of this.knowledgeFiles) {
            if (!grouped[file.folder]) grouped[file.folder] = [];
            grouped[file.folder].push(file);
          }
          const order = ['shared', 'leet_master', 'finance'];
          const result = [];
          for (const key of order) {
            if (grouped[key]) { result.push({ folder: key, files: grouped[key] }); delete grouped[key]; }
          }
          for (const [key, files] of Object.entries(grouped)) {
            result.push({ folder: key, files });
          }
          return result;
        },

        getKnowledgeFolderStyle(folder) {
          const styles = {
            shared:      { label: 'shared (ì „ì²´ ê³µìœ )', color: 'text-gray-400' },
            leet_master: { label: 'leet_master (LEET Master)', color: 'text-cyan-400' },
            finance:     { label: 'finance (íˆ¬ìë¶„ì„)', color: 'text-purple-400' },
          };
          return styles[folder] || { label: folder, color: 'text-gray-400' };
        },

        getAgentName(id) { return this.agentNames[id] || id; },
        getAgentEmoji(id) { return this.agentEmojis[id] || 'ğŸ¤–'; },

        getAgentAvatarBg(id) {
          const div = this.agentDivision[id];
          if (!div) return 'bg-gray-700';
          const m = { secretary: 'bg-yellow-900/40', tech: 'bg-cyan-900/40', strategy: 'bg-emerald-900/40',
                      legal: 'bg-orange-900/40', marketing: 'bg-pink-900/40', finance: 'bg-purple-900/40' };
          return m[div] || 'bg-gray-700';
        },

        getAgentDotClass(id) {
          const s = this.activeAgents[id];
          if (!s) return 'bg-amber-500';
          if (s.status === 'working') return 'bg-hq-green pulse-dot';
          if (s.status === 'done') return 'bg-hq-green';
          return 'bg-amber-500';
        },

        getSectionStatusColor(section) {
          const ids = this.getSectionAgentIds(section);
          if (ids.some(id => this.activeAgents[id]?.status === 'working')) return 'text-hq-yellow';
          if (ids.some(id => this.activeAgents[id]?.status === 'done')) return 'text-hq-green';
          return 'text-gray-600';
        },

        getSectionStatusText(section) {
          const ids = this.getSectionAgentIds(section);
          const w = ids.filter(id => this.activeAgents[id]?.status === 'working').length;
          if (w > 0) return `${w}ëª… ì‘ì—…ì¤‘`;
          const d = ids.filter(id => this.activeAgents[id]?.status === 'done').length;
          if (d > 0) return `${d}ëª… ì™„ë£Œ`;
          return '';
        },

        getSectionAgentIds(section) {
          if (section === 'leet_master') {
            return Object.entries(this.agentDivision).filter(([_,d]) => ['tech','strategy','legal','marketing'].includes(d)).map(([id]) => id);
          }
          if (section === 'investment') {
            return Object.entries(this.agentDivision).filter(([_,d]) => d === 'finance').map(([id]) => id);
          }
          return Object.entries(this.agentDivision).filter(([_,d]) => d === section).map(([id]) => id);
        },

        renderMarkdown(text) { try { return marked.parse(text || ''); } catch { return text; } },
        scrollToBottom() { const el = this.$refs.chatArea; if (el) el.scrollTop = el.scrollHeight; },
      };
    }
  </script>
</body>
</html>
