<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTHEX HQ - CEO Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'hq-bg': '#0a0e1a',
            'hq-surface': '#111827',
            'hq-panel': '#1a2235',
            'hq-border': '#1e2d4a',
            'hq-border-light': '#2a3a5c',
            'hq-accent': '#3b82f6',
            'hq-cyan': '#06b6d4',
            'hq-purple': '#8b5cf6',
            'hq-green': '#10b981',
            'hq-yellow': '#f59e0b',
            'hq-red': '#ef4444',
            'hq-text': '#e2e8f0',
            'hq-muted': '#64748b',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }

    /* Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #2a3a5c; border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #3b4f7a; }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-16px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.85); }
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink {
      50% { border-color: transparent; }
    }
    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.4; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    @keyframes gridPulse {
      0%, 100% { opacity: 0.03; }
      50% { opacity: 0.06; }
    }
    .fade-in-up { animation: fadeInUp 0.4s ease-out; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-in-left { animation: slideInLeft 0.3s ease-out; }
    .pulse-dot { animation: pulseDot 1.5s ease-in-out infinite; }
    .progress-bar { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(135deg, #06b6d4, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient border */
    .gradient-border {
      position: relative;
      background: #1a2235;
      border: 1px solid transparent;
      background-clip: padding-box;
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(135deg, #06b6d430, #3b82f630, #8b5cf630);
      z-index: -1;
    }

    /* Glow effects */
    .glow-cyan { box-shadow: 0 0 20px rgba(6, 182, 212, 0.15), 0 0 40px rgba(6, 182, 212, 0.05); }
    .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15), 0 0 40px rgba(59, 130, 246, 0.05); }
    .glow-purple { box-shadow: 0 0 20px rgba(139, 92, 246, 0.15), 0 0 40px rgba(139, 92, 246, 0.05); }
    .glow-accent { box-shadow: 0 0 24px rgba(59, 130, 246, 0.2); }

    /* Glass effect */
    .glass {
      background: rgba(26, 34, 53, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Background grid pattern */
    .bg-grid {
      background-image:
        linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridPulse 8s ease-in-out infinite;
    }

    /* Hover transitions */
    .hover-lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    /* Card hover glow */
    .hover-glow {
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .hover-glow:hover {
      box-shadow: 0 0 24px rgba(59, 130, 246, 0.12);
      border-color: #2a3a5c;
    }

    /* Agent avatar */
    .agent-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
      transition: transform 0.15s ease;
    }
    .agent-avatar:hover { transform: scale(1.1); }

    /* Status badge */
    .status-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    /* Markdown body */
    .markdown-body { line-height: 1.7; }
    .markdown-body h1 { font-size: 1.25rem; font-weight: 700; margin: 1rem 0 0.5rem; color: #e2e8f0; }
    .markdown-body h2 { font-size: 1.1rem; font-weight: 600; margin: 0.8rem 0 0.4rem; color: #cbd5e1; }
    .markdown-body h3 { font-size: 1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; color: #94a3b8; }
    .markdown-body p { margin: 0.4rem 0; color: #cbd5e1; }
    .markdown-body ul, .markdown-body ol { margin: 0.3rem 0; padding-left: 1.5rem; }
    .markdown-body li { margin: 0.2rem 0; color: #cbd5e1; }
    .markdown-body code { background: #0f172a; padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; color: #7dd3fc; border: 1px solid #1e2d4a; }
    .markdown-body pre { background: #0a0e1a; padding: 1rem; border-radius: 10px; overflow-x: auto; margin: 0.5rem 0; border: 1px solid #1e2d4a; }
    .markdown-body pre code { background: transparent; padding: 0; border: none; color: #e2e8f0; }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
    .markdown-body th, .markdown-body td { border: 1px solid #1e2d4a; padding: 0.5rem 0.8rem; text-align: left; }
    .markdown-body th { background: #111827; color: #94a3b8; font-weight: 600; }
    .markdown-body blockquote { border-left: 3px solid #3b82f6; padding-left: 1rem; margin: 0.5rem 0; color: #94a3b8; }
    .markdown-body a { color: #60a5fa; text-decoration: underline; text-underline-offset: 2px; }
    .markdown-body hr { border-color: #1e2d4a; margin: 1rem 0; }

    /* Typing effect for welcome */
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #3b82f6;
      animation: typing 2s steps(30) 0.5s forwards, blink 0.8s step-end infinite;
      width: 0;
    }

    /* Input focus ring */
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 0 20px rgba(59, 130, 246, 0.1);
    }

    /* Activity log item */
    .log-item {
      transition: background 0.15s ease;
      border-radius: 6px;
      padding: 4px 8px;
    }
    .log-item:hover {
      background: rgba(59, 130, 246, 0.05);
    }
  </style>
</head>

<body class="bg-hq-bg text-hq-text h-screen flex flex-col overflow-hidden"
      x-data="corthexApp()" x-init="init()">

  <!-- ═══ Top Bar ═══ -->
  <header class="h-14 glass border-b border-hq-border flex items-center justify-between px-5 shrink-0 z-20">
    <div class="flex items-center gap-4">
      <!-- Logo -->
      <div class="flex items-center gap-2.5">
        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGrad" x1="0" y1="0" x2="32" y2="32">
              <stop offset="0%" stop-color="#06b6d4"/>
              <stop offset="50%" stop-color="#3b82f6"/>
              <stop offset="100%" stop-color="#8b5cf6"/>
            </linearGradient>
          </defs>
          <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#logoGrad)" stroke-width="1.5" fill="none"/>
          <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#logoGrad)" stroke-width="1" fill="none" opacity="0.5"/>
          <circle cx="16" cy="16" r="4" fill="url(#logoGrad)" opacity="0.8"/>
          <circle cx="16" cy="16" r="2" fill="#0a0e1a"/>
          <line x1="16" y1="12" x2="16" y2="6" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="16" y1="20" x2="16" y2="26" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
        </svg>
        <div>
          <div class="text-base font-bold tracking-wide gradient-text">CORTHEX</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-[10px] font-mono text-hq-muted bg-hq-surface border border-hq-border rounded-md px-2 py-0.5">v0.4.0</span>
        <span class="text-[10px] font-mono text-hq-cyan/60 bg-hq-cyan/5 border border-hq-cyan/20 rounded-md px-2 py-0.5">CEO 관제</span>
      </div>
    </div>

    <div class="flex items-center gap-5">
      <!-- System Status -->
      <div class="flex items-center gap-2">
        <template x-if="systemStatus === 'idle'">
          <div class="flex items-center gap-2 bg-hq-green/10 border border-hq-green/20 rounded-lg px-3 py-1">
            <span class="w-2 h-2 rounded-full bg-hq-green"></span>
            <span class="text-xs font-medium text-hq-green">대기</span>
          </div>
        </template>
        <template x-if="systemStatus === 'working'">
          <div class="flex items-center gap-2 bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-3 py-1">
            <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
            <span class="text-xs font-medium text-hq-yellow">처리중</span>
          </div>
        </template>
        <template x-if="systemStatus === 'error'">
          <div class="flex items-center gap-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-3 py-1">
            <span class="w-2 h-2 rounded-full bg-hq-red"></span>
            <span class="text-xs font-medium text-hq-red">오류</span>
          </div>
        </template>
      </div>

      <!-- Metrics -->
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-green/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span class="text-xs font-mono text-hq-green" x-text="'$' + totalCost.toFixed(4)"></span>
        </div>
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-purple/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
          <span class="text-xs font-mono text-hq-text/70" x-text="totalTokens.toLocaleString()"></span>
        </div>
      </div>

      <!-- Connection -->
      <div class="flex items-center gap-1.5" :class="wsConnected ? 'text-hq-green' : 'text-hq-red'">
        <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
        <span class="text-[11px] font-mono" x-text="wsConnected ? '연결됨' : '끊김'"></span>
      </div>

      <!-- Quality Settings Button -->
      <button @click="showQualitySettings = true; loadQualityRules()"
              class="text-gray-400 hover:text-white transition ml-1" title="품질 검수 설정">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- ═══ Main Layout ═══ -->
  <div class="flex flex-1 overflow-hidden">

    <!-- ═══ Left Panel: Organization ═══ -->
    <aside class="w-[280px] bg-hq-surface border-r border-hq-border flex flex-col shrink-0">

      <!-- Org Tree -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-3 space-y-1">
        <div class="flex items-center justify-between px-2 mb-3">
          <div class="text-[10px] font-bold text-hq-muted uppercase tracking-[0.15em]">조직도</div>
          <div class="text-[10px] font-mono text-hq-muted">25명</div>
        </div>

        <!-- CEO -->
        <div class="mb-2">
          <div class="flex items-center gap-2.5 px-2 py-2 rounded-lg bg-gradient-to-r from-hq-accent/10 to-hq-purple/10 border border-hq-accent/20">
            <div class="agent-avatar bg-gradient-to-br from-hq-accent to-hq-purple text-white">
              CEO
            </div>
            <div>
              <div class="text-sm font-semibold text-white">CEO</div>
              <div class="text-[10px] text-hq-muted">총괄 사령관</div>
            </div>
          </div>
        </div>

        <!-- 비서실 -->
        <div class="mb-1">
          <button @click="toggleSection('secretary')"
                  class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors group">
            <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.secretary ? 'rotate-90' : ''" >&#9654;</span>
            <div class="agent-avatar bg-hq-yellow/20 text-hq-yellow text-[10px]">BS</div>
            <div class="flex-1">
              <span class="text-sm text-hq-text/90">비서실</span>
            </div>
            <span class="status-badge" :class="getSectionBadgeClass('secretary')"
                  x-text="getSectionStatusText('secretary')"></span>
          </button>
          <div x-show="expanded.secretary" x-collapse class="ml-10 space-y-0.5 mt-1">
            <template x-for="id in ['chief_of_staff', 'report_worker', 'schedule_worker', 'relay_worker']" :key="id">
              <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                <span x-show="activeAgents[id]?.status === 'working'"
                      class="ml-auto text-[9px] font-mono text-hq-yellow"
                      x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- LEET Master 본부 -->
        <div class="mb-1">
          <button @click="toggleSection('leet_master')"
                  class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors group">
            <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.leet_master ? 'rotate-90' : ''">&#9654;</span>
            <div class="agent-avatar bg-hq-cyan/20 text-hq-cyan text-[10px]">LM</div>
            <div class="flex-1">
              <span class="text-sm font-semibold text-hq-cyan">LEET Master</span>
            </div>
            <span class="status-badge" :class="getSectionBadgeClass('leet_master')"
                  x-text="getSectionStatusText('leet_master')"></span>
          </button>
          <div x-show="expanded.leet_master" x-collapse class="space-y-0.5 mt-1">

            <!-- 기술개발처 CTO -->
            <div class="ml-5 mb-1">
              <button @click="toggleSection('tech')"
                      class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors">
                <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.tech ? 'rotate-90' : ''">&#9654;</span>
                <div class="agent-avatar bg-hq-cyan/15 text-hq-cyan text-[9px]" :class="getAgentDotClass('cto_manager').includes('pulse') ? 'ring-1 ring-hq-green ring-offset-1 ring-offset-hq-surface' : ''">
                  CTO
                </div>
                <span class="text-xs text-hq-text/80">기술개발처</span>
                <span class="ml-auto status-badge" :class="getSectionBadgeClass('tech')"
                      x-text="getSectionStatusText('tech')"></span>
              </button>
              <div x-show="expanded.tech" x-collapse class="ml-10 space-y-0.5 mt-1">
                <template x-for="id in ['frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 사업기획처 CSO -->
            <div class="ml-5 mb-1">
              <button @click="toggleSection('strategy')"
                      class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors">
                <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.strategy ? 'rotate-90' : ''">&#9654;</span>
                <div class="agent-avatar bg-hq-cyan/15 text-hq-cyan text-[9px]">CSO</div>
                <span class="text-xs text-hq-text/80">사업기획처</span>
                <span class="ml-auto status-badge" :class="getSectionBadgeClass('strategy')"
                      x-text="getSectionStatusText('strategy')"></span>
              </button>
              <div x-show="expanded.strategy" x-collapse class="ml-10 space-y-0.5 mt-1">
                <template x-for="id in ['market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 법무 IP처 CLO -->
            <div class="ml-5 mb-1">
              <button @click="toggleSection('legal')"
                      class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors">
                <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.legal ? 'rotate-90' : ''">&#9654;</span>
                <div class="agent-avatar bg-hq-cyan/15 text-hq-cyan text-[9px]">CLO</div>
                <span class="text-xs text-hq-text/80">법무 IP처</span>
                <span class="ml-auto status-badge" :class="getSectionBadgeClass('legal')"
                      x-text="getSectionStatusText('legal')"></span>
              </button>
              <div x-show="expanded.legal" x-collapse class="ml-10 space-y-0.5 mt-1">
                <template x-for="id in ['copyright_specialist','patent_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 마케팅 고객처 CMO -->
            <div class="ml-5 mb-1">
              <button @click="toggleSection('marketing')"
                      class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors">
                <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.marketing ? 'rotate-90' : ''">&#9654;</span>
                <div class="agent-avatar bg-hq-cyan/15 text-hq-cyan text-[9px]">CMO</div>
                <span class="text-xs text-hq-text/80">마케팅 고객처</span>
                <span class="ml-auto status-badge" :class="getSectionBadgeClass('marketing')"
                      x-text="getSectionStatusText('marketing')"></span>
              </button>
              <div x-show="expanded.marketing" x-collapse class="ml-10 space-y-0.5 mt-1">
                <template x-for="id in ['survey_specialist','content_specialist','community_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <span x-show="activeAgents[id]?.status === 'working'"
                          class="ml-auto text-[9px] font-mono text-hq-yellow"
                          x-text="Math.round((activeAgents[id]?.progress || 0) * 100) + '%'"></span>
                  </div>
                </template>
              </div>
            </div>

          </div>
        </div>

        <!-- 투자분석 본부 -->
        <div class="mb-1">
          <button @click="toggleSection('investment')"
                  class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors group">
            <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.investment ? 'rotate-90' : ''">&#9654;</span>
            <div class="agent-avatar bg-hq-purple/20 text-hq-purple text-[10px]">FN</div>
            <div class="flex-1">
              <span class="text-sm font-semibold text-hq-purple">투자분석</span>
            </div>
            <span class="status-badge" :class="getSectionBadgeClass('investment')"
                  x-text="getSectionStatusText('investment')"></span>
          </button>
          <div x-show="expanded.investment" x-collapse class="space-y-0.5 mt-1">

            <!-- 투자분석처 CIO -->
            <div class="ml-5 mb-1">
              <button @click="toggleSection('finance')"
                      class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors">
                <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.finance ? 'rotate-90' : ''">&#9654;</span>
                <div class="agent-avatar bg-hq-purple/15 text-hq-purple text-[9px]">CIO</div>
                <span class="text-xs text-hq-text/80">투자분석처</span>
                <span class="ml-auto status-badge" :class="getSectionBadgeClass('finance')"
                      x-text="getSectionStatusText('finance')"></span>
              </button>
              <div x-show="expanded.finance" x-collapse class="ml-10 space-y-0.5 mt-1">
                <template x-for="id in ['market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="getAgentDotClass(id)"></span>
                    <span class="text-xs text-hq-muted" x-text="getAgentName(id)"></span>
                    <template x-if="id !== 'risk_management_specialist'">
                      <span class="text-[9px] font-mono text-hq-cyan/40 ml-auto">병렬</span>
                    </template>
                    <template x-if="id === 'risk_management_specialist'">
                      <span class="text-[9px] font-mono text-hq-purple/40 ml-auto">순차</span>
                    </template>
                  </div>
                </template>
              </div>
            </div>

          </div>
        </div>

        <!-- Tool Pool -->
        <div class="mb-1">
          <button @click="toggleSection('tools')"
                  class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-white/[0.03] w-full text-left transition-colors group">
            <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="expanded.tools ? 'rotate-90' : ''">&#9654;</span>
            <div class="agent-avatar bg-hq-red/15 text-hq-red text-[10px]">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <span class="text-sm text-hq-text/70">도구 풀</span>
            <span class="text-[10px] font-mono text-hq-muted ml-auto">5개</span>
          </button>
          <div x-show="expanded.tools" x-collapse class="ml-10 space-y-0.5 mt-1">
            <template x-for="t in [{n:'변리사', c:'text-amber-400'}, {n:'세무사', c:'text-emerald-400'}, {n:'디자이너', c:'text-pink-400'}, {n:'번역가', c:'text-sky-400'}, {n:'웹검색', c:'text-orange-400'}]" :key="t.n">
              <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/[0.02] transition-colors">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-muted/50"></span>
                <span class="text-xs text-hq-muted" :class="t.c" x-text="t.n"></span>
                <span class="text-[9px] text-hq-muted/50 ml-auto">도구</span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="border-t border-hq-border shrink-0">
        <button @click="logExpanded = !logExpanded"
                class="w-full flex items-center justify-between px-4 py-2 hover:bg-white/[0.02] transition-colors">
          <div class="flex items-center gap-2">
            <svg class="w-3.5 h-3.5 text-hq-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            <span class="text-[10px] font-bold text-hq-muted uppercase tracking-[0.15em]">활동 로그</span>
          </div>
          <div class="flex items-center gap-2">
            <span x-show="activityLogs.length > 0"
                  class="text-[9px] font-mono bg-hq-accent/10 text-hq-accent px-1.5 py-0.5 rounded"
                  x-text="activityLogs.length"></span>
            <span class="text-[10px] text-hq-muted transition-transform duration-200"
                  :class="logExpanded ? 'rotate-180' : ''">&#9660;</span>
          </div>
        </button>
        <div x-show="logExpanded" x-collapse>
          <div class="overflow-y-auto scrollbar-thin max-h-52 px-3 pb-3 space-y-0.5">
            <template x-for="(log, i) in activityLogs.slice(-30).reverse()" :key="i">
              <div class="log-item text-[11px] text-hq-muted fade-in">
                <span class="font-mono text-hq-muted/50" x-text="log.time"></span>
                <span class="text-hq-cyan/70 font-medium" x-text="log.agent_id"></span>
                <span x-text="log.action"></span>
              </div>
            </template>
            <template x-if="activityLogs.length === 0">
              <div class="text-[11px] text-hq-muted/40 italic px-2 py-2">아직 활동이 없습니다</div>
            </template>
          </div>
        </div>
      </div>
    </aside>

    <!-- ═══ Right Panel: Tabs + Content ═══ -->
    <main class="flex-1 flex flex-col overflow-hidden bg-hq-bg">

      <!-- ═══ Error Alert Banner ═══ -->
      <div x-show="errorAlert.visible" x-transition
           class="bg-hq-red/15 border-b border-hq-red/30 px-5 py-2 flex items-center justify-between shrink-0" style="display:none;">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
          <span class="text-sm text-hq-red font-medium" x-text="errorAlert.message"></span>
        </div>
        <button @click="errorAlert.visible = false" class="text-hq-red/50 hover:text-hq-red text-lg">&times;</button>
      </div>

      <!-- ═══ Tab Navigation ═══ -->
      <div class="flex items-center gap-0.5 px-3 pt-1.5 pb-0 border-b border-hq-border bg-hq-surface/50 shrink-0 overflow-x-auto">
        <template x-for="tab in tabs" :key="tab.id">
          <button @click="switchTab(tab.id)"
                  :class="activeTab === tab.id
                    ? 'text-white border-hq-accent bg-hq-accent/10'
                    : 'text-hq-muted border-transparent hover:text-hq-text hover:bg-white/[0.02]'"
                  class="flex items-center gap-1.5 px-3 py-2 text-[11px] font-semibold border-b-2 transition-all rounded-t-lg whitespace-nowrap">
            <span x-html="tab.icon" class="w-3.5 h-3.5"></span>
            <span x-text="tab.label"></span>
          </button>
        </template>
      </div>

      <!-- ═══ Tab: 홈 (Home Dashboard) ═══ -->
      <div x-show="activeTab === 'home'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">
          <div class="mb-6">
            <h1 class="text-2xl font-bold gradient-text mb-1">CORTHEX HQ 대시보드</h1>
            <p class="text-sm text-hq-muted">AI 에이전트 기업 현황을 한눈에 확인하세요</p>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-accent/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-white" x-text="dashboard.todayTasks || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">오늘 작업</div>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[11px]">
                <span class="text-hq-green" x-text="'완료 ' + (dashboard.todayCompleted || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-yellow" x-text="'진행 ' + (dashboard.runningCount || 0)"></span>
              </div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-green/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-white" x-text="'$' + (dashboard.totalCost || 0).toFixed(4)"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">누적 비용</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted" x-text="(dashboard.totalTokens || 0).toLocaleString() + ' 토큰'"></div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-purple/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-white" x-text="dashboard.agentCount || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">에이전트</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted">4개 본부 운영 중</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                     :class="dashboard.systemHealth === 'ok' ? 'bg-hq-green/15' : 'bg-hq-red/15'">
                  <svg class="w-4.5 h-4.5" :class="dashboard.systemHealth === 'ok' ? 'text-hq-green' : 'text-hq-red'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-white" x-text="dashboard.systemHealth === 'ok' ? '정상' : '점검'"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">시스템</div>
                </div>
              </div>
              <div class="flex items-center gap-1.5 text-[11px]">
                <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
                <span class="text-hq-muted" x-text="wsConnected ? '연결됨' : '끊김'"></span>
              </div>
            </div>
          </div>

          <!-- Recent Completed Tasks -->
          <div class="glass border border-hq-border rounded-xl p-5 mb-6">
            <h2 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              최근 완료 작업
            </h2>
            <template x-if="dashboard.recentCompleted && dashboard.recentCompleted.length > 0">
              <div class="space-y-2">
                <template x-for="task in dashboard.recentCompleted" :key="task.task_id">
                  <div class="flex items-center justify-between p-3 bg-hq-bg/50 rounded-lg hover:bg-hq-bg transition cursor-pointer"
                       @click="switchTab('history')">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm text-hq-text truncate" x-text="task.command"></div>
                      <div class="text-[11px] text-hq-muted mt-0.5" x-text="new Date(task.created_at).toLocaleString('ko-KR', {timeZone:'Asia/Seoul'})"></div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0 ml-4">
                      <span class="text-[11px] font-mono text-hq-green" x-text="task.time_seconds + '초'"></span>
                      <span class="text-[11px] font-mono text-hq-muted" x-text="'$' + (task.cost || 0).toFixed(4)"></span>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!dashboard.recentCompleted || dashboard.recentCompleted.length === 0">
              <div class="text-center py-8 text-hq-muted/50 text-sm">아직 완료된 작업이 없습니다</div>
            </template>
          </div>

          <!-- Quick Commands -->
          <div class="glass border border-hq-border rounded-xl p-5">
            <h2 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              빠른 명령
            </h2>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="p in presets.items" :key="p.name">
                <button @click="switchTab('command'); $nextTick(() => sendPreset(p.command))"
                        class="text-left p-3 bg-hq-bg/50 rounded-lg hover:bg-hq-bg border border-transparent hover:border-hq-accent/20 transition group">
                  <div class="text-sm font-medium text-hq-text group-hover:text-white" x-text="p.name"></div>
                  <div class="text-[11px] text-hq-muted mt-1 truncate" x-text="p.command"></div>
                </button>
              </template>
              <button @click="switchTab('command')"
                      class="text-left p-3 bg-hq-bg/50 rounded-lg hover:bg-hq-bg border border-dashed border-hq-border hover:border-hq-accent/30 transition group flex items-center justify-center min-h-[60px]">
                <span class="text-sm text-hq-muted group-hover:text-hq-accent">+ 직접 명령</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 명령 (Command) ═══ -->
      <div x-show="activeTab === 'command'" x-cloak class="flex-1 flex flex-col overflow-hidden">

      <!-- Chat Messages -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-6 space-y-4 bg-grid" id="chatArea"
           x-ref="chatArea">

        <!-- ═══ Welcome Screen ═══ -->
        <template x-if="messages.length === 0">
          <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">

            <!-- Hero Logo -->
            <div class="mb-6 relative">
              <svg width="72" height="72" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-lg">
                <defs>
                  <linearGradient id="heroGrad" x1="0" y1="0" x2="32" y2="32">
                    <stop offset="0%" stop-color="#06b6d4"/>
                    <stop offset="50%" stop-color="#3b82f6"/>
                    <stop offset="100%" stop-color="#8b5cf6"/>
                  </linearGradient>
                </defs>
                <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#heroGrad)" stroke-width="1.5" fill="none"/>
                <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#heroGrad)" stroke-width="1" fill="none" opacity="0.4"/>
                <circle cx="16" cy="16" r="4" fill="url(#heroGrad)" opacity="0.8"/>
                <circle cx="16" cy="16" r="2" fill="#0a0e1a"/>
                <line x1="16" y1="12" x2="16" y2="6" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                <line x1="16" y1="20" x2="16" y2="26" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
              </svg>
              <div class="absolute inset-0 bg-hq-accent/10 rounded-full blur-3xl scale-150"></div>
            </div>

            <!-- Title -->
            <h1 class="text-4xl font-extrabold gradient-text mb-2 tracking-tight">CORTHEX HQ</h1>
            <p class="text-hq-muted text-sm mb-8 max-w-sm leading-relaxed">
              AI 에이전트 기업 관제 센터<br>
              <span class="text-hq-text/50">4개 본부, 25명의 에이전트가 명령을 대기하고 있습니다</span>
            </p>

            <!-- Division Summary Cards -->
            <div class="flex gap-3 mb-8">
              <div class="glass border border-hq-border rounded-xl px-4 py-3 hover-glow cursor-default">
                <div class="text-lg font-bold text-hq-cyan">4</div>
                <div class="text-[10px] text-hq-muted uppercase tracking-wider">본부</div>
              </div>
              <div class="glass border border-hq-border rounded-xl px-4 py-3 hover-glow cursor-default">
                <div class="text-lg font-bold text-hq-accent">25</div>
                <div class="text-[10px] text-hq-muted uppercase tracking-wider">에이전트</div>
              </div>
              <div class="glass border border-hq-border rounded-xl px-4 py-3 hover-glow cursor-default">
                <div class="text-lg font-bold text-hq-purple">5</div>
                <div class="text-[10px] text-hq-muted uppercase tracking-wider">도구</div>
              </div>
              <div class="glass border border-hq-border rounded-xl px-4 py-3 hover-glow cursor-default">
                <div class="text-lg font-bold text-hq-green">2</div>
                <div class="text-[10px] text-hq-muted uppercase tracking-wider">AI 모델</div>
              </div>
            </div>

            <!-- Preset Commands -->
            <div class="grid grid-cols-2 gap-3 max-w-lg w-full">
              <button @click="sendPreset('LEET MASTER 서비스의 기술 스택을 제안해줘')"
                      class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group">
                <div class="flex items-center gap-2 mb-1.5">
                  <div class="w-7 h-7 rounded-lg bg-hq-cyan/15 flex items-center justify-center">
                    <svg class="w-4 h-4 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                  </div>
                  <span class="text-sm font-semibold text-hq-text group-hover:text-white transition-colors">기술 스택 제안</span>
                </div>
                <p class="text-[11px] text-hq-muted leading-relaxed">CTO + 기술팀이 최적의 아키텍처를 설계합니다</p>
              </button>

              <button @click="sendPreset('삼성전자 주가를 분석해줘')"
                      class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group">
                <div class="flex items-center gap-2 mb-1.5">
                  <div class="w-7 h-7 rounded-lg bg-hq-purple/15 flex items-center justify-center">
                    <svg class="w-4 h-4 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                  </div>
                  <span class="text-sm font-semibold text-hq-text group-hover:text-white transition-colors">주가 분석</span>
                </div>
                <p class="text-[11px] text-hq-muted leading-relaxed">4명의 투자분석팀이 병렬로 분석합니다</p>
              </button>

              <button @click="sendPreset('서비스 이용약관 초안을 만들어줘')"
                      class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group">
                <div class="flex items-center gap-2 mb-1.5">
                  <div class="w-7 h-7 rounded-lg bg-hq-green/15 flex items-center justify-center">
                    <svg class="w-4 h-4 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  </div>
                  <span class="text-sm font-semibold text-hq-text group-hover:text-white transition-colors">이용약관 작성</span>
                </div>
                <p class="text-[11px] text-hq-muted leading-relaxed">CLO + 법무팀이 법적 문서를 작성합니다</p>
              </button>

              <button @click="sendPreset('마케팅 콘텐츠 전략을 수립해줘')"
                      class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group">
                <div class="flex items-center gap-2 mb-1.5">
                  <div class="w-7 h-7 rounded-lg bg-hq-yellow/15 flex items-center justify-center">
                    <svg class="w-4 h-4 text-hq-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                  </div>
                  <span class="text-sm font-semibold text-hq-text group-hover:text-white transition-colors">마케팅 전략</span>
                </div>
                <p class="text-[11px] text-hq-muted leading-relaxed">CMO + 마케팅팀이 전략을 수립합니다</p>
              </button>
            </div>

            <!-- Hint -->
            <p class="text-[11px] text-hq-muted/40 mt-6">자유롭게 명령을 입력하세요</p>
          </div>
        </template>

        <!-- ═══ Messages ═══ -->
        <template x-for="(msg, i) in messages" :key="i">
          <div class="fade-in-up">

            <!-- User message -->
            <template x-if="msg.type === 'user'">
              <div class="flex justify-end mb-4">
                <div class="max-w-2xl">
                  <div class="bg-gradient-to-br from-hq-accent/20 to-hq-purple/10 border border-hq-accent/20 rounded-2xl rounded-tr-md px-5 py-3.5 glow-blue">
                    <div class="flex items-center gap-2 mb-1.5">
                      <div class="w-5 h-5 rounded-md bg-gradient-to-br from-hq-accent to-hq-purple flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                      </div>
                      <span class="text-[11px] font-bold text-hq-accent uppercase tracking-wider">CEO 명령</span>
                    </div>
                    <div class="text-hq-text text-sm leading-relaxed" x-text="msg.text"></div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Processing indicator -->
            <template x-if="msg.type === 'processing'">
              <div class="mb-4">
                <div class="max-w-3xl">
                  <div class="glass border border-hq-yellow/20 rounded-2xl rounded-tl-md px-5 py-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
                      <span class="text-xs font-bold text-hq-yellow uppercase tracking-wider">에이전트 작업중</span>
                      <div class="ml-auto flex gap-1">
                        <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay: 0s"></span>
                        <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay: 0.3s"></span>
                        <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay: 0.6s"></span>
                      </div>
                    </div>
                    <div class="space-y-2.5">
                      <template x-for="(status, agentId) in activeAgents" :key="agentId">
                        <div x-show="status.status === 'working'" class="fade-in">
                          <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                              <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold"
                                   :class="getAgentAvatarClass(agentId)"
                                   x-text="getAgentInitials(agentId)"></div>
                              <span class="text-xs text-hq-text/80 font-medium" x-text="getAgentName(agentId)"></span>
                            </div>
                            <span class="text-[10px] font-mono text-hq-yellow" x-text="Math.round(status.progress * 100) + '%'"></span>
                          </div>
                          <div class="h-1 bg-hq-bg rounded-full overflow-hidden">
                            <div class="h-full rounded-full progress-bar bg-gradient-to-r from-hq-yellow to-hq-accent"
                                 :style="'width:' + (status.progress * 100) + '%'"></div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Agent result -->
            <template x-if="msg.type === 'result'">
              <div class="mb-4">
                <div class="max-w-4xl">
                  <div class="glass border border-hq-green/20 rounded-2xl rounded-tl-md overflow-hidden">
                    <!-- Result header -->
                    <div class="flex items-center justify-between px-5 py-3 border-b border-hq-border/50 bg-hq-green/[0.03]">
                      <div class="flex items-center gap-2.5">
                        <div class="w-2 h-2 rounded-full bg-hq-green"></div>
                        <span class="text-xs font-bold text-hq-green uppercase tracking-wider"
                              x-text="getAgentName(msg.sender_id) || '결과'"></span>
                      </div>
                      <div class="flex items-center gap-4 text-[11px] font-mono text-hq-muted">
                        <div class="flex items-center gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                          <span x-text="msg.time_seconds + 's'"></span>
                        </div>
                        <div class="flex items-center gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                          <span x-text="'$' + (msg.cost || 0).toFixed(4)"></span>
                        </div>
                      </div>
                    </div>
                    <!-- Result body -->
                    <div class="px-5 py-4">
                      <div class="text-sm leading-relaxed markdown-body"
                           x-html="renderMarkdown(msg.content)"></div>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Error -->
            <template x-if="msg.type === 'error'">
              <div class="mb-4">
                <div class="max-w-2xl">
                  <div class="bg-hq-red/5 border border-hq-red/20 rounded-2xl rounded-tl-md px-5 py-4">
                    <div class="flex items-center gap-2 mb-2">
                      <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                      <span class="text-xs font-bold text-hq-red uppercase tracking-wider">오류</span>
                    </div>
                    <div class="text-sm text-hq-text/80" x-text="msg.text"></div>
                  </div>
                </div>
              </div>
            </template>

          </div>
        </template>
      </div>

      <!-- ═══ Input Bar ═══ -->
      <div class="border-t border-hq-border bg-hq-surface/80 backdrop-blur-sm p-4 shrink-0">
        <form @submit.prevent="sendMessage()" class="flex items-center gap-3 max-w-4xl mx-auto">
          <div class="flex-1 relative">
            <input type="text"
                   x-model="inputText"
                   :disabled="systemStatus === 'working'"
                   placeholder="명령을 입력하세요..."
                   class="w-full bg-hq-bg border border-hq-border rounded-xl px-4 py-3 pr-10 text-sm text-hq-text
                          placeholder-hq-muted/50 focus:outline-none focus:border-hq-accent/50 input-glow
                          disabled:opacity-40 disabled:cursor-not-allowed transition-all"
                   autofocus>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-hq-muted/30"
                 x-show="!inputText.trim() && systemStatus !== 'working'">
              Enter &#9166;
            </div>
          </div>
          <button type="submit"
                  :disabled="!inputText.trim() || systemStatus === 'working'"
                  class="bg-gradient-to-r from-hq-accent to-hq-purple hover:from-blue-500 hover:to-violet-500
                         disabled:from-gray-700 disabled:to-gray-700 disabled:text-hq-muted
                         text-white rounded-xl px-6 py-3 text-sm font-semibold transition-all shrink-0
                         hover:shadow-lg hover:shadow-hq-accent/20 disabled:shadow-none">
            <span x-show="systemStatus !== 'working'">보내기</span>
            <span x-show="systemStatus === 'working'" class="flex items-center gap-2">
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              처리중
            </span>
          </button>
        </form>
        <!-- Preset Chips -->
        <div x-show="presets.items.length > 0" class="flex items-center gap-2 flex-wrap mt-2 max-w-4xl mx-auto">
          <template x-for="p in presets.items" :key="p.name">
            <button @click="sendPreset(p.command)"
                    :disabled="systemStatus === 'working'"
                    class="text-[11px] bg-hq-panel border border-hq-border rounded-lg px-2.5 py-1 hover:border-hq-accent/40 hover:text-hq-accent transition disabled:opacity-30 text-hq-muted">
              <span x-text="p.name"></span>
            </button>
          </template>
          <button @click="presets.showModal = true" class="text-[11px] text-hq-muted/50 hover:text-hq-accent transition px-1">
            <svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
          </button>
        </div>
      </div>
      </div><!-- /command tab -->

      <!-- ═══ Tab: 성능 (Performance) ═══ -->
      <div x-show="activeTab === 'performance'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-5xl mx-auto fade-in-up">
          <h1 class="text-xl font-bold text-white mb-1">에이전트 성능</h1>
          <p class="text-sm text-hq-muted mb-6">에이전트별 작업 통계를 확인하세요</p>

          <!-- Performance Summary Cards -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-white" x-text="performance.totalCalls || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 LLM 호출</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-green" x-text="'$' + (performance.totalCost || 0).toFixed(4)"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 비용</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-white" x-text="performance.totalTasks || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 작업</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-cyan" x-text="(performance.avgSuccessRate || 0).toFixed(0) + '%'"></div>
              <div class="text-[10px] text-hq-muted uppercase">평균 성공률</div>
            </div>
          </div>

          <!-- Agent Performance Table -->
          <div class="glass border border-hq-border rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-hq-border text-[11px] text-hq-muted uppercase">
                  <th class="text-left px-4 py-3">에이전트</th>
                  <th class="text-right px-4 py-3">호출</th>
                  <th class="text-right px-4 py-3">비용</th>
                  <th class="text-right px-4 py-3">작업</th>
                  <th class="text-right px-4 py-3">성공률</th>
                  <th class="text-right px-4 py-3">평균 시간</th>
                  <th class="px-4 py-3 w-32">비용 비율</th>
                  <th class="px-4 py-3">기억</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="a in performance.agents" :key="a.agent_id">
                  <tr class="border-b border-hq-border/50 hover:bg-white/[0.02]">
                    <td class="px-4 py-2.5">
                      <div class="text-hq-text font-medium" x-text="a.name_ko"></div>
                      <div class="text-[10px] text-hq-muted" x-text="a.role"></div>
                    </td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.llm_calls"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-green" x-text="'$' + (a.cost_usd || 0).toFixed(4)"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.tasks_completed"></td>
                    <td class="text-right px-4 py-2.5">
                      <span class="font-mono" :class="(a.success_rate||0) >= 80 ? 'text-hq-green' : (a.success_rate||0) >= 50 ? 'text-hq-yellow' : 'text-hq-red'"
                            x-text="(a.success_rate || 0).toFixed(0) + '%'"></span>
                    </td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-muted" x-text="(a.avg_execution_seconds || 0).toFixed(1) + '초'"></td>
                    <td class="px-4 py-2.5">
                      <div class="h-2 bg-hq-bg rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-hq-accent to-hq-cyan rounded-full transition-all"
                             :style="'width:' + (performance.maxCost > 0 ? ((a.cost_usd || 0) / performance.maxCost * 100) : 0) + '%'"></div>
                      </div>
                    </td>
                    <td class="px-4 py-2.5 text-center">
                      <button @click="openMemoryModal(a.agent_id, a.name_ko)"
                              class="text-[10px] px-2 py-1 rounded border border-hq-purple/30 text-hq-purple hover:bg-hq-purple/10 transition">기억</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <template x-if="!performance.agents || performance.agents.length === 0">
              <div class="text-center py-12 text-hq-muted/50 text-sm">성능 데이터가 없습니다. 작업을 실행하면 통계가 쌓입니다.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 작업내역 (History) ═══ -->
      <div x-show="activeTab === 'history'" x-cloak class="flex-1 flex flex-col overflow-hidden">
        <div class="px-6 pt-4 pb-3 shrink-0 border-b border-hq-border bg-hq-surface/30">
          <div class="flex items-center gap-3 max-w-5xl mx-auto">
            <!-- Search -->
            <div class="flex-1 relative">
              <svg class="w-4 h-4 text-hq-muted absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              <input type="text" x-model="taskHistory.search" @input.debounce.300ms="loadTaskHistory()"
                     placeholder="작업 검색..."
                     class="w-full bg-hq-bg border border-hq-border rounded-lg pl-9 pr-4 py-2 text-sm text-hq-text placeholder-hq-muted/50 focus:outline-none focus:border-hq-accent/50">
            </div>
            <!-- Status Filter -->
            <select x-model="taskHistory.filterStatus" @change="loadTaskHistory()"
                    class="bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:outline-none">
              <option value="all">전체</option>
              <option value="completed">완료</option>
              <option value="failed">실패</option>
              <option value="running">진행중</option>
            </select>
            <!-- Bookmark Filter -->
            <button @click="taskHistory.bookmarkOnly = !taskHistory.bookmarkOnly; loadTaskHistory()"
                    :class="taskHistory.bookmarkOnly ? 'text-hq-yellow border-hq-yellow/30' : 'text-hq-muted border-hq-border'"
                    class="border rounded-lg px-3 py-2 text-sm transition hover:text-hq-yellow">
              &#9733;
            </button>
            <!-- Compare Button -->
            <button x-show="taskHistory.selectedIds.length === 2"
                    @click="openComparison()"
                    class="bg-hq-accent/20 text-hq-accent border border-hq-accent/30 rounded-lg px-3 py-2 text-xs font-semibold hover:bg-hq-accent/30 transition">
              비교하기
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
          <div class="max-w-5xl mx-auto space-y-2">
            <template x-for="task in taskHistory.items" :key="task.task_id">
              <div class="glass border rounded-xl p-4 hover-glow transition"
                   :class="taskHistory.selectedIds.includes(task.task_id) ? 'border-hq-accent/40' : 'border-hq-border'">
                <div class="flex items-start gap-3">
                  <!-- Checkbox -->
                  <input type="checkbox" :value="task.task_id"
                         @change="toggleTaskSelect(task.task_id)"
                         :checked="taskHistory.selectedIds.includes(task.task_id)"
                         class="mt-1 rounded border-hq-border bg-hq-bg text-hq-accent focus:ring-hq-accent/50">
                  <!-- Bookmark -->
                  <button @click="toggleBookmark(task.task_id)"
                          class="mt-0.5 text-lg transition"
                          :class="task.bookmarked ? 'text-hq-yellow' : 'text-hq-muted/30 hover:text-hq-yellow/50'">
                    &#9733;
                  </button>
                  <!-- Content -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="status-badge"
                            :class="task.status === 'completed' ? 'bg-hq-green/15 text-hq-green border border-hq-green/20' :
                                    task.status === 'failed' ? 'bg-hq-red/15 text-hq-red border border-hq-red/20' :
                                    task.status === 'running' ? 'bg-hq-yellow/15 text-hq-yellow border border-hq-yellow/20' :
                                    'bg-hq-muted/15 text-hq-muted border border-hq-border'"
                            x-text="task.status === 'completed' ? '완료' : task.status === 'failed' ? '실패' : task.status === 'running' ? '진행중' : '대기'"></span>
                      <span class="text-[11px] text-hq-muted" x-text="new Date(task.created_at).toLocaleString('ko-KR', {timeZone:'Asia/Seoul'})"></span>
                    </div>
                    <div class="text-sm text-hq-text mb-1" x-text="task.command"></div>
                    <div x-show="task.summary" class="text-[12px] text-hq-muted truncate" x-text="task.summary"></div>
                    <!-- Expandable Detail -->
                    <div x-show="taskHistory.expandedId === task.task_id" class="mt-3 pt-3 border-t border-hq-border/50">
                      <div class="text-sm markdown-body max-h-96 overflow-y-auto" x-html="renderMarkdown(task._fullResult || '')"></div>
                      <!-- Replay Button -->
                      <button x-show="task.correlation_id"
                              @click="loadReplay(task.correlation_id, task.task_id)"
                              class="mt-3 text-xs text-hq-accent hover:text-blue-400 flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        내부 대화 보기
                      </button>
                      <!-- Replay Tree -->
                      <div x-show="taskHistory.replayData[task.task_id]" class="mt-3 pl-4 border-l-2 border-hq-accent/20">
                        <div class="text-xs text-hq-muted mb-2 font-semibold">에이전트 간 대화 흐름</div>
                        <div x-html="renderReplayTree(taskHistory.replayData[task.task_id])"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Meta -->
                  <div class="flex items-center gap-3 shrink-0">
                    <span class="text-[11px] font-mono text-hq-muted" x-text="task.time_seconds ? task.time_seconds + '초' : ''"></span>
                    <span class="text-[11px] font-mono text-hq-green" x-text="task.cost ? '$' + task.cost.toFixed(4) : ''"></span>
                    <button @click="taskHistory.expandedId = taskHistory.expandedId === task.task_id ? null : task.task_id; if(taskHistory.expandedId === task.task_id) loadTaskDetail(task.task_id)"
                            class="text-hq-muted hover:text-white transition text-xs">
                      <span x-text="taskHistory.expandedId === task.task_id ? '접기' : '펼치기'"></span>
                    </button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!taskHistory.items || taskHistory.items.length === 0">
              <div class="text-center py-16 text-hq-muted/50 text-sm">작업 내역이 없습니다</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 예약 (Schedule) ═══ -->
      <div x-show="activeTab === 'schedule'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-white mb-1">작업 예약</h1>
              <p class="text-sm text-hq-muted">반복 작업을 자동으로 실행합니다</p>
            </div>
            <button @click="schedules.showModal = true"
                    class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-semibold transition">
              + 새 예약
            </button>
          </div>

          <div class="space-y-3">
            <template x-for="s in schedules.items" :key="s.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-sm font-semibold text-white" x-text="s.name"></span>
                      <span class="status-badge" :class="s.enabled ? 'bg-hq-green/15 text-hq-green border border-hq-green/20' : 'bg-hq-muted/15 text-hq-muted border border-hq-border'"
                            x-text="s.enabled ? '활성' : '비활성'"></span>
                    </div>
                    <div class="text-[12px] text-hq-muted mb-1" x-text="s.command"></div>
                    <div class="flex items-center gap-3 text-[11px] text-hq-muted/70">
                      <span x-text="'주기: ' + (s.cron_label || s.cron)"></span>
                      <span x-show="s.last_run" x-text="'마지막: ' + s.last_run"></span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button @click="toggleSchedule(s.id)"
                            class="text-xs px-3 py-1.5 rounded-lg border transition"
                            :class="s.enabled ? 'border-hq-yellow/30 text-hq-yellow hover:bg-hq-yellow/10' : 'border-hq-green/30 text-hq-green hover:bg-hq-green/10'"
                            x-text="s.enabled ? '중지' : '시작'"></button>
                    <button @click="deleteSchedule(s.id)"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!schedules.items || schedules.items.length === 0">
              <div class="text-center py-16 text-hq-muted/50 text-sm">예약된 작업이 없습니다. 새 예약을 추가해보세요.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 워크플로우 (Workflow) ═══ -->
      <div x-show="activeTab === 'workflow'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-white mb-1">워크플로우</h1>
              <p class="text-sm text-hq-muted">여러 단계를 연결해서 자동화 흐름을 만드세요</p>
            </div>
            <button @click="workflows.showEditor = true; workflows.editing = null; workflows.editSteps = [{name:'', command:''}]"
                    class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-semibold transition">
              + 새 워크플로우
            </button>
          </div>

          <div class="space-y-3">
            <template x-for="wf in workflows.items" :key="wf.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="text-sm font-semibold text-white mb-1" x-text="wf.name"></div>
                    <div class="text-[12px] text-hq-muted" x-text="wf.description || wf.steps.length + '단계'"></div>
                    <div class="flex items-center gap-2 mt-2">
                      <template x-for="(step, i) in wf.steps" :key="i">
                        <div class="flex items-center gap-1">
                          <span class="text-[10px] bg-hq-accent/10 text-hq-accent rounded px-1.5 py-0.5" x-text="step.name || ('단계 ' + (i+1))"></span>
                          <span x-show="i < wf.steps.length - 1" class="text-hq-muted/30 text-[10px]">→</span>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button @click="runWorkflow(wf.id)"
                            :disabled="workflows.runningId === wf.id"
                            class="bg-hq-green/20 text-hq-green border border-hq-green/30 rounded-lg px-3 py-1.5 text-xs font-semibold hover:bg-hq-green/30 transition disabled:opacity-50">
                      <span x-show="workflows.runningId !== wf.id">실행</span>
                      <span x-show="workflows.runningId === wf.id">진행중...</span>
                    </button>
                    <button @click="editWorkflow(wf)"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-border text-hq-muted hover:text-white transition">수정</button>
                    <button @click="deleteWorkflow(wf.id)"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!workflows.items || workflows.items.length === 0">
              <div class="text-center py-16 text-hq-muted/50 text-sm">워크플로우가 없습니다. 새 워크플로우를 만들어보세요.</div>
            </template>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ═══ Schedule Add Modal (예약 추가) ═══ -->
  <div x-show="schedules.showModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="schedules.showModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-[500px] p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-white">새 예약 추가</h2>
        <button @click="schedules.showModal = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">예약 이름</label>
          <input x-model="schedules.editName" placeholder="예: 일일 보고서"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-white focus:border-hq-accent outline-none">
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행할 명령</label>
          <textarea x-model="schedules.editCommand" placeholder="예: 오늘 회사 현황을 보고서로 작성해줘" rows="2"
                    class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-white focus:border-hq-accent outline-none resize-none"></textarea>
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행 주기</label>
          <div class="grid grid-cols-2 gap-2">
            <template x-for="preset in schedules.cronPresets" :key="preset">
              <button @click="schedules.editCronPreset = preset"
                      class="text-xs px-3 py-2 rounded-lg border transition text-left"
                      :class="schedules.editCronPreset === preset
                        ? 'border-hq-accent bg-hq-accent/15 text-hq-accent'
                        : 'border-hq-border text-hq-muted hover:border-hq-border-light'"
                      x-text="preset"></button>
            </template>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="schedules.showModal = false"
                class="px-4 py-2 text-sm text-hq-muted hover:text-white transition">취소</button>
        <button @click="addSchedule()"
                class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition">추가</button>
      </div>
    </div>
  </div>

  <!-- ═══ Agent Memory Modal (에이전트 기억) ═══ -->
  <div x-show="memoryModal.visible" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="memoryModal.visible = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-[600px] max-h-[80vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-white">
          <span x-text="memoryModal.agentName"></span> 기억 관리
        </h2>
        <button @click="memoryModal.visible = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>

      <!-- 기억 추가 -->
      <div class="bg-hq-bg rounded-xl p-4 mb-4">
        <div class="text-xs text-hq-muted font-semibold mb-2">새 기억 추가</div>
        <div class="flex gap-2 mb-2">
          <input x-model="memoryModal.newKey" placeholder="제목 (예: 선호하는 보고서 형식)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-white focus:border-hq-accent outline-none">
        </div>
        <div class="flex gap-2">
          <input x-model="memoryModal.newValue" placeholder="내용 (예: 표와 그래프를 포함한 형식 선호)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-white focus:border-hq-accent outline-none"
                 @keydown.enter="addMemory()">
          <button @click="addMemory()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-1.5 text-xs font-semibold transition">추가</button>
        </div>
      </div>

      <!-- 기억 목록 -->
      <div class="space-y-2">
        <template x-for="mem in memoryModal.items" :key="mem.memory_id">
          <div class="flex items-start gap-3 bg-hq-bg rounded-lg p-3 group">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-semibold text-hq-accent" x-text="mem.key"></span>
                <span class="text-[10px] px-1.5 py-0.5 rounded"
                      :class="mem.source === 'auto' ? 'bg-hq-purple/15 text-hq-purple' : 'bg-hq-green/15 text-hq-green'"
                      x-text="mem.source === 'auto' ? '자동' : '수동'"></span>
              </div>
              <div class="text-xs text-hq-muted" x-text="mem.value"></div>
            </div>
            <button @click="deleteMemory(mem.memory_id)"
                    class="text-hq-red/50 hover:text-hq-red text-sm opacity-0 group-hover:opacity-100 transition">&times;</button>
          </div>
        </template>
        <template x-if="!memoryModal.items || memoryModal.items.length === 0">
          <div class="text-center py-8 text-hq-muted/50 text-sm">아직 저장된 기억이 없습니다.</div>
        </template>
      </div>
    </div>
  </div>

  <!-- ═══ Quality Gate Settings Modal ═══ -->
  <div x-show="showQualitySettings" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showQualitySettings = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-[700px] max-h-[80vh] overflow-y-auto p-6"
         @click.stop>

      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-white">품질 검수 설정</h2>
        <button @click="showQualitySettings = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>

      <!-- Section 1: Review Model Selection -->
      <div class="mb-6 p-4 bg-hq-bg rounded-xl">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">검수 모델</h3>
        <p class="text-xs text-gray-500 mb-3">모든 품질 검수에 사용할 AI 모델을 선택하세요.</p>
        <div class="flex items-center gap-3">
          <select x-model="selectedReviewModel"
                  class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200">
            <template x-for="m in availableModels" :key="m.name">
              <option :value="m.name"
                      x-text="m.name + ' (' + m.provider + ', $' + m.cost_input + '/' + m.cost_output + ')'">
              </option>
            </template>
          </select>
          <button @click="saveReviewModel()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm whitespace-nowrap">
            저장
          </button>
        </div>
      </div>

      <!-- Section 2: Common Rubric -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">공통 검수 기준</h3>
        <p class="text-xs text-gray-500 mb-3">부서별 기준이 없는 부서에 기본 적용되는 검수 기준입니다.</p>

        <div class="p-3 bg-hq-bg rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-sm text-gray-200 font-medium">기본 (전체 공통)</span>
              <span x-show="qualityRules.rubrics && qualityRules.rubrics['default']"
                    class="ml-2 text-xs text-green-400">설정됨</span>
            </div>
            <button @click="startEditRubric('default')"
                    class="text-xs text-hq-accent hover:text-blue-400">편집</button>
          </div>
          <template x-if="qualityRules.rubrics && qualityRules.rubrics['default']">
            <p class="text-xs text-gray-500 mt-1 truncate"
               x-text="qualityRules.rubrics['default'].prompt.substring(0, 80) + '...'"></p>
          </template>
        </div>
      </div>

      <!-- Section 3: Department-Specific Rubrics -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">부서별 검수 기준 (루브릭)</h3>
        <p class="text-xs text-gray-500 mb-3">각 부서별 검수 기준을 설정하세요. 미설정 부서는 위 공통 기준이 적용됩니다.</p>

        <div class="space-y-2">
          <template x-for="div in (qualityRules.known_divisions || [])" :key="div">
            <div class="p-3 bg-hq-bg rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-sm text-gray-200 font-medium" x-text="getDivisionLabel(div)"></span>
                  <span x-show="qualityRules.rubrics && qualityRules.rubrics[div]"
                        class="ml-2 text-xs text-green-400">설정됨</span>
                  <span x-show="!qualityRules.rubrics || !qualityRules.rubrics[div]"
                        class="ml-2 text-xs text-gray-500">공통 적용</span>
                </div>
                <button @click="startEditRubric(div)"
                        class="text-xs text-hq-accent hover:text-blue-400">편집</button>
              </div>
              <template x-if="qualityRules.rubrics && qualityRules.rubrics[div]">
                <p class="text-xs text-gray-500 mt-1 truncate"
                   x-text="qualityRules.rubrics[div].prompt.substring(0, 80) + '...'"></p>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Rubric Editor -->
      <div x-show="editingRubric !== null" class="mt-4 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
        <h4 class="text-sm font-semibold text-hq-accent mb-3"
            x-text="getDivisionLabel(editingRubric) + ' 검수 기준 편집'"></h4>
        <div class="mb-3">
          <label class="text-xs text-gray-400 mb-1 block">기준 이름</label>
          <input x-model="rubricEditName"
                 class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200"
                 placeholder="예: 기술개발처 검수 기준">
        </div>
        <div class="mb-3">
          <label class="text-xs text-gray-400 mb-1 block">검수 기준 (프롬프트)</label>
          <textarea x-model="rubricEditPrompt" rows="8"
                    class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200 resize-y font-mono"
                    placeholder="다음 기준으로 검수하세요:&#10;1. ...&#10;2. ...&#10;3. ..."></textarea>
        </div>
        <div class="flex items-center gap-2">
          <button @click="saveRubric()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm">저장</button>
          <button @click="editingRubric = null"
                  class="bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg px-4 py-2 text-sm">취소</button>
        </div>
      </div>

      <!-- Save status -->
      <div class="mt-4 text-center h-5">
        <span x-show="qualitySaveStatus === 'saving'" class="text-xs text-yellow-400">저장 중...</span>
        <span x-show="qualitySaveStatus === 'saved'" class="text-xs text-green-400">저장 완료 (Git 동기화됨)</span>
        <span x-show="qualitySaveStatus === 'error'" class="text-xs text-red-400">저장 실패</span>
      </div>
    </div>
  </div>

  <script>
    function corthexApp() {
      return {
        // State
        inputText: '',
        messages: [],
        systemStatus: 'idle',
        wsConnected: false,
        totalCost: 0,
        totalTokens: 0,
        activityLogs: [],
        activeAgents: {},
        ws: null,
        logExpanded: true,

        // ── Tab System ──
        activeTab: 'home',
        tabs: [
          { id: 'home', label: '홈', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>' },
          { id: 'command', label: '명령', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
          { id: 'performance', label: '성능', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>' },
          { id: 'history', label: '작업내역', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' },
          { id: 'schedule', label: '예약', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
          { id: 'workflow', label: '워크플로우', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>' },
        ],

        // ── Dashboard (홈) ──
        dashboard: { todayTasks: 0, todayCompleted: 0, todayFailed: 0, runningCount: 0, totalCost: 0, totalTokens: 0, agentCount: 0, recentCompleted: [], systemHealth: 'ok', loaded: false },

        // ── Presets (명령 템플릿) ──
        presets: { items: [], showModal: false, editName: '', editCommand: '' },

        // ── Task History (작업내역) ──
        taskHistory: { items: [], search: '', filterStatus: 'all', filterDateFrom: '', filterDateTo: '', bookmarkOnly: false, selectedIds: [], expandedId: null, replayData: {}, compareMode: false, compareA: null, compareB: null, loaded: false },

        // ── Performance (성능) ──
        performance: { agents: [], totalCalls: 0, totalCost: 0, totalTasks: 0, avgSuccessRate: 0, maxCost: 0, loaded: false },

        // ── Error Alert ──
        errorAlert: { visible: false, message: '', severity: 'error' },

        // ── Schedules (예약) ──
        schedules: {
          items: [], showModal: false, editName: '', editCommand: '',
          editCronPreset: '매일 오전 9시',
          cronPresets: ['매일 오전 9시', '매일 오후 6시', '매주 월요일 오전 10시', '매주 금요일 오후 5시', '매시간', '30분마다'],
        },

        // ── Workflows (워크플로우) ──
        workflows: { items: [], showEditor: false, editing: null, editName: '', editDesc: '', editSteps: [{ name: '', command: '' }], runningId: null },

        // ── Auth (인증) ──
        auth: { user: null, token: null, showLogin: false, loginUser: '', loginPass: '' },

        // ── Memory Modal (에이전트 기억) ──
        memoryModal: { visible: false, agentId: '', agentName: '', items: [], newKey: '', newValue: '' },

        // Quality gate settings
        showQualitySettings: false,
        qualityRules: { rules: {}, rubrics: {}, known_divisions: [] },
        availableModels: [],
        selectedReviewModel: '',
        editingRubric: null,
        rubricEditName: '',
        rubricEditPrompt: '',
        qualitySaveStatus: '',

        // Org tree expand state
        expanded: {
          secretary: false,
          leet_master: true,
          tech: false,
          strategy: false,
          legal: false,
          marketing: false,
          investment: true,
          finance: false,
          tools: false,
        },

        // Agent name mapping
        agentNames: {
          'chief_of_staff': '비서실장',
          'report_worker': '보고 요약',
          'schedule_worker': '일정 추적',
          'relay_worker': '정보 중계',
          'cto_manager': 'CTO 기술개발처장',
          'frontend_specialist': '프론트엔드',
          'backend_specialist': '백엔드/API',
          'infra_specialist': 'DB/인프라',
          'ai_model_specialist': 'AI 모델',
          'cso_manager': 'CSO 사업기획처장',
          'market_research_specialist': '시장조사',
          'business_plan_specialist': '사업계획서',
          'financial_model_specialist': '재무모델링',
          'clo_manager': 'CLO 법무 IP처장',
          'copyright_specialist': '저작권',
          'patent_specialist': '특허/약관',
          'cmo_manager': 'CMO 마케팅처장',
          'survey_specialist': '설문/리서치',
          'content_specialist': '콘텐츠',
          'community_specialist': '커뮤니티',
          'cio_manager': 'CIO 투자분석처장',
          'market_condition_specialist': '시황분석',
          'stock_analysis_specialist': '종목분석',
          'technical_analysis_specialist': '기술적분석',
          'risk_management_specialist': '리스크관리',
        },

        // Agent initials for avatars
        agentInitials: {
          'chief_of_staff': 'CS',
          'report_worker': 'RP',
          'schedule_worker': 'SC',
          'relay_worker': 'RL',
          'cto_manager': 'CTO',
          'frontend_specialist': 'FE',
          'backend_specialist': 'BE',
          'infra_specialist': 'IF',
          'ai_model_specialist': 'AI',
          'cso_manager': 'CSO',
          'market_research_specialist': 'MR',
          'business_plan_specialist': 'BP',
          'financial_model_specialist': 'FM',
          'clo_manager': 'CLO',
          'copyright_specialist': 'CR',
          'patent_specialist': 'PT',
          'cmo_manager': 'CMO',
          'survey_specialist': 'SV',
          'content_specialist': 'CT',
          'community_specialist': 'CM',
          'cio_manager': 'CIO',
          'market_condition_specialist': 'MC',
          'stock_analysis_specialist': 'SA',
          'technical_analysis_specialist': 'TA',
          'risk_management_specialist': 'RM',
        },

        // Division mapping for auto-expand
        agentDivision: {
          'chief_of_staff': 'secretary', 'report_worker': 'secretary',
          'schedule_worker': 'secretary', 'relay_worker': 'secretary',
          'cto_manager': 'tech',
          'frontend_specialist': 'tech', 'backend_specialist': 'tech',
          'infra_specialist': 'tech', 'ai_model_specialist': 'tech',
          'cso_manager': 'strategy', 'market_research_specialist': 'strategy',
          'business_plan_specialist': 'strategy', 'financial_model_specialist': 'strategy',
          'clo_manager': 'legal', 'copyright_specialist': 'legal',
          'patent_specialist': 'legal', 'cmo_manager': 'marketing',
          'survey_specialist': 'marketing', 'content_specialist': 'marketing',
          'community_specialist': 'marketing',
          'cio_manager': 'finance', 'market_condition_specialist': 'finance',
          'stock_analysis_specialist': 'finance', 'technical_analysis_specialist': 'finance',
          'risk_management_specialist': 'finance',
        },

        // Agent color mapping
        agentColorMap: {
          'secretary': 'bg-hq-yellow/20 text-hq-yellow',
          'tech': 'bg-hq-cyan/20 text-hq-cyan',
          'strategy': 'bg-hq-cyan/20 text-hq-cyan',
          'legal': 'bg-hq-cyan/20 text-hq-cyan',
          'marketing': 'bg-hq-cyan/20 text-hq-cyan',
          'finance': 'bg-hq-purple/20 text-hq-purple',
        },

        init() {
          this.connectWebSocket();
          this.loadDashboard();
          this.loadPresets();
        },

        connectWebSocket() {
          const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
          this.ws = new WebSocket(`${protocol}//${location.host}/ws`);

          this.ws.onopen = () => {
            this.wsConnected = true;
          };

          this.ws.onclose = () => {
            this.wsConnected = false;
            setTimeout(() => this.connectWebSocket(), 3000);
          };

          this.ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            this.handleWsMessage(msg);
          };
        },

        handleWsMessage(msg) {
          switch (msg.event) {
            case 'processing_start':
              this.systemStatus = 'working';
              this.messages.push({ type: 'processing', id: Date.now() });
              break;

            case 'agent_status':
              const d = msg.data;
              this.activeAgents[d.agent_id] = {
                status: d.status,
                progress: d.progress || 0,
              };

              if (d.status === 'working') {
                const div = this.agentDivision[d.agent_id];
                if (div) {
                  this.expanded[div] = true;
                  if (['tech','strategy','legal','marketing'].includes(div)) {
                    this.expanded.leet_master = true;
                  }
                  if (div === 'finance') {
                    this.expanded.investment = true;
                  }
                }
              }

              if (d.status === 'working' && d.progress < 0.9) {
                this.simulateProgress(d.agent_id);
              }
              break;

            case 'activity_log':
              msg.data.time = new Date().toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false });
              this.activityLogs.push(msg.data);
              break;

            case 'cost_update':
              this.totalCost = msg.data.total_cost;
              this.totalTokens = msg.data.total_tokens;
              break;

            case 'result':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({
                type: 'result',
                content: msg.data.content,
                sender_id: msg.data.sender_id,
                time_seconds: msg.data.time_seconds,
                cost: msg.data.cost,
              });
              this.systemStatus = 'idle';
              this.totalCost = msg.data.cost || this.totalCost;
              this.$nextTick(() => this.scrollToBottom());
              break;

            case 'error':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({ type: 'error', text: msg.data.message });
              this.systemStatus = 'error';
              this.errorAlert = { visible: true, message: msg.data.message || '오류가 발생했습니다', severity: 'error' };
              setTimeout(() => { this.systemStatus = 'idle'; }, 3000);
              setTimeout(() => { this.errorAlert.visible = false; }, 10000);
              break;

            case 'error_alert':
              this.errorAlert = { visible: true, message: msg.data.message, severity: msg.data.severity || 'error' };
              if (msg.data.severity !== 'critical') {
                setTimeout(() => { this.errorAlert.visible = false; }, 10000);
              }
              break;

            case 'task_completed':
              // Refresh dashboard if on home tab
              if (this.activeTab === 'home') this.loadDashboard();
              if (this.activeTab === 'history') this.loadTaskHistory();
              break;
          }
        },

        simulateProgress(agentId) {
          const interval = setInterval(() => {
            if (!this.activeAgents[agentId] || this.activeAgents[agentId].status !== 'working') {
              clearInterval(interval);
              return;
            }
            const current = this.activeAgents[agentId].progress;
            if (current < 0.9) {
              this.activeAgents[agentId].progress = Math.min(0.9, current + 0.05 + Math.random() * 0.1);
            } else {
              clearInterval(interval);
            }
          }, 800);
        },

        sendMessage() {
          const text = this.inputText.trim();
          if (!text || this.systemStatus === 'working') return;

          this.messages.push({ type: 'user', text });
          this.inputText = '';
          this.activeAgents = {};

          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'command', text }));
          }

          this.$nextTick(() => this.scrollToBottom());
        },

        sendPreset(text) {
          this.inputText = text;
          this.sendMessage();
        },

        toggleSection(section) {
          this.expanded[section] = !this.expanded[section];
        },

        getAgentName(id) {
          return this.agentNames[id] || id;
        },

        getAgentInitials(id) {
          return this.agentInitials[id] || id.substring(0, 2).toUpperCase();
        },

        getAgentAvatarClass(id) {
          const div = this.agentDivision[id];
          return this.agentColorMap[div] || 'bg-hq-accent/20 text-hq-accent';
        },

        getAgentDotClass(id) {
          const status = this.activeAgents[id];
          if (!status) return 'bg-hq-muted/40';
          switch (status.status) {
            case 'working': return 'bg-hq-green pulse-dot';
            case 'done': return 'bg-hq-green';
            case 'idle': return 'bg-hq-muted/40';
            default: return 'bg-hq-muted/30';
          }
        },

        getSectionBadgeClass(section) {
          const ids = this.getSectionAgentIds(section);
          const hasWorking = ids.some(id => this.activeAgents[id]?.status === 'working');
          if (hasWorking) return 'bg-hq-yellow/15 text-hq-yellow border border-hq-yellow/20';
          const hasDone = ids.some(id => this.activeAgents[id]?.status === 'done');
          if (hasDone) return 'bg-hq-green/15 text-hq-green border border-hq-green/20';
          return 'hidden';
        },

        getSectionStatusColor(section) {
          const ids = this.getSectionAgentIds(section);
          const hasWorking = ids.some(id => this.activeAgents[id]?.status === 'working');
          if (hasWorking) return 'text-hq-yellow';
          const hasDone = ids.some(id => this.activeAgents[id]?.status === 'done');
          if (hasDone) return 'text-hq-green';
          return 'text-hq-muted/30';
        },

        getSectionStatusText(section) {
          const ids = this.getSectionAgentIds(section);
          const working = ids.filter(id => this.activeAgents[id]?.status === 'working').length;
          if (working > 0) return `${working}명 작업중`;
          const done = ids.filter(id => this.activeAgents[id]?.status === 'done').length;
          if (done > 0) return `${done}명 완료`;
          return '';
        },

        getSectionAgentIds(section) {
          if (section === 'leet_master') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => ['tech','strategy','legal','marketing'].includes(div))
              .map(([id]) => id);
          }
          if (section === 'investment') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => div === 'finance')
              .map(([id]) => id);
          }
          return Object.entries(this.agentDivision)
            .filter(([_, div]) => div === section)
            .map(([id]) => id);
        },

        renderMarkdown(text) {
          try { return marked.parse(text || ''); }
          catch { return text; }
        },

        // ── Quality Gate Settings ──────────────────

        async loadQualityRules() {
          try {
            const [rulesRes, modelsRes] = await Promise.all([
              fetch('/api/quality-rules').then(r => r.json()),
              fetch('/api/available-models').then(r => r.json()),
            ]);
            this.qualityRules = rulesRes;
            this.availableModels = modelsRes;
            this.selectedReviewModel = rulesRes.rules?.review_model || 'gpt-4o-mini';
          } catch (e) {
            console.error('Failed to load quality rules:', e);
          }
        },

        async saveReviewModel() {
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch('/api/quality-rules/model', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ review_model: this.selectedReviewModel }),
            }).then(r => r.json());
            this.qualitySaveStatus = res.success ? 'saved' : 'error';
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        startEditRubric(division) {
          this.editingRubric = division;
          const rubric = this.qualityRules.rubrics?.[division] || { name: '', prompt: '' };
          this.rubricEditName = rubric.name || '';
          this.rubricEditPrompt = rubric.prompt || '';
        },

        async saveRubric() {
          if (!this.editingRubric) return;
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch(`/api/quality-rules/rubric/${this.editingRubric}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
              }),
            }).then(r => r.json());
            if (res.success) {
              if (!this.qualityRules.rubrics) this.qualityRules.rubrics = {};
              this.qualityRules.rubrics[this.editingRubric] = {
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
              };
              this.editingRubric = null;
              this.qualitySaveStatus = 'saved';
            } else {
              this.qualitySaveStatus = 'error';
            }
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        getDivisionLabel(division) {
          const labels = {
            'default': '기본 (전체 공통)',
            'secretary': '비서실',
            'leet_master.tech': '기술개발처 (CTO)',
            'leet_master.strategy': '사업기획처 (CSO)',
            'leet_master.legal': '법무처 (CLO)',
            'leet_master.marketing': '마케팅처 (CMO)',
            'finance.investment': '투자분석처 (CIO)',
          };
          return labels[division] || division;
        },

        // ── Tab Switching ──

        switchTab(tabId) {
          this.activeTab = tabId;
          if (tabId === 'home' && !this.dashboard.loaded) this.loadDashboard();
          if (tabId === 'performance' && !this.performance.loaded) this.loadPerformance();
          if (tabId === 'history' && !this.taskHistory.loaded) this.loadTaskHistory();
          if (tabId === 'schedule') this.loadSchedules();
          if (tabId === 'workflow') this.loadWorkflows();
        },

        // ── Dashboard ──

        async loadDashboard() {
          try {
            const data = await fetch('/api/dashboard').then(r => r.json());
            this.dashboard = {
              todayTasks: data.today_task_count || 0,
              todayCompleted: data.today_completed || 0,
              todayFailed: data.today_failed || 0,
              runningCount: data.running_count || 0,
              totalCost: data.total_cost || 0,
              totalTokens: data.total_tokens || 0,
              agentCount: data.agent_count || 0,
              recentCompleted: data.recent_completed || [],
              systemHealth: data.system_health || 'ok',
              loaded: true,
            };
          } catch (e) { console.error('Dashboard load failed:', e); }
        },

        // ── Presets ──

        async loadPresets() {
          try {
            const data = await fetch('/api/presets').then(r => r.json());
            this.presets.items = data || [];
          } catch (e) { console.error('Presets load failed:', e); }
        },

        async addPreset() {
          const name = this.presets.editName.trim();
          const command = this.presets.editCommand.trim();
          if (!name || !command) return;
          try {
            await fetch('/api/presets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, command }),
            });
            this.presets.editName = '';
            this.presets.editCommand = '';
            await this.loadPresets();
          } catch (e) { console.error('Add preset failed:', e); }
        },

        async deletePreset(name) {
          try {
            await fetch(`/api/presets/${encodeURIComponent(name)}`, { method: 'DELETE' });
            await this.loadPresets();
          } catch (e) { console.error('Delete preset failed:', e); }
        },

        // ── Performance ──

        async loadPerformance() {
          try {
            const data = await fetch('/api/performance').then(r => r.json());
            const agents = data.agents || [];
            const maxCost = Math.max(...agents.map(a => a.cost_usd || 0), 0.0001);
            const totalTasks = agents.reduce((s, a) => s + (a.tasks_completed || 0), 0);
            const rates = agents.filter(a => a.tasks_completed > 0).map(a => a.success_rate || 0);
            const avgRate = rates.length > 0 ? rates.reduce((s, r) => s + r, 0) / rates.length : 0;
            this.performance = {
              agents,
              totalCalls: data.total_llm_calls || 0,
              totalCost: data.total_cost_usd || 0,
              totalTasks,
              avgSuccessRate: avgRate,
              maxCost,
              loaded: true,
            };
          } catch (e) { console.error('Performance load failed:', e); }
        },

        // ── Task History ──

        async loadTaskHistory() {
          try {
            const params = new URLSearchParams();
            if (this.taskHistory.search) params.set('keyword', this.taskHistory.search);
            if (this.taskHistory.filterStatus !== 'all') params.set('status', this.taskHistory.filterStatus);
            if (this.taskHistory.bookmarkOnly) params.set('bookmarked', 'true');
            const data = await fetch('/api/tasks?' + params.toString()).then(r => r.json());
            this.taskHistory.items = data || [];
            this.taskHistory.loaded = true;
          } catch (e) { console.error('Task history load failed:', e); }
        },

        async loadTaskDetail(taskId) {
          try {
            const data = await fetch(`/api/tasks/${taskId}`).then(r => r.json());
            const task = this.taskHistory.items.find(t => t.task_id === taskId);
            if (task) {
              task._fullResult = data.result_data || '';
              task.correlation_id = data.correlation_id || '';
            }
          } catch (e) { console.error('Task detail load failed:', e); }
        },

        async toggleBookmark(taskId) {
          try {
            const res = await fetch(`/api/tasks/${taskId}/bookmark`, { method: 'POST' }).then(r => r.json());
            const task = this.taskHistory.items.find(t => t.task_id === taskId);
            if (task) task.bookmarked = res.bookmarked;
          } catch (e) { console.error('Bookmark toggle failed:', e); }
        },

        toggleTaskSelect(taskId) {
          const idx = this.taskHistory.selectedIds.indexOf(taskId);
          if (idx >= 0) {
            this.taskHistory.selectedIds.splice(idx, 1);
          } else {
            if (this.taskHistory.selectedIds.length >= 2) this.taskHistory.selectedIds.shift();
            this.taskHistory.selectedIds.push(taskId);
          }
        },

        async openComparison() {
          if (this.taskHistory.selectedIds.length !== 2) return;
          try {
            const [a, b] = await Promise.all(
              this.taskHistory.selectedIds.map(id => fetch(`/api/tasks/${id}`).then(r => r.json()))
            );
            this.taskHistory.compareA = a;
            this.taskHistory.compareB = b;
            this.taskHistory.compareMode = true;
          } catch (e) { console.error('Comparison load failed:', e); }
        },

        async loadReplay(correlationId, taskId) {
          if (this.taskHistory.replayData[taskId]) {
            this.taskHistory.replayData[taskId] = null;
            return;
          }
          try {
            const data = await fetch(`/api/replay/${correlationId}`).then(r => r.json());
            this.taskHistory.replayData[taskId] = data;
          } catch (e) { console.error('Replay load failed:', e); }
        },

        renderReplayTree(data) {
          if (!data || !data.root) return '<div class="text-xs text-hq-muted">데이터 없음</div>';
          const renderNode = (node, depth = 0) => {
            const indent = depth * 16;
            const icon = node.type === 'task_request' ? '→' : '←';
            const color = node.success === false ? 'text-hq-red' : node.type === 'task_result' ? 'text-hq-green' : 'text-hq-cyan';
            let html = `<div style="margin-left:${indent}px" class="py-1 text-[11px]">`;
            html += `<span class="${color} font-semibold">${icon} ${node.sender_id || ''}</span>`;
            html += `<span class="text-hq-muted ml-1">${(node.detail || node.summary || '').substring(0, 100)}</span>`;
            if (node.time) html += `<span class="text-hq-muted/50 ml-1 font-mono">${node.time}s</span>`;
            html += '</div>';
            if (node.children) {
              for (const child of node.children) {
                html += renderNode(child, depth + 1);
              }
            }
            return html;
          };
          return renderNode(data.root);
        },

        // ── Memory (에이전트 기억) ──

        async openMemoryModal(agentId, agentName) {
          this.memoryModal.agentId = agentId;
          this.memoryModal.agentName = agentName;
          this.memoryModal.newKey = '';
          this.memoryModal.newValue = '';
          this.memoryModal.visible = true;
          await this.loadMemory(agentId);
        },

        async loadMemory(agentId) {
          try {
            const data = await fetch(`/api/memory/${agentId}`).then(r => r.json());
            this.memoryModal.items = Array.isArray(data) ? data : [];
          } catch (e) { this.memoryModal.items = []; }
        },

        async addMemory() {
          const key = this.memoryModal.newKey.trim();
          const value = this.memoryModal.newValue.trim();
          if (!key || !value) return;
          try {
            await fetch(`/api/memory/${this.memoryModal.agentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ key, value }),
            });
            this.memoryModal.newKey = '';
            this.memoryModal.newValue = '';
            await this.loadMemory(this.memoryModal.agentId);
          } catch (e) { console.error('Add memory failed:', e); }
        },

        async deleteMemory(memoryId) {
          try {
            await fetch(`/api/memory/${this.memoryModal.agentId}/${memoryId}`, { method: 'DELETE' });
            await this.loadMemory(this.memoryModal.agentId);
          } catch (e) { console.error('Delete memory failed:', e); }
        },

        // ── Schedules ──

        async loadSchedules() {
          try {
            const data = await fetch('/api/schedules').then(r => r.json());
            this.schedules.items = (Array.isArray(data) ? data : data.schedules || []).map(s => ({
              ...s, id: s.schedule_id, cron_label: s.cron_preset,
            }));
          } catch (e) { this.schedules.items = []; }
        },

        async addSchedule() {
          const name = this.schedules.editName.trim();
          const command = this.schedules.editCommand.trim();
          const cron_preset = this.schedules.editCronPreset;
          if (!name || !command) return;
          try {
            await fetch('/api/schedules', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, command, cron_preset }),
            });
            this.schedules.editName = '';
            this.schedules.editCommand = '';
            this.schedules.showModal = false;
            await this.loadSchedules();
          } catch (e) { console.error('Add schedule failed:', e); }
        },

        async toggleSchedule(id) {
          try {
            await fetch(`/api/schedules/${id}/toggle`, { method: 'POST' });
            await this.loadSchedules();
          } catch (e) { console.error('Toggle schedule failed:', e); }
        },

        async deleteSchedule(id) {
          try {
            await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
            await this.loadSchedules();
          } catch (e) { console.error('Delete schedule failed:', e); }
        },

        // ── Workflows ──

        async loadWorkflows() {
          try {
            const data = await fetch('/api/workflows').then(r => r.json());
            this.workflows.items = data.workflows || data || [];
          } catch (e) { this.workflows.items = []; }
        },

        editWorkflow(wf) {
          this.workflows.editing = wf.id;
          this.workflows.editName = wf.name;
          this.workflows.editDesc = wf.description || '';
          this.workflows.editSteps = wf.steps.map(s => ({ ...s }));
          this.workflows.showEditor = true;
        },

        async saveWorkflow() {
          const name = this.workflows.editName.trim();
          if (!name || this.workflows.editSteps.length === 0) return;
          const body = {
            name,
            description: this.workflows.editDesc,
            steps: this.workflows.editSteps.filter(s => s.command.trim()),
          };
          try {
            if (this.workflows.editing) {
              await fetch(`/api/workflows/${this.workflows.editing}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
              });
            } else {
              await fetch('/api/workflows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
              });
            }
            this.workflows.showEditor = false;
            await this.loadWorkflows();
          } catch (e) { console.error('Save workflow failed:', e); }
        },

        async deleteWorkflow(id) {
          try {
            await fetch(`/api/workflows/${id}`, { method: 'DELETE' });
            await this.loadWorkflows();
          } catch (e) { console.error('Delete workflow failed:', e); }
        },

        async runWorkflow(id) {
          this.workflows.runningId = id;
          try {
            await fetch(`/api/workflows/${id}/run`, { method: 'POST' });
          } catch (e) { console.error('Run workflow failed:', e); }
          finally { setTimeout(() => { this.workflows.runningId = null; }, 2000); }
        },

        scrollToBottom() {
          const el = this.$refs.chatArea;
          if (el) el.scrollTop = el.scrollHeight;
        },
      };
    }
  </script>
</body>
</html>
