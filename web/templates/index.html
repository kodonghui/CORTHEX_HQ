<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>CORTHEX HQ - Cyber Command Center</title>
  <!-- 폰트: preload 비동기 로드 (CSS @import 순차 블로킹 제거) -->
  <link rel="preload" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"></noscript>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <!-- Tailwind JIT (blocking 필수 — 제거 불가) -->
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <!-- Marked, Chart.js, Mermaid: 동적 로드 (_loadScript) — blocking 제거 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'hq-bg': 'rgb(var(--hq-bg) / <alpha-value>)',
            'hq-surface': 'rgb(var(--hq-surface) / <alpha-value>)',
            'hq-panel': 'rgb(var(--hq-panel) / <alpha-value>)',
            'hq-border': 'rgb(var(--hq-border) / <alpha-value>)',
            'hq-border-light': 'rgb(var(--hq-border-light) / <alpha-value>)',
            'hq-accent': 'rgb(var(--hq-accent) / <alpha-value>)',
            'hq-cyan': 'rgb(var(--hq-cyan) / <alpha-value>)',
            'hq-purple': 'rgb(var(--hq-purple) / <alpha-value>)',
            'hq-green': 'rgb(var(--hq-green) / <alpha-value>)',
            'hq-yellow': 'rgb(var(--hq-yellow) / <alpha-value>)',
            'hq-red': 'rgb(var(--hq-red) / <alpha-value>)',
            'hq-text': 'rgb(var(--hq-text) / <alpha-value>)',
            'hq-muted': 'rgb(var(--hq-muted) / <alpha-value>)',
          }
        }
      }
    }
  </script>
  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CORTHEX HQ">
  <link rel="apple-touch-icon" href="/static/images/corthex-logo-256.png">
  <link rel="stylesheet" href="/static/css/corthex-styles.css?v=727">
  <script defer src="/static/js/corthex-app.js?v=727"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="text-hq-text h-screen flex flex-col overflow-hidden"
      x-data="corthexApp()" x-init="init()">

  <!-- ═══ Top Bar ═══ -->
  <header class="h-14 hq-header flex items-center justify-between px-5 shrink-0 z-20" style="background: rgb(var(--hq-surface)); border-bottom: 1px solid rgb(var(--hq-border))">
    <div class="flex items-center gap-4">
      <!-- Sidebar Toggle -->
      <button @click="sidebarOpen = !sidebarOpen"
              class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-hq-panel/50 transition-colors text-hq-muted hover:text-hq-text"
              :title="sidebarOpen ? '사이드바 접기' : '사이드바 펼치기'">
        <svg x-show="sidebarOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/>
        </svg>
        <svg x-show="!sidebarOpen" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5"/>
        </svg>
      </button>
      <!-- Logo (클릭 → 홈) -->
      <div class="flex items-center gap-2.5 cursor-pointer hover:opacity-80 transition-opacity"
           @click="viewMode = 'chat'; activeTab = 'command'; $nextTick(() => scrollToBottom()); setTimeout(() => scrollToBottom(), 300)">
        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGrad" x1="0" y1="0" x2="32" y2="32">
              <stop offset="0%" stop-color="#34d399"/>
              <stop offset="50%" stop-color="#22d3ee"/>
              <stop offset="100%" stop-color="#34d399"/>
            </linearGradient>
          </defs>
          <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#logoGrad)" stroke-width="1.5" fill="none"/>
          <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#logoGrad)" stroke-width="1" fill="none" opacity="0.5"/>
          <circle cx="16" cy="16" r="4" fill="url(#logoGrad)" opacity="0.8"/>
          <circle cx="16" cy="16" r="2" fill="#0a0a0a"/>
          <line x1="16" y1="12" x2="16" y2="6" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="16" y1="20" x2="16" y2="26" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
          <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#logoGrad)" stroke-width="1" opacity="0.6"/>
        </svg>
        <div>
          <div class="text-base font-bold tracking-wider gradient-text font-mono flex items-center gap-1"><span>CORTHEX</span><span>HQ</span></div>
        </div>
      </div>
      <div class="flex items-center gap-2 header-build-badge">
        <span class="text-[10px] text-hq-muted bg-hq-surface border border-hq-border rounded-md px-2 py-0.5">빌드 #727</span>
        <span class="text-[10px] text-hq-cyan/85 bg-hq-cyan/5 border border-hq-cyan/20 rounded-md px-2 py-0.5">CEO 관제</span>
      </div>
    </div>

    <!-- 로그아웃 버튼 (로그인 상태이고 부트스트랩 모드가 아닐 때만) -->
    <template x-if="auth.token && !auth.bootstrapMode">
      <button @click="doLogout()"
              class="text-[10px] text-hq-muted hover:text-hq-red border border-hq-border hover:border-hq-red/30 rounded-md px-2 py-0.5 transition mr-2"
              title="로그아웃">로그아웃</button>
    </template>

    <div class="flex items-center gap-5">
      <!-- System Status (click → health popover) -->
      <div class="flex items-center gap-2 relative">
        <template x-if="systemStatus === 'idle'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-green/10 border border-hq-green/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-green/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-green"></span>
            <span class="text-xs font-medium text-hq-green">대기</span>
          </div>
        </template>
        <template x-if="systemStatus === 'working'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-yellow/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
            <span class="text-xs font-medium text-hq-yellow">처리중</span>
            <span x-show="commandQueue.length > 0" class="text-[10px] font-mono text-hq-yellow/70 ml-1" x-text="'+' + commandQueue.length + '대기'"></span>
          </div>
        </template>
        <template x-if="systemStatus === 'error'">
          <div @click="showHealthPopover = !showHealthPopover; if(showHealthPopover) loadHealth()"
               class="flex items-center gap-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-3 py-1 cursor-pointer hover:bg-hq-red/20 transition">
            <span class="w-2 h-2 rounded-full bg-hq-red"></span>
            <span class="text-xs font-medium text-hq-red">오류</span>
          </div>
        </template>
        <!-- Health Popover -->
        <div x-show="showHealthPopover" @click.outside="showHealthPopover = false" x-transition
             class="absolute top-full mt-2 right-0 w-72 glass border border-hq-border rounded-xl p-4 shadow-xl z-30"
             style="display: none;">
          <h4 class="text-xs font-bold text-hq-text uppercase tracking-wider mb-3">시스템 상태 상세</h4>
          <template x-if="healthData">
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs text-hq-muted">전체</span>
                <span class="text-xs font-bold" :class="(healthData.status === 'ok' || healthData.overall === 'ok') ? 'text-hq-green' : (healthData.status === 'warning' || healthData.overall === 'warning') ? 'text-hq-yellow' : 'text-hq-red'"
                      x-text="(healthData.status === 'ok' || healthData.overall === 'ok') ? '정상' : (healthData.status === 'warning' || healthData.overall === 'warning') ? '경고' : '오류'"></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-hq-muted">서버</span>
                <span class="text-xs" x-text="healthData.mode || 'ARM 서버'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.agents !== undefined">
                <span class="text-xs text-hq-muted">등록 에이전트</span>
                <span class="text-xs text-hq-accent" x-text="healthData.agents + '명'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.telegram !== undefined">
                <span class="text-xs text-hq-muted">텔레그램</span>
                <span class="text-xs" x-text="healthData.telegram ? '연결됨' : '미연결'"></span>
              </div>
              <!-- 분석 상태 + 중지 버튼 -->
              <div class="flex items-center justify-between">
                <span class="text-xs text-hq-muted">분석 상태</span>
                <template x-if="trading.runningNow || trading.analyzingSelected">
                  <button @click="stopAnalysis()" class="text-[10px] px-2 py-0.5 bg-red-600 hover:bg-red-700 text-white rounded-full font-bold transition-colors">
                    🛑 중지
                  </button>
                </template>
                <template x-if="!trading.runningNow && !trading.analyzingSelected">
                  <span class="text-[10px] text-hq-muted">대기 중</span>
                </template>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.model_router !== undefined">
                <span class="text-xs text-hq-muted">모델 라우터 (경로 배정)</span>
                <span class="text-xs" x-text="healthData.model_router ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.registry !== undefined">
                <span class="text-xs text-hq-muted">에이전트 레지스트리 (등록소)</span>
                <span class="text-xs" x-text="healthData.registry ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.knowledge_mgr !== undefined">
                <span class="text-xs text-hq-muted">지식 관리자</span>
                <span class="text-xs" x-text="healthData.knowledge_mgr ? '✅' : '❌'"></span>
              </div>
              <div class="flex items-center justify-between" x-show="healthData.agent_count !== undefined">
                <span class="text-xs text-hq-muted">등록된 에이전트</span>
                <span class="text-xs text-hq-accent" x-text="healthData.agent_count + '명'"></span>
              </div>
              <template x-if="healthData.checks && healthData.checks.length > 0">
                <div class="border-t border-hq-border/50 pt-2 mt-2 space-y-1">
                  <template x-for="check in healthData.checks" :key="check.name || check">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] text-hq-muted" x-text="check.name || check"></span>
                      <span class="text-[11px]" :class="check.ok ? 'text-hq-green' : 'text-hq-red'" x-text="check.ok ? '✅' : '❌'"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
          <template x-if="!healthData">
            <div class="text-xs text-hq-muted text-center py-2">로딩 중...</div>
          </template>
        </div>
      </div>

      <!-- Metrics -->
      <div class="flex items-center gap-4 header-metrics">
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-green/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span class="text-xs font-mono text-hq-green" x-text="'$' + totalCost.toFixed(4)"></span>
        </div>
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-hq-purple/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
          <span class="text-xs font-mono text-hq-text/90" x-text="totalTokens.toLocaleString()"></span>
        </div>
      </div>

      <!-- Connection -->
      <div class="flex items-center gap-1.5" :class="wsConnected ? 'text-hq-green' : 'text-hq-red'">
        <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
        <span class="text-[11px] header-conn-text" x-text="wsConnected ? '연결됨' : '끊김'"></span>
      </div>

      <!-- View Toggle: 지휘소/사무실/대시보드 -->
      <div class="flex items-center bg-hq-surface border border-hq-border rounded-lg header-view-toggle">
        <button @click="if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);dashboardRefreshTimer=null;} viewMode = 'chat'"
                :class="viewMode === 'chat' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold rounded-l-lg transition-colors">지휘소</button>
        <button @click="if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);dashboardRefreshTimer=null;} viewMode = 'office'"
                :class="viewMode === 'office' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold border-x border-hq-border transition-colors">사무실</button>
        <button @click="viewMode = 'dashboard'; loadDashboard(); if(dashboardRefreshTimer){clearInterval(dashboardRefreshTimer);} dashboardRefreshTimer = setInterval(() => loadDashboard(), 30000)"
                :class="viewMode === 'dashboard' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                class="px-3 py-1 text-xs font-semibold border-r border-hq-border transition-colors">대시보드</button>
        <button @click="viewMode = 'agora'; $nextTick(() => { if(typeof openAgora === 'function') openAgora(); if(typeof _loadAgoraStatus === 'function') _loadAgoraStatus(); })"
                :class="viewMode === 'agora' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-accent'"
                class="px-3 py-1 text-xs font-semibold border-r border-hq-border transition-colors tracking-wider">AGORA</button>
        <button @click="openNexus()"
                :class="nexusOpen ? 'bg-[#e879f9]/20 text-[#e879f9]' : 'text-hq-muted hover:text-[#e879f9]'"
                class="px-3 py-1 text-xs font-semibold rounded-r-lg transition-colors tracking-wider">NEXUS</button>
      </div>

      <!-- Dark/Light Toggle -->
      <button @click="toggleTheme()" class="text-hq-muted hover:text-hq-text transition" title="다크/라이트 모드 전환">
        <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
      </button>

      <!-- Quality Settings Button -->
      <button @click="showQualitySettings = true; loadQualityRules()"
              class="text-hq-muted hover:text-hq-text transition" title="품질 검수 설정">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
    </div>
  </header>
  <div class="h-px shrink-0" style="background: linear-gradient(to right, transparent, #8b5cf6 30%, #818cf8 70%, transparent)"></div>

  <!-- ARGOS 상단 상태바 삭제됨 (2026-02-26) -->

  <!-- ═══ Toast Notifications ═══ -->
  <div class="fixed top-16 right-4 z-50 space-y-2 max-w-sm" style="pointer-events:none;">
    <template x-for="toast in toasts" :key="toast.id">
      <div :class="[
        toast.visible ? 'toast-in' : 'toast-out',
        toast.type === 'success' ? 'border-hq-green/40 bg-hq-green/10' :
        toast.type === 'error' ? 'border-hq-red/40 bg-hq-red/10' :
        toast.type === 'warning' ? 'border-hq-yellow/40 bg-hq-yellow/10' :
        'border-hq-accent/40 bg-hq-accent/10'
      ]" class="glass border rounded-xl px-4 py-3 text-sm shadow-lg" style="pointer-events:auto;">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full shrink-0"
                :class="toast.type==='success'?'bg-hq-green':toast.type==='error'?'bg-hq-red':toast.type==='warning'?'bg-hq-yellow':'bg-hq-accent'"></span>
          <span class="flex-1 text-hq-text text-sm" x-text="toast.message"></span>
          <button @click="removeToast(toast.id)" class="text-hq-muted hover:text-hq-text text-lg leading-none ml-2">&times;</button>
        </div>
      </div>
    </template>
  </div>

  <!-- ═══ Connection Lost Banner ═══ -->
  <div x-show="connectionLost" x-transition
       class="bg-hq-red/15 border-b border-hq-red/30 text-center py-2 text-sm text-hq-red shrink-0 flex items-center justify-center gap-2">
    <span class="w-2 h-2 bg-hq-red rounded-full pulse-dot"></span>
    서버 연결이 끊어졌습니다. 재연결 시도중... (<span x-text="reconnectAttempt"></span>회)
  </div>

  <!-- ═══ Main Layout ═══ -->
  <div class="flex flex-1 overflow-hidden">

    <!-- ═══ Left Panel: Organization ═══ -->
    <!-- 모바일 오버레이 배경 -->
    <div x-show="sidebarOpen && window.innerWidth <= 768" x-cloak
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-black/50 z-30 md:hidden"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    <aside x-show="sidebarOpen"
           x-transition:enter="transition-all ease-out duration-250"
           x-transition:enter-start="opacity-0 -translate-x-4 w-0"
           x-transition:enter-end="opacity-100 translate-x-0 w-[260px]"
           x-transition:leave="transition-all ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-x-0 w-[260px]"
           x-transition:leave-end="opacity-0 -translate-x-4 w-0"
           class="w-[260px] flex flex-col shrink-0 overflow-hidden max-md:fixed max-md:top-14 max-md:left-0 max-md:bottom-0 max-md:z-40 max-md:shadow-2xl"
           style="background: rgb(var(--hq-surface)); border-right: 1px solid rgb(var(--hq-border))">

      <!-- Team (flat) -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-1.5">
        <div class="flex items-center justify-between px-2 mb-3">
          <div class="text-[10px] font-bold text-hq-muted uppercase tracking-[0.15em] font-mono">TEAM</div>
          <div class="text-[10px] text-hq-muted">6명</div>
        </div>
        <!-- 에이전트 상태 요약 -->
        <div class="flex items-center gap-3 px-2 py-2 mb-3 rounded-lg bg-hq-panel border border-hq-border/30 text-[10px]">
          <span class="flex items-center gap-1 text-hq-green"><span class="w-1.5 h-1.5 rounded-full bg-hq-green animate-pulse"></span> <span x-text="Object.values(activeAgents).filter(a => a.status === 'working').length"></span> 활동</span>
          <span class="flex items-center gap-1 text-hq-yellow"><span class="w-1.5 h-1.5 rounded-full bg-hq-yellow"></span> <span x-text="Object.values(activeAgents).filter(a => a.status === 'idle').length"></span> 대기</span>
        </div>

        <!-- CEO -->
        <div class="mb-3">
          <div @click="showCeoProfile = true" class="flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-gradient-to-r from-hq-accent/10 to-hq-purple/10 border border-hq-accent/20 cursor-pointer hover:border-hq-accent/40 hover:from-hq-accent/15 hover:to-hq-purple/15 transition-all">
            <div class="agent-avatar bg-gradient-to-br from-hq-accent to-hq-purple text-white">
              CEO
            </div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-hq-text font-mono">CEO</div>
              <div class="text-[10px] text-hq-muted font-mono">COMMANDER</div>
            </div>
            <span class="text-[10px] text-hq-muted/85">&#9654;</span>
          </div>
        </div>

        <!-- 팀장 6명 (flat list) -->
        <div class="space-y-1">
          <template x-for="id in ['chief_of_staff','cio_manager','cso_manager','clo_manager','cmo_manager','cpo_manager']" :key="id">
            <div :id="'agent-' + id" @click="openAgentConfig(id)"
                 class="flex items-center gap-2.5 px-3 py-2.5 rounded-xl border border-transparent cursor-pointer transition-all duration-200 hover:bg-hq-panel/25 hover:border-hq-border"
                 title="클릭하면 모델·추론·소울 설정 가능">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center text-[10px] font-bold shrink-0"
                   :class="{'bg-amber-500/20 text-amber-400': id==='chief_of_staff', 'bg-red-500/20 text-red-400': id==='cio_manager', 'bg-purple-500/20 text-purple-400': id==='cso_manager', 'bg-emerald-500/20 text-emerald-400': id==='clo_manager', 'bg-orange-500/20 text-orange-400': id==='cmo_manager', 'bg-fuchsia-500/20 text-fuchsia-400': id==='cpo_manager'}"
                   x-text="getAgentInitials(id)"></div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text" x-text="getAgentName(id)"></div>
                <div class="text-[10px] text-hq-muted font-mono truncate" x-text="getModelDisplayName(agentModels[id])"></div>
              </div>
              <span class="w-2 h-2 rounded-full shrink-0 transition-colors"
                    :class="[getAgentDotClass(id), activeAgents[id]?.status==='working' ? 'agent-working-glow' : '']"></span>
              <span x-show="activeAgents[id]?.status === 'working'"
                    class="text-[9px] font-mono text-hq-yellow shrink-0"
                    x-text="activeAgents[id]?.elapsed || '00:00'"></span>
            </div>
          </template>
        </div>


        <!-- Tool Pool -->
        <div class="mb-1.5">
          <button @click="toggleSection('tools')"
                  class="w-full text-left px-3 py-2.5 rounded-xl border transition-all duration-200"
                  :class="expanded.tools ? 'bg-orange-400/10 border-orange-400/30' : 'bg-hq-panel/15 border-transparent hover:bg-hq-panel/25 hover:border-hq-border'">
            <div class="flex items-center gap-2.5">
              <div class="w-8 h-8 rounded-lg bg-orange-400/15 flex items-center justify-center text-orange-400 shrink-0">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-semibold text-hq-text">도구함</div>
                <div class="text-[10px] text-hq-muted" x-text="(toolsList || []).length + '개 도구'"></div>
              </div>
              <span class="text-[10px] text-hq-muted/85 transition-transform duration-200" :class="expanded.tools ? 'rotate-90' : ''">&#9654;</span>
            </div>
          </button>
          <div x-show="expanded.tools" x-collapse class="ml-3 mt-1 pl-8 border-l border-hq-red/20 space-y-0.5 max-h-60 overflow-y-auto scrollbar-thin">
            <template x-if="!toolsList || toolsList.length === 0">
              <div class="text-[10px] text-hq-muted/80 px-2 py-2">서버 연결 후 표시됩니다</div>
            </template>
            <!-- API 연동 -->
            <div class="text-[9px] font-bold text-hq-green/60 uppercase mt-1 mb-0.5 px-2" x-show="(toolsList||[]).filter(t=>t.category==='api').length">
              API 연동 <span class="font-mono" x-text="(toolsList||[]).filter(t=>t.category==='api').length"></span>
            </div>
            <template x-for="t in (toolsList||[]).filter(t=>t.category==='api')" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-green/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-green/40"></span>
                <span class="text-xs text-hq-text/90" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
            <!-- LLM 분석 -->
            <div class="text-[9px] font-bold text-hq-cyan/60 uppercase mt-2 mb-0.5 px-2" x-show="(toolsList||[]).filter(t=>t.category==='llm').length">
              LLM 분석 <span class="font-mono" x-text="(toolsList||[]).filter(t=>t.category==='llm').length"></span>
            </div>
            <template x-for="t in (toolsList||[]).filter(t=>t.category==='llm')" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-cyan/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-cyan/40"></span>
                <span class="text-xs text-hq-text/90" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
            <!-- 로컬 처리 -->
            <div class="text-[9px] font-bold text-hq-accent/60 uppercase mt-2 mb-0.5 px-2" x-show="(toolsList||[]).filter(t=>t.category==='local').length">
              로컬 처리 <span class="font-mono" x-text="(toolsList||[]).filter(t=>t.category==='local').length"></span>
            </div>
            <template x-for="t in (toolsList||[]).filter(t=>t.category==='local')" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-accent/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-accent/40"></span>
                <span class="text-xs text-hq-text/90" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
            <!-- 개발중 (stub) -->
            <div class="text-[9px] font-bold text-hq-muted/40 uppercase mt-2 mb-0.5 px-2" x-show="(toolsList||[]).filter(t=>t.category==='stub').length">
              개발중 <span class="font-mono" x-text="(toolsList||[]).filter(t=>t.category==='stub').length"></span>
            </div>
            <template x-for="t in (toolsList||[]).filter(t=>t.category==='stub')" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-muted/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-muted/30"></span>
                <span class="text-xs text-hq-muted/60" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
            <!-- 미분류 (category 없는 도구) -->
            <template x-for="t in (toolsList||[]).filter(t=>!t.category)" :key="t.name">
              <div @click="showToolDetail(t)" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-hq-red/10 transition-colors cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-hq-red/40"></span>
                <span class="text-xs text-hq-text/90" x-text="t.name_ko || t.name"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

    </aside>

    <!-- ═══ Right Panel: Tabs + Content ═══ -->
    <main class="flex-1 flex flex-col overflow-hidden bg-hq-bg responsive-main">

      <!-- ═══ Error Alert Banner ═══ -->
      <div x-show="errorAlert.visible" x-transition
           class="bg-hq-red/15 border-b border-hq-red/30 px-5 py-2 flex items-center justify-between shrink-0" style="display:none;">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
          <span class="text-sm text-hq-red font-medium" x-text="errorAlert.message"></span>
        </div>
        <button @click="errorAlert.visible = false" class="text-hq-red/50 hover:text-hq-red text-lg">&times;</button>
      </div>

      <!-- ═══ Tab Navigation (채팅 모드일 때만 표시 — 모바일에서는 하단 네비 사용) ═══ -->
      <div x-show="viewMode === 'chat'" class="flex items-center gap-0.5 px-3 pt-2 pb-0 border-b border-hq-border bg-hq-surface shrink-0 mobile-tabs-scroll desktop-tab-bar">
        <!-- 기본 탭 5개 (#12) -->
        <template x-for="tab in getPrimaryTabs()" :key="tab.id">
          <button @click="switchTab(tab.id); showMoreTabs = false"
                  :class="activeTab === tab.id
                    ? 'text-hq-accent border-hq-accent bg-hq-accent/10 font-bold'
                    : 'text-hq-muted border-transparent hover:text-hq-text hover:bg-hq-panel/20'"
                  class="flex items-center gap-1.5 px-3 py-2 text-[11px] font-semibold border-b-2 transition-all rounded-t-lg whitespace-nowrap">
            <span x-html="tab.icon" class="w-3.5 h-3.5"></span>
            <span x-text="tab.label"></span>
          </button>
        </template>
        <!-- 더보기 드롭다운 -->
        <div class="relative">
          <button @click="showMoreTabs = !showMoreTabs"
                  :class="getSecondaryTabs().some(t => t.id === activeTab)
                    ? 'text-hq-accent border-hq-accent bg-hq-accent/10 font-bold'
                    : 'text-hq-muted border-transparent hover:text-hq-text hover:bg-hq-panel/20'"
                  class="flex items-center gap-1 px-3 py-2 text-[11px] font-semibold border-b-2 transition-all rounded-t-lg whitespace-nowrap">
            <span x-text="getSecondaryTabs().find(t => t.id === activeTab)?.label || '더보기'"></span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div x-show="showMoreTabs" @click.outside="showMoreTabs = false" x-transition
               class="absolute top-full left-0 mt-1 glass border border-hq-border rounded-xl py-1 shadow-xl z-30 min-w-[140px]" style="display:none;">
            <template x-for="tab in getSecondaryTabs()" :key="tab.id">
              <button @click="switchTab(tab.id); showMoreTabs = false"
                      :class="activeTab === tab.id ? 'bg-hq-accent/10 text-hq-accent' : 'text-hq-muted hover:text-hq-text hover:bg-hq-panel/20'"
                      class="flex items-center gap-2 w-full px-3 py-2 text-xs transition">
                <span x-html="tab.icon" class="w-3.5 h-3.5"></span>
                <span x-text="tab.label"></span>
              </button>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 홈 (Home Dashboard) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'home'" x-cloak class="flex-1 overflow-y-auto scrollbar-thin px-6 pt-8 pb-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto fade-in-up">
          <div class="mb-6">
            <h1 class="text-xl md:text-2xl font-bold gradient-text mb-1 welcome-title">AI 지휘소</h1>
            <p class="text-sm text-hq-muted">빠른 요약 — 상세 실시간 분석은 <button @click="viewMode='dashboard'; loadDashboard()" class="text-hq-accent hover:underline">대시보드</button>에서</p>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-accent/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-text" x-text="dashboard.todayTasks || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">오늘 작업</div>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[11px]">
                <span class="text-hq-green" x-text="'완료 ' + (dashboard.todayCompleted || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-yellow" x-text="'진행 ' + (dashboard.runningCount || 0)"></span>
              </div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-green/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-green" x-text="'$' + (dashboard.todayCost || 0).toFixed(4)"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">오늘 비용</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted">누적: $<span x-text="(dashboard.totalCost || 0).toFixed(2)"></span></div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-purple/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <div>
                  <div class="text-xl font-bold text-hq-text" x-text="dashboard.agentCount || 0"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">에이전트</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted">6팀장 체제</div>
            </div>
            <!-- 노션 연동 상태 카드 -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg flex items-center justify-center" :class="dashboard.notionConnected ? 'bg-hq-green/15' : 'bg-hq-red/15'">
                  <svg class="w-4.5 h-4.5" :class="dashboard.notionConnected ? 'text-hq-green' : 'text-hq-red'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </div>
                <div>
                  <div class="text-sm font-bold" :class="dashboard.notionConnected ? 'text-hq-green' : 'text-hq-red'" x-text="dashboard.notionConnected ? '연결됨' : '미연결'"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">노션 연동</div>
                </div>
              </div>
              <div class="text-[11px] text-hq-muted" x-text="dashboard.notionConnected ? '보고서 자동 저장 중' : 'API 키 설정 필요'"></div>
            </div>
          </div>

          <!-- 퀵 액션 + AI 사용량 + 시스템 현황 -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
            <!-- 퀵 액션 카드 -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-lg bg-hq-cyan/15 flex items-center justify-center">
                    <svg class="w-4.5 h-4.5 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  </div>
                  <div>
                    <div class="text-sm font-bold text-hq-text">퀵 액션</div>
                    <div class="text-[10px] text-hq-muted uppercase tracking-wider">바로 실행</div>
                  </div>
                </div>
                <div class="flex gap-1 bg-hq-bg rounded-lg p-0.5">
                  <button @click="quickActionTab='routine'" class="px-2 py-0.5 text-[10px] font-semibold rounded transition"
                    :class="quickActionTab==='routine' ? 'bg-hq-cyan/20 text-hq-cyan' : 'text-hq-muted hover:text-hq-text'">루틴</button>
                  <button @click="quickActionTab='system'" class="px-2 py-0.5 text-[10px] font-semibold rounded transition"
                    :class="quickActionTab==='system' ? 'bg-hq-green/20 text-hq-green' : 'text-hq-muted hover:text-hq-text'">시스템</button>
                </div>
              </div>
              <div x-show="quickActionTab==='routine'" class="flex flex-wrap gap-2">
                <button @click="activeTab='command'; $nextTick(() => { inputText='전 부서 현황 보고'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-cyan/10 text-hq-cyan border border-hq-cyan/20 hover:bg-hq-cyan/20 transition">
                  🏢 전 부서 현황
                </button>
                <button @click="activeTab='command'; $nextTick(() => { inputText='오늘 일정 및 예약 현황 보고'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-accent/10 text-hq-accent border border-hq-accent/20 hover:bg-hq-accent/20 transition">
                  📅 오늘 일정
                </button>
                <button @click="activeTab='command'; $nextTick(() => { inputText='예산 사용 현황 보고'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-yellow/10 text-hq-yellow border border-hq-yellow/20 hover:bg-hq-yellow/20 transition">
                  💰 예산 현황
                </button>
              </div>
              <div x-show="quickActionTab==='system'" class="flex flex-wrap gap-2">
                <button @click="activeTab='command'; $nextTick(() => { inputText='/도구점검'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-green/10 text-hq-green border border-hq-green/20 hover:bg-hq-green/20 transition">
                  🔧 도구 점검
                </button>
                <button @click="activeTab='command'; $nextTick(() => { inputText='/배치실행 전체 보고'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-purple/10 text-hq-purple border border-hq-purple/20 hover:bg-hq-purple/20 transition">
                  📤 대기 전송
                </button>
                <button @click="activeTab='command'; $nextTick(() => { inputText='/배치상태'; })"
                  class="px-3 py-1.5 text-[11px] font-semibold rounded-lg bg-hq-muted/10 text-hq-muted border border-hq-border hover:bg-hq-muted/20 transition">
                  📋 배치 상태
                </button>
              </div>
              <template x-if="recentCommands.length > 0">
                <div class="mt-2 pt-2 border-t border-hq-border/30">
                  <div class="text-[9px] text-hq-muted uppercase tracking-wider mb-1.5">최근 사용</div>
                  <div class="flex flex-wrap gap-1.5">
                    <template x-for="(cmd, i) in recentCommands.slice(0, 3)" :key="i">
                      <button @click="activeTab='command'; $nextTick(() => { inputText=cmd; })"
                        class="px-2 py-1 text-[10px] rounded-md bg-hq-surface text-hq-muted border border-hq-border/50 hover:text-hq-text hover:border-hq-accent/30 transition truncate max-w-[140px]"
                        x-text="cmd"></button>
                    </template>
                  </div>
                </div>
              </template>
            </div>

            <!-- 오늘 AI 사용량 카드 -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-9 h-9 rounded-lg bg-hq-accent/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                </div>
                <div>
                  <div class="text-sm font-bold text-hq-text" x-text="'AI 호출 ' + (dashboard.totalAiCalls || 0) + '회'"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">오늘 사용량</div>
                </div>
              </div>
              <!-- 로딩 중 스피너 -->
              <div x-show="!dashboard.loaded" class="flex items-center justify-center py-3 gap-2 text-[11px] text-hq-muted">
                <svg class="animate-spin w-3.5 h-3.5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                로딩 중...
              </div>
              <!-- 프로바이더별 막대 (데이터 로드 완료 후 표시) -->
              <div x-show="dashboard.loaded" class="space-y-1.5">
                <template x-for="p in [
                  {id:'anthropic', label:'Claude', color:'hq-purple'},
                  {id:'openai', label:'GPT', color:'hq-green'},
                  {id:'google', label:'Gemini', color:'hq-cyan'},
                ]" :key="p.id">
                  <div class="flex items-center gap-2 text-[11px]">
                    <span class="w-12 text-hq-muted truncate" x-text="p.label"></span>
                    <div class="flex-1 h-2 rounded-full bg-hq-border/50 overflow-hidden">
                      <div class="h-full rounded-full transition-all duration-500"
                        :class="'bg-' + p.color"
                        :style="'width:' + (dashboard.totalAiCalls > 0 ? Math.round((dashboard.providerCalls?.[p.id] || 0) / dashboard.totalAiCalls * 100) : 0) + '%'"></div>
                    </div>
                    <span class="w-6 text-right font-mono text-hq-muted" x-text="dashboard.providerCalls?.[p.id] || 0"></span>
                  </div>
                </template>
                <!-- 오늘 호출 없을 때 안내 -->
                <div x-show="dashboard.loaded && dashboard.totalAiCalls === 0" class="text-center text-[10px] text-hq-muted/60 pt-1">오늘 AI 호출 없음</div>
              </div>
              <!-- 예산 바 -->
              <div class="mt-2 pt-2 border-t border-hq-border/30">
                <div class="flex items-center justify-between text-[10px] text-hq-muted mb-1">
                  <span x-text="'$' + (dashboard.todayCost || 0).toFixed(4)"></span>
                  <span x-text="'한도 $' + (dashboard.dailyLimit || 7).toFixed(0)"></span>
                </div>
                <div class="h-1.5 rounded-full bg-hq-border/50 overflow-hidden">
                  <div class="h-full rounded-full transition-all duration-500"
                    :class="(dashboard.todayCost || 0) >= (dashboard.dailyLimit || 7) ? 'bg-hq-red' : 'bg-hq-green'"
                    :style="'width:' + Math.min(100, ((dashboard.todayCost || 0) / (dashboard.dailyLimit || 7) * 100)).toFixed(1) + '%'"></div>
                </div>
              </div>
            </div>

            <!-- 시스템 현황 카드 -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-9 h-9 rounded-lg bg-hq-green/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                </div>
                <div>
                  <div class="text-sm font-bold text-hq-text">시스템 현황</div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">상태 요약</div>
                </div>
              </div>
              <div class="space-y-1.5 text-[11px]">
                <div class="flex items-center justify-between">
                  <span class="text-hq-muted">API 연결</span>
                  <span class="text-hq-green" x-text="(dashboard.apiConnected || 0) + '/' + (dashboard.apiTotal || 5) + ' 정상'"></span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-hq-muted">도구 로드</span>
                  <span class="text-hq-cyan" x-text="(dashboard.toolCount || 0) + '개'"></span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-hq-muted">배치</span>
                  <span>
                    <span class="text-hq-yellow" x-text="'대기 ' + (dashboard.batchActive || 0)"></span>
                    <span class="text-hq-muted mx-0.5">·</span>
                    <span class="text-hq-green" x-text="'완료 ' + (dashboard.batchDone || 0)"></span>
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-hq-muted">노션</span>
                  <span :class="dashboard.notionConnected ? 'text-hq-green' : 'text-hq-red'" x-text="dashboard.notionConnected ? '연결됨' : '미연결'"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- 콘텐츠 파이프라인 — 제거됨 (2026-02-21, CEO 지시) -->

          <!-- Feedback + Budget Row -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
            <!-- CEO 만족도 카드 (#7) -->
            <div class="glass border border-hq-border rounded-xl p-5 hover-glow">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-9 h-9 rounded-lg bg-hq-yellow/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div class="flex-1">
                  <div class="text-xl font-bold text-hq-text" x-text="(feedbackStats.satisfaction_rate || 0) + '%'"></div>
                  <div class="text-[10px] text-hq-muted uppercase tracking-wider">CEO 만족도</div>
                </div>
                <!-- 만족도 시각 표시 바 -->
                <div class="w-20 h-20 relative flex items-center justify-center shrink-0">
                  <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="rgb(var(--hq-border))" stroke-width="3"/>
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="rgb(var(--hq-yellow))" stroke-width="3"
                          :stroke-dasharray="(feedbackStats.satisfaction_rate || 0) + ', 100'"/>
                  </svg>
                  <span class="absolute text-[11px] font-bold text-hq-yellow" x-text="(feedbackStats.satisfaction_rate || 0) + '%'"></span>
                </div>
              </div>
              <div class="flex items-center gap-3 text-[11px]">
                <span class="text-hq-green" x-text="'좋아요 ' + (feedbackStats.good || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-red" x-text="'아쉬워요 ' + (feedbackStats.bad || 0)"></span>
                <span class="text-hq-muted">·</span>
                <span class="text-hq-muted" x-text="'총 ' + (feedbackStats.total || 0) + '건'"></span>
              </div>
            </div>
            <!-- 예산 현황 + 수정 카드 (#8) -->
            <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-9 h-9 rounded-lg bg-hq-cyan/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
                <div class="flex-1">
                  <div class="text-sm font-bold text-hq-text">예산</div>
                  <div class="text-[10px] text-hq-muted">일일 $<span x-text="(budget.daily_limit || 0).toFixed(2)"></span> / 월 $<span x-text="(budget.monthly_limit || 0).toFixed(2)"></span></div>
                </div>
                <button @click="showBudgetEdit = true; budgetEditDaily = budget.daily_limit || 0; budgetEditMonthly = budget.monthly_limit || 0"
                        class="text-xs text-hq-accent hover:text-hq-accent/80 px-2 py-1 border border-hq-accent/20 rounded-lg">수정</button>
              </div>
              <div class="w-full bg-hq-bg rounded-full h-2 mt-1">
                <div class="bg-gradient-to-r from-hq-green to-hq-yellow h-2 rounded-full transition-all"
                     :style="'width:' + Math.min(100, ((budget.today_spent || 0) / Math.max(budget.daily_limit || 1, 0.01)) * 100) + '%'"></div>
              </div>
              <div class="text-[10px] text-hq-muted mt-1">오늘 사용: $<span x-text="(budget.today_spent || 0).toFixed(4)"></span></div>
            </div>
          </div>

          <!-- E-2: 시스템 기능 바로가기 (숨겨진 기능 노출) -->
          <div class="glass border border-hq-border rounded-xl p-5 mb-6">
            <h2 class="text-sm font-bold text-hq-text mb-3 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
              시스템 기능
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
              <button @click="switchTab('performance')" class="bg-hq-bg/50 border border-hq-border/30 rounded-lg px-3 py-2.5 text-left hover:border-hq-accent/30 transition">
                <div class="text-xs font-semibold text-hq-text">Soul Gym</div>
                <div class="text-[10px] text-hq-muted mt-0.5">AI 경쟁 진화 훈련</div>
              </button>
              <button @click="switchTab('performance')" class="bg-hq-bg/50 border border-hq-border/30 rounded-lg px-3 py-2.5 text-left hover:border-hq-accent/30 transition">
                <div class="text-xs font-semibold text-hq-text">장기기억</div>
                <div class="text-[10px] text-hq-muted mt-0.5">팀장별 메모리 관리</div>
              </button>
              <button @click="switchTab('performance')" class="bg-hq-bg/50 border border-hq-border/30 rounded-lg px-3 py-2.5 text-left hover:border-hq-accent/30 transition">
                <div class="text-xs font-semibold text-hq-text">품질 대시보드</div>
                <div class="text-[10px] text-hq-muted mt-0.5">QA 검수 결과 현황</div>
              </button>
              <button @click="viewMode = 'agora'" class="bg-hq-bg/50 border border-hq-border/30 rounded-lg px-3 py-2.5 text-left hover:border-hq-accent/30 transition">
                <div class="text-xs font-semibold text-hq-text">AGORA 토론</div>
                <div class="text-[10px] text-hq-muted mt-0.5">논문/주제 AI 토론</div>
              </button>
            </div>
          </div>

          <!-- Recent Completed Tasks -->
          <div class="glass border border-hq-border rounded-xl p-5 mb-6">
            <h2 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              최근 완료 작업
            </h2>
            <template x-if="dashboard.recentCompleted && dashboard.recentCompleted.length > 0">
              <div class="space-y-2">
                <template x-for="task in dashboard.recentCompleted" :key="task.task_id">
                  <div class="flex items-center justify-between p-3 bg-hq-panel rounded-lg hover:bg-hq-bg transition cursor-pointer"
                       @click="switchTab('history')">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm text-hq-text truncate" x-text="task.command"></div>
                      <div class="text-[11px] text-hq-muted mt-0.5" x-text="new Date(task.created_at).toLocaleString('ko-KR', {timeZone:'Asia/Seoul'})"></div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0 ml-4">
                      <span class="text-[11px] text-hq-green" x-text="task.time_seconds + '초'"></span>
                      <span class="text-[11px] font-mono text-hq-muted" x-text="'$' + (task.cost || 0).toFixed(4)"></span>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!dashboard.recentCompleted || dashboard.recentCompleted.length === 0">
              <div class="text-center py-8 text-hq-muted/80 text-sm">아직 완료된 작업이 없습니다</div>
            </template>
          </div>

          <!-- Quick Commands (프리셋 카드 그리드) -->
          <div class="glass border border-hq-border rounded-xl p-5">
            <h2 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              빠른 명령
            </h2>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
              <!-- 서버 프리셋 -->
              <template x-for="p in presets.items" :key="p.name">
                <button @click="switchTab('command'); $nextTick(() => sendPreset(p.command))"
                        class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                  <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent" x-text="p.name"></div>
                  <div class="text-[11px] text-hq-muted mt-1 truncate" x-text="p.command"></div>
                </button>
              </template>
              <!-- 기본 프리셋 (서버 프리셋이 없을 때만 표시) -->
              <template x-if="!presets.items || presets.items.length === 0">
                <div class="contents">
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '전 부서 현황 보고'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">📊 전 부서 현황</div>
                    <div class="text-[11px] text-hq-muted mt-1">전 부서 현황 보고</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@사업기획팀장 시장분석 시작'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">📊 시장분석</div>
                    <div class="text-[11px] text-hq-muted mt-1">@사업기획팀장 시장분석 시작</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@사업기획팀장 보안 스캔 시작'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">🛡️ 보안 스캔</div>
                    <div class="text-[11px] text-hq-muted mt-1">@사업기획팀장 보안 스캔 시작</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@마케팅팀장 마케팅 전략 분석'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">📈 마케팅 분석</div>
                    <div class="text-[11px] text-hq-muted mt-1">@마케팅팀장 마케팅 전략 분석</div>
                  </button>
                  <button @click="switchTab('command'); $nextTick(() => { inputText = '@금융분석팀장 예산 현황 정리'; sendMessage(); })"
                          class="text-left p-4 glass border border-hq-border rounded-xl hover-glow transition group">
                    <div class="text-sm font-medium text-hq-text group-hover:text-hq-accent">💰 예산 현황</div>
                    <div class="text-[11px] text-hq-muted mt-1">@금융분석팀장 예산 현황 정리</div>
                  </button>
                </div>
              </template>
              <button @click="switchTab('command')"
                      class="text-left p-4 bg-hq-panel/30 rounded-xl border border-dashed border-hq-border hover:border-hq-accent/30 transition group flex items-center justify-center min-h-[60px]">
                <span class="text-sm text-hq-muted group-hover:text-hq-accent">+ 직접 명령</span>
              </button>
            </div>
          </div>

          <!-- 대시보드 상세 링크 -->
          <div class="mt-6 text-center">
            <button @click="viewMode='dashboard'; loadDashboard()"
                    class="text-sm text-hq-accent/70 hover:text-hq-accent transition inline-flex items-center gap-1.5">
              <span>대시보드 상세 보기</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 명령 (Command) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'command'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 flex flex-col overflow-hidden relative">

        <!-- 모바일 미처리 배너 (pending SNS 항목 있을 때만) -->
        <div class="mobile-pending-banner"
             x-show="(sns.queue||[]).filter(q=>q.status==='pending').length > 0"
             @click="viewMode='chat'; switchTab('sns'); mobileMoreOpen=false"
             x-cloak>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0"/></svg>
          승인 대기
          <span class="banner-count" x-text="(sns.queue||[]).filter(q=>q.status==='pending').length"></span>건 — 탭하여 처리
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto scrollbar-thin px-6 pt-8 pb-6 space-y-4 bg-grid" id="chatArea" x-ref="chatArea" @scroll="onChatScroll($event)">

          <!-- ═══ Welcome Screen ═══ -->
          <template x-if="messages.length === 0 && viewMode === 'chat'">
            <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">
              <div class="mb-6 relative">
                <svg width="72" height="72" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-lg">
                  <defs><linearGradient id="heroGrad" x1="0" y1="0" x2="32" y2="32"><stop offset="0%" stop-color="#34d399"/><stop offset="50%" stop-color="#22d3ee"/><stop offset="100%" stop-color="#34d399"/></linearGradient></defs>
                  <path d="M16 2L28 9V23L16 30L4 23V9L16 2Z" stroke="url(#heroGrad)" stroke-width="1.5" fill="none"/>
                  <path d="M16 6L24 10.5V21.5L16 26L8 21.5V10.5L16 6Z" stroke="url(#heroGrad)" stroke-width="1" fill="none" opacity="0.4"/>
                  <circle cx="16" cy="16" r="4" fill="url(#heroGrad)" opacity="0.8"/><circle cx="16" cy="16" r="2" fill="#131317"/>
                  <line x1="16" y1="12" x2="16" y2="6" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="19.5" y1="14" x2="24" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="19.5" y1="18" x2="24" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="16" y1="20" x2="16" y2="26" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="12.5" y1="18" x2="8" y2="21.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                  <line x1="12.5" y1="14" x2="8" y2="10.5" stroke="url(#heroGrad)" stroke-width="1" opacity="0.5"/>
                </svg>
                <div class="absolute inset-0 bg-hq-accent/10 rounded-full blur-3xl scale-150"></div>
              </div>

              <h1 class="text-3xl font-bold gradient-text mb-2" style="letter-spacing: 0.08em; font-family: 'JetBrains Mono', monospace;">CORTHEX HQ</h1>
              <p class="text-base text-hq-text/80 mb-1" x-text="greeting"></p>
              <p class="text-hq-muted text-sm mb-8 max-w-sm leading-relaxed">
                무엇을 지시하시겠습니까?
              </p>

              <div class="flex gap-3 mb-6">
                <div class="glass border border-hq-green/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.1s">
                  <div class="text-lg font-bold text-hq-green font-mono">7</div><div class="text-[10px] text-hq-green/50 uppercase tracking-wider font-mono">DIVISION</div>
                </div>
                <div class="glass border border-hq-cyan/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.2s">
                  <div class="text-lg font-bold text-hq-cyan font-mono" x-text="agentsList.length || 29"></div><div class="text-[10px] text-hq-cyan/50 uppercase tracking-wider font-mono">AGENTS</div>
                </div>
                <div class="glass border border-hq-purple/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.3s">
                  <div class="text-lg font-bold text-hq-purple font-mono" x-text="toolsList.length || 103"></div><div class="text-[10px] text-hq-purple/50 uppercase tracking-wider font-mono">WEAPONS</div>
                </div>
                <div class="glass border border-hq-accent/30 rounded-xl px-4 py-3 hover-glow cursor-default bounce-in" style="animation-delay:0.4s">
                  <div class="text-lg font-bold text-hq-accent font-mono">3</div><div class="text-[10px] text-hq-accent/50 uppercase tracking-wider font-mono">AI ENGINE</div>
                </div>
              </div>

              <!-- Preset Category Tabs -->
              <div class="flex gap-2 mb-4">
                <template x-for="tab in presetTabs" :key="tab">
                  <button @click="presetTab = tab"
                    :class="presetTab === tab ? 'bg-hq-accent/20 border-hq-accent/40 text-hq-accent' : 'bg-hq-surface border-hq-border text-hq-muted hover:text-hq-text'"
                    class="border rounded-lg px-3 py-1.5 text-xs font-semibold transition-all" x-text="tab"></button>
                </template>
              </div>

              <!-- Preset Commands Grid -->
              <div class="grid grid-cols-2 gap-3 max-w-lg w-full max-h-[300px] overflow-y-auto scrollbar-thin">
                <template x-for="preset in getFilteredPresets()" :key="preset.name">
                  <div class="glass border border-hq-border rounded-xl px-4 py-3.5 text-left hover-lift hover-glow group relative">
                    <div @click="sendPreset(preset.command)" class="cursor-pointer">
                      <div class="flex items-center gap-2 mb-1.5">
                        <div class="w-7 h-7 rounded-lg flex items-center justify-center" :class="'bg-' + preset.color + '/15'">
                          <span class="w-3 h-3 rounded-full" :class="'bg-' + preset.color"></span>
                        </div>
                        <span class="text-sm font-semibold text-hq-text group-hover:text-hq-text transition-colors" x-text="preset.name"></span>
                      </div>
                      <p class="text-[11px] text-hq-muted leading-relaxed" x-text="preset.desc"></p>
                    </div>
                    <button x-show="preset.isServer" @click.stop="deletePreset(preset.name)"
                      class="absolute top-2 right-2 text-hq-muted/70 hover:text-hq-red text-xs transition opacity-0 group-hover:opacity-100" title="삭제">&times;</button>
                  </div>
                </template>
              </div>
              <!-- Add Preset Button & Form -->
              <div class="mt-3 max-w-lg w-full">
                <button x-show="!showAddPreset" @click="showAddPreset = true"
                  class="text-xs text-hq-accent hover:text-hq-accent/80 transition">+ 새 프리셋 추가</button>
                <div x-show="showAddPreset" x-transition class="glass border border-hq-border rounded-xl p-3 space-y-2">
                  <input x-model="newPresetName" placeholder="프리셋 이름" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text placeholder-hq-muted/70">
                  <input x-model="newPresetCommand" placeholder="명령어" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text placeholder-hq-muted/70">
                  <div class="flex gap-2">
                    <button @click="addPreset()" class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-3 py-1 text-xs">추가</button>
                    <button @click="showAddPreset = false; newPresetName = ''; newPresetCommand = ''" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-3 py-1 text-xs">취소</button>
                  </div>
                </div>
              </div>
              <!-- 텍스트 제거됨 (#17) -->

              <!-- 최근 완료 작업 (새로고침 후에도 표시) -->
              <div x-show="recentCommandTasks && recentCommandTasks.length > 0" class="mt-4 max-w-lg w-full">
                <div class="text-[10px] font-bold text-hq-muted/60 uppercase tracking-[0.15em] font-mono mb-2">LAST OPERATIONS</div>
                <div class="space-y-1.5">
                  <template x-for="task in recentCommandTasks.slice(0,3)" :key="task.task_id">
                    <div class="glass border border-hq-border/40 rounded-xl px-3 py-2 flex items-center gap-2 text-[10px]">
                      <span class="font-mono" x-text="task.status === 'completed' ? '✅' : '❌'"></span>
                      <span class="flex-1 text-hq-text/70 truncate"
                            x-text="(task.agent_name || task.agent_id || '') + (task.command ? ' · ' + task.command.slice(0,40) : '')"></span>
                      <span class="text-hq-muted/50 shrink-0 font-mono"
                            x-text="task.created_at ? new Date(task.created_at).toLocaleTimeString('ko-KR', {timeZone:'Asia/Seoul', hour:'2-digit', minute:'2-digit'}) : ''"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- ═══ Messages ═══ -->
          <template x-for="(msg, i) in messages" :key="i">
            <div>

              <!-- 날짜 구분선 (카카오톡 스타일) -->
              <template x-if="shouldShowDateSeparator(messages, i)">
                <div class="flex items-center my-4 gap-3">
                  <div class="flex-1 h-px bg-hq-muted/20"></div>
                  <span class="text-xs text-hq-muted/60 whitespace-nowrap" x-text="formatDate(msg.timestamp)"></span>
                  <div class="flex-1 h-px bg-hq-muted/20"></div>
                </div>
              </template>

              <!-- User message -->
              <template x-if="msg.type === 'user'">
                <div class="flex justify-end mb-4 msg-user">
                  <div class="max-w-2xl">
                    <div class="user-bubble px-5 py-3.5">
                      <div class="flex items-center gap-2 mb-1.5">
                        <div class="w-5 h-5 rounded-md bg-gradient-to-br from-hq-accent to-hq-purple flex items-center justify-center">
                          <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                        <span class="text-[11px] font-bold text-hq-accent uppercase tracking-wider" x-text="msg.source === 'telegram' ? 'CEO 명령 (텔레그램)' : 'CEO 명령'"></span>
                      </div>
                      <div class="text-hq-text text-sm leading-relaxed whitespace-pre-wrap" x-text="msg.text"></div>
                      <span class="text-[10px] text-hq-muted/40 ml-2 shrink-0 self-end block text-right mt-1" x-text="formatTime(msg.timestamp)"></span>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Queued message (D-2) -->
              <template x-if="msg.type === 'queued'">
                <div class="flex justify-end mb-4 msg-queued">
                  <div class="max-w-2xl">
                    <div class="bg-gradient-to-br from-hq-yellow/10 to-amber-500/5 border border-hq-yellow/20 border-dashed rounded-2xl rounded-tr-md px-5 py-3.5">
                      <div class="flex items-center gap-2 mb-1.5">
                        <svg class="w-4 h-4 text-hq-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-[11px] font-bold text-hq-yellow uppercase tracking-wider">대기열</span>
                        <button @click="removeFromQueue(commandQueue.findIndex(q => q.text === msg.text))"
                                class="ml-auto text-hq-muted/50 hover:text-hq-red text-[10px] transition">취소</button>
                      </div>
                      <div class="text-hq-text/70 text-sm leading-relaxed whitespace-pre-wrap" x-text="msg.text"></div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Processing indicator -->
              <template x-if="msg.type === 'processing'">
                <div class="mb-4 msg-processing">
                  <div class="max-w-3xl">
                    <div class="glass border border-hq-yellow/20 rounded-2xl rounded-tl-md px-5 py-4">
                      <div class="flex items-center gap-2 mb-3">
                        <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
                        <span class="text-xs font-bold text-hq-yellow uppercase tracking-wider">에이전트 작업중</span>
                        <div class="ml-auto flex gap-1">
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0s"></span>
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0.3s"></span>
                          <span class="w-1 h-1 rounded-full bg-hq-yellow/60 pulse-dot" style="animation-delay:0.6s"></span>
                        </div>
                      </div>
                      <!-- 리프레시 후 복원된 작업 명령어 표시 -->
                      <div x-show="msg.restoredCommand && Object.values(activeAgents).filter(a => a.status === 'working').length === 0"
                           class="text-[11px] text-hq-muted/80 italic pl-1 pb-1">
                        <span class="text-hq-yellow/70">복원됨:</span>
                        <span x-text="msg.restoredCommand"></span>
                      </div>
                      <div class="space-y-2.5">
                        <template x-for="(status, agentId) in activeAgents" :key="agentId">
                          <div x-show="status.status === 'working'" class="fade-in cursor-pointer" @click="scrollToAgent(agentId)">
                            <div class="flex items-center justify-between mb-1">
                              <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold"
                                     :class="getAgentAvatarClass(agentId)" x-text="getAgentInitials(agentId)"></div>
                                <span class="text-xs text-hq-text/80 font-medium" x-text="getAgentName(agentId)"></span>
                              </div>
                              <span class="text-[10px] font-mono text-hq-yellow" x-text="Math.round(status.progress * 100) + '%'"></span>
                            </div>
                            <div x-show="status.detail" class="text-[10px] text-hq-muted mb-1 pl-7 truncate" x-text="status.detail"></div>
                            <div class="h-1 bg-hq-bg rounded-full overflow-hidden">
                              <div class="h-full rounded-full progress-bar bg-gradient-to-r from-hq-yellow to-hq-accent"
                                   :style="'width:' + (status.progress * 100) + '%'"></div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Agent result -->
              <template x-if="msg.type === 'result'">
                <div class="mb-4 msg-result">
                  <div class="max-w-4xl">
                    <div class="agent-bubble overflow-hidden" :data-agent="msg.agent_id">
                      <div class="flex items-center justify-between px-5 py-3 border-b border-hq-border/50">
                        <div class="flex items-center gap-2.5">
                          <div class="w-2 h-2 rounded-full bg-hq-accent"></div>
                          <span class="text-xs font-bold text-hq-accent tracking-wider" x-text="msg.delegation || msg.handled_by || (msg.agent_id ? getAgentName(msg.agent_id) : '시스템')"></span>
                          <!-- D-6: 보고서 ID -->
                          <span x-show="msg.task_id" class="text-[9px] font-mono text-hq-muted/30" x-text="'#' + (msg.task_id || '').slice(0, 8)"></span>
                          <template x-if="msg.quality_score">
                            <span class="status-badge border" :class="getQualityBadge(msg.quality_score).cls" x-text="getQualityBadge(msg.quality_score).label"></span>
                          </template>
                        </div>
                        <div class="flex items-center gap-3">
                          <div class="flex items-center gap-4 text-[11px] font-mono text-hq-muted">
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                              <span x-text="msg.time_seconds + 's'"></span>
                            </div>
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                              <span x-text="'$' + (msg.cost || 0).toFixed(4)"></span>
                            </div>
                            <template x-if="msg.model">
                              <div class="flex items-center gap-1">
                                <span class="text-hq-accent">&#9679;</span>
                                <span x-text="msg.model.includes('-') ? msg.model.split('-')[1] : msg.model"></span>
                              </div>
                            </template>
                          </div>
                          <button @click="copyToClipboard(msg.content)" class="text-hq-muted hover:text-hq-green transition p-1" title="복사">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                          </button>
                          <!-- Feedback Buttons -->
                          <div class="flex items-center gap-0.5 border-l border-hq-border/40 pl-2 ml-1">
                            <button @click="sendFeedback(msg, 'good')"
                              :class="msg.feedbackRating === 'good' ? 'text-hq-green scale-110 bg-green-500/20 ring-1 ring-green-400/50 rounded' : 'text-hq-muted hover:text-hq-green'"
                              class="transition-all duration-200 p-1" :title="msg.feedbackRating === 'good' ? '좋아요 취소' : '좋아요'">
                              <svg class="w-4 h-4" :fill="msg.feedbackRating === 'good' ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg>
                            </button>
                            <button @click="sendFeedback(msg, 'bad')"
                              :class="msg.feedbackRating === 'bad' ? 'text-hq-red scale-110 bg-red-500/20 ring-1 ring-red-400/50 rounded' : 'text-hq-muted hover:text-hq-red'"
                              class="transition-all duration-200 p-1" :title="msg.feedbackRating === 'bad' ? '아쉬워요 취소' : '아쉬워요'">
                              <svg class="w-4 h-4" :fill="msg.feedbackRating === 'bad' ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a3.5 3.5 0 003.5 3.5h.5a2 2 0 002-2v-.5c0-.966-.393-1.84-1.027-2.472L17 13V4m-7 10h2M17 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/></svg>
                            </button>
                          </div>
                          <button x-show="isLongContent(msg.content)" @click="msg.collapsed = !msg.collapsed"
                            class="text-hq-muted hover:text-hq-text transition p-1" title="접기/펼치기">
                            <svg class="w-4 h-4 transition-transform" :class="msg.collapsed ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                          </button>
                        </div>
                      </div>
                      <div class="px-5 py-4" x-show="!msg.collapsed" x-collapse>
                        <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(msg.content)"></div>
                      </div>
                      <div x-show="msg.collapsed" class="px-5 py-3">
                        <div class="text-sm text-hq-muted italic">결과가 접혀있습니다. 위 버튼을 클릭하면 펼칩니다. <span class="text-[11px] ml-2" x-text="'(' + (msg.content?.length || 0) + '자)'"></span></div>
                      </div>
                      <div class="px-5 pb-2 text-right">
                        <span class="text-[10px] text-hq-muted/40" x-text="formatTime(msg.timestamp)"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Error -->
              <template x-if="msg.type === 'error'">
                <div class="mb-4 scale-in">
                  <div class="max-w-2xl">
                    <div class="bg-hq-red/5 border border-hq-red/20 rounded-2xl rounded-tl-md px-5 py-4">
                      <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                        <span class="text-xs font-bold text-hq-red uppercase tracking-wider">오류</span>
                      </div>
                      <div class="text-sm text-hq-text/80" x-text="msg.text"></div>
                      <span class="text-[10px] text-hq-muted/40 block text-right mt-1" x-text="formatTime(msg.timestamp)"></span>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Phase 3: 재시도 버블 (30초 무응답) -->
              <template x-if="msg.type === 'retry'">
                <div class="mb-4 scale-in">
                  <div class="retry-bubble">
                    <span class="retry-bubble-icon">⚠️</span>
                    <div class="retry-bubble-text" x-text="msg.text"></div>
                    <button class="retry-bubble-btn" @click="retryMessage(msg.retryText)">재시도</button>
                  </div>
                </div>
              </template>

            </div>
          </template>
        </div>

        <!-- 스크롤 다운 버튼 -->
        <button x-show="showScrollBtn" x-transition @click="scrollToBottomSmooth()"
          class="absolute bottom-20 right-6 z-30 w-10 h-10 rounded-full bg-hq-accent/80 hover:bg-hq-accent text-white shadow-lg flex items-center justify-center backdrop-blur-sm transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
          <span x-show="newMsgCount > 0" x-text="newMsgCount"
            class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center"></span>
        </button>

        <!-- 내부통신 패널 삭제됨 — 통신로그 4탭 체계로 대체 (D안, 2026-02-23) -->
        <div x-show="false" x-cloak
             class="absolute top-0 right-0 w-80 h-full flex flex-col z-20 border-l border-hq-border/60"
          <!-- 패널 헤더 -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-hq-border/50 shrink-0">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-hq-cyan animate-pulse"></span>
              <span class="text-sm font-bold text-hq-text tracking-wide">내부통신</span>
              <span class="text-[10px] text-hq-muted/60 font-mono">DELEGATION LOG</span>
            </div>
            <div class="flex items-center gap-2">
              <button @click="fetchDelegationLogs()" title="새로고침"
                      class="text-hq-muted hover:text-hq-accent transition p-1 rounded">
                <svg class="w-3.5 h-3.5" :class="delegationLogLoading ? 'animate-spin' : ''"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
              </button>
              <button @click="showDelegationLog = false" title="닫기"
                      class="text-hq-muted hover:text-hq-red transition p-1 rounded">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          <!-- 필터 탭 -->
          <div class="flex gap-1 px-3 py-2 border-b border-hq-border/30 shrink-0">
            <button @click="delegationLogFilter = 'all'"
                    :class="delegationLogFilter === 'all' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                    class="text-[10px] px-2 py-1 rounded-md font-semibold transition">전체</button>
            <button @click="delegationLogFilter = 'delegation'"
                    :class="delegationLogFilter === 'delegation' ? 'bg-hq-cyan/20 text-hq-cyan' : 'text-hq-muted hover:text-hq-text'"
                    class="text-[10px] px-2 py-1 rounded-md font-semibold transition">위임</button>
            <button @click="delegationLogFilter = 'report'"
                    :class="delegationLogFilter === 'report' ? 'bg-hq-green/20 text-hq-green' : 'text-hq-muted hover:text-hq-text'"
                    class="text-[10px] px-2 py-1 rounded-md font-semibold transition">보고</button>
            <button @click="delegationLogFilter = 'p2p'"
                    :class="delegationLogFilter === 'p2p' ? 'bg-hq-orange/20 text-hq-orange' : 'text-hq-muted hover:text-hq-text'"
                    class="text-[10px] px-2 py-1 rounded-md font-semibold transition">P2P</button>
            <button @click="delegationLogFilter = 'flow'"
                    :class="delegationLogFilter === 'flow' ? 'bg-hq-purple/20 text-hq-purple' : 'text-hq-muted hover:text-hq-text'"
                    class="text-[10px] px-2 py-1 rounded-md font-semibold transition">흐름도</button>
          </div>
          <!-- 로그 목록 (전체/위임/보고 탭) -->
          <div x-show="delegationLogFilter !== 'flow'" class="flex-1 overflow-y-auto scrollbar-thin p-2.5 space-y-1.5">
            <template x-if="delegationLogs.length === 0 && !delegationLogLoading">
              <div class="text-center py-8">
                <div class="text-hq-muted/40 text-sm">에이전트 통신 없음</div>
                <div class="text-hq-muted/30 text-[11px] mt-1">대화를 시작하면 여기에 표시됩니다</div>
              </div>
            </template>
            <template x-for="log in getFilteredDelegationLogs()" :key="log.id">
              <!-- B안: 카드형 — 왼쪽 컬러 보더 + 발신/수신 헤더 + 메시지 + 시간(hover) -->
              <div class="rounded-lg border border-hq-border/20 bg-hq-panel/30 overflow-hidden transition-all hover:bg-hq-panel/60 hover:border-hq-border/40 hover:shadow-sm"
                   :style="'border-left: 3px solid ' + getDeptColor(log.sender)">
                <!-- 헤더: 발신 → 수신 + 상대시간 -->
                <div class="flex items-center justify-between px-3 pt-2.5 pb-1">
                  <div class="flex items-center gap-1.5 min-w-0">
                    <span class="text-[11px] font-bold truncate max-w-[90px]"
                          :style="'color:' + getDeptColor(log.sender)"
                          x-text="getAgentName(log.sender) || log.sender"></span>
                    <svg class="w-3 h-3 text-hq-muted/40 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                    <span class="text-[11px] font-semibold text-hq-text/80 truncate max-w-[90px]"
                          x-text="getAgentName(log.receiver) || log.receiver"></span>
                  </div>
                  <!-- 상대시간 (hover시 정확한 시간 툴팁) -->
                  <span class="text-[9px] text-hq-muted/50 shrink-0 ml-1 cursor-default whitespace-nowrap"
                        :title="formatTime(log.created_at)"
                        x-text="relativeTimeStr(log.created_at)"></span>
                </div>
                <!-- 메시지 미리보기 (마크다운 제거) -->
                <div class="px-3 pb-2 text-[11px] text-hq-muted/70 leading-relaxed line-clamp-2"
                     x-text="stripMarkdown(log.message)"></div>
                <!-- 유형 배지 -->
                <div class="px-3 pb-2.5">
                  <span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider"
                        :class="log.source === 'cross_agent' ? 'bg-hq-orange/15 text-hq-orange' : (log.log_type === 'delegation' ? 'bg-hq-cyan/15 text-hq-cyan' : (log.log_type === 'consult' ? 'bg-hq-purple/15 text-hq-purple' : 'bg-hq-green/15 text-hq-green'))"
                        x-text="log.source === 'cross_agent' ? 'P2P' : (log.log_type === 'delegation' ? '위임' : (log.log_type === 'consult' ? '협의' : '보고'))"></span>
                </div>
              </div>
            </template>
          </div>
          <!-- 흐름도 탭 -->
          <div x-show="delegationLogFilter === 'flow'" class="flex-1 overflow-y-auto scrollbar-thin p-2.5">
            <template x-if="delegationLogs.length === 0">
              <div class="text-center py-8 text-hq-muted/60 text-[11px]">협업 기록이 없습니다</div>
            </template>
            <div class="space-y-0">
              <template x-for="(log, idx) in delegationLogs.slice(0, 20)" :key="log.id || idx">
                <div class="relative pl-10">
                  <!-- 타임라인 세로선 -->
                  <div x-show="idx < delegationLogs.slice(0,20).length - 1"
                       class="absolute left-[14px] top-[28px] w-px bottom-[-4px] bg-hq-border/30"></div>
                  <!-- 발신자 컬러 도트 -->
                  <div class="absolute left-[9px] top-[10px] w-[11px] h-[11px] rounded-full border-2 border-hq-bg"
                       :style="'background:' + getDeptColor(log.sender)"></div>
                  <!-- 카드 내용 -->
                  <div class="mb-3 pb-1">
                    <div class="flex items-center gap-1 mb-0.5">
                      <span class="text-[11px] font-bold"
                            :style="'color:' + getDeptColor(log.sender)"
                            x-text="getAgentName(log.sender) || log.sender"></span>
                      <svg class="w-3 h-3 text-hq-muted/40 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-[11px] font-semibold text-hq-text/80 truncate"
                            x-text="getAgentName(log.receiver) || log.receiver"></span>
                      <span x-show="log.title" class="text-[10px] text-hq-accent/70 truncate max-w-[120px]"
                            x-text="'· ' + (log.title || '')"></span>
                      <span class="ml-auto text-[9px] text-hq-muted/40 shrink-0 cursor-default"
                            :title="formatTime(log.created_at)"
                            x-text="relativeTimeStr(log.created_at)"></span>
                    </div>
                    <div class="text-[10px] text-hq-muted/60 line-clamp-2 leading-relaxed"
                         x-text="stripMarkdown(log.message)"></div>
                    <span class="inline-block mt-1 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider"
                          :class="log.source === 'cross_agent' ? 'bg-hq-orange/10 text-hq-orange' : (log.log_type === 'delegation' ? 'bg-hq-cyan/10 text-hq-cyan' : 'bg-hq-green/10 text-hq-green')"
                          x-text="log.source === 'cross_agent' ? 'P2P' : (log.log_type === 'delegation' ? '위임' : '보고')"></span>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <!-- 푸터 -->
          <div class="px-4 py-2 border-t border-hq-border/30 shrink-0 flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full animate-pulse" :class="_commsSSE ? 'bg-hq-green' : 'bg-hq-muted/40'"></span>
            <span class="text-[10px] text-hq-muted/60" x-text="_commsSSE ? 'SSE 실시간' : '대기'"></span>
            <span class="text-[10px] text-hq-muted/40 ml-auto" x-text="delegationLogs.length + '건'"></span>
          </div>
        </div>

        <!-- ═══ Input Bar ═══ -->
        <div class="command-input-wrap p-4 shrink-0 relative z-50 chat-input-bar">
          <div class="max-w-4xl mx-auto relative">
            <!-- 슬래시 명령어 팝업 -->
            <div x-show="showSlashDropdown" x-transition
                 class="absolute bottom-full mb-2 left-0 w-full max-w-[calc(100%-1rem)] sm:max-w-96 bg-[rgb(var(--hq-surface))] border border-hq-border rounded-xl overflow-hidden shadow-2xl z-[999]">
              <div class="px-4 py-2 border-b border-hq-border/30">
                <span class="text-xs text-hq-muted font-semibold tracking-wide">명령어</span>
              </div>
              <template x-for="(cmd, idx) in filteredSlashCommands" :key="cmd.cmd">
                <button @click="insertSlashCommand(cmd)" @mouseenter="slashSelectedIndex = idx"
                  class="w-full px-4 py-2.5 text-left flex items-center gap-3 transition-colors"
                  :class="idx === slashSelectedIndex ? 'bg-hq-accent/15' : 'hover:bg-hq-accent/5'">
                  <span class="text-lg w-7 text-center" x-text="cmd.icon"></span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="text-hq-accent font-mono font-bold text-sm" x-text="cmd.cmd"></span>
                      <span class="text-hq-muted/60 text-xs" x-text="cmd.args"></span>
                    </div>
                    <div class="text-[13px] text-hq-muted font-medium truncate mt-0.5" x-text="cmd.desc"></div>
                  </div>
                </button>
              </template>
            </div>
            <!-- @mention dropdown -->
            <div x-show="showMentionDropdown" x-transition
                 class="absolute bottom-full mb-2 left-0 w-full max-w-72 rounded-xl overflow-hidden shadow-2xl z-50"
                 :style="darkMode
                   ? 'background:#0d1117; border:1px solid #374158; box-shadow:0 8px 32px rgba(0,0,0,0.6);'
                   : 'background:#ffffff; border:1px solid #d1d5db; box-shadow:0 8px 32px rgba(0,0,0,0.12);'">
              <div class="px-3 py-1.5 text-[10px] text-hq-muted uppercase tracking-wider border-b border-hq-border/50">에이전트 @ 멘션</div>
              <div class="max-h-64 overflow-y-auto">
                <template x-for="group in mentionGroups" :key="group.label">
                  <div>
                    <div class="px-3 py-1 text-[9px] text-hq-muted/70 uppercase tracking-widest font-semibold"
                         :style="darkMode ? 'background:#111827;' : 'background:#f3f4f6;'" x-text="group.label"></div>
                    <template x-for="agent in group.agents" :key="agent.id">
                      <button @click="insertMention(agent)"
                        class="w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 transition-colors"
                        @mouseover="$el.style.background=darkMode ? 'rgba(99,102,241,0.15)' : 'rgba(99,102,241,0.08)'"
                        @mouseout="$el.style.background='transparent'">
                        <span class="w-6 h-6 rounded-md flex items-center justify-center text-[9px] font-bold"
                          :class="getAgentAvatarClass(agent.id)" x-text="getAgentInitials(agent.id)"></span>
                        <span class="text-hq-text text-sm" x-text="agent.name"></span>
                      </button>
                    </template>
                  </div>
                </template>
              </div>
            </div>
            <!-- 수신자 선택 드롭다운 -->
            <div class="flex items-center gap-1.5 mb-1 flex-wrap">
              <select
                x-model="targetAgentId"
                class="text-xs px-2 py-1.5 rounded-lg border border-hq-border bg-hq-panel text-hq-muted
                       focus:outline-none focus:border-hq-accent/60 transition-colors cursor-pointer shrink-0
                       dark:bg-hq-panel dark:text-hq-muted"
                title="메시지 수신자 선택"
              >
                <option value="">🤖 전체 자동 라우팅</option>
                <template x-for="group in getRecipientGroups()" :key="group.label">
                  <optgroup :label="'── ' + group.label + ' ──'">
                    <template x-for="agent in group.agents" :key="agent.id">
                      <option :value="agent.id" x-text="agent.name"></option>
                    </template>
                  </optgroup>
                </template>
              </select>
              <!-- 직접 전달 모드 안내 -->
              <p x-show="targetAgentId"
                 x-transition:enter="transition ease-out duration-150"
                 x-transition:enter-start="opacity-0 translate-y-1"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="text-[11px] text-hq-yellow font-medium">
                📌 직접 전달: <span x-text="targetAgentId"></span>에게 바로 전송
              </p>
            </div>
            <!-- 배치 진행 상태 배너 (모바일에서 상단 표시) -->
            <div x-show="batchProgress.active" x-transition
                 class="px-3 py-1.5 mb-1.5 rounded-lg bg-hq-yellow/10 border border-hq-yellow/30 text-xs flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-hq-yellow animate-pulse shrink-0"></span>
              <span class="text-hq-yellow font-medium shrink-0" x-text="batchProgress.step"></span>
              <span class="text-hq-muted truncate flex-1 min-w-0" x-text="batchProgress.message"></span>
              <span class="font-mono text-hq-muted shrink-0" x-text="batchProgress.elapsed"></span>
            </div>
            <div class="flex items-end gap-2 sm:gap-3">
              <!-- Batch/실시간 세그먼트 토글 -->
              <div class="flex rounded-xl border border-hq-border/40 overflow-hidden shrink-0 self-stretch">
                <button @click="useBatch = false"
                        class="text-xs px-2 sm:px-3 py-2 transition-all"
                        :class="!useBatch
                          ? 'bg-hq-accent/15 text-hq-accent'
                          : 'text-hq-muted/60 hover:text-hq-muted'">⚡<span class="hidden sm:inline"> 실시간</span></button>
                <button @click="useBatch = true"
                        class="text-xs px-2 sm:px-3 py-2 transition-all"
                        :class="useBatch
                          ? 'bg-hq-purple/15 text-hq-purple'
                          : 'text-hq-muted/60 hover:text-hq-muted'">📦<span class="hidden sm:inline"> Batch</span></button>
              </div>
              <div class="flex-1 relative">
                <textarea x-model="inputText" x-ref="inputArea"
                  @keydown="handleInputKeydown($event)" @input="handleInputChange($event)"
                  :placeholder="systemStatus === 'working' ? '명령 대기열에 추가됩니다...' : '명령을 입력하세요... (@로 에이전트 지정)'"
                  rows="1"
                  class="command-textarea w-full px-4 py-3 pr-10 text-hq-text
                         disabled:opacity-40 disabled:cursor-not-allowed resize-none overflow-hidden"
                  style="min-height:46px; max-height:200px;" autofocus></textarea>
                <div class="absolute right-3 bottom-3 text-[10px] font-mono text-hq-muted/70"
                     x-show="!inputText.trim() && systemStatus !== 'working'">Enter &#9166;</div>
              </div>
              <button @click="sendMessage()"
                :disabled="!inputText.trim()"
                :class="inputText.trim()
                  ? (systemStatus === 'working'
                    ? 'bg-hq-yellow text-black shadow-lg'
                    : 'send-btn-active')
                  : 'border border-hq-border bg-hq-panel/50 text-hq-muted/40'"
                class="rounded-full w-12 h-12 flex items-center justify-center transition-all shrink-0"
                :title="systemStatus === 'working' ? '대기열에 추가' : '보내기'"
                style="min-width:48px;">
                <svg x-show="systemStatus !== 'working'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18"/>
                </svg>
                <svg x-show="systemStatus === 'working'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
              </button>
              <button x-show="systemStatus === 'working'" @click="cancelTask()"
                class="bg-hq-red/20 border border-hq-red/30 hover:bg-hq-red/30
                       text-hq-red rounded-xl px-6 py-3 text-sm font-semibold transition-all shrink-0 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                취소
              </button>
            </div>
          </div>
          <!-- 하단 툴바: 내부통신 + 프리셋 + 내보내기/비우기 한 행 -->
          <div class="flex items-center gap-2 flex-wrap mt-2 max-w-4xl mx-auto overflow-x-auto scrollbar-thin">
            <!-- 내부통신 버튼 삭제됨 (D안, 2026-02-23) -->
            <template x-for="p in presets.items" :key="p.name">
              <button @click="sendPreset(p.command)"
                      class="text-[11px] bg-hq-panel border border-hq-border rounded-lg px-2.5 py-1 hover:border-hq-accent/40 hover:text-hq-accent transition text-hq-muted whitespace-nowrap shrink-0">
                <span x-text="p.name"></span>
              </button>
            </template>
            <button x-show="presets.items && presets.items.length > 0" @click="presets.showModal = true" class="text-[11px] text-hq-muted/80 hover:text-hq-accent transition px-1 shrink-0">
              <svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            </button>
            <!-- 대화 세션 버튼 (새 대화 + 목록 + 턴 카운터) -->
            <div class="flex items-center gap-2 shrink-0">
              <button @click="showConversationDrawer = !showConversationDrawer"
                      class="text-[10px] flex items-center gap-1 transition border rounded-lg px-2 py-1"
                      :class="showConversationDrawer ? 'border-hq-accent/40 text-hq-accent' : 'border-hq-border text-hq-muted hover:text-hq-text'">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg>
                대화목록
              </button>
              <button @click="newConversation()"
                      class="text-[10px] text-hq-accent hover:text-hq-accent/80 flex items-center gap-1 transition border border-hq-accent/30 rounded-lg px-2 py-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                새 대화
              </button>
              <span x-show="conversationTurnCount > 0"
                    class="text-[9px] font-mono text-hq-muted/60 bg-hq-surface rounded px-1.5 py-0.5"
                    x-text="conversationTurnCount + '턴'"></span>
            </div>
            <!-- 대화 내보내기 + 비우기 (오른쪽 끝) -->
            <div x-show="messages.length > 0" class="flex items-center gap-2 ml-auto shrink-0">
              <button @click="exportConversation()"
                      class="text-[10px] text-hq-muted/70 hover:text-hq-accent flex items-center gap-1 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                내보내기
              </button>
              <span class="text-hq-border">|</span>
              <button @click="clearConversation()"
                      class="text-[10px] text-hq-muted/70 hover:text-hq-red flex items-center gap-1 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                대화 비우기
              </button>
            </div>
          </div>
        </div>
      <!-- 대화 목록 서랍 (Conversation List Drawer) -->
      <div x-show="showConversationDrawer" x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 -translate-x-full" x-transition:enter-end="opacity-100 translate-x-0"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100 translate-x-0" x-transition:leave-end="opacity-0 -translate-x-full"
           class="fixed inset-y-0 left-0 z-50 w-72 bg-hq-surface border-r border-hq-border shadow-2xl flex flex-col"
           @click.outside="showConversationDrawer = false" x-cloak>
        <div class="p-4 border-b border-hq-border flex items-center justify-between">
          <h3 class="text-sm font-bold text-hq-text">대화 목록</h3>
          <button @click="showConversationDrawer = false" class="text-hq-muted hover:text-hq-text">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="p-2 border-b border-hq-border">
          <button @click="newConversation(); showConversationDrawer = false"
                  class="w-full text-xs text-hq-accent hover:bg-hq-accent/10 flex items-center gap-2 transition rounded-lg px-3 py-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            새 대화 시작
          </button>
        </div>
        <div class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-1">
          <template x-for="conv in conversationList" :key="conv.conversation_id">
            <div @click="switchConversation(conv.conversation_id)"
                 :class="currentConversationId === conv.conversation_id ? 'bg-hq-accent/10 border-hq-accent/30' : 'border-transparent hover:bg-hq-panel'"
                 class="rounded-lg border px-3 py-2 cursor-pointer transition group">
              <div class="text-xs text-hq-text font-medium truncate" x-text="conv.title"></div>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-[9px] text-hq-muted font-mono" x-text="(conv.turn_count || 0) + '턴'"></span>
                <span class="text-[9px] text-hq-muted" x-text="new Date(conv.updated_at).toLocaleDateString('ko-KR')"></span>
                <span x-show="conv.total_cost > 0" class="text-[9px] text-hq-muted font-mono" x-text="'$' + (conv.total_cost || 0).toFixed(3)"></span>
                <button @click.stop="deleteConversationSession(conv.conversation_id)"
                        class="ml-auto text-hq-muted/50 hover:text-hq-red opacity-0 group-hover:opacity-100 transition">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </template>
          <template x-if="conversationList.length === 0">
            <div class="text-xs text-hq-muted/60 text-center py-8">대화 기록이 없습니다</div>
          </template>
        </div>
      </div>

      </div><!-- /command tab -->

      <!-- ═══ Tab: 성능 (Performance) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'performance'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-4 md:mb-6">
            <div>
              <h1 class="text-lg md:text-xl font-bold text-hq-text mb-1 font-mono tracking-normal">POWER ANALYSIS</h1>
              <p class="text-xs md:text-sm text-hq-muted">에이전트별 작업 통계를 확인하세요</p>
            </div>
            <button @click="performance.loaded = false; loadPerformance()"
                    class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-muted hover:text-hq-text transition flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              새로고침
            </button>
          </div>

          <!-- Performance Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-text" x-text="performance.totalCalls || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 LLM 호출</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-green" x-text="'$' + (performance.totalCost || 0).toFixed(4)"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 비용</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-text" x-text="performance.totalTasks || 0"></div>
              <div class="text-[10px] text-hq-muted uppercase">총 작업</div>
            </div>
            <div class="glass border border-hq-border rounded-xl p-4">
              <div class="text-xl font-bold text-hq-cyan" x-text="(performance.avgSuccessRate || 0).toFixed(0) + '%'"></div>
              <div class="text-[10px] text-hq-muted uppercase">평균 성공률</div>
            </div>
          </div>

          <!-- Agent Performance Table -->
          <div class="flex items-center gap-2 mb-2 px-1">
            <svg class="w-4 h-4 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
            <span class="text-xs text-hq-muted">각 팀장의 <span class="text-hq-purple font-semibold">기억</span> 버튼을 클릭하면 장기기억을 관리할 수 있습니다</span>
          </div>
          <div class="glass border border-hq-border rounded-xl overflow-x-auto">
            <table class="w-full text-sm min-w-[600px]">
              <thead>
                <tr class="border-b border-hq-border text-[11px] text-hq-muted uppercase">
                  <th class="text-left px-4 py-3">에이전트</th>
                  <th class="text-right px-4 py-3">호출</th>
                  <th class="text-right px-4 py-3">비용</th>
                  <th class="text-right px-4 py-3">작업</th>
                  <th class="text-right px-4 py-3">성공률</th>
                  <th class="text-right px-4 py-3">평균 시간</th>
                  <th class="px-4 py-3 w-32">비용 비율</th>
                  <th class="px-4 py-3">기억</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="a in performance.agents" :key="a.agent_id">
                  <tr class="border-b border-hq-border/50 hover:bg-hq-panel/20">
                    <td class="px-4 py-2.5">
                      <div class="text-hq-text font-medium" x-text="a.name_ko"></div>
                      <div class="text-[10px] text-hq-muted" x-text="a.role"></div>
                    </td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.llm_calls"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-green" x-text="'$' + (a.cost_usd || 0).toFixed(4)"></td>
                    <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="a.tasks_completed"></td>
                    <td class="text-right px-4 py-2.5">
                      <span class="font-mono" :class="(a.success_rate||0) >= 80 ? 'text-hq-green' : (a.success_rate||0) >= 50 ? 'text-hq-yellow' : 'text-hq-red'"
                            x-text="(a.success_rate || 0).toFixed(0) + '%'"></span>
                    </td>
                    <td class="text-right px-4 py-2.5 text-hq-muted" x-text="(a.avg_execution_seconds || 0).toFixed(1) + '초'"></td>
                    <td class="px-4 py-2.5">
                      <div class="h-2 bg-hq-bg rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-hq-accent to-hq-cyan rounded-full transition-all"
                             :style="'width:' + (performance.maxCost > 0 ? ((a.cost_usd || 0) / performance.maxCost * 100) : 0) + '%'"></div>
                      </div>
                    </td>
                    <td class="px-4 py-2.5 text-center">
                      <button @click="openMemoryModal(a.agent_id, a.name_ko)"
                              class="text-xs px-3 py-1.5 rounded-lg border border-hq-purple/40 text-hq-purple hover:bg-hq-purple/20 transition font-semibold flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
                        기억
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <template x-if="!performance.agents || performance.agents.length === 0">
              <div class="text-center py-12 text-hq-muted/80 text-sm">성능 데이터가 없습니다. 작업을 실행하면 통계가 쌓입니다.</div>
            </template>
          </div>

          <!-- 품질 대시보드 (Phase 11) -->
          <div class="mt-6 glass border border-hq-border rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold text-hq-text font-mono">QUALITY DASHBOARD</h3>
              <button @click="loadQualityDashboard()"
                      class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-hq-cyan/20 text-hq-cyan hover:bg-hq-cyan/30 transition">새로고침</button>
            </div>

            <!-- 품질 요약 카드 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
              <div class="bg-hq-bg rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-hq-text" x-text="qualityDash.totalReviews"></div>
                <div class="text-[10px] text-hq-muted">총 검수</div>
              </div>
              <div class="bg-hq-bg rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-hq-green" x-text="qualityDash.passRate + '%'"></div>
                <div class="text-[10px] text-hq-muted">합격률</div>
              </div>
              <div class="bg-hq-bg rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-hq-cyan" x-text="qualityDash.avgScore"></div>
                <div class="text-[10px] text-hq-muted">평균 점수</div>
              </div>
              <div class="bg-hq-bg rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-hq-red" x-text="qualityDash.failed"></div>
                <div class="text-[10px] text-hq-muted">반려 횟수</div>
              </div>
            </div>

            <!-- 점수 추이 차트 -->
            <div class="bg-hq-bg rounded-lg p-3 mb-3" style="height:200px">
              <canvas id="qualityScoreChart"></canvas>
            </div>

            <!-- 반복 반려 항목 Top 5 -->
            <template x-if="qualityDash.topRejections.length > 0">
              <div>
                <div class="text-[10px] text-hq-muted uppercase mb-1">반복 반려 Top 5</div>
                <template x-for="r in qualityDash.topRejections" :key="r.target_id + r.reason">
                  <div class="flex items-center gap-2 text-xs py-1 border-b border-hq-border/20">
                    <span class="text-hq-red font-mono" x-text="r.count + '회'"></span>
                    <span class="text-hq-accent" x-text="r.target_id"></span>
                    <span class="text-hq-muted truncate" x-text="r.reason"></span>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- Soul 자동 진화 섹션 -->
          <div class="mt-6 glass border border-hq-border rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-hq-text font-mono">SOUL EVOLUTION</h3>
                <p class="text-[10px] text-hq-muted">반려 학습 패턴 분석 → 소울 자동 개선 제안 (매주 일요일 03:00)</p>
              </div>
              <button @click="soulEvolution.loading = true; fetch('/api/soul-evolution/run', {method:'POST'}).then(r => r.json()).then(d => { soulEvolution.loading = false; soulEvolution.message = d.message || '분석 시작됨'; setTimeout(() => loadSoulEvolutionProposals(), 3000); })"
                      :disabled="soulEvolution.loading"
                      class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-hq-purple/20 text-hq-purple hover:bg-hq-purple/30 transition disabled:opacity-50">
                <span x-show="!soulEvolution.loading">수동 분석</span>
                <span x-show="soulEvolution.loading">분석 중...</span>
              </button>
            </div>
            <div x-show="soulEvolution.message" class="text-xs text-hq-cyan mb-2" x-text="soulEvolution.message"></div>

            <!-- 대기 중인 제안 목록 -->
            <template x-if="soulEvolution.proposals.length > 0">
              <div class="space-y-3">
                <template x-for="(p, idx) in soulEvolution.proposals" :key="p.id">
                  <div class="bg-hq-bg rounded-lg p-3 border border-hq-border/50">
                    <div class="flex items-center justify-between mb-2">
                      <div>
                        <span class="text-xs font-bold text-hq-accent" x-text="p.agent_name"></span>
                        <span class="text-[10px] text-hq-muted ml-2 font-mono" x-text="p.agent_id"></span>
                      </div>
                      <span class="text-[10px] text-hq-muted" x-text="p.created_at"></span>
                    </div>
                    <div class="text-[10px] text-hq-muted mb-1">반려 기록:</div>
                    <div class="text-xs text-hq-yellow bg-hq-yellow/5 rounded p-2 mb-2 font-mono leading-relaxed max-h-16 overflow-y-auto" x-text="p.warnings"></div>
                    <div class="text-[10px] text-hq-muted mb-1">제안:</div>
                    <div class="text-xs text-hq-text bg-hq-bg rounded p-2 mb-3 border border-hq-border/30 leading-relaxed max-h-32 overflow-y-auto whitespace-pre-wrap" x-text="p.proposed_change"></div>
                    <div class="flex gap-2" x-show="p.status === 'pending'">
                      <button @click="fetch('/api/soul-evolution/approve/' + p.id, {method:'POST'}).then(r => r.json()).then(d => { if(d.success) { p.status = 'approved'; soulEvolution.message = d.message; } })"
                              class="flex-1 py-1.5 text-xs font-semibold rounded-lg bg-hq-green/20 text-hq-green hover:bg-hq-green/30 transition">승인 (소울 업데이트)</button>
                      <button @click="fetch('/api/soul-evolution/reject/' + p.id, {method:'POST'}).then(r => r.json()).then(d => { if(d.success) { p.status = 'rejected'; soulEvolution.message = '거부됨'; } })"
                              class="flex-1 py-1.5 text-xs font-semibold rounded-lg bg-hq-red/20 text-hq-red hover:bg-hq-red/30 transition">거부</button>
                    </div>
                    <div x-show="p.status === 'approved'" class="text-xs text-hq-green font-semibold text-center py-1">승인됨</div>
                    <div x-show="p.status === 'rejected'" class="text-xs text-hq-red font-semibold text-center py-1">거부됨</div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="soulEvolution.proposals.length === 0">
              <div class="text-center py-4 text-hq-muted/60 text-xs">대기 중인 제안이 없습니다.</div>
            </template>
          </div>
        </div>

          <!-- Soul Gym 경쟁 진화 섹션 -->
          <div class="mt-6 glass border border-hq-border rounded-xl p-4"
               x-data="{
                 gymStatus: { idle: true, running_all: false, running_agents: [] },
                 gymHistory: [],
                 gymLoading: false,
                 gymMessage: '',
                 gymConfig: {},
                 async loadGymStatus() {
                   try {
                     const r = await fetch('/api/soul-gym/status');
                     this.gymStatus = await r.json();
                   } catch(e) {}
                 },
                 async loadGymHistory() {
                   try {
                     const r = await fetch('/api/soul-gym/history?limit=20');
                     const d = await r.json();
                     this.gymHistory = d.history || [];
                   } catch(e) {}
                 },
                 async loadGymConfig() {
                   try {
                     const r = await fetch('/api/soul-gym/config');
                     this.gymConfig = await r.json();
                   } catch(e) {}
                 },
                 async evolveAll(dryRun) {
                   this.gymLoading = true;
                   this.gymMessage = '';
                   try {
                     const r = await fetch('/api/soul-gym/evolve-all', {
                       method: 'POST',
                       headers: {'Content-Type':'application/json'},
                       body: JSON.stringify({dry_run: dryRun})
                     });
                     const d = await r.json();
                     this.gymMessage = d.message || (d.success ? '진화 시작됨' : '실패');
                     if (!dryRun) { setTimeout(() => { this.loadGymHistory(); this.loadGymStatus(); }, 5000); }
                   } catch(e) { this.gymMessage = '오류: ' + e.message; }
                   this.gymLoading = false;
                 },
                 init() { this.loadGymStatus(); this.loadGymHistory(); this.loadGymConfig(); }
               }">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-hq-text font-mono">SOUL GYM</h3>
                <p class="text-[10px] text-hq-muted">투자팀장 소울 경쟁 진화 (flash2.5 · 모의투자 · 자동 채택 · 매주 월요일 03:00)</p>
              </div>
              <div class="flex gap-2">
                <button @click="evolveAll(true)"
                        :disabled="gymLoading || gymStatus.running_all"
                        class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-hq-cyan/20 text-hq-cyan hover:bg-hq-cyan/30 transition disabled:opacity-50">
                  Dry Run
                </button>
                <button @click="evolveAll(false)"
                        :disabled="gymLoading || gymStatus.running_all"
                        class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-hq-green/20 text-hq-green hover:bg-hq-green/30 transition disabled:opacity-50">
                  <span x-show="!gymStatus.running_all">전체 진화</span>
                  <span x-show="gymStatus.running_all">진화 중...</span>
                </button>
              </div>
            </div>

            <!-- 상태/메시지 -->
            <div x-show="gymMessage" class="text-xs text-hq-cyan mb-2" x-text="gymMessage"></div>
            <div x-show="gymStatus.running_all" class="text-xs text-hq-yellow mb-2 animate-pulse">경쟁 진화 진행 중...</div>

            <!-- 설정 요약 -->
            <div class="flex gap-4 text-[10px] text-hq-muted mb-3 font-mono">
              <span>모델: <span class="text-hq-accent" x-text="gymConfig.gym_model || '-'"></span></span>
              <span>임계값: <span class="text-hq-accent" x-text="'+' + (gymConfig.min_improvement || 3) + '점'"></span></span>
              <span>비용캡: <span class="text-hq-accent" x-text="'$' + (gymConfig.cost_cap_usd || 20)"></span></span>
            </div>

            <!-- 진화 기록 테이블 -->
            <template x-if="gymHistory.length > 0">
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="text-hq-muted border-b border-hq-border/30">
                      <th class="text-left py-1.5 pr-3">에이전트</th>
                      <th class="text-center py-1.5 px-2">R</th>
                      <th class="text-center py-1.5 px-2">결과</th>
                      <th class="text-center py-1.5 px-2">점수</th>
                      <th class="text-center py-1.5 px-2">변화</th>
                      <th class="text-center py-1.5 px-2">비용</th>
                      <th class="text-right py-1.5 pl-2">날짜</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="h in gymHistory" :key="h.id">
                      <tr class="border-b border-hq-border/10 hover:bg-hq-accent/5">
                        <td class="py-1.5 pr-3 font-semibold text-hq-text" x-text="h.agent_name || h.agent_id"></td>
                        <td class="text-center py-1.5 px-2 font-mono text-hq-muted" x-text="'R' + h.round_num"></td>
                        <td class="text-center py-1.5 px-2">
                          <span x-show="h.winner !== 'original'" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-hq-green/20 text-hq-green" x-text="h.winner"></span>
                          <span x-show="h.winner === 'original'" class="px-1.5 py-0.5 rounded text-[10px] bg-hq-muted/10 text-hq-muted">유지</span>
                        </td>
                        <td class="text-center py-1.5 px-2 font-mono" x-text="h.score_before.toFixed(0) + '→' + h.score_after.toFixed(0)"></td>
                        <td class="text-center py-1.5 px-2 font-mono font-bold"
                            :class="h.improvement > 0 ? 'text-hq-green' : h.improvement < 0 ? 'text-hq-red' : 'text-hq-muted'"
                            x-text="(h.improvement > 0 ? '+' : '') + h.improvement.toFixed(0)"></td>
                        <td class="text-center py-1.5 px-2 font-mono text-hq-muted" x-text="'$' + h.cost_usd.toFixed(2)"></td>
                        <td class="text-right py-1.5 pl-2 text-[10px] text-hq-muted" x-text="h.created_at ? h.created_at.slice(5,16) : ''"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <template x-if="gymHistory.length === 0">
              <div class="text-center py-4 text-hq-muted/60 text-xs">아직 진화 기록이 없습니다. 첫 Dry Run을 실행해보세요.</div>
            </template>
          </div>

          <!-- 진화 실시간 로그 (N-4) -->
          <div class="mt-6 glass border border-hq-border rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-hq-text font-mono">EVOLUTION LOG</h3>
                <p class="text-[10px] text-hq-muted">진화 시스템 실시간 로그 — 텔레그램 알림 대신 웹에서 확인</p>
              </div>
              <button @click="loadEvolutionLogs()" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-hq-green/20 text-hq-green hover:bg-hq-green/30 transition">새로고침</button>
            </div>
            <div class="bg-hq-bg rounded-lg border border-hq-border/50 max-h-60 overflow-y-auto scrollbar-thin">
              <template x-if="evolutionLogs.length > 0">
                <div class="divide-y divide-hq-border/30">
                  <template x-for="(log, idx) in evolutionLogs" :key="idx">
                    <div class="px-3 py-2 flex items-start gap-2 text-xs hover:bg-hq-surface/30 transition">
                      <span class="font-mono text-hq-muted/70 shrink-0 w-12" x-text="log.time"></span>
                      <span class="w-1.5 h-1.5 rounded-full mt-1.5 shrink-0"
                            :class="log.level === 'error' ? 'bg-hq-red' : log.level === 'warning' ? 'bg-hq-yellow' : 'bg-hq-green'"></span>
                      <span class="text-hq-text/90 leading-relaxed" x-text="log.message"></span>
                    </div>
                  </template>
                </div>
              </template>
              <template x-if="evolutionLogs.length === 0">
                <div class="text-center py-6 text-hq-muted/60 text-xs">아직 진화 로그가 없습니다. Soul Gym이 실행되면 여기에 실시간으로 표시됩니다.</div>
              </template>
            </div>
          </div>

        </div>
      </div></template>

      <!-- ═══ Tab: 아키텍처 맵 (Architecture Map) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'archmap'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-6xl mx-auto fade-in-up">

          <!-- 헤더 -->
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-lg md:text-xl font-bold text-hq-text mb-1 font-mono tracking-normal">ARCHITECTURE MAP</h1>
              <p class="text-xs md:text-sm text-hq-muted">CORTHEX HQ 에이전트 조직도 · 실시간 상태 · 비용 분석</p>
            </div>
          </div>

          <!-- 이번 달 AI 비용 총액 (히어로 카드) -->
          <div class="glass border border-hq-accent/30 rounded-2xl p-6 mb-6 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-hq-accent/5 to-hq-purple/5"></div>
            <div class="relative flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
              <div>
                <div class="text-xs text-hq-muted uppercase tracking-wider mb-1" x-text="archMap.costSummary?.month_label || '이번 달'"></div>
                <div class="text-4xl md:text-5xl font-bold font-mono text-hq-accent" x-text="'$' + (archMap.costSummary?.monthly_cost_usd || 0).toFixed(2)"></div>
                <div class="text-xs text-hq-muted mt-1">AI 비용 총액</div>
              </div>
              <div class="flex gap-6">
                <div class="text-center">
                  <div class="text-lg font-bold font-mono text-hq-green" x-text="'$' + (archMap.costSummary?.today_cost_usd || 0).toFixed(4)"></div>
                  <div class="text-[10px] text-hq-muted">오늘</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold font-mono text-hq-cyan" x-text="'$' + (archMap.costSummary?.daily_avg_usd || 0).toFixed(4)"></div>
                  <div class="text-[10px] text-hq-muted">일 평균</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold font-mono text-hq-text" x-text="archMap.hierarchy?.total_agents || 0"></div>
                  <div class="text-[10px] text-hq-muted">에이전트</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 서브탭 -->
          <div class="flex gap-1 mb-4 border-b border-hq-border">
            <button @click="archMap.subTab = 'orgchart'; $nextTick(() => renderMermaidOrgChart())"
                    :class="archMap.subTab === 'orgchart' ? 'text-hq-accent border-hq-accent' : 'text-hq-muted border-transparent hover:text-hq-text'"
                    class="px-4 py-2 text-xs font-semibold border-b-2 transition">조직도</button>
            <button @click="archMap.subTab = 'status'"
                    :class="archMap.subTab === 'status' ? 'text-hq-accent border-hq-accent' : 'text-hq-muted border-transparent hover:text-hq-text'"
                    class="px-4 py-2 text-xs font-semibold border-b-2 transition">실시간 현황</button>
            <button @click="archMap.subTab = 'cost'; $nextTick(() => renderCostCharts())"
                    :class="archMap.subTab === 'cost' ? 'text-hq-accent border-hq-accent' : 'text-hq-muted border-transparent hover:text-hq-text'"
                    class="px-4 py-2 text-xs font-semibold border-b-2 transition">비용 분석</button>
          </div>

          <!-- 서브탭 1: 조직도 -->
          <div x-show="archMap.subTab === 'orgchart'" x-transition>
            <div class="glass border border-hq-border rounded-xl p-4 overflow-x-auto">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xs text-hq-muted">에이전트를 클릭하면 사령관실에서 직접 대화할 수 있습니다</span>
              </div>
              <div id="mermaid-orgchart" class="min-h-[400px] flex items-center justify-center">
                <template x-if="!archMap.mermaidRendered">
                  <div class="text-hq-muted text-sm animate-pulse">조직도 렌더링 중...</div>
                </template>
              </div>
            </div>
            <div class="flex flex-wrap gap-3 mt-3">
              <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full" style="background:#FF6B35"></div><span class="text-[10px] text-hq-muted">CEO</span></div>
              <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full" style="background:#FFD200"></div><span class="text-[10px] text-hq-muted">비서실</span></div>
              <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full" style="background:#00E6FF"></div><span class="text-[10px] text-hq-muted">LEET Master 본부</span></div>
              <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full" style="background:#8C64FF"></div><span class="text-[10px] text-hq-muted">투자분석 본부</span></div>
              <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full" style="background:#00FF88"></div><span class="text-[10px] text-hq-muted">출판기록 본부</span></div>
            </div>
          </div>

          <!-- 서브탭 2: 실시간 현황 -->
          <div x-show="archMap.subTab === 'status'" x-transition>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="dept in [
                {key:'secretary',label:'비서실',color:'hq-yellow',icon:'🏛️'},
                {key:'strategy',label:'사업기획팀장',color:'hq-cyan',icon:'📊'},
                {key:'legal',label:'법무팀장',color:'hq-cyan',icon:'⚖️'},
                {key:'marketing',label:'마케팅팀장',color:'hq-cyan',icon:'📢'},
                {key:'finance',label:'금융분석팀장',color:'hq-purple',icon:'💰'},
                {key:'publishing',label:'콘텐츠팀장',color:'hq-green',icon:'📚'},
              ]" :key="dept.key">
                <div class="glass border rounded-xl p-4" :class="'border-' + dept.color + '/20'">
                  <div class="flex items-center gap-2 mb-3">
                    <span x-text="dept.icon"></span>
                    <span class="text-sm font-bold" :class="'text-' + dept.color" x-text="dept.label"></span>
                    <span class="ml-auto text-[10px] px-2 py-0.5 rounded-full"
                          :class="getDeptWorkingCount(dept.key) > 0 ? 'bg-hq-green/20 text-hq-green' : 'bg-hq-border/50 text-hq-muted'"
                          x-text="getDeptWorkingCount(dept.key) > 0 ? getDeptWorkingCount(dept.key) + '명 작업중' : '대기중'"></span>
                  </div>
                  <div class="space-y-1.5">
                    <template x-for="aid in getDeptAgents(dept.key)" :key="aid">
                      <div class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-hq-panel/20 cursor-pointer transition"
                           @click="targetAgentId = aid; switchTab('command')">
                        <div class="w-2 h-2 rounded-full shrink-0"
                             :class="activeAgents[aid]?.status === 'working' ? 'bg-hq-green animate-pulse' : 'bg-hq-border'"></div>
                        <span class="text-xs text-hq-text truncate flex-1" x-text="agentNames[aid] || aid"></span>
                        <span class="text-[9px] text-hq-muted font-mono truncate max-w-[100px]" x-text="agentModels[aid] || ''"></span>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- 서브탭 3: 비용 분석 -->
          <div x-show="archMap.subTab === 'cost'" x-transition>
            <div class="flex gap-2 mb-4">
              <button @click="changeCostPeriod('today')"
                      :class="archMap.costPeriod === 'today' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-hq-muted border-hq-border hover:text-hq-text'"
                      class="px-3 py-1.5 text-xs rounded-lg border transition">오늘</button>
              <button @click="changeCostPeriod('month')"
                      :class="archMap.costPeriod === 'month' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-hq-muted border-hq-border hover:text-hq-text'"
                      class="px-3 py-1.5 text-xs rounded-lg border transition">이번 달</button>
              <button @click="changeCostPeriod('all')"
                      :class="archMap.costPeriod === 'all' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-hq-muted border-hq-border hover:text-hq-text'"
                      class="px-3 py-1.5 text-xs rounded-lg border transition">전체</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="glass border border-hq-border rounded-xl p-4">
                <h3 class="text-sm font-bold text-hq-text mb-3">부서별 비용 분포</h3>
                <div class="h-[280px]"><canvas id="division-cost-chart"></canvas></div>
              </div>
              <div class="glass border border-hq-border rounded-xl p-4">
                <h3 class="text-sm font-bold text-hq-text mb-3">에이전트별 비용 TOP 10</h3>
                <div class="h-[280px]"><canvas id="agent-cost-chart"></canvas></div>
              </div>
            </div>

            <div class="glass border border-hq-border rounded-xl overflow-x-auto mt-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-hq-border text-[11px] text-hq-muted uppercase">
                    <th class="text-left px-4 py-3">부서</th>
                    <th class="text-right px-4 py-3">비용</th>
                    <th class="text-right px-4 py-3">호출 수</th>
                    <th class="text-right px-4 py-3">에이전트</th>
                    <th class="px-4 py-3 w-32">비율</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="d in archMap.costByDivision" :key="d.division">
                    <tr class="border-b border-hq-border/50 hover:bg-hq-panel/20">
                      <td class="px-4 py-2.5 text-hq-text font-medium" x-text="d.label"></td>
                      <td class="text-right px-4 py-2.5 font-mono text-hq-green" x-text="'$' + (d.cost_usd || 0).toFixed(4)"></td>
                      <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="d.call_count"></td>
                      <td class="text-right px-4 py-2.5 font-mono text-hq-text" x-text="d.agent_count + '명'"></td>
                      <td class="px-4 py-2.5">
                        <div class="h-2 bg-hq-bg rounded-full overflow-hidden">
                          <div class="h-full bg-gradient-to-r from-hq-accent to-hq-cyan rounded-full transition-all"
                               :style="'width:' + (archMap.costByDivision.length > 0 && archMap.costByDivision[0].cost_usd > 0 ? Math.round(d.cost_usd / archMap.costByDivision[0].cost_usd * 100) : 0) + '%'"></div>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
              <template x-if="!archMap.costByDivision.length">
                <div class="text-center py-8 text-hq-muted/80 text-sm">비용 데이터가 없습니다. AI 작업을 실행하면 통계가 쌓입니다.</div>
              </template>
            </div>
          </div>

        </div>
      </div></template>

      <!-- ═══ Office View (가상 사무실) ═══ -->
      <div x-show="viewMode === 'office'" x-transition.opacity.duration.200ms class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto space-y-5 fade-in-up">

          <!-- CEO 사무실 (accent) -->
          <div class="office-room glass border border-hq-accent/20 bg-hq-accent/[0.04]">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-hq-accent border border-hq-accent/10">
              <span class="text-lg">⚡</span>
              <span class="text-sm font-bold text-hq-accent uppercase tracking-wider font-mono">COMMAND CENTER</span>
            </div>
            <div class="flex gap-3">
              <div class="desk-card glass border border-hq-accent/30 w-48 sm:w-[160px] cursor-pointer" @click="showCeoProfile = true">
                <div class="flex items-center justify-between mb-2">
                  <div class="agent-avatar bg-gradient-to-br from-hq-accent to-hq-purple text-white text-[10px]">CEO</div>
                  <div class="status-light status-light-working"></div>
                </div>
                <div class="text-sm font-semibold text-hq-text font-mono">CEO</div>
                <div class="text-[10px] text-hq-muted font-mono">COMMANDER (You)</div>
              </div>
            </div>
          </div>

          <!-- 참모진 — 팀장 6명 (단일 그리드) -->
          <div class="office-room glass border border-hq-border/40 bg-hq-surface/30">
            <div class="flex items-center gap-3 mb-3 px-3 py-2 rounded-lg border-l-[3px] border-l-hq-purple border border-hq-purple/10 bg-hq-purple/[0.04]">
              <span class="text-base">👥</span>
              <span class="text-xs font-bold text-hq-purple uppercase tracking-wider font-mono">CORTHEX STAFF — 팀장 6명</span>
              <span class="text-[10px] text-hq-muted ml-auto">v4.0</span>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              <template x-for="id in ['chief_of_staff','cio_manager','cso_manager','clo_manager','cmo_manager','cpo_manager']" :key="id">
                <div class="desk-card glass border border-hq-border hover:border-hq-purple/40 cursor-pointer p-3" @click="openAgentConfig(id)">
                  <div class="flex items-center justify-between mb-2">
                    <div class="agent-avatar text-[10px]"
                         :class="{'bg-amber-500/20 text-amber-400': id==='chief_of_staff', 'bg-red-500/20 text-red-400': id==='cio_manager', 'bg-purple-500/20 text-purple-400': id==='cso_manager', 'bg-emerald-500/20 text-emerald-400': id==='clo_manager', 'bg-orange-500/20 text-orange-400': id==='cmo_manager', 'bg-fuchsia-500/20 text-fuchsia-400': id==='cpo_manager'}"
                         x-text="getAgentInitials(id)"></div>
                    <div class="status-light" :class="getAgentStatusLight(id)"></div>
                  </div>
                  <div class="text-sm font-semibold text-hq-text truncate" x-text="getAgentName(id)"></div>
                  <div x-show="agentModels[id]" class="text-[10px] text-hq-cyan/70 font-mono truncate mt-0.5" x-text="getModelDisplayName(agentModels[id])"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- ARGOS — 서버 실행 시스템 (zinc) -->
          <div class="office-room glass border border-zinc-500/30 bg-zinc-500/[0.03]">
            <div class="flex items-center gap-3 mb-3 px-3 py-2.5 rounded-lg glass border-l-[3px] border-l-zinc-400 border border-zinc-500/20">
              <span class="text-lg">⚙️</span>
              <span class="text-sm font-bold text-zinc-400 uppercase tracking-wider font-mono">ARGOS — 서버 실행 시스템</span>
              <span class="text-[10px] text-hq-muted ml-auto font-mono">24H / 100 EYES</span>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 items-start">
              <!-- ARGOS 카드 -->
              <div class="desk-card glass border border-zinc-500/40 hover:border-zinc-400/60 w-full sm:w-[160px] shrink-0">
                <div class="flex items-center justify-between mb-2">
                  <div class="agent-avatar bg-zinc-700 text-zinc-300 text-[13px]">⚙</div>
                  <div class="status-light status-light-working"></div>
                </div>
                <div class="text-sm font-bold text-zinc-300 font-mono">ARGOS</div>
                <div class="text-[10px] text-zinc-500 font-mono">SYSTEM EXECUTOR</div>
                <div class="text-[10px] text-emerald-400/80 font-mono mt-1">Oracle ARM · 24/7</div>
              </div>
              <!-- 역할 설명 -->
              <div class="flex-1 text-[11px] text-hq-muted/80 space-y-1 pt-1">
                <div class="flex items-center gap-1.5"><span class="text-zinc-500">▸</span> 크론 스케줄 실행 (금융분석팀장 분석 · Soul Evolution)</div>
                <div class="flex items-center gap-1.5"><span class="text-zinc-500">▸</span> 노션 자동 저장 (비서실 · 에이전트 산출물)</div>
                <div class="flex items-center gap-1.5"><span class="text-zinc-500">▸</span> KIS API 매매 실행 · 포트폴리오 추적</div>
                <div class="flex items-center gap-1.5"><span class="text-zinc-500">▸</span> 텔레그램 알림 발송</div>
                <div class="flex items-center gap-1.5"><span class="text-zinc-500">▸</span> 웹소켓 · SSE 실시간 연결 유지</div>
                <div class="text-[10px] text-zinc-600 mt-2 font-mono italic">판단은 에이전트. 실행은 ARGOS. 잠들지 않는다.</div>
              </div>
            </div>
          </div>

          <p class="text-center text-[11px] text-hq-muted/80 mt-4">에이전트를 클릭하면 모델, 추론 정도, 소울(성격)을 확인할 수 있습니다</p>
        </div>
      </div>

      <!-- ═══ Dashboard View ═══ -->
      <div x-show="viewMode === 'dashboard'" x-transition.opacity.duration.200ms class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto fade-in-up">

          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-normal">DASHBOARD</h1>
              <p class="text-sm text-hq-muted">실시간 대시보드 — 30초 자동 갱신 · 상세 분석</p>
            </div>
            <button @click="loadDashboard()" class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-muted hover:text-hq-text transition flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              새로고침
            </button>
          </div>

          <!-- Loading -->
          <template x-if="!dashboard.loaded">
            <div class="flex items-center justify-center py-20">
              <div class="text-hq-muted flex items-center gap-2">
                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                대시보드 로딩 중...
              </div>
            </div>
          </template>

          <!-- Content -->
          <template x-if="dashboard.loaded">
            <div class="space-y-6">

              <!-- Summary Cards -->
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">오늘 작업</div>
                  <div class="text-2xl font-bold text-hq-text" x-text="dashboard.todayTasks"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">완료</div>
                  <div class="text-2xl font-bold text-hq-green" x-text="dashboard.todayCompleted"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">실패</div>
                  <div class="text-2xl font-bold text-hq-red" x-text="dashboard.todayFailed"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">진행중</div>
                  <div class="text-2xl font-bold text-hq-yellow" x-text="dashboard.runningCount"></div>
                </div>
              </div>

              <!-- Cost & Agent Info -->
              <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">총 비용</div>
                  <div class="text-lg font-bold text-hq-accent">$<span x-text="(dashboard.totalCost || 0).toFixed(2)"></span></div>
                  <div class="text-[10px] text-hq-muted mt-1" x-text="'AI 호출 ' + (dashboard.totalAiCalls || 0) + '회'"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">에이전트</div>
                  <div class="text-lg font-bold text-hq-cyan" x-text="(dashboard.agentCount || 0) + '명'"></div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-4">
                  <div class="text-xs text-hq-muted mb-1">시스템 상태</div>
                  <div class="flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" :class="dashboard.systemHealth === 'ok' ? 'bg-hq-green' : dashboard.systemHealth === 'busy' ? 'bg-hq-yellow animate-pulse' : 'bg-hq-red'"></span>
                    <span class="text-lg font-bold" :class="dashboard.systemHealth === 'ok' ? 'text-hq-green' : dashboard.systemHealth === 'busy' ? 'text-hq-yellow' : 'text-hq-red'" x-text="dashboard.systemHealth === 'ok' ? '정상' : dashboard.systemHealth === 'busy' ? '작업중' : '이상'"></span>
                  </div>
                </div>
              </div>

              <!-- Budget Section (항상 표시) -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <span class="text-hq-yellow">$</span> 예산 현황
                  </h3>
                  <button @click="showBudgetEdit = true; budgetEditDaily = budget.daily_limit || 0; budgetEditMonthly = budget.monthly_limit || 0"
                          class="text-xs text-hq-accent hover:text-hq-accent/80 px-2 py-1 border border-hq-accent/20 rounded-lg transition">한도 수정</button>
                </div>
                <!-- 한도 미설정 안내 -->
                <div x-show="!budget.daily_limit && !budget.monthly_limit" class="text-center py-4">
                  <div class="text-xs text-hq-muted mb-2">예산 한도가 설정되지 않았습니다</div>
                  <button @click="showBudgetEdit = true; budgetEditDaily = 10; budgetEditMonthly = 200"
                          class="text-xs bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-lg px-3 py-1.5 hover:bg-hq-accent/20 transition">한도 설정하기</button>
                </div>
                <div class="space-y-4" x-show="budget.daily_limit || budget.monthly_limit">
                  <!-- Daily Budget -->
                  <div x-show="budget.daily_limit">
                    <div class="flex justify-between text-xs mb-1.5">
                      <span class="text-hq-muted">일일 예산</span>
                      <span class="text-hq-text font-mono">$<span x-text="(budget.daily_used || 0).toFixed(2)"></span> / $<span x-text="(budget.daily_limit || 0).toFixed(2)"></span></span>
                    </div>
                    <div class="w-full bg-hq-bg rounded-full h-2.5">
                      <div class="h-2.5 rounded-full transition-all duration-500"
                           :class="(budget.daily_used / budget.daily_limit * 100) > 80 ? 'bg-hq-red' : 'bg-hq-green'"
                           :style="'width: ' + Math.min(100, (budget.daily_used || 0) / (budget.daily_limit || 1) * 100) + '%'"></div>
                    </div>
                  </div>
                  <!-- Monthly Budget -->
                  <div x-show="budget.monthly_limit">
                    <div class="flex justify-between text-xs mb-1.5">
                      <span class="text-hq-muted">월간 예산</span>
                      <span class="text-hq-text font-mono">$<span x-text="(budget.monthly_used || 0).toFixed(2)"></span> / $<span x-text="(budget.monthly_limit || 0).toFixed(2)"></span></span>
                    </div>
                    <div class="w-full bg-hq-bg rounded-full h-2.5">
                      <div class="h-2.5 rounded-full transition-all duration-500"
                           :class="(budget.monthly_used / budget.monthly_limit * 100) > 80 ? 'bg-hq-red' : 'bg-hq-accent'"
                           :style="'width: ' + Math.min(100, (budget.monthly_used || 0) / (budget.monthly_limit || 1) * 100) + '%'"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Model Mode Section -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <span class="text-hq-accent">&#9881;</span> AI 모델 변경
                  </h3>
                </div>

                <!-- 현재 팀장별 모델 현황 -->
                <div class="space-y-1.5 mb-4">
                  <template x-for="id in ['chief_of_staff','cio_manager','cso_manager','clo_manager','cmo_manager','cpo_manager']" :key="'model-'+id">
                    <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-hq-bg/50 border border-hq-border/30">
                      <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full shrink-0" :class="getAgentDotClass(id)"></span>
                        <span class="text-xs font-medium text-hq-text" x-text="getAgentName(id)"></span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-[10px] text-hq-cyan/70 font-mono" x-text="getModelDisplayName(agentModels[id])"></span>
                        <span x-show="agentReasonings[id]" class="text-[9px] px-1.5 py-0.5 rounded border"
                              :class="agentReasonings[id]==='low' ? 'border-hq-green/30 text-hq-green' : agentReasonings[id]==='medium' ? 'border-hq-yellow/30 text-hq-yellow' : agentReasonings[id]==='high' ? 'border-hq-purple/30 text-hq-purple' : 'border-hq-border text-hq-muted'"
                              x-text="agentReasonings[id]"></span>
                      </div>
                    </div>
                  </template>
                </div>

                <div class="flex gap-1.5 mb-3">
                  <button @click="modelMode = 'auto'; saveModelMode()"
                          :class="modelMode === 'auto' ? 'bg-hq-accent text-white' : 'bg-hq-bg text-hq-muted border border-hq-border'"
                          class="flex-1 text-xs font-bold px-3 py-2 rounded-lg transition">
                    자동
                  </button>
                  <button @click="applyRecommendedModels()"
                          :class="modelMode === 'recommended' ? 'bg-hq-green text-white' : 'bg-hq-bg text-hq-muted border border-hq-border'"
                          class="flex-1 text-xs font-bold px-3 py-2 rounded-lg transition">
                    권장
                  </button>
                  <button @click="modelMode = 'manual'; saveModelMode()"
                          :class="modelMode === 'manual' ? 'bg-hq-accent text-white' : 'bg-hq-bg text-hq-muted border border-hq-border'"
                          class="flex-1 text-xs font-bold px-3 py-2 rounded-lg transition">
                    수동
                  </button>
                </div>
                <div x-show="modelMode === 'auto'" class="text-[10px] text-hq-muted">
                  질문 길이/내용에 따라 Haiku(저비용) 또는 Sonnet(고품질) 자동 선택
                </div>
                <div x-show="modelMode === 'manual'" class="mt-1">
                  <div class="text-[10px] text-hq-muted">각 에이전트에 개별 지정된 모델을 사용합니다</div>
                  <div class="text-[10px] text-hq-accent mt-1">에이전트 클릭 → 모델 탭에서 개별 변경 가능</div>
                </div>

                <!-- 전체 모델 일괄 변경 -->
                <div class="border-t border-hq-border mt-4 pt-4">
                  <div class="text-[11px] font-bold text-hq-text mb-2">전체 에이전트 모델 일괄 변경</div>
                  <div class="text-[10px] text-hq-muted mb-3">팀장 6명의 모델과 추론 정도를 한번에 바꿉니다</div>
                  <!-- 모델 선택 -->
                  <select x-model="bulkModelSelection"
                          @change="bulkReasoningOptions = _getDefaultReasoning(bulkModelSelection); bulkReasoningSelection = ''"
                          class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text mb-2">
                    <option value="">모델 선택...</option>
                    <template x-for="[provLabel, models] of Object.entries(getModelsByProvider())" :key="provLabel">
                      <optgroup :label="provLabel">
                        <template x-for="m in models" :key="m.name">
                          <option :value="m.name" x-text="getModelDisplayName(m.name)"></option>
                        </template>
                      </optgroup>
                    </template>
                  </select>
                  <!-- 추론 정도 -->
                  <div x-show="bulkReasoningOptions.length > 0" class="flex flex-wrap gap-1.5 mb-3">
                    <button @click="bulkReasoningSelection = ''"
                            :class="!bulkReasoningSelection ? 'bg-hq-accent/20 text-hq-accent border-hq-accent' : 'text-hq-muted border-hq-border'"
                            class="text-[10px] border rounded-md px-2 py-1 transition">기본</button>
                    <template x-for="lv in bulkReasoningOptions" :key="lv">
                      <button @click="bulkReasoningSelection = lv"
                              :class="bulkReasoningSelection === lv
                                ? (lv === 'none' ? 'bg-hq-muted/20 text-hq-muted border-hq-muted'
                                  : lv === 'low' ? 'bg-hq-green/20 text-hq-green border-hq-green'
                                  : lv === 'medium' ? 'bg-hq-yellow/20 text-hq-yellow border-hq-yellow'
                                  : lv === 'high' ? 'bg-hq-purple/20 text-hq-purple border-hq-purple'
                                  : 'bg-hq-red/20 text-hq-red border-hq-red')
                                : 'text-hq-muted border-hq-border'"
                              class="text-[10px] border rounded-md px-2 py-1 transition"
                              x-text="({'none':'⛔ none','low':'⚡ low','medium':'🧠 medium','high':'🔬 high','xhigh':'🔥 xhigh'})[lv] || lv"></button>
                    </template>
                  </div>
                  <!-- 적용 버튼 -->
                  <button @click="applyBulkModel()"
                          :disabled="!bulkModelSelection || bulkModelSaving"
                          :class="bulkModelSelection ? 'bg-hq-accent hover:bg-blue-600 text-white' : 'bg-hq-bg text-hq-muted cursor-not-allowed border border-hq-border'"
                          class="w-full text-xs font-bold px-3 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                    <span x-show="bulkModelSaving" class="animate-spin">&#8987;</span>
                    <span x-text="bulkModelSaving ? '변경 중...' : '6명 전체 적용'"></span>
                  </button>

                  <!-- 기본값 저장/복원 -->
                  <div class="border-t border-hq-border mt-3 pt-3 flex gap-2">
                    <button @click="saveAgentDefaults()"
                            class="flex-1 text-[10px] font-bold bg-hq-bg border border-hq-border text-hq-text hover:border-hq-accent rounded-lg px-2 py-1.5 transition">
                      현재를 기본값으로 저장
                    </button>
                    <button @click="restoreAgentDefaults()"
                            class="flex-1 text-[10px] font-bold bg-hq-bg border border-hq-border text-hq-muted hover:border-hq-yellow rounded-lg px-2 py-1.5 transition">
                      기본값 복원
                    </button>
                  </div>
                </div>
              </div>

              <!-- Quality Section -->
              <div class="glass border border-hq-border rounded-xl p-5" x-show="quality && quality.total_reviews">
                <h3 class="text-sm font-bold text-hq-text mb-4 flex items-center gap-2">
                  <span class="text-hq-green">&#10003;</span> 품질 검수
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div class="text-center">
                    <div class="text-2xl font-bold" :class="(quality.pass_rate || 0) >= 80 ? 'text-hq-green' : 'text-hq-yellow'" x-text="(quality.pass_rate || 0).toFixed(0) + '%'"></div>
                    <div class="text-[10px] text-hq-muted">합격률</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-hq-text" x-text="quality.total_reviews || 0"></div>
                    <div class="text-[10px] text-hq-muted">총 검수</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-hq-red" x-text="quality.failed || 0"></div>
                    <div class="text-[10px] text-hq-muted">불합격</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold" :class="getQualityBadge(quality.average_score).cls.split(' ').filter(c => c.startsWith('text-'))[0] || 'text-hq-text'" x-text="(quality.average_score || 0).toFixed(1)"></div>
                    <div class="text-[10px] text-hq-muted">평균 (1~5)</div>
                  </div>
                </div>
              </div>

              <!-- Deploy Status (배포 현황) -->
              <div class="glass border border-hq-border rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                    <svg class="w-4 h-4 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                    배포 현황
                  </h3>
                  <div class="flex items-center gap-2">
                    <button @click="loadDeployStatus()" class="text-[10px] text-hq-muted hover:text-hq-text transition">새로고침</button>
                    <a href="https://github.com/kodonghui/CORTHEX_HQ/actions" target="_blank"
                       class="text-[10px] text-hq-accent hover:underline">GitHub Actions ↗</a>
                  </div>
                </div>

                <!-- 배포 상태 카드 (정렬 통일) -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 2h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 8.172V3L8 2z"/></svg>
                      현재 빌드
                    </div>
                    <div class="text-base font-bold font-mono" :class="deployStatus.status === 'success' ? 'text-hq-green' : 'text-hq-red'" x-text="deployStatus.build ? '#' + deployStatus.build : '-'"></div>
                  </div>
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
                      서버 상태
                    </div>
                    <div class="text-base font-bold" :class="deployStatus.status === 'success' ? 'text-hq-green' : deployStatus.status === 'loading' ? 'text-hq-yellow' : 'text-hq-red'"
                         x-text="deployStatus.status === 'success' ? '정상' : deployStatus.status === 'loading' ? '확인중...' : '확인 불가'"></div>
                  </div>
                  <div class="bg-hq-panel rounded-lg p-3 min-h-[76px] flex flex-col items-center justify-center">
                    <div class="text-[10px] text-hq-muted mb-1.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                      마지막 배포
                    </div>
                    <div class="text-base font-bold text-hq-text" x-text="deployStatus.time ? new Date(deployStatus.time).toLocaleString('ko-KR', {timeZone:'Asia/Seoul', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '-'"></div>
                  </div>
                </div>

                <!-- 최근 배포 로그 -->
                <div class="space-y-2" x-show="deployLogs.length > 0">
                  <div class="text-[10px] text-hq-muted font-bold uppercase tracking-wider mb-2">최근 배포 기록</div>
                  <template x-for="log in deployLogs" :key="log.id">
                    <div class="flex items-center gap-3 p-2 rounded-lg bg-hq-bg border border-hq-border/30">
                      <span class="w-2 h-2 rounded-full shrink-0" :class="log.conclusion === 'success' ? 'bg-hq-green' : log.conclusion === 'failure' ? 'bg-hq-red' : 'bg-hq-yellow'"></span>
                      <div class="flex-1 min-w-0">
                        <div class="text-xs text-hq-text truncate" x-text="'#' + log.number + ' — ' + log.title"></div>
                        <div class="text-[10px] text-hq-muted" x-text="new Date(log.time).toLocaleString('ko-KR', {timeZone:'Asia/Seoul', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})"></div>
                      </div>
                      <span class="text-[10px] shrink-0" :class="log.conclusion === 'success' ? 'text-hq-green' : 'text-hq-red'" x-text="log.conclusion === 'success' ? '성공' : '실패'"></span>
                    </div>
                  </template>
                </div>
                <div x-show="deployLogs.length === 0 && deployStatus.status !== 'loading'" class="text-center py-3">
                  <div class="text-xs text-hq-muted">배포 기록을 불러올 수 없습니다</div>
                  <div class="text-[10px] text-hq-muted mt-1">서버 연결 상태를 확인해주세요</div>
                </div>
              </div>

              <!-- Recent Completed -->
              <div class="glass border border-hq-border rounded-xl p-5" x-show="dashboard.recentCompleted && dashboard.recentCompleted.length > 0">
                <h3 class="text-sm font-bold text-hq-text mb-4">최근 완료 작업</h3>
                <div class="space-y-2">
                  <template x-for="task in dashboard.recentCompleted.slice(0, 8)" :key="task.task_id">
                    <div class="flex items-center gap-3 p-2.5 bg-hq-panel rounded-lg">
                      <span class="w-2 h-2 rounded-full bg-hq-green shrink-0"></span>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm text-hq-text truncate" x-text="task.command || task.task_id"></div>
                      </div>
                      <span class="text-[10px] text-hq-muted shrink-0" x-text="task.time_seconds ? task.time_seconds.toFixed(1) + '초' : ''"></span>
                    </div>
                  </template>
                </div>
              </div>

            </div>
          </template>

        </div>
      </div>

      <!-- ═══ Tab: 작업내역 (History) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'history'"><div class="flex-1 flex flex-col overflow-hidden">
        <div class="px-4 md:px-6 pt-4 md:pt-5 pb-3 shrink-0 border-b border-hq-border bg-hq-surface">
          <!-- 통계 카드 (아이콘 + 색상 강화) -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-5xl mx-auto mb-4">
            <!-- 전체 작업 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-accent rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-accent/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-text" x-text="taskHistory.items?.length || 0"></div>
                <div class="text-[10px] text-hq-muted">전체 작업</div>
              </div>
            </div>
            <!-- 완료 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-green rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-green/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-green" x-text="(taskHistory.items || []).filter(t => t.status === 'completed').length"></div>
                <div class="text-[10px] text-hq-muted">완료</div>
              </div>
            </div>
            <!-- 실패 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-red rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-red/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-red" x-text="(taskHistory.items || []).filter(t => t.status === 'failed').length"></div>
                <div class="text-[10px] text-hq-muted">실패</div>
              </div>
            </div>
            <!-- 총 비용 -->
            <div class="bg-hq-panel border border-hq-border/50 rounded-lg px-4 py-3 flex items-center gap-3 relative overflow-hidden">
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-hq-cyan rounded-l-lg"></div>
              <div class="w-9 h-9 rounded-lg bg-hq-cyan/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-hq-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </div>
              <div>
                <div class="text-xl font-bold text-hq-cyan" x-text="'$' + ((taskHistory.items || []).reduce((s, t) => s + (t.cost || 0), 0)).toFixed(2)"></div>
                <div class="text-[10px] text-hq-muted">총 비용</div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 md:gap-3 max-w-5xl mx-auto flex-wrap">
            <!-- 전체 선택 체크박스 -->
            <button @click="toggleSelectAll()"
                    class="w-[18px] h-[18px] rounded border-2 flex items-center justify-center shrink-0 transition-all duration-150 cursor-pointer"
                    :class="isAllSelected() ? 'border-hq-accent bg-hq-accent text-white' : taskHistory.selectedIds.length > 0 ? 'border-hq-accent/50 bg-hq-accent/20 text-hq-accent' : 'border-hq-muted/30 hover:border-hq-accent/50 bg-transparent'"
                    title="전체 선택">
              <svg x-show="isAllSelected()" class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              <svg x-show="taskHistory.selectedIds.length > 0 && !isAllSelected()" class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14"/></svg>
            </button>
            <!-- Search -->
            <div class="flex-1 relative">
              <svg class="w-4 h-4 text-hq-muted absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              <input type="text" x-model="taskHistory.search" @input.debounce.300ms="loadTaskHistory()"
                     placeholder="작업 검색..."
                     class="w-full bg-hq-bg border border-hq-border rounded-lg pl-9 pr-4 py-2 text-sm text-hq-text placeholder-hq-muted/70 focus:outline-none focus:border-hq-accent/50">
            </div>
            <!-- Status Filter (커스텀 드롭다운) -->
            <div class="relative" x-data="{ filterOpen: false }">
              <button @click="filterOpen = !filterOpen" @click.outside="filterOpen = false"
                      class="flex items-center gap-2 bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text hover:border-hq-accent/40 transition min-w-[110px]">
                <span x-text="({'all':'전체','completed':'완료','failed':'실패','running':'진행중','archived':'보관'})[taskHistory.filterStatus] || '전체'"></span>
                <svg class="w-3.5 h-3.5 text-hq-muted ml-auto transition-transform" :class="filterOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div x-show="filterOpen" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0 -translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                   class="absolute top-full left-0 mt-1 w-full bg-hq-surface border border-hq-border rounded-lg shadow-xl z-50 overflow-hidden py-1">
                <template x-for="opt in [{v:'all',l:'전체'},{v:'completed',l:'완료'},{v:'failed',l:'실패'},{v:'running',l:'진행중'},{v:'archived',l:'보관'}]" :key="opt.v">
                  <button @click="taskHistory.filterStatus = opt.v; filterOpen = false; loadTaskHistory()"
                          class="w-full text-left px-3 py-1.5 text-sm transition"
                          :class="taskHistory.filterStatus === opt.v ? 'text-hq-accent bg-hq-accent/10 font-semibold' : 'text-hq-text hover:bg-hq-panel'">
                    <span x-text="opt.l"></span>
                    <svg x-show="taskHistory.filterStatus === opt.v" class="w-3.5 h-3.5 inline ml-1 text-hq-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                  </button>
                </template>
              </div>
            </div>
            <!-- Bookmark Filter -->
            <button @click="taskHistory.bookmarkOnly = !taskHistory.bookmarkOnly; loadTaskHistory()"
                    :class="taskHistory.bookmarkOnly ? 'text-hq-yellow border-hq-yellow/30' : 'text-hq-muted border-hq-border'"
                    class="border rounded-lg px-3 py-2 text-sm transition hover:text-hq-yellow">
              &#9733;
            </button>
          </div>
          <!-- 멀티셀렉트 액션바 (선택 시 표시) -->
          <div x-show="taskHistory.selectedIds.length > 0"
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0 -translate-y-2"
               x-transition:enter-end="opacity-100 translate-y-0"
               class="flex items-center gap-2 md:gap-3 max-w-5xl mx-auto mt-3 px-3 md:px-4 py-2.5 rounded-xl bg-hq-accent/10 border border-hq-accent/20 flex-wrap">
            <!-- 전체 선택 토글 -->
            <button @click="selectAllTasks()"
                    class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all duration-200 cursor-pointer shrink-0"
                    :class="taskHistory.selectedIds.length === taskHistory.items.length ? 'border-hq-accent bg-hq-accent text-white' : 'border-hq-accent/50 hover:border-hq-accent'"
                    title="전체 선택/해제">
              <svg x-show="taskHistory.selectedIds.length === taskHistory.items.length" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
            </button>
            <span class="text-sm font-bold text-hq-accent">
              <span x-text="taskHistory.selectedIds.length"></span>개 선택됨
            </span>
            <div class="flex items-center gap-2 ml-auto">
              <button @click="bulkBookmark()"
                      class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-hq-yellow/10 text-hq-yellow border border-hq-yellow/20 hover:bg-hq-yellow/20 transition">
                &#9733; 북마크
              </button>
              <button @click="bulkTag()"
                      class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-hq-cyan/10 text-hq-cyan border border-hq-cyan/20 hover:bg-hq-cyan/20 transition">
                # 태그
              </button>
              <button @click="bulkArchive()"
                      class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-hq-muted/10 text-hq-muted border border-hq-muted/20 hover:bg-hq-muted/20 transition">
                보관
              </button>
              <button @click="bulkDelete()"
                      class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-hq-red/10 text-hq-red border border-hq-red/20 hover:bg-hq-red/20 transition">
                삭제
              </button>
              <button @click="taskHistory.selectedIds = []"
                      class="px-3 py-1.5 rounded-lg text-xs text-hq-muted hover:text-hq-text transition">
                선택 해제
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
          <div class="max-w-5xl mx-auto space-y-2">
            <!-- 로딩 표시 -->
            <div x-show="taskHistory.loading" class="flex items-center justify-center py-12">
              <div class="flex items-center gap-3 text-hq-muted">
                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                <span class="text-sm">작업 기록을 불러오는 중...</span>
              </div>
            </div>
            <!-- 에러 표시 -->
            <div x-show="taskHistory.error && !taskHistory.loading" class="mb-3 flex items-center gap-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-4 py-2 text-xs text-hq-red">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              <span x-text="taskHistory.error"></span>
              <button @click="loadTaskHistory()" class="ml-auto underline hover:text-hq-text">다시 시도</button>
            </div>
            <!-- 샘플 데이터 배너 -->
            <div x-show="taskHistory.isSample && !taskHistory.loading" class="mb-3 flex items-center gap-2 bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-4 py-2 text-xs text-hq-yellow">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              미리보기용 샘플 데이터입니다 — 실제 명령을 내리면 진짜 기록으로 대체됩니다
            </div>
            <!-- ═══ 노션 스타일 작전일지 카드 뷰 ═══ -->
            <template x-for="(group, gi) in getGroupedTaskHistory()" :key="group.label">
              <div class="mb-8">
                <!-- 날짜 구분선 -->
                <div class="flex items-center gap-3 mb-4 py-1">
                  <div class="w-2 h-2 rounded-full shrink-0"
                       :class="gi === 0 ? 'bg-hq-accent ring-2 ring-hq-accent/30' : 'bg-hq-muted/40'"></div>
                  <h3 class="text-xs font-bold tracking-wider shrink-0 font-title"
                      :class="gi === 0 ? 'text-hq-accent' : 'text-hq-muted'" x-text="group.label"></h3>
                  <div class="flex-1 h-px bg-hq-border/15"></div>
                  <span class="text-[10px] px-2 py-0.5 rounded-full shrink-0"
                        :class="gi === 0 ? 'text-hq-accent bg-hq-accent/8' : 'text-hq-muted/70 bg-hq-surface/50'"
                        x-text="group.items.length + '건'"></span>
                </div>
                <!-- 카드 리스트 -->
                <div class="space-y-3">
                  <template x-for="task in group.items" :key="task.task_id">
                    <div class="bg-hq-panel/50 border rounded-2xl overflow-hidden transition-all duration-200 hover:bg-hq-panel/80 hover:shadow-lg hover:shadow-hq-bg/40"
                         :class="taskHistory.selectedIds.includes(task.task_id) ? 'border-hq-accent/40 ring-1 ring-hq-accent/20' : 'border-hq-border/20'">
                      <!-- 상단 컬러 인디케이터 (부서별 색상, 실패/진행중은 상태색) -->
                      <div class="h-[3px]"
                           :class="task.status === 'failed' ? 'bg-hq-red/60' : task.status === 'running' ? 'bg-hq-yellow/60 animate-pulse' : getTaskColorBarClass(task)"></div>
                      <div class="p-5">
                        <!-- 1행: 체크박스 + 상태 + 명령어 (큰 글씨) + 시간 -->
                        <div class="flex items-start gap-3">
                          <!-- Gmail 스타일 체크박스 -->
                          <button @click.stop="toggleTaskSelect(task.task_id)"
                                  class="w-[18px] h-[18px] rounded border-2 flex items-center justify-center shrink-0 mt-0.5 transition-all duration-150 cursor-pointer"
                                  :class="taskHistory.selectedIds.includes(task.task_id) ? 'border-hq-accent bg-hq-accent text-white' : 'border-hq-muted/25 hover:border-hq-accent/50 bg-transparent'"
                                  title="선택">
                            <svg x-show="taskHistory.selectedIds.includes(task.task_id)" class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                          </button>
                          <!-- 상태 도트 -->
                          <div class="w-3 h-3 rounded-full shrink-0 mt-1 cursor-pointer"
                               @click="taskHistory.expandedId = taskHistory.expandedId === task.task_id ? null : task.task_id; if(taskHistory.expandedId === task.task_id) loadTaskDetail(task.task_id)"
                               :class="task.status === 'completed' ? 'bg-hq-green' : task.status === 'failed' ? 'bg-hq-red' : task.status === 'running' ? 'bg-hq-yellow animate-pulse' : 'bg-hq-muted/40'"></div>
                          <!-- 명령어 (주인공) -->
                          <div class="flex-1 min-w-0 cursor-pointer"
                               @click="taskHistory.expandedId = taskHistory.expandedId === task.task_id ? null : task.task_id; if(taskHistory.expandedId === task.task_id) loadTaskDetail(task.task_id)">
                            <div class="text-[15px] font-semibold text-hq-text leading-snug line-clamp-1" x-text="task.summary ? stripMarkdown(task.summary) : task.command"></div>
                            <div x-show="task.summary" class="text-xs text-hq-muted/60 line-clamp-1 mt-0.5" x-text="task.command"></div>
                          </div>
                          <!-- 시간 (오른쪽) -->
                          <span class="text-xs text-hq-muted/60 font-mono shrink-0 pt-0.5"
                                x-text="new Date(task.created_at || Date.now()).toLocaleTimeString('ko-KR', {timeZone:'Asia/Seoul', hour:'2-digit', minute:'2-digit'})"></span>
                        </div>

                        <!-- 3행: 메타 정보 (ID + 태그 + 비용 + 소요시간 + 상태 뱃지) -->
                        <div class="flex items-center gap-2 mt-3 ml-6 flex-wrap">
                          <!-- D-6: 보고서 ID + 버전 -->
                          <span class="text-[9px] font-mono text-hq-muted/40 bg-hq-bg/50 px-1.5 py-0.5 rounded"
                                x-text="'#' + (task.task_id || '').slice(0, 8) + (task.version > 1 ? ' v' + task.version : '')"
                                :title="task.task_id + (task.parent_task_id ? ' ← ' + task.parent_task_id : '')"></span>
                          <!-- 반려된 섹션 표시 -->
                          <span x-show="task.rejected_sections && task.rejected_sections.length"
                                class="text-[9px] font-mono text-hq-red/60 bg-hq-red/8 px-1.5 py-0.5 rounded"
                                x-text="'반려§' + (task.rejected_sections || []).join(',')"></span>
                          <!-- 상태 뱃지 -->
                          <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                                :class="task.status === 'completed' ? 'bg-hq-green/12 text-hq-green' : task.status === 'failed' ? 'bg-hq-red/12 text-hq-red' : task.status === 'running' ? 'bg-hq-yellow/12 text-hq-yellow' : 'bg-hq-muted/12 text-hq-muted'"
                                x-text="task.status === 'completed' ? '완료' : task.status === 'failed' ? '실패' : task.status === 'running' ? '진행중' : '대기'"></span>
                          <!-- 태그들 -->
                          <template x-for="tag in (task.tags || []).slice(0,3)" :key="tag">
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-hq-accent/8 text-hq-accent font-medium" x-text="'#' + tag"></span>
                          </template>
                          <!-- 구분점 -->
                          <span x-show="task.cost || task.time_seconds" class="text-hq-muted/30 text-[10px]">&middot;</span>
                          <!-- 비용 -->
                          <span x-show="task.cost" class="text-[11px] font-mono"
                                :class="task.cost > 0.1 ? 'text-hq-yellow' : 'text-hq-muted/60'"
                                x-text="task.cost ? '$' + task.cost.toFixed(4) : ''"></span>
                          <!-- 소요시간 -->
                          <span x-show="task.time_seconds" class="text-[11px] text-hq-muted/60"
                                x-text="task.time_seconds ? task.time_seconds + '초' : ''"></span>
                        </div>

                        <!-- 4행: 액션 버튼 (항상 보임) -->
                        <div class="flex items-center gap-2 mt-3 ml-6">
                          <!-- 결과 보기 버튼 -->
                          <button @click="taskHistory.expandedId = taskHistory.expandedId === task.task_id ? null : task.task_id; if(taskHistory.expandedId === task.task_id) loadTaskDetail(task.task_id)"
                                  class="text-[11px] px-3 py-1 rounded-lg transition flex items-center gap-1"
                                  :class="taskHistory.expandedId === task.task_id ? 'bg-hq-accent/15 text-hq-accent' : 'bg-hq-bg/50 text-hq-muted/70 hover:text-hq-accent hover:bg-hq-accent/10'">
                            <svg class="w-3.5 h-3.5 transition-transform" :class="taskHistory.expandedId === task.task_id ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            <span x-text="taskHistory.expandedId === task.task_id ? '접기' : '결과 보기'"></span>
                          </button>
                          <!-- 내부 대화 버튼 (correlation_id 있을 때만) -->
                          <button x-show="task.correlation_id"
                                  @click.stop="loadReplay(task.correlation_id, task.task_id)"
                                  class="text-[11px] px-3 py-1 rounded-lg bg-hq-bg/50 text-hq-muted/70 hover:text-hq-accent hover:bg-hq-accent/10 transition flex items-center gap-1">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            내부 대화
                          </button>
                          <!-- 스페이서 -->
                          <div class="flex-1"></div>
                          <!-- 북마크 -->
                          <button @click.stop="toggleBookmark(task.task_id)"
                                  class="w-7 h-7 rounded-lg flex items-center justify-center text-sm transition"
                                  :class="task.bookmarked ? 'text-hq-yellow bg-hq-yellow/10' : 'text-hq-muted/40 hover:text-hq-yellow hover:bg-hq-yellow/5'"
                                  title="북마크">&#9733;</button>
                          <!-- 삭제 -->
                          <button @click.stop="deleteTask(task.task_id)"
                                  class="w-8 h-8 rounded-lg flex items-center justify-center text-hq-muted/30 hover:text-hq-red hover:bg-hq-red/8 transition"
                                  title="삭제">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                          </button>
                        </div>

                        <!-- 펼침: 상세 결과 -->
                        <div x-show="taskHistory.expandedId === task.task_id"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 -translate-y-1"
                             x-transition:enter-end="opacity-100 translate-y-0"
                             class="mt-4 pt-4 border-t border-hq-border/15 ml-6">
                          <div class="text-sm markdown-body max-h-[500px] overflow-y-auto rounded-xl bg-hq-bg/40 p-4 border border-hq-border/10"
                               x-html="renderMarkdown(task._fullResult || '')"></div>
                          <!-- 에이전트 간 대화 흐름 (리플레이) -->
                          <div x-show="taskHistory.replayData[task.task_id]"
                               class="mt-3 pl-4 border-l-2 border-hq-accent/20 rounded-r-lg bg-hq-bg/20 p-3">
                            <div class="text-xs text-hq-muted mb-2 font-semibold">에이전트 간 대화 흐름</div>
                            <div x-html="renderReplayTree(taskHistory.replayData[task.task_id])"></div>
                          </div>
                          <!-- N-9: 섹션 반려/재작성 -->
                          <div x-show="task.status === 'completed'" class="mt-3 flex items-center gap-2 flex-wrap">
                            <button @click="task._rewriteOpen = !task._rewriteOpen"
                                    class="text-[10px] px-2.5 py-1 rounded-lg bg-hq-red/10 text-hq-red/70 hover:bg-hq-red/20 transition flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                              섹션 반려
                            </button>
                            <span x-show="task.parent_task_id" class="text-[9px] text-hq-muted/50 font-mono">
                              원본: #<span x-text="(task.parent_task_id || '').slice(0,8)"></span>
                            </span>
                          </div>
                          <!-- 반려 입력 폼 -->
                          <div x-show="task._rewriteOpen" x-transition class="mt-2 p-3 bg-hq-surface/50 border border-hq-border/20 rounded-xl space-y-2">
                            <div class="text-[10px] text-hq-muted font-semibold">반려할 섹션 번호 (쉼표 구분)</div>
                            <input type="text" x-model="task._rewriteSections"
                                   placeholder="예: 1, 3, 5"
                                   class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text placeholder-hq-muted/40 focus:border-hq-accent outline-none">
                            <input type="text" x-model="task._rewriteFeedback"
                                   placeholder="피드백 (선택)"
                                   class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text placeholder-hq-muted/40 focus:border-hq-accent outline-none">
                            <button @click="requestRewrite(task.task_id, task._rewriteSections, task._rewriteFeedback)"
                                    class="text-[10px] px-3 py-1.5 rounded-lg bg-hq-red/20 text-hq-red hover:bg-hq-red/30 transition font-semibold">
                              재작성 요청
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <!-- 더 보기 버튼 -->
            <div x-show="hasMoreTasks()" class="text-center py-4">
              <button @click="loadMoreTasks()"
                      class="text-xs text-hq-accent hover:text-hq-accent/80 bg-hq-accent/10 border border-hq-accent/20 rounded-lg px-6 py-2 transition">
                더 보기 (<span x-text="taskHistory.items.length - taskHistoryPage * taskHistoryPageSize"></span>건 남음)
              </button>
            </div>
            <template x-if="!taskHistory.items || taskHistory.items.length === 0">
              <div class="text-center py-16 relative">
                <!-- 플로팅 일러스트 -->
                <div class="relative inline-block mb-6">
                  <div class="float-anim">
                    <svg class="w-20 h-20 mx-auto text-hq-accent/40" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                      <rect x="2" y="3" width="20" height="14" rx="2"/>
                      <path d="M8 21h8M12 17v4"/>
                      <circle cx="12" cy="10" r="2" fill="currentColor" opacity="0.3"/>
                    </svg>
                  </div>
                  <!-- 장식 도트 -->
                  <div class="absolute -top-2 -right-2 w-3 h-3 rounded-full bg-hq-green/30 float-anim" style="animation-delay:0.5s"></div>
                  <div class="absolute -bottom-1 -left-3 w-2 h-2 rounded-full bg-hq-accent/30 float-anim" style="animation-delay:1s"></div>
                  <div class="absolute top-1/2 -right-5 w-2 h-2 rounded-full bg-hq-yellow/30 float-anim" style="animation-delay:1.5s"></div>
                </div>
                <div class="text-base font-semibold text-hq-text mb-1">에이전트 대기 중</div>
                <div class="text-xs text-hq-muted/70 mb-6">명령을 내리면 작전 기록이 쌓입니다</div>
                <!-- 빠른 명령 버튼 — 일일 루틴 -->
                <div class="text-[9px] text-hq-muted/60 uppercase tracking-wider mb-2">일일 루틴</div>
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                  <button @click="inputText='전 부서 현황 보고'; activeTab='command'"
                          class="text-xs bg-hq-cyan/10 text-hq-cyan border border-hq-cyan/20 rounded-full px-4 py-1.5 hover:bg-hq-cyan/20 transition">
                    🏢 전 부서 현황
                  </button>
                  <button @click="inputText='오늘 일정 및 예약 현황 보고'; activeTab='command'"
                          class="text-xs bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-full px-4 py-1.5 hover:bg-hq-accent/20 transition">
                    📅 오늘 일정
                  </button>
                  <button @click="inputText='예산 사용 현황 보고'; activeTab='command'"
                          class="text-xs bg-hq-yellow/10 text-hq-yellow border border-hq-yellow/20 rounded-full px-4 py-1.5 hover:bg-hq-yellow/20 transition">
                    💰 예산 현황
                  </button>
                </div>
                <!-- 시스템 관리 -->
                <div class="text-[9px] text-hq-muted/60 uppercase tracking-wider mb-2">시스템 관리</div>
                <div class="flex flex-wrap justify-center gap-2">
                  <button @click="inputText='/도구점검'; activeTab='command'"
                          class="text-xs bg-hq-green/10 text-hq-green border border-hq-green/20 rounded-full px-4 py-1.5 hover:bg-hq-green/20 transition">
                    🔧 도구 점검
                  </button>
                  <button @click="inputText='/배치실행 전체 보고'; activeTab='command'"
                          class="text-xs bg-hq-purple/10 text-hq-purple border border-hq-purple/20 rounded-full px-4 py-1.5 hover:bg-hq-purple/20 transition">
                    📤 대기 전송
                  </button>
                  <button @click="inputText='/배치상태'; activeTab='command'"
                          class="text-xs bg-hq-muted/10 text-hq-muted border border-hq-border rounded-full px-4 py-1.5 hover:bg-hq-muted/20 transition">
                    📋 배치 상태
                  </button>
                </div>
                <!-- 최근 사용 명령 -->
                <template x-if="recentCommands.length > 0">
                  <div class="mt-4">
                    <div class="text-[9px] text-hq-muted/60 uppercase tracking-wider mb-2">최근 사용</div>
                    <div class="flex flex-wrap justify-center gap-2">
                      <template x-for="(cmd, i) in recentCommands.slice(0, 5)" :key="i">
                        <button @click="inputText=cmd; activeTab='command'"
                                class="text-[11px] bg-hq-surface text-hq-muted border border-hq-border/50 rounded-full px-3 py-1 hover:text-hq-text hover:border-hq-accent/30 transition truncate max-w-[200px]"
                                x-text="cmd"></button>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>
      </div></template>

      <!-- ═══ Tab: 예약 (Schedule) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'schedule'" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-normal">CRON BASE</h1>
              <p class="text-sm text-hq-muted">반복 작업을 자동으로 실행합니다</p>
            </div>
            <button @click="schedules.showModal = true"
                    class="bg-hq-green/20 hover:bg-hq-green/30 text-hq-green border border-hq-green/40 rounded-lg px-4 py-2 text-sm font-semibold font-mono transition">
              + NEW SCHEDULE
            </button>
          </div>

          <div class="space-y-3">
            <template x-for="s in schedules.items" :key="s.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="mb-1.5"><span class="inline-block w-2 h-2 rounded-full mr-1.5 align-middle" :class="s.enabled ? 'bg-emerald-400' : 'bg-gray-500'"></span><span class="text-sm font-semibold align-middle text-hq-text" x-text="s.name"></span></div>
                    <div class="text-[12px] text-hq-muted mb-1" x-text="s.command"></div>
                    <div class="flex items-center gap-3 text-[11px] text-hq-muted/70">
                      <span x-text="'주기: ' + (s.cron_label || s.cron)"></span>
                      <span x-show="s.last_run" x-text="'마지막: ' + s.last_run"></span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button @click="toggleSchedule(s.id)"
                            class="text-xs px-3 py-1.5 rounded-lg border transition"
                            :class="s.enabled ? 'border-hq-yellow/30 text-hq-yellow hover:bg-hq-yellow/10' : 'border-hq-green/30 text-hq-green hover:bg-hq-green/10'"
                            x-text="s.enabled ? '중지' : '시작'"></button>
                    <button @click="confirmDelete = {type:'schedule', id:s.id, name:s.name||s.command||'이름 없음'}"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!schedules.items || schedules.items.length === 0">
              <div class="text-center py-16 text-hq-muted/80 text-sm">예약된 작업이 없습니다. 새 예약을 추가해보세요.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- ═══ Tab: 워크플로우 (Workflow) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'workflow'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-4xl mx-auto fade-in-up">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-bold text-hq-text mb-1 font-mono tracking-normal">AUTOMATION</h1>
              <p class="text-sm text-hq-muted">여러 단계를 연결해서 자동화 흐름을 만드세요</p>
            </div>
            <button @click="workflows.showEditor = true; workflows.editing = null; workflows.editSteps = [{name:'', command:''}]"
                    class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-semibold transition">
              + 새 워크플로우
            </button>
          </div>

          <!-- 마지막 실행 결과 -->
          <div x-show="workflows.lastResult" class="mb-4 rounded-xl border p-4"
               :class="workflows.lastResult?.status === 'success' ? 'bg-hq-green/5 border-hq-green/30' : 'bg-hq-red/5 border-hq-red/30'">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-sm" x-text="workflows.lastResult?.status === 'success' ? '✅' : '❌'"></span>
                <span class="text-sm font-semibold text-hq-text" x-text="workflows.lastResult?.name"></span>
              </div>
              <button @click="workflows.lastResult = null" class="text-xs text-hq-muted hover:text-hq-text transition">&times; 닫기</button>
            </div>
            <div class="text-xs text-hq-muted whitespace-pre-wrap" x-text="workflows.lastResult?.message"></div>
          </div>

          <div class="space-y-3">
            <template x-for="wf in workflows.items" :key="wf.id">
              <div class="glass border border-hq-border rounded-xl p-4 hover-glow">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap mb-1">
                      <span class="inline-block w-2 h-2 rounded-full bg-violet-400 shrink-0"></span>
                      <span class="text-sm font-semibold text-hq-text font-title" x-text="wf.name"></span>
                      <template x-for="(step, i) in wf.steps" :key="i">
                        <div class="flex items-center gap-1">
                          <span x-show="i > 0" class="text-hq-muted/40 text-[10px]">→</span>
                          <span class="text-[10px] bg-hq-accent/10 text-hq-accent rounded-md px-2 py-0.5 font-medium" x-text="step.name || ('단계 ' + (i+1))"></span>
                        </div>
                      </template>
                    </div>
                    <div class="text-[12px] text-hq-muted ml-3.5" x-text="wf.description || wf.steps.length + '단계'"></div>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <!-- 실시간/배치 모드 토글 -->
                    <div class="flex rounded-md border border-hq-border/30 overflow-hidden text-[10px]">
                      <button @click="wf._mode = 'realtime'"
                              :class="(wf._mode || 'realtime') === 'realtime' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                              class="px-2 py-1 transition">실시간</button>
                      <button @click="wf._mode = 'batch'"
                              :class="wf._mode === 'batch' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                              class="px-2 py-1 transition">배치</button>
                    </div>
                    <!-- 실행 버튼 (바로 실행) -->
                    <button @click="runWorkflowDirect(wf)"
                            :disabled="workflows.runningId === wf.id"
                            class="bg-hq-green/20 text-hq-green border border-hq-green/30 rounded-lg px-3 py-1.5 text-xs font-semibold hover:bg-hq-green/30 transition disabled:opacity-50">
                      <span x-show="workflows.runningId !== wf.id">실행</span>
                      <span x-show="workflows.runningId === wf.id" class="flex items-center gap-1">
                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                        진행중
                      </span>
                    </button>
                    <button @click="editWorkflow(wf)"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-border text-hq-muted hover:text-hq-text transition">수정</button>
                    <button @click="confirmDelete = {type:'workflow', id:wf.id, name:wf.name||'이름 없음'}"
                            class="text-xs px-3 py-1.5 rounded-lg border border-hq-red/30 text-hq-red hover:bg-hq-red/10 transition">삭제</button>
                  </div>
                </div>
                <!-- 워크플로우 실행 진행 상태 (카드 안에 표시) -->
                <div x-show="workflows.runningId === wf.id || wf._lastResult"
                     x-transition class="mt-3 pt-3 border-t border-hq-border/20">
                  <!-- 진행 바 (실행 중) -->
                  <div x-show="workflows.runningId === wf.id">
                    <div class="flex items-center gap-2 mb-1.5">
                      <div class="flex-1 bg-hq-muted/10 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-hq-green h-1.5 rounded-full transition-all duration-500"
                             :style="`width: ${wf._progress || 0}%`"></div>
                      </div>
                      <span class="text-[10px] text-hq-muted shrink-0 font-mono"
                            x-text="`${wf._currentStep || 0}/${wf.steps?.length || 0}`"></span>
                    </div>
                    <div class="text-[11px] text-hq-muted" x-text="wf._progressText || '준비 중...'"></div>
                  </div>
                  <!-- 결과 (완료 후) -->
                  <div x-show="wf._lastResult && workflows.runningId !== wf.id">
                    <button @click="wf._showResult = !wf._showResult"
                            class="text-[11px] text-hq-accent hover:text-hq-text transition flex items-center gap-1">
                      <svg class="w-3 h-3 transition-transform" :class="wf._showResult ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                      <span x-text="wf._showResult ? '결과 접기' : '결과 보기'"></span>
                      <span class="text-hq-muted ml-1" x-text="wf._resultTime || ''"></span>
                    </button>
                    <div x-show="wf._showResult" x-transition
                         class="mt-2 p-3 rounded-lg bg-hq-bg/40 border border-hq-border/20 text-xs text-hq-text/80 whitespace-pre-wrap max-h-48 overflow-y-auto markdown-body"
                         x-html="renderMarkdown(wf._lastResult || '')"></div>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="!workflows.items || workflows.items.length === 0">
              <div class="text-center py-16 text-hq-muted/80 text-sm">워크플로우가 없습니다. 새 워크플로우를 만들어보세요.</div>
            </template>
          </div>
        </div>
      </div></template>

      <!-- ═══ 통신로그 (활동 로그 + 교신 로그 통합) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'activityLog'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto fade-in-up">
          <!-- 헤더 + 서브탭 -->
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
            <div class="flex items-center gap-3 md:gap-4">
              <h2 class="text-base md:text-lg font-bold text-hq-text font-mono tracking-normal">COMMS LOG</h2>
              <!-- 서브탭 전환 -->
              <div class="flex bg-hq-surface border border-hq-border rounded-lg overflow-hidden flex-wrap">
                <button @click="commsLogSubTab = 'activity'"
                        :class="commsLogSubTab === 'activity' ? 'bg-hq-accent/20 text-hq-accent font-bold' : 'text-hq-muted hover:text-hq-text'"
                        class="px-3 py-1.5 text-xs font-semibold transition">
                  📋 활동 <span class="font-mono ml-1" x-text="activityLogs.length"></span>
                </button>
                <button @click="commsLogSubTab = 'qa'"
                        :class="commsLogSubTab === 'qa' ? 'bg-hq-green/20 text-hq-green font-bold' : 'text-hq-muted hover:text-hq-text'"
                        class="px-3 py-1.5 text-xs font-semibold transition border-l border-hq-border">
                  ✅ 검수 <span class="font-mono ml-1" x-text="qaLogs.length"></span>
                </button>
                <button @click="commsLogSubTab = 'tools'"
                        :class="commsLogSubTab === 'tools' ? 'bg-hq-orange/20 text-hq-orange font-bold' : 'text-hq-muted hover:text-hq-text'"
                        class="px-3 py-1.5 text-xs font-semibold transition border-l border-hq-border">
                  🔧 도구 <span class="font-mono ml-1" x-text="toolLogs.length"></span>
                </button>
              </div>
            </div>
            <!-- 필터 + 🗑️ 삭제 (활동 로그일 때) -->
            <div x-show="commsLogSubTab === 'activity'" class="flex items-center gap-3">
              <select x-model="activityLogFilter"
                      class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text min-w-[120px]">
                <option value="all">전체 에이전트</option>
                <template x-for="(name, id) in agentNames" :key="id">
                  <option :value="id" x-text="name"></option>
                </template>
              </select>
              <button @click="showConfirm({ title: '활동 로그 삭제', message: '활동 로그를 전체 삭제할까요?', confirmText: '삭제', onConfirm: () => clearLogsTab('activity') })" title="활동 로그 전체삭제"
                      class="text-hq-muted hover:text-hq-red transition p-1 rounded">🗑️</button>
            </div>
            <!-- 🗑️ 삭제 (검수 로그일 때) -->
            <div x-show="commsLogSubTab === 'qa'" class="flex items-center gap-2">
              <button @click="showConfirm({ title: '검수 로그 삭제', message: '검수 로그를 전체 삭제할까요?', confirmText: '삭제', onConfirm: () => clearLogsTab('qa') })" title="검수 로그 전체삭제"
                      class="text-hq-muted hover:text-hq-red transition p-1 rounded">🗑️</button>
            </div>
            <!-- 🗑️ 삭제 (도구 로그일 때) -->
            <div x-show="commsLogSubTab === 'tools'" class="flex items-center gap-2">
              <button @click="showConfirm({ title: '도구 로그 삭제', message: '도구 로그를 전체 삭제할까요?', confirmText: '삭제', onConfirm: () => clearLogsTab('tools') })" title="도구 로그 전체삭제"
                      class="text-hq-muted hover:text-hq-red transition p-1 rounded">🗑️</button>
            </div>
          </div>

          <!-- SSE 연결 상태 표시 -->
          <div class="flex items-center gap-2 mb-3 text-[11px]">
            <span class="w-1.5 h-1.5 rounded-full animate-pulse" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
            <span class="text-hq-muted/60" x-text="wsConnected ? '실시간 연결됨' : '연결 대기'"></span>
            <span class="w-1.5 h-1.5 rounded-full animate-pulse ml-3" :class="_commsSSE ? 'bg-hq-cyan' : 'bg-hq-muted/40'"></span>
            <span class="text-hq-muted/60" x-text="_commsSSE ? '교신 SSE 연결됨' : '교신 SSE 대기'"></span>
          </div>

          <!-- ── 활동 로그 서브탭 (타임라인) ── -->
          <div x-show="commsLogSubTab === 'activity'" class="relative pl-6">
            <!-- 타임라인 세로선 -->
            <div class="absolute left-[11px] top-2 bottom-2 w-px bg-gradient-to-b from-hq-accent/30 via-hq-border/20 to-transparent"></div>
            <div class="space-y-1">
              <template x-for="(log, i) in activityLogs.filter(l => activityLogFilter === 'all' || l.agent_id === activityLogFilter).slice().reverse()" :key="i">
                <div class="relative group">
                  <!-- 타임라인 도트 -->
                  <div class="absolute -left-[17px] top-3 w-2.5 h-2.5 rounded-full border-2 border-hq-bg ring-1 ring-hq-border/20 group-hover:ring-hq-accent/40 transition"
                       :class="getAgentAvatarClass(log.agent_id) || 'bg-hq-accent'"></div>
                  <!-- 카드 -->
                  <div class="ml-2 bg-hq-panel/30 border border-hq-border/15 rounded-xl px-4 py-2.5 hover:bg-hq-panel/50 hover:border-hq-border/30 transition group-hover:shadow-sm">
                    <div class="flex items-center gap-3">
                      <span class="text-[10px] font-mono text-hq-muted/50 shrink-0 w-12 text-right" x-text="log.timeClock || log.time?.split(' ')[1] || log.time || ''"></span>
                      <span class="w-6 h-6 rounded-md flex items-center justify-center text-[9px] font-bold shrink-0"
                            :class="getAgentAvatarClass(log.agent_id)" x-text="getAgentInitials(log.agent_id)"></span>
                      <span class="text-xs font-medium shrink-0 w-20 truncate" :class="getAgentColor(log.agent_id) || 'text-hq-cyan/80'" x-text="getAgentName(log.agent_id)"></span>
                      <span class="text-sm text-hq-text/80 flex-1 line-clamp-2" x-text="log.action"></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <template x-if="activityLogs.length === 0">
              <div class="text-center text-hq-muted/80 py-12 -ml-6">아직 활동 로그가 없습니다. 에이전트에 작업을 지시하면 여기에 표시됩니다.</div>
            </template>
          </div>

          <!-- ── 검수 로그 서브탭 (타임라인) ── -->
          <div x-show="commsLogSubTab === 'qa'" class="relative pl-6">
            <div class="absolute left-[11px] top-2 bottom-2 w-px bg-gradient-to-b from-hq-green/30 via-hq-border/20 to-transparent"></div>
            <div class="space-y-1">
              <template x-for="(log, i) in qaLogs.slice().reverse()" :key="i">
                <div class="relative group">
                  <div class="absolute -left-[17px] top-3 w-2.5 h-2.5 rounded-full border-2 border-hq-bg"
                       :class="log.level === 'qa_pass' ? 'bg-hq-green ring-1 ring-hq-green/30' : 'bg-hq-red ring-1 ring-hq-red/30'"></div>
                  <div class="ml-2 bg-hq-panel/30 border rounded-xl px-4 py-2.5 hover:bg-hq-panel/50 transition"
                       :class="log.level === 'qa_pass' ? 'border-hq-green/15' : 'border-hq-red/15'">
                    <div class="flex items-center gap-3">
                      <span class="text-[10px] font-mono text-hq-muted/50 shrink-0 w-12 text-right" x-text="log.timeClock || log.time?.split(' ')[1] || log.time || ''"></span>
                      <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold shrink-0"
                            :class="log.level === 'qa_pass' ? 'bg-hq-green/20 text-hq-green' : 'bg-hq-red/20 text-hq-red'"
                            x-text="log.level === 'qa_pass' ? '✅' : '❌'"></span>
                      <span class="text-xs font-medium shrink-0 w-20 truncate" :class="getAgentColor(log.agent_id) || 'text-hq-cyan/80'" x-text="getAgentName(log.agent_id)"></span>
                      <span class="text-sm text-hq-text/80 flex-1 line-clamp-2" x-text="log.action"></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <template x-if="qaLogs.length === 0">
              <div class="text-center text-hq-muted/80 py-12 -ml-6">
                <div class="text-sm mb-1">아직 검수 로그가 없습니다</div>
                <div class="text-[11px] text-hq-muted/50">에이전트 작업 시 품질검수 결과가 실시간으로 표시됩니다</div>
              </div>
            </template>
          </div>

          <!-- ── 도구 로그 서브탭 (타임라인) ── -->
          <div x-show="commsLogSubTab === 'tools'" class="relative pl-6">
            <div class="absolute left-[11px] top-2 bottom-2 w-px bg-gradient-to-b from-hq-orange/30 via-hq-border/20 to-transparent"></div>
            <div class="space-y-1">
              <template x-for="(log, i) in toolLogs.slice().reverse()" :key="i">
                <div class="relative group">
                  <div class="absolute -left-[17px] top-3 w-2.5 h-2.5 rounded-full border-2 border-hq-bg bg-hq-orange ring-1 ring-hq-orange/30"></div>
                  <div class="ml-2 bg-hq-panel/30 border border-hq-border/15 rounded-xl px-4 py-2.5 hover:bg-hq-panel/50 transition">
                    <div class="flex items-center gap-3">
                      <span class="text-[10px] font-mono text-hq-muted/50 shrink-0 w-12 text-right" x-text="log.timeClock || log.time?.split(' ')[1] || log.time || ''"></span>
                      <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold shrink-0 bg-hq-orange/20 text-hq-orange">🔧</span>
                      <span class="text-xs font-medium shrink-0 w-20 truncate" :class="getAgentColor(log.agent_id) || 'text-hq-cyan/80'" x-text="getAgentName(log.agent_id)"></span>
                      <span class="text-sm text-hq-text/80 flex-1 line-clamp-2" x-text="log.action"></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <template x-if="toolLogs.length === 0">
              <div class="text-center text-hq-muted/80 py-12 -ml-6">
                <div class="text-sm mb-1">아직 도구 사용 로그가 없습니다</div>
                <div class="text-[11px] text-hq-muted/50">에이전트가 API를 호출하면 실시간으로 표시됩니다</div>
              </div>
            </template>
          </div>
        </div>
      </div></template>

      <!-- ═══ ARGOS 탭 (Phase 6-8) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'intelligence'">
        <div class="flex-1 overflow-y-auto scrollbar-thin p-4 bg-grid">
          <div class="max-w-5xl mx-auto space-y-4">
            <!-- 헤더 -->
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-base font-bold text-hq-text">📡 ARGOS</h2>
                <p class="text-[11px] text-hq-muted">데이터 수집 레이어 · AI 활동 · 비용 추적 · 에러 모니터링</p>
              </div>
              <button @click="loadIntelligence()"
                      :disabled="intelligence.loading"
                      class="text-xs px-3 py-1.5 rounded-lg bg-hq-surface border border-hq-border text-hq-muted hover:text-hq-text transition">
                <span x-text="intelligence.loading ? '로딩 중...' : '새로고침'"></span>
              </button>
            </div>

            <!-- 시스템 상태 카드 4개 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <template x-for="[type, label] in [['price','주가'], ['news','뉴스'], ['dart','공시'], ['macro','매크로']]" :key="type">
                <div class="bg-hq-panel border border-hq-border rounded-xl p-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-hq-muted uppercase tracking-wider" x-text="label"></span>
                    <span class="text-xs" :class="(intelligence.argos[type] || {}).error ? 'text-hq-red' : 'text-hq-green'"
                          x-text="(intelligence.argos[type] || {}).error ? '❌' : '✅'"></span>
                  </div>
                  <div class="text-[10px] text-hq-muted/70"
                       x-text="_fmtArgosTime((intelligence.argos[type] || {}).last) || '미수집'"></div>
                  <div x-show="(intelligence.argos[type] || {}).error"
                       class="text-[9px] text-hq-red/70 mt-1 truncate"
                       x-text="(intelligence.argos[type] || {}).error"></div>
                </div>
              </template>
            </div>

            <!-- 수동 수집 버튼 -->
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs text-hq-muted">즉시 수집:</span>
              <template x-for="[type, label] in [['all','전체'], ['price','주가'], ['news','뉴스'], ['dart','공시'], ['macro','매크로']]" :key="type">
                <button @click="argosCollectNow(type)"
                        :disabled="intelligence.collectingNow"
                        class="text-[11px] px-2.5 py-1 rounded-lg border border-hq-border text-hq-muted hover:text-hq-accent hover:border-hq-accent/40 transition">
                  <span x-text="label"></span>
                </button>
              </template>
            </div>

            <!-- 활성 트리거 -->
            <div class="bg-hq-panel border border-hq-border rounded-xl p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-hq-text">🎯 활성 트리거</h3>
                <span class="text-[10px] text-hq-muted" x-text="intelligence.triggers.length + '건'"></span>
              </div>
              <template x-if="intelligence.triggers.length === 0">
                <div class="text-xs text-hq-muted/60 py-2 text-center">활성 트리거 없음</div>
              </template>
              <template x-for="tr in intelligence.triggers" :key="tr.ticker + tr.type">
                <div class="flex items-center justify-between py-1.5 border-b border-hq-border/30 last:border-0">
                  <div class="flex items-center gap-2">
                    <span class="text-[10px] px-1.5 py-0.5 rounded"
                          :class="tr.type === 'stop_loss' ? 'bg-hq-red/15 text-hq-red' : 'bg-hq-green/15 text-hq-green'"
                          x-text="tr.type === 'stop_loss' ? '손절' : '익절'"></span>
                    <span class="text-xs font-mono text-hq-text" x-text="tr.ticker"></span>
                  </div>
                  <div class="text-[11px] text-hq-muted font-mono">
                    목표 <span class="text-hq-text" x-text="(tr.trigger_price || 0).toLocaleString()"></span>
                  </div>
                </div>
              </template>
            </div>

            <!-- AI 활동 요약 -->
            <div class="bg-hq-panel border border-hq-border rounded-xl p-4">
              <h3 class="text-sm font-semibold text-hq-text mb-3">🤖 최근 AI 활동</h3>
              <div class="space-y-1.5 max-h-48 overflow-y-auto scrollbar-thin">
                <template x-if="intelligence.activity.length === 0">
                  <div class="text-xs text-hq-muted/60 py-2 text-center">활동 없음</div>
                </template>
                <template x-for="log in intelligence.activity" :key="log.ts">
                  <div class="flex items-start gap-2 text-[11px]">
                    <span class="text-hq-muted/60 font-mono shrink-0" x-text="(log.ts || '').slice(11,16)"></span>
                    <span class="text-hq-accent/80 shrink-0" x-text="log.agent"></span>
                    <span class="text-hq-text/70 truncate" x-text="log.msg"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 비용 추적 -->
            <div class="bg-hq-panel border border-hq-border rounded-xl p-4">
              <h3 class="text-sm font-semibold text-hq-text mb-3">💸 비용 추적</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <div class="text-[10px] text-hq-muted mb-0.5">오늘</div>
                  <div class="text-lg font-bold font-mono text-hq-green" x-text="'$' + (intelligence.costs.today_usd || 0).toFixed(4)"></div>
                </div>
                <div>
                  <div class="text-[10px] text-hq-muted mb-0.5">이번 주</div>
                  <div class="text-lg font-bold font-mono text-hq-text" x-text="'$' + (intelligence.costs.week_usd || 0).toFixed(4)"></div>
                </div>
              </div>
              <!-- 팀장별 비용 바 -->
              <div class="space-y-1.5">
                <template x-for="ac in (intelligence.costs.per_agent || []).slice(0,8)" :key="ac.agent">
                  <div class="flex items-center gap-2">
                    <span class="text-[10px] text-hq-muted w-24 truncate" x-text="ac.agent"></span>
                    <div class="flex-1 bg-hq-bg rounded-full h-1.5">
                      <div class="bg-hq-accent h-1.5 rounded-full"
                           :style="'width:' + Math.min(100, (ac.cost / (intelligence.costs.today_usd || 0.001)) * 100) + '%'"></div>
                    </div>
                    <span class="text-[10px] font-mono text-hq-muted w-14 text-right" x-text="'$' + (ac.cost || 0).toFixed(4)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 에러 로그 -->
            <template x-if="intelligence.errors.length > 0">
              <div class="bg-hq-red/5 border border-hq-red/20 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-hq-red mb-3">🚨 에러 로그 (24시간)</h3>
                <div class="space-y-1.5">
                  <template x-for="err in intelligence.errors" :key="err.ts">
                    <div class="text-[11px]">
                      <span class="text-hq-muted/60 font-mono" x-text="(err.ts || '').slice(11,16)"></span>
                      <span class="text-hq-red/80 ml-2" x-text="err.agent"></span>
                      <span class="text-hq-text/60 ml-2" x-text="err.msg"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <template x-if="intelligence.errors.length === 0">
              <div class="text-xs text-hq-green/70 flex items-center gap-1.5">
                <span>✅</span><span>최근 24시간 에러 없음</span>
              </div>
            </template>
          </div>
        </div>
      </template>

      <!-- ═══ Knowledge View (지식 관리) ═══ -->
      <div x-show="viewMode === 'chat' && activeTab === 'knowledge'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="flex-1 overflow-hidden flex bg-grid">
        <!-- Left: File Tree (드래그앤드롭 지원) -->
        <div class="w-64 border-r border-hq-border overflow-y-auto scrollbar-thin p-4 bg-hq-surface shrink-0 relative"
             @dragover.prevent="knowledge.dragOver = true"
             @dragenter.prevent="knowledge.dragOver = true"
             @dragleave.prevent="knowledge.dragOver = false"
             @drop.prevent="knowledge.dragOver = false; handleKnowledgeDrop($event)">
          <!-- 드래그앤드롭 오버레이 -->
          <div x-show="knowledge.dragOver" x-transition.opacity
               class="absolute inset-0 z-10 bg-hq-accent/10 border-2 border-dashed border-hq-accent rounded-xl flex items-center justify-center">
            <div class="text-center">
              <svg class="w-8 h-8 text-hq-accent mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
              <div class="text-xs font-bold text-hq-accent">파일을 여기에 놓으세요</div>
              <div class="text-[10px] text-hq-muted mt-1">.md, .txt, .yaml, .json, .csv</div>
            </div>
          </div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-bold text-hq-text uppercase tracking-wider">참고 자료</h3>
            <div class="flex items-center gap-1.5">
              <!-- E-3: 파일 업로드 -->
              <button @click="$refs.knowledgeUploadInput.click()" class="text-hq-green text-xs hover:text-hq-green/80 flex items-center gap-0.5" title="로컬 파일 업로드">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
                업로드
              </button>
              <input type="file" x-ref="knowledgeUploadInput" @change="uploadKnowledgeFile($event)" accept=".md,.txt,.yaml,.json,.csv" multiple class="hidden">
              <span class="text-hq-border">|</span>
              <button @click="knowledge.showCreateForm = !knowledge.showCreateForm" class="text-hq-accent text-xs hover:text-hq-accent/80">+ 새 파일</button>
            </div>
          </div>
          <!-- E-3: 업로드 시 폴더 지정 (showCreateForm 없을 때도 표시) -->
          <div x-show="knowledge.showCreateForm" x-transition class="mb-3 space-y-1">
            <input x-model="knowledge.newFolder" placeholder="폴더명" class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
            <input x-model="knowledge.newFileName" placeholder="파일명" class="w-full bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
            <button @click="createKnowledgeFile()" class="bg-hq-accent text-white rounded-lg px-2 py-1 text-xs w-full">생성</button>
          </div>
          <!-- 업로드 폴더 지정 -->
          <div class="mb-2">
            <input x-model="knowledge.uploadFolder" placeholder="업로드 폴더 (기본: shared)" class="w-full bg-hq-bg border border-hq-border/50 rounded-lg px-2 py-1 text-xs text-hq-muted focus:text-hq-text focus:border-hq-accent/50 transition">
          </div>
          <template x-if="knowledge.loading">
            <div class="text-xs text-hq-muted text-center py-4">로딩 중...</div>
          </template>
          <div class="space-y-0.5">
            <template x-for="file in knowledge.files" :key="file.folder + '/' + file.filename">
              <button @click="selectKnowledgeFile(file)"
                :class="knowledge.selectedFile && knowledge.selectedFile.folder === file.folder && knowledge.selectedFile.filename === file.filename ? 'bg-hq-accent/15 text-hq-accent' : 'text-hq-text/90 hover:bg-hq-surface'"
                class="w-full text-left px-2 py-1.5 rounded-lg text-xs transition truncate">
                <span class="text-hq-muted/80" x-text="file.folder + '/'"></span><span x-text="file.filename"></span>
              </button>
            </template>
          </div>
          <template x-if="!knowledge.loading && knowledge.files.length === 0">
            <div class="text-xs text-hq-muted/80 text-center py-4">파일이 없습니다</div>
          </template>
        </div>
        <!-- Right: Editor/Viewer -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-6">
          <template x-if="knowledge.selectedFile">
            <div class="fade-in-up">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-hq-text" x-text="knowledge.selectedFile.folder + '/' + knowledge.selectedFile.filename"></h3>
                <div class="flex items-center gap-2">
                  <button @click="knowledge.editMode = !knowledge.editMode"
                    :class="knowledge.editMode ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                    class="text-xs px-3 py-1 rounded-lg transition" x-text="knowledge.editMode ? '미리보기' : '편집'"></button>
                  <button x-show="knowledge.editMode" @click="saveKnowledge()" :disabled="knowledge.saving"
                    class="bg-hq-accent hover:bg-blue-600 disabled:opacity-50 text-white rounded-lg px-3 py-1 text-xs">저장</button>
                  <button @click="deleteKnowledge()" class="text-hq-red/60 hover:text-hq-red text-xs px-2 py-1">삭제</button>
                </div>
              </div>
              <div x-show="knowledge.editMode">
                <textarea x-model="knowledge.content" rows="25"
                  class="w-full bg-hq-bg border border-hq-border rounded-xl px-4 py-3 text-sm text-hq-text font-mono resize-y"></textarea>
              </div>
              <div x-show="!knowledge.editMode" class="bg-hq-surface border border-hq-border rounded-xl px-5 py-4">
                <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(knowledge.content)"></div>
              </div>
            </div>
          </template>
          <template x-if="!knowledge.selectedFile">
            <div class="flex items-center justify-center h-full text-hq-muted/80 text-sm">왼쪽에서 파일을 선택하세요</div>
          </template>
        </div>
      </div>

      <!-- ═══ Archive View (아카이브) — 2단 레이아웃 ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'archive'"><div class="flex-1 overflow-hidden p-6 bg-grid">
        <div class="max-w-7xl mx-auto fade-in-up h-full flex flex-col">
          <!-- 상단: 제목 + 검색 -->
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-hq-text flex items-center gap-2 font-mono tracking-wide">
              <svg class="w-5 h-5 text-hq-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              CLASSIFIED
              <span class="text-xs text-hq-muted font-normal ml-1" x-text="'총 ' + archive.files.length + '건'" x-show="archive.files.length > 0"></span>
            </h2>
            <div class="flex items-center gap-2">
              <input x-model="archive.searchCorrelation" placeholder="작업 ID로 검색"
                class="bg-hq-surface border border-hq-border rounded-lg px-3 py-1.5 text-xs text-hq-text w-48" @keydown.enter="searchArchiveByCorrelation()">
              <button @click="searchArchiveByCorrelation()" class="bg-hq-accent text-white rounded-lg px-3 py-1.5 text-xs">검색</button>
              <button @click="downloadArchiveZip()"
                      class="px-3 py-1.5 rounded-lg text-xs font-medium bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 border border-hq-accent/30 transition flex items-center gap-1.5"
                      x-show="archive.files.length > 0"
                      title="현재 필터 조건으로 ZIP 다운로드">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                ZIP 내보내기
              </button>
              <button @click="showDeleteAllArchiveModal = true"
                      class="px-3 py-1.5 rounded-lg text-xs font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 transition"
                      x-show="archive.files.length > 0">
                전체 삭제
              </button>
            </div>
          </div>

          <!-- 2단 레이아웃 (모바일: 1단) -->
          <div class="flex gap-4 flex-1 min-h-0 archive-layout">
            <!-- 왼쪽: 카드 목록 (1/3, 모바일: 전체) -->
            <div class="w-1/3 sm:min-w-[280px] overflow-y-auto scrollbar-thin pr-1 flex flex-col">
              <!-- 부서 필터 (sticky) -->
              <div class="flex flex-wrap gap-1.5 mb-2 sticky top-0 z-10 pb-1" style="background: rgb(var(--hq-bg));">
                <button @click="archive.filterDivision = 'all'; loadArchive()"
                  :class="archive.filterDivision === 'all' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                  class="px-2.5 py-1 text-[11px] font-semibold rounded-lg transition">전체</button>
                <template x-for="div in ['secretary','leet_master.tech','leet_master.strategy','leet_master.legal','leet_master.marketing','finance.investment','publishing']" :key="div">
                  <button @click="archive.filterDivision = div; loadArchive()"
                    :class="archive.filterDivision === div ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                    class="px-2.5 py-1 text-[11px] font-semibold rounded-lg transition" x-text="getDivisionLabel(div)"></button>
                </template>
              </div>
              <!-- 중요도 + 태그 필터 -->
              <div class="flex flex-wrap gap-2 mb-3 sticky top-14 z-10 pb-1" style="background: rgb(var(--hq-bg));">
                <select x-model="archiveImportanceFilter"
                        class="bg-hq-surface border border-hq-border rounded-lg px-2 py-1 text-[10px] text-hq-text">
                  <option value="all">중요도 전체</option>
                  <option value="임원급">임원급</option>
                  <option value="일반">일반</option>
                </select>
                <div class="flex gap-1.5 flex-wrap items-center">
                  <template x-for="tag in ['임원급','전략실','긴급','기밀','보고서']" :key="tag">
                    <button @click="toggleArchiveTag(tag)"
                            :class="archiveTagFilter.includes(tag) ? 'bg-hq-accent text-white border-hq-accent' : 'bg-hq-surface text-hq-muted border-hq-border'"
                            class="px-2 py-0.5 rounded text-[10px] border transition"
                            x-text="'#' + tag"></button>
                  </template>
                </div>
              </div>

              <template x-if="archive.loading">
                <div class="text-center py-8 text-hq-muted">로딩 중...</div>
              </template>

              <!-- 보고서 카드 목록 (세로) -->
              <div class="space-y-2 flex-1" x-show="!archive.loading">
                <template x-for="file in archive.files.filter(f => {
                  if (archive.filterDivision !== 'all' && f.division !== archive.filterDivision) return false;
                  if (archive.filterTier !== 'all') {
                    const tier = getAgentTier(f.agent_id);
                    if (archive.filterTier !== tier) return false;
                  }
                  if (archiveImportanceFilter !== 'all' && f.importance !== archiveImportanceFilter) return false;
                  if (archiveTagFilter.length > 0 && !archiveTagFilter.every(t => (f.tags||[]).includes(t))) return false;
                  return true;
                })" :key="file.division + '/' + file.filename">
                  <div @click="readArchiveReport(file)"
                    :class="archive.selectedReport && archive.selectedReport.filename === file.filename ? 'border-hq-accent bg-hq-accent/15 shadow-lg shadow-hq-accent/10 ring-1 ring-hq-accent/30 border-l-[3px] border-l-hq-accent' : 'border-hq-border/50 hover:border-hq-accent/30 hover:bg-hq-accent/5'"
                    class="group glass border rounded-xl p-3 pl-8 cursor-pointer transition-all duration-200 relative">
                    <!-- 체크박스 (hover 또는 selectMode 시 표시) -->
                    <div class="absolute top-2 left-2 z-10"
                         :class="archive.selectMode || archive.selectedFiles.some(f => f.division === file.division && f.filename === file.filename) ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'"
                         @click.stop="">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               :checked="archive.selectedFiles.some(f => f.division === file.division && f.filename === file.filename)"
                               @change="e => { if(e.target.checked) { archive.selectedFiles.push(file) } else { archive.selectedFiles = archive.selectedFiles.filter(f => !(f.division === file.division && f.filename === file.filename)) } }"
                               class="sr-only">
                        <div :class="archive.selectedFiles.some(f => f.division === file.division && f.filename === file.filename) ? 'bg-hq-accent border-hq-accent' : 'bg-hq-bg border-hq-border/50'"
                             class="w-4 h-4 rounded border-2 flex items-center justify-center transition-all">
                          <svg x-show="archive.selectedFiles.some(f => f.division === file.division && f.filename === file.filename)"
                               class="w-2.5 h-2.5 text-hq-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                          </svg>
                        </div>
                      </label>
                    </div>
                    <!-- 액션 버튼 (호버 시 표시) -->
                    <div class="absolute top-2 right-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition z-10">
                      <button @click.stop="downloadArchiveReport(file)"
                              class="w-6 h-6 rounded-md flex items-center justify-center text-hq-muted/30 hover:text-hq-accent hover:bg-hq-accent/10 transition"
                              title="다운로드">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                      </button>
                      <button @click.stop="deleteArchiveReport(file)"
                              class="w-6 h-6 rounded-md flex items-center justify-center text-hq-muted/30 hover:text-hq-red hover:bg-hq-red/8 transition"
                              title="삭제">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                      </button>
                    </div>
                    <!-- 1줄: 팀명 | 담당자 -->
                    <div class="flex items-center gap-1.5 mb-1.5">
                      <span class="status-badge text-[9px] px-1.5 py-0.5"
                        :class="file.division?.includes('tech') ? 'bg-hq-cyan/10 text-hq-cyan' :
                                file.division?.includes('strategy') ? 'bg-hq-purple/10 text-hq-purple' :
                                file.division?.includes('legal') ? 'bg-hq-red/10 text-hq-red' :
                                file.division?.includes('marketing') ? 'bg-hq-green/10 text-hq-green' :
                                file.division?.includes('finance') ? 'bg-hq-yellow/10 text-hq-yellow' :
                                'bg-hq-accent/10 text-hq-accent'"
                        x-text="getDivisionLabel(file.division)"></span>
                      <span class="text-[9px] text-hq-muted/40">|</span>
                      <span class="text-[10px] text-hq-text/80 font-medium truncate" x-text="getArchiveAuthor(file.agent_id)"></span>
                    </div>
                    <!-- 2줄: 날짜 | 제목 -->
                    <div class="flex items-start gap-2 mb-1">
                      <span class="text-[10px] text-hq-muted shrink-0 pt-px font-mono" x-text="formatArchiveDateFull(file.created_at)"></span>
                      <span class="text-[10px] text-hq-muted/40 shrink-0">|</span>
                      <span class="text-xs font-semibold text-hq-text line-clamp-1 leading-tight" x-text="cleanArchiveTitle(file.filename)"></span>
                    </div>
                    <!-- 3줄: 시간 | 용량 -->
                    <div class="flex items-center justify-between">
                      <span class="text-[10px] text-hq-muted" x-text="formatArchiveDate(file.created_at)"></span>
                      <span class="text-[10px] text-hq-muted font-mono" x-text="file.size ? (file.size / 1024).toFixed(1) + 'KB' : ''"></span>
                    </div>
                  </div>
                </template>

                <!-- 다중 선택 액션 바 -->
                <div x-show="archive.selectedFiles.length > 0"
                     class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-2 px-4 py-2.5 rounded-2xl glass border border-hq-accent/30 shadow-lg shadow-hq-accent/10 backdrop-blur-xl">
                  <span class="text-xs font-medium text-hq-accent" x-text="archive.selectedFiles.length + '개 선택됨'"></span>
                  <div class="w-px h-4 bg-hq-border/50"></div>
                  <button @click="downloadSelectedAsZip()"
                          class="flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg bg-hq-accent/15 hover:bg-hq-accent/25 text-hq-accent transition font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                    ZIP 다운로드
                  </button>
                  <button @click="deleteSelectedFiles()"
                          class="flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg bg-hq-red/10 hover:bg-hq-red/20 text-hq-red transition font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                    삭제
                  </button>
                  <button @click="archive.selectedFiles = []"
                          class="text-xs text-hq-muted hover:text-hq-text transition px-2 py-1.5">취소</button>
                </div>

                <!-- 빈 화면 안내 -->
                <div x-show="archive.files.filter(f => {
                  if (archive.filterDivision !== 'all' && f.division !== archive.filterDivision) return false;
                  if (archive.filterTier !== 'all' && getAgentTier(f.agent_id) !== archive.filterTier) return false;
                  if (archiveImportanceFilter !== 'all' && f.importance !== archiveImportanceFilter) return false;
                  if (archiveTagFilter.length > 0 && !archiveTagFilter.every(t => (f.tags||[]).includes(t))) return false;
                  return true;
                }).length === 0"
                     class="flex flex-col items-center justify-center py-12 text-center">
                  <div class="w-16 h-16 rounded-2xl bg-hq-purple/10 flex items-center justify-center mb-3 float-anim">
                    <svg class="w-8 h-8 text-hq-purple/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                  </div>
                  <div class="text-xs font-semibold text-hq-text/60 mb-1">보고서 없음</div>
                  <div class="text-[11px] text-hq-muted">에이전트에게 분석을 지시해보세요</div>
                </div>
              </div>
            </div>

            <!-- 오른쪽: 보고서 내용 (2/3) -->
            <div class="w-2/3 overflow-y-auto scrollbar-thin">
              <template x-if="archive.content">
                <div class="glass border border-hq-border/50 rounded-xl p-6 h-full">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-hq-text break-words max-w-[60%]" x-text="cleanArchiveTitle(archive.selectedReport?.filename || '')"></h3>
                    <div class="flex items-center gap-3">
                      <button @click="copyToClipboard(archive.content)" class="text-xs text-hq-muted hover:text-hq-green transition">복사</button>
                      <button @click="downloadArchiveReport(archive.selectedReport)" class="text-xs text-hq-muted hover:text-hq-accent transition">다운로드</button>
                      <button @click="deleteArchiveReport(archive.selectedReport)" class="text-xs text-hq-muted hover:text-hq-red transition">삭제</button>
                    </div>
                  </div>
                  <div class="report-reading-mode markdown-body" x-html="renderMarkdown(archive.content)"></div>
                </div>
              </template>
              <template x-if="!archive.content">
                <div class="flex items-center justify-center h-full text-hq-muted">
                  <div class="text-center">
                    <svg class="w-12 h-12 mx-auto mb-3 text-hq-purple/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <div class="text-sm text-hq-muted">왼쪽에서 보고서를 선택하세요</div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div></template>

      <!-- ═══ SNS Management View (SNS 관리) ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'sns'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-5xl mx-auto fade-in-up">
          <h2 class="text-base md:text-lg font-bold text-hq-text mb-4 font-mono tracking-wide">COMM STATION</h2>
          <!-- Sub Tabs -->
          <div class="flex gap-2 mb-4 md:mb-6 overflow-x-auto scrollbar-thin pb-1">
            <button @click="sns.tab = 'status'; loadSNS()" :class="sns.tab === 'status' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">연결 상태</button>
            <button @click="sns.tab = 'publish'" :class="sns.tab === 'publish' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">게시하기</button>
            <button @click="sns.tab = 'queue'; loadSNSQueue()" :class="sns.tab === 'queue' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">승인 대기열</button>
            <button @click="sns.tab = 'media'; loadMediaGallery()" :class="sns.tab === 'media' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">미디어</button>
            <button @click="sns.tab = 'events'; loadSNSEvents()" :class="sns.tab === 'events' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">이벤트</button>
            <button @click="sns.tab = 'cookies'; loadCookieStatus()" :class="sns.tab === 'cookies' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1.5 text-xs font-semibold rounded-lg transition shrink-0">쿠키 관리</button>
          </div>
          <template x-if="sns.loading">
            <div class="text-center py-8 text-hq-muted">로딩 중...</div>
          </template>

          <!-- SNS Tab 1: Connection Status -->
          <div x-show="sns.tab === 'status' && !sns.loading">
            <div class="bg-hq-surface border border-hq-border/50 rounded-lg px-4 py-3 mb-4 text-xs text-hq-muted">
              SNS 플랫폼을 연결하려면 각 플랫폼의 API 키가 필요합니다. GitHub Secrets에 해당 키를 등록하면 배포 시 서버 환경변수에 자동 반영됩니다.
            </div>
            <!-- D-3: 연결 요약 -->
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
              <div class="bg-hq-green/10 border border-hq-green/20 rounded-lg px-3 py-2 text-center flex-1">
                <div class="text-lg font-bold text-hq-green" x-text="Object.values(sns.status || {}).filter(s => s.connected).length"></div>
                <div class="text-[10px] text-hq-green/70">연결됨</div>
              </div>
              <div class="bg-hq-muted/10 border border-hq-border/30 rounded-lg px-3 py-2 text-center flex-1">
                <div class="text-lg font-bold text-hq-muted" x-text="Object.values(sns.status || {}).filter(s => !s.connected).length"></div>
                <div class="text-[10px] text-hq-muted/70">미연결</div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <template x-for="platform in Object.keys(sns.status)" :key="platform">
                <div class="glass border rounded-xl p-4"
                     :class="(sns.status || {})[platform]?.connected ? 'border-hq-green/20' : 'border-hq-border'">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-hq-text" x-text="getSNSPlatformName(platform)"></span>
                    <span class="status-badge text-[10px] px-2 py-0.5"
                      :class="(sns.status || {})[platform]?.connected ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-muted/10 text-hq-muted'"
                      x-text="(sns.status || {})[platform]?.connected ? '연결됨' : '미연결'"></span>
                  </div>
                  <!-- D-3: 필요한 환경변수 + 토큰 상태 표시 -->
                  <div class="text-[10px] text-hq-muted/60 mb-3 font-mono"
                       x-text="'필요: ' + ((sns.status || {})[platform]?.env_key || '—')"></div>
                  <div x-show="(sns.status || {})[platform]?.token_valid === false" class="text-[10px] text-hq-yellow mb-2">토큰 만료됨 — 재인증 필요</div>
                  <button @click="connectPlatform(platform)"
                    class="w-full border hover:bg-hq-accent/20 text-hq-accent rounded-lg px-3 py-2 text-xs transition"
                    :class="(sns.status || {})[platform]?.connected ? 'bg-hq-accent/5 border-hq-accent/20' : 'bg-hq-accent/10 border-hq-accent/30'"
                    x-text="(sns.status || {})[platform]?.connected ? '재연결' : '연결하기'"></button>
                </div>
              </template>
            </div>
          </div>

          <!-- SNS Tab 2: Publish -->
          <div x-show="sns.tab === 'publish' && !sns.loading" class="space-y-6">
            <!-- Instagram Photo -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">Instagram 사진 게시</h3>
              <div class="space-y-2">
                <input x-model="sns.igImageUrl" placeholder="이미지 URL" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.igCaption" placeholder="캡션" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <button @click="postInstagramPhoto()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg px-4 py-2 text-sm font-semibold">게시</button>
              </div>
            </div>
            <!-- Instagram Reel -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">Instagram 릴스 게시</h3>
              <div class="space-y-2">
                <input x-model="sns.igVideoUrl" placeholder="비디오 URL" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.igReelCaption" placeholder="캡션" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <button @click="postInstagramReel()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg px-4 py-2 text-sm font-semibold">게시</button>
              </div>
            </div>
            <!-- YouTube Upload -->
            <div class="glass border border-hq-border rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">YouTube 업로드</h3>
              <div class="space-y-2">
                <input x-model="sns.ytFilePath" placeholder="파일 경로 (서버 내)" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <input x-model="sns.ytTitle" placeholder="제목" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                <textarea x-model="sns.ytDesc" placeholder="설명" rows="2" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text resize-y"></textarea>
                <div class="flex gap-2">
                  <input x-model="sns.ytTags" placeholder="태그 (쉼표 구분)" class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                  <select x-model="sns.ytPrivacy" class="bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
                    <option value="private">비공개</option>
                    <option value="unlisted">일부공개</option>
                    <option value="public">공개</option>
                  </select>
                </div>
                <button @click="postYouTubeVideo()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 text-sm font-semibold">업로드</button>
              </div>
            </div>
          </div>

          <!-- SNS Tab 3: Approval Queue -->
          <div x-show="sns.tab === 'queue' && !sns.loading">
            <!-- D-3: 대기열 상태 요약 -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-1">
              <div class="bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg px-3 py-1.5 text-center shrink-0">
                <span class="text-sm font-bold text-hq-yellow" x-text="(sns.queue || []).filter(q => q.status === 'pending').length"></span>
                <span class="text-[10px] text-hq-yellow/70 ml-1">대기</span>
              </div>
              <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg px-3 py-1.5 text-center shrink-0">
                <span class="text-sm font-bold text-orange-400" x-text="(sns.queue || []).filter(q => q.status === 'rework').length"></span>
                <span class="text-[10px] text-orange-400/70 ml-1">재작업</span>
              </div>
              <div class="bg-hq-green/10 border border-hq-green/20 rounded-lg px-3 py-1.5 text-center shrink-0">
                <span class="text-sm font-bold text-hq-green" x-text="(sns.queue || []).filter(q => q.status === 'approved').length"></span>
                <span class="text-[10px] text-hq-green/70 ml-1">승인</span>
              </div>
              <div class="bg-hq-cyan/10 border border-hq-cyan/20 rounded-lg px-3 py-1.5 text-center shrink-0">
                <span class="text-sm font-bold text-hq-cyan" x-text="(sns.queue || []).filter(q => q.status === 'published').length"></span>
                <span class="text-[10px] text-hq-cyan/70 ml-1">발행</span>
              </div>
            </div>
            <div class="flex items-center justify-between mb-4">
              <div class="flex gap-2">
                <template x-for="f in ['all','pending','rework','approved','published','rejected']" :key="f">
                  <button @click="sns.queueFilter = f"
                    :class="sns.queueFilter === f ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                    class="px-3 py-1 text-xs rounded-lg transition"
                    x-text="f === 'all' ? '전체' : f === 'pending' ? '대기' : f === 'rework' ? '재작업' : f === 'approved' ? '승인' : f === 'published' ? '발행' : '거절'"></button>
                </template>
              </div>
              <button x-show="sns.queue.length > 0" @click="sns.showClearQueueModal = true"
                class="text-[10px] text-red-400 hover:text-red-300 px-2 py-1 rounded-lg hover:bg-red-500/10 transition">전체 초기화</button>
            </div>
            <div class="space-y-3">
              <template x-for="item in sns.queue.filter(q => sns.queueFilter === 'all' || q.status === sns.queueFilter)" :key="item.request_id">
                <div class="sns-card-redesign p-4"
                     :class="item.status === 'pending' ? 'status-pending' : item.status === 'approved' ? 'status-approved' : item.status === 'published' ? 'status-published' : item.status === 'rework' ? 'status-rework' : ''">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-bold text-hq-text uppercase tracking-wide font-mono" x-text="item.platform || '-'"></span>
                      <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                        :class="item.status === 'pending' ? 'bg-hq-yellow/10 text-hq-yellow' : item.status === 'approved' ? 'bg-hq-accent/10 text-hq-accent' : item.status === 'published' ? 'bg-hq-muted/10 text-hq-muted' : item.status === 'rework' ? 'bg-hq-red/10 text-hq-red' : 'bg-hq-border text-hq-muted'"
                        x-text="item.status === 'pending' ? '대기 중' : item.status === 'approved' ? '승인됨' : item.status === 'published' ? '발행 완료' : item.status === 'failed' ? '실패' : item.status === 'rework' ? '재작업 중' : '거절'"></span>
                      <span x-show="item.revision > 0" class="text-[9px] text-hq-yellow" x-text="'v' + (item.revision || 1)"></span>
                      <span class="text-[9px] text-hq-muted" x-text="item.requested_by ? item.requested_by : ''"></span>
                    </div>
                    <!-- 대기 → 승인/거절 버튼 (데스크탑: 즉시 승인 / 모바일: 5초 undo) -->
                    <div class="flex items-center gap-2" x-show="item.status === 'pending'">
                      <button @click="window.innerWidth <= 768 ? approveWithUndo(item.request_id) : approveSNS(item.request_id)"
                              class="btn-approve sns-approve-btn">✓ 승인+발행</button>
                      <button @click="sns.rejectingId = item.request_id" class="text-hq-muted hover:text-hq-red text-xs px-2 py-1 rounded-lg hover:bg-hq-red/10 transition">거절</button>
                    </div>
                    <!-- 승인됨 → 자동 발행 진행중 (수동 발행 버튼도 유지) -->
                    <div class="flex items-center gap-2" x-show="item.status === 'approved'">
                      <span class="text-hq-accent text-xs animate-pulse">발행 진행중...</span>
                      <button @click="publishSNS(item.request_id)" class="bg-hq-accent/20 text-hq-accent rounded-lg px-2 py-0.5 text-[10px] hover:bg-hq-accent/30">수동 발행</button>
                    </div>
                    <!-- 발행완료 → 링크 -->
                    <div x-show="item.status === 'published' && item.result?.post_url">
                      <a :href="item.result.post_url" target="_blank" class="text-hq-cyan text-xs hover:underline">🔗 보기</a>
                    </div>
                  </div>
                  <div class="text-sm font-semibold text-hq-text mb-1" x-text="item.content?.title || '-'"></div>
                  <div class="text-xs text-hq-muted line-clamp-3" x-text="item.content?.body?.substring(0, 200) || '-'"></div>
                  <!-- 이미지 미리보기 -->
                  <template x-if="item.content?.image_url || item.content?.body?.includes('/api/media/images/')">
                    <div class="mt-2 rounded-lg overflow-hidden border border-hq-border/30">
                      <img :src="item.content?.image_url || item.content?.body?.match(/\/api\/media\/images\/[^\s\)]+/)?.[0] || ''"
                           class="max-h-48 w-auto object-contain bg-hq-bg/50" loading="lazy"
                           @error="$el.style.display='none'" />
                    </div>
                  </template>
                  <!-- 영상 미리보기 -->
                  <template x-if="item.content?.video_url || item.content?.body?.includes('/api/media/videos/')">
                    <div class="mt-2 rounded-lg overflow-hidden border border-hq-border/30">
                      <video :src="item.content?.video_url || item.content?.body?.match(/\/api\/media\/videos\/[^\s\)]+/)?.[0] || ''"
                             class="max-h-48 w-auto bg-hq-bg/50" controls preload="metadata"></video>
                    </div>
                  </template>
                  <div class="flex gap-1 mt-1 flex-wrap" x-show="item.content?.tags?.length > 0">
                    <template x-for="tag in (item.content?.tags || [])" :key="tag">
                      <span class="text-[9px] bg-hq-accent/10 text-hq-accent px-1.5 py-0.5 rounded" x-text="'#' + tag"></span>
                    </template>
                  </div>
                  <!-- Reject form -->
                  <div x-show="sns.rejectingId === item.request_id" class="mt-2 flex gap-2">
                    <input x-model="sns.rejectReason" placeholder="거절 사유" class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-2 py-1 text-xs text-hq-text">
                    <button @click="rejectSNS(item.request_id)" class="bg-hq-red text-white rounded-lg px-3 py-1 text-xs">확인</button>
                  </div>
                  <!-- 재작업 상태 표시 -->
                  <div x-show="item.status === 'rework'" class="mt-2 bg-orange-500/10 border border-orange-500/20 rounded-lg px-3 py-2">
                    <div class="text-[10px] text-orange-400 font-bold mb-1">재작업 진행중</div>
                    <div x-show="item.result?.reason" class="text-[10px] text-hq-muted" x-text="'거절 사유: ' + item.result?.reason"></div>
                  </div>
                  <!-- 거절 사유 (rejected 상태) -->
                  <div x-show="item.status === 'rejected' && item.result?.reason" class="mt-2 bg-hq-red/10 border border-hq-red/20 rounded-lg px-3 py-2">
                    <div class="text-[10px] text-hq-red" x-text="'거절 사유: ' + item.result?.reason"></div>
                  </div>
                  <!-- 발행 결과 -->
                  <div x-show="item.result?.message" class="mt-2 text-[10px] text-hq-muted bg-hq-bg rounded px-2 py-1" x-text="item.result?.message"></div>
                </div>
              </template>
              <template x-if="sns.queue.filter(q => sns.queueFilter === 'all' || q.status === sns.queueFilter).length === 0">
                <div class="empty-state">
                  <div class="empty-state-icon">✓</div>
                  <div class="empty-state-title" x-text="sns.queueFilter === 'pending' ? '승인 대기 없음' : '항목 없음'"></div>
                  <div class="empty-state-desc" x-text="sns.queueFilter === 'pending' ? '오늘 모두 처리됐습니다' : '해당 상태의 항목이 없습니다'"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- SNS Tab: 미디어 갤러리 (생성된 이미지/영상) -->
          <div x-show="sns.tab === 'media' && !sns.loading">
            <!-- 상단 액션 바 -->
            <div class="flex items-center justify-between mb-4">
              <div class="text-xs text-hq-muted">
                나노바나나 Pro(이미지) + Veo 3.1(영상)로 생성된 미디어 파일입니다.
              </div>
              <div class="flex items-center gap-2">
                <button x-show="(sns.mediaImages || []).length + (sns.mediaVideos || []).length > 0"
                  @click="sns.mediaSelectMode = !sns.mediaSelectMode; sns.selectedMedia = []"
                  :class="sns.mediaSelectMode ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="text-[10px] px-2 py-1 rounded-lg transition">
                  <span x-text="sns.mediaSelectMode ? '선택 취소' : '선택'"></span>
                </button>
                <button x-show="sns.mediaSelectMode && (sns.selectedMedia || []).length > 0"
                  @click="deleteSelectedMedia()"
                  class="text-[10px] px-2 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">
                  <span x-text="sns.selectedMedia.length + '개 삭제'"></span>
                </button>
                <button x-show="(sns.mediaImages || []).length + (sns.mediaVideos || []).length > 0"
                  @click="sns.showDeleteAllMediaModal = true"
                  class="text-[10px] text-red-400 hover:text-red-300 px-2 py-1 rounded-lg hover:bg-red-500/10 transition">전체 삭제</button>
              </div>
            </div>
            <!-- 이미지 갤러리 -->
            <template x-if="(sns.mediaImages || []).length > 0">
              <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-bold text-hq-text">이미지 (<span x-text="sns.mediaImages.length"></span>)</h3>
                  <button x-show="sns.mediaSelectMode" @click="toggleSelectAllMedia('images')"
                    class="text-[10px] text-hq-accent hover:underline">전체 선택</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                  <template x-for="img in sns.mediaImages" :key="img.filename">
                    <div class="glass border rounded-xl overflow-hidden group cursor-pointer relative"
                         :class="(sns.selectedMedia || []).find(m => m.filename === img.filename) ? 'border-hq-accent' : 'border-hq-border'"
                         @click="sns.mediaSelectMode ? toggleMediaItem('images', img) : window.open(img.url, '_blank')">
                      <!-- 선택 체크박스 -->
                      <div x-show="sns.mediaSelectMode" class="absolute top-1.5 left-1.5 z-10">
                        <div class="w-5 h-5 rounded-md border-2 flex items-center justify-center text-xs"
                          :class="(sns.selectedMedia || []).find(m => m.filename === img.filename) ? 'bg-hq-accent border-hq-accent text-white' : 'border-hq-muted bg-black/40'">
                          <span x-show="(sns.selectedMedia || []).find(m => m.filename === img.filename)">&#10003;</span>
                        </div>
                      </div>
                      <img :src="img.thumb || img.url" class="w-full h-32 object-cover group-hover:scale-105 transition-transform" loading="lazy" />
                      <div class="px-2 py-1.5">
                        <div class="text-[9px] text-hq-muted truncate" x-text="img.filename"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <!-- 영상 갤러리 -->
            <template x-if="(sns.mediaVideos || []).length > 0">
              <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-bold text-hq-text">영상 (<span x-text="sns.mediaVideos.length"></span>)</h3>
                  <button x-show="sns.mediaSelectMode" @click="toggleSelectAllMedia('videos')"
                    class="text-[10px] text-hq-accent hover:underline">전체 선택</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <template x-for="vid in sns.mediaVideos" :key="vid.filename">
                    <div class="glass border rounded-xl overflow-hidden relative"
                         :class="(sns.selectedMedia || []).find(m => m.filename === vid.filename) ? 'border-hq-accent' : 'border-hq-border'">
                      <!-- 선택 체크박스 -->
                      <div x-show="sns.mediaSelectMode" class="absolute top-1.5 left-1.5 z-10 cursor-pointer"
                           @click.stop="toggleMediaItem('videos', vid)">
                        <div class="w-5 h-5 rounded-md border-2 flex items-center justify-center text-xs"
                          :class="(sns.selectedMedia || []).find(m => m.filename === vid.filename) ? 'bg-hq-accent border-hq-accent text-white' : 'border-hq-muted bg-black/40'">
                          <span x-show="(sns.selectedMedia || []).find(m => m.filename === vid.filename)">&#10003;</span>
                        </div>
                      </div>
                      <video :src="vid.url" class="w-full h-40 object-cover" controls preload="metadata"></video>
                      <div class="px-2 py-1.5">
                        <div class="text-[9px] text-hq-muted truncate" x-text="vid.filename"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <template x-if="(sns.mediaImages || []).length === 0 && (sns.mediaVideos || []).length === 0">
              <div class="text-center text-hq-muted/80 py-8">생성된 미디어가 없습니다. 에이전트에게 이미지/영상 생성을 요청해보세요.</div>
            </template>
          </div>

          <!-- SNS Tab 4: Events -->
          <div x-show="sns.tab === 'events' && !sns.loading">
            <div class="bg-hq-surface border border-hq-border/50 rounded-lg px-4 py-3 mb-4 text-xs text-hq-muted">
              SNS 이벤트는 연결된 플랫폼에서 발생한 활동 기록입니다. 게시물 발행, 댓글 알림, 팔로워 변동 등의 이벤트가 여기에 자동으로 기록됩니다.
            </div>
            <div class="space-y-2">
              <template x-for="(event, i) in sns.events" :key="i">
                <div class="glass border border-hq-border rounded-xl px-4 py-3">
                  <div class="flex items-center gap-3">
                    <span class="text-[10px] font-mono text-hq-muted/85 shrink-0" x-text="event.time || event.timestamp || '-'"></span>
                    <span class="text-xs font-bold text-hq-cyan capitalize" x-text="event.platform || '-'"></span>
                    <span class="text-xs text-hq-text/90" x-text="event.type || event.event || '-'"></span>
                  </div>
                  <div x-show="event.data" class="text-[11px] text-hq-muted mt-1 truncate" x-text="typeof event.data === 'string' ? event.data : JSON.stringify(event.data || '').substring(0, 150)"></div>
                </div>
              </template>
              <template x-if="sns.events.length === 0">
                <div class="text-center text-hq-muted/80 py-8">이벤트가 없습니다</div>
              </template>
            </div>
          </div>

          <!-- SNS Tab 5: Cookie Management -->
          <div x-show="sns.tab === 'cookies'" x-cloak>
            <!-- 상태 카드 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
              <template x-for="p in ['naver', 'kakao']" :key="p">
                <div class="glass border rounded-xl p-4" :class="(sns.cookieStatus||{})[p]?.exists ? 'border-hq-green/30' : 'border-hq-border'">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-hq-text" x-text="p === 'naver' ? '네이버' : '카카오 (티스토리/다음카페)'"></span>
                    <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                      :class="(sns.cookieStatus||{})[p]?.exists ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-muted/10 text-hq-muted'"
                      x-text="(sns.cookieStatus||{})[p]?.exists ? '등록됨' : '미등록'"></span>
                  </div>
                  <div x-show="(sns.cookieStatus||{})[p]?.exists" class="text-[10px] text-hq-muted/70 space-y-1 mb-3">
                    <div>쿠키 수: <span class="text-hq-text" x-text="(sns.cookieStatus||{})[p]?.cookie_count || 0"></span>개</div>
                    <div>등록일: <span class="text-hq-text" x-text="((sns.cookieStatus||{})[p]?.uploaded_at || '').substring(0,10)"></span></div>
                    <div>만료 예상: <span class="text-hq-text" x-text="(sns.cookieStatus||{})[p]?.estimated_expiry || '—'"></span></div>
                    <div x-show="(sns.cookieStatus||{})[p]?.expiry_warning" class="text-hq-yellow font-semibold">⚠️ 곧 만료 — 재등록 필요</div>
                  </div>
                  <button x-show="(sns.cookieStatus||{})[p]?.exists" @click="deleteSNSCookie(p)" class="text-[10px] text-hq-red/70 hover:text-hq-red transition">삭제</button>
                </div>
              </template>
            </div>

            <!-- 업로드 영역 -->
            <div class="glass border border-hq-border rounded-xl p-5 mb-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">쿠키 등록</h3>
              <div class="space-y-3">
                <select x-model="sns.cookiePlatform" class="bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text w-full">
                  <option value="naver">네이버 (naver.com)</option>
                  <option value="kakao">카카오 (kakao.com / daum.net / tistory.com)</option>
                </select>
                <textarea x-model="sns.cookieJson" rows="5" placeholder="Cookie-Editor에서 Export한 JSON을 여기에 붙여넣기" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text font-mono resize-y focus:border-hq-accent/50 outline-none transition"></textarea>
                <button @click="uploadSNSCookies()" class="bg-hq-accent hover:bg-hq-accent/80 text-white rounded-lg px-4 py-2 text-sm font-semibold transition w-full sm:w-auto">등록하기</button>
              </div>
            </div>

            <!-- 가이드 -->
            <div class="glass border border-hq-border/50 rounded-xl p-5">
              <h3 class="text-sm font-bold text-hq-text mb-3">쿠키 등록 가이드</h3>
              <div class="text-xs text-hq-muted space-y-3">
                <div>
                  <span class="font-bold text-hq-text">1단계: Cookie-Editor 확장 설치</span>
                  <div class="pl-4 mt-1">Chrome에서 <a href="https://chromewebstore.google.com/detail/cookie-editor/hlkenndednhfkekhgcdicdfddnkalmdm" target="_blank" class="text-hq-accent underline">Cookie-Editor</a> 설치 (1회)</div>
                </div>
                <div>
                  <span class="font-bold text-hq-text">2단계: 로그인 후 쿠키 추출</span>
                  <div class="pl-4 mt-1 space-y-1">
                    <div>네이버: <a href="https://www.naver.com" target="_blank" class="text-hq-accent underline">naver.com</a> 로그인 → Cookie-Editor 아이콘 → <strong>Export (JSON)</strong> 클릭</div>
                    <div>카카오: <a href="https://accounts.kakao.com" target="_blank" class="text-hq-accent underline">accounts.kakao.com</a> 로그인 → Cookie-Editor → <strong>Export (JSON)</strong></div>
                  </div>
                </div>
                <div>
                  <span class="font-bold text-hq-text">3단계: 위 입력란에 붙여넣기 → 등록하기</span>
                  <div class="pl-4 mt-1 text-hq-muted/60">유효기간: 네이버 ~90일, 카카오 ~30일. 만료 시 재등록.</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div></template>

      <!-- ═══ TRADING OPS (전략실) 탭 ═══ -->
      <template x-if="viewMode === 'chat' && activeTab === 'trading'"><div class="flex-1 overflow-y-auto scrollbar-thin p-6 bg-grid tab-content-padded">
        <div class="max-w-6xl mx-auto fade-in-up">

          <!-- 헤더 -->
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 md:mb-6 gap-3">
            <div>
              <h2 class="text-base md:text-lg font-bold text-hq-text font-mono tracking-normal">TRADING OPS</h2>
              <p class="text-xs text-hq-muted">
                한국투자증권 자동매매 —
                <span :class="(trading.summary.settings||{}).kis_connected ? 'text-hq-green' : 'text-hq-muted/60'"
                      x-text="(trading.summary.settings||{}).kis_connected ? 'KIS 연결됨' : 'KIS 미연결'"></span>
                <span x-show="trading.lastRefresh" class="text-hq-muted/50 ml-2" x-text="'· ' + trading.lastRefresh + ' 기준'"></span>
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button @click="trading.showOrderModal = true" class="bg-hq-green/20 text-hq-green hover:bg-hq-green/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">
                📈 주문 실행
              </button>
              <button @click="resetTradingPortfolio()" class="bg-hq-red/10 text-hq-red/70 hover:bg-hq-red/20 hover:text-hq-red rounded-lg px-3 py-1.5 text-xs font-semibold transition">
                🗑️ 초기화
              </button>
              <button @click="trading.showSettingsModal = true; trading.settings = {...(trading.summary.settings || {})}" class="bg-hq-surface border border-hq-border hover:border-hq-accent/30 rounded-lg px-3 py-1.5 text-xs text-hq-muted transition">
                ⚙️ 설정
              </button>
            </div>
          </div>

          <!-- 서브 탭 -->
          <div class="flex gap-2 mb-4 md:mb-6 overflow-x-auto scrollbar-thin pb-1 -mx-1 px-1">
            <template x-for="tab in [{id:'dashboard',l:'대시보드'},{id:'actlog',l:'교신로그'},{id:'shadow',l:'실거래/모의 비교'},{id:'portfolio',l:'포트폴리오'},{id:'watchlist',l:'관심종목'},{id:'history',l:'거래내역'},{id:'signals',l:'시그널'},{id:'plan',l:'작전계획'},{id:'performance',l:'금융분석팀장 성과'}]" :key="tab.id">
              <button @click="trading.tab = tab.id" :class="trading.tab === tab.id ? 'bg-hq-accent/20 text-hq-accent border-hq-accent/30' : 'text-hq-muted border-transparent hover:text-hq-text'" class="px-3 py-1.5 text-xs font-semibold rounded-lg border transition whitespace-nowrap shrink-0" x-text="tab.l"></button>
            </template>
          </div>

          <template x-if="trading.loading">
            <div class="text-center py-12 text-hq-muted">로딩 중...</div>
          </template>

          <!-- ▸ 서브탭 1: 대시보드 -->
          <div x-show="trading.tab === 'dashboard' && !trading.loading">

            <!-- CIO 자동매매 배너 (최상단) -->
            <div class="glass border rounded-xl p-3 md:p-4 mb-4 flex flex-col md:flex-row md:items-center justify-between gap-3"
                 :class="trading.botActive ? 'border-hq-green/40 bg-hq-green/[0.05]' : 'border-hq-border'">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full" :class="trading.botActive ? 'bg-hq-green animate-pulse' : 'bg-hq-muted/30'"></div>
                <div>
                  <span class="text-sm font-bold" :class="trading.botActive ? 'text-hq-green' : 'text-hq-muted'"
                        x-text="trading.botActive ? '금융분석팀장 자동매매 : 가동 중' : '금융분석팀장 자동매매 : 대기'"></span>
                  <p class="text-[10px] text-hq-muted"
                     x-text="trading.botActive ? `투자팀장이 하루 2회 관심종목 분석 중 (09:10 한국장 · ${trading.schedule?.us_time || '23:40'} 미국장 ${trading.schedule?.us_tz || ''})` : '자동매매가 꺼져 있습니다. 설정에서 켜세요.'"></p>
                </div>
              </div>
              <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                <span class="text-[10px] px-2 py-1 rounded-full border"
                      :class="(() => { const s = trading.summary.settings||{}; if(s.enable_real && !s.paper_trading) return 'border-hq-green/30 bg-hq-green/10 text-hq-green'; if(s.enable_mock) return 'border-hq-purple/30 bg-hq-purple/10 text-hq-purple'; return 'border-hq-accent/30 bg-hq-accent/10 text-hq-accent'; })()"
                      x-text="(() => { const s = trading.summary.settings||{}; if(s.enable_real && !s.paper_trading) return '실거래'; if(s.enable_mock) return '모의투자'; return '가상투자'; })()"></span>
                <span class="text-[10px] px-2 py-1 rounded-full border"
                      :class="(trading.summary.settings||{}).kis_connected ? 'border-hq-green/30 bg-hq-green/10 text-hq-green' : 'border-hq-muted/30 bg-hq-muted/10 text-hq-muted'"
                      x-text="(trading.summary.settings||{}).kis_connected ? 'KIS 연결' : 'KIS 미연결'"></span>
                <div class="w-px h-4 bg-hq-border/50 mx-1 hidden md:block"></div>
                <button @click="runTradingNow()" :disabled="trading.runningNow"
                        class="rounded-lg px-4 py-1.5 text-xs font-bold transition bg-hq-accent text-hq-bg hover:bg-hq-accent/90 shadow-lg shadow-hq-accent/20 disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none flex items-center gap-1.5">
                  <svg x-show="trading.runningNow" class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                  </svg>
                  <span x-text="trading.runningNow ? '분석 중...' : '즉시 분석·매매결정'"></span>
                </button>
                <button @click="toggleTradingBot()" class="rounded-lg px-4 py-1.5 text-xs font-bold transition"
                        :class="trading.botActive ? 'bg-hq-red/20 text-hq-red hover:bg-hq-red/30' : 'bg-hq-green/20 text-hq-green hover:bg-hq-green/30'"
                        x-text="trading.botActive ? '중지' : '시작'"></button>
              </div>
            </div>

            <!-- ═══ MISSION CONTROL BOARD ═══ -->
            <div x-data="{
              mockBal: null, mockLoading: false,
              usBal: null, usLoading: false,
              usMockBal: null,
              fxRate: 1450,
              async loadMissionData() {
                this.mockLoading = true; this.usLoading = true;
                try {
                  const [mockR, usR, usMockR] = await Promise.allSettled([
                    fetch('/api/trading/mock/balance').then(r=>r.json()),
                    fetch('/api/trading/overseas/balance').then(r=>r.json()),
                    fetch('/api/trading/overseas/mock-balance').then(r=>r.json())
                  ]);
                  this.mockBal = mockR.status==='fulfilled' ? mockR.value : {available:false};
                  this.usBal = usR.status==='fulfilled' ? usR.value : {available:false};
                  this.usMockBal = usMockR.status==='fulfilled' ? usMockR.value : {available:false};
                } catch(e) {}
                this.mockLoading = false; this.usLoading = false;
              },
              krTotal() {
                const kis = (trading.summary.kis_balance||{});
                if (kis.success) {
                  // 한국 보유종목+현금만 (total_eval은 해외자산 원화환산 포함 → usTotal과 이중 계산됨)
                  const hEval = (kis.holdings||[]).reduce((s,h) => s + (h.qty||0)*(h.current_price||0), 0);
                  return (kis.cash || 0) + hEval;
                }
                if (this.mockBal && this.mockBal.available) return this.mockBal.total_eval || this.mockBal.cash || 0;
                return 0;
              },
              usTotal() {
                if(this.usBal&&this.usBal.success) return this.usBal.total_eval_usd || this.usBal.cash_usd || 0;
                if(this.usMockBal&&this.usMockBal.success) return this.usMockBal.total_eval_usd || this.usMockBal.cash_usd || 0;
                return 0;
              },
              grandTotal() { return this.krTotal() + Math.round(this.usTotal() * this.fxRate); },
              fmtKRW(v) { return '₩' + Math.round(v||0).toLocaleString(); },
              fmtUSD(v) { return '$' + (v||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); },
              fmtDual(krw, usd) { return this.fmtKRW(krw) + ' / ' + this.fmtUSD(usd); }
            }" x-init="loadMissionData(); fetch('/api/delegation-log?division=cio&limit=20').then(r=>r.ok?r.json():[]).then(d=>{$root.trading.cioLogs=Array.isArray(d)?d:[];}).catch(()=>{})">

              <!-- KPI 카드 4개 (C안: 확대 버전) -->
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-3 mb-4">
                <!-- 총자산 -->
                <div class="glass border border-hq-accent/20 rounded-xl p-5 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-16 h-16 bg-hq-accent/5 rounded-bl-full"></div>
                  <div class="text-xs text-hq-muted mb-1">총자산 (한국+미국)</div>
                  <div class="text-xl lg:text-2xl font-bold font-mono text-hq-accent" x-text="fmtKRW(grandTotal())"></div>
                  <div class="text-xs text-hq-muted/70 font-mono mt-1" x-text="usTotal() > 0 ? fmtUSD(usTotal()) + ' 포함' : '한국장만'"></div>
                </div>
                <!-- 오늘 손익 -->
                <div class="glass border border-hq-border rounded-xl p-5 relative overflow-hidden">
                  <div class="text-xs text-hq-muted mb-1">오늘 손익</div>
                  <div class="text-xl lg:text-2xl font-bold font-mono"
                       :class="((trading.summary.today||{}).pnl||0) >= 0 ? 'text-hq-green' : 'text-hq-red'"
                       x-text="(((trading.summary.today||{}).pnl||0) >= 0 ? '+' : '') + fmtKRW((trading.summary.today||{}).pnl||0)"></div>
                  <div class="text-xs text-hq-muted/70 mt-1" x-text="'거래 ' + ((trading.summary.today||{}).trades||0) + '건'"></div>
                </div>
                <!-- 수익률 -->
                <div class="glass border border-hq-border rounded-xl p-5 relative overflow-hidden">
                  <div class="text-xs text-hq-muted mb-1">누적 수익률</div>
                  <div class="text-xl lg:text-2xl font-bold font-mono"
                       :class="((trading.summary.portfolio||{}).total_return||0) >= 0 ? 'text-hq-green' : 'text-hq-red'"
                       x-text="(((trading.summary.portfolio||{}).total_return||0) >= 0 ? '+' : '') + ((trading.summary.portfolio||{}).total_return||0).toFixed(2) + '%'"></div>
                  <div class="text-xs text-hq-muted/70 mt-1" x-text="(trading.summary.portfolio||{}).win_rate ? '승률 ' + ((trading.summary.portfolio||{}).win_rate||0).toFixed(0) + '%' : ''"></div>
                </div>
                <!-- 환율 -->
                <div class="glass border border-hq-border rounded-xl p-5 relative overflow-hidden">
                  <div class="text-xs text-hq-muted mb-1">USD/KRW 환율</div>
                  <div class="text-xl lg:text-2xl font-bold font-mono text-hq-cyan" x-text="'₩' + fxRate.toLocaleString()"></div>
                  <div class="text-xs text-hq-muted/70 mt-1">기준환율</div>
                </div>
              </div>

              <!-- ═══ C안: 2행 2열 (실거래/모의 × 한국/미국) ═══ -->
              <!-- Row 1: 실거래 -->
              <div class="mb-2 mt-1 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-hq-green"></div>
                <span class="text-sm font-bold text-hq-green">실거래</span>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- 실거래 한국장 -->
                <div class="glass border border-l-4 border-hq-green/20 border-l-hq-green rounded-xl p-3 lg:p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1.5">
                      <span class="text-sm">🇰🇷</span>
                      <span class="text-sm font-bold text-hq-green">한국장</span>
                    </div>
                    <span class="text-[10px] px-1.5 py-0.5 rounded-full border"
                          :class="(trading.summary.settings||{}).kis_connected ? 'border-hq-green/30 bg-hq-green/10 text-hq-green' : 'border-hq-muted/30 text-hq-muted'"
                          x-text="(trading.summary.settings||{}).kis_connected ? 'KIS 연결' : 'KIS 미연결'"></span>
                  </div>
                  <div class="text-xl lg:text-2xl font-bold font-mono text-hq-text"
                       x-text="fmtKRW(((trading.summary.kis_balance||{}).cash || 0) + ((trading.summary.kis_balance||{}).holdings||[]).reduce((s,h) => s + (h.qty||0)*(h.current_price||0), 0))"></div>
                  <div class="flex items-center gap-3 mt-1 text-xs text-hq-muted">
                    <span x-text="'현금 ' + fmtKRW((trading.summary.kis_balance||{}).cash || 0)"></span>
                    <span x-text="'보유 ' + ((trading.summary.kis_balance||{}).holdings||[]).length + '종목'"></span>
                  </div>
                  <div class="mt-2 space-y-1">
                    <template x-for="h in ((trading.summary.kis_balance||{}).holdings||[]).slice(0,3)" :key="h.ticker">
                      <div class="flex items-center justify-between bg-hq-surface/50 rounded px-2 py-1 cursor-pointer hover:bg-hq-accent/10 transition"
                           @click="openStockChart && openStockChart(h.ticker, h.name, 'KR')">
                        <div class="text-xs font-semibold text-hq-text truncate max-w-[120px]" x-text="h.name"></div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-mono text-hq-text" x-text="fmtKRW(h.current_price)"></span>
                          <span class="text-xs font-mono" :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'"
                                x-text="((h.eval_profit||0)>=0?'+':'') + fmtKRW(h.eval_profit||0)"></span>
                        </div>
                      </div>
                    </template>
                    <template x-if="((trading.summary.kis_balance||{}).holdings||[]).length === 0">
                      <div class="text-xs text-hq-muted/50 text-center py-2">실거래 보유종목 없음</div>
                    </template>
                  </div>
                </div>
                <!-- 실거래 미국장 -->
                <div class="glass border border-l-4 border-hq-cyan/20 border-l-hq-cyan rounded-xl p-3 lg:p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1.5">
                      <span class="text-sm">🇺🇸</span>
                      <span class="text-sm font-bold text-hq-cyan">미국장</span>
                    </div>
                    <span class="text-[10px] px-1.5 py-0.5 rounded-full border"
                          :class="(usBal&&usBal.success) ? 'border-hq-cyan/30 bg-hq-cyan/10 text-hq-cyan' : 'border-hq-muted/30 text-hq-muted'"
                          x-text="(usBal&&usBal.success) ? 'KIS 연결' : '미연결'"></span>
                  </div>
                  <div class="flex items-baseline gap-2">
                    <span class="text-xl lg:text-2xl font-bold font-mono text-hq-text" x-text="fmtUSD(usTotal())"></span>
                    <span class="text-xs font-mono text-hq-muted" x-text="usTotal() > 0 ? '≈ ' + fmtKRW(usTotal() * fxRate) : ''"></span>
                  </div>
                  <div class="flex items-center gap-3 mt-1 text-xs text-hq-muted">
                    <span x-text="'현금 ' + fmtUSD((usBal||{}).cash_usd || 0)"></span>
                    <span x-text="'보유 ' + ((usBal||{}).holdings||[]).length + '종목'"></span>
                  </div>
                  <div class="mt-2 space-y-1">
                    <template x-for="h in ((usBal||{}).holdings||[]).slice(0,3)" :key="h.symbol">
                      <div class="flex items-center justify-between bg-hq-surface/50 rounded px-2 py-1 cursor-pointer hover:bg-hq-accent/10 transition"
                           @click="openStockChart && openStockChart(h.symbol, h.name, 'US')">
                        <div class="flex items-center gap-1.5">
                          <span class="text-xs font-semibold text-hq-text" x-text="h.symbol"></span>
                          <span class="text-[10px] text-hq-muted truncate max-w-[80px]" x-text="h.name"></span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-mono text-hq-text" x-text="fmtUSD(h.current_price)"></span>
                          <span class="text-xs font-mono" :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'"
                                x-text="((h.eval_profit||0)>=0?'+':'') + fmtUSD(h.eval_profit||0)"></span>
                        </div>
                      </div>
                    </template>
                    <template x-if="((usBal||{}).holdings||[]).length === 0">
                      <div class="text-xs text-hq-muted/50 text-center py-2">실거래 보유종목 없음</div>
                    </template>
                  </div>
                </div>
              </div>
              <!-- Row 2: 모의투자 -->
              <div class="mb-2 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-hq-purple"></div>
                <span class="text-sm font-bold text-hq-purple">모의투자</span>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- 모의투자 한국장 -->
                <div class="glass border border-l-4 border-hq-purple/20 border-l-hq-purple rounded-xl p-3 lg:p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1.5">
                      <span class="text-sm">🇰🇷</span>
                      <span class="text-sm font-bold text-hq-purple">한국장</span>
                    </div>
                    <span class="text-[10px] px-1.5 py-0.5 rounded-full border border-hq-purple/30 bg-hq-purple/10 text-hq-purple">모의</span>
                  </div>
                  <div class="text-xl lg:text-2xl font-bold font-mono text-hq-text"
                       x-text="fmtKRW((mockBal||{}).total_eval || (mockBal||{}).cash || 0)"></div>
                  <div class="flex items-center gap-3 mt-1 text-xs text-hq-muted">
                    <span x-text="'현금 ' + fmtKRW((mockBal||{}).cash || 0)"></span>
                    <span x-text="'보유 ' + ((mockBal||{}).holdings||[]).length + '종목'"></span>
                  </div>
                  <div class="mt-2 space-y-1">
                    <template x-for="h in ((mockBal||{}).holdings||[]).slice(0,3)" :key="h.ticker">
                      <div class="flex items-center justify-between bg-hq-surface/50 rounded px-2 py-1 cursor-pointer hover:bg-hq-accent/10 transition"
                           @click="openStockChart && openStockChart(h.ticker, h.name, 'KR')">
                        <div class="text-xs font-semibold text-hq-text truncate max-w-[120px]" x-text="h.name"></div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-mono text-hq-text" x-text="fmtKRW(h.current_price)"></span>
                          <span class="text-xs font-mono" :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'"
                                x-text="((h.eval_profit||0)>=0?'+':'') + fmtKRW(h.eval_profit||0)"></span>
                        </div>
                      </div>
                    </template>
                    <template x-if="((mockBal||{}).holdings||[]).length === 0">
                      <div class="text-xs text-hq-muted/50 text-center py-2">모의 보유종목 없음</div>
                    </template>
                  </div>
                </div>
                <!-- 모의투자 미국장 -->
                <div class="glass border border-l-4 border-hq-purple/20 border-l-hq-purple rounded-xl p-3 lg:p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1.5">
                      <span class="text-sm">🇺🇸</span>
                      <span class="text-sm font-bold text-hq-purple">미국장</span>
                    </div>
                    <span class="text-[10px] px-1.5 py-0.5 rounded-full border border-hq-purple/30 bg-hq-purple/10 text-hq-purple">모의</span>
                  </div>
                  <div class="flex items-baseline gap-2">
                    <span class="text-xl lg:text-2xl font-bold font-mono text-hq-text"
                          x-text="fmtUSD((usMockBal||{}).total_eval_usd || (usMockBal||{}).cash_usd || 0)"></span>
                    <span class="text-xs font-mono text-hq-muted"
                          x-text="(usMockBal||{}).cash_usd ? '≈ ' + fmtKRW(((usMockBal||{}).total_eval_usd || (usMockBal||{}).cash_usd || 0) * fxRate) : ''"></span>
                  </div>
                  <div class="flex items-center gap-3 mt-1 text-xs text-hq-muted">
                    <span x-text="'현금 ' + fmtUSD((usMockBal||{}).cash_usd || 0)"></span>
                    <span x-text="'보유 ' + ((usMockBal||{}).holdings||[]).length + '종목'"></span>
                  </div>
                  <div class="mt-2 space-y-1">
                    <template x-for="h in ((usMockBal||{}).holdings||[]).slice(0,3)" :key="h.symbol">
                      <div class="flex items-center justify-between bg-hq-surface/50 rounded px-2 py-1 cursor-pointer hover:bg-hq-accent/10 transition"
                           @click="openStockChart && openStockChart(h.symbol, h.name, 'US')">
                        <div class="flex items-center gap-1.5">
                          <span class="text-xs font-semibold text-hq-text" x-text="h.symbol"></span>
                          <span class="text-[10px] text-hq-muted truncate max-w-[80px]" x-text="h.name"></span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-mono text-hq-text" x-text="fmtUSD(h.current_price)"></span>
                          <span class="text-xs font-mono" :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'"
                                x-text="((h.eval_profit||0)>=0?'+':'') + fmtUSD(h.eval_profit||0)"></span>
                        </div>
                      </div>
                    </template>
                    <template x-if="((usMockBal||{}).holdings||[]).length === 0">
                      <div class="text-xs text-hq-muted/50 text-center py-2">모의 보유종목 없음</div>
                    </template>
                  </div>
                </div>
              </div>

              <!-- 최근 거래 + 교신 로그 -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">

                <!-- 최근 거래 -->
                <div class="glass border border-hq-border rounded-xl p-5">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-hq-text">최근 거래</h3>
                    <span class="text-[11px] text-hq-muted" x-text="trading.history.length + '건'"></span>
                  </div>
                  <template x-if="trading.history.length === 0">
                    <div class="text-center text-hq-muted/50 py-6 text-xs">최근 거래 없음</div>
                  </template>
                  <div class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin">
                    <template x-for="t in trading.history.slice(0, 8)" :key="t.id">
                      <div class="flex items-center justify-between bg-hq-surface/50 rounded-lg px-3 py-2">
                        <div class="flex items-center gap-2">
                          <span class="text-[10px] font-bold px-2 py-0.5 rounded"
                                :class="t.action === 'buy' ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-red/10 text-hq-red'"
                                x-text="t.action === 'buy' ? '매수' : '매도'"></span>
                          <span class="text-xs font-semibold text-hq-text" x-text="t.name"></span>
                          <span class="text-[10px] text-hq-muted" x-text="t.qty + '주'"></span>
                        </div>
                        <div class="text-right">
                          <span class="text-[11px] font-mono text-hq-text" x-text="(t.market==='US'?fmtUSD(t.total):fmtKRW(t.total||0))"></span>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>

              </div>

              <!-- 모의투자 연결 상태 바 (슬리피지는 실/모의 탭에서 확인) -->
              <div class="glass border border-hq-border rounded-xl px-4 py-2 flex items-center justify-between mb-1">
                <div class="flex items-center gap-3">
                  <span class="text-[10px] text-hq-muted">실거래 vs 모의투자</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-full"
                        :class="(mockBal&&mockBal.available) ? ((mockBal.mode||'').includes('Paper') ? 'bg-hq-surface text-hq-muted/70 border border-hq-border' : 'bg-hq-purple/10 text-hq-purple border border-hq-purple/20') : 'bg-hq-surface text-hq-muted/50'"
                        x-text="(mockBal&&mockBal.available) ? ((mockBal.mode||'').includes('Paper') ? '가상: ' + fmtKRW(mockBal.total_eval||0) : '모의: ' + fmtKRW(mockBal.total_eval||0)) : '모의 미연결'"></span>
                </div>
                <span class="text-[10px] text-hq-muted/50"
                      x-text="(mockBal&&mockBal.available) ? '비교 → 실/모의 탭' : '양쪽 연결 시 비교 가능'"></span>
              </div>
            </div>
            <!-- /MISSION CONTROL BOARD -->

          </div>

          <!-- ▸ 서브탭: 교신로그 (CIO팀 전용) -->
          <div x-show="trading.tab === 'actlog' && !trading.loading">
            <div x-effect="if(trading.tab === 'actlog') loadCioActivityLog()"></div>

            <!-- 헤더 + 4탭 -->
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
              <div class="flex items-center gap-3 md:gap-4">
                <h3 class="text-sm font-bold text-hq-text flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full" :class="trading.runningNow ? 'bg-hq-yellow animate-pulse' : 'bg-hq-accent'"></span>
                  금융분석팀 통신로그
                </h3>
                <span x-show="trading.runningNow" class="text-[10px] text-hq-yellow animate-pulse font-semibold">● LIVE</span>
                <!-- 4탭 -->
                <div class="flex bg-hq-surface border border-hq-border rounded-lg overflow-hidden flex-wrap">
                  <button @click="trading.activityLog.subTab = 'activity'"
                          :class="trading.activityLog.subTab === 'activity' ? 'bg-hq-accent/20 text-hq-accent font-bold' : 'text-hq-muted hover:text-hq-text'"
                          class="px-3 py-1.5 text-xs font-semibold transition">
                    📋 활동 <span class="font-mono ml-1" x-text="trading.activityLog.logs.filter(l => l.level !== 'tool' && l.level !== 'qa_pass' && l.level !== 'qa_fail' && l.type !== 'delegation' && l.type !== 'report').length"></span>
                  </button>
                  <button @click="trading.activityLog.subTab = 'comms'"
                          :class="trading.activityLog.subTab === 'comms' ? 'bg-hq-cyan/20 text-hq-cyan font-bold' : 'text-hq-muted hover:text-hq-text'"
                          class="px-3 py-1.5 text-xs font-semibold transition border-l border-hq-border">
                    💬 교신 <span class="font-mono ml-1" x-text="trading.activityLog.logs.filter(l => l.type === 'delegation' || l.type === 'report').length"></span>
                  </button>
                  <button @click="trading.activityLog.subTab = 'qa'"
                          :class="trading.activityLog.subTab === 'qa' ? 'bg-hq-green/20 text-hq-green font-bold' : 'text-hq-muted hover:text-hq-text'"
                          class="px-3 py-1.5 text-xs font-semibold transition border-l border-hq-border">
                    ✅ 검수 <span class="font-mono ml-1" x-text="trading.activityLog.logs.filter(l => l.level === 'qa_pass' || l.level === 'qa_fail').length"></span>
                  </button>
                  <button @click="trading.activityLog.subTab = 'tools'"
                          :class="trading.activityLog.subTab === 'tools' ? 'bg-hq-orange/20 text-hq-orange font-bold' : 'text-hq-muted hover:text-hq-text'"
                          class="px-3 py-1.5 text-xs font-semibold transition border-l border-hq-border">
                    🔧 도구 <span class="font-mono ml-1" x-text="trading.activityLog.logs.filter(l => (l.tools || []).length > 0 || l.level === 'tool').length"></span>
                  </button>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button @click="loadCioActivityLog()" class="bg-hq-surface border border-hq-border hover:border-hq-accent/30 rounded-lg px-3 py-1.5 text-xs text-hq-muted transition">새로고침</button>
                <button @click="showConfirm({ title: '로그 삭제', message: '이 탭의 로그를 삭제할까요?', confirmText: '삭제', onConfirm: () => clearCioLogsTab(trading.activityLog.subTab) })" title="현재 탭 전체삭제"
                        class="text-hq-muted hover:text-hq-red transition p-1 rounded">🗑️</button>
              </div>
            </div>

            <!-- 로딩 -->
            <div x-show="trading.activityLog.loading" class="flex items-center justify-center py-12">
              <div class="w-5 h-5 border-2 border-hq-accent border-t-transparent rounded-full animate-spin mr-2"></div>
              <span class="text-xs text-hq-muted">로그 조회 중...</span>
            </div>

            <!-- 빈 상태 -->
            <template x-if="!trading.activityLog.loading && getFilteredCioLogs().length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted/50 text-xs">아직 금융분석팀 활동 기록이 없습니다</p>
                <p class="text-hq-muted/30 text-[10px] mt-1">"즉시 분석" 실행 시 실시간으로 기록됩니다</p>
              </div>
            </template>

            <!-- 로그 타임라인 -->
            <div x-show="!trading.activityLog.loading && getFilteredCioLogs().length > 0" class="relative pl-6">
              <!-- 타임라인 세로선 -->
              <div class="absolute left-[11px] top-2 bottom-2 w-px bg-gradient-to-b from-hq-cyan/30 via-hq-border/20 to-transparent"></div>
              <template x-for="(log, i) in getFilteredCioLogs()" :key="log.id">
                <div class="relative mb-2">
                  <!-- 타임라인 도트 -->
                  <div class="absolute left-[-21px] top-3 w-2.5 h-2.5 rounded-full border-2 border-hq-bg z-10"
                       :class="{
                         'bg-hq-yellow': log.type === 'delegation',
                         'bg-hq-green': log.type === 'report',
                         'bg-hq-cyan': log.type === 'activity',
                         'bg-hq-orange': log.level === 'tool',
                         'bg-hq-accent': !['delegation','report','activity'].includes(log.type) && log.level !== 'tool'
                       }"></div>
                  <div class="bg-hq-panel/40 border border-hq-border/15 rounded-xl px-4 py-3 hover:border-hq-accent/20 transition group">
                    <div class="flex items-start gap-2">
                      <!-- 아이콘 -->
                      <span class="text-sm mt-0.5 shrink-0 w-5 text-center" x-text="getCioLogIcon(log)"></span>

                      <!-- 본문 -->
                      <div class="flex-1 min-w-0">
                        <!-- 발신/수신 -->
                        <div class="flex items-center gap-1.5 mb-0.5">
                          <span class="text-xs font-bold shrink-0" :class="getCioLogColor(log)"
                                x-text="getCioShortName(log.sender)"></span>
                          <template x-if="log.receiver">
                            <span class="flex items-center gap-1">
                              <span class="text-[10px] text-hq-muted/40" x-text="log.type === 'report' ? '→' : '⇢'"></span>
                              <span class="text-[11px] text-hq-muted/60 shrink-0"
                                    x-text="getCioShortName(log.receiver)"></span>
                            </span>
                          </template>
                          <span class="text-[10px] text-hq-muted/40 ml-auto shrink-0" x-text="formatLogTime(log.time)"></span>
                        </div>

                        <!-- 메시지 (접이식) -->
                        <p class="text-xs text-hq-muted leading-relaxed cursor-pointer"
                           :class="log._expanded ? '' : 'line-clamp-2'"
                           @click="log._expanded = !log._expanded"
                           x-text="stripMarkdownPreview(log.message)"></p>

                        <!-- 도구 사용 태그 -->
                        <template x-if="log.tools && log.tools.length > 0">
                          <div class="flex flex-wrap gap-1 mt-1.5">
                            <template x-for="tool in log.tools" :key="tool">
                              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-hq-accent/10 border border-hq-accent/20 text-[11px] text-hq-accent font-mono">
                                <span class="text-[10px]">🔧</span>
                                <span x-text="tool"></span>
                              </span>
                            </template>
                          </div>
                        </template>
                      </div>

                      <!-- 타입 뱃지 -->
                      <span class="text-[10px] px-1.5 py-0.5 rounded-full shrink-0 mt-0.5"
                            :class="{
                              'bg-hq-yellow/10 text-hq-yellow': log.type === 'delegation',
                              'bg-hq-green/10 text-hq-green': log.type === 'report',
                              'bg-hq-accent/10 text-hq-accent': log.type === 'activity',
                            }"
                            x-text="log.type === 'delegation' ? '위임' : log.type === 'report' ? '보고' : '활동'"></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- 통계 요약 -->
            <div x-show="!trading.activityLog.loading && trading.activityLog.logs.length > 0" class="mt-4 glass border border-hq-border rounded-xl p-3">
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-center">
                <div>
                  <p class="text-lg font-bold text-hq-text" x-text="trading.activityLog.logs.length"></p>
                  <p class="text-[9px] text-hq-muted">전체</p>
                </div>
                <div>
                  <p class="text-lg font-bold text-hq-accent" x-text="trading.activityLog.logs.filter(l => l.type !== 'delegation' && l.type !== 'report' && l.level !== 'qa_pass' && l.level !== 'qa_fail' && l.level !== 'tool').length"></p>
                  <p class="text-[9px] text-hq-muted">활동</p>
                </div>
                <div>
                  <p class="text-lg font-bold text-hq-yellow" x-text="trading.activityLog.logs.filter(l => l.type === 'delegation' || l.type === 'report').length"></p>
                  <p class="text-[9px] text-hq-muted">교신</p>
                </div>
                <div>
                  <p class="text-lg font-bold text-hq-cyan" x-text="trading.activityLog.logs.filter(l => l.level === 'qa_pass' || l.level === 'qa_fail').length"></p>
                  <p class="text-[9px] text-hq-muted">검수</p>
                </div>
                <div>
                  <p class="text-lg font-bold text-hq-orange" x-text="trading.activityLog.logs.filter(l => l.level === 'tool').length"></p>
                  <p class="text-[9px] text-hq-muted">도구</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ▸ 서브탭 2: 포트폴리오 (C안 — 한국장+미국장 분리) -->
          <div x-show="trading.tab === 'portfolio' && !trading.loading"
               x-data="{
                 port: null, portLoading: false, portError: '',
                 snapHistory: [],
                 newInitialKrw: null, newInitialUsd: null, newTotalDeposit: null,
                 async loadPortfolio() {
                   this.portLoading = true; this.portError = '';
                   try {
                     const [p, h] = await Promise.all([
                       fetch('/api/trading/portfolio').then(r => r.json()),
                       fetch('/api/trading/portfolio/history').then(r => r.json()),
                     ]);
                     this.port = p;
                     this.snapHistory = (h.snapshots || []).slice(-30);
                   } catch(e) { this.portError = e.message; }
                   finally { this.portLoading = false; }
                 },
                 fmtKRW(v) { if (!v && v !== 0) return '-'; return '₩' + Number(v).toLocaleString('ko-KR'); },
                 fmtUSD(v) { if (!v && v !== 0) return '-'; return '$' + Number(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); },
                 fmtPct(v) { return (v >= 0 ? '+' : '') + Number(v).toFixed(2) + '%'; },
                 get pieSlices() {
                   if (!this.port || !this.port.available) return [];
                   const kr = this.port.kr || {}, us = this.port.us || {};
                   const fx = this.port.fx_rate || 1450;
                   const krCash = kr.cash || 0, krHoldings = kr.holdings || [];
                   const usCashKrw = (us.cash_usd || 0) * fx, usHoldings = us.holdings || [];
                   const total = this.port.total_eval || 1;
                   const colors = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ef4444','#06b6d4','#f97316','#ec4899'];
                   let slices = [];
                   if (krCash > 0) slices.push({label:'현금(KR)', value: Math.round(krCash/total*1000)/10, color:'#3b82f6'});
                   if (usCashKrw > 0) slices.push({label:'현금(US)', value: Math.round(usCashKrw/total*1000)/10, color:'#60a5fa'});
                   krHoldings.forEach((h,i) => {
                     const pct = Math.round((h.qty * h.current_price)/total*1000)/10;
                     if (pct > 0) slices.push({label: (h.name||h.ticker)+' 🇰🇷', value: pct, color: colors[(i+2) % colors.length]});
                   });
                   usHoldings.forEach((h,i) => {
                     const evalKrw = h.qty * (h.current_price||0) * fx;
                     const pct = Math.round(evalKrw/total*1000)/10;
                     if (pct > 0) slices.push({label: (h.name||h.symbol)+' 🇺🇸', value: pct, color: colors[(i+4) % colors.length]});
                   });
                   return slices.length ? slices : [{label:'현금', value:100, color:'#3b82f6'}];
                 },
                 svgPie(slices) {
                   if (!slices.length) return '';
                   let paths = []; let cumPct = 0;
                   const cx=60, cy=60, r=55;
                   slices.forEach(s => {
                     const startAngle = (cumPct/100)*Math.PI*2 - Math.PI/2;
                     cumPct += s.value;
                     const endAngle = (cumPct/100)*Math.PI*2 - Math.PI/2;
                     const x1=cx+r*Math.cos(startAngle), y1=cy+r*Math.sin(startAngle);
                     const x2=cx+r*Math.cos(endAngle), y2=cy+r*Math.sin(endAngle);
                     const large = s.value > 50 ? 1 : 0;
                     if (s.value >= 99.9) { paths.push(`<circle cx='${cx}' cy='${cy}' r='${r}' fill='${s.color}'/>`); }
                     else { paths.push(`<path d='M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z' fill='${s.color}' opacity='0.85'/>`); }
                   });
                   return paths.join('');
                 },
                 get linePoints() {
                   if (!this.snapHistory.length) return '';
                   const vals = this.snapHistory.map(s => s.eval || s.cash || 0);
                   const min = Math.min(...vals), max = Math.max(...vals);
                   const range = max - min || 1;
                   const w=280, h=80;
                   return this.snapHistory.map((s,i) => {
                     const x = (i/(this.snapHistory.length-1||1))*w;
                     const y = h - ((( (s.eval||s.cash||0) - min)/range)*h*0.85 + h*0.05);
                     return `${x},${y}`;
                   }).join(' ');
                 },
                 get svgCircles() {
                   if (!this.snapHistory.length) return '';
                   const vals = this.snapHistory.map(s => s.eval || s.cash || 0);
                   const min = Math.min(...vals), max = Math.max(...vals);
                   const range = max - min || 1;
                   const w=280, h=80, color = this.lineColor;
                   return this.snapHistory.map((s,i) => {
                     const cx = (i/(this.snapHistory.length-1||1))*w;
                     const cy = h - ((( (s.eval||s.cash||0) - min)/range)*h*0.85 + h*0.05);
                     return '&lt;circle cx=&quot;' + cx + '&quot; cy=&quot;' + cy + '&quot; r=&quot;2.5&quot; fill=&quot;' + color + '&quot;/&gt;';
                   }).join('');
                 },
                 get lineColor() { if (!this.port) return '#3b82f6'; return (this.port.pnl || 0) >= 0 ? '#10b981' : '#ef4444'; }
               }"
               x-init="loadPortfolio()">

            <div x-effect="if(trading.tab === 'portfolio') loadPortfolio()"></div>

            <!-- 로딩 -->
            <div x-show="portLoading" class="text-center py-12 text-hq-muted text-sm">잔고 조회 중...</div>

            <!-- 에러 또는 미연결 -->
            <template x-if="!portLoading && (!port || !port.available)">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted text-sm" x-text="port?.reason || '실거래 API 미연결'"></p>
              </div>
            </template>

            <!-- 메인 콘텐츠 -->
            <template x-if="!portLoading && port && port.available">
              <div class="space-y-4">

                <!-- 총합 요약 카드 -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                  <div class="glass border border-hq-accent/30 rounded-xl p-4">
                    <p class="text-[10px] text-hq-muted mb-1">총 자산 (원화 환산)</p>
                    <p class="text-sm font-bold text-hq-text" x-text="fmtKRW(port.total_eval)"></p>
                    <p class="text-[9px] text-hq-muted/60 mt-0.5" x-text="'환율 ' + fmtKRW(port.fx_rate) + '/USD'"></p>
                  </div>
                  <div class="glass border border-hq-border rounded-xl p-4">
                    <p class="text-[10px] text-hq-muted mb-1">총 투자금</p>
                    <p class="text-sm font-bold text-hq-text" x-text="fmtKRW(port.initial_capital)"></p>
                  </div>
                  <div class="glass border border-hq-border rounded-xl p-4">
                    <p class="text-[10px] text-hq-muted mb-1">총 손익</p>
                    <p class="text-sm font-bold" :class="(port.pnl||0)>=0?'text-hq-green':'text-hq-red'"
                       x-text="fmtKRW(port.pnl) + ' (' + fmtPct(port.pnl_pct) + ')'"></p>
                  </div>
                  <div class="glass border border-hq-border rounded-xl p-4">
                    <p class="text-[10px] text-hq-muted mb-1">보유 현금</p>
                    <p class="text-xs font-bold text-hq-accent" x-text="fmtKRW(port.kr?.cash||0)"></p>
                    <p class="text-[9px] text-hq-muted mt-0.5" x-show="port.us?.cash_usd > 0" x-text="'+ ' + fmtUSD(port.us?.cash_usd)"></p>
                  </div>
                </div>

                <!-- 한국장 🇰🇷 / 미국장 🇺🇸 분리 카드 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  <!-- 한국장 -->
                  <div class="glass border border-red-500/20 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 border border-red-500/30">KR</span>
                      <h4 class="text-xs font-bold text-hq-text">한국장</h4>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                      <div><span class="text-hq-muted">투자금</span><p class="font-bold" x-text="fmtKRW(port.kr?.initial_capital||0)"></p></div>
                      <div><span class="text-hq-muted">평가금액</span><p class="font-bold" x-text="fmtKRW(port.kr?.total_eval||0)"></p></div>
                      <div><span class="text-hq-muted">손익</span>
                        <p class="font-bold" :class="(port.kr?.pnl||0)>=0?'text-hq-green':'text-hq-red'"
                           x-text="fmtKRW(port.kr?.pnl||0) + ' (' + fmtPct(port.kr?.pnl_pct||0) + ')'"></p></div>
                      <div><span class="text-hq-muted">종목 수</span><p class="font-bold" x-text="(port.kr?.holdings||[]).length + '개'"></p></div>
                    </div>
                    <!-- 보유 종목 -->
                    <template x-if="(port.kr?.holdings||[]).length > 0">
                      <div class="mt-3 space-y-1.5 border-t border-hq-border/30 pt-2">
                        <template x-for="h in port.kr.holdings" :key="h.ticker">
                          <div class="flex items-center justify-between text-[11px]">
                            <span class="text-hq-text" x-text="h.name||h.ticker"></span>
                            <span :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'" x-text="fmtKRW(h.eval_profit||0)"></span>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                  <!-- 미국장 -->
                  <div class="glass border border-blue-500/20 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30">US</span>
                      <h4 class="text-xs font-bold text-hq-text">미국장</h4>
                      <span x-show="!port.us?.available" class="text-[9px] text-hq-muted/50">(미연결)</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                      <div><span class="text-hq-muted">투자금</span><p class="font-bold" x-text="fmtUSD(port.us?.initial_capital_usd||0)"></p></div>
                      <div><span class="text-hq-muted">평가금액</span><p class="font-bold" x-text="fmtUSD(port.us?.total_eval_usd||0)"></p>
                        <p class="text-[9px] text-hq-muted" x-text="'≈ ' + fmtKRW(port.us?.total_eval_krw||0)"></p></div>
                      <div><span class="text-hq-muted">손익</span>
                        <p class="font-bold" :class="(port.us?.pnl_usd||0)>=0?'text-hq-green':'text-hq-red'"
                           x-text="fmtUSD(port.us?.pnl_usd||0) + ' (' + fmtPct(port.us?.pnl_pct||0) + ')'"></p></div>
                      <div><span class="text-hq-muted">종목 수</span><p class="font-bold" x-text="(port.us?.holdings||[]).length + '개'"></p></div>
                    </div>
                    <!-- 보유 종목 -->
                    <template x-if="(port.us?.holdings||[]).length > 0">
                      <div class="mt-3 space-y-1.5 border-t border-hq-border/30 pt-2">
                        <template x-for="h in port.us.holdings" :key="h.symbol">
                          <div class="flex items-center justify-between text-[11px]">
                            <span class="text-hq-text" x-text="h.name||h.symbol"></span>
                            <span :class="(h.eval_profit||0)>=0?'text-hq-green':'text-hq-red'" x-text="fmtUSD(h.eval_profit||0)"></span>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- 파이차트 + 자산 구성 -->
                <div class="glass border border-hq-border rounded-xl p-5">
                  <h3 class="text-sm font-bold text-hq-text mb-4">자산 구성</h3>
                  <div class="flex gap-6 items-center">
                    <div class="flex-shrink-0">
                      <svg width="120" height="120" viewBox="0 0 120 120" x-html="svgPie(pieSlices)"></svg>
                    </div>
                    <div class="flex-1 space-y-1.5">
                      <template x-for="slice in pieSlices" :key="slice.label">
                        <div class="flex items-center justify-between text-xs">
                          <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" :style="'background:'+slice.color"></div>
                            <span class="text-hq-text" x-text="slice.label"></span>
                          </div>
                          <span class="text-hq-muted" x-text="slice.value+'%'"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- 수익률 라인 차트 -->
                <div class="glass border border-hq-border rounded-xl p-5">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-hq-text">수익률 추이 (최근 30일)</h3>
                    <span class="text-[10px] text-hq-muted">데이터 누적 중</span>
                  </div>
                  <template x-if="snapHistory.length >= 2">
                    <div>
                      <svg width="100%" height="90" viewBox="0 0 280 90" preserveAspectRatio="none" class="w-full">
                        <line x1="0" y1="45" x2="280" y2="45" stroke="#374151" stroke-width="0.5" stroke-dasharray="4,4"/>
                        <polyline :points="linePoints" fill="none" :stroke="lineColor" stroke-width="2" stroke-linejoin="round"/>
                        <g x-html="svgCircles"></g>
                      </svg>
                      <div class="flex justify-between text-[9px] text-hq-muted mt-1">
                        <span x-text="snapHistory[0]?.date||''"></span>
                        <span x-text="snapHistory[snapHistory.length-1]?.date||''"></span>
                      </div>
                    </div>
                  </template>
                  <template x-if="snapHistory.length < 2">
                    <div class="text-center py-6 text-hq-muted/70 text-xs">
                      데이터가 쌓이면 차트가 표시됩니다 (현재 <span x-text="snapHistory.length"></span>일)
                    </div>
                  </template>
                </div>

                <!-- D-4: 입출금 기록 (토스형) -->
                <div class="glass border border-hq-border rounded-xl p-4"
                     x-data="{
                       txns: [], txnLoading: false,
                       showAddTxn: false,
                       txnType: 'deposit', txnAmount: null, txnCurrency: 'KRW', txnMemo: '',
                       async loadTxns() {
                         this.txnLoading = true;
                         try {
                           const r = await fetch('/api/trading/portfolio/transactions');
                           const d = await r.json();
                           this.txns = (d.transactions || []).reverse();
                         } catch(e) {}
                         this.txnLoading = false;
                       },
                       async addTxn() {
                         if (!this.txnAmount || this.txnAmount <= 0) return;
                         await fetch('/api/trading/portfolio/transactions', {
                           method: 'POST', headers: {'Content-Type': 'application/json'},
                           body: JSON.stringify({type: this.txnType, amount: this.txnAmount, currency: this.txnCurrency, memo: this.txnMemo})
                         });
                         this.txnAmount = null; this.txnMemo = ''; this.showAddTxn = false;
                         await this.loadTxns();
                         await loadPortfolio();
                       },
                       async deleteTxn(id) {
                         await fetch('/api/trading/portfolio/transactions/' + id, {method: 'DELETE'});
                         await this.loadTxns();
                         await loadPortfolio();
                       },
                       txnLabel(t) { return t === 'deposit' ? '입금' : t === 'withdraw' ? '출금' : '환전'; },
                       txnColor(t) { return t === 'deposit' ? 'text-hq-green' : t === 'withdraw' ? 'text-hq-red' : 'text-hq-cyan'; },
                       txnSign(t) { return t === 'deposit' ? '+' : t === 'withdraw' ? '-' : ''; },
                     }" x-init="loadTxns()">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-xs font-bold text-hq-text">입출금 기록</h4>
                    <button @click="showAddTxn = !showAddTxn"
                            class="text-[10px] px-2 py-1 rounded-lg transition"
                            :class="showAddTxn ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-accent'">
                      <span x-text="showAddTxn ? '닫기' : '+ 기록 추가'"></span>
                    </button>
                  </div>
                  <!-- 추가 폼 -->
                  <div x-show="showAddTxn" x-transition class="bg-hq-bg/50 border border-hq-border/30 rounded-lg p-3 mb-3 space-y-2">
                    <div class="flex gap-2">
                      <template x-for="t in ['deposit','withdraw','exchange']" :key="t">
                        <button @click="txnType = t" class="text-[10px] px-3 py-1 rounded-lg transition"
                                :class="txnType === t ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'"
                                x-text="txnLabel(t)"></button>
                      </template>
                    </div>
                    <div class="flex gap-2">
                      <input type="number" x-model.number="txnAmount" placeholder="금액"
                             class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text font-mono"/>
                      <select x-model="txnCurrency" class="bg-hq-bg border border-hq-border rounded-lg px-2 py-2 text-xs text-hq-text">
                        <option value="KRW">KRW</option>
                        <option value="USD">USD</option>
                      </select>
                    </div>
                    <div class="flex gap-2">
                      <input x-model="txnMemo" placeholder="메모 (선택)" class="flex-1 bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text"/>
                      <button @click="addTxn()" class="bg-hq-accent/20 text-hq-accent rounded-lg px-4 py-2 text-xs font-semibold hover:bg-hq-accent/30">저장</button>
                    </div>
                  </div>
                  <!-- 기록 리스트 -->
                  <div class="space-y-1.5 max-h-48 overflow-y-auto scrollbar-thin">
                    <template x-for="txn in txns" :key="txn.id">
                      <div class="flex items-center justify-between py-1.5 border-b border-hq-border/20 last:border-0">
                        <div class="flex items-center gap-2">
                          <span class="text-[10px] font-bold px-1.5 py-0.5 rounded"
                                :class="txn.type === 'deposit' ? 'bg-hq-green/10 text-hq-green' : txn.type === 'withdraw' ? 'bg-hq-red/10 text-hq-red' : 'bg-hq-cyan/10 text-hq-cyan'"
                                x-text="txnLabel(txn.type)"></span>
                          <span class="text-[10px] text-hq-muted" x-text="txn.date"></span>
                          <span x-show="txn.memo" class="text-[10px] text-hq-muted/60" x-text="txn.memo"></span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-mono font-bold" :class="txnColor(txn.type)"
                                x-text="txnSign(txn.type) + Number(txn.amount).toLocaleString() + ' ' + txn.currency"></span>
                          <button @click="deleteTxn(txn.id)" class="text-hq-muted/30 hover:text-hq-red text-[10px] transition">×</button>
                        </div>
                      </div>
                    </template>
                    <div x-show="txns.length === 0" class="text-center text-hq-muted/60 py-4 text-xs">입출금 기록이 없습니다</div>
                  </div>
                  <!-- 요약 -->
                  <div x-show="txns.length > 0" class="mt-3 pt-2 border-t border-hq-border/30 flex justify-between text-[10px]">
                    <span class="text-hq-muted">총 입금</span>
                    <span class="text-hq-green font-mono" x-text="'+' + txns.filter(t => t.type === 'deposit').reduce((s,t) => s + t.amount, 0).toLocaleString() + ' KRW'"></span>
                  </div>
                </div>

              </div>
            </template>
          </div>

          <!-- ▸ 서브탭 3: 매매 전략 -->
          <!-- ▸ 서브탭 4: 관심종목 -->
          <div x-show="trading.tab === 'watchlist' && !trading.loading">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <h3 class="text-sm font-bold text-hq-text">관심종목</h3>
                <button @click="loadWatchlistPrices()" :disabled="trading.watchPricesLoading"
                        class="text-[10px] px-2 py-0.5 rounded bg-hq-cyan/10 text-hq-cyan hover:bg-hq-cyan/20 transition disabled:opacity-50">
                  <span x-show="!trading.watchPricesLoading">🔄 시세 새로고침</span>
                  <span x-show="trading.watchPricesLoading">⏳ 조회 중...</span>
                </button>
                <span x-show="trading.watchPricesUpdatedAt" class="text-[9px] text-hq-muted"
                      x-text="'최근 갱신: ' + trading.watchPricesUpdatedAt"></span>
              </div>
              <button @click="trading.showWatchModal = true" class="bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg px-3 py-1.5 text-xs font-semibold transition">+ 종목 추가</button>
            </div>
            <!-- 시장 필터 탭 -->
            <div class="flex items-center gap-1 mb-4">
              <template x-for="mf in [{id:'all',l:'전체'},{id:'KR',l:'🇰🇷 한국'},{id:'US',l:'🇺🇸 미국'}]" :key="mf.id">
                <button @click="trading.watchMarketFilter = mf.id"
                        :class="trading.watchMarketFilter === mf.id ? 'bg-hq-accent/25 text-hq-accent border-hq-accent/40' : 'bg-hq-surface/60 text-hq-muted border-hq-border hover:text-hq-text'"
                        class="px-3 py-1 rounded-lg text-xs font-semibold border transition"
                        x-text="mf.l + (mf.id === 'all' ? ' (' + trading.watchlist.length + ')' : ' (' + trading.watchlist.filter(w => w.market === mf.id || (mf.id === 'KR' && !w.market)).length + ')')"></button>
              </template>
              <span x-show="trading.watchDragHint" class="ml-auto text-[9px] text-hq-muted/60 italic">↕ 드래그해서 순서 변경</span>
              <!-- 전체선택 버튼 -->
              <button @click="selectAllWatchlist(trading.watchMarketFilter)"
                      x-show="trading.watchlist.length > 0"
                      class="ml-2 px-2.5 py-1 rounded-lg text-[10px] font-semibold border transition"
                      :class="trading.watchlist.filter(w => trading.watchMarketFilter === 'all' || w.market === trading.watchMarketFilter || (trading.watchMarketFilter === 'KR' && !w.market)).every(w => trading.selectedWatchlist.includes(w.ticker)) && trading.watchlist.filter(w => trading.watchMarketFilter === 'all' || w.market === trading.watchMarketFilter || (trading.watchMarketFilter === 'KR' && !w.market)).length > 0 ? 'bg-hq-accent/20 text-hq-accent border-hq-accent/40' : 'bg-hq-surface/60 text-hq-muted border-hq-border hover:text-hq-text'"
                      x-text="trading.watchlist.filter(w => trading.watchMarketFilter === 'all' || w.market === trading.watchMarketFilter || (trading.watchMarketFilter === 'KR' && !w.market)).every(w => trading.selectedWatchlist.includes(w.ticker)) && trading.watchlist.filter(w => trading.watchMarketFilter === 'all' || w.market === trading.watchMarketFilter || (trading.watchMarketFilter === 'KR' && !w.market)).length > 0 ? '✓ 전체해제' : '☐ 전체선택'">
              </button>
            </div>
            <!-- 선택 종목 분석 버튼 -->
            <div x-show="trading.selectedWatchlist && trading.selectedWatchlist.length > 0" class="mb-3 flex items-center gap-2 p-2.5 rounded-xl bg-hq-accent/10 border border-hq-accent/30">
              <span class="text-xs text-hq-accent font-bold" x-text="trading.selectedWatchlist.length + '개 종목 선택'"></span>
              <button @click="analyzeSelectedWatchlist()"
                      :disabled="trading.analyzingSelected"
                      class="ml-auto bg-hq-accent text-white rounded-lg px-4 py-1.5 text-xs font-bold hover:bg-hq-accent/80 transition disabled:opacity-50">
                <span x-show="!trading.analyzingSelected">🔍 선택 종목 분석 및 자동매매</span>
                <span x-show="trading.analyzingSelected">⏳ 금융분석팀장 분석 진행 중...</span>
              </button>
              <button @click="trading.selectedWatchlist = []" class="text-hq-muted hover:text-hq-text text-xs transition">선택 해제</button>
            </div>
            <template x-if="trading.watchlist.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center">
                <p class="text-hq-muted/70 text-xs mb-3">관심 종목이 없습니다</p>
                <button @click="trading.showWatchModal = true" class="bg-hq-accent/20 text-hq-accent rounded-lg px-4 py-2 text-xs font-semibold">종목 추가하기</button>
              </div>
            </template>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="w in trading.watchlist.filter(w => trading.watchMarketFilter === 'all' || w.market === trading.watchMarketFilter || (trading.watchMarketFilter === 'KR' && !w.market))" :key="w.ticker">
                <div class="glass border border-hq-border rounded-xl p-4 hover-glow transition-all duration-150 cursor-grab active:cursor-grabbing"
                     draggable="true"
                     @dragstart="trading.draggedTicker = w.ticker; trading.watchDragHint = false; $event.dataTransfer.effectAllowed = 'move'"
                     @dragend="trading.draggedTicker = null; trading.dragOverTicker = null"
                     @dragover.prevent="trading.dragOverTicker = w.ticker; $event.dataTransfer.dropEffect = 'move'"
                     @dragleave="if(trading.dragOverTicker === w.ticker) trading.dragOverTicker = null"
                     @drop.prevent="watchlistDropReorder(w.ticker)"
                     :class="trading.dragOverTicker === w.ticker && trading.draggedTicker !== w.ticker ? 'border-hq-accent/60 scale-[1.02] shadow-lg' : trading.draggedTicker === w.ticker ? 'opacity-40' : ''">
                  <!-- 헤더: 체크박스 + 종목명 + 삭제 -->
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <input type="checkbox" class="w-4 h-4 rounded border-hq-border accent-hq-accent cursor-pointer"
                             :checked="trading.selectedWatchlist && trading.selectedWatchlist.includes(w.ticker)"
                             @change="toggleWatchlistSelect(w.ticker)"
                             @click.stop>
                      <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" :class="(w.market||'KR')==='US' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'" x-text="(w.market||'KR')==='US' ? 'US' : 'KR'"></span>
                      <div>
                        <div class="text-sm font-bold text-hq-text" x-text="w.name"></div>
                        <div class="text-[10px] text-hq-muted font-mono" x-text="w.ticker"></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <button @click="openWatchlistChart(w)" class="text-hq-muted/70 hover:text-hq-cyan transition" title="차트 보기">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                      </button>
                      <button @click="openWatchlistEdit(w)" class="text-hq-muted/70 hover:text-hq-accent transition" title="수정">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                      </button>
                      <button @click="removeWatchlistItem(w.ticker)" class="text-hq-muted/70 hover:text-hq-red transition" title="삭제">&times;</button>
                    </div>
                  </div>

                  <!-- 현재가 + 등락률 (실시간 데이터) -->
                  <template x-if="trading.watchPrices[w.ticker] && !trading.watchPrices[w.ticker].error">
                    <div class="mb-2">
                      <div class="flex items-baseline gap-2">
                        <span class="text-xl font-bold font-mono"
                              :class="trading.watchPrices[w.ticker].change >= 0 ? 'text-hq-red' : 'text-blue-400'"
                              x-text="(trading.watchPrices[w.ticker].currency === 'USD' ? '$' : '') + (trading.watchPrices[w.ticker].current_price||0).toLocaleString() + (trading.watchPrices[w.ticker].currency === 'KRW' ? '원' : '')"></span>
                        <span class="text-sm font-bold px-2 py-0.5 rounded"
                              :class="trading.watchPrices[w.ticker].change >= 0 ? 'bg-hq-red/15 text-hq-red' : 'bg-blue-500/15 text-blue-400'"
                              x-text="(trading.watchPrices[w.ticker].change >= 0 ? '▲' : '▼') + ' ' + Math.abs(trading.watchPrices[w.ticker].change).toLocaleString() + ' (' + (trading.watchPrices[w.ticker].change_pct >= 0 ? '+' : '') + trading.watchPrices[w.ticker].change_pct + '%)'"></span>
                      </div>
                      <div class="flex gap-4 mt-1.5 text-xs text-hq-muted">
                        <span x-text="'고가 ' + (trading.watchPrices[w.ticker].high||0).toLocaleString()"></span>
                        <span x-text="'저가 ' + (trading.watchPrices[w.ticker].low||0).toLocaleString()"></span>
                        <span x-text="'거래량 ' + (trading.watchPrices[w.ticker].volume||0).toLocaleString()"></span>
                      </div>
                    </div>
                  </template>
                  <!-- 가격 데이터 없을 때 -->
                  <template x-if="!trading.watchPrices[w.ticker]">
                    <div class="mb-2 text-[10px] text-hq-muted/60 italic">
                      🔄 시세 새로고침을 눌러 현재가를 확인하세요
                    </div>
                  </template>
                  <!-- 가격 조회 에러 (상세 원인 표시) -->
                  <template x-if="trading.watchPrices[w.ticker] && trading.watchPrices[w.ticker].error">
                    <div class="mb-2 text-[10px] text-hq-yellow/70">
                      ⚠️ 시세 조회 실패: <span x-text="trading.watchPrices[w.ticker].error" class="text-hq-muted"></span>
                    </div>
                  </template>

                  <!-- 목표가 vs 현재가 비교 -->
                  <template x-if="w.target_price && trading.watchPrices[w.ticker] && !trading.watchPrices[w.ticker].error">
                    <div class="mb-2">
                      <div class="flex items-center justify-between text-xs mb-1">
                        <span class="text-hq-muted">현재가 → 목표가</span>
                        <span class="font-mono font-semibold"
                              :class="trading.watchPrices[w.ticker].current_price >= w.target_price ? 'text-hq-green' : 'text-hq-cyan'"
                              x-text="(() => { const cur = trading.watchPrices[w.ticker].current_price; const tgt = w.target_price; const diff = ((tgt - cur) / cur * 100).toFixed(1); return (diff > 0 ? '+' : '') + diff + '%'; })()"></span>
                      </div>
                      <div class="w-full bg-hq-surface rounded-full h-2">
                        <div class="h-2 rounded-full transition-all"
                             :class="trading.watchPrices[w.ticker].current_price >= w.target_price ? 'bg-hq-green' : 'bg-hq-cyan'"
                             :style="'width:' + Math.min(100, Math.max(5, (trading.watchPrices[w.ticker].current_price / w.target_price * 100))) + '%'"></div>
                      </div>
                      <div class="flex justify-between text-xs text-hq-muted mt-1">
                        <span x-text="(trading.watchPrices[w.ticker].current_price||0).toLocaleString()"></span>
                        <span class="font-semibold" x-text="'목표 ' + (w.target_price||0).toLocaleString() + ((w.market||'KR')==='US' ? '$' : '원')"></span>
                      </div>
                    </div>
                  </template>
                  <!-- 목표가만 있고 현재가 없을 때 -->
                  <template x-if="w.target_price && (!trading.watchPrices[w.ticker] || trading.watchPrices[w.ticker].error)">
                    <div class="text-[10px] text-hq-cyan mb-1">
                      <span x-text="(w.alert_type === 'above' ? '↑ ' : '↓ ') + '목표: ' + (w.target_price||0).toLocaleString() + ((w.market||'KR')==='US' ? '$' : '원')"></span>
                    </div>
                  </template>

                  <div x-show="w.notes" class="text-[10px] text-hq-muted/80 truncate mb-1" x-text="w.notes"></div>
                  <div class="flex gap-2 mt-2">
                    <button @click="trading.orderForm = {action:'buy', ticker:w.ticker, name:w.name, qty:0, price:(trading.watchPrices[w.ticker]||{}).current_price||0, market:w.market||'KR'}; trading.showOrderModal = true;"
                            class="flex-1 bg-hq-green/10 text-hq-green hover:bg-hq-green/20 rounded-lg py-1 text-[10px] font-bold transition">매수</button>
                    <button @click="trading.orderForm = {action:'sell', ticker:w.ticker, name:w.name, qty:0, price:(trading.watchPrices[w.ticker]||{}).current_price||0, market:w.market||'KR'}; trading.showOrderModal = true;"
                            class="flex-1 bg-hq-red/10 text-hq-red hover:bg-hq-red/20 rounded-lg py-1 text-[10px] font-bold transition">매도</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- ▸ 서브탭 5: 거래내역 -->
          <div x-show="trading.tab === 'history' && !trading.loading">
            <h3 class="text-sm font-bold text-hq-text mb-4">거래 내역</h3>
            <template x-if="trading.history.length === 0">
              <div class="glass border border-hq-border rounded-xl p-8 text-center text-hq-muted/70 text-xs">거래 내역이 없습니다</div>
            </template>
            <template x-if="trading.history.length > 0">
              <div class="glass border border-hq-border rounded-xl overflow-hidden">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="text-hq-muted text-[10px] uppercase tracking-wider border-b border-hq-border bg-hq-surface">
                      <th class="py-2 px-3 text-left">시간</th>
                      <th class="py-2 px-3 text-left">구분</th>
                      <th class="py-2 px-3 text-left">종목</th>
                      <th class="py-2 px-3 text-right">수량</th>
                      <th class="py-2 px-3 text-right">단가</th>
                      <th class="py-2 px-3 text-right">금액</th>
                      <th class="py-2 px-3 text-right">손익</th>
                      <th class="py-2 px-3 text-left">전략</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="t in trading.history.slice(0, 50)" :key="t.id">
                      <tr class="border-b border-hq-border/30 hover:bg-hq-surface/50">
                        <td class="py-2 px-3 text-hq-muted font-mono text-[10px]" x-text="(t.date||'').substring(5, 16)"></td>
                        <td class="py-2 px-3">
                          <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" :class="t.action === 'buy' ? 'bg-hq-green/10 text-hq-green' : 'bg-hq-red/10 text-hq-red'"
                                x-text="t.action === 'buy' ? '매수' : '매도'"></span>
                        </td>
                        <td class="py-2 px-3 font-bold text-hq-text" x-text="t.name"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="t.qty"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="(t.price||0).toLocaleString()"></td>
                        <td class="py-2 px-3 text-right text-hq-text" x-text="(t.total||0).toLocaleString()"></td>
                        <td class="py-2 px-3 text-right" :class="tradingPnlColor(t.pnl||0)" x-text="t.pnl ? ((t.pnl > 0 ? '+' : '') + (t.pnl).toLocaleString()) : '-'"></td>
                        <td class="py-2 px-3 text-hq-muted" x-text="t.strategy || '-'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>

          <!-- ▸ 서브탭 6: 시그널 (CIO 분석) -->
          <div x-show="trading.tab === 'signals' && !trading.loading">
            <div x-effect="if(trading.tab === 'signals') {
              fetch('/api/trading/decisions').then(r=>r.ok?r.json():{decisions:[]}).then(d=>{ trading.decisions = d.decisions||[]; }).catch(()=>{});
            }"></div>
            <!-- 작전일지 (분석별 그룹핑) -->
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-hq-text">작전일지</h3>
                <p class="text-[10px] text-hq-muted mt-0.5">투자팀장의 매매 결정 기록 (분석별 그룹)</p>
              </div>
              <button x-show="trading.decisions.length > 0"
                      @click="showConfirm({ title: '작전일지 삭제', message: '작전일지를 전체 삭제하시겠습니까?', confirmText: '전체 삭제', onConfirm: () => { fetch('/api/trading/decisions',{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.success){trading.decisions=[];$dispatch('notify',{message:'작전일지 전체 삭제됨',type:'success'})}}) } })"
                      class="text-[10px] text-hq-muted/50 hover:text-hq-red transition-colors px-2 py-1 rounded hover:bg-hq-red/10">
                전체 삭제
              </button>
            </div>

            <div x-data="{
              expandedGroup: null,
              get grouped() {
                const groups = {};
                (trading.decisions||[]).forEach(d => {
                  const key = (d.created_at||'').slice(0,16);
                  if (!groups[key]) groups[key] = { time: key, items: [] };
                  groups[key].items.push(d);
                });
                return Object.values(groups).sort((a,b) => b.time.localeCompare(a.time));
              },
              async deleteDecision(id) {
                const r = await fetch('/api/trading/decisions/'+id, {method:'DELETE'});
                const d = await r.json();
                if(d.success) {
                  trading.decisions = trading.decisions.filter(x => x.id !== id);
                  $dispatch('notify',{message:'삭제됨',type:'success'});
                }
              }
            }">
              <div x-show="trading.decisions.length === 0" class="text-xs text-hq-muted/60 text-center py-4">
                아직 매매 결정 이력이 없습니다
              </div>
              <template x-for="(g, gi) in grouped" :key="g.time">
                <div class="glass border border-hq-border rounded-xl mb-2 overflow-hidden">
                  <!-- 그룹 헤더 (분석 세션 단위) -->
                  <div @click="expandedGroup = expandedGroup === g.time ? null : g.time"
                       class="flex items-center gap-3 p-2.5 cursor-pointer hover:bg-hq-surface/50">
                    <svg :class="expandedGroup === g.time ? 'rotate-90' : ''" class="w-3 h-3 transition-transform text-hq-muted flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    <span class="text-[10px] text-hq-muted font-mono" x-text="g.time.replace('T',' ')"></span>
                    <span class="text-xs text-hq-text font-medium" x-text="'금융분석팀장 분석 (' + g.items.length + '종목)'"></span>
                    <div class="flex-1 flex items-center justify-end gap-1.5">
                      <template x-for="d in g.items.slice(0,5)" :key="d.id">
                        <span class="text-[10px] px-1.5 py-0.5 rounded-full border"
                              :class="d.action==='매수'?'border-hq-green/30 bg-hq-green/10 text-hq-green':d.action==='매도'?'border-hq-red/30 bg-hq-red/10 text-hq-red':'border-hq-muted/30 text-hq-muted'"
                              x-text="(d.ticker_name||d.ticker).slice(0,4)"></span>
                      </template>
                    </div>
                  </div>
                  <!-- 그룹 내용 (펼쳤을 때) -->
                  <div x-show="expandedGroup === g.time" class="border-t border-hq-border">
                    <template x-for="d in g.items" :key="d.id">
                      <div class="border-b border-hq-border/50 last:border-b-0 p-2.5 group">
                        <div class="flex items-center gap-2 mb-1">
                          <span :class="d.action==='매수'?'text-hq-green':d.action==='매도'?'text-hq-red':'text-hq-muted'"
                                class="text-[10px] font-bold w-6" x-text="d.action"></span>
                          <span class="text-xs font-medium text-hq-text" x-text="d.ticker_name||d.ticker"></span>
                          <span class="text-[10px] font-mono text-hq-muted" x-text="'(' + d.ticker + ')'"></span>
                          <span class="ml-auto text-[10px] font-mono text-hq-accent" x-text="'신뢰도 ' + (d.confidence||0) + '%'"></span>
                          <button @click.stop="deleteDecision(d.id)"
                                  class="opacity-0 group-hover:opacity-100 text-hq-muted/40 hover:text-hq-red transition-all ml-1 p-0.5"
                                  title="삭제">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                          </button>
                        </div>
                        <div x-show="d.reason" class="text-[11px] text-hq-muted/80 leading-relaxed line-clamp-2 pl-8" x-text="d.reason"></div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- ▸ 서브탭: 작전계획 -->
          <div x-show="trading.tab === 'plan' && !trading.loading"
               x-data="{
                 plan: null, triggers: [], planLoading: false, expandedTicker: null,
                 async load() {
                   this.planLoading = true;
                   try {
                     const [pr, tr] = await Promise.all([
                       fetch('/api/trading/plan').then(r=>r.json()),
                       fetch('/api/trading/triggers').then(r=>r.ok?r.json():{triggers:[]}).catch(()=>({triggers:[]}))
                     ]);
                     this.plan = pr;
                     this.triggers = (tr.triggers||[]).filter(t => t.type==='buy_limit' && t.active);
                   } finally { this.planLoading = false; }
                 },
                 fmtPrice(p, mkt) {
                   if (!p || p <= 0) return '—';
                   return mkt==='US' ? '$'+Number(p).toFixed(2) : '₩'+Number(p).toLocaleString();
                 },
                 actionLabel(a) { return a==='buy'?'매수':a==='sell'?'매도':a==='hold'?'관망':a; },
                 cardBg(a) {
                   if(a==='buy') return 'from-hq-green/15 to-hq-green/3 border-hq-green/25';
                   if(a==='sell') return 'from-hq-red/15 to-hq-red/3 border-hq-red/25';
                   return 'from-hq-surface/80 to-hq-surface/40 border-hq-border';
                 },
                 actionBadge(a) {
                   if(a==='buy') return 'bg-hq-green/20 text-hq-green';
                   if(a==='sell') return 'bg-hq-red/20 text-hq-red';
                   return 'bg-hq-surface text-hq-muted';
                 },
                 confColor(c) { return c>=70?'text-hq-green':c>=55?'text-hq-accent':'text-hq-muted'; },
                 confBar(c) { return c>=70?'bg-hq-green':c>=55?'bg-hq-accent':'bg-hq-muted/50'; },
                 priceColor(a) { return a==='buy'?'text-hq-green':a==='sell'?'text-hq-red':'text-hq-accent'; },
                 hasTrigger(tk) { return this.triggers.some(t=>t.ticker===tk); }
               }">
            <div x-effect="if(trading.tab==='plan') load()"></div>

            <!-- 헤더 -->
            <div class="flex items-center justify-between mb-4">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-sm font-bold text-hq-text">금융팀장 작전계획</h3>
                  <span x-show="plan && plan.qa_passed" class="text-[9px] px-1.5 py-0.5 rounded-full bg-hq-green/15 border border-hq-green/25 text-hq-green font-bold">QA ✓</span>
                </div>
                <p class="text-[10px] text-hq-muted mt-0.5" x-show="plan && plan.date"
                   x-text="(plan?.analyzed_by||'금융분석팀장') + ' · ' + (plan?.date||'').slice(0,16).replace('T',' ')"></p>
              </div>
              <button @click="load()" class="flex items-center gap-1.5 text-[10px] text-hq-muted hover:text-hq-accent px-2.5 py-1.5 rounded-lg border border-hq-border hover:border-hq-accent/30 transition-all">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                새로고침
              </button>
            </div>

            <!-- 로딩 -->
            <div x-show="planLoading" class="flex flex-col items-center justify-center py-16 gap-3">
              <div class="w-7 h-7 border-2 border-hq-accent/30 border-t-hq-accent rounded-full animate-spin"></div>
              <p class="text-xs text-hq-muted">작전 불러오는 중...</p>
            </div>

            <!-- 비어있음 -->
            <div x-show="!planLoading && (!plan || !plan.signals || plan.signals.length===0)"
                 class="glass border border-hq-border rounded-2xl p-10 text-center">
              <div class="text-4xl mb-3">📋</div>
              <p class="text-sm font-bold text-hq-text mb-1">아직 작전계획이 없습니다</p>
              <p class="text-xs text-hq-muted/70 leading-relaxed">관심종목 탭에서 즉시분석을 실행하거나<br>자동 분석(09:10 KST)을 기다리세요.</p>
            </div>

            <div x-show="!planLoading && plan && plan.signals && plan.signals.length > 0">
              <!-- 요약 스탯 -->
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-5">
                <div class="glass border border-hq-green/25 rounded-xl p-3 text-center">
                  <div class="text-2xl font-black text-hq-green" x-text="plan.signals.filter(s=>s.action==='buy').length"></div>
                  <div class="text-[10px] text-hq-muted mt-0.5">매수</div>
                </div>
                <div class="glass border border-hq-red/25 rounded-xl p-3 text-center">
                  <div class="text-2xl font-black text-hq-red" x-text="plan.signals.filter(s=>s.action==='sell').length"></div>
                  <div class="text-[10px] text-hq-muted mt-0.5">매도</div>
                </div>
                <div class="glass border border-hq-border rounded-xl p-3 text-center">
                  <div class="text-2xl font-black text-hq-muted" x-text="plan.signals.filter(s=>s.action==='hold').length"></div>
                  <div class="text-[10px] text-hq-muted mt-0.5">관망</div>
                </div>
                <div class="glass border border-hq-accent/25 rounded-xl p-3 text-center">
                  <div class="text-2xl font-black text-hq-accent" x-text="triggers.length"></div>
                  <div class="text-[10px] text-hq-muted mt-0.5">🎯 대기</div>
                </div>
              </div>

              <!-- 종목 카드 그리드 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-5">
                <template x-for="sig in plan.signals" :key="sig.ticker">
                  <div class="rounded-2xl border bg-gradient-to-br p-4 transition-all duration-150 hover:scale-[1.015] hover:shadow-xl cursor-pointer select-none"
                       :class="cardBg(sig.action)"
                       @click="expandedTicker = expandedTicker===sig.ticker ? null : sig.ticker">

                    <!-- 상단: 액션 + 시장 + 신뢰도 -->
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center gap-1.5">
                        <span class="text-xs font-black px-2.5 py-1 rounded-xl" :class="actionBadge(sig.action)"
                              x-text="actionLabel(sig.action)"></span>
                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-lg"
                              :class="sig.market==='US' ? 'bg-blue-500/20 text-blue-400' : 'bg-rose-500/20 text-rose-400'"
                              x-text="sig.market==='US' ? '🇺🇸' : '🇰🇷'"></span>
                      </div>
                      <div class="text-right">
                        <div class="text-2xl font-black leading-none" :class="confColor(sig.confidence||0)"
                             x-text="(sig.confidence||0)+'%'"></div>
                        <div class="text-[9px] text-hq-muted">신뢰도</div>
                      </div>
                    </div>

                    <!-- 종목명 -->
                    <div class="mb-2">
                      <div class="text-base font-bold text-hq-text" x-text="sig.name||sig.ticker"></div>
                      <div class="text-[10px] font-mono text-hq-muted" x-text="sig.ticker"></div>
                    </div>

                    <!-- 신뢰도 바 -->
                    <div class="w-full h-1 bg-white/10 rounded-full mb-3">
                      <div class="h-1 rounded-full transition-all duration-500" :class="confBar(sig.confidence||0)"
                           :style="'width:'+Math.min(100,sig.confidence||0)+'%'"></div>
                    </div>

                    <!-- 목표가 + 비중 + 트리거 -->
                    <div class="flex items-end justify-between">
                      <div x-show="sig.target_price > 0">
                        <div class="text-[9px] text-hq-muted mb-0.5">목표 진입가</div>
                        <div class="text-lg font-black font-mono" :class="priceColor(sig.action)"
                             x-text="fmtPrice(sig.target_price, sig.market)"></div>
                      </div>
                      <div class="flex flex-col items-end gap-1">
                        <span x-show="sig.weight > 0" class="text-[10px] text-hq-muted">
                          비중 <span class="font-bold text-hq-text" x-text="(sig.weight||0)+'%'"></span>
                        </span>
                        <span x-show="hasTrigger(sig.ticker)"
                              class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-hq-accent/15 border border-hq-accent/30 text-hq-accent">🎯 대기 중</span>
                      </div>
                    </div>

                    <!-- 이유 (클릭 시 펼치기) -->
                    <div x-show="sig.reason" class="mt-3 pt-2.5 border-t border-white/10">
                      <div class="text-[11px] text-hq-muted/80 leading-relaxed"
                           :class="expandedTicker===sig.ticker ? '' : 'line-clamp-2'"
                           x-text="sig.reason"></div>
                      <div x-show="(sig.reason||'').length > 60"
                           class="text-[9px] text-hq-muted/40 mt-1.5"
                           x-text="expandedTicker===sig.ticker ? '▲ 접기' : '▼ 더 보기'"></div>
                    </div>
                  </div>
                </template>
              </div>

              <!-- 목표매수 대기 섹션 -->
              <div x-show="triggers.length > 0" class="glass border border-hq-accent/25 rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3">
                  <h4 class="text-xs font-bold text-hq-text">🎯 목표매수 대기 중</h4>
                  <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-hq-accent/15 text-hq-accent font-bold" x-text="triggers.length+'개'"></span>
                  <span class="ml-auto text-[9px] text-hq-muted/50">가격 도달 시 서버 자동 매수</span>
                </div>
                <div class="space-y-1.5">
                  <template x-for="t in triggers" :key="t.id">
                    <div class="flex items-center gap-3 p-2.5 rounded-xl bg-hq-accent/8 border border-hq-accent/15">
                      <div class="w-2 h-2 rounded-full bg-hq-accent animate-pulse flex-shrink-0"></div>
                      <span class="text-xs font-bold text-hq-text" x-text="t.name||t.ticker"></span>
                      <span class="text-[10px] font-mono text-hq-muted" x-text="t.ticker"></span>
                      <div class="ml-auto text-right">
                        <div class="text-sm font-black text-hq-accent font-mono"
                             x-text="t.market==='US' ? '$'+Number(t.trigger_price).toFixed(2) : '₩'+Number(t.trigger_price).toLocaleString()"></div>
                        <div class="text-[9px] text-hq-muted" x-text="(t.qty||1)+'주 예정'"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- ▸ 서브탭: CIO 성과 -->
          <div x-show="trading.tab === 'performance' && !trading.loading"
               x-data="{
                 perfData: null,
                 predictions: [],
                 loading: false,
                 async load() {
                   this.loading = true;
                   try {
                     const [p, s] = await Promise.all([
                       fetch('/api/cio/predictions?limit=20').then(r=>r.json()),
                       fetch('/api/cio/performance-summary').then(r=>r.json())
                     ]);
                     this.predictions = p.predictions || [];
                     this.perfData = s;
                   } catch(e) { console.error(e); }
                   this.loading = false;
                 }
               }"
               x-init="load()">

            <!-- 성과 요약 카드 (1행: 총예측/검증/전체 승률 / 2행: 최근20/매수/매도 승률) -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
              <div class="glass border border-hq-border rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">전체 예측</p>
                <p class="text-2xl font-bold text-hq-text" x-text="perfData ? (perfData.total || 0) : '-'"></p>
              </div>
              <div class="glass border border-hq-border rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">검증 완료</p>
                <p class="text-2xl font-bold text-hq-text" x-text="perfData ? (perfData.verified || 0) : '-'"></p>
              </div>
              <div class="glass border border-hq-green/30 rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">전체 승률</p>
                <p class="text-2xl font-bold text-hq-green" x-text="perfData && perfData.overall_accuracy !== null ? perfData.overall_accuracy + '%' : '-'"></p>
              </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
              <div class="glass border border-hq-cyan/30 rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">최근 20건</p>
                <p class="text-2xl font-bold text-hq-cyan" x-text="perfData && perfData.recent_20_accuracy !== null ? perfData.recent_20_accuracy + '%' : '-'"></p>
                <p class="text-[9px] text-hq-muted mt-0.5" x-text="perfData ? (perfData.recent_correct || 0) + '/' + (perfData.recent_total || 0) : ''"></p>
              </div>
              <div class="glass border border-hq-red/30 rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">매수 승률</p>
                <p class="text-2xl font-bold text-hq-red" x-text="perfData && perfData.buy_accuracy !== null ? perfData.buy_accuracy + '%' : '-'"></p>
              </div>
              <div class="glass border border-blue-500/30 rounded-xl p-4 text-center">
                <p class="text-[10px] text-hq-muted mb-1">매도 승률</p>
                <p class="text-2xl font-bold text-blue-400" x-text="perfData && perfData.sell_accuracy !== null ? perfData.sell_accuracy + '%' : '-'"></p>
              </div>
            </div>

            <!-- 예측 히스토리 테이블 -->
            <div class="glass border border-hq-border rounded-xl overflow-hidden">
              <div class="px-4 py-3 border-b border-hq-border flex items-center justify-between">
                <h3 class="text-sm font-bold text-hq-text">예측 히스토리</h3>
                <button @click="load()" class="text-xs text-hq-accent hover:text-hq-text transition">새로고침</button>
              </div>

              <div x-show="loading" class="text-center py-8 text-hq-muted text-sm">로딩 중...</div>
              <div x-show="!loading && predictions.length === 0" class="text-center py-8 text-hq-muted text-sm">
                아직 예측 데이터 없음<br>
                <span class="text-xs">금융분석팀장이 분석을 실행하면 자동으로 기록됩니다</span>
              </div>

              <div x-show="!loading && predictions.length > 0" class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="border-b border-hq-border">
                      <th class="text-left px-4 py-2 text-hq-muted font-medium">날짜</th>
                      <th class="text-left px-4 py-2 text-hq-muted font-medium">종목</th>
                      <th class="text-left px-4 py-2 text-hq-muted font-medium">예측</th>
                      <th class="text-right px-4 py-2 text-hq-muted font-medium">예측가</th>
                      <th class="text-center px-4 py-2 text-hq-muted font-medium">3일</th>
                      <th class="text-center px-4 py-2 text-hq-muted font-medium">7일</th>
                      <th class="text-left px-4 py-2 text-hq-muted font-medium">신뢰도</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="pred in predictions" :key="pred.id">
                      <tr class="border-b border-hq-border/30 hover:bg-hq-surface/50">
                        <td class="px-4 py-2 text-hq-muted font-mono" x-text="pred.analyzed_at ? pred.analyzed_at.slice(0,10) : '-'"></td>
                        <td class="px-4 py-2 font-bold text-hq-text" x-text="(pred.ticker_name || pred.ticker || '-')"></td>
                        <td class="px-4 py-2">
                          <span class="px-2 py-0.5 rounded font-bold"
                                :class="['BUY','UP'].includes(pred.direction) ? 'bg-hq-green/20 text-hq-green' : 'bg-hq-red/20 text-hq-red'"
                                x-text="['BUY','UP'].includes(pred.direction) ? '매수' : '매도'"></span>
                        </td>
                        <td class="px-4 py-2 text-right font-mono text-hq-text" x-text="pred.predicted_price ? pred.predicted_price.toLocaleString() + '원' : '-'"></td>
                        <td class="px-4 py-2 text-center">
                          <span x-show="pred.correct_3d !== null"
                                :class="pred.correct_3d ? 'text-hq-green' : 'text-hq-red'"
                                x-text="pred.correct_3d ? '✓' : '✗'"></span>
                          <span x-show="pred.correct_3d === null" class="text-hq-muted">대기</span>
                        </td>
                        <td class="px-4 py-2 text-center">
                          <span x-show="pred.correct_7d !== null"
                                :class="pred.correct_7d ? 'text-hq-green' : 'text-hq-red'"
                                x-text="pred.correct_7d ? '✓' : '✗'"></span>
                          <span x-show="pred.correct_7d === null" class="text-hq-muted">대기</span>
                        </td>
                        <td class="px-4 py-2">
                          <div class="flex items-center gap-2">
                            <div class="flex-1 h-1.5 bg-hq-surface rounded-full overflow-hidden">
                              <div class="h-full bg-hq-accent rounded-full" :style="`width: ${pred.confidence || 0}%`"></div>
                            </div>
                            <span class="text-hq-muted font-mono" x-text="(pred.confidence || 0) + '%'"></span>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ═══ SHADOW TRADING: 실거래/모의 비교 탭 ═══ -->
          <div x-show="trading.tab === 'shadow' && !trading.loading" x-data="{
            shadowData: null, shadowLoading: false, shadowError: '',
            usReal: null, usMock: null,
            fxRate: 1450,
            async loadShadow() {
              this.shadowLoading = true; this.shadowError = '';
              try {
                const [sR, usRealR, usMockR] = await Promise.allSettled([
                  fetch('/api/trading/shadow/compare').then(r=>r.json()),
                  fetch('/api/trading/overseas/balance').then(r=>r.json()),
                  fetch('/api/trading/overseas/mock-balance').then(r=>r.json())
                ]);
                this.shadowData = sR.status==='fulfilled' ? sR.value : null;
                this.usReal = usRealR.status==='fulfilled' ? usRealR.value : null;
                this.usMock = usMockR.status==='fulfilled' ? usMockR.value : null;
              } catch(e) { this.shadowError = '조회 실패: ' + e.message; }
              this.shadowLoading = false;
            },
            fmtKRW(v) { return '₩' + Math.round(v||0).toLocaleString(); },
            fmtUSD(v) { return '$' + (v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
          }">
            <div x-effect="if(trading.tab === 'shadow') loadShadow()"></div>

            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-sm font-bold text-hq-text">실거래 / 모의투자 비교</h3>
                  <p class="text-xs text-hq-muted mt-0.5">한국장+미국장 통합 비교 · KRW/USD 이중표기</p>
                </div>
                <button @click="loadShadow()" class="bg-hq-surface border border-hq-border hover:border-hq-accent/30 rounded-lg px-3 py-1.5 text-xs text-hq-muted transition">새로고침</button>
              </div>

              <div x-show="shadowLoading" class="flex items-center justify-center py-12">
                <div class="w-6 h-6 border-2 border-hq-accent border-t-transparent rounded-full animate-spin mr-3"></div>
                <span class="text-sm text-hq-muted">비교 데이터 조회 중...</span>
              </div>

              <div x-show="!shadowLoading && shadowError" class="bg-hq-red/10 border border-hq-red/20 rounded-lg p-3 text-xs text-hq-red" x-text="shadowError"></div>

              <div x-show="!shadowLoading && !shadowError && shadowData && !(shadowData.mock||{}).available && !(shadowData.mock||{}).holdings" class="bg-hq-yellow/10 border border-hq-yellow/20 rounded-lg p-4">
                <p class="text-xs font-bold text-hq-yellow mb-1">모의투자 설정 필요</p>
                <p class="text-xs text-hq-muted">KIS 포털에서 모의투자 App Key를 신청하고 GitHub Secrets에 등록하면 비교가 시작됩니다.</p>
              </div>

              <div x-show="!shadowLoading && !shadowError && shadowData" class="space-y-4">

                <!-- 실거래: 한국 | 미국 -->
                <div class="text-[10px] text-hq-muted font-bold uppercase tracking-wider mb-1">실거래</div>
                <div class="grid grid-cols-2 gap-3">
                  <div class="bg-hq-panel border border-hq-green/30 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-2 h-2 rounded-full bg-hq-green"></div>
                      <span class="text-xs font-bold text-hq-green">🇰🇷 한국</span>
                    </div>
                    <div class="text-lg font-bold text-hq-text font-mono" x-text="(shadowData&&(shadowData.real||{}).success) ? fmtKRW(shadowData.real.total_eval||0) : '—'"></div>
                    <div class="text-[10px] text-hq-muted mt-1" x-text="(shadowData&&(shadowData.real||{}).success) ? '현금 '+fmtKRW(shadowData.real.cash||0)+' · '+((shadowData.real.holdings||[]).length)+'종목' : 'KIS 미연결'"></div>
                  </div>
                  <div class="bg-hq-panel border border-hq-green/30 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-2 h-2 rounded-full bg-hq-green"></div>
                      <span class="text-xs font-bold text-hq-green">🇺🇸 미국</span>
                    </div>
                    <div class="text-lg font-bold text-hq-text font-mono" x-text="(usReal&&usReal.success) ? fmtUSD(usReal.total_eval_usd||0) : '—'"></div>
                    <div class="text-[10px] text-hq-muted mt-0.5 font-mono" x-text="(usReal&&usReal.success&&(usReal.total_eval_usd||0)>0) ? '≈ '+fmtKRW((usReal.total_eval_usd||0)*fxRate) : ''"></div>
                    <div class="text-[10px] text-hq-muted mt-1" x-text="(usReal&&usReal.success) ? '현금 '+fmtUSD(usReal.cash_usd||0)+' · '+((usReal.holdings||[]).length)+'종목' : '해외 미연결'"></div>
                  </div>
                </div>

                <!-- 모의투자: 한국 | 미국 -->
                <div class="text-[10px] text-hq-muted font-bold uppercase tracking-wider mt-4 mb-1">모의투자</div>
                <div class="grid grid-cols-2 gap-3">
                  <div class="bg-hq-panel border border-hq-purple/30 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-2 h-2 rounded-full bg-hq-purple"></div>
                      <span class="text-xs font-bold text-hq-purple">🇰🇷 한국</span>
                    </div>
                    <div class="text-lg font-bold text-hq-text font-mono" x-text="(shadowData&&((shadowData.mock||{}).available||(shadowData.mock||{}).success)) ? fmtKRW(shadowData.mock.total_eval||0) : '—'"></div>
                    <div class="text-[10px] text-hq-muted mt-1" x-text="(shadowData&&((shadowData.mock||{}).available||(shadowData.mock||{}).success)) ? '현금 '+fmtKRW(shadowData.mock.cash||0)+' · '+((shadowData.mock.holdings||[]).length)+'종목' : '모의 미연결'"></div>
                  </div>
                  <div class="bg-hq-panel border border-hq-purple/30 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-2 h-2 rounded-full bg-hq-purple"></div>
                      <span class="text-xs font-bold text-hq-purple">🇺🇸 미국</span>
                    </div>
                    <div class="text-lg font-bold text-hq-text font-mono" x-text="(usMock&&usMock.success) ? fmtUSD(usMock.total_eval_usd||0) : '—'"></div>
                    <div class="text-[10px] text-hq-muted mt-0.5 font-mono" x-text="(usMock&&usMock.success&&(usMock.total_eval_usd||0)>0) ? '≈ '+fmtKRW((usMock.total_eval_usd||0)*fxRate) : ''"></div>
                    <div class="text-[10px] text-hq-muted mt-1" x-text="(usMock&&usMock.success) ? '현금 '+fmtUSD(usMock.cash_usd||0)+' · '+((usMock.holdings||[]).length)+'종목' : '해외 모의 미연결'"></div>
                  </div>
                </div>

                <!-- 슬리피지 -->
                <div class="bg-hq-surface border border-hq-border rounded-xl p-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-xs font-bold text-hq-text">슬리피지 (실거래 - 모의 수익률 차이)</p>
                      <p class="text-[10px] text-hq-muted mt-0.5">음수=실거래 손실 더 큼 · 양수=실거래가 더 좋음</p>
                    </div>
                    <div class="text-base font-bold" :class="(shadowData&&shadowData.slip_rate!=null) ? (shadowData.slip_rate>=0?'text-hq-green':'text-hq-red') : 'text-hq-muted'"
                         x-text="(shadowData&&shadowData.slip_rate!=null) ? (shadowData.slip_rate>=0?'+':'')+shadowData.slip_rate+'%' : '측정 중'"></div>
                  </div>
                </div>

                <!-- 전략 검증 -->
                <div class="bg-hq-panel border border-hq-accent/20 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-hq-accent/20 flex items-center justify-center flex-shrink-0 mt-0.5">🏅</div>
                    <div>
                      <p class="text-xs font-bold text-hq-text">전략 검증 흐름</p>
                      <p class="text-xs text-hq-muted mt-1 leading-relaxed">
                        모의투자에서 <span class="text-hq-yellow font-semibold">2주 연속 수익</span>이 나면 → 텔레그램으로 "실거래 전환 추천" 알림 발송.
                      </p>
                      <div class="mt-2 flex gap-2 flex-wrap">
                        <span class="bg-hq-muted/10 text-hq-muted rounded px-2 py-0.5 text-[10px]">1단계: 모의투자</span>
                        <span class="text-hq-muted/40 text-[10px]">→</span>
                        <span class="bg-hq-yellow/10 text-hq-yellow rounded px-2 py-0.5 text-[10px]">2단계: 2주 수익 확인</span>
                        <span class="text-hq-muted/40 text-[10px]">→</span>
                        <span class="bg-hq-green/10 text-hq-green rounded px-2 py-0.5 text-[10px]">3단계: 실거래 전환</span>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div><!-- /shadow 탭 끝 -->

        </div>
      </div></template>

      <!-- E-1: 피드백 모드 — 피그마급 핀 시스템 -->
      <div class="fixed bottom-20 md:bottom-6 right-6 z-50 flex flex-col items-end gap-2">
        <!-- 피드백 모드 ON 패널 -->
        <div x-show="feedbackMode" x-transition class="bg-hq-bg/95 backdrop-blur border border-hq-yellow/40 rounded-xl shadow-xl p-3 w-56">
          <div class="text-xs font-bold text-hq-yellow mb-2 flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-yellow animate-pulse"></span>
            피드백 모드 ON
          </div>
          <p class="text-[10px] text-hq-muted mb-2">드래그 → 영역 캡처 | 클릭 → 핀</p>
          <div class="text-[10px] text-hq-muted mb-1.5" x-text="'핀 ' + feedbackPins.length + '개'"></div>
          <!-- 핀 목록 (최근 5개) -->
          <div class="max-h-24 overflow-y-auto scrollbar-thin space-y-1 mb-2">
            <template x-for="(pin, idx) in feedbackPins.slice(-5)" :key="idx">
              <div class="flex items-center gap-1 bg-hq-surface rounded px-2 py-1">
                <span class="text-hq-yellow font-bold text-[10px]" x-text="'#' + (idx + 1)"></span>
                <span class="text-[10px] text-hq-text truncate flex-1" x-text="pin.comment"></span>
                <button @click="removeFeedbackPin(idx)" class="text-hq-red/60 hover:text-hq-red text-[10px]">&times;</button>
              </div>
            </template>
          </div>
          <button x-show="feedbackPins.length > 0" @click="clearAllFeedbackPins()"
                  class="w-full text-[10px] py-1 rounded bg-hq-red/10 text-hq-red hover:bg-hq-red/20 transition mb-1">전체 삭제</button>
        </div>
        <button @click="feedbackMode = !feedbackMode; if(feedbackMode) loadFeedbackPins()"
                class="w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-lg transition-all"
                :class="feedbackMode ? 'bg-hq-yellow text-black scale-110 ring-4 ring-hq-yellow/30' : 'bg-hq-panel border border-hq-border text-hq-muted hover:text-hq-yellow hover:border-hq-yellow/30'"
                title="피드백 모드">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/>
          </svg>
        </button>
      </div>
      <!-- E-1: 피드백 드래그 캡처 오버레이 + 핀 표시 -->
      <div x-show="feedbackMode" id="fb-overlay"
           @mousedown.prevent="fbDragStart($event)"
           @mousemove="fbDragMove($event)"
           @mouseup="fbDragEnd($event)"
           class="fixed inset-0 z-40 cursor-crosshair select-none" style="background: rgba(234, 179, 8, 0.03);">
        <!-- 드래그 중 선택 영역 표시 -->
        <div x-show="fbDrag && (Math.abs(fbDrag.curX - fbDrag.startX) > 5 || Math.abs(fbDrag.curY - fbDrag.startY) > 5)"
             class="absolute border-2 border-hq-yellow bg-hq-yellow/10 rounded pointer-events-none"
             :style="fbDrag ? `left:${fbDragRect().x}px;top:${fbDragRect().y}px;width:${fbDragRect().w}px;height:${fbDragRect().h}px` : ''">
          <div class="absolute -top-5 left-0 text-[10px] text-hq-yellow bg-black/70 px-1.5 py-0.5 rounded"
               x-text="fbDrag ? fbDragRect().w + '×' + fbDragRect().h : ''"></div>
        </div>
        <!-- 기존 핀 표시 -->
        <template x-for="(pin, idx) in feedbackPins" :key="pin.id || idx">
          <div class="absolute z-41" :style="`left:${pin.x - 8}px;top:${pin.y - 8}px`">
            <div class="w-6 h-6 rounded-full shadow-lg cursor-pointer hover:scale-110 transition flex items-center justify-center text-[10px] font-bold"
                 :class="pin.hasCapture ? 'bg-hq-blue text-white' : 'bg-hq-yellow text-black'"
                 :title="pin.comment" x-text="idx + 1"></div>
          </div>
        </template>
        <!-- 새 핀 입력 폼 (클릭 모드) -->
        <div x-show="feedbackNewPin" x-transition @click.stop @mousedown.stop
             class="absolute z-42" :style="feedbackNewPin ? `left:${feedbackNewPin.x}px;top:${feedbackNewPin.y + 16}px` : ''">
          <div class="bg-hq-bg border border-hq-yellow/40 rounded-xl shadow-2xl p-3 w-64">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-5 h-5 rounded-full bg-hq-yellow text-black text-[10px] font-bold flex items-center justify-center" x-text="feedbackPins.length + 1"></div>
              <span class="text-xs font-bold text-hq-yellow">새 피드백</span>
            </div>
            <textarea id="feedbackPinInput" x-model="feedbackPinText"
                      @keydown.enter.meta="submitFeedbackPin()" @keydown.enter.ctrl="submitFeedbackPin()"
                      @keydown.escape="feedbackNewPin = null; feedbackPinText = ''"
                      placeholder="피드백을 입력하세요... (Ctrl+Enter 전송)"
                      class="w-full bg-hq-surface border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text resize-none h-16 focus:border-hq-yellow/50 outline-none"></textarea>
            <div class="flex gap-2 mt-2">
              <button @click="submitFeedbackPin()" class="flex-1 py-1.5 text-xs font-semibold rounded-lg bg-hq-yellow/20 text-hq-yellow hover:bg-hq-yellow/30 transition">저장</button>
              <button @click="feedbackNewPin = null; feedbackPinText = ''" class="py-1.5 px-3 text-xs rounded-lg bg-hq-muted/10 text-hq-muted hover:bg-hq-muted/20 transition">취소</button>
            </div>
          </div>
        </div>
        <!-- 캡처 결과 + 코멘트 폼 -->
        <div x-show="fbCapture" x-transition @click.stop @mousedown.stop
             class="absolute z-42" :style="fbCapture ? `left:${Math.min(fbCapture.x, window.innerWidth - 320)}px;top:${Math.min(fbCapture.y + fbCapture.h + 8, window.innerHeight - 260)}px` : ''">
          <div class="bg-hq-bg border border-hq-blue/50 rounded-xl shadow-2xl p-3 w-72">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm">📸</span>
              <span class="text-xs font-bold text-hq-blue">영역 캡처</span>
              <span class="text-[10px] text-hq-muted ml-auto" x-text="fbCapture ? fbCapture.w + '×' + fbCapture.h + 'px' : ''"></span>
            </div>
            <!-- 캡처 미리보기 -->
            <div class="mb-2 rounded-lg overflow-hidden border border-hq-border bg-black/30 max-h-32">
              <img x-show="fbCapture && fbCapture.dataUrl" :src="fbCapture ? fbCapture.dataUrl : ''" class="w-full object-contain max-h-32" alt="캡처">
            </div>
            <textarea id="fbCaptureInput" x-model="fbCaptureText"
                      @keydown.enter.meta="fbCaptureSubmit()" @keydown.enter.ctrl="fbCaptureSubmit()"
                      @keydown.escape="fbCaptureCancel()"
                      placeholder="코멘트 (선택)... Ctrl+Enter 전송"
                      class="w-full bg-hq-surface border border-hq-border rounded-lg px-3 py-2 text-xs text-hq-text resize-none h-14 focus:border-hq-blue/50 outline-none"></textarea>
            <div class="flex gap-2 mt-2">
              <button @click="fbCaptureSubmit()" class="flex-1 py-1.5 text-xs font-semibold rounded-lg bg-hq-blue/20 text-hq-blue hover:bg-hq-blue/30 transition">저장</button>
              <button @click="fbCaptureCancel()" class="py-1.5 px-3 text-xs rounded-lg bg-hq-muted/10 text-hq-muted hover:bg-hq-muted/20 transition">취소</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ Phase 2: 5초 취소 토스트 스택 (모바일 전용) ═══ -->
      <div class="mobile-undo-toast-stack md:hidden" x-cloak>
        <template x-for="toast in mobileUndoToasts" :key="toast.id">
          <div class="mobile-undo-toast" style="position:relative;overflow:hidden;">
            <span style="font-size:20px;">✅</span>
            <div class="mobile-undo-toast-text">
              승인 발행 예약됨
              <div class="mobile-undo-toast-sub" x-text="toast.countdown + '초 후 발행 확정'"></div>
            </div>
            <button class="mobile-undo-toast-cancel" @click="cancelUndoToast(toast.id)">취소</button>
            <div class="mobile-undo-toast-progress" :style="'width:' + toast.progress + '%'"></div>
          </div>
        </template>
      </div>

      <!-- ═══ Phase 3: 모바일 @멘션 바텀 시트 ═══ -->
      <template x-if="mobileMentionSheetOpen">
        <div>
          <div class="mobile-bottom-sheet-backdrop md:hidden" @click="closeMobileMentionSheet()"></div>
          <div class="mobile-bottom-sheet md:hidden">
            <div class="mobile-bottom-sheet-handle"></div>
            <div class="mobile-bottom-sheet-title">팀장 선택</div>
            <div class="mobile-bottom-sheet-list">
              <template x-for="group in mentionGroups" :key="group.label">
                <div>
                  <div class="mobile-sheet-group-label" x-text="group.label"></div>
                  <template x-for="agent in group.agents" :key="agent.id">
                    <div class="mobile-sheet-agent-item" @click="insertMentionFromSheet(agent)">
                      <div class="mobile-sheet-agent-avatar" :class="getAgentAvatarClass(agent.id)" x-text="getAgentInitials(agent.id)"></div>
                      <div>
                        <div class="mobile-sheet-agent-name" x-text="agent.name"></div>
                        <div class="mobile-sheet-agent-div" x-text="agent.div"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </div>
      </template>

      <!-- ═══ Mobile Bottom Navigation (모바일 하단 네비) ═══ -->
      <nav class="mobile-bottom-nav safe-bottom" x-cloak>
        <!-- 사령관실 -->
        <div class="mobile-bottom-nav-item" :class="viewMode === 'chat' && activeTab === 'command' ? 'active' : ''"
             @click="viewMode = 'chat'; switchTab('command'); mobileMoreOpen = false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <span>사령관실</span>
        </div>
        <!-- 전략실 -->
        <div class="mobile-bottom-nav-item" :class="viewMode === 'chat' && activeTab === 'trading' ? 'active' : ''"
             @click="viewMode = 'chat'; switchTab('trading'); mobileMoreOpen = false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
          <span>전략실</span>
        </div>
        <!-- 통산로그 -->
        <div class="mobile-bottom-nav-item" :class="viewMode === 'chat' && activeTab === 'activityLog' ? 'active' : ''"
             @click="viewMode = 'chat'; switchTab('activityLog'); mobileMoreOpen = false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
          <span>통산로그</span>
        </div>
        <!-- 기밀문서 -->
        <div class="mobile-bottom-nav-item" :class="viewMode === 'chat' && activeTab === 'archive' ? 'active' : ''"
             @click="viewMode = 'chat'; switchTab('archive'); mobileMoreOpen = false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
          <span>기밀</span>
        </div>
        <!-- 통신국 (pending 배지 포함) -->
        <div class="mobile-bottom-nav-item" style="position:relative" :class="viewMode === 'chat' && activeTab === 'sns' ? 'active' : ''"
             @click="viewMode = 'chat'; switchTab('sns'); mobileMoreOpen = false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/></svg>
          <span
            class="mobile-nav-badge"
            x-show="(sns.queue||[]).filter(q=>q.status==='pending').length > 0"
            x-text="(sns.queue||[]).filter(q=>q.status==='pending').length"
            x-cloak></span>
          <span>통신국</span>
        </div>
      </nav>

      <!-- ═══ Mobile More Tabs Sheet (더보기 바텀시트) ═══ -->
      <div class="mobile-more-overlay" :class="mobileMoreOpen ? 'open' : ''" @click="mobileMoreOpen = false" x-cloak></div>
      <div class="mobile-more-sheet" :class="mobileMoreOpen ? 'open' : ''" x-cloak>
        <div class="mobile-more-sheet-handle"></div>
        <div class="mobile-more-sheet-grid">
          <!-- AGORA -->
          <div class="mobile-more-sheet-item" :class="viewMode === 'agora' ? 'active' : ''"
               @click="viewMode = 'agora'; mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/></svg>
            <span>AGORA</span>
          </div>
          <!-- 대시보드 -->
          <div class="mobile-more-sheet-item" :class="viewMode === 'dashboard' ? 'active' : ''"
               @click="viewMode = 'dashboard'; mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
            <span>대시보드</span>
          </div>
          <!-- 작전일지 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'history' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('history'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span>작전일지</span>
          </div>
          <!-- 전력분석 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'performance' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('performance'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span>전력분석</span>
          </div>
          <!-- 기밀문서 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'archive' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('archive'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/></svg>
            <span>기밀문서</span>
          </div>
          <!-- 자동화 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'workflow' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('workflow'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
            <span>자동화</span>
          </div>
          <!-- 크론기지 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'schedule' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('schedule'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span>크론기지</span>
          </div>
          <!-- 정보국 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'knowledge' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('knowledge'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            <span>정보국</span>
          </div>
          <!-- ARGOS -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'intelligence' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('intelligence'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/></svg>
            <span>ARGOS</span>
          </div>
          <!-- 통신국 -->
          <div class="mobile-more-sheet-item" :class="activeTab === 'sns' ? 'active' : ''"
               @click="viewMode = 'chat'; switchTab('sns'); mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/></svg>
            <span>통신국</span>
          </div>
          <!-- 사무실 뷰 -->
          <div class="mobile-more-sheet-item"
               @click="viewMode = 'office'; mobileMoreOpen = false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <span>사무실</span>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ═══ Trading Order Modal (주문 실행) ═══ -->
  <div x-show="trading.showOrderModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showOrderModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[420px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">주문 실행</h2>
        <div class="flex items-center gap-2">
          <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                :class="(trading.summary.settings||{}).paper_trading !== false ? 'bg-hq-accent/20 text-hq-accent' : 'bg-hq-red/20 text-hq-red'"
                x-text="(trading.summary.settings||{}).paper_trading !== false ? '가상 모드' : '실거래 모드'"></span>
          <button @click="trading.showOrderModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
        </div>
      </div>
      <!-- 실거래 경고 -->
      <div x-show="(trading.summary.settings||{}).paper_trading === false" class="bg-hq-red/10 border border-hq-red/30 rounded-lg p-2.5 mb-3 text-xs text-hq-red">
        실거래 모드 — 실제 증권 계좌에서 주문이 실행됩니다
      </div>
      <div class="space-y-3">
        <div class="flex gap-2">
          <button @click="trading.orderForm.action = 'buy'" :class="trading.orderForm.action === 'buy' ? 'bg-hq-green text-white' : 'bg-hq-surface text-hq-muted'" class="flex-1 py-2 rounded-lg text-sm font-bold transition">매수</button>
          <button @click="trading.orderForm.action = 'sell'" :class="trading.orderForm.action === 'sell' ? 'bg-hq-red text-white' : 'bg-hq-surface text-hq-muted'" class="flex-1 py-2 rounded-lg text-sm font-bold transition">매도</button>
        </div>
        <!-- 시장 선택 -->
        <div class="flex gap-2">
          <button @click="trading.orderForm.market = 'KR'" :class="(trading.orderForm.market||'KR') === 'KR' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent/40' : 'bg-hq-surface text-hq-muted border-hq-border'" class="flex-1 py-1.5 rounded-lg text-xs font-bold border transition">한국</button>
          <button @click="trading.orderForm.market = 'US'" :class="trading.orderForm.market === 'US' ? 'bg-hq-accent/20 text-hq-accent border-hq-accent/40' : 'bg-hq-surface text-hq-muted border-hq-border'" class="flex-1 py-1.5 rounded-lg text-xs font-bold border transition">미국</button>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목코드</label>
          <input x-model="trading.orderForm.ticker" :placeholder="(trading.orderForm.market||'KR')==='KR' ? '예: 005930' : '예: AAPL'" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목명</label>
          <input x-model="trading.orderForm.name" :placeholder="(trading.orderForm.market||'KR')==='KR' ? '예: 삼성전자' : '예: Apple'" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-hq-muted block mb-1">수량 (주)</label>
            <input type="number" x-model.number="trading.orderForm.qty" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
          <div>
            <label class="text-[10px] text-hq-muted block mb-1" x-text="(trading.orderForm.market||'KR')==='KR' ? '가격 (원)' : '가격 ($)'">가격 (원)</label>
            <input type="number" x-model.number="trading.orderForm.price" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
          </div>
        </div>
        <div class="bg-hq-surface rounded-lg p-3 text-xs">
          <div class="flex justify-between text-hq-muted">
            <span>주문 총액</span>
            <span class="font-bold text-hq-text" x-text="((trading.orderForm.qty || 0) * (trading.orderForm.price || 0)).toLocaleString() + ((trading.orderForm.market||'KR')==='KR' ? '원' : '$')"></span>
          </div>
        </div>
        <button @click="tradingOrder()" class="w-full py-2.5 rounded-lg text-sm font-bold transition"
                :class="trading.orderForm.action === 'buy' ? 'bg-hq-green text-white hover:bg-hq-green/80' : 'bg-hq-red text-white hover:bg-hq-red/80'"
                x-text="trading.orderForm.action === 'buy' ? '매수 실행' : '매도 실행'"></button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Watchlist Modal (관심종목 추가) ═══ -->
  <div x-show="trading.showWatchModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showWatchModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[420px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">관심종목 추가</h2>
        <button @click="trading.showWatchModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">시장</label>
          <div class="flex gap-2">
            <button @click="trading.watchForm.market='KR'"
                    :class="trading.watchForm.market==='KR' ? 'bg-hq-accent/30 text-hq-accent border-hq-accent' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">🇰🇷 한국</button>
            <button @click="trading.watchForm.market='US'"
                    :class="trading.watchForm.market==='US' ? 'bg-hq-cyan/30 text-hq-cyan border-hq-cyan' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">🇺🇸 미국</button>
          </div>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목코드</label>
          <input x-model="trading.watchForm.ticker"
                 :placeholder="trading.watchForm.market==='KR' ? '예: 005930' : '예: AAPL, TSLA, NVDA'"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">종목명</label>
          <input x-model="trading.watchForm.name"
                 :placeholder="trading.watchForm.market==='KR' ? '예: 삼성전자' : '예: Apple'"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1" x-text="trading.watchForm.market==='KR' ? '목표 가격 (원)' : '목표 가격 ($)'"></label>
          <input type="number" x-model.number="trading.watchForm.target_price" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text text-right">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">메모</label>
          <input x-model="trading.watchForm.notes" placeholder="메모 (선택)" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <button @click="addWatchlistItem()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition">관심종목 추가</button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Watchlist Edit Modal (관심종목 수정) ═══ -->
  <div x-show="trading.showWatchEditModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showWatchEditModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[420px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <div>
          <h2 class="text-lg font-bold text-hq-text">관심종목 수정</h2>
          <p class="text-[10px] text-hq-muted mt-0.5" x-text="trading.watchEditForm.name + ' (' + trading.watchEditForm.ticker + ')'"></p>
        </div>
        <button @click="trading.showWatchEditModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">목표가 <span class="text-hq-muted/50" x-text="(trading.watchEditForm.market||'KR')==='US' ? '(USD)' : '(원)'"></span></label>
          <input x-model.number="trading.watchEditForm.target_price" type="number" placeholder="0" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text font-mono">
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">알림 조건</label>
          <div class="flex gap-2">
            <button @click="trading.watchEditForm.alert_type='above'"
                    :class="trading.watchEditForm.alert_type==='above' ? 'bg-hq-green/20 text-hq-green border-hq-green/40' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">↑ 이상 시 알림</button>
            <button @click="trading.watchEditForm.alert_type='below'"
                    :class="trading.watchEditForm.alert_type==='below' ? 'bg-blue-500/20 text-blue-400 border-blue-500/40' : 'bg-hq-bg text-hq-muted border-hq-border'"
                    class="flex-1 border rounded-lg py-2 text-xs font-bold transition">↓ 이하 시 알림</button>
          </div>
        </div>
        <div>
          <label class="text-[10px] text-hq-muted block mb-1">메모</label>
          <input x-model="trading.watchEditForm.notes" placeholder="메모 (선택)" class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <button @click="updateWatchlistItem()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition">수정 저장</button>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Chart Slide Panel (종목 차트 C안) ═══ -->
  <div x-show="trading.showChartModal" x-transition.opacity
       class="fixed inset-0 z-50 bg-black/40" @click="trading.showChartModal = false" style="display: none;"></div>
  <div x-show="trading.showChartModal"
       x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
       x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full"
       class="fixed top-0 right-0 z-50 h-full w-full max-w-[420px] bg-hq-panel border-l border-hq-border shadow-2xl overflow-y-auto" style="display: none;">
    <!-- 헤더 -->
    <div class="sticky top-0 bg-hq-panel/95 backdrop-blur-sm border-b border-hq-border z-10 px-5 py-4">
      <div class="flex items-center justify-between">
        <div class="min-w-0">
          <h2 class="text-base font-bold text-hq-text truncate" x-text="trading.chartName"></h2>
          <p class="text-xs text-hq-muted font-mono mt-0.5" x-text="trading.chartTicker + ' · ' + (trading.chartMarket || 'KR')"></p>
        </div>
        <button @click="trading.showChartModal = false" class="ml-3 flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-hq-surface hover:bg-hq-border/50 text-hq-muted hover:text-hq-text transition">&times;</button>
      </div>
      <!-- 현재가 요약 -->
      <div x-show="!trading.chartLoading && trading.chartData.length > 0" class="mt-3 flex items-end gap-3">
        <span class="text-2xl font-bold text-hq-text font-mono" x-text="trading.chartData.length > 0 ? trading.chartData[trading.chartData.length-1].close.toLocaleString() : '-'"></span>
        <span class="text-sm font-bold mb-0.5"
              :class="trading.chartData.length >= 2 && trading.chartData[trading.chartData.length-1].close >= trading.chartData[trading.chartData.length-2].close ? 'text-hq-red' : 'text-blue-400'"
              x-text="(() => { if(trading.chartData.length < 2) return ''; const cur = trading.chartData[trading.chartData.length-1].close; const prev = trading.chartData[trading.chartData.length-2].close; const pct = ((cur - prev) / prev * 100).toFixed(2); return (pct >= 0 ? '+' : '') + pct + '%'; })()"></span>
      </div>
    </div>

    <!-- 차트 본문 -->
    <div class="px-5 py-4 space-y-4">
      <div x-show="trading.chartLoading" class="flex items-center justify-center py-16">
        <span class="text-hq-muted text-xs animate-pulse">차트 데이터 불러오는 중...</span>
      </div>
      <div x-show="!trading.chartLoading && trading.chartData.length === 0" class="text-center py-16 text-hq-muted/70 text-xs">
        차트 데이터가 없습니다
      </div>
      <div x-show="!trading.chartLoading && trading.chartData.length > 0">
        <!-- SVG 선 그래프 -->
        <div class="bg-hq-bg rounded-xl p-3 border border-hq-border/50">
          <svg viewBox="0 0 560 200" class="w-full" style="height: 180px;">
            <line x1="40" y1="10" x2="550" y2="10" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
            <line x1="40" y1="60" x2="550" y2="60" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
            <line x1="40" y1="110" x2="550" y2="110" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
            <line x1="40" y1="160" x2="550" y2="160" stroke="rgb(var(--hq-border))" stroke-width="0.5" opacity="0.3"/>
            <defs>
              <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(var(--hq-cyan))" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="rgb(var(--hq-cyan))" stop-opacity="0.02"/>
              </linearGradient>
            </defs>
            <polygon :points="getChartAreaPoints()" fill="url(#chartGrad)"/>
            <polyline :points="getChartLinePoints()" fill="none" stroke="rgb(var(--hq-cyan))" stroke-width="2" stroke-linejoin="round"/>
            <text x="36" y="14" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(1)"></text>
            <text x="36" y="64" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0.67)"></text>
            <text x="36" y="114" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0.33)"></text>
            <text x="36" y="164" fill="rgb(var(--hq-muted))" font-size="8" text-anchor="end" x-text="getChartYLabel(0)"></text>
          </svg>
          <div class="flex justify-between px-10 text-[8px] text-hq-muted -mt-1">
            <span x-text="trading.chartData.length > 0 ? trading.chartData[0].date : ''"></span>
            <span x-text="trading.chartData.length > 10 ? trading.chartData[Math.floor(trading.chartData.length/2)].date : ''"></span>
            <span x-text="trading.chartData.length > 0 ? trading.chartData[trading.chartData.length-1].date : ''"></span>
          </div>
        </div>
        <!-- 가격 요약 -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3">
          <div class="bg-hq-surface rounded-lg p-2.5 text-center">
            <div class="text-[9px] text-hq-muted">시작가</div>
            <div class="text-xs font-bold text-hq-text font-mono" x-text="trading.chartData.length > 0 ? trading.chartData[0].close.toLocaleString() : '-'"></div>
          </div>
          <div class="bg-hq-surface rounded-lg p-2.5 text-center">
            <div class="text-[9px] text-hq-muted">최고가</div>
            <div class="text-xs font-bold text-hq-red font-mono" x-text="trading.chartData.length > 0 ? Math.max(...trading.chartData.map(d=>d.close)).toLocaleString() : '-'"></div>
          </div>
          <div class="bg-hq-surface rounded-lg p-2.5 text-center">
            <div class="text-[9px] text-hq-muted">최저가</div>
            <div class="text-xs font-bold text-blue-400 font-mono" x-text="trading.chartData.length > 0 ? Math.min(...trading.chartData.map(d=>d.close)).toLocaleString() : '-'"></div>
          </div>
          <div class="bg-hq-surface rounded-lg p-2.5 text-center">
            <div class="text-[9px] text-hq-muted">현재가</div>
            <div class="text-xs font-bold text-hq-cyan font-mono" x-text="trading.chartData.length > 0 ? trading.chartData[trading.chartData.length-1].close.toLocaleString() : '-'"></div>
          </div>
        </div>
        <!-- CIO 최근 시그널 (있으면 표시) -->
        <template x-if="trading.signals && trading.signals.filter(s => s.ticker === trading.chartTicker).length > 0">
          <div class="mt-4 bg-hq-surface rounded-xl p-3 border border-hq-border/50">
            <div class="text-[10px] text-hq-muted font-bold mb-2">금융분석팀 최근 시그널</div>
            <template x-for="sig in trading.signals.filter(s => s.ticker === trading.chartTicker).slice(0,2)" :key="sig.ticker + sig.action">
              <div class="flex items-center gap-2 mb-1.5 last:mb-0">
                <span class="text-[10px] px-1.5 py-0.5 rounded font-bold"
                      :class="sig.action === 'buy' ? 'bg-hq-red/20 text-hq-red' : sig.action === 'sell' ? 'bg-blue-500/20 text-blue-400' : 'bg-hq-surface text-hq-muted'"
                      x-text="sig.action === 'buy' ? '매수' : sig.action === 'sell' ? '매도' : '관망'"></span>
                <span class="text-[10px] text-hq-muted" x-text="'신뢰도 ' + (sig.confidence || 0) + '%'"></span>
                <span class="text-[10px] text-hq-text truncate flex-1" x-text="sig.reason || ''"></span>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- ═══ Trading Settings Modal (자동매매 설정 — CEO 읽기 전용 + 성향 슬라이더) ═══ -->
  <div x-show="trading.showSettingsModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="trading.showSettingsModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[520px] mx-4 p-6 max-h-[90vh] overflow-y-auto" @click.stop
         x-data="{
           riskProfile: 'aggressive',
           changeHistory: [],
           saving: false,
           async loadProfile() {
             try {
               const res = await fetch('/api/trading/risk-profile').then(r=>r.json());
               this.riskProfile = res.profile || 'aggressive';
               this.changeHistory = res.change_history || [];
             } catch {}
           },
           async setProfile(p) {
             this.saving = true;
             try {
               const res = await fetch('/api/trading/risk-profile', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({profile:p})}).then(r=>r.json());
               if (res.success) { this.riskProfile = p; $dispatch('trading-settings-updated'); }
             } catch {}
             this.saving = false;
             await this.loadProfile();
           }
         }" x-init="loadProfile()">

      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">자동매매 설정</h2>
        <button @click="trading.showSettingsModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <!-- 투자 성향 슬라이더 (CEO가 유일하게 변경 가능한 것) -->
      <div class="mb-5 p-4 bg-hq-surface rounded-xl border border-hq-border">
        <p class="text-xs font-bold text-hq-text mb-3">투자 성향</p>
        <div class="flex gap-2">
          <button @click="setProfile('conservative')" :disabled="saving"
                  :class="riskProfile === 'conservative' ? 'bg-blue-500/20 text-blue-400 border-blue-500/40 ring-1 ring-blue-500/30' : 'bg-hq-bg text-hq-muted border-hq-border hover:border-blue-500/30'"
                  class="flex-1 border rounded-xl py-3 text-center transition">
            <div class="text-lg mb-0.5">🐢</div>
            <div class="text-xs font-bold">보수적</div>
          </button>
          <button @click="setProfile('balanced')" :disabled="saving"
                  :class="riskProfile === 'balanced' ? 'bg-hq-yellow/20 text-hq-yellow border-hq-yellow/40 ring-1 ring-hq-yellow/30' : 'bg-hq-bg text-hq-muted border-hq-border hover:border-hq-yellow/30'"
                  class="flex-1 border rounded-xl py-3 text-center transition">
            <div class="text-lg mb-0.5">⚖️</div>
            <div class="text-xs font-bold">균형</div>
          </button>
          <button @click="setProfile('aggressive')" :disabled="saving"
                  :class="riskProfile === 'aggressive' ? 'bg-hq-red/20 text-hq-red border-hq-red/40 ring-1 ring-hq-red/30' : 'bg-hq-bg text-hq-muted border-hq-border hover:border-hq-red/30'"
                  class="flex-1 border rounded-xl py-3 text-center transition">
            <div class="text-lg mb-0.5">🔥</div>
            <div class="text-xs font-bold">공격적</div>
          </button>
        </div>
        <p class="text-[9px] text-hq-muted mt-2 text-center">금융분석팀장이 이 성향에 맞춰 안전 범위 내에서 자율적으로 설정을 조정합니다</p>
      </div>

      <!-- 현재 설정값 (읽기 전용) -->
      <div class="mb-4">
        <p class="text-[10px] font-bold text-hq-muted mb-2">현재 설정 (금융분석팀장 자율 관리)</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">종목당 최대</div>
            <div class="text-sm font-bold text-hq-text font-mono" x-text="(trading.settings.max_position_pct || 20) + '%'"></div>
          </div>
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">최소 신뢰도</div>
            <div class="text-sm font-bold text-hq-text font-mono" x-text="(trading.settings.min_confidence || 65) + '%'"></div>
          </div>
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">주문 금액</div>
            <div class="text-sm font-bold text-hq-text font-mono" x-text="(trading.settings.order_size || 0) === 0 ? '금융분석팀장 자율' : (trading.settings.order_size||0).toLocaleString()"></div>
          </div>
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">손절</div>
            <div class="text-sm font-bold text-hq-red font-mono" x-text="(trading.settings.default_stop_loss_pct || -5) + '%'"></div>
          </div>
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">익절</div>
            <div class="text-sm font-bold text-hq-green font-mono" x-text="'+' + (trading.settings.default_take_profit_pct || 10) + '%'"></div>
          </div>
          <div class="bg-hq-bg rounded-lg p-2.5 text-center border border-hq-border/50">
            <div class="text-[9px] text-hq-muted">일일 최대</div>
            <div class="text-sm font-bold text-hq-text font-mono" x-text="(trading.settings.max_daily_trades || 10) + '회'"></div>
          </div>
        </div>
      </div>

      <!-- 매매 모드 선택 (3단 라디오) -->
      <div class="p-3 bg-hq-surface rounded-lg space-y-3 mb-4">
        <p class="text-[10px] font-bold text-hq-muted mb-1">매매 모드</p>
        <div class="space-y-2">
          <label class="flex items-center gap-3 p-2 rounded-lg cursor-pointer transition"
                 :class="trading.settings.enable_real && !trading.settings.paper_trading ? 'bg-green-500/10 border border-green-500/30' : 'hover:bg-hq-bg border border-transparent'">
            <input type="radio" name="trading_mode" value="real"
                   :checked="trading.settings.enable_real && !trading.settings.paper_trading"
                   @change="trading.settings.enable_real=true; trading.settings.enable_mock=false; trading.settings.paper_trading=false"
                   class="accent-green-500">
            <div>
              <span class="text-xs font-bold text-hq-green">실거래</span>
              <p class="text-[9px] text-hq-muted">KIS 실계좌로 실제 주문 (실제 돈)</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-2 rounded-lg cursor-pointer transition"
                 :class="trading.settings.enable_mock && trading.settings.paper_trading ? 'bg-purple-500/10 border border-purple-500/30' : 'hover:bg-hq-bg border border-transparent'">
            <input type="radio" name="trading_mode" value="mock"
                   :checked="trading.settings.enable_mock && trading.settings.paper_trading"
                   @change="trading.settings.enable_real=false; trading.settings.enable_mock=true; trading.settings.paper_trading=true"
                   class="accent-purple-500">
            <div>
              <span class="text-xs font-bold text-hq-purple">모의투자</span>
              <p class="text-[9px] text-hq-muted">KIS 모의계좌로 주문 (연습용)</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-2 rounded-lg cursor-pointer transition"
                 :class="!trading.settings.enable_real && !trading.settings.enable_mock ? 'bg-hq-accent/10 border border-hq-accent/30' : 'hover:bg-hq-bg border border-transparent'">
            <input type="radio" name="trading_mode" value="virtual"
                   :checked="!trading.settings.enable_real && !trading.settings.enable_mock"
                   @change="trading.settings.enable_real=false; trading.settings.enable_mock=false; trading.settings.paper_trading=true"
                   class="accent-blue-500">
            <div>
              <span class="text-xs font-bold text-hq-accent">가상투자</span>
              <p class="text-[9px] text-hq-muted">내부 포트폴리오만 (KIS 미사용)</p>
            </div>
          </label>
        </div>
        <!-- CIO 자동실행 토글 -->
        <div class="pt-2 border-t border-hq-border/50">
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_execute" class="rounded">
            <span class="text-hq-yellow font-bold">금융분석팀장 자동실행</span>
            <span class="text-[9px] text-hq-muted">(신뢰도 이상 시 자동 매수/매도)</span>
          </label>
        </div>
        <!-- 손절/익절 -->
        <div class="flex gap-4 pt-1 border-t border-hq-border/50">
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_stop_loss" class="rounded">
            <span>자동 손절</span>
          </label>
          <label class="flex items-center gap-2 text-xs text-hq-text cursor-pointer">
            <input type="checkbox" x-model="trading.settings.auto_take_profit" class="rounded">
            <span>자동 익절</span>
          </label>
        </div>
      </div>
      <button @click="saveTradingSettings()" class="w-full bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 rounded-lg py-2.5 text-sm font-bold transition mb-4">설정 저장</button>

      <!-- CIO 변경 이력 -->
      <div x-show="changeHistory.length > 0" x-data="{ showHistory: false }">
        <button @click="showHistory = !showHistory" class="flex items-center gap-1 text-[10px] text-hq-muted font-semibold hover:text-hq-text transition w-full">
          <span x-text="showHistory ? '▼' : '▶'"></span>
          <span>설정 변경 이력</span>
          <span class="text-hq-accent ml-1" x-text="changeHistory.length + '건'"></span>
        </button>
        <div x-show="showHistory" x-transition class="mt-2 space-y-1.5 max-h-40 overflow-y-auto">
          <template x-for="h in [...changeHistory].reverse().slice(0,10)" :key="h.changed_at">
            <div class="bg-hq-bg rounded-lg px-3 py-2 text-[9px] border border-hq-border/30">
              <div class="flex items-center justify-between">
                <span class="font-bold" :class="h.changed_by === '금융분석팀장' ? 'text-hq-cyan' : 'text-hq-yellow'" x-text="h.changed_by"></span>
                <span class="text-hq-muted font-mono" x-text="h.changed_at ? h.changed_at.slice(5,16).replace('T',' ') : ''"></span>
              </div>
              <div class="text-hq-text mt-0.5" x-text="h.detail || h.action"></div>
            </div>
          </template>
        </div>
      </div>

      <div x-show="(trading.summary.settings||{}).kis_connected" class="bg-hq-green/10 border border-hq-green/20 rounded-lg p-3 text-[10px] text-hq-green mt-3">
        ✅ KIS(한국투자증권) API 연결됨 — 실거래 주문 가능.
      </div>
    </div>
  </div>

  <!-- ═══ Schedule Add Modal (예약 추가) ═══ -->
  <div x-show="schedules.showModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="schedules.showModal = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">새 예약 추가</h2>
        <button @click="schedules.showModal = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">예약 이름</label>
          <input x-model="schedules.editName" placeholder="예: 일일 보고서"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행할 명령</label>
          <textarea x-model="schedules.editCommand" placeholder="예: 오늘 회사 현황을 보고서로 작성해줘" rows="2"
                    class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none resize-none"></textarea>
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">실행 주기</label>
          <div class="grid grid-cols-2 gap-2">
            <template x-for="preset in schedules.cronPresets" :key="preset">
              <button @click="schedules.editCronPreset = preset"
                      class="text-xs px-3 py-2 rounded-lg border transition text-left"
                      :class="schedules.editCronPreset === preset
                        ? 'border-hq-accent bg-hq-accent/15 text-hq-accent'
                        : 'border-hq-border text-hq-muted hover:border-hq-border-light'"
                      x-text="preset"></button>
            </template>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="schedules.showModal = false"
                class="px-4 py-2 text-sm text-hq-muted hover:text-hq-text transition">취소</button>
        <button @click="addSchedule()"
                class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition">추가</button>
      </div>
    </div>
  </div>

  <!-- ═══ Universal Delete Confirm Modal (범용 삭제 확인) ═══ -->
  <div x-show="confirmDelete.type" x-transition.opacity
       class="fixed inset-0 z-[60] flex items-center justify-center backdrop-blur-lg"
       :class="darkMode ? 'bg-black/60' : 'bg-black/30'"
       @click.self="confirmDelete = {type:null, id:null, name:null}" style="display: none;">
    <div class="relative overflow-hidden rounded-3xl w-full max-w-[400px] mx-4 text-center" @click.stop
         :style="darkMode
           ? 'background: rgba(18,10,36,0.92); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(239,68,68,0.12), 0 0 120px rgba(139,92,246,0.08), 0 8px 32px rgba(0,0,0,0.4);'
           : 'background: rgba(255,255,255,0.96); border: 1px solid rgba(220,120,160,0.2); box-shadow: 0 0 40px rgba(220,100,140,0.06), 0 8px 32px rgba(0,0,0,0.08);'"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-90 translate-y-4"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0">
      <!-- 오로라 배경 그라데이션 -->
      <div :style="darkMode
        ? 'position:absolute; inset:0; background: linear-gradient(135deg, rgba(239,68,68,0.06) 0%, rgba(139,92,246,0.08) 40%, rgba(236,72,153,0.06) 70%, rgba(239,68,68,0.04) 100%); pointer-events:none;'
        : 'position:absolute; inset:0; background: linear-gradient(135deg, rgba(236,72,153,0.03) 0%, rgba(168,85,247,0.03) 40%, rgba(244,114,182,0.02) 100%); pointer-events:none;'"></div>
      <!-- 상단 분홍 라인 -->
      <div :style="darkMode
        ? 'position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, transparent, rgba(239,68,68,0.6), rgba(236,72,153,0.4), transparent);'
        : 'position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, transparent, rgba(236,72,153,0.4), rgba(168,85,247,0.25), transparent);'"></div>
      <div class="relative px-8 pt-8 pb-7">
        <!-- 큰 아이콘 + 분홍 글로우 -->
        <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"
             :style="darkMode
               ? 'background: radial-gradient(circle, rgba(239,68,68,0.2) 0%, rgba(239,68,68,0.05) 70%); border: 1.5px solid rgba(239,68,68,0.3); box-shadow: 0 0 30px rgba(239,68,68,0.25), 0 0 60px rgba(239,68,68,0.1);'
               : 'background: radial-gradient(circle, rgba(236,72,153,0.1) 0%, rgba(244,114,182,0.03) 70%); border: 1.5px solid rgba(236,72,153,0.2); box-shadow: 0 0 20px rgba(236,72,153,0.08);'">
          <svg class="w-9 h-9" :style="darkMode
            ? 'color: rgb(252,129,129); filter: drop-shadow(0 0 8px rgba(239,68,68,0.4));'
            : 'color: rgb(219,39,119); filter: drop-shadow(0 0 6px rgba(236,72,153,0.2));'" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </div>
        <!-- 제목 (타입에 따라 다르게) -->
        <h3 class="text-lg font-bold text-hq-text mb-3" x-text="confirmDelete.type === 'workflow' ? '워크플로우를 삭제하시겠습니까?' : '예약을 삭제하시겠습니까?'"></h3>
        <!-- 이름 하이라이트 -->
        <div class="mb-6">
          <div class="inline-block rounded-lg px-4 py-2"
               :style="darkMode
                 ? 'background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.15);'
                 : 'background: rgba(236,72,153,0.06); border: 1px solid rgba(236,72,153,0.12);'">
            <span class="text-sm font-semibold"
                  :style="darkMode ? 'color: rgb(252,165,165);' : 'color: rgb(190,24,93);'"
                  x-text="confirmDelete.name || '이름 없음'"></span>
          </div>
          <p class="text-[13px] mt-3" :style="darkMode ? 'color: rgba(200,195,220,0.6);' : 'color: rgba(100,95,120,0.65);'">이 항목은 영구적으로 삭제되며 복구할 수 없습니다.</p>
        </div>
        <!-- 버튼 (전체 너비, 세로 배치) -->
        <div class="space-y-2.5">
          <button @click="if(confirmDelete.type==='schedule') deleteSchedule(confirmDelete.id); else if(confirmDelete.type==='workflow') deleteWorkflow(confirmDelete.id); confirmDelete={type:null,id:null,name:null};"
                  class="w-full py-3 text-sm text-white rounded-2xl font-semibold transition-all duration-200"
                  :style="darkMode
                    ? 'background: linear-gradient(135deg, rgb(220,50,50), rgb(180,30,80)); box-shadow: 0 0 20px rgba(239,68,68,0.3), 0 4px 12px rgba(0,0,0,0.3);'
                    : 'background: linear-gradient(135deg, rgb(219,39,119), rgb(190,24,93)); box-shadow: 0 2px 12px rgba(219,39,119,0.25);'"
                  @mouseover="$el.style.transform='translateY(-1px)'; $el.style.boxShadow=darkMode ? '0 0 35px rgba(239,68,68,0.5), 0 4px 16px rgba(0,0,0,0.4)' : '0 4px 20px rgba(219,39,119,0.35)'"
                  @mouseout="$el.style.transform='translateY(0)'; $el.style.boxShadow=darkMode ? '0 0 20px rgba(239,68,68,0.3), 0 4px 12px rgba(0,0,0,0.3)' : '0 2px 12px rgba(219,39,119,0.25)'">삭제하기</button>
          <button @click="confirmDelete = {type:null, id:null, name:null}"
                  class="w-full py-3 text-sm rounded-2xl transition-all duration-200 font-medium"
                  :style="darkMode
                    ? 'color: rgba(200,195,220,0.8); border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04);'
                    : 'color: rgba(85,80,108,0.7); border: 1px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.02);'"
                  @mouseover="$el.style.background=darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)'; $el.style.borderColor=darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'"
                  @mouseout="$el.style.background=darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.02)'; $el.style.borderColor=darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Agent Memory Modal (에이전트 기억) ═══ -->
  <div x-show="memoryModal.visible" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="memoryModal.visible = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[80vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text">
          <span x-text="memoryModal.agentName"></span> 기억 관리
        </h2>
        <button @click="memoryModal.visible = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <!-- 기억 추가 -->
      <div class="bg-hq-bg rounded-xl p-4 mb-4">
        <div class="text-xs text-hq-muted font-semibold mb-2">새 기억 추가</div>
        <div class="flex gap-2 mb-2">
          <input x-model="memoryModal.newKey" placeholder="제목 (예: 선호하는 보고서 형식)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div class="flex gap-2">
          <input x-model="memoryModal.newValue" placeholder="내용 (예: 표와 그래프를 포함한 형식 선호)"
                 class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-1.5 text-sm text-hq-text focus:border-hq-accent outline-none"
                 @keydown.enter="addMemory()">
          <button @click="addMemory()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-1.5 text-xs font-semibold transition">추가</button>
        </div>
      </div>

      <!-- 기억 목록 -->
      <div class="space-y-2">
        <template x-for="mem in memoryModal.items" :key="mem.memory_id">
          <div class="flex items-start gap-3 bg-hq-bg rounded-lg p-3 group">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-semibold text-hq-accent" x-text="mem.key"></span>
                <span class="text-[10px] px-1.5 py-0.5 rounded"
                      :class="mem.source === 'auto' ? 'bg-hq-purple/15 text-hq-purple' : 'bg-hq-green/15 text-hq-green'"
                      x-text="mem.source === 'auto' ? '자동' : '수동'"></span>
              </div>
              <div class="text-xs text-hq-muted" x-text="mem.value"></div>
            </div>
            <button @click="deleteMemory(mem.memory_id)"
                    class="text-hq-red/50 hover:text-hq-red text-sm opacity-0 group-hover:opacity-100 transition">&times;</button>
          </div>
        </template>
        <template x-if="!memoryModal.items || memoryModal.items.length === 0">
          <div class="text-center py-8 text-hq-muted/80 text-sm">아직 저장된 기억이 없습니다.</div>
        </template>
      </div>
    </div>
  </div>

  <!-- ═══ Workflow Editor Modal (워크플로우 편집기) ═══ -->
  <div x-show="workflows.showEditor" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="workflows.showEditor = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[80vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-hq-text" x-text="workflows.editing ? '워크플로우 수정' : '새 워크플로우'"></h2>
        <button @click="workflows.showEditor = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">이름</label>
          <input x-model="workflows.editName" placeholder="워크플로우 이름"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">설명</label>
          <input x-model="workflows.editDesc" placeholder="워크플로우 설명 (선택)"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text focus:border-hq-accent outline-none">
        </div>

        <!-- Steps -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="text-xs text-hq-muted font-semibold">단계 목록</label>
            <button @click="workflows.editSteps.push({name:'', command:''})"
                    class="text-[10px] px-2 py-1 rounded border border-hq-accent/30 text-hq-accent hover:bg-hq-accent/10 transition">+ 단계 추가</button>
          </div>
          <div class="space-y-2">
            <template x-for="(step, idx) in workflows.editSteps" :key="idx">
              <div class="bg-hq-bg rounded-lg p-3">
                <div class="flex items-start gap-2">
                  <div class="text-xs text-hq-muted mt-1.5 font-mono w-6 shrink-0" x-text="(idx+1) + '.'"></div>
                  <div class="flex-1 space-y-1.5">
                    <input x-model="step.name" :placeholder="'단계 ' + (idx+1) + ' 이름'"
                           class="w-full bg-hq-panel border border-hq-border rounded px-2 py-1 text-xs text-hq-text focus:border-hq-accent outline-none">
                    <textarea x-model="step.command" :placeholder="idx === 0 ? '이 단계에서 AI에게 시킬 작업을 입력하세요' : '이 단계에서 AI에게 시킬 작업 (아래 버튼으로 이전 결과를 가져올 수 있어요)'" rows="2"
                              :id="'wf-step-cmd-' + idx"
                              class="w-full bg-hq-panel border border-hq-border rounded px-2 py-1 text-xs text-hq-text focus:border-hq-accent outline-none resize-none"></textarea>
                    <!-- 이전 결과 삽입 버튼 (2단계부터만 표시) -->
                    <button x-show="idx > 0"
                            @click="(() => { const ta = document.getElementById('wf-step-cmd-' + idx); const pos = ta.selectionStart || step.command.length; step.command = step.command.slice(0, pos) + '{prev_result}' + step.command.slice(pos); $nextTick(() => { ta.focus(); ta.setSelectionRange(pos + 13, pos + 13); }); })()"
                            class="inline-flex items-center gap-1 text-[10px] px-2 py-0.5 rounded border border-hq-cyan/30 text-hq-cyan hover:bg-hq-cyan/10 transition">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                      이전 결과 삽입
                    </button>
                  </div>
                  <button @click="workflows.editSteps.splice(idx, 1)"
                          class="text-hq-red/50 hover:text-hq-red text-sm mt-1"
                          x-show="workflows.editSteps.length > 1">&times;</button>
                </div>
                <!-- 단계 간 화살표 -->
                <div x-show="idx < workflows.editSteps.length - 1" class="flex justify-center mt-2 text-hq-muted/30">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                </div>
              </div>
            </template>
          </div>
          <div class="text-[10px] text-hq-muted/80 mt-2 bg-hq-panel/50 rounded-lg px-3 py-1.5">
            💡 2단계부터 '이전 결과 삽입' 버튼으로 앞 단계의 AI 답변을 가져올 수 있어요
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button @click="workflows.showEditor = false"
                class="px-4 py-2 text-sm text-hq-muted hover:text-hq-text transition">취소</button>
        <button @click="saveWorkflow()"
                class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition">저장</button>
      </div>
    </div>
  </div>

  <!-- ═══ 워크플로우 실행창 모달 (비활성 — 카드 내 직접 실행으로 대체) ═══ -->
  <div x-show="false"
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       style="display: none !important;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[650px] mx-4 max-h-[85vh] overflow-y-auto p-6" @click.stop>
      <!-- 헤더 -->
      <div class="flex items-center justify-between mb-5">
        <div>
          <h2 class="text-lg font-bold text-hq-text font-title" x-text="workflowExec.workflowName"></h2>
          <p class="text-xs text-hq-muted mt-0.5">워크플로우 실행</p>
        </div>
        <button @click="closeWorkflowExec()" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>

      <!-- 모드 선택 -->
      <div class="flex items-center gap-3 mb-5 p-3 rounded-xl bg-hq-bg/50 border border-hq-border/30">
        <span class="text-xs text-hq-muted font-semibold">모드:</span>
        <button @click="workflowExec.mode = 'realtime'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="workflowExec.mode === 'realtime' ? 'bg-hq-accent text-white' : 'text-hq-muted hover:text-hq-text border border-hq-border'">
          실시간
        </button>
        <button @click="workflowExec.mode = 'batch'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="workflowExec.mode === 'batch' ? 'bg-hq-accent text-white' : 'text-hq-muted hover:text-hq-text border border-hq-border'">
          배치
        </button>
        <span class="text-[10px] text-hq-muted/60 ml-1" x-text="workflowExec.mode === 'realtime' ? '단계별로 결과를 바로 보여줍니다' : '전부 끝나면 결과를 한꺼번에 보여줍니다'"></span>
      </div>

      <!-- 단계별 진행 상태 -->
      <div class="space-y-2 mb-5">
        <template x-for="(step, i) in workflowExec.steps" :key="i">
          <div class="flex items-start gap-3 p-3 rounded-xl transition-all"
               :class="step.status === 'running' ? 'bg-hq-yellow/5 border border-hq-yellow/20' : step.status === 'completed' ? 'bg-hq-green/5 border border-hq-green/20' : step.status === 'failed' ? 'bg-hq-red/5 border border-hq-red/20' : 'bg-hq-bg/30 border border-hq-border/10'">
            <!-- 상태 아이콘 -->
            <div class="w-6 h-6 rounded-full flex items-center justify-center shrink-0 text-xs font-bold mt-0.5"
                 :class="step.status === 'running' ? 'bg-hq-yellow/20 text-hq-yellow animate-pulse' : step.status === 'completed' ? 'bg-hq-green/20 text-hq-green' : step.status === 'failed' ? 'bg-hq-red/20 text-hq-red' : 'bg-hq-muted/10 text-hq-muted/50'">
              <span x-show="step.status === 'pending'" x-text="i + 1"></span>
              <span x-show="step.status === 'running'">
                <svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
              </span>
              <span x-show="step.status === 'completed'">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </span>
              <span x-show="step.status === 'failed'">!</span>
            </div>
            <!-- 단계 정보 -->
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold" :class="step.status === 'running' ? 'text-hq-yellow' : step.status === 'completed' ? 'text-hq-green' : step.status === 'failed' ? 'text-hq-red' : 'text-hq-muted/60'" x-text="step.name"></div>
              <div x-show="step.command" class="text-[10px] text-hq-muted/50 truncate mt-0.5" x-text="step.command"></div>
              <div x-show="step.result && workflowExec.mode === 'realtime'" class="text-xs text-hq-text/80 mt-2 p-2 rounded-lg bg-hq-bg/50 whitespace-pre-wrap max-h-32 overflow-y-auto" x-html="renderMarkdown(step.result)"></div>
            </div>
          </div>
        </template>
      </div>

      <!-- 최종 결과 (배치 모드) -->
      <div x-show="workflowExec.done && workflowExec.finalResult" class="mb-5 p-4 rounded-xl bg-hq-green/5 border border-hq-green/20">
        <div class="text-xs font-semibold text-hq-green mb-2">최종 결과</div>
        <div class="text-sm text-hq-text/80 whitespace-pre-wrap markdown-body max-h-64 overflow-y-auto" x-html="renderMarkdown(workflowExec.finalResult)"></div>
      </div>

      <!-- 에러 표시 -->
      <div x-show="workflowExec.error" class="mb-5 p-4 rounded-xl bg-hq-red/5 border border-hq-red/20">
        <div class="text-xs font-semibold text-hq-red mb-1">오류 발생</div>
        <div class="text-sm text-hq-red/80" x-text="workflowExec.error"></div>
      </div>

      <!-- 하단 버튼 -->
      <div class="flex items-center justify-end gap-3 pt-3 border-t border-hq-border/20">
        <button @click="closeWorkflowExec()"
                class="px-4 py-2 text-sm text-hq-muted hover:text-hq-text transition">닫기</button>
        <button @click="executeWorkflow()"
                :disabled="workflowExec.currentStep >= 0 && !workflowExec.done"
                class="bg-hq-green hover:bg-green-600 text-white rounded-lg px-5 py-2 text-sm font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                x-text="workflowExec.currentStep >= 0 && !workflowExec.done ? '실행 중...' : workflowExec.done ? '다시 실행' : '실행'"></button>
      </div>
    </div>
  </div>

  <!-- ═══ Login Overlay (로그인 오버레이) ═══ -->
  <div x-show="auth.showLogin" x-transition.opacity
       class="fixed inset-0 z-[60] flex items-center justify-center bg-hq-bg/95"
       style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[400px] mx-4 p-8">
      <div class="text-center mb-6">
        <div class="text-2xl font-bold gradient-text mb-2 font-mono tracking-normal">CYBER COMMAND</div>
        <p class="text-sm text-hq-muted">[ ACCESS RESTRICTED ] 인증이 필요합니다</p>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-hq-muted font-semibold mb-1 block">비밀번호</label>
          <input x-model="auth.loginPass" type="password" placeholder="비밀번호"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2.5 text-sm text-hq-text focus:border-hq-accent outline-none"
                 @keydown.enter="doLogin()">
          <p class="text-[10px] text-hq-muted/60 mt-1">기본 비밀번호: corthex2026</p>
        </div>
      </div>

      <div x-show="auth.loginError" class="mt-3 text-xs text-hq-red" x-text="auth.loginError"></div>

      <div class="flex flex-col gap-2 mt-6">
        <button @click="doLogin()"
                class="bg-hq-green/20 hover:bg-hq-green/30 text-hq-green border border-hq-green/40 rounded-lg px-5 py-2.5 text-sm font-semibold font-mono tracking-wide transition w-full">ACCESS</button>
      </div>
    </div>
  </div>

  <!-- ═══ Quality Gate Settings Modal ═══ -->
  <div x-show="showQualitySettings" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showQualitySettings = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[720px] mx-4 max-h-[85vh] flex flex-col"
         @click.stop>

      <!-- Sticky Header -->
      <div class="flex items-center justify-between p-5 pb-4 border-b border-hq-border/50 shrink-0">
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white text-xs font-bold shadow-lg shadow-blue-500/20">QA</span>
          <div>
            <h2 class="text-base font-bold text-hq-text">품질 검수 설정</h2>
            <p class="text-[11px] text-hq-muted/70">매니저급 에이전트가 보고서를 검수할 때 적용되는 기준</p>
          </div>
        </div>
        <button @click="showQualitySettings = false" class="text-hq-muted hover:text-hq-text w-8 h-8 flex items-center justify-center rounded-lg hover:bg-hq-surface transition">&times;</button>
      </div>

      <!-- Scrollable Content -->
      <div class="overflow-y-auto flex-1 p-5 space-y-5">

        <!-- Section 1: Review Model (자기 모델 사용) -->
        <div class="p-4 bg-hq-bg rounded-xl border border-hq-border/30">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">🤖</span>
            <h3 class="text-sm font-semibold text-hq-text">검수 모델</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-green/10 text-hq-green">자동</span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-2">각 매니저가 자기 모델로 직접 검수합니다. 별도 설정 불필요.</p>
          <div class="text-xs text-hq-muted/50 space-y-1">
            <div>비서실장: Claude Sonnet 4.6 | 사업기획팀장: Claude Sonnet 4.6</div>
            <div>법무팀장: Claude Sonnet 4.6 | 마케팅팀장: Claude Sonnet 4.6</div>
            <div>금융분석팀장: GPT-5.2 | 콘텐츠팀장: Claude Sonnet 4.6</div>
          </div>
        </div>

        <!-- Section 2: Common Rubric -->
        <!-- Section 2: Common Checklist (공통 체크리스트) -->
        <div class="p-4 bg-hq-bg rounded-xl border border-hq-border/30" x-show="qualityRules.common_checklist">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">&#10003;</span>
            <h3 class="text-sm font-semibold text-hq-text">공통 체크리스트</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-green/10 text-hq-green">모든 부서</span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-2">모든 검수에 자동 적용되는 체크리스트입니다.</p>
          <div class="space-y-1">
            <template x-for="item in (qualityRules.common_checklist?.required || [])" :key="item.id">
              <div class="flex items-center gap-2 text-xs">
                <span class="font-mono text-hq-accent w-6" x-text="item.id"></span>
                <span class="text-[10px] px-1 rounded bg-hq-red/10 text-hq-red">필수</span>
                <span class="text-hq-text" x-text="item.label"></span>
              </div>
            </template>
            <template x-for="item in (qualityRules.common_checklist?.optional || [])" :key="item.id">
              <div class="flex items-center gap-2 text-xs">
                <span class="font-mono text-hq-accent w-6" x-text="item.id"></span>
                <span class="text-[10px] px-1 rounded bg-hq-muted/10 text-hq-muted">선택</span>
                <span class="text-hq-text" x-text="item.label"></span>
              </div>
            </template>
          </div>
          <div class="mt-2 text-[10px] text-hq-muted/50" x-show="qualityRules.pass_criteria">
            합격 기준: 필수 항목 전부 통과 + 가중 평균 <span x-text="qualityRules.pass_criteria?.min_average_score || 3.0"></span> 이상
          </div>
        </div>

        <!-- Section 3: Default Rubric -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">📋</span>
            <h3 class="text-sm font-semibold text-hq-text">기본 점수 기준</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-muted/10 text-hq-muted">기본값</span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-3">부서별 기준이 없는 부서에 기본 적용되는 점수 기준입니다.</p>

          <div class="p-4 bg-hq-bg rounded-xl border border-hq-border/30 hover:border-hq-border/60 transition cursor-pointer"
               @click="editingRubric === 'default' ? (editingRubric = null) : startEditRubric('default')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-hq-text">기본 (전체 공통)</span>
                <span x-show="qualityRules.rubrics && qualityRules.rubrics['default']"
                      class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-green/10 text-hq-green font-medium">설정됨</span>
              </div>
              <span class="text-[10px] text-hq-muted transition-transform duration-200" :class="editingRubric === 'default' ? 'rotate-90' : ''">&#9654;</span>
            </div>
            <template x-if="qualityRules.rubrics && qualityRules.rubrics['default'] && editingRubric !== 'default'">
              <div class="mt-2 text-xs text-hq-muted/60 space-y-0.5">
                <template x-for="s in (qualityRules.rubrics['default'].scoring || []).slice(0, 3)" :key="s.id">
                  <span class="inline-block mr-2" x-text="s.label + ' (' + s.weight + '%)'"></span>
                </template>
              </div>
            </template>
          </div>
          <!-- Inline Editor (읽기 전용 — YAML에서 직접 편집) -->
          <div x-show="editingRubric === 'default'" x-collapse class="mt-2 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
            <p class="text-xs text-hq-muted/70 mb-3">하이브리드 루브릭은 config/quality_rules.yaml에서 편집합니다.</p>
            <template x-if="qualityRules.rubrics?.['default']?.scoring">
              <div class="space-y-3">
                <template x-for="s in qualityRules.rubrics['default'].scoring" :key="s.id">
                  <div class="bg-hq-surface/30 rounded-lg p-2.5">
                    <div class="flex items-center gap-2 text-xs mb-1.5">
                      <span class="font-mono text-hq-accent w-6" x-text="s.id"></span>
                      <span class="text-hq-text font-medium flex-1" x-text="s.label"></span>
                      <template x-if="s.critical"><span class="text-[9px] px-1 py-0.5 rounded bg-hq-red/20 text-hq-red">★치명적</span></template>
                      <span class="text-hq-muted text-[10px]" x-text="s.weight + '%'"></span>
                    </div>
                    <template x-if="s.criteria">
                      <div class="space-y-1 ml-8">
                        <div class="flex gap-2 text-[10px]"><span class="text-hq-red shrink-0 w-5">1점</span><span class="text-hq-muted/70" x-text="s.criteria[1] || s.criteria['1'] || '-'"></span></div>
                        <div class="flex gap-2 text-[10px]"><span class="text-hq-yellow shrink-0 w-5">3점</span><span class="text-hq-muted/70" x-text="s.criteria[3] || s.criteria['3'] || '-'"></span></div>
                        <div class="flex gap-2 text-[10px]"><span class="text-hq-green shrink-0 w-5">5점</span><span class="text-hq-muted/70" x-text="s.criteria[5] || s.criteria['5'] || '-'"></span></div>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
            <div class="flex items-center gap-2 mt-3">
              <button @click.stop="editingRubric = null" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-4 py-1.5 text-xs transition">닫기</button>
            </div>
          </div>
        </div>

        <!-- Section 3: Department-Specific Rubrics -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm">🏢</span>
            <h3 class="text-sm font-semibold text-hq-text">부서별 검수 기준</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-hq-accent/10 text-hq-accent"
                  x-text="(qualityRules.known_divisions || []).length + '개 부서'"></span>
          </div>
          <p class="text-xs text-hq-muted/70 mb-3">각 부서의 카드를 클릭하면 전용 검수 기준을 설정할 수 있습니다.</p>

          <div class="grid grid-cols-1 gap-2">
            <template x-for="div in (qualityRules.known_divisions || [])" :key="div">
              <div>
                <!-- Department Card -->
                <div class="p-3.5 bg-hq-bg rounded-xl border border-hq-border/30 hover:border-hq-border/60 transition cursor-pointer group"
                     :class="editingRubric === div ? 'border-hq-accent/40' : ''"
                     @click="editingRubric === div ? (editingRubric = null) : startEditRubric(div)">
                  <div class="flex items-center gap-3">
                    <span class="text-lg w-8 h-8 flex items-center justify-center rounded-lg shrink-0"
                          :class="'bg-gradient-to-br ' + getDivisionStyle(div).bg"
                          x-text="getDivisionStyle(div).icon"></span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="text-sm text-hq-text font-medium" x-text="getDivisionLabel(div)"></span>
                        <span x-show="qualityRules.rubrics && qualityRules.rubrics[div]"
                              class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-green/10 text-hq-green font-medium shrink-0">설정됨</span>
                        <span x-show="!qualityRules.rubrics || !qualityRules.rubrics[div]"
                              class="text-[10px] px-1.5 py-0.5 rounded-full bg-hq-muted/10 text-hq-muted shrink-0">공통 적용</span>
                      </div>
                      <template x-if="qualityRules.rubrics && qualityRules.rubrics[div] && editingRubric !== div">
                        <div class="text-xs text-hq-muted/60 mt-0.5 flex flex-wrap gap-1">
                          <template x-for="s in (qualityRules.rubrics[div].scoring || []).slice(0, 3)" :key="s.id">
                            <span x-text="s.label + '(' + s.weight + '%)'"></span>
                          </template>
                        </div>
                      </template>
                      <template x-if="(!qualityRules.rubrics || !qualityRules.rubrics[div]) && editingRubric !== div">
                        <p class="text-xs text-hq-muted/40 mt-0.5">공통 기준 적용 중</p>
                      </template>
                    </div>
                    <span class="text-[10px] text-hq-muted/50 group-hover:text-hq-muted transition-transform duration-200 shrink-0" :class="editingRubric === div ? 'rotate-90' : ''">&#9654;</span>
                  </div>
                </div>
                <!-- Inline Viewer (읽기 전용 — YAML에서 직접 편집) -->
                <div x-show="editingRubric === div" x-collapse class="mt-1 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
                  <p class="text-xs text-hq-muted/70 mb-3">config/quality_rules.yaml에서 편집합니다.</p>
                  <!-- 부서 체크리스트 -->
                  <template x-if="qualityRules.rubrics?.[div]?.department_checklist">
                    <div class="mb-3">
                      <div class="text-[10px] text-hq-muted font-semibold mb-1">체크리스트</div>
                      <template x-for="item in [...(qualityRules.rubrics[div].department_checklist.required || []), ...(qualityRules.rubrics[div].department_checklist.optional || [])]" :key="item.id">
                        <div class="flex items-center gap-2 text-xs py-0.5">
                          <span class="font-mono text-hq-accent w-6" x-text="item.id"></span>
                          <span class="text-hq-text" x-text="item.label"></span>
                        </div>
                      </template>
                    </div>
                  </template>
                  <!-- 점수 항목 (1/3/5 상세 기준 포함) -->
                  <template x-if="qualityRules.rubrics?.[div]?.scoring">
                    <div class="mb-3">
                      <div class="text-[10px] text-hq-muted font-semibold mb-2">점수 항목 (1/3/5)</div>
                      <div class="space-y-2.5">
                        <template x-for="s in qualityRules.rubrics[div].scoring" :key="s.id">
                          <div class="bg-hq-surface/30 rounded-lg p-2.5">
                            <div class="flex items-center gap-2 text-xs mb-1.5">
                              <span class="font-mono text-hq-accent w-6" x-text="s.id"></span>
                              <span class="text-hq-text font-medium flex-1" x-text="s.label"></span>
                              <template x-if="s.critical"><span class="text-[9px] px-1 py-0.5 rounded bg-hq-red/20 text-hq-red">★치명적</span></template>
                              <span class="text-hq-muted text-[10px]" x-text="s.weight + '%'"></span>
                            </div>
                            <template x-if="s.criteria">
                              <div class="space-y-1 ml-8">
                                <div class="flex gap-2 text-[10px]"><span class="text-hq-red shrink-0 w-5">1점</span><span class="text-hq-muted/70" x-text="s.criteria[1] || s.criteria['1'] || '-'"></span></div>
                                <div class="flex gap-2 text-[10px]"><span class="text-hq-yellow shrink-0 w-5">3점</span><span class="text-hq-muted/70" x-text="s.criteria[3] || s.criteria['3'] || '-'"></span></div>
                                <div class="flex gap-2 text-[10px]"><span class="text-hq-green shrink-0 w-5">5점</span><span class="text-hq-muted/70" x-text="s.criteria[5] || s.criteria['5'] || '-'"></span></div>
                              </div>
                            </template>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                  <div class="flex items-center gap-2">
                    <button @click.stop="editingRubric = null" class="bg-hq-surface hover:bg-hq-panel text-hq-text rounded-lg px-4 py-1.5 text-xs transition">닫기</button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

      </div>

      <!-- Sticky Footer -->
      <div class="p-3 border-t border-hq-border/30 text-center shrink-0">
        <span x-show="qualitySaveStatus === 'saving'" class="text-xs text-hq-yellow animate-pulse">저장 중...</span>
        <span x-show="qualitySaveStatus === 'saved'" class="text-xs text-hq-green">저장 완료</span>
        <span x-show="qualitySaveStatus === 'error'" class="text-xs text-hq-red">저장 실패</span>
        <span x-show="!qualitySaveStatus" class="text-xs text-hq-muted/40">변경사항은 서버에 자동 동기화됩니다</span>
      </div>
    </div>
  </div>

  <!-- ═══ Agent Config Modal (에이전트 설정) ═══ -->
  <div x-show="showAgentConfig" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showAgentConfig = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[600px] mx-4 max-h-[85vh] overflow-y-auto p-6"
         @click.stop>

      <!-- Loading -->
      <div x-show="agentConfigLoading" class="flex items-center justify-center py-12">
        <svg class="animate-spin w-6 h-6 text-hq-accent" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
        </svg>
      </div>

      <!-- Content -->
      <div x-show="!agentConfigLoading && agentConfigData">
        <!-- Header -->
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold"
                 :class="getAgentAvatarClass(agentConfigId)"
                 x-text="getAgentInitials(agentConfigId)"></div>
            <div>
              <h2 class="text-lg font-bold text-hq-text" x-text="agentConfigData?.name_ko || agentConfigData?.name || agentConfigId"></h2>
              <div class="text-xs text-hq-muted" x-text="(agentConfigData?.role || '') + ' · ' + (agentConfigData?.division || '')"></div>
            </div>
          </div>
          <button @click="showAgentConfig = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
        </div>

        <!-- Tabs (모바일: 가로 스크롤) -->
        <div class="flex gap-1 mb-5 bg-hq-bg rounded-xl p-1 overflow-x-auto scrollbar-thin">
          <button @click="agentConfigTab = 'info'"
                  :class="agentConfigTab === 'info' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-2 sm:px-3 py-2 text-[11px] sm:text-xs font-semibold rounded-lg transition-colors whitespace-nowrap shrink-0">기본 정보</button>
          <button @click="agentConfigTab = 'model'"
                  :class="agentConfigTab === 'model' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-2 sm:px-3 py-2 text-[11px] sm:text-xs font-semibold rounded-lg transition-colors whitespace-nowrap shrink-0">모델</button>
          <button @click="agentConfigTab = 'reasoning'"
                  :class="agentConfigTab === 'reasoning' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-2 sm:px-3 py-2 text-[11px] sm:text-xs font-semibold rounded-lg transition-colors whitespace-nowrap shrink-0">추론</button>
          <button @click="agentConfigTab = 'soul'"
                  :class="agentConfigTab === 'soul' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-2 sm:px-3 py-2 text-[11px] sm:text-xs font-semibold rounded-lg transition-colors whitespace-nowrap shrink-0">소울</button>
          <button @click="agentConfigTab = 'skills'"
                  :class="agentConfigTab === 'skills' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted hover:text-hq-text'"
                  class="flex-1 px-2 sm:px-3 py-2 text-[11px] sm:text-xs font-semibold rounded-lg transition-colors whitespace-nowrap shrink-0">스킬</button>
        </div>

        <!-- Tab: Info -->
        <div x-show="agentConfigTab === 'info'">
          <div class="bg-hq-bg rounded-xl p-4 space-y-3">
            <div class="flex justify-between"><span class="text-sm text-hq-muted">에이전트 ID</span><span class="text-xs font-mono text-hq-text" x-text="agentConfigId"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">이름 (한국어)</span><span class="text-sm text-hq-text" x-text="agentConfigData?.name_ko || '-'"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">역할</span><span class="text-sm text-hq-text" x-text="agentConfigData?.role || '-'"></span></div>
            <div class="flex justify-between"><span class="text-sm text-hq-muted">부서</span><span class="text-sm text-hq-text" x-text="agentConfigData?.division || '-'"></span></div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-hq-muted">현재 모델</span>
              <span class="text-xs font-mono text-hq-cyan font-semibold"
                    x-text="getModelDisplayName(agentConfigData?.model_name) + (agentConfigData?.reasoning_effort ? ' (' + agentConfigData.reasoning_effort + ')' : '')"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-hq-muted">추론 정도</span>
              <span class="text-sm font-semibold"
                    :class="({'none':'text-hq-muted','minimal':'text-hq-cyan','low':'text-hq-green','medium':'text-hq-yellow','high':'text-hq-purple','xhigh':'text-hq-red'})[agentConfigData?.reasoning_effort] || 'text-hq-text'"
                    x-text="agentConfigData?.reasoning_effort ? (({'none':'⛔ none','minimal':'💨 minimal','low':'⚡ low','medium':'🧠 medium','high':'🔬 high','xhigh':'🔥 xhigh'})[agentConfigData.reasoning_effort] || agentConfigData.reasoning_effort) : 'default'"></span>
            </div>
            <div x-show="agentConfigData?.capabilities?.length > 0">
              <span class="text-sm text-hq-muted block mb-1">능력치</span>
              <div class="flex flex-wrap gap-1">
                <template x-for="cap in (agentConfigData?.capabilities || [])" :key="cap">
                  <span class="text-[10px] bg-hq-accent/10 text-hq-accent border border-hq-accent/20 rounded-md px-2 py-0.5" x-text="cap"></span>
                </template>
              </div>
            </div>
            <!-- 상관 -->
            <div x-show="agentConfigData?.superior_id">
              <span class="text-sm text-hq-muted block mb-1">상관</span>
              <div @click="openAgentConfig(agentConfigData?.superior_id)" class="inline-flex items-center gap-2 bg-hq-purple/10 border border-hq-purple/20 rounded-lg px-3 py-1.5 cursor-pointer hover:bg-hq-purple/20 transition">
                <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold" :class="getAgentAvatarClass(agentConfigData?.superior_id)" x-text="getAgentInitials(agentConfigData?.superior_id)"></div>
                <span class="text-xs text-hq-text" x-text="getAgentName(agentConfigData?.superior_id)"></span>
              </div>
            </div>
            <!-- 부하직원 -->
            <div x-show="agentConfigData?.subordinate_ids?.length > 0">
              <span class="text-sm text-hq-muted block mb-1">부하직원</span>
              <div class="flex flex-wrap gap-1.5">
                <template x-for="subId in (agentConfigData?.subordinate_ids || [])" :key="subId">
                  <div @click="openAgentConfig(subId)" class="inline-flex items-center gap-2 bg-hq-cyan/10 border border-hq-cyan/20 rounded-lg px-3 py-1.5 cursor-pointer hover:bg-hq-cyan/20 transition">
                    <div class="w-5 h-5 rounded-md flex items-center justify-center text-[8px] font-bold" :class="getAgentAvatarClass(subId)" x-text="getAgentInitials(subId)"></div>
                    <span class="text-xs text-hq-text" x-text="getAgentName(subId)"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Model -->
        <div x-show="agentConfigTab === 'model'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">AI 모델 선택</label>
            <p class="text-[11px] text-hq-muted/70 mb-3">이 에이전트가 사용할 AI 모델을 변경합니다. 변경 즉시 적용됩니다.</p>
            <select x-model="agentModelSelection"
                    class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2.5 text-sm text-hq-text mb-3">
              <template x-for="[provLabel, models] in Object.entries(getModelsByProvider())" :key="provLabel">
                <optgroup :label="provLabel">
                  <template x-for="m in models" :key="m.name">
                    <option :value="m.name" x-text="getModelDisplayName(m.name) + ' ($' + (m.cost_input ?? 0) + '/' + (m.cost_output ?? 0) + ')'"></option>
                  </template>
                </optgroup>
              </template>
            </select>
            <div class="flex items-center gap-2">
              <button @click="saveAgentModel()"
                      class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm transition-colors">모델 변경</button>
              <span class="text-xs text-hq-muted" x-show="agentModelSelection !== agentConfigData?.model_name">
                현재: <span class="font-mono text-hq-cyan" x-text="agentConfigData?.model_name"></span>
              </span>
            </div>
          </div>
        </div>

        <!-- Tab: Reasoning -->
        <div x-show="agentConfigTab === 'reasoning'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">추론 정도 (Reasoning Effort)</label>
            <p class="text-[11px] text-hq-muted/70 mb-4">에이전트가 답변할 때 얼마나 깊이 생각할지 결정합니다. 높을수록 정확하지만 느리고 비용이 더 듭니다.</p>

            <!-- 추론 미지원 모델 -->
            <template x-if="agentReasoningOptions.length === 0">
              <div class="text-center py-6">
                <div class="text-3xl mb-2">🚫</div>
                <p class="text-sm text-hq-muted">이 모델은 추론 정도 설정을 지원하지 않습니다.</p>
                <p class="text-[11px] text-hq-muted/85 mt-1">추론을 지원하는 모델로 변경하면 설정할 수 있습니다.</p>
              </div>
            </template>

            <!-- 추론 지원 모델: 동적 버튼 -->
            <template x-if="agentReasoningOptions.length > 0">
              <div>
                <div class="grid gap-3 mb-3" :class="agentReasoningOptions.length <= 3 ? 'grid-cols-3' : (agentReasoningOptions.length <= 4 ? 'grid-cols-2 sm:grid-cols-4' : 'grid-cols-2 sm:grid-cols-3')">
                  <template x-for="level in agentReasoningOptions" :key="level">
                    <button @click="agentReasoningSelection = level"
                            :class="agentReasoningSelection === level
                              ? (level === 'none' ? 'border-hq-muted bg-hq-muted/10 text-hq-muted'
                                : level === 'minimal' ? 'border-hq-cyan bg-hq-cyan/10 text-hq-cyan'
                                : level === 'low' ? 'border-hq-green bg-hq-green/10 text-hq-green'
                                : level === 'medium' ? 'border-hq-yellow bg-hq-yellow/10 text-hq-yellow'
                                : level === 'high' ? 'border-hq-purple bg-hq-purple/10 text-hq-purple'
                                : 'border-hq-red bg-hq-red/10 text-hq-red')
                              : 'border-hq-border text-hq-muted hover:text-hq-text'"
                            class="border-2 rounded-xl p-4 text-center transition-all">
                      <div class="text-2xl mb-1" x-text="({none:'⛔',minimal:'💨',low:'⚡',medium:'🧠',high:'🔬',xhigh:'🔥'})[level] || '❓'"></div>
                      <div class="text-sm font-bold font-mono" x-text="level"></div>
                      <div class="text-[10px] mt-1" x-text="({none:'추론 비활성화',minimal:'아주 빠름',low:'빠르고 저렴',medium:'균형잡힌 성능',high:'정확하지만 느림',xhigh:'최대 깊이'})[level] || ''"></div>
                    </button>
                  </template>
                </div>
                <div class="flex items-center gap-2">
                  <button @click="saveAgentReasoning()"
                          class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm transition-colors">추론 정도 변경</button>
                  <button @click="agentReasoningSelection = ''; saveAgentReasoning()"
                          class="border border-hq-border hover:border-hq-muted text-hq-muted hover:text-hq-text rounded-lg px-4 py-2 text-sm transition-colors">초기화 (기본값)</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Tab: Soul (읽기 전용) -->
        <div x-show="agentConfigTab === 'soul'">
          <div class="bg-hq-bg rounded-xl p-4">
            <div class="flex items-center justify-between mb-1">
              <div class="flex items-center gap-2">
                <span class="text-base">🧠</span>
                <label class="text-xs font-semibold text-hq-text">시스템 프롬프트</label>
              </div>
              <span class="text-[9px] px-2.5 py-1 rounded-full font-medium"
                    style="background: linear-gradient(135deg, rgba(var(--hq-cyan),0.15), rgba(var(--hq-accent),0.10)); color: rgb(var(--hq-cyan)); border: 1px solid rgba(var(--hq-cyan),0.2);">
                🔒 코드 관리 전용
              </span>
            </div>
            <p class="text-[11px] text-hq-muted/60 mb-3">에이전트의 성격과 행동 방식을 결정합니다. 설정 파일(<code class="text-hq-cyan/70">agents.yaml</code>)에서만 수정 가능합니다.</p>
            <div class="relative">
              <div class="w-full rounded-xl border border-hq-border/30 px-5 py-4 text-[13px] text-hq-text/85 overflow-y-auto whitespace-pre-wrap"
                   style="font-family: 'Pretendard Variable', 'Pretendard', sans-serif; line-height: 1.9; background: linear-gradient(135deg, rgba(var(--hq-panel),0.3), rgba(var(--hq-panel),0.5)); letter-spacing:0.01em; max-height: 420px; scrollbar-width: thin; scrollbar-color: rgba(var(--hq-cyan),0.2) transparent;"
                   x-text="agentSoulText || '(프롬프트 없음)'"></div>
            </div>
            <div class="flex items-center justify-between mt-3">
              <span class="text-[10px] text-hq-muted/60" x-text="agentSoulText.length + '자'"></span>
              <span class="text-[10px] text-hq-muted/40 italic">config/agents.yaml 에서 수정하세요</span>
            </div>
          </div>
        </div>

        <!-- Tab: Skills -->
        <div x-show="agentConfigTab === 'skills'">
          <div class="bg-hq-bg rounded-xl p-4">
            <label class="text-xs text-hq-muted block mb-2">사용 가능한 도구 (스킬)</label>
            <p class="text-[11px] text-hq-muted/70 mb-4">이 에이전트가 작업할 때 쓸 수 있는 도구 목록입니다.</p>
            <template x-if="(agentConfigData?.allowed_tools || []).length === 0">
              <div class="text-center py-8">
                <div class="text-3xl mb-2">🚫</div>
                <p class="text-sm text-hq-muted">이 에이전트는 도구를 사용하지 않습니다.</p>
                <p class="text-[11px] text-hq-muted/85 mt-1">순수 분석·요약 전문 에이전트입니다.</p>
              </div>
            </template>
            <template x-if="(agentConfigData?.allowed_tools || []).length > 0">
              <div class="grid grid-cols-2 gap-2">
                <template x-for="tool in (agentConfigData?.allowed_tools || [])" :key="tool">
                  <div class="bg-hq-panel border border-hq-border/50 rounded-lg p-3 flex items-center gap-2.5">
                    <div class="w-7 h-7 rounded-md bg-hq-accent/10 flex items-center justify-center text-sm shrink-0">🔧</div>
                    <div class="min-w-0">
                      <div class="text-xs font-semibold text-hq-text truncate" x-text="getToolDisplayName(tool)"></div>
                      <div class="text-[10px] text-hq-muted truncate" x-text="getToolDescription(tool)"></div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>

        <!-- Save status -->
        <div class="mt-4 text-center h-5">
          <span x-show="agentConfigSaveStatus === 'saving'" class="text-xs text-hq-yellow">저장 중...</span>
          <span x-show="agentConfigSaveStatus === 'saved'" class="text-xs text-hq-green">저장 완료</span>
          <span x-show="agentConfigSaveStatus === 'error'" class="text-xs text-hq-red">저장 실패</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Task Detail Modal (작업 상세) ═══ -->
  <div x-show="showTaskDetail" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showTaskDetail = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[800px] mx-4 max-h-[85vh] overflow-y-auto p-6" @click.stop>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-hq-text">작업 상세</h2>
        <button @click="showTaskDetail = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <template x-if="taskDetailData">
        <div>
          <!-- Task Info -->
          <div class="bg-hq-bg rounded-xl p-4 mb-4">
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div><span class="text-hq-muted">명령:</span> <span class="text-hq-text ml-1" x-text="taskDetailData.command"></span></div>
              <div><span class="text-hq-muted">상태:</span>
                <span class="ml-1 status-badge"
                      :class="taskDetailData.status === 'completed' ? 'bg-hq-green/10 text-hq-green' : taskDetailData.status === 'failed' ? 'bg-hq-red/10 text-hq-red' : 'bg-hq-yellow/10 text-hq-yellow'"
                      x-text="taskDetailData.status === 'completed' ? '완료' : taskDetailData.status === 'failed' ? '실패' : '진행중'"></span>
              </div>
              <div><span class="text-hq-muted">소요시간:</span> <span class="text-hq-text font-mono ml-1" x-text="(taskDetailData.time_seconds || 0) + 's'"></span></div>
              <div><span class="text-hq-muted">비용:</span> <span class="text-hq-green font-mono ml-1" x-text="'$' + (taskDetailData.cost || 0).toFixed(4)"></span></div>
              <div x-show="taskDetailData.tokens_used"><span class="text-hq-muted">토큰(사용량):</span> <span class="text-hq-purple font-mono ml-1" x-text="(taskDetailData.tokens_used || 0).toLocaleString()"></span></div>
              <div><span class="text-hq-muted">생성일:</span> <span class="text-hq-text ml-1" x-text="taskDetailData.created_at ? new Date(taskDetailData.created_at).toLocaleString('ko-KR') : '-'"></span></div>
            </div>
          </div>
          <!-- Tabs -->
          <div class="flex gap-2 mb-4">
            <button @click="taskDetailTab = 'result'" :class="taskDetailTab === 'result' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1 text-xs font-semibold rounded-lg transition">결과</button>
            <button @click="taskDetailTab = 'replay'; loadTaskReplay(taskDetailData.task_id)" :class="taskDetailTab === 'replay' ? 'bg-hq-accent/20 text-hq-accent' : 'text-hq-muted'" class="px-3 py-1 text-xs font-semibold rounded-lg transition">리플레이 (실행 과정)</button>
          </div>
          <!-- Result Tab -->
          <div x-show="taskDetailTab === 'result'" class="bg-hq-bg rounded-xl p-4">
            <template x-if="taskDetailData.result_data">
              <div class="text-sm leading-relaxed markdown-body" x-html="renderMarkdown(taskDetailData.result_data)"></div>
            </template>
            <template x-if="!taskDetailData.result_data">
              <div class="text-sm text-hq-muted text-center py-4">결과 데이터가 없습니다</div>
            </template>
          </div>
          <!-- Replay Tab -->
          <div x-show="taskDetailTab === 'replay'" class="bg-hq-bg rounded-xl p-4">
            <template x-if="taskReplay && taskReplay.root">
              <div class="space-y-2" x-html="renderTaskDetailReplay(taskReplay.root, 0)"></div>
            </template>
            <template x-if="!taskReplay">
              <div class="text-sm text-hq-muted text-center py-4">리플레이 데이터를 불러오는 중...</div>
            </template>
            <template x-if="taskReplay && !taskReplay.root">
              <div class="text-sm text-hq-muted text-center py-4">리플레이 데이터가 없습니다</div>
            </template>
          </div>
        </div>
      </template>
      <template x-if="!taskDetailData">
        <div class="text-center py-8 text-hq-muted">로딩 중...</div>
      </template>
    </div>
  </div>

  <!-- ═══ Task Comparison Modal (#9) ═══ -->
  <div x-show="taskHistory.compareMode" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" style="display:none;" @click.self="taskHistory.compareMode = false">
    <div class="glass border border-hq-border rounded-2xl w-full max-w-6xl max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between px-6 py-4 border-b border-hq-border">
        <h3 class="text-lg font-bold text-hq-text">작업 비교</h3>
        <button @click="taskHistory.compareMode = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="flex-1 overflow-auto p-6">
        <div class="grid grid-cols-2 gap-6">
          <!-- Left -->
          <div class="space-y-3">
            <div class="bg-hq-surface border border-hq-border rounded-xl p-4">
              <div class="text-xs text-hq-muted mb-1">명령</div>
              <div class="text-sm text-hq-text font-medium" x-text="taskHistory.compareA?.command || '-'"></div>
              <div class="flex items-center gap-3 mt-2 text-[10px] text-hq-muted">
                <span x-text="taskHistory.compareA?.created_at ? new Date(taskHistory.compareA.created_at).toLocaleString('ko-KR') : ''"></span>
                <span :class="taskHistory.compareA?.success ? 'text-hq-green' : 'text-hq-red'" x-text="taskHistory.compareA?.success ? '성공' : '실패'"></span>
              </div>
            </div>
            <div class="bg-hq-bg rounded-xl p-4 text-sm markdown-body max-h-96 overflow-auto" x-html="renderMarkdown(taskHistory.compareA?.result_data || taskHistory.compareA?.result_summary || '결과 없음')"></div>
          </div>
          <!-- Right -->
          <div class="space-y-3">
            <div class="bg-hq-surface border border-hq-border rounded-xl p-4">
              <div class="text-xs text-hq-muted mb-1">명령</div>
              <div class="text-sm text-hq-text font-medium" x-text="taskHistory.compareB?.command || '-'"></div>
              <div class="flex items-center gap-3 mt-2 text-[10px] text-hq-muted">
                <span x-text="taskHistory.compareB?.created_at ? new Date(taskHistory.compareB.created_at).toLocaleString('ko-KR') : ''"></span>
                <span :class="taskHistory.compareB?.success ? 'text-hq-green' : 'text-hq-red'" x-text="taskHistory.compareB?.success ? '성공' : '실패'"></span>
              </div>
            </div>
            <div class="bg-hq-bg rounded-xl p-4 text-sm markdown-body max-h-96 overflow-auto" x-html="renderMarkdown(taskHistory.compareB?.result_data || taskHistory.compareB?.result_summary || '결과 없음')"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Budget Edit Modal (#8) ═══ -->
  <div x-show="showBudgetEdit" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" style="display:none;" @click.self="showBudgetEdit = false">
    <div class="glass border border-hq-border rounded-2xl w-full max-w-md p-6">
      <h3 class="text-lg font-bold text-hq-text mb-4">예산 한도 수정</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-hq-muted mb-1">일일 한도 ($)</label>
          <input x-model.number="budgetEditDaily" type="number" step="0.1" min="0"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div>
          <label class="block text-xs text-hq-muted mb-1">월간 한도 ($)</label>
          <input x-model.number="budgetEditMonthly" type="number" step="1" min="0"
                 class="w-full bg-hq-bg border border-hq-border rounded-lg px-3 py-2 text-sm text-hq-text">
        </div>
        <div class="flex gap-3">
          <button @click="saveBudget()" class="flex-1 bg-hq-accent hover:bg-hq-accent/80 text-white rounded-lg py-2 text-sm font-semibold transition">저장</button>
          <button @click="showBudgetEdit = false" class="px-4 text-hq-muted hover:text-hq-text border border-hq-border rounded-lg py-2 text-sm transition">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ CEO Profile Modal ═══ -->
  <div x-show="showCeoProfile" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showCeoProfile = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[500px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-5">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-hq-accent to-hq-purple flex items-center justify-center text-white font-bold text-sm">CEO</div>
          <div>
            <h2 class="text-lg font-bold text-hq-text">CEO</h2>
            <div class="text-xs text-hq-muted">총괄 사령관 · CORTHEX HQ</div>
          </div>
        </div>
        <button @click="showCeoProfile = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="bg-hq-bg rounded-xl p-4 space-y-3 mb-4">
        <div class="flex justify-between"><span class="text-xs text-hq-muted">직책</span><span class="text-xs text-hq-text">총괄 사령관 (CEO)</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">직속 보고</span><span class="text-xs text-hq-cyan cursor-pointer hover:underline" @click="showCeoProfile = false; openAgentConfig('chief_of_staff')">비서실장 → CEO</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">관리 부서</span><span class="text-xs text-hq-text">전체 (7개 부서)</span></div>
        <div class="flex justify-between"><span class="text-xs text-hq-muted">총 에이전트</span><span class="text-xs text-hq-text" x-text="Object.keys(agentNames).length + '명'"></span></div>
      </div>
      <div class="bg-hq-bg rounded-xl p-4">
        <div class="text-xs text-hq-muted font-semibold mb-3">오늘 현황</div>
        <div class="grid grid-cols-3 gap-3">
          <div class="text-center">
            <div class="text-lg font-bold text-hq-accent" x-text="dashboard.todayTasks || 0"></div>
            <div class="text-[10px] text-hq-muted">명령</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-hq-green" x-text="dashboard.todayCompleted || 0"></div>
            <div class="text-[10px] text-hq-muted">완료</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-hq-yellow">$<span x-text="(totalCost || 0).toFixed(2)"></span></div>
            <div class="text-[10px] text-hq-muted">비용</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Tool Detail Modal ═══ -->
  <div x-show="toolDetailVisible" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="toolDetailVisible = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-[400px] mx-4 p-6" @click.stop>
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-hq-red/15 flex items-center justify-center text-hq-red text-lg">🔧</div>
          <div>
            <h2 class="text-base font-bold text-hq-text" x-text="toolDetailData?.name_ko || toolDetailData?.name || ''"></h2>
            <div class="text-[10px] text-hq-muted">외부 도구</div>
          </div>
        </div>
        <button @click="toolDetailVisible = false" class="text-hq-muted hover:text-hq-text text-xl">&times;</button>
      </div>
      <div class="bg-hq-bg rounded-xl p-4 space-y-3">
        <div class="flex justify-between"><span class="text-xs text-hq-muted">도구 ID</span><span class="text-xs font-mono text-hq-text" x-text="toolDetailData?.name || '-'"></span></div>
        <div x-show="toolDetailData?.description"><span class="text-xs text-hq-muted block mb-1">설명</span><span class="text-xs text-hq-text" x-text="toolDetailData?.description || ''"></span></div>
        <div x-show="toolDetailData?.category"><div class="flex justify-between"><span class="text-xs text-hq-muted">분류</span><span class="text-xs text-hq-text" x-text="toolDetailData?.category || '-'"></span></div></div>
      </div>
    </div>
  </div>

  <!-- ═══ 기밀문서 전체 삭제 확인 모달 ═══ -->
  <div x-show="showDeleteAllArchiveModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showDeleteAllArchiveModal = false" style="display: none;">
    <div class="bg-hq-panel border border-red-500/30 rounded-2xl w-full max-w-[380px] mx-4 p-6" @click.stop>
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-red-500/15 flex items-center justify-center text-red-400 text-lg">⚠️</div>
        <h2 class="text-base font-bold text-red-400">전체 삭제 확인</h2>
      </div>
      <p class="text-hq-300 text-sm mb-5 leading-relaxed">정말 모든 기밀문서를 삭제하시겠습니까?<br>이 작업은 되돌릴 수 없습니다.</p>
      <div class="flex justify-end gap-2">
        <button @click="showDeleteAllArchiveModal = false"
                class="px-4 py-2 rounded-lg text-sm bg-hq-surface text-hq-muted hover:bg-hq-border transition">취소</button>
        <button @click="deleteAllArchives()"
                class="px-4 py-2 rounded-lg text-sm bg-red-600 text-white hover:bg-red-700 transition">삭제</button>
      </div>
    </div>
  </div>

  <!-- ═══ 미디어 전체 삭제 확인 모달 ═══ -->
  <div x-show="sns.showDeleteAllMediaModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="sns.showDeleteAllMediaModal = false" style="display: none;">
    <div class="bg-hq-panel border border-red-500/30 rounded-2xl w-full max-w-[380px] mx-4 p-6" @click.stop>
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-red-500/15 flex items-center justify-center text-red-400 text-lg">⚠️</div>
        <h2 class="text-base font-bold text-red-400">미디어 전체 삭제</h2>
      </div>
      <p class="text-hq-300 text-sm mb-5 leading-relaxed">모든 이미지와 영상을 삭제합니다.<br>이 작업은 되돌릴 수 없습니다.</p>
      <div class="flex justify-end gap-2">
        <button @click="sns.showDeleteAllMediaModal = false"
                class="px-4 py-2 rounded-lg text-sm bg-hq-surface text-hq-muted hover:bg-hq-border transition">취소</button>
        <button @click="deleteAllMedia('images')"
                class="px-4 py-2 rounded-lg text-sm bg-orange-600 text-white hover:bg-orange-700 transition">이미지만</button>
        <button @click="deleteAllMediaBoth()"
                class="px-4 py-2 rounded-lg text-sm bg-red-600 text-white hover:bg-red-700 transition">전체 삭제</button>
      </div>
    </div>
  </div>

  <!-- ═══ SNS 큐 전체 초기화 확인 모달 ═══ -->
  <div x-show="sns.showClearQueueModal" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="sns.showClearQueueModal = false" style="display: none;">
    <div class="bg-hq-panel border border-red-500/30 rounded-2xl w-full max-w-[380px] mx-4 p-6" @click.stop>
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-red-500/15 flex items-center justify-center text-red-400 text-lg">⚠️</div>
        <h2 class="text-base font-bold text-red-400">승인큐 전체 초기화</h2>
      </div>
      <p class="text-hq-300 text-sm mb-5 leading-relaxed">모든 SNS 발행 요청을 삭제합니다.<br>대기/승인/거절/발행 모든 항목이 사라집니다.</p>
      <div class="flex justify-end gap-2">
        <button @click="sns.showClearQueueModal = false"
                class="px-4 py-2 rounded-lg text-sm bg-hq-surface text-hq-muted hover:bg-hq-border transition">취소</button>
        <button @click="clearSNSQueue()"
                class="px-4 py-2 rounded-lg text-sm bg-red-600 text-white hover:bg-red-700 transition">전체 초기화</button>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════════ 범용 확인 모달 ══ -->
  <!-- x-if 사용: show=false 시 DOM에서 완전 제거 → x-transition 글리치 방지 -->
  <template x-if="confirmModal.show">
  <div class="fixed inset-0 z-[100] flex items-center justify-center p-4"
       :style="darkMode ? 'background: rgba(2,0,12,0.8); backdrop-filter: blur(8px);' : 'background: rgba(100,80,120,0.25); backdrop-filter: blur(6px);'"
       @click.self="closeConfirm()">
    <div class="w-full max-w-sm rounded-3xl overflow-hidden relative"
         :style="darkMode
           ? 'background: rgba(18,10,36,0.92); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(139,92,246,0.12), 0 8px 32px rgba(0,0,0,0.4);'
           : 'background: rgba(255,255,255,0.96); border: 1px solid rgba(160,120,200,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.08);'"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95 translate-y-2"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0">
      <!-- 상단 라인 -->
      <div :style="confirmModal.isDanger
        ? (darkMode ? 'position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(239,68,68,0.6),rgba(236,72,153,0.4),transparent);' : 'position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(236,72,153,0.4),transparent);')
        : (darkMode ? 'position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(139,92,246,0.6),rgba(99,102,241,0.4),transparent);' : 'position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(99,102,241,0.4),transparent);')
      "></div>
      <div class="relative px-8 pt-8 pb-7">
        <!-- 아이콘 -->
        <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5"
             :style="confirmModal.isDanger
               ? (darkMode ? 'background:radial-gradient(circle,rgba(239,68,68,0.15) 0%,transparent 70%);border:1.5px solid rgba(239,68,68,0.25);box-shadow:0 0 25px rgba(239,68,68,0.2);' : 'background:radial-gradient(circle,rgba(236,72,153,0.08) 0%,transparent 70%);border:1.5px solid rgba(236,72,153,0.15);')
               : (darkMode ? 'background:radial-gradient(circle,rgba(139,92,246,0.15) 0%,transparent 70%);border:1.5px solid rgba(139,92,246,0.25);box-shadow:0 0 25px rgba(139,92,246,0.2);' : 'background:radial-gradient(circle,rgba(99,102,241,0.08) 0%,transparent 70%);border:1.5px solid rgba(99,102,241,0.15);')">
          <template x-if="confirmModal.isDanger">
            <svg class="w-7 h-7" :style="darkMode ? 'color:rgb(252,129,129);' : 'color:rgb(219,39,119);'" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
          </template>
          <template x-if="!confirmModal.isDanger">
            <svg class="w-7 h-7" :style="darkMode ? 'color:rgb(167,139,250);' : 'color:rgb(99,102,241);'" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"/></svg>
          </template>
        </div>
        <!-- 제목 -->
        <h3 class="text-lg font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'" x-text="confirmModal.title"></h3>
        <!-- 메시지 -->
        <p class="text-sm mb-1" :style="darkMode ? 'color:rgba(200,195,220,0.8);' : 'color:rgba(75,70,100,0.8);'" x-text="confirmModal.message"></p>
        <!-- 상세 (있을 때만) -->
        <template x-if="confirmModal.detail">
          <div class="mt-3 mb-1 inline-block rounded-lg px-3 py-1.5"
               :style="confirmModal.isDanger
                 ? (darkMode ? 'background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);' : 'background:rgba(236,72,153,0.06);border:1px solid rgba(236,72,153,0.12);')
                 : (darkMode ? 'background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.15);' : 'background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.12);')">
            <span class="text-sm font-medium"
                  :style="confirmModal.isDanger ? (darkMode ? 'color:rgb(252,165,165);' : 'color:rgb(190,24,93);') : (darkMode ? 'color:rgb(196,181,253);' : 'color:rgb(79,70,229);')"
                  x-text="confirmModal.detail"></span>
          </div>
        </template>
        <p class="text-[13px] mt-3 mb-5" :style="darkMode ? 'color:rgba(200,195,220,0.5);' : 'color:rgba(100,95,120,0.55);'" x-show="confirmModal.isDanger">이 작업은 되돌릴 수 없습니다.</p>
        <!-- 버튼 -->
        <div class="space-y-2.5">
          <button @click="executeConfirm()"
                  class="w-full py-3 text-sm text-white rounded-2xl font-semibold transition-all duration-200"
                  :style="confirmModal.isDanger
                    ? (darkMode ? 'background:linear-gradient(135deg,rgb(220,50,50),rgb(180,30,80));box-shadow:0 0 20px rgba(239,68,68,0.3),0 4px 12px rgba(0,0,0,0.3);' : 'background:linear-gradient(135deg,rgb(219,39,119),rgb(190,24,93));box-shadow:0 2px 12px rgba(219,39,119,0.25);')
                    : (darkMode ? 'background:linear-gradient(135deg,rgb(124,58,237),rgb(99,102,241));box-shadow:0 0 20px rgba(139,92,246,0.3),0 4px 12px rgba(0,0,0,0.3);' : 'background:linear-gradient(135deg,rgb(99,102,241),rgb(79,70,229));box-shadow:0 2px 12px rgba(99,102,241,0.25);')"
                  x-text="confirmModal.confirmText"></button>
          <button @click="closeConfirm()"
                  class="w-full py-3 text-sm rounded-2xl transition-all duration-200 font-medium"
                  :style="darkMode ? 'color:rgba(200,195,220,0.8);border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);' : 'color:rgba(85,80,108,0.7);border:1px solid rgba(0,0,0,0.08);background:rgba(0,0,0,0.02);'">취소</button>
        </div>
      </div>
    </div>
  </div>
  </template><!-- /confirmModal x-if -->

  <!-- ══════════════════════════════════════════════════ NEXUS 풀스크린 오버레이 ══ -->
  <template x-if="nexusOpen">
    <div class="fixed inset-0 z-50 flex flex-col bg-[#060a14]"
         @keydown.ctrl.s.prevent.window="nexusOpen && flowchart.mode==='canvas' && saveNexusCanvas()">

      <!-- 상단 헤더 -->
      <div class="shrink-0 flex items-center gap-3 px-5 py-3 border-b border-white/10 bg-[#0a0f1a]/90 backdrop-blur-md">
        <!-- NEXUS 로고 -->
        <span class="text-base font-black tracking-[0.3em] text-[#e879f9]">NEXUS</span>
        <!-- 캔버스 도구 -->
        <div class="flex items-center gap-2 ml-2">
          <input x-model="flowchart.canvasName" type="text" placeholder="파일명..."
                 class="bg-white/5 border border-white/10 rounded-lg px-2.5 py-1.5 text-xs text-white/80 font-mono outline-none focus:border-yellow-500/50 w-36"/>
          <button @click="saveNexusCanvas()"
                  class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 transition"
                  :class="flowchart.canvasDirty ? 'ring-1 ring-yellow-500/40' : ''">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
            <span x-text="flowchart.canvasDirty ? '저장 *' : '저장'"></span>
          </button>
          <button @click="clearNexusCanvas()" class="px-2.5 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 text-white/40 hover:text-red-400 hover:border-red-400/40 transition">초기화</button>
          <button @click="flowchart.sketchVibeOpen = !flowchart.sketchVibeOpen; flowchart.sketchVibeOpen ? _connectSketchVibeSSE() : _disconnectSketchVibeSSE()"
                  :class="flowchart.sketchVibeOpen ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' : 'bg-white/5 text-white/40 border-white/10 hover:text-emerald-400 hover:border-emerald-500/30'"
                  class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold border transition ml-2">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
            스케치바이브
          </button>
        </div>

        <!-- 우측 닫기 -->
        <div class="ml-auto flex items-center gap-3">
          <span class="text-xs text-white/20 font-mono hidden sm:block">ESC</span>
          <button @click="nexusOpen = false"
                  class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 text-white/40 hover:text-white hover:bg-white/10 flex items-center justify-center transition"
                  title="닫기 (ESC)">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
      </div>

      <!-- ══════ 캔버스 (유일한 모드) ══════ -->
      <div class="flex-1 flex overflow-hidden">
        <!-- 좌측: 팔레트 + 목록 -->
        <div class="w-44 shrink-0 border-r border-white/10 bg-[#0a0f1a] flex flex-col overflow-hidden">
          <div class="px-3 py-2 border-b border-white/10">
            <span class="text-xs font-semibold text-white/40 uppercase tracking-wider">노드 팔레트</span>
          </div>
          <div class="p-2 flex flex-col gap-1.5 border-b border-white/10">
            <template x-if="flowchart.canvasLoaded">
              <div class="flex flex-col gap-1.5">
                <template x-for="n in [{t:'agent',l:'에이전트',c:'#8b5cf6'},{t:'system',l:'시스템',c:'#3b82f6'},{t:'api',l:'외부 API',c:'#059669'},{t:'decide',l:'결정 분기',c:'#f59e0b'},{t:'start',l:'시작',c:'#22c55e'},{t:'end',l:'종료',c:'#ef4444'},{t:'note',l:'메모',c:'#6b7280'}]" :key="n.t">
                  <button @click="addCanvasNode(n.t)"
                          class="w-full text-left py-1.5 px-2 rounded-lg text-xs font-semibold transition hover:opacity-80 flex items-center gap-2"
                          :style="`background:${n.c}22; border:1px solid ${n.c}44; color:${n.c}`">
                    <span class="w-2 h-2 rounded-full shrink-0" :style="`background:${n.c}`"></span>
                    <span x-text="n.l"></span>
                  </button>
                </template>
              </div>
            </template>
            <template x-if="!flowchart.canvasLoaded">
              <div class="text-xs text-white/30 py-2 animate-pulse">로딩 중...</div>
            </template>
          </div>
          <div class="px-3 py-2 border-b border-white/10 flex items-center justify-between">
            <span class="text-xs font-semibold text-white/40 uppercase tracking-wider">저장된 캔버스</span>
            <button @click="retrySketchVibe()" class="text-[10px] text-white/30 hover:text-emerald-400 transition px-1.5 py-0.5 rounded hover:bg-emerald-500/10" title="새 캔버스">+ 새로</button>
          </div>
          <div class="flex-1 overflow-y-auto scrollbar-thin py-1">
            <template x-if="flowchart.canvasItems.length === 0 && flowchart.confirmedItems.length === 0">
              <div class="px-3 py-2 text-xs text-white/20 italic">아직 없습니다</div>
            </template>
            <!-- 확인된 다이어그램 (맞아 누른 것) -->
            <template x-for="item in flowchart.confirmedItems" :key="item.safe_name">
              <div class="group flex items-center hover:bg-emerald-500/5 transition rounded-r-lg">
                <button @click="loadConfirmedDiagram(item)"
                        class="flex-1 text-left py-1.5 px-3 text-xs text-white/50 hover:text-emerald-400 transition truncate flex items-center gap-1.5"
                        :title="item.interpretation || item.name">
                  <span class="text-emerald-500/60 text-[10px]">&#x2713;</span>
                  <span x-text="item.name"></span>
                </button>
                <button @click.stop="deleteConfirmedDiagram(item)"
                        class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center text-white/30 hover:text-red-400 hover:bg-red-500/10 rounded transition shrink-0 mr-1"
                        title="삭제">&times;</button>
              </div>
            </template>
            <!-- 캔버스 JSON 파일 -->
            <template x-for="item in flowchart.canvasItems" :key="item.name">
              <button @click="loadNexusCanvas(item)"
                      class="w-full text-left py-1.5 px-3 text-xs text-white/40 hover:text-white/80 hover:bg-white/5 transition rounded-r-lg font-mono truncate"
                      x-text="item.name.replace('.json','')">
              </button>
            </template>
          </div>
        </div>
        <!-- Drawflow 캔버스 -->
        <div class="flex-1 overflow-hidden relative">
          <template x-if="!flowchart.canvasLoaded">
            <div class="absolute inset-0 flex items-center justify-center z-10">
              <div class="flex flex-col items-center gap-3">
                <div class="w-8 h-8 border-2 border-yellow-500/30 border-t-yellow-400 rounded-full animate-spin"></div>
                <span class="text-xs text-white/40">비주얼 캔버스 로딩 중...</span>
              </div>
            </div>
          </template>
          <template x-if="flowchart.canvasLoaded">
            <div class="absolute top-4 left-1/2 -translate-x-1/2 z-10 pointer-events-none">
              <div class="bg-black/60 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white/30 backdrop-blur-sm">
                팔레트에서 노드 추가 / 포트 드래그로 연결 / 더블클릭으로 노드 이름 수정
              </div>
            </div>
          </template>
          <div id="nexus-canvas" class="w-full h-full"></div>
          <!-- Mermaid 결과 — 스케치를 교체하여 캔버스에 표시 -->
          <div x-show="flowchart.sketchResult && flowchart.sketchResult.mermaid"
               x-transition:enter="transition ease-out duration-300"
               x-transition:enter-start="opacity-0"
               x-transition:enter-end="opacity-100"
               x-transition:leave="transition ease-in duration-200"
               x-transition:leave-start="opacity-100"
               x-transition:leave-end="opacity-0"
               :class="darkMode ? 'bg-[#0a0f1a]' : 'bg-white'"
               class="absolute inset-0 overflow-auto z-20 flex flex-col" x-cloak>
            <!-- 상단 바 -->
            <div class="flex items-center justify-between px-4 py-2.5 shrink-0"
                 :class="darkMode ? 'border-b border-white/10' : 'border-b border-gray-200'"
              <div class="flex items-center gap-2">
                <span class="text-emerald-400 text-xs font-bold">변환 결과</span>
                <template x-if="flowchart.sketchResult && flowchart.sketchResult.description">
                  <span class="text-[10px] text-white/30 truncate max-w-[200px]" x-text="flowchart.sketchResult.description"></span>
                </template>
              </div>
              <div class="flex gap-2">
                <template x-if="!flowchart.sketchConfirmed">
                  <div class="flex gap-2">
                    <button @click="confirmSketchVibe()" class="px-4 py-1.5 rounded-lg text-xs font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 border border-emerald-500/30 transition">
                      맞아 ✓
                    </button>
                    <button @click="retrySketchVibe()" class="px-4 py-1.5 rounded-lg text-xs font-bold bg-white/5 text-white/50 hover:text-white/80 border border-white/10 hover:border-white/20 transition">
                      초기화 ↩
                    </button>
                  </div>
                </template>
                <template x-if="flowchart.sketchConfirmed">
                  <div class="flex items-center gap-2">
                    <span class="text-emerald-400/60 text-[10px]">✓ 확인됨</span>
                    <button @click="retrySketchVibe()" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-white/5 text-white/40 hover:text-white/70 border border-white/10 transition">
                      새 다이어그램
                    </button>
                  </div>
                </template>
              </div>
            </div>
            <!-- Claude Code 확인 요청 알림 (캔버스 위) -->
            <template x-if="flowchart.approvalRequest">
              <div class="mx-4 mt-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/30 flex items-center gap-3 animate-pulse shrink-0">
                <span class="text-amber-400 text-sm">!</span>
                <span class="text-xs text-white/60 flex-1" x-text="flowchart.approvalRequest"></span>
              </div>
            </template>
            <!-- Mermaid 렌더링 영역 -->
            <div class="flex-1 overflow-auto flex items-center justify-center p-6">
              <div id="sketchvibe-canvas-mermaid" class="flex justify-center"></div>
            </div>
          </div>
        </div>

        <!-- ══════ 스케치바이브 패널 ══════ -->
        <div x-show="flowchart.sketchVibeOpen"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="translate-x-full opacity-0"
             x-transition:enter-end="translate-x-0 opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="translate-x-0 opacity-100"
             x-transition:leave-end="translate-x-full opacity-0"
             class="w-96 shrink-0 border-l border-white/10 bg-[#0a0f1a] flex flex-col overflow-hidden" x-cloak>

          <!-- 헤더 -->
          <div class="shrink-0 px-4 py-2.5 border-b border-white/10 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-emerald-400 tracking-wider uppercase">SketchVibe</span>
              <span class="text-xs text-white/20">스케치 → 다이어그램</span>
            </div>
            <button @click="flowchart.sketchVibeOpen = false; _disconnectSketchVibeSSE()" class="w-6 h-6 rounded flex items-center justify-center text-white/30 hover:text-white/60 transition">
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>

          <!-- 입력: 설명 + 저장 -->
          <div class="p-3 border-b border-white/10 flex flex-col gap-2">
            <label class="text-xs text-white/50 font-semibold">이 스케치를 설명해주세요</label>
            <textarea x-model="flowchart.sketchDescription"
                      class="w-full h-16 bg-white/5 border border-white/10 rounded-lg p-2.5 text-xs text-white/80 placeholder:text-white/20 outline-none focus:border-emerald-500/50 resize-none"
                      placeholder="예: A 서버에서 B DB로 요청 보내고, C 캐시 거쳐 응답하는 구조"></textarea>
            <button @click="saveSketchVibe()"
                    :disabled="flowchart.sketchConverting"
                    class="w-full py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"
                    :class="flowchart.sketchConverting ? 'bg-emerald-500/10 text-emerald-500/50 cursor-wait' : 'bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 border border-emerald-500/30'">
              <template x-if="flowchart.sketchConverting">
                <div class="w-3.5 h-3.5 border-2 border-emerald-500/30 border-t-emerald-400 rounded-full animate-spin"></div>
              </template>
              <svg x-show="!flowchart.sketchConverting" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
              <span x-text="flowchart.sketchConverting ? '저장 중...' : '저장하기'"></span>
            </button>
          </div>

          <!-- 결과 영역 -->
          <div class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 scrollbar-thin">
            <!-- 에러 -->
            <template x-if="flowchart.sketchError">
              <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-xs text-red-400" x-text="flowchart.sketchError"></div>
            </template>

            <!-- Claude Code 확인 요청 알림 -->
            <template x-if="flowchart.approvalRequest">
              <div class="p-3 rounded-lg bg-amber-500/10 border border-amber-500/30 flex flex-col gap-2.5 animate-pulse">
                <div class="flex items-center gap-2">
                  <span class="text-amber-400 text-sm">!</span>
                  <span class="text-xs font-bold text-amber-400 uppercase tracking-wider">Claude Code 확인 요청</span>
                </div>
                <p class="text-xs text-white/60" x-text="flowchart.approvalRequest"></p>
                <div class="flex gap-2">
                  <button @click="confirmSketchVibe()" class="flex-1 py-2.5 rounded-lg text-xs font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 border border-emerald-500/30 transition">
                    맞아 ✓
                  </button>
                  <button @click="retrySketchVibe()" class="flex-1 py-2.5 rounded-lg text-xs font-bold bg-white/5 text-white/50 hover:text-white/80 border border-white/10 hover:border-white/20 transition">
                    다시 해줘 ↩
                  </button>
                </div>
              </div>
            </template>

            <!-- Mermaid 결과 → 캔버스에 표시됨 (사이드 패널은 상태만) -->
            <template x-if="flowchart.sketchResult && flowchart.sketchResult.mermaid && !flowchart.sketchConfirmed">
              <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <span class="text-emerald-400 text-sm">&#x25C0;</span>
                  <span class="text-xs font-bold text-emerald-400">캔버스에 표시됨</span>
                </div>
                <p class="text-xs text-white/40 leading-relaxed">변환 결과가 캔버스에 표시되었습니다. 상단 "맞아 ✓"로 확인하세요.</p>
              </div>
            </template>

            <!-- 저장 완료 메시지 (캔버스 저장 후, Mermaid 수신 전) -->
            <template x-if="flowchart.sketchResult && flowchart.sketchResult.saved && !flowchart.sketchResult.mermaid">
              <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <span class="text-emerald-400 text-sm">✓</span>
                  <span class="text-xs font-bold text-emerald-400">저장 완료</span>
                </div>
                <p class="text-xs text-white/50 leading-relaxed">
                  VS Code Claude Code에서 <span class="font-mono text-emerald-400/70">read_canvas</span> 도구를 호출하세요.
                </p>
                <p class="text-xs text-white/30 leading-relaxed">
                  Claude Code가 Mermaid로 변환하면 여기에 실시간으로 표시됩니다.
                </p>
              </div>
            </template>

            <!-- 확인 완료 → 구현 안내 패널 -->
            <template x-if="flowchart.sketchConfirmed">
              <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 flex flex-col gap-2.5">
                <div class="flex items-center gap-2">
                  <span class="text-emerald-400 text-sm">✓</span>
                  <span class="text-xs font-bold text-emerald-400 tracking-wider uppercase">확인 완료</span>
                  <span class="text-[10px] text-white/30 ml-auto" x-text="flowchart.sketchConfirmed.name"></span>
                </div>
                <p class="text-xs text-white/50 leading-relaxed">
                  저장된 캔버스에 추가되었습니다. Claude Code에서 구현 가능합니다.
                </p>
                <button @click="retrySketchVibe()"
                        class="w-full py-2 rounded-lg text-xs font-semibold bg-white/5 text-white/40 hover:text-white/70 border border-white/10 transition">
                  새 다이어그램
                </button>
              </div>
            </template>

            <!-- 빈 상태 -->
            <template x-if="!flowchart.sketchResult && !flowchart.sketchError && !flowchart.sketchConverting && !flowchart.sketchConfirmed && !flowchart.approvalRequest">
              <div class="flex-1 flex items-center justify-center min-h-[200px]">
                <div class="text-center space-y-1.5">
                  <div class="text-2xl opacity-20 mb-3">🎨</div>
                  <p class="text-xs text-white/30">1. 캔버스에 노드를 배치하고 선으로 연결</p>
                  <p class="text-xs text-white/30">2. "저장하기"로 캔버스 저장</p>
                  <p class="text-xs text-white/30">3. VS Code Claude Code에서 read_canvas 호출</p>
                  <p class="text-xs text-emerald-500/50 font-semibold mt-2">Claude Code가 변환한 결과가 여기에 표시됩니다</p>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

    </div>
  </template>

  <!-- ══════════════════════════════════════════════════ AGORA (독립 viewMode) ══ -->
  <template x-if="viewMode === 'agora'">
    <div class="flex-1 flex flex-col overflow-hidden">

      <!-- 상단 툴바 -->
      <div class="shrink-0 flex items-center gap-2 px-4 py-2.5 border-b border-hq-border bg-hq-panel/80 backdrop-blur-sm">
        <!-- AGORA 로고 -->
        <div class="flex items-center gap-2 mr-2">
          <span class="text-sm font-bold tracking-widest text-hq-accent">AGORA</span>
          <template x-if="agora.status">
            <span class="text-[10px] px-1.5 py-0.5 rounded-full font-semibold"
                  :class="{'bg-green-500/20 text-green-400': agora.status==='active', 'bg-yellow-500/20 text-yellow-400': agora.status==='paused', 'bg-hq-muted/20 text-hq-muted': agora.status==='completed'}"
                  x-text="({active:'진행중',paused:'일시정지',completed:'완료'})[agora.status]"></span>
          </template>
        </div>

        <!-- 컨트롤 버튼들 -->
        <template x-if="!agora.sessionId">
          <button @click="startAgora()"
                  class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-hq-accent/20 text-hq-accent hover:bg-hq-accent/30 transition">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            새 토론 시작
          </button>
        </template>
        <template x-if="agora.status === 'active'">
          <button @click="pauseAgora()"
                  class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 transition">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            일시정지
          </button>
        </template>
        <template x-if="agora.status === 'paused'">
          <button @click="resumeAgora()"
                  class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-green-500/20 text-green-400 hover:bg-green-500/30 transition">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            재개
          </button>
        </template>

        <div class="flex-1"></div>

        <!-- 라운드 + 비용 표시 -->
        <template x-if="agora.sessionId">
          <div class="flex items-center gap-3">
            <span class="text-xs text-hq-muted/60 font-mono">
              R<span class="text-hq-text" x-text="agora.totalRounds"></span>
            </span>
            <span class="text-xs font-mono px-2 py-0.5 rounded bg-hq-surface border border-hq-border">
              <span class="text-hq-muted/60">$</span><span class="text-hq-accent" x-text="(agora.totalCost || 0).toFixed(2)"></span>
            </span>
          </div>
        </template>
      </div>

      <!-- 3패널 본문 -->
      <div class="flex-1 flex overflow-hidden">

        <!-- ▌좌측: 쟁점 트리 ▌ -->
        <div class="hidden sm:block w-60 shrink-0 border-r border-hq-border overflow-y-auto bg-hq-bg/50">
          <div class="p-3">
            <h3 class="text-[10px] font-semibold text-hq-muted/50 uppercase tracking-widest mb-3">쟁점 트리</h3>
            <div class="space-y-0.5">
              <template x-for="issue in agora.issues" :key="issue.id">
                <button @click="selectAgoraIssue(issue.id)"
                        :class="agora.selectedIssueId === issue.id ? 'bg-hq-accent/10 border-hq-accent/30 text-hq-text' : 'border-transparent text-hq-text/70 hover:bg-hq-surface hover:text-hq-text'"
                        :style="`padding-left: ${(issue._depth || 0) * 14 + 8}px`"
                        class="w-full text-left py-1.5 pr-2 rounded-lg text-xs border transition-all flex items-center gap-1.5">
                  <span x-text="agoraIssueIcon(issue.status)" class="text-[11px] shrink-0"></span>
                  <span x-text="issue.title" class="truncate"></span>
                </button>
              </template>
            </div>
            <template x-if="agora.issues.length === 0">
              <div class="flex flex-col items-center justify-center py-12 text-hq-muted/40">
                <svg class="w-8 h-8 mb-2 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
                <p class="text-[10px]">토론을 시작하면</p>
                <p class="text-[10px]">쟁점이 여기에 표시됩니다</p>
              </div>
            </template>
          </div>
        </div>

        <!-- ▌중앙: 토론 라이브 ▌ -->
        <div class="flex-1 flex flex-col overflow-hidden min-w-0">
          <div class="shrink-0 px-4 py-2 border-b border-hq-border flex items-center gap-2">
            <h3 class="text-[10px] font-semibold text-hq-muted/50 uppercase tracking-widest">토론 라이브</h3>
            <template x-if="agora.selectedIssueId">
              <span class="text-[10px] text-hq-muted/40" x-text="'— ' + (agora.issues.find(i => i.id === agora.selectedIssueId)?.title || '')"></span>
            </template>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4" x-ref="agoraLive">
            <template x-for="round in agora.rounds" :key="`${round.issue_id}-${round.round_num}-${round.speaker}`">
              <div class="flex gap-3 group">
                <!-- 아바타 -->
                <div class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mt-0.5"
                     :class="{'bg-blue-500/20 text-blue-400': round.speaker==='kodh', 'bg-red-500/20 text-red-400': round.speaker==='psb', 'bg-purple-500/20 text-purple-400': round.speaker==='kdw'}">
                  <span x-text="agoraSpeakerName(round.speaker)[0]"></span>
                </div>
                <!-- 발언 내용 -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-bold" :class="agoraSpeakerColor(round.speaker)" x-text="agoraSpeakerName(round.speaker)"></span>
                    <span class="text-[10px] text-hq-muted/30 font-mono">R<span x-text="round.round_num"></span></span>
                    <template x-if="round.speaker === 'kdw'">
                      <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-purple-500/10 text-purple-400/60">사회자</span>
                    </template>
                  </div>
                  <div class="text-sm text-hq-text/80 whitespace-pre-wrap leading-relaxed" x-text="round.content"></div>
                  <!-- 인용 표시 -->
                  <template x-if="round.citations && JSON.parse(round.citations || '[]').length > 0">
                    <div class="mt-2 space-y-1">
                      <template x-for="cite in JSON.parse(round.citations || '[]')" :key="cite.title">
                        <div class="text-[10px] px-2 py-1 rounded bg-hq-surface/50 border border-hq-border/50 text-hq-muted/60 flex items-center gap-1.5">
                          <span :class="cite.verified ? 'text-green-400' : 'text-yellow-400'" x-text="cite.verified ? '✓' : '?'"></span>
                          <span x-text="`${cite.author}, 「${cite.title}」 (${cite.year})`"></span>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <!-- 빈 상태 -->
            <template x-if="agora.rounds.length === 0">
              <div class="flex flex-col items-center justify-center h-full text-hq-muted/40">
                <svg class="w-10 h-10 mb-3 opacity-20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <p class="text-xs">쟁점을 선택하면</p>
                <p class="text-xs">토론 내용이 여기에 표시됩니다</p>
              </div>
            </template>
          </div>
        </div>

        <!-- ▌우측: 논문 DIFF / 대화록 ▌ -->
        <div class="hidden md:flex w-80 shrink-0 border-l border-hq-border flex-col overflow-hidden">
          <!-- 탭 바 -->
          <div class="shrink-0 flex border-b border-hq-border">
            <button @click="agora.rightTab = 'diff'"
                    :class="agora.rightTab === 'diff' ? 'border-b-2 border-hq-accent text-hq-accent' : 'text-hq-muted/50 hover:text-hq-text'"
                    class="flex-1 px-3 py-2 text-xs font-semibold transition">
              <span class="flex items-center justify-center gap-1.5">
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M3 12h18"/></svg>
                논문 DIFF
              </span>
            </button>
            <button @click="agora.rightTab = 'book'"
                    :class="agora.rightTab === 'book' ? 'border-b-2 border-hq-accent text-hq-accent' : 'text-hq-muted/50 hover:text-hq-text'"
                    class="flex-1 px-3 py-2 text-xs font-semibold transition">
              <span class="flex items-center justify-center gap-1.5">
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                대화록
              </span>
            </button>
          </div>

          <!-- DIFF 내용 -->
          <div x-show="agora.rightTab === 'diff'" class="flex-1 overflow-y-auto">
            <template x-if="agora.diffHtml">
              <div class="p-4 text-xs font-mono leading-relaxed agora-diff" x-html="agora.diffHtml"></div>
            </template>
            <template x-if="!agora.diffHtml">
              <div class="flex flex-col items-center justify-center h-full text-hq-muted/40">
                <svg class="w-8 h-8 mb-2 opacity-20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                <p class="text-[10px]">논문 수정이 발생하면</p>
                <p class="text-[10px]">diff가 여기에 표시됩니다</p>
              </div>
            </template>
          </div>

          <!-- 대화록 내용 -->
          <div x-show="agora.rightTab === 'book'" class="flex-1 overflow-y-auto">
            <template x-if="agora.bookChapters.length > 0">
              <div class="p-4 space-y-6">
                <!-- 대화록 헤더 -->
                <div class="text-center pb-4 border-b border-hq-border/30">
                  <p class="text-[10px] text-hq-muted/40 uppercase tracking-widest mb-1">플라톤 대화록</p>
                  <p class="text-[10px] text-hq-muted/30">저자: 고동희 · 박성범 | 엮은이: 권대옥</p>
                </div>
                <template x-for="ch in agora.bookChapters" :key="ch.chapter_num">
                  <div class="space-y-2">
                    <h4 class="text-sm font-bold text-hq-accent/80 flex items-center gap-2">
                      <span class="text-[10px] text-hq-muted/30 font-mono" x-text="`CH.${ch.chapter_num}`"></span>
                      <span x-text="ch.title"></span>
                    </h4>
                    <div class="text-xs text-hq-text/70 whitespace-pre-wrap leading-relaxed pl-2 border-l-2 border-hq-border/30" x-text="ch.content"></div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="agora.bookChapters.length === 0">
              <div class="flex flex-col items-center justify-center h-full text-hq-muted/40">
                <svg class="w-8 h-8 mb-2 opacity-20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                <p class="text-[10px]">합의가 도달되면</p>
                <p class="text-[10px]">플라톤 대화록이 여기에 편찬됩니다</p>
              </div>
            </template>
          </div>
        </div>

      </div>
    </div>
  </template>

  <!-- AGORA: 논문 입력 모달 -->
  <template x-if="viewMode === 'agora' && agora.showPaperInput">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
         @click.self="agora.showPaperInput = false">
      <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-2xl mx-4 p-6 shadow-2xl" @click.stop>
        <h3 class="text-base font-bold text-hq-text mb-1 flex items-center gap-2">
          <svg class="w-5 h-5 text-hq-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
          새 토론 시작
        </h3>
        <p class="text-xs text-hq-muted/60 mb-4">논문 텍스트를 입력하면 AI 에이전트 3명이 자동으로 토론을 시작합니다</p>

        <label class="text-xs font-semibold text-hq-muted/70 mb-1 block">논문 제목</label>
        <input x-model="agora.inputTitle" type="text" placeholder="예: 부진정부작위범의 인과관계 및 객관적 귀속 평가의 가능성과 방향성 재검토"
               class="w-full bg-hq-surface border border-hq-border rounded-xl px-3 py-2.5 text-sm text-hq-text placeholder:text-hq-muted/30 outline-none focus:border-hq-accent/50 mb-3 font-mono">

        <label class="text-xs font-semibold text-hq-muted/70 mb-1 block">논문 전문</label>
        <textarea x-model="agora.inputPaper" placeholder="논문 전문을 여기에 붙여넣으세요..."
                  class="w-full h-64 bg-hq-surface border border-hq-border rounded-xl px-3 py-2.5 text-sm text-hq-text placeholder:text-hq-muted/30 outline-none focus:border-hq-accent/50 resize-none mb-1 font-mono"></textarea>
        <p class="text-[10px] text-hq-muted/40 mb-4">💡 고동희(Opus) vs 박성범(GPT-5.2) — 사회자: 권대옥(GPT-5.2/Sonnet)</p>

        <div class="flex justify-end gap-2">
          <button @click="agora.showPaperInput = false"
                  class="px-4 py-2 rounded-lg text-sm bg-hq-surface text-hq-muted hover:bg-hq-border transition">취소</button>
          <button @click="submitAgora()" :disabled="!agora.inputTitle.trim() || !agora.inputPaper.trim()"
                  class="px-4 py-2 rounded-lg text-sm bg-hq-accent text-white hover:bg-hq-accent/80 transition disabled:opacity-40 flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            토론 시작
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- 설계실: 새 다이어그램 모달 -->
  <template x-if="activeTab === 'flowchart' && flowchart.showNewModal">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
         @click.self="flowchart.showNewModal = false">
      <div class="bg-hq-panel border border-hq-border rounded-2xl w-full max-w-sm mx-4 p-6 shadow-2xl" @click.stop>
        <h3 class="text-base font-bold text-hq-text mb-4 flex items-center gap-2">
          <svg class="w-4 h-4 text-hq-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          새 다이어그램
        </h3>
        <input x-model="flowchart.newName" @keydown.enter="createFlowchart()"
               type="text" placeholder="이름 입력 (예: 매매봇-흐름)"
               class="w-full bg-hq-surface border border-hq-border rounded-xl px-3 py-2.5 text-sm text-hq-text placeholder:text-hq-muted/40 outline-none focus:border-hq-accent/50 mb-4 font-mono"
               x-ref="newFcInput"
               x-init="$nextTick(()=>$el.focus())">
        <div class="flex justify-end gap-2">
          <button @click="flowchart.showNewModal = false"
                  class="px-4 py-2 rounded-lg text-sm bg-hq-surface text-hq-muted hover:bg-hq-border transition">취소</button>
          <button @click="createFlowchart()" :disabled="!flowchart.newName.trim()"
                  class="px-4 py-2 rounded-lg text-sm bg-hq-accent text-white hover:bg-hq-accent/80 transition disabled:opacity-40">생성</button>
        </div>
      </div>
    </div>
  </template>


  <!-- PWA Service Worker 등록 -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
