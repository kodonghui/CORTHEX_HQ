<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTHEX HQ - CEO ê´€ì œì‹¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'hq-bg': '#0f172a',
            'hq-panel': '#1e293b',
            'hq-border': '#334155',
            'hq-accent': '#3b82f6',
            'hq-green': '#22c55e',
            'hq-yellow': '#eab308',
            'hq-red': '#ef4444',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
    .progress-bar { transition: width 0.5s ease-in-out; }
    .markdown-body h1 { font-size: 1.25rem; font-weight: 700; margin: 1rem 0 0.5rem; }
    .markdown-body h2 { font-size: 1.1rem; font-weight: 600; margin: 0.8rem 0 0.4rem; }
    .markdown-body h3 { font-size: 1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; }
    .markdown-body p { margin: 0.4rem 0; }
    .markdown-body ul, .markdown-body ol { margin: 0.3rem 0; padding-left: 1.5rem; }
    .markdown-body li { margin: 0.2rem 0; }
    .markdown-body code { background: #334155; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.85rem; }
    .markdown-body pre { background: #0f172a; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
    .markdown-body pre code { background: transparent; padding: 0; }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
    .markdown-body th, .markdown-body td { border: 1px solid #475569; padding: 0.4rem 0.8rem; text-align: left; }
    .markdown-body th { background: #1e293b; }
  </style>
</head>

<body class="bg-hq-bg text-gray-200 h-screen flex flex-col overflow-hidden"
      x-data="corthexApp()" x-init="init()">

  <!-- â•â•â• Top Bar â•â•â• -->
  <header class="h-14 bg-hq-panel border-b border-hq-border flex items-center justify-between px-4 shrink-0">
    <div class="flex items-center gap-3">
      <div class="text-xl font-bold tracking-wide">
        <span class="text-hq-accent">CORTHEX</span> <span class="text-gray-400">HQ</span>
      </div>
      <span class="text-xs text-gray-500 border border-hq-border rounded px-2 py-0.5">v0.3.0</span>
    </div>

    <div class="flex items-center gap-6">
      <!-- System Status -->
      <div class="flex items-center gap-2 text-sm">
        <template x-if="systemStatus === 'idle'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-green"></span>
            <span class="text-gray-400">ëŒ€ê¸°ì¤‘</span>
          </span>
        </template>
        <template x-if="systemStatus === 'working'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
            <span class="text-hq-yellow">ì²˜ë¦¬ì¤‘</span>
          </span>
        </template>
        <template x-if="systemStatus === 'error'">
          <span class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-hq-red"></span>
            <span class="text-hq-red">ì˜¤ë¥˜</span>
          </span>
        </template>
      </div>

      <!-- Cost -->
      <div class="text-sm text-gray-400">
        <span class="text-gray-500">ë¹„ìš©</span>
        <span class="text-hq-green font-mono ml-1" x-text="'$' + totalCost.toFixed(4)"></span>
      </div>

      <!-- Tokens -->
      <div class="text-sm text-gray-400">
        <span class="text-gray-500">í† í°</span>
        <span class="font-mono ml-1" x-text="totalTokens.toLocaleString()"></span>
      </div>

      <!-- API Status -->
      <div class="flex items-center gap-1.5 text-xs" :class="wsConnected ? 'text-hq-green' : 'text-hq-red'">
        <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-hq-green' : 'bg-hq-red'"></span>
        <span x-text="wsConnected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€'"></span>
      </div>

      <!-- Quality Settings Button -->
      <button @click="showQualitySettings = true; loadQualityRules()"
              class="text-gray-400 hover:text-white transition ml-1" title="í’ˆì§ˆ ê²€ìˆ˜ ì„¤ì •">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- â•â•â• Main Layout â•â•â• -->
  <div class="flex flex-1 overflow-hidden">

    <!-- â•â•â• Left Panel: Org Tree + Activity Log â•â•â• -->
    <aside class="w-72 bg-hq-panel border-r border-hq-border flex flex-col shrink-0">

      <!-- Org Tree -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-1">ì¡°ì§ë„</div>

        <!-- CEO -->
        <div class="mb-1">
          <div class="flex items-center gap-2 px-2 py-1.5 rounded text-sm font-semibold text-white">
            <span class="text-lg">ğŸ‘¤</span> CEO (ë™í¬ ë‹˜)
          </div>
        </div>

        <!-- ë¹„ì„œì‹¤ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('secretary')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.secretary ? 'â–¼' : 'â–¶'"></span>
            <span class="text-yellow-400">ğŸ“‹</span>
            <span>ë¹„ì„œì‹¤</span>
            <span class="ml-auto text-xs" :class="getSectionStatusColor('secretary')"
                  x-text="getSectionStatusText('secretary')"></span>
          </button>
          <div x-show="expanded.secretary" x-collapse class="ml-6 space-y-0.5">
            <template x-for="id in ['report_worker', 'schedule_worker', 'relay_worker']" :key="id">
              <div class="flex items-center gap-2 px-2 py-0.5 rounded text-xs text-gray-400">
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                <span x-text="getAgentName(id)"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- LEET Master ë³¸ë¶€ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('leet_master')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.leet_master ? 'â–¼' : 'â–¶'"></span>
            <span class="text-cyan-400">ğŸ—ï¸</span>
            <span class="text-cyan-400 font-medium">LEET Master ë³¸ë¶€</span>
            <span class="ml-auto text-xs" :class="getSectionStatusColor('leet_master')"
                  x-text="getSectionStatusText('leet_master')"></span>
          </button>
          <div x-show="expanded.leet_master" x-collapse>

            <!-- ê¸°ìˆ ê°œë°œì²˜ (CTO) -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('tech')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.tech ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cto_manager')"></span>
                <span class="text-cyan-400">ê¸°ìˆ ê°œë°œì²˜ (CTO)</span>
                <span class="ml-auto text-xs" :class="getSectionStatusColor('tech')"
                      x-text="getSectionStatusText('tech')"></span>
              </button>
              <div x-show="expanded.tech" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['frontend_specialist','backend_specialist','infra_specialist','ai_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- ì‚¬ì—…ê¸°íšì²˜ (CSO) -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('strategy')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.strategy ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cso_manager')"></span>
                <span class="text-cyan-400">ì‚¬ì—…ê¸°íšì²˜ (CSO)</span>
                <span class="ml-auto text-xs" :class="getSectionStatusColor('strategy')"
                      x-text="getSectionStatusText('strategy')"></span>
              </button>
              <div x-show="expanded.strategy" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['market_research_specialist','business_plan_specialist','financial_model_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- ë²•ë¬´Â·IPì²˜ (CLO) -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('legal')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.legal ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('clo_manager')"></span>
                <span class="text-cyan-400">ë²•ë¬´Â·IPì²˜ (CLO)</span>
                <span class="ml-auto text-xs" :class="getSectionStatusColor('legal')"
                      x-text="getSectionStatusText('legal')"></span>
              </button>
              <div x-show="expanded.legal" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['copyright_specialist','patent_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ (CMO) -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('marketing')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.marketing ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cmo_manager')"></span>
                <span class="text-cyan-400">ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ (CMO)</span>
                <span class="ml-auto text-xs" :class="getSectionStatusColor('marketing')"
                      x-text="getSectionStatusText('marketing')"></span>
              </button>
              <div x-show="expanded.marketing" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['survey_specialist','content_specialist','community_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                  </div>
                </template>
              </div>
            </div>

          </div> <!-- end leet_master collapse -->
        </div>

        <!-- íˆ¬ìë¶„ì„ ë³¸ë¶€ -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('investment')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.investment ? 'â–¼' : 'â–¶'"></span>
            <span class="text-purple-400">ğŸ“Š</span>
            <span class="text-purple-400 font-medium">íˆ¬ìë¶„ì„ ë³¸ë¶€</span>
            <span class="ml-auto text-xs" :class="getSectionStatusColor('investment')"
                  x-text="getSectionStatusText('investment')"></span>
          </button>
          <div x-show="expanded.investment" x-collapse>

            <!-- íˆ¬ìë¶„ì„ì²˜ (CIO) -->
            <div class="ml-4 mb-1">
              <button @click="toggleSection('finance')"
                      class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
                <span class="text-xs text-gray-500" x-text="expanded.finance ? 'â–¼' : 'â–¶'"></span>
                <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass('cio_manager')"></span>
                <span class="text-purple-400">íˆ¬ìë¶„ì„ì²˜ (CIO)</span>
                <span class="ml-auto text-xs" :class="getSectionStatusColor('finance')"
                      x-text="getSectionStatusText('finance')"></span>
              </button>
              <div x-show="expanded.finance" x-collapse class="ml-6 space-y-0.5">
                <template x-for="id in ['market_condition_specialist','stock_analysis_specialist','technical_analysis_specialist','risk_management_specialist']" :key="id">
                  <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-400">
                    <span class="w-1.5 h-1.5 rounded-full" :class="getAgentDotClass(id)"></span>
                    <span x-text="getAgentName(id)"></span>
                    <template x-if="id !== 'risk_management_specialist'">
                      <span class="text-gray-600 text-[10px]">[ë³‘ë ¬]</span>
                    </template>
                    <template x-if="id === 'risk_management_specialist'">
                      <span class="text-gray-600 text-[10px]">[ìˆœì°¨]</span>
                    </template>
                  </div>
                </template>
              </div>
            </div>

          </div> <!-- end investment collapse -->
        </div>

        <!-- Tool Pool -->
        <div class="ml-2 mb-1">
          <button @click="toggleSection('tools')"
                  class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5 w-full text-left text-sm">
            <span class="text-xs text-gray-500" x-text="expanded.tools ? 'â–¼' : 'â–¶'"></span>
            <span class="text-red-400">ğŸ”§</span>
            <span>AgentTool Pool</span>
          </button>
          <div x-show="expanded.tools" x-collapse class="ml-6 space-y-0.5">
            <template x-for="t in ['ë³€ë¦¬ì‚¬','ì„¸ë¬´ì‚¬','ë””ìì´ë„ˆ','ë²ˆì—­ê°€','ì›¹ê²€ìƒ‰']" :key="t">
              <div class="flex items-center gap-2 px-2 py-0.5 text-xs text-gray-500">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                <span x-text="t + ' Tool'"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="h-48 border-t border-hq-border shrink-0">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 pt-2 pb-1">í™œë™ ë¡œê·¸</div>
        <div class="overflow-y-auto scrollbar-thin h-36 px-3 space-y-1">
          <template x-for="(log, i) in activityLogs.slice(-20).reverse()" :key="i">
            <div class="text-[11px] text-gray-500 fade-in">
              <span class="text-gray-600 font-mono" x-text="log.time"></span>
              <span class="text-gray-400" x-text="log.agent_id"></span>
              <span x-text="log.action"></span>
            </div>
          </template>
          <template x-if="activityLogs.length === 0">
            <div class="text-[11px] text-gray-600 italic">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </template>
        </div>
      </div>
    </aside>

    <!-- â•â•â• Right Panel: Chat â•â•â• -->
    <main class="flex-1 flex flex-col overflow-hidden">

      <!-- Chat Messages -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-6 space-y-4" id="chatArea"
           x-ref="chatArea">

        <!-- Welcome message -->
        <template x-if="messages.length === 0">
          <div class="flex flex-col items-center justify-center h-full text-center">
            <div class="text-5xl mb-4">ğŸ¢</div>
            <h2 class="text-2xl font-bold text-white mb-2">CORTHEX HQ</h2>
            <p class="text-gray-400 mb-6 max-w-md">
              25ëª…ì˜ AI ì—ì´ì „íŠ¸ê°€ ëŒ€ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
              í•œêµ­ì–´ë¡œ ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <div class="flex flex-wrap gap-2 justify-center max-w-lg">
              <button @click="sendPreset('LEET MASTER ì„œë¹„ìŠ¤ì˜ ê¸°ìˆ  ìŠ¤íƒì„ ì œì•ˆí•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ–¥ï¸ ê¸°ìˆ  ìŠ¤íƒ ì œì•ˆ
              </button>
              <button @click="sendPreset('ì‚¼ì„±ì „ì ì£¼ê°€ë¥¼ ë¶„ì„í•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“Š ì£¼ê°€ ë¶„ì„
              </button>
              <button @click="sendPreset('ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ì´ˆì•ˆì„ ë§Œë“¤ì–´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“‹ ì´ìš©ì•½ê´€ ì‘ì„±
              </button>
              <button @click="sendPreset('ë§ˆì¼€íŒ… ì½˜í…ì¸  ì „ëµì„ ìˆ˜ë¦½í•´ì¤˜')"
                      class="text-sm bg-hq-panel border border-hq-border rounded-lg px-4 py-2 hover:bg-white/5 text-gray-300 transition">
                ğŸ“£ ë§ˆì¼€íŒ… ì „ëµ
              </button>
            </div>
          </div>
        </template>

        <!-- Messages -->
        <template x-for="(msg, i) in messages" :key="i">
          <div class="fade-in">

            <!-- User message -->
            <template x-if="msg.type === 'user'">
              <div class="flex justify-end mb-4">
                <div class="bg-hq-accent/20 border border-hq-accent/30 rounded-2xl rounded-tr-sm px-4 py-3 max-w-2xl">
                  <div class="text-xs text-hq-accent mb-1 font-semibold">CEO</div>
                  <div class="text-gray-200" x-text="msg.text"></div>
                </div>
              </div>
            </template>

            <!-- Processing indicator -->
            <template x-if="msg.type === 'processing'">
              <div class="mb-4">
                <div class="bg-hq-panel border border-hq-border rounded-2xl rounded-tl-sm px-4 py-3 max-w-3xl">
                  <div class="text-xs text-hq-yellow mb-2 font-semibold flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-hq-yellow pulse-dot"></span>
                    ì—ì´ì „íŠ¸ ì¡°ì§ì´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...
                  </div>
                  <!-- Live progress bars -->
                  <div class="space-y-2">
                    <template x-for="(status, agentId) in activeAgents" :key="agentId">
                      <div x-show="status.status === 'working'" class="fade-in">
                        <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
                          <span x-text="getAgentName(agentId)"></span>
                          <span x-text="Math.round(status.progress * 100) + '%'"></span>
                        </div>
                        <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                          <div class="h-full bg-hq-accent rounded-full progress-bar"
                               :style="'width:' + (status.progress * 100) + '%'"></div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>

            <!-- Agent result -->
            <template x-if="msg.type === 'result'">
              <div class="mb-4">
                <div class="bg-hq-panel border border-hq-border rounded-2xl rounded-tl-sm px-5 py-4 max-w-4xl">
                  <div class="flex items-center justify-between mb-3">
                    <div class="text-xs text-hq-green font-semibold flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-hq-green"></span>
                      <span x-text="getAgentName(msg.sender_id) || 'ê²°ê³¼'"></span>
                    </div>
                    <div class="flex items-center gap-3 text-[11px] text-gray-500">
                      <span x-text="msg.time_seconds + 'ì´ˆ'"></span>
                      <span x-text="'$' + (msg.cost || 0).toFixed(4)"></span>
                    </div>
                  </div>
                  <div class="text-gray-300 text-sm leading-relaxed markdown-body"
                       x-html="renderMarkdown(msg.content)"></div>
                </div>
              </div>
            </template>

            <!-- Error -->
            <template x-if="msg.type === 'error'">
              <div class="mb-4">
                <div class="bg-red-900/20 border border-hq-red/30 rounded-2xl rounded-tl-sm px-4 py-3 max-w-2xl">
                  <div class="text-xs text-hq-red mb-1 font-semibold">ì˜¤ë¥˜</div>
                  <div class="text-gray-300 text-sm" x-text="msg.text"></div>
                </div>
              </div>
            </template>

          </div>
        </template>
      </div>

      <!-- Input Bar -->
      <div class="border-t border-hq-border bg-hq-panel p-4 shrink-0">
        <form @submit.prevent="sendMessage()" class="flex items-center gap-3 max-w-4xl mx-auto">
          <input type="text"
                 x-model="inputText"
                 :disabled="systemStatus === 'working'"
                 placeholder="ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”..."
                 class="flex-1 bg-hq-bg border border-hq-border rounded-xl px-4 py-3 text-sm text-gray-200
                        placeholder-gray-500 focus:outline-none focus:border-hq-accent focus:ring-1
                        focus:ring-hq-accent/50 disabled:opacity-50 transition"
                 autofocus>
          <button type="submit"
                  :disabled="!inputText.trim() || systemStatus === 'working'"
                  class="bg-hq-accent hover:bg-blue-600 disabled:bg-gray-700 disabled:text-gray-500
                         text-white rounded-xl px-6 py-3 text-sm font-medium transition shrink-0">
            <span x-show="systemStatus !== 'working'">ë³´ë‚´ê¸°</span>
            <span x-show="systemStatus === 'working'" class="flex items-center gap-2">
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              ì²˜ë¦¬ì¤‘
            </span>
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- â•â•â• Quality Gate Settings Modal â•â•â• -->
  <div x-show="showQualitySettings" x-transition.opacity
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
       @click.self="showQualitySettings = false" style="display: none;">
    <div class="bg-hq-panel border border-hq-border rounded-2xl w-[700px] max-h-[80vh] overflow-y-auto p-6"
         @click.stop>

      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-white">í’ˆì§ˆ ê²€ìˆ˜ ì„¤ì •</h2>
        <button @click="showQualitySettings = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>

      <!-- Section 1: Review Model Selection -->
      <div class="mb-6 p-4 bg-hq-bg rounded-xl">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">ê²€ìˆ˜ ëª¨ë¸</h3>
        <p class="text-xs text-gray-500 mb-3">ëª¨ë“  í’ˆì§ˆ ê²€ìˆ˜ì— ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="flex items-center gap-3">
          <select x-model="selectedReviewModel"
                  class="flex-1 bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200">
            <template x-for="m in availableModels" :key="m.name">
              <option :value="m.name"
                      x-text="m.name + ' (' + m.provider + ', $' + m.cost_input + '/' + m.cost_output + ')'">
              </option>
            </template>
          </select>
          <button @click="saveReviewModel()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm whitespace-nowrap">
            ì €ì¥
          </button>
        </div>
      </div>

      <!-- Section 2: Rubrics per Division -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">ë¶€ì„œë³„ ê²€ìˆ˜ ê¸°ì¤€ (ë£¨ë¸Œë¦­)</h3>
        <p class="text-xs text-gray-500 mb-3">ê° ë¶€ì„œë³„ ê²€ìˆ˜ ê¸°ì¤€ì„ ì„¤ì •í•˜ì„¸ìš”. ë¯¸ì„¤ì • ë¶€ì„œëŠ” 'ê¸°ë³¸' ê¸°ì¤€ì´ ì ìš©ë©ë‹ˆë‹¤.</p>

        <div class="space-y-2">
          <template x-for="div in ['default', ...(qualityRules.known_divisions || [])]" :key="div">
            <div class="p-3 bg-hq-bg rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-sm text-gray-200 font-medium" x-text="getDivisionLabel(div)"></span>
                  <span x-show="qualityRules.rubrics && qualityRules.rubrics[div]"
                        class="ml-2 text-xs text-green-400">ì„¤ì •ë¨</span>
                  <span x-show="!qualityRules.rubrics || !qualityRules.rubrics[div]"
                        class="ml-2 text-xs text-gray-500">ê¸°ë³¸ ì ìš©</span>
                </div>
                <button @click="startEditRubric(div)"
                        class="text-xs text-hq-accent hover:text-blue-400">í¸ì§‘</button>
              </div>
              <template x-if="qualityRules.rubrics && qualityRules.rubrics[div]">
                <p class="text-xs text-gray-500 mt-1 truncate"
                   x-text="qualityRules.rubrics[div].prompt.substring(0, 80) + '...'"></p>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Rubric Editor -->
      <div x-show="editingRubric !== null" class="mt-4 p-4 bg-hq-bg rounded-xl border border-hq-accent/30">
        <h4 class="text-sm font-semibold text-hq-accent mb-3"
            x-text="getDivisionLabel(editingRubric) + ' ê²€ìˆ˜ ê¸°ì¤€ í¸ì§‘'"></h4>
        <div class="mb-3">
          <label class="text-xs text-gray-400 mb-1 block">ê¸°ì¤€ ì´ë¦„</label>
          <input x-model="rubricEditName"
                 class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200"
                 placeholder="ì˜ˆ: ê¸°ìˆ ê°œë°œì²˜ ê²€ìˆ˜ ê¸°ì¤€">
        </div>
        <div class="mb-3">
          <label class="text-xs text-gray-400 mb-1 block">ê²€ìˆ˜ ê¸°ì¤€ (í”„ë¡¬í”„íŠ¸)</label>
          <textarea x-model="rubricEditPrompt" rows="8"
                    class="w-full bg-hq-panel border border-hq-border rounded-lg px-3 py-2 text-sm text-gray-200 resize-y font-mono"
                    placeholder="ë‹¤ìŒ ê¸°ì¤€ìœ¼ë¡œ ê²€ìˆ˜í•˜ì„¸ìš”:&#10;1. ...&#10;2. ...&#10;3. ..."></textarea>
        </div>
        <div class="flex items-center gap-2">
          <button @click="saveRubric()"
                  class="bg-hq-accent hover:bg-blue-600 text-white rounded-lg px-4 py-2 text-sm">ì €ì¥</button>
          <button @click="editingRubric = null"
                  class="bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg px-4 py-2 text-sm">ì·¨ì†Œ</button>
        </div>
      </div>

      <!-- Save status -->
      <div class="mt-4 text-center h-5">
        <span x-show="qualitySaveStatus === 'saving'" class="text-xs text-yellow-400">ì €ì¥ ì¤‘...</span>
        <span x-show="qualitySaveStatus === 'saved'" class="text-xs text-green-400">ì €ì¥ ì™„ë£Œ (Git ë™ê¸°í™”ë¨)</span>
        <span x-show="qualitySaveStatus === 'error'" class="text-xs text-red-400">ì €ì¥ ì‹¤íŒ¨</span>
      </div>
    </div>
  </div>

  <script>
    function corthexApp() {
      return {
        // State
        inputText: '',
        messages: [],
        systemStatus: 'idle',
        wsConnected: false,
        totalCost: 0,
        totalTokens: 0,
        activityLogs: [],
        activeAgents: {},
        ws: null,

        // Quality gate settings
        showQualitySettings: false,
        qualityRules: { rules: {}, rubrics: {}, known_divisions: [] },
        availableModels: [],
        selectedReviewModel: '',
        editingRubric: null,
        rubricEditName: '',
        rubricEditPrompt: '',
        qualitySaveStatus: '',

        // Org tree expand state
        expanded: {
          secretary: false,
          leet_master: true,
          tech: false,
          strategy: false,
          legal: false,
          marketing: false,
          investment: true,
          finance: false,
          tools: false,
        },

        // Agent name mapping
        agentNames: {
          'chief_of_staff': 'ë¹„ì„œì‹¤ì¥',
          'report_worker': 'ë³´ê³  ìš”ì•½ Worker',
          'schedule_worker': 'ì¼ì •/ë¯¸ê²° ì¶”ì  Worker',
          'relay_worker': 'ì •ë³´ ì¤‘ê³„ Worker',
          'cto_manager': 'CTO ê¸°ìˆ ê°œë°œì²˜ì¥',
          'frontend_specialist': 'í”„ë¡ íŠ¸ì—”ë“œ',
          'backend_specialist': 'ë°±ì—”ë“œ/API',
          'infra_specialist': 'DB/ì¸í”„ë¼',
          'ai_model_specialist': 'AI ëª¨ë¸',
          'cso_manager': 'CSO ì‚¬ì—…ê¸°íšì²˜ì¥',
          'market_research_specialist': 'ì‹œì¥ì¡°ì‚¬',
          'business_plan_specialist': 'ì‚¬ì—…ê³„íšì„œ',
          'financial_model_specialist': 'ì¬ë¬´ëª¨ë¸ë§',
          'clo_manager': 'CLO ë²•ë¬´Â·IPì²˜ì¥',
          'copyright_specialist': 'ì €ì‘ê¶Œ',
          'patent_specialist': 'íŠ¹í—ˆ/ì•½ê´€',
          'cmo_manager': 'CMO ë§ˆì¼€íŒ…Â·ê³ ê°ì²˜ì¥',
          'survey_specialist': 'ì„¤ë¬¸/ë¦¬ì„œì¹˜',
          'content_specialist': 'ì½˜í…ì¸ ',
          'community_specialist': 'ì»¤ë®¤ë‹ˆí‹°',
          'cio_manager': 'CIO íˆ¬ìë¶„ì„ì²˜ì¥',
          'market_condition_specialist': 'ì‹œí™©ë¶„ì„',
          'stock_analysis_specialist': 'ì¢…ëª©ë¶„ì„',
          'technical_analysis_specialist': 'ê¸°ìˆ ì ë¶„ì„',
          'risk_management_specialist': 'ë¦¬ìŠ¤í¬ê´€ë¦¬',
        },

        // Division mapping for auto-expand
        agentDivision: {
          'chief_of_staff': 'secretary', 'report_worker': 'secretary',
          'schedule_worker': 'secretary', 'relay_worker': 'secretary',
          'cto_manager': 'tech',
          'frontend_specialist': 'tech', 'backend_specialist': 'tech',
          'infra_specialist': 'tech', 'ai_model_specialist': 'tech',
          'cso_manager': 'strategy', 'market_research_specialist': 'strategy',
          'business_plan_specialist': 'strategy', 'financial_model_specialist': 'strategy',
          'clo_manager': 'legal', 'copyright_specialist': 'legal',
          'patent_specialist': 'legal', 'cmo_manager': 'marketing',
          'survey_specialist': 'marketing', 'content_specialist': 'marketing',
          'community_specialist': 'marketing',
          'cio_manager': 'finance', 'market_condition_specialist': 'finance',
          'stock_analysis_specialist': 'finance', 'technical_analysis_specialist': 'finance',
          'risk_management_specialist': 'finance',
        },

        init() {
          this.connectWebSocket();
        },

        connectWebSocket() {
          const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
          this.ws = new WebSocket(`${protocol}//${location.host}/ws`);

          this.ws.onopen = () => {
            this.wsConnected = true;
          };

          this.ws.onclose = () => {
            this.wsConnected = false;
            // Reconnect after 3 seconds
            setTimeout(() => this.connectWebSocket(), 3000);
          };

          this.ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            this.handleWsMessage(msg);
          };
        },

        handleWsMessage(msg) {
          switch (msg.event) {
            case 'processing_start':
              this.systemStatus = 'working';
              this.messages.push({ type: 'processing', id: Date.now() });
              break;

            case 'agent_status':
              const d = msg.data;
              this.activeAgents[d.agent_id] = {
                status: d.status,
                progress: d.progress || 0,
              };

              // Auto-expand the relevant section
              if (d.status === 'working') {
                const div = this.agentDivision[d.agent_id];
                if (div) {
                  this.expanded[div] = true;
                  if (['tech','strategy','legal','marketing'].includes(div)) {
                    this.expanded.leet_master = true;
                  }
                  if (div === 'finance') {
                    this.expanded.investment = true;
                  }
                }
              }

              // Simulate progress increase
              if (d.status === 'working' && d.progress < 0.9) {
                this.simulateProgress(d.agent_id);
              }
              break;

            case 'activity_log':
              this.activityLogs.push(msg.data);
              break;

            case 'cost_update':
              this.totalCost = msg.data.total_cost;
              this.totalTokens = msg.data.total_tokens;
              break;

            case 'result':
              // Remove processing indicator
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({
                type: 'result',
                content: msg.data.content,
                sender_id: msg.data.sender_id,
                time_seconds: msg.data.time_seconds,
                cost: msg.data.cost,
              });
              this.systemStatus = 'idle';
              this.totalCost = msg.data.cost || this.totalCost;
              this.$nextTick(() => this.scrollToBottom());
              break;

            case 'error':
              this.messages = this.messages.filter(m => m.type !== 'processing');
              this.messages.push({ type: 'error', text: msg.data.message });
              this.systemStatus = 'error';
              setTimeout(() => { this.systemStatus = 'idle'; }, 3000);
              break;
          }
        },

        simulateProgress(agentId) {
          const interval = setInterval(() => {
            if (!this.activeAgents[agentId] || this.activeAgents[agentId].status !== 'working') {
              clearInterval(interval);
              return;
            }
            const current = this.activeAgents[agentId].progress;
            if (current < 0.9) {
              this.activeAgents[agentId].progress = Math.min(0.9, current + 0.05 + Math.random() * 0.1);
            } else {
              clearInterval(interval);
            }
          }, 800);
        },

        sendMessage() {
          const text = this.inputText.trim();
          if (!text || this.systemStatus === 'working') return;

          this.messages.push({ type: 'user', text });
          this.inputText = '';
          this.activeAgents = {};

          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'command', text }));
          }

          this.$nextTick(() => this.scrollToBottom());
        },

        sendPreset(text) {
          this.inputText = text;
          this.sendMessage();
        },

        toggleSection(section) {
          this.expanded[section] = !this.expanded[section];
        },

        getAgentName(id) {
          return this.agentNames[id] || id;
        },

        getAgentDotClass(id) {
          const status = this.activeAgents[id];
          if (!status) return 'bg-amber-500';
          switch (status.status) {
            case 'working': return 'bg-hq-green pulse-dot';
            case 'done': return 'bg-hq-green';
            case 'idle': return 'bg-amber-500';
            default: return 'bg-gray-600';
          }
        },

        getSectionStatusColor(section) {
          const ids = this.getSectionAgentIds(section);
          const hasWorking = ids.some(id => this.activeAgents[id]?.status === 'working');
          if (hasWorking) return 'text-hq-yellow';
          const hasDone = ids.some(id => this.activeAgents[id]?.status === 'done');
          if (hasDone) return 'text-hq-green';
          return 'text-gray-600';
        },

        getSectionStatusText(section) {
          const ids = this.getSectionAgentIds(section);
          const working = ids.filter(id => this.activeAgents[id]?.status === 'working').length;
          if (working > 0) return `${working}ëª… ì‘ì—…ì¤‘`;
          const done = ids.filter(id => this.activeAgents[id]?.status === 'done').length;
          if (done > 0) return `${done}ëª… ì™„ë£Œ`;
          return '';
        },

        getSectionAgentIds(section) {
          if (section === 'leet_master') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => ['tech','strategy','legal','marketing'].includes(div))
              .map(([id]) => id);
          }
          if (section === 'investment') {
            return Object.entries(this.agentDivision)
              .filter(([_, div]) => div === 'finance')
              .map(([id]) => id);
          }
          return Object.entries(this.agentDivision)
            .filter(([_, div]) => div === section)
            .map(([id]) => id);
        },

        renderMarkdown(text) {
          try { return marked.parse(text || ''); }
          catch { return text; }
        },

        // â”€â”€ Quality Gate Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async loadQualityRules() {
          try {
            const [rulesRes, modelsRes] = await Promise.all([
              fetch('/api/quality-rules').then(r => r.json()),
              fetch('/api/available-models').then(r => r.json()),
            ]);
            this.qualityRules = rulesRes;
            this.availableModels = modelsRes;
            this.selectedReviewModel = rulesRes.rules?.review_model || 'gpt-4o-mini';
          } catch (e) {
            console.error('Failed to load quality rules:', e);
          }
        },

        async saveReviewModel() {
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch('/api/quality-rules/model', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ review_model: this.selectedReviewModel }),
            }).then(r => r.json());
            this.qualitySaveStatus = res.success ? 'saved' : 'error';
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        startEditRubric(division) {
          this.editingRubric = division;
          const rubric = this.qualityRules.rubrics?.[division] || { name: '', prompt: '' };
          this.rubricEditName = rubric.name || '';
          this.rubricEditPrompt = rubric.prompt || '';
        },

        async saveRubric() {
          if (!this.editingRubric) return;
          this.qualitySaveStatus = 'saving';
          try {
            const res = await fetch(`/api/quality-rules/rubric/${this.editingRubric}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
              }),
            }).then(r => r.json());
            if (res.success) {
              if (!this.qualityRules.rubrics) this.qualityRules.rubrics = {};
              this.qualityRules.rubrics[this.editingRubric] = {
                name: this.rubricEditName,
                prompt: this.rubricEditPrompt,
              };
              this.editingRubric = null;
              this.qualitySaveStatus = 'saved';
            } else {
              this.qualitySaveStatus = 'error';
            }
          } catch {
            this.qualitySaveStatus = 'error';
          }
          setTimeout(() => { this.qualitySaveStatus = ''; }, 2500);
        },

        getDivisionLabel(division) {
          const labels = {
            'default': 'ê¸°ë³¸ (ì „ì²´ ê³µí†µ)',
            'secretary': 'ë¹„ì„œì‹¤',
            'leet_master.tech': 'ê¸°ìˆ ê°œë°œì²˜ (CTO)',
            'leet_master.strategy': 'ì‚¬ì—…ê¸°íšì²˜ (CSO)',
            'leet_master.legal': 'ë²•ë¬´ì²˜ (CLO)',
            'leet_master.marketing': 'ë§ˆì¼€íŒ…ì²˜ (CMO)',
            'finance.investment': 'íˆ¬ìë¶„ì„ì²˜ (CIO)',
          };
          return labels[division] || division;
        },

        scrollToBottom() {
          const el = this.$refs.chatArea;
          if (el) el.scrollTop = el.scrollHeight;
        },
      };
    }
  </script>
</body>
</html>
